<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIT ìì„¸ ë¶„ì„ AI (ìµœì¢… í†µí•©ë²„ì „)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0b0f14;
  --panel: rgba(30, 34, 42, 0.7);
  --accent: #7c9cff;
  --accent2: #ffb86c;
  --ink: #e7eef7;
  --muted: #9bb0c7;
  --radius: 18px;
}
* { box-sizing: border-box; }
html, body {
  margin: 0; 
  padding: 0;
  height: 100%;
  -webkit-overflow-scrolling: touch;
}
body {
  background: var(--bg); 
  color: var(--ink);
  font-family: "Noto Sans KR", sans-serif;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  overflow-x: hidden;
}
.panel {
  background: var(--panel);
  backdrop-filter: blur(20px);
  border-radius: var(--radius);
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
}
.sidebar { 
  padding: 12px; 
  overflow-y: auto;
  overflow-x: hidden;
  max-height: 50vh;
  -webkit-overflow-scrolling: touch;
}
.title { 
  font-size: 16px; 
  font-weight:800; 
  margin-bottom: 6px; 
  line-height: 1.3;
}
.muted { 
  color: var(--muted); 
  font-size: 11px; 
  line-height: 1.4;
}
.btn {
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 10px 14px;
  background: rgba(255,255,255,0.05);
  color: var(--ink);
  cursor: pointer;
  font-size: 13px;
  width: 100%;
  text-align: center;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.btn:hover, .btn:active { 
  background: rgba(255,255,255,0.12); 
}
.seg { 
  display: flex; 
  border-radius: 10px; 
  overflow: hidden; 
  margin-top: 8px; 
  gap: 4px;
}
.seg button { 
  flex:1; 
  border:0; 
  background: rgba(255,255,255,0.04); 
  color:var(--muted); 
  padding:10px 8px; 
  cursor:pointer; 
  font-size: 13px;
  touch-action: manipulation;
}
.seg button.active { 
  background: rgba(124,156,255,0.25); 
  color:var(--ink); 
}
label.btn { 
  display: block;
  width: 100%;
  margin-bottom: 8px;
}
label.btn input { display:none; }
.tbl { 
  width:100%; 
  border-collapse:collapse; 
  font-size:11px; 
  overflow-x: auto;
  display: table;
  -webkit-overflow-scrolling: touch;
}
.tbl th,.tbl td { 
  border-bottom:1px solid rgba(255,255,255,0.1); 
  padding:6px 4px; 
  text-align: center;
  font-size: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.canvasWrap { 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  flex: 1;
  min-height: 50vh;
  padding: 8px;
}
canvas { 
  max-width:100%; 
  max-height:100%; 
  border-radius:var(--radius); 
  background:#0a0e13; 
  cursor: crosshair; 
  touch-action: none;
}
</style>
</head>
<body>
<aside class="panel sidebar" style="order: 1;">
  <div class="title">ğŸ“¸ DIT ìì„¸ ë¶„ì„ AI</div>
  <div class="muted">íŒŒì¼ ì—…ë¡œë“œ â†’ ì ì„ ë“œë˜ê·¸ë¡œ ì¡°ì • â†’ ê°ë„ ìë™ ê³„ì‚°</div>

  <div class="seg">
    <button id="btnBefore" class="active">Before</button>
    <button id="btnAfter">After</button>
  </div>
  <div style="margin-top:8px; display:flex; flex-direction:column; gap:8px;">
    <label class="btn">ğŸ“· íŒŒì¼ ì„ íƒ
      <input id="filePicker" type="file" accept="image/*">
    </label>
    <label class="btn">ğŸ“¸ ì§ì ‘ ì´¬ì˜
      <input id="cameraPicker" type="file" accept="image/*" capture="environment">
    </label>
    <button class="btn" id="btnReset">â†º ì´ˆê¸°í™”</button>
  </div>

  <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
    <button class="btn" id="btnEditCoords" style="background: rgba(124,156,255,0.2);">âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ</button>
    <button class="btn" id="btnSaveJSON">ğŸ’¾ ì¢Œí‘œ ì €ì¥</button>
    <button class="btn" id="btnLoadJSON">ğŸ“‚ ì¢Œí‘œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button class="btn" id="btnPDF">ğŸ“„ PDF ì €ì¥</button>
  </div>

  <div id="coordEditPanel" style="margin-top:12px; padding:10px; background:rgba(124,156,255,0.1); border-radius:10px; display:none;">
    <div class="muted" style="margin-bottom:8px; font-weight:600;">ì¢Œí‘œ ìˆ˜ì •</div>
    <div style="margin-bottom:8px;">
      <select id="coordSelectPoint" class="btn" style="width:100%; padding:6px; margin-bottom:6px;">
        <option value="">ì  ì„ íƒ...</option>
        <option value="Tragus">Tragus</option>
        <option value="C7">C7</option>
        <option value="Shoulder">Shoulder</option>
        <option value="Hip">Hip</option>
        <option value="Knee">Knee</option>
        <option value="Ankle">Ankle</option>
        <option value="ASIS">ASIS</option>
        <option value="PSIS">PSIS</option>
      </select>
    </div>
    <div style="display:flex; flex-direction:column; gap:6px; margin-bottom:6px;">
      <div>
        <div class="muted" style="font-size:11px; margin-bottom:4px;">X ì¢Œí‘œ</div>
        <input type="number" id="coordX" class="btn" style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);" step="0.1" placeholder="X">
      </div>
      <div>
        <div class="muted" style="font-size:11px; margin-bottom:4px;">Y ì¢Œí‘œ</div>
        <input type="number" id="coordY" class="btn" style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);" step="0.1" placeholder="Y">
      </div>
    </div>
    <button class="btn" id="coordApply" style="width:100%; background:rgba(124,156,255,0.3);">ì ìš©</button>
    <button class="btn" id="coordCancel" style="width:100%; margin-top:6px; background:rgba(255,255,255,0.05);">ì·¨ì†Œ</button>
  </div>

  <div style="margin-top:12px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px;">
    <div class="muted" style="margin-bottom:6px;">í˜„ì¬ ì„¸ì…˜: <span id="currentSession">Before</span></div>
    <div class="muted" style="margin-bottom:6px;">CVA: <span id="dispCva">â€”</span></div>
    <div class="muted" style="margin-bottom:6px;">TRUNK: <span id="dispPel">â€”</span></div>
    <div class="muted" style="margin-bottom:8px;">KNEE: <span id="dispKnee">â€”</span></div>
    
    <div style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1);">
      <div style="font-size:14px; font-weight:600; margin-bottom:8px;">ğŸ“Š ì²´í˜• ì¢…í•© ì ìˆ˜</div>
      <div id="totalScore" style="font-size:32px; font-weight:800; margin-bottom:8px;">â€”</div>
      <div id="scoreReason" class="muted" style="font-size:11px; line-height:1.4; margin-bottom:8px;"></div>
    </div>
  </div>

  <div id="aiCommentPanel" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#2ec4b6;">ğŸ¤– AI ì‹¤ì‹œê°„ ë¶„ì„</div>
    <div id="aiComment" class="muted" style="font-size:12px; line-height:1.5;"></div>
  </div>

  <div id="musclePanel" style="margin-top:12px; padding:12px; background:rgba(255,184,108,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#ffb86c;">ğŸ’ª ê·¼ìœ¡ ìƒíƒœ ë¶„ì„</div>
    <div id="muscleTight" style="margin-bottom:8px;">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">ğŸ”´ ê¸´ì¥ëœ ê·¼ìœ¡:</div>
      <div id="muscleTightList" style="font-size:12px; color:#ff6b6b;"></div>
    </div>
    <div id="muscleWeak">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">ğŸ”µ ì•½í™”ëœ ê·¼ìœ¡:</div>
      <div id="muscleWeakList" style="font-size:12px; color:#7c9cff;"></div>
    </div>
  </div>

  <div style="margin-top:12px;">
    <table class="tbl">
      <thead><tr><th>í•­ëª©</th><th>Before</th><th>After</th><th>ë³€í™”</th><th>ì •ìƒ</th></tr></thead>
      <tbody>
        <tr><td>CVA</td><td id="cmpCvaB">â€”</td><td id="cmpCvaA">â€”</td><td id="cmpCvaD">â€”</td><td>â‰¥50Â°</td></tr>
        <tr><td>TRUNK</td><td id="cmpPelB">â€”</td><td id="cmpPelA">â€”</td><td id="cmpPelD">â€”</td><td>|0â€“5Â°|</td></tr>
        <tr><td>KNEE</td><td id="cmpKneeB">â€”</td><td id="cmpKneeA">â€”</td><td id="cmpKneeD">â€”</td><td>175â€“185Â°</td></tr>
      </tbody>
    </table>
  </div>
</aside>
<main class="panel canvasWrap" style="order: 2;">
  <canvas id="cv" width="1600" height="1000"></canvas>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
let DPR = window.devicePixelRatio || 1;
let dragKey = null;
let editMode = false;
let selectedPoint = null;

const keypoints = [
  {key:'Tragus', color:'#7c9cff'},
  {key:'C7', color:'#7c9cff'},
  {key:'Shoulder', color:'#7c9cff'},
  {key:'Hip', color:'#7c9cff'},
  {key:'Knee', color:'#7c9cff'},
  {key:'Ankle', color:'#7c9cff'},
  {key:'ASIS', color:'#ffb86c'},
  {key:'PSIS', color:'#ffb86c'},
];

const sessions = {
  Before: { img:null, pts:new Map(), metrics:{}, score:null, analysis:null },
  After: { img:null, pts:new Map(), metrics:{}, score:null, analysis:null }
};
let cur = "Before";

const clamp = (v,min,max) => Math.min(max,Math.max(min,v));
const rad2deg = r => r * 180 / Math.PI;
const angleBetween = (a,b) => Math.atan2(b.y - a.y, b.x - a.x);
const internalAngle = (a,b,c) => {
  const ab = Math.atan2(a.y - b.y, a.x - b.x);
  const cb = Math.atan2(c.y - b.y, c.x - b.x);
  let d = Math.abs(ab - cb);
  if(d > Math.PI) d = 2 * Math.PI - d;
  return d;
};

document.getElementById("btnBefore").onclick = () => switchSession("Before");
document.getElementById("btnAfter").onclick = () => switchSession("After");

function switchSession(s) {
  cur = s;
  document.getElementById("btnBefore").classList.toggle("active", s === "Before");
  document.getElementById("btnAfter").classList.toggle("active", s === "After");
  document.getElementById("currentSession").textContent = s;
  draw();
  computeAll();
  updateCompare();
}

function resizeCanvasFor(img) {
  const maxW = cv.parentElement.clientWidth - 24;
  const maxH = cv.parentElement.clientHeight - 24;
  const r = img ? Math.min(maxW / img.naturalWidth, maxH / img.naturalHeight) : 1;
  const w = Math.round((img ? img.naturalWidth : 1200) * r);
  const h = Math.round((img ? img.naturalHeight : 800) * r);
  cv.width = w * DPR;
  cv.height = h * DPR;
  cv.style.width = w + "px";
  cv.style.height = h + "px";
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
}

function ensureDefaultPoints(session) {
  const S = sessions[session];
  const W = cv.width / DPR, H = cv.height / DPR;
  if(S.pts.size === 0 && S.img) {
    const defaults = {
      Tragus: {x:W*0.35, y:H*0.3},
      C7: {x:W*0.3, y:H*0.35},
      Shoulder: {x:W*0.35, y:H*0.4},
      Hip: {x:W*0.38, y:H*0.6},
      Knee: {x:W*0.42, y:H*0.8},
      Ankle: {x:W*0.44, y:H*0.95},
      ASIS: {x:W*0.40, y:H*0.58},
      PSIS: {x:W*0.35, y:H*0.6},
    };
    for(const kp of keypoints) {
      if(defaults[kp.key]) S.pts.set(kp.key, {...defaults[kp.key]});
    }
  }
}

function getPts(session) {
  const map = sessions[session].pts;
  const out = {};
  for(const k of keypoints) out[k.key] = map.get(k.key);
  return out;
}

function draw() {
  const S = sessions[cur];
  const W = cv.width / DPR, H = cv.height / DPR;
  ctx.clearRect(0, 0, cv.width, cv.height);
  ctx.fillStyle = "#0a0e13";
  ctx.fillRect(0, 0, W, H);

  if(S.img) {
    ctx.drawImage(S.img, 0, 0, W, H);
  }

  ensureDefaultPoints(cur);
  const P = getPts(cur);

  // ë³´ì¡°ì„  ê·¸ë¦¬ê¸°
  ctx.lineWidth = 2;
  ctx.setLineDash([8, 6]);
  ctx.strokeStyle = 'rgba(124,156,255,0.85)';

  if(P.C7 && P.Tragus) {
    ctx.beginPath();
    ctx.moveTo(0, P.C7.y);
    ctx.lineTo(W, P.C7.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(P.C7.x, P.C7.y);
    ctx.lineTo(P.Tragus.x, P.Tragus.y);
    ctx.stroke();
  }

  if(P.Shoulder && P.Hip) {
    ctx.beginPath();
    ctx.moveTo(P.Shoulder.x, P.Shoulder.y);
    ctx.lineTo(P.Hip.x, P.Hip.y);
    ctx.stroke();
  }
  if(P.Hip && P.Knee) {
    ctx.beginPath();
    ctx.moveTo(P.Hip.x, P.Hip.y);
    ctx.lineTo(P.Knee.x, P.Knee.y);
    ctx.stroke();
  }
  if(P.Knee && P.Ankle) {
    ctx.beginPath();
    ctx.moveTo(P.Knee.x, P.Knee.y);
    ctx.lineTo(P.Ankle.x, P.Ankle.y);
    ctx.stroke();
  }

  if(P.ASIS && P.PSIS) {
    ctx.strokeStyle = 'rgba(255,184,108,0.95)';
    ctx.beginPath();
    ctx.moveTo(P.ASIS.x, P.ASIS.y);
    ctx.lineTo(P.PSIS.x, P.PSIS.y);
    ctx.stroke();
    ctx.strokeStyle = 'rgba(255,184,108,0.35)';
    const midy = (P.ASIS.y + P.PSIS.y) / 2;
    ctx.beginPath();
    ctx.moveTo(0, midy);
    ctx.lineTo(W, midy);
    ctx.stroke();
  }

  ctx.setLineDash([]);

  // ì  ê·¸ë¦¬ê¸°
  for(const kp of keypoints) {
    const pt = P[kp.key];
    if(!pt) continue;
    drawHandle(pt.x, pt.y, kp.key, kp.color);
  }
}

function drawHandle(x, y, label, color) {
  // ì ì„ ë” í¬ê²Œ ê·¸ë¦¬ê³  ë“œë˜ê·¸ ì˜ì—­ì„ ë„“ê²Œ
  ctx.fillStyle = color;
  ctx.strokeStyle = 'rgba(0,0,0,0.8)';
  ctx.beginPath();
  ctx.arc(x, y, 8, 0, Math.PI * 2);  // 6 -> 8ë¡œ ì¦ê°€
  ctx.fill();
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.font = '12px "Noto Sans KR"';
  const pad = 4;
  const tw = ctx.measureText(label).width;
  const th = 16;
  ctx.fillStyle = 'rgba(0,0,0,0.6)';
  ctx.fillRect(x + 10, y - 12, tw + pad * 2, th);
  ctx.fillStyle = '#e7eef7';
  ctx.fillText(label, x + 10 + pad, y + 1);
}

function computeAll() {
  const S = sessions[cur];
  const P = getPts(cur);
  let cva = null, pelvic = null, knee = null;

  if(P.C7 && P.Tragus) {
    const a = angleBetween(P.C7, P.Tragus);
    cva = Math.abs(rad2deg(a));
  }
  if(P.ASIS && P.PSIS) {
    pelvic = rad2deg(angleBetween(P.ASIS, P.PSIS));
  }
  if(P.Hip && P.Knee && P.Ankle) {
    knee = rad2deg(internalAngle(P.Hip, P.Knee, P.Ankle));
  }

  S.metrics = { cva, pelvic, knee };
  const score = computeScore(cva, pelvic, knee);
  S.score = score;
  const analysis = analyzeMuscles(cva, pelvic, knee);
  S.analysis = analysis;
  
  updateDisplay();
  updateCompare();
  updateScoreAndAnalysis(score, cva, pelvic, knee, analysis);
}

function computeScore(cva, pelvic, knee) {
  let penalties = 0;
  let reasons = [];
  
  if(cva != null) {
    const target = 50;
    const delta = Math.max(0, target - cva);
    const penalty = Math.min(40, delta * 1.6);
    penalties += penalty;
    if(penalty > 0) {
      reasons.push(`CVA ${cva.toFixed(1)}Â° (ëª©í‘œ ${target}Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  if(pelvic != null) {
    const abs = Math.abs(pelvic);
    const target = 0;
    const penalty = Math.min(30, abs * 2.0);
    penalties += penalty;
    if(penalty > 0) {
      reasons.push(`ê³¨ë°˜ ê¸°ìš¸ê¸° ${pelvic.toFixed(1)}Â° (ëª©í‘œ ${target}Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  if(knee != null) {
    const target = 180;
    const delta = Math.max(0, target - knee);
    const penalty = Math.min(30, delta * 1.0);
    penalties += penalty;
    if(penalty > 0) {
      reasons.push(`ë¬´ë¦ ê° ${knee.toFixed(1)}Â° (ëª©í‘œ ${target}Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  const score = Math.round(clamp(100 - penalties, 0, 100));
  return { score, reasons, penalties };
}

function analyzeMuscles(cva, pelvic, knee) {
  const tight = [];
  const weak = [];
  const comments = [];
  
  // CVA ë¶„ì„
  if(cva != null) {
    if(cva < 50) {
      if(cva < 45) {
        tight.push('ìƒë¶€ìŠ¹ëª¨ê·¼', 'ê²¬ê°‘ê±°ê·¼', 'SCM');
        weak.push('ì‹¬ë¶€ê²½ë¶€êµ´ê·¼', 'í•˜ë¶€ìŠ¹ëª¨ê·¼');
        comments.push(`ì „ë°©ë‘ ìì„¸ ì‹¬ê°: CVA ${cva.toFixed(1)}Â°ë¡œ ëª©í‘œ 50Â°ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤.`);
      } else {
        tight.push('ìƒë¶€ìŠ¹ëª¨ê·¼', 'ê²¬ê°‘ê±°ê·¼');
        weak.push('ì‹¬ë¶€ê²½ë¶€êµ´ê·¼');
        comments.push(`ì „ë°©ë‘ ìì„¸ ê²½ë¯¸: CVA ${cva.toFixed(1)}Â°ë¡œ ëª©í‘œì— ê·¼ì ‘í•©ë‹ˆë‹¤.`);
      }
    } else {
      comments.push(`ê²½ì¶” ì •ë ¬ ì–‘í˜¸: CVA ${cva.toFixed(1)}Â°`);
    }
  }
  
  // ê³¨ë°˜ ê¸°ìš¸ê¸° ë¶„ì„
  if(pelvic != null) {
    const abs = Math.abs(pelvic);
    if(abs > 5) {
      if(pelvic > 0) {
        tight.push('ì¥ìš”ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼');
        weak.push('ë³µíš¡ê·¼', 'ë‘”ê·¼');
        comments.push(`ê³¨ë°˜ ì „ë°©ê²½ì‚¬: ${pelvic.toFixed(1)}Â°ë¡œ ëª©í‘œ 0Â°ë³´ë‹¤ í½ë‹ˆë‹¤.`);
      } else {
        tight.push('ë‘”ê·¼', 'í–„ìŠ¤íŠ¸ë§');
        weak.push('ë³µì§ê·¼', 'ì¥ìš”ê·¼');
        comments.push(`ê³¨ë°˜ í›„ë°©ê²½ì‚¬: ${pelvic.toFixed(1)}Â°ë¡œ ëª©í‘œ 0Â°ë³´ë‹¤ ì‘ìŠµë‹ˆë‹¤.`);
      }
    } else {
      comments.push(`ê³¨ë°˜ ì •ë ¬ ì–‘í˜¸: ${pelvic.toFixed(1)}Â°`);
    }
  }
  
  // ë¬´ë¦ ê°ë„ ë¶„ì„
  if(knee != null) {
    if(knee < 175) {
      if(knee < 165) {
        tight.push('í–„ìŠ¤íŠ¸ë§', 'ë¹„ë³µê·¼', 'ê°€ìë¯¸ê·¼');
        weak.push('ëŒ€í‡´ì‚¬ë‘ê·¼', 'ë‘”ê·¼');
        comments.push(`ë¬´ë¦ ê³¼êµ´ê³¡: ${knee.toFixed(1)}Â°ë¡œ ëª©í‘œ 180Â°ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤.`);
      } else {
        tight.push('í–„ìŠ¤íŠ¸ë§', 'ë¹„ë³µê·¼');
        weak.push('ëŒ€í‡´ì‚¬ë‘ê·¼');
        comments.push(`ë¬´ë¦ ì•½ê°„ êµ´ê³¡: ${knee.toFixed(1)}Â°ë¡œ ëª©í‘œì— ê·¼ì ‘í•©ë‹ˆë‹¤.`);
      }
    } else if(knee <= 185) {
      comments.push(`ë¬´ë¦ ì •ë ¬ ì–‘í˜¸: ${knee.toFixed(1)}Â°`);
    } else {
      comments.push(`ë¬´ë¦ ê³¼ì‹ ì „: ${knee.toFixed(1)}Â°ë¡œ ëª©í‘œë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
    }
  }
  
  return { tight: [...new Set(tight)], weak: [...new Set(weak)], comments };
}

function updateScoreAndAnalysis(scoreData, cva, pelvic, knee, analysis) {
  const scoreEl = document.getElementById("totalScore");
  const reasonEl = document.getElementById("scoreReason");
  const commentEl = document.getElementById("aiComment");
  const commentPanel = document.getElementById("aiCommentPanel");
  const musclePanel = document.getElementById("musclePanel");
  const tightList = document.getElementById("muscleTightList");
  const weakList = document.getElementById("muscleWeakList");
  
  if(scoreData && scoreData.score != null) {
    const score = scoreData.score;
    scoreEl.textContent = score;
    
    // ì ìˆ˜ ìƒ‰ìƒ
    if(score >= 85) {
      scoreEl.style.color = "#2ec4b6";
    } else if(score >= 70) {
      scoreEl.style.color = "#ffd166";
    } else {
      scoreEl.style.color = "#ff6b6b";
    }
    
    // ì ìˆ˜ ê·¼ê±°
    if(scoreData.reasons && scoreData.reasons.length > 0) {
      reasonEl.textContent = "ê°ì  ê·¼ê±°: " + scoreData.reasons.join(", ");
    } else {
      reasonEl.textContent = "ëª¨ë“  ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.";
    }
  } else {
    scoreEl.textContent = "â€”";
    reasonEl.textContent = "";
  }
  
  // AI ì½”ë©˜íŠ¸
  if(analysis && analysis.comments && analysis.comments.length > 0) {
    commentEl.textContent = analysis.comments.join(" ");
    commentPanel.style.display = "block";
  } else {
    commentPanel.style.display = "none";
  }
  
  // ê·¼ìœ¡ ë¶„ì„
  if(analysis && (analysis.tight.length > 0 || analysis.weak.length > 0)) {
    if(analysis.tight.length > 0) {
      tightList.textContent = analysis.tight.join(", ");
    } else {
      tightList.textContent = "ì—†ìŒ";
      tightList.style.color = "var(--muted)";
    }
    
    if(analysis.weak.length > 0) {
      weakList.textContent = analysis.weak.join(", ");
    } else {
      weakList.textContent = "ì—†ìŒ";
      weakList.style.color = "var(--muted)";
    }
    
    musclePanel.style.display = "block";
  } else {
    musclePanel.style.display = "none";
  }
}

function updateDisplay() {
  const M = sessions[cur].metrics;
  document.getElementById("dispCva").textContent = M.cva != null ? M.cva.toFixed(1) + "Â°" : "â€”";
  document.getElementById("dispPel").textContent = M.pelvic != null ? M.pelvic.toFixed(1) + "Â°" : "â€”";
  document.getElementById("dispKnee").textContent = M.knee != null ? M.knee.toFixed(1) + "Â°" : "â€”";
}

function fmtDeg(v) {
  return (v == null || isNaN(v)) ? "â€”" : v.toFixed(1) + "Â°";
}

function deltaStr(b, a, suf = "") {
  if(b == null || a == null || isNaN(b) || isNaN(a)) return "â€”";
  const d = a - b;
  const sign = d > 0 ? "+" : "";
  return sign + d.toFixed(1) + (suf || "");
}

function updateCompare() {
  const B = sessions.Before, A = sessions.After;
  const cB = B.metrics.cva, cA = A.metrics.cva;
  document.getElementById("cmpCvaB").textContent = fmtDeg(cB);
  document.getElementById("cmpCvaA").textContent = fmtDeg(cA);
  document.getElementById("cmpCvaD").textContent = deltaStr(cB, cA, "Â°");

  const pB = B.metrics.pelvic, pA = A.metrics.pelvic;
  document.getElementById("cmpPelB").textContent = fmtDeg(pB);
  document.getElementById("cmpPelA").textContent = fmtDeg(pA);
  document.getElementById("cmpPelD").textContent = deltaStr(pB, pA, "Â°");

  const kB = B.metrics.knee, kA = A.metrics.knee;
  document.getElementById("cmpKneeB").textContent = fmtDeg(kB);
  document.getElementById("cmpKneeA").textContent = fmtDeg(kA);
  document.getElementById("cmpKneeD").textContent = deltaStr(kB, kA, "Â°");
  
  // ì ìˆ˜ ë¹„êµ ì¶”ê°€
  const sB = B.score ? B.score.score : null, sA = A.score ? A.score.score : null;
  if(!document.getElementById("cmpScoreRow")) {
    const tbody = document.querySelector(".tbl tbody");
    const row = document.createElement("tr");
    row.id = "cmpScoreRow";
    row.innerHTML = `
      <td>ì²´í˜• ì ìˆ˜</td>
      <td id="cmpScoreB">â€”</td>
      <td id="cmpScoreA">â€”</td>
      <td id="cmpScoreD">â€”</td>
      <td>0â€“100</td>
    `;
    tbody.appendChild(row);
  }
  document.getElementById("cmpScoreB").textContent = sB != null ? sB : "â€”";
  document.getElementById("cmpScoreA").textContent = sA != null ? sA : "â€”";
  document.getElementById("cmpScoreD").textContent = deltaStr(sB, sA, "");
}

// ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ í† ê¸€
document.getElementById("btnEditCoords").onclick = () => {
  editMode = !editMode;
  const panel = document.getElementById("coordEditPanel");
  const btn = document.getElementById("btnEditCoords");
  if(editMode) {
    panel.style.display = "block";
    btn.style.background = "rgba(124,156,255,0.4)";
    btn.textContent = "âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ (í™œì„±)";
  } else {
    panel.style.display = "none";
    btn.style.background = "rgba(124,156,255,0.2)";
    btn.textContent = "âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ";
    selectedPoint = null;
    document.getElementById("coordSelectPoint").value = "";
    document.getElementById("coordX").value = "";
    document.getElementById("coordY").value = "";
  }
};

// ì  ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½
document.getElementById("coordSelectPoint").addEventListener("change", e => {
  selectedPoint = e.target.value;
  if(selectedPoint) {
    const P = getPts(cur);
    const pt = P[selectedPoint];
    if(pt) {
      document.getElementById("coordX").value = pt.x.toFixed(1);
      document.getElementById("coordY").value = pt.y.toFixed(1);
    } else {
      document.getElementById("coordX").value = "";
      document.getElementById("coordY").value = "";
    }
  }
});

// ì¢Œí‘œ ì ìš©
document.getElementById("coordApply").onclick = () => {
  if(!selectedPoint) {
    alert("ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }
  const x = parseFloat(document.getElementById("coordX").value);
  const y = parseFloat(document.getElementById("coordY").value);
  if(isNaN(x) || isNaN(y)) {
    alert("ì˜¬ë°”ë¥¸ ì¢Œí‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  const W = cv.width / DPR, H = cv.height / DPR;
  const map = sessions[cur].pts;
  map.set(selectedPoint, {
    x: clamp(x, 0, W),
    y: clamp(y, 0, H)
  });
  draw();
  computeAll();
  // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
  document.getElementById("coordX").value = map.get(selectedPoint).x.toFixed(1);
  document.getElementById("coordY").value = map.get(selectedPoint).y.toFixed(1);
};

// ì·¨ì†Œ
document.getElementById("coordCancel").onclick = () => {
  selectedPoint = null;
  document.getElementById("coordSelectPoint").value = "";
  document.getElementById("coordX").value = "";
  document.getElementById("coordY").value = "";
};

// ë“œë˜ê·¸ ê¸°ëŠ¥ (ë§ˆìš°ìŠ¤ + í„°ì¹˜)
function getEventPos(e) {
  if(e.touches && e.touches.length > 0) {
    const r = cv.getBoundingClientRect();
    return {
      x: e.touches[0].clientX - r.left,
      y: e.touches[0].clientY - r.top
    };
  } else {
    const r = cv.getBoundingClientRect();
    return {
      x: e.clientX - r.left,
      y: e.clientY - r.top
    };
  }
}

function startDrag(e) {
  e.preventDefault();
  const pos = getEventPos(e);
  const P = getPts(cur);
  let best = null, bestD = 1e9;
  
  // ë“œë˜ê·¸ ë²”ìœ„ë¥¼ ë„“ê²Œ (20px)
  const threshold = 20;
  
  for(const k of keypoints) {
    const p = P[k.key];
    if(!p) continue;
    const d = Math.hypot(p.x - pos.x, p.y - pos.y);
    if(d < threshold && d < bestD) {
      best = k.key;
      bestD = d;
    }
  }
  
  if(best) {
    dragKey = best;
    
    // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” ì„ íƒí•œ ì  ì •ë³´ë„ ì—…ë°ì´íŠ¸
    if(editMode) {
      selectedPoint = best;
      document.getElementById("coordSelectPoint").value = best;
      const pt = P[best];
      document.getElementById("coordX").value = pt.x.toFixed(1);
      document.getElementById("coordY").value = pt.y.toFixed(1);
    }
    
    // ë“œë˜ê·¸ ì‹œì‘
    return true;
  }
  return false;
}

function doDrag(e) {
  if(!dragKey) return;
  e.preventDefault();
  const pos = getEventPos(e);
  const x = clamp(pos.x, 0, cv.width / DPR);
  const y = clamp(pos.y, 0, cv.height / DPR);
  const map = sessions[cur].pts;
  const p = map.get(dragKey);
  if(!p) return;
  
  p.x = x;
  p.y = y;
  
  // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” ì…ë ¥ í•„ë“œë„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
  if(editMode && selectedPoint === dragKey) {
    document.getElementById("coordX").value = x.toFixed(1);
    document.getElementById("coordY").value = y.toFixed(1);
  }
  
  draw();
  computeAll();
}

function endDrag(e) {
  dragKey = null;
}

// ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
cv.addEventListener('mousedown', startDrag);
window.addEventListener('mousemove', doDrag);
window.addEventListener('mouseup', endDrag);
window.addEventListener('mouseleave', endDrag);

// í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ ì§€ì›)
cv.addEventListener('touchstart', startDrag, {passive: false});
window.addEventListener('touchmove', doDrag, {passive: false});
window.addEventListener('touchend', endDrag);
window.addEventListener('touchcancel', endDrag);

// ì—…ë¡œë“œ
["filePicker","cameraPicker"].forEach(id => {
  document.getElementById(id).addEventListener("change", e => {
    const f = e.target.files[0];
    if(!f) return;
    const img = new Image();
    img.onload = () => {
      sessions[cur].img = img;
      resizeCanvasFor(img);
      sessions[cur].pts.clear();
      draw();
      computeAll();
    };
    img.crossOrigin = "anonymous";
    img.src = URL.createObjectURL(f);
  });
});

// Reset ë²„íŠ¼
document.getElementById("btnReset").onclick = () => {
  sessions[cur].pts.clear();
  draw();
  computeAll();
};

// ì¢Œí‘œ ì €ì¥
document.getElementById("btnSaveJSON").onclick = () => {
  const obj = Object.fromEntries(sessions[cur].pts);
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${cur}_keypoints.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};

// ì¢Œí‘œ ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById("btnLoadJSON").onclick = () => {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'application/json';
  inp.onchange = e => {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const obj = JSON.parse(r.result);
        const map = new Map();
        for(const k of Object.keys(obj)) map.set(k, obj[k]);
        sessions[cur].pts = map;
        draw();
        computeAll();
      } catch(err) {
        alert('JSON íŒŒì‹± ì‹¤íŒ¨: ' + err.message);
      }
    };
    r.readAsText(f);
  };
  inp.click();
};

// PDF ì €ì¥
document.getElementById("btnPDF").onclick = async () => {
  const target = document.body;
  const canvas = await html2canvas(target, {scale:2, backgroundColor:"#fff", useCORS:true});
  const imgData = canvas.toDataURL("image/png");
  const pdf = new jsPDF({orientation:"portrait", unit:"px", format:"a4"});
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const imgW = pageW - 40, imgH = canvas.height * (imgW / canvas.width);
  let y = 20;
  if(imgH < pageH - 40) {
    pdf.addImage(imgData, "PNG", 20, y, imgW, imgH);
  } else {
    let remaining = imgH, sY = 0;
    const onePageH = pageH - 40, sliceH = canvas.height * (onePageH / imgH);
    while(remaining > 0) {
      const pageCanvas = document.createElement("canvas");
      pageCanvas.width = canvas.width;
      pageCanvas.height = Math.min(sliceH, canvas.height - sY);
      const pctx = pageCanvas.getContext("2d");
      pctx.drawImage(canvas, 0, sY, canvas.width, pageCanvas.height, 0, 0, canvas.width, pageCanvas.height);
      const pageImg = pageCanvas.toDataURL("image/png");
      pdf.addImage(pageImg, "PNG", 20, 20, imgW, onePageH * (pageCanvas.height / sliceH));
      remaining -= onePageH;
      sY += sliceH;
      if(remaining > 0) pdf.addPage();
    }
  }
  pdf.save("DIT_ìì„¸_ë¶„ì„_ë¦¬í¬íŠ¸.pdf");
};

// ì´ˆê¸°í™”
resizeCanvasFor(null);
draw();
computeAll();
updateCompare();
</script>
</body>
</html>
