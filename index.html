<!DOCTYPE html>
<html lang="ko">
  <head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIT ìì„¸ ë¶„ì„ AI (ìµœì¢… í†µí•©ë²„ì „)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0b0f14;
  --panel: rgba(30, 34, 42, 0.7);
  --accent: #7c9cff;
  --accent2: #ffb86c;
  --ink: #e7eef7;
  --muted: #9bb0c7;
  --radius: 18px;
}
* { box-sizing: border-box; }
html, body {
  margin: 0; 
  padding: 0;
  height: 100%;
  -webkit-overflow-scrolling: touch;
}
body {
  background: var(--bg); 
  color: var(--ink);
  font-family: "Noto Sans KR", sans-serif;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  overflow-x: hidden;
}
.panel {
  background: var(--panel);
  backdrop-filter: blur(20px);
  border-radius: var(--radius);
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
}
.sidebar { 
  padding: 12px; 
  overflow-y: auto;
  overflow-x: hidden;
  max-height: 50vh;
  -webkit-overflow-scrolling: touch;
}
.title { 
  font-size: 16px; 
  font-weight:800; 
  margin-bottom: 6px; 
  line-height: 1.3;
}
.muted { 
  color: var(--muted); 
  font-size: 11px; 
  line-height: 1.4;
}
.btn {
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 10px 14px;
  background: rgba(255,255,255,0.05);
  color: var(--ink);
  cursor: pointer;
  font-size: 13px;
  width: 100%;
  text-align: center;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.btn:hover, .btn:active { 
  background: rgba(255,255,255,0.12); 
}
.seg { 
  display: flex; 
  border-radius: 10px; 
  overflow: hidden; 
  margin-top: 8px; 
  gap: 4px;
}
.seg button { 
  flex:1; 
  border:0; 
  background: rgba(255,255,255,0.04); 
  color:var(--muted); 
  padding:10px 8px; 
  cursor:pointer; 
  font-size: 13px;
  touch-action: manipulation;
}
.seg button.active { 
  background: rgba(124,156,255,0.25); 
  color:var(--ink); 
}
label.btn { 
  display: block;
  width: 100%;
  margin-bottom: 8px;
}
label.btn input { display:none; }
.tbl { 
  width:100%; 
  border-collapse:collapse; 
  font-size:11px; 
  overflow-x: auto;
  display: table;
  -webkit-overflow-scrolling: touch;
}
.tbl th,.tbl td { 
  border-bottom:1px solid rgba(255,255,255,0.1); 
  padding:6px 4px; 
  text-align: center;
  font-size: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.canvasWrap { 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  flex: 1;
  min-height: 50vh;
  padding: 8px;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  position: relative;
}
.canvasWrap.zoomed {
  align-items: flex-start;
  justify-content: flex-start;
}
canvas { 
  border-radius:var(--radius); 
  background:#0a0e13; 
  cursor: crosshair; 
  touch-action: none; /* ë“œë˜ê·¸ì™€ ìŠ¤í¬ë¡¤ì„ JavaScriptë¡œ ì œì–´ */
  display: block;
  flex-shrink: 0;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
  -moz-user-select: none;
       user-select: none;
  -webkit-user-select: none;
}
</style>
    <script type="module" crossorigin src="/posture-ai-kor/assets/main-B5Qt9EMX.js"></script>
  </head>
  <body>
<aside class="panel sidebar" style="order: 1;">
  <div class="title">ğŸ“¸ DIT ìì„¸ ë¶„ì„ AI</div>
  <div class="muted">íŒŒì¼ ì—…ë¡œë“œ â†’ ì ì„ ë“œë˜ê·¸ë¡œ ì¡°ì • â†’ ê°ë„ ìë™ ê³„ì‚°</div>

  <div class="seg">
    <button id="btnBefore" class="active">Before</button>
    <button id="btnAfter">After</button>
  </div>
  <div style="margin-top:8px; display:flex; flex-direction:column; gap:8px;">
    <div class="seg" style="margin-bottom:4px;">
      <button id="btnOrientationSide" class="active">ğŸ“ ì˜†ëª¨ìŠµ</button>
      <button id="btnOrientationFront">ğŸ“· ì •ë©´</button>
    </div>
    <label class="btn">ğŸ“· íŒŒì¼ ì„ íƒ
      <input id="filePicker" type="file" accept="image/*">
    </label>
    <label class="btn">ğŸ“¸ ì§ì ‘ ì´¬ì˜
      <input id="cameraPicker" type="file" accept="image/*" capture="environment">
    </label>
    <button class="btn" id="btnReset">â†º ì´ˆê¸°í™”</button>
    <button class="btn" id="btnCalibrate" style="background: rgba(255,184,108,0.2);">ğŸ“ ìº˜ë¦¬ë¸Œë ˆì´ì…˜</button>
  </div>

  <div id="calibrationPanel" style="margin-top:12px; padding:10px; background:rgba(255,184,108,0.1); border-radius:10px; display:none;">
    <div class="muted" style="margin-bottom:8px; font-weight:600;">ğŸ“ ìº˜ë¦¬ë¸Œë ˆì´ì…˜</div>
    <div class="muted" style="font-size:11px; margin-bottom:8px;">ê¸°ì¤€ ë§ˆì»¤ ë‘ ì ì„ ì°ê³  ì‹¤ì œ ê¸¸ì´(cm)ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
    <div style="margin-bottom:8px;">
      <input type="number" id="calibrationLength" placeholder="ì‹¤ì œ ê¸¸ì´ (cm)" step="0.1" min="0.1" style="width:100%; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.3); color:var(--ink);">
    </div>
    <div class="muted" style="font-size:11px; margin-bottom:4px;">ì  1: <span id="calPoint1">í´ë¦­í•˜ì—¬ ì„ íƒ</span></div>
    <div class="muted" style="font-size:11px; margin-bottom:8px;">ì  2: <span id="calPoint2">í´ë¦­í•˜ì—¬ ì„ íƒ</span></div>
    <button class="btn" id="btnCalibrateConfirm" style="width:100%; margin-bottom:8px;">âœ… ê³„ì‚°</button>
    <button class="btn" id="btnCalibrateCancel" style="width:100%;">âŒ ì·¨ì†Œ</button>
    <div id="calibrationResult" class="muted" style="font-size:11px; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);"></div>
  </div>

  <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
    <button class="btn" id="btnEditCoords" style="background: rgba(124,156,255,0.2);">âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ</button>
    <button class="btn" id="btnSaveJSON">ğŸ’¾ ì¢Œí‘œ ì €ì¥</button>
    <button class="btn" id="btnLoadJSON">ğŸ“‚ ì¢Œí‘œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button class="btn" id="btnPDF">ğŸ“„ PDF ì €ì¥</button>
    <button class="btn" id="btnImage">ğŸ–¼ï¸ ê·¸ë¦¼ìœ¼ë¡œ ì €ì¥</button>
    <button class="btn" id="btnShare">ğŸ“¤ ê³µìœ í•˜ê¸°</button>
  </div>

  <div id="coordEditPanel" style="margin-top:12px; padding:10px; background:rgba(124,156,255,0.1); border-radius:10px; display:none;">
    <div class="muted" style="margin-bottom:8px; font-weight:600;">ì¢Œí‘œ ìˆ˜ì •</div>
    <div style="margin-bottom:8px;">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">í™•ëŒ€ ë°°ìœ¨</div>
      <select id="zoomLevel" class="btn" style="width:100%; padding:6px; margin-bottom:8px;">
        <option value="1">ì›ë³¸ í¬ê¸° (1ë°°)</option>
        <option value="2">2ë°° í™•ëŒ€ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</option>
        <option value="3">3ë°° í™•ëŒ€ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</option>
        <option value="4">4ë°° í™•ëŒ€ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</option>
      </select>
      <div class="muted" style="font-size:10px; margin-top:4px; margin-bottom:8px; line-height:1.4;">í™•ëŒ€ ì‹œ ì–‘ì†ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì—¬ ì´ë™ ê°€ëŠ¥</div>
    </div>
    <div style="margin-bottom:8px;">
      <select id="coordSelectPoint" class="btn" style="width:100%; padding:6px; margin-bottom:6px;">
        <option value="">ì  ì„ íƒ...</option>
        <!-- ì˜µì…˜ì€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨ -->
      </select>
    </div>
    <div style="display:flex; flex-direction:column; gap:6px; margin-bottom:6px;">
      <div>
        <div class="muted" style="font-size:11px; margin-bottom:4px;">X ì¢Œí‘œ</div>
        <div style="display:flex; gap:4px; align-items:center;">
          <input type="number" id="coordX" class="btn" style="flex:1; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);" step="0.1" placeholder="X">
          <button class="btn" id="coordXDec" style="padding:8px 12px; background:rgba(255,107,107,0.2); border:1px solid rgba(255,107,107,0.3); min-width:40px;">âˆ’</button>
          <button class="btn" id="coordXInc" style="padding:8px 12px; background:rgba(46,196,182,0.2); border:1px solid rgba(46,196,182,0.3); min-width:40px;">+</button>
        </div>
      </div>
      <div>
        <div class="muted" style="font-size:11px; margin-bottom:4px;">Y ì¢Œí‘œ</div>
        <div style="display:flex; gap:4px; align-items:center;">
          <input type="number" id="coordY" class="btn" style="flex:1; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);" step="0.1" placeholder="Y">
          <button class="btn" id="coordYDec" style="padding:8px 12px; background:rgba(255,107,107,0.2); border:1px solid rgba(255,107,107,0.3); min-width:40px;">âˆ’</button>
          <button class="btn" id="coordYInc" style="padding:8px 12px; background:rgba(46,196,182,0.2); border:1px solid rgba(46,196,182,0.3); min-width:40px;">+</button>
        </div>
      </div>
    </div>
    <button class="btn" id="coordApply" style="width:100%; background:rgba(124,156,255,0.3);">ì ìš©</button>
    <button class="btn" id="coordCancel" style="width:100%; margin-top:6px; background:rgba(255,255,255,0.05);">ì·¨ì†Œ</button>
  </div>

  <div style="margin-top:12px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px;">
    <div class="muted" style="margin-bottom:6px;">í˜„ì¬ ì„¸ì…˜: <span id="currentSession">Before</span></div>
    
    <!-- ì£¼ìš” ì§€í‘œ (ê°„ëµ í‘œì‹œ) -->
    <div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.1);">
      <div class="muted" style="margin-bottom:4px;">CVA: <span id="dispCva">â€”</span></div>
      <div class="muted" style="margin-bottom:4px;">TRUNK: <span id="dispPel">â€”</span></div>
      <div class="muted" style="margin-bottom:4px;">KNEE: <span id="dispKnee">â€”</span></div>
    </div>
    
    <!-- ì „ì²´ ë¶„ì„ í•­ëª© (16ê°€ì§€) -->
    <div id="allMetricsPanel" style="max-height:300px; overflow-y:auto; margin-bottom:8px;">
      <div style="font-size:12px; font-weight:600; margin-bottom:6px; color:#7c9cff;">ğŸ“Š ì „ì²´ ë¶„ì„ í•­ëª©</div>
      <div id="allMetricsList" style="font-size:11px; line-height:1.6;"></div>
    </div>
    
    <div style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1);">
      <div style="font-size:14px; font-weight:600; margin-bottom:8px;">ğŸ“Š ì²´í˜• ì¢…í•© ì ìˆ˜</div>
      <div id="totalScore" style="font-size:32px; font-weight:800; margin-bottom:8px;">â€”</div>
      <div id="scoreReason" class="muted" style="font-size:11px; line-height:1.4; margin-bottom:8px;"></div>
      <div id="pdsScore" class="muted" style="font-size:12px; margin-top:6px;">PDS: <span id="pdsValue">â€”</span></div>
    </div>
  </div>

  <div id="aiCommentPanel" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#2ec4b6;">ğŸ¤– AI ì²´í˜• ë¶„ì„</div>
    <div id="aiComment" class="muted" style="font-size:12px; line-height:1.5;"></div>
    
    <!-- ê°œì¸ë³„ ì²´í˜• ë¶„ì„ ì„¤ëª… -->
    <div id="postureTypeDesc" style="margin-top:12px; padding:10px; background:rgba(255,255,255,0.1); border-radius:8px; border-left:3px solid #2ec4b6;">
      <div style="font-size:13px; font-weight:600; margin-bottom:6px; color:#2ec4b6;">ğŸ“Œ ì²´í˜• ìœ í˜• ë¶„ì„</div>
      <div id="postureTypeContent" style="font-size:11px; line-height:1.6; color:var(--muted);"></div>
    </div>
  </div>
  
  <!-- 16ê°œ í•­ëª© ìƒì„¸ ì„¤ëª… -->
  <div id="metricsDescPanel" style="margin-top:12px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#7c9cff;">ğŸ“‹ ë¶„ì„ í•­ëª© ì„¤ëª…</div>
    <div style="font-size:11px; color:#7c9cff; margin-bottom:8px; padding:4px 8px; background:rgba(124,156,255,0.2); border-radius:4px; display:inline-block;">ì¸¡ë©´ í•­ëª© (ì˜†ëª¨ìŠµ)</div>
    <div style="font-size:11px; color:#2ec4b6; margin-bottom:8px; padding:4px 8px; background:rgba(46,196,182,0.2); border-radius:4px; display:inline-block; margin-left:8px;">ì •ë©´ í•­ëª© (ì•ëª¨ìŠµ)</div>
    <div id="metricsDescContent" style="max-height:400px; overflow-y:auto; font-size:11px; line-height:1.6;">
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">CVA (Craniovertebral Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ê·€ ë’¤ ìœ ì–‘ëŒê¸°(Tragus)ì™€ ì œ7ê²½ì¶”(C7) ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ê±°ë¶ëª© ìì„¸ì˜ ì •ë„ë¥¼ í‰ê°€í•˜ëŠ” ê°€ì¥ ì¤‘ìš”í•œ ì§€í‘œì…ë‹ˆë‹¤. ê°ë„ê°€ ì‘ì„ìˆ˜ë¡ ë¨¸ë¦¬ê°€ ì•ìœ¼ë¡œ ë‚˜ì˜¨ ìƒíƒœì…ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¥50Â° (ê°ë„ê°€ í´ìˆ˜ë¡ ì¢‹ìŒ)<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> CVA &lt; 50Â°ëŠ” ì „ë°©ë‘ë¶€ìì„¸(FHP)ë¥¼ ì˜ë¯¸í•˜ë©°, ê²½ì¶” ê·¼ìœ¡ ê¸´ì¥, ë‘í†µ, ëª© í†µì¦ì˜ ì›ì¸ì´ ë©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">HPD (Head Protrusion Distance)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ê·€(Tragus)ì™€ ì–´ê¹¨(Acromion) ì‚¬ì´ì˜ ìˆ˜í‰ ê±°ë¦¬<br>
          <strong>ì˜ë¯¸:</strong> ë¨¸ë¦¬ê°€ ëª¸í†µì—ì„œ ì–¼ë§ˆë‚˜ ì•ìœ¼ë¡œ ëŒì¶œë˜ì–´ ìˆëŠ”ì§€ë¥¼ cm ë‹¨ìœ„ë¡œ ì¸¡ì •í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤2cm<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> 2cm ì´ˆê³¼ ì‹œ ê²½ì¶” ë¶€ë‹´ ì¦ê°€, ìƒë¶€ ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥, ëª©-ì–´ê¹¨ í†µì¦ ìœ ë°œ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">NIA (Neck Inclination Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ì–´ê¹¨ì—ì„œ ê·€ë¡œ í–¥í•˜ëŠ” ì„ ê³¼ ìˆ˜í‰ì„  ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ëª©ì˜ ì „ë°© ê¸°ìš¸ê¸° ì •ë„ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. CVAì™€ í•¨ê»˜ ê±°ë¶ëª©ì„ í‰ê°€í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-20Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> 20Â° ì´ˆê³¼ ì‹œ ê²½ì¶” ì‹ ì „ê·¼ ì•½í™” ë° êµ´ê³¡ê·¼ ê¸´ì¥ì´ ì˜ì‹¬ë©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">TIA (Trunk Inclination Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ì–´ê¹¨(Acromion)ì™€ ê³¨ë°˜(Hip)ì„ ì—°ê²°í•œ ì„ ê³¼ ìˆ˜ì§ì„  ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ëª¸í†µì˜ ì•ë’¤ ê¸°ìš¸ê¸°ë¥¼ í‰ê°€í•˜ì—¬ ì „ì²´ì ì¸ ì²´ê°„ ì •ë ¬ì„ í™•ì¸í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-10Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> 10Â° ì´ˆê³¼ ì‹œ ìš”ì¶” ê³¼ì „ë§Œ ë˜ëŠ” í‰í‰í•œ ë“±(Flat Back) ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">SAA (Scapular Alignment Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ì–´ê¹¨(Acromion)ì™€ ê³¨ë°˜ í›„ë©´(PSIS)ì„ ì—°ê²°í•œ ì„ ê³¼ ìˆ˜í‰ì„  ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ì–´ê¹¨ë¼ˆì˜ ì •ë ¬ ìƒíƒœì™€ ìƒë¶€ ì²´ê°„ì˜ ìì„¸ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-10Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> ì´ìƒ ì‹œ ê²¬ê°‘ê³¨ ë‚ ê°œë¼ˆ(Winging) ë˜ëŠ” ì–´ê¹¨ ì „ë°© ë§ë¦¼ì´ ì˜ì‹¬ë©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">PTA (Pelvic Tilt Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> í›„ìƒì¥ê³¨ê·¹(PSIS)ê³¼ ì „ìƒì¥ê³¨ê·¹(ASIS)ì„ ì—°ê²°í•œ ì„ ê³¼ ìˆ˜í‰ì„  ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ê³¨ë°˜ì˜ ì „ë°© ë˜ëŠ” í›„ë°© ê¸°ìš¸ê¸°ë¥¼ í‰ê°€í•˜ëŠ” í•µì‹¬ ì§€í‘œì…ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-15Â° (ì•½ê°„ì˜ ì „ë°© ê²½ì‚¬ëŠ” ì •ìƒ)<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> &gt;15Â°ëŠ” ê³¨ë°˜ ì „ë°© ê²½ì‚¬(ìš”ì¶” ê³¼ì „ë§Œ), &lt;0Â°ëŠ” ê³¨ë°˜ í›„ë°© ê²½ì‚¬(ìš”ì¶” í‰í‰)ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">KA (Knee Alignment Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ê³ ê´€ì ˆ(Hip)-ë¬´ë¦(Knee)-ë°œëª©(Ankle) ì„¸ ì ì´ ì´ë£¨ëŠ” ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ë¬´ë¦ ê´€ì ˆì˜ ì‹ ì „(í´ì§) ì •ë„ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 175-185Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> &lt;175Â°ëŠ” ë¬´ë¦ ê³¼êµ´ê³¡(ìŠ¬ê°œê±´ ë¶€ë‹´), &gt;185Â°ëŠ” ë¬´ë¦ ê³¼ì‹ ì „(ê´€ì ˆ ë¶ˆì•ˆì •ì„±)ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">Tibial Angle (ê²½ê³¨ ê²½ì‚¬ê°)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ë¬´ë¦(Knee)ê³¼ ë°œëª©(Ankle)ì„ ì—°ê²°í•œ ì„ ê³¼ ìˆ˜ì§ì„  ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ì •ê°•ì´(ê²½ê³¨)ì˜ ì•ë’¤ ê¸°ìš¸ê¸°ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-10Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> ê³¼ë„í•œ ê²½ì‚¬ëŠ” ë°œëª© ë¶ˆì•ˆì •ì„± ë° ì¢…ì•„ë¦¬ ê·¼ìœ¡ ë¶ˆê· í˜•ì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">Q-Angle (ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ASIS-ìŠ¬ê°œê³¨(Patella)-ê²½ê³¨ì¡°ë©´(Tibial Tuberosity) ì„¸ ì ì´ ì´ë£¨ëŠ” ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ëŒ€í‡´ì‚¬ë‘ê·¼ì˜ ë‹¹ê¹€ ë°©í–¥ì„ í‰ê°€í•˜ì—¬ ë¬´ë¦ ì •ë ¬ì„ í™•ì¸í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> ë‚¨ì„± 10-15Â°, ì—¬ì„± 15-20Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> &gt;20Â°ëŠ” ìŠ¬ê°œê³¨ ì™¸ì¸¡ ì „ìœ„ ë° ìŠ¬ê°œëŒ€í‡´ í†µì¦ ì¦í›„êµ°ì˜ ìœ„í—˜ ìš”ì¸ì…ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">Knee Deviation (ë¬´ë¦ ë†’ì´ ì°¨)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ì¢Œìš° ë¬´ë¦ì˜ ë†’ì´ ì°¨ì´ë¥¼ ê°ë„ë¡œ í™˜ì‚°<br>
          <strong>ì˜ë¯¸:</strong> ì–‘ìª½ ë¬´ë¦ì˜ ìˆ˜í‰ ì •ë ¬ì„ í‰ê°€í•˜ì—¬ ê³¨ë°˜ ê¸°ìš¸ê¸°ë¥¼ ê°„ì ‘ì ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-3Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> 3Â° ì´ˆê³¼ ì‹œ ê³¨ë°˜ íšŒì „(Pelvic Rotation) ë˜ëŠ” ì²™ì¶” ì¸¡ë§Œì¦ì´ ì˜ì‹¬ë©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">LLD (Leg Length Discrepancy)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ì¢Œìš° ë‹¤ë¦¬ ê¸¸ì´(Hip-Ankle) ì°¨ì´ë¥¼ cm ë‹¨ìœ„ë¡œ ì¸¡ì •<br>
          <strong>ì˜ë¯¸:</strong> ê¸°ëŠ¥ì  ë˜ëŠ” êµ¬ì¡°ì  ë‹¤ë¦¬ ê¸¸ì´ ì°¨ì´ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤1cm<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> 1cm ì´ˆê³¼ ì‹œ ê³¨ë°˜ ë¹„ëŒ€ì¹­, ì²™ì¶” ì¸¡ë§Œ, ë³´í–‰ ì´ìƒì´ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë©° ë³´ìƒ ìì„¸ë¡œ ì¸í•œ ë§Œì„± í†µì¦ì˜ ì›ì¸ì´ ë©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">GSB (Global Sagittal Balance)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ê·€(Tragus)ì™€ ë°œëª©(Ankle)ì˜ ìˆ˜í‰ ê±°ë¦¬<br>
          <strong>ì˜ë¯¸:</strong> ì „ì‹ ì˜ ì‹œìƒë©´(ì˜†ì—ì„œ ë³¸) ê· í˜•ì„ ì¢…í•©ì ìœ¼ë¡œ í‰ê°€í•˜ëŠ” ì§€í‘œì…ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤2cm<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> 2cm ì´ˆê³¼ ì‹œ ì¤‘ë ¥ ì¤‘ì‹¬ì„  ì´íƒˆë¡œ ì¸í•œ ì „ì²´ ê·¼ê³¨ê²©ê³„ ë¶€ë‹´ ì¦ê°€ ë° ì—ë„ˆì§€ ì†Œëª¨ê°€ ì¦ê°€í•©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">BVA (Body Vertical Alignment)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ë¨¸ë¦¬-ì–´ê¹¨-ê³¨ë°˜-ë¬´ë¦-ë°œëª© ë“± ì£¼ìš” ê´€ì ˆì˜ ìˆ˜ì§ì„  ì •ë ¬ ë²”ìœ„<br>
          <strong>ì˜ë¯¸:</strong> ëª¨ë“  ì£¼ìš” ê´€ì ˆì´ í•˜ë‚˜ì˜ ìˆ˜ì§ì„ ìƒì— ì •ë ¬ë˜ì–´ ìˆëŠ”ì§€ í‰ê°€í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤2cm (ìµœëŒ€ í¸ì°¨)<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> ë¶ˆëŸ‰í•œ ìˆ˜ì§ ì •ë ¬ì€ íŠ¹ì • ê´€ì ˆ ë° ê·¼ìœ¡ì— ê³¼ë¶€í•˜ë¥¼ ì¼ìœ¼ì¼œ ë§Œì„± í†µì¦ê³¼ í‡´í–‰ì„± ë³€í™”ë¥¼ ê°€ì†í™”í•©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">SCI (Spinal Curvature Index)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ì²™ì¶”ì˜ ê²½ì¶” ë° ìš”ì¶” ì „ë§Œ(ì•ìœ¼ë¡œ êµ½ìŒ) ê³¡ì„ ì˜ ë¹„ìœ¨<br>
          <strong>ì˜ë¯¸:</strong> ì²™ì¶”ì˜ ìì—°ìŠ¤ëŸ¬ìš´ Sì ê³¡ì„ ì´ ì ì ˆí•˜ê²Œ ìœ ì§€ë˜ëŠ”ì§€ í‰ê°€í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0.15-0.35<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> &lt;0.15ëŠ” í‰í‰í•œ ì²™ì¶”(ì¶©ê²© í¡ìˆ˜â†“), &gt;0.35ëŠ” ê³¼ë„í•œ ë§Œê³¡(ë””ìŠ¤í¬ ì••ë ¥â†‘)ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">HPA (Headâ€“Pelvis Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ë¨¸ë¦¬(Tragus)ì™€ ê³¨ë°˜(PSIS)ì„ ì—°ê²°í•œ ì„ ê³¼ ìˆ˜ì§ì„  ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ë¨¸ë¦¬ì™€ ê³¨ë°˜ì˜ ìƒëŒ€ì  ìœ„ì¹˜ ê´€ê³„ë¥¼ í†µí•´ ì „ì‹  ìì„¸ë¥¼ ì¢…í•© í‰ê°€í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-10Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> ì´ìƒ ê°ë„ëŠ” ë¨¸ë¦¬-ê³¨ë°˜ ë¶„ì ˆ ê°„ í˜‘ì‘ ë¶€ì¡±ì„ ë‚˜íƒ€ë‚´ë©°, ì „ì‹  ìì„¸ ë¶ˆê· í˜•ì˜ ì§€í‘œì…ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">PDS (Postural Deviation Score)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ìœ„ 15ê°œ í•­ëª©ì˜ ë¹„ì •ìƒ ì •ë„ë¥¼ ì ìˆ˜í™”í•˜ì—¬ í•©ì‚°<br>
          <strong>ì˜ë¯¸:</strong> ì „ì²´ì ì¸ ìì„¸ ë¶ˆê· í˜•ì˜ ì •ë„ë¥¼ í•˜ë‚˜ì˜ ìˆ«ìë¡œ ìš”ì•½í•œ ì¢…í•© ì§€í‘œì…ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-10ì <br>
          <strong>ë¶„ë¥˜:</strong> 0-10 (ì •ìƒ), 11-20 (ê²½ë¯¸), 21-30 (ì¤‘ë“±ë„), 31+ (ì‹¬ê°)<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> ì ìˆ˜ê°€ ë†’ì„ìˆ˜ë¡ ë‹¤ì–‘í•œ ìì„¸ ë¬¸ì œê°€ ë³µí•©ì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ë©°, ì „ë¬¸ì ì¸ êµì • ì¹˜ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.
        </div>
      </details>
      
      <!-- ì •ë©´ í•­ëª© (ì•ëª¨ìŠµ) - ìƒ‰ìƒ: #2ec4b6 -->
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">STA (Shoulder Tilt Angle) - ì–´ê¹¨ ì¢Œìš° ê¸°ìš¸ê¸°</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle(line(L_acromion, R_acromion), horizontal)<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì¹´ë©”ë¼ë¥¼ ê°€ìŠ´ ì¤‘ì•™ ë†’ì´ì— ê³ ì •í•˜ê³  í”¼í—˜ìëŠ” ì •ë©´ìœ¼ë¡œ ì„  ìì„¸ ìœ ì§€. â‘¡ ì¢ŒÂ·ìš° Acromionì˜ ì¢Œí‘œë¥¼ ì¸ì‹. â‘¢ Î”yë¥¼ ê°ë„ë¡œ ë³€í™˜(atan(Î”y / Î”x)).<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤ 3Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ ì–´ê¹¨ ì¢Œìš° ë¶ˆê· í˜•, ìŠ¹ëª¨ê·¼Â·ëŠ¥í˜•ê·¼ ê¸´ì¥ ì°¨ì´ ê°€ëŠ¥ì„±.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">POA (Pelvic Obliquity Angle) - ê³¨ë°˜ ì¢Œìš° ê¸°ìš¸ê¸°</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle(line(L_ASIS, R_ASIS), horizontal)<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì¹´ë©”ë¼ë¥¼ ê³¨ë°˜ ë†’ì´ì— ë§ì¶”ê³  ì •ë©´ì—ì„œ ì´¬ì˜. â‘¡ ì¢ŒÂ·ìš° ASISë¥¼ ì¸ì‹í•˜ê³  Î”y ê³„ì‚°. â‘¢ ê°ë„ ê³„ì‚°: POA = atan(Î”y / Î”x).<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤ 3Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ ê³¨ë°˜ ì¢Œìš° ë¹„ëŒ€ì¹­ / í•˜ì§€ ê¸¸ì´ ì°¨ / ìš”ì¶” ì¸¡ë§Œ ê°€ëŠ¥ì„±.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">LLD (Leg Length Discrepancy) - í•˜ì§€ ê¸¸ì´ ì°¨</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> |distance(L_ASIS, L_ankle) - distance(R_ASIS, R_ankle)|<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì „ì‹ ì´ ë³´ì´ë„ë¡ ì •ë©´ ì´¬ì˜. â‘¡ ì¢ŒÂ·ìš° ASIS ë° ë°œëª©(Ankle) ì¢Œí‘œ ì¸ì‹. â‘¢ ê±°ë¦¬(cm) í™˜ì‚°(pxPerCm ë³´ì •).<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤ 1 cm<br>
          <strong>í•´ì„:</strong> â†‘ â†’ êµ¬ì¡°ì  ë˜ëŠ” ê¸°ëŠ¥ì  í•˜ì§€ ê¸¸ì´ ì°¨ ì¡´ì¬.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">TD (Trunk Deviation) - ì²´ê°„ í¸ìœ„</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> horizontal deviation(C7, midline(L_ankle, R_ankle))<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì¹´ë©”ë¼ë¥¼ ì •ë©´, ì–‘ ë°œëª©ì´ ìˆ˜í‰ì— ì˜¤ë„ë¡ ì´¬ì˜. â‘¡ L/R Ankle ì¢Œí‘œë¡œ ì¤‘ê°„ì„ (midpoint) ê³„ì‚°. â‘¢ C7ì˜ ìˆ˜í‰ ê±°ë¦¬ í¸ì°¨ ê³„ì‚°.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> Â± 2Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ ì²´ê°„ì´ ì¢Œìš°ë¡œ ê¸°ìš¸ì–´ì§ / ì²´ì¤‘ ì¤‘ì‹¬ ë¶ˆê· í˜•.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">HTA (Head Tilt Angle) - ë¨¸ë¦¬ ì¢Œìš° ê¸°ìš¸ê¸°</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle(line(L_tragus, R_tragus), horizontal)<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì •ë©´ì—ì„œ Tragus ì¢Œìš°ê°€ ëª…í™•íˆ ë³´ì´ë„ë¡ ì´¬ì˜. â‘¡ ë‘ ì ì˜ yì¢Œí‘œ ì°¨ì´ ê³„ì‚° â†’ ê°ë„ë¡œ ë³€í™˜.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤ 3Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ ê²½ë¶€ ì¸¡êµ´ ë˜ëŠ” ì¸¡ë§Œì„± ê¸´ì¥ íŒ¨í„´.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">SPP (Shoulderâ€“Pelvis Parallelism) - ì–´ê¹¨-ê³¨ë°˜ í‰í–‰ë„</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle_diff(line(L_acromion, R_acromion), line(L_ASIS, R_ASIS))<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì •ë©´ ì´¬ì˜ ì‹œ L/R ì–´ê¹¨ì™€ L/R ASISê°€ ëª¨ë‘ ë³´ì—¬ì•¼ í•¨. â‘¡ ë‘ ì„ ì˜ ê°ë„ ì°¨ ê³„ì‚°.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0â€“3Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ ì²´ê°„ íšŒì „ / ê³¨ë°˜ ë¹„í‹€ë¦¼ / ì²™ì¶” íšŒì „ì„± ë¶ˆê· í˜•.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">KAS (Knee Alignment Symmetry) - ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„±</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle_diff(line(L_knee, L_ankle), line(R_knee, R_ankle))<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì •ë©´ì—ì„œ ë¬´ë¦ê³¼ ë°œëª© ëª¨ë‘ ì¸ì‹. â‘¡ ê° ë¬´ë¦â€“ë°œëª© ìˆ˜ì§ì„ ì˜ ê°ë„ ë¹„êµ.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> ëŒ€ì¹­(Â±2Â° ì´ë‚´)<br>
          <strong>í•´ì„:</strong> â†‘ â†’ í•œìª½ ë‚´ë°˜/ì™¸ë°˜ ë˜ëŠ” í•˜ì§€ íšŒì „ íŒ¨í„´.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">LLAS (Lower Limb Axis Symmetry) - í•˜ì§€ ì¶• ëŒ€ì¹­ì„±</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle_diff(line(L_ASIS, L_ankle), line(R_ASIS, R_ankle))<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì •ë©´ì—ì„œ í•˜ì§€ ì „ì²´ ì´¬ì˜. â‘¡ ê° í•˜ì§€ì¶• ë¼ì¸ ê°ë„ ë¹„êµ.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> Â±2Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ í•œìª½ íšŒë‚´Â·íšŒì™¸ ë˜ëŠ” í•˜ì§€ íšŒì „ì„± ë¶ˆê· í˜•.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">FBA (Foot Base Angle) - ë°œ ì •ë ¬ ê°ë„</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle(line(ankle, toe), body midline)<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  í”¼í—˜ìëŠ” ë°œëê¹Œì§€ ë³´ì´ê²Œ ì •ë©´ìœ¼ë¡œ ì„ ë‹¤. â‘¡ ë°œ ì¤‘ì‹¬ì„ (ankleâ€“toe)ê³¼ ëª¸ ì¤‘ì‹¬ì„  ê°„ ê°ë„ ê³„ì‚°.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0â€“10Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ ê³¼ë„í•œ ì™¸íšŒì „(íšŒì™¸) / â†“ â†’ íšŒë‚´ ê²½í–¥.
        </div>
      </details>
    </div>
  </div>
  
  <!-- ì‹¤ì‹œê°„ ë¶„ì„ ê²°ê³¼ íŒ¨ë„ -->
  <div id="liveAnalysisPanel" style="margin-top:12px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#7c9cff;">ğŸ“Š ì‹¤ì‹œê°„ AI ë¶„ì„ ê²°ê³¼</div>
    <div id="livePDS" style="font-size:16px; font-weight:700; margin-bottom:8px; color:#7c9cff;">PDS: â€”</div>
    <div id="livePatterns" style="font-size:12px; line-height:1.6;"></div>
  </div>

  <div id="musclePanel" style="margin-top:12px; padding:12px; background:rgba(255,184,108,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#ffb86c;">ğŸ’ª ê·¼ìœ¡ ìƒíƒœ ë¶„ì„</div>
    <div id="muscleTight" style="margin-bottom:8px;">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">ğŸ”´ ê¸´ì¥ëœ ê·¼ìœ¡:</div>
      <div id="muscleTightList" style="font-size:12px; color:#ff6b6b; line-height:1.5;"></div>
    </div>
    <div id="muscleWeak" style="margin-bottom:8px;">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">ğŸ”µ ì•½í™”ëœ ê·¼ìœ¡:</div>
      <div id="muscleWeakList" style="font-size:12px; color:#7c9cff; line-height:1.5;"></div>
    </div>
    <div id="muscleDetail" style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">ğŸ“‹ ìƒì„¸ ë¶„ì„:</div>
      <div id="muscleDetailList" style="font-size:11px; line-height:1.6; color:var(--ink);"></div>
    </div>
  </div>

  <div id="exercisePanel" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.15); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#2ec4b6;">ğŸ‹ï¸ ì¶”ì²œ ìš´ë™</div>
    <div id="exerciseList" style="font-size:12px; line-height:1.6;"></div>
  </div>

  <div id="pilatesPanel" style="margin-top:12px; padding:12px; background:rgba(156,136,255,0.15); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#9c88ff;">ğŸ§˜ í•„ë¼í…ŒìŠ¤ ì„¸ì…˜ ì¶”ì²œ</div>
    <div id="pilatesList" style="font-size:12px; line-height:1.6;"></div>
  </div>

  <!-- í•„ë¼í…ŒìŠ¤ ìš´ë™ ìƒì„¸ ì„¤ëª… ëª¨ë‹¬ -->
  <div id="pilatesExerciseModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; overflow-y:auto; padding:20px; box-sizing:border-box;">
    <div style="max-width:600px; margin:0 auto; background:#1a1a2e; border-radius:12px; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 id="modalExerciseTitle" style="margin:0; color:#9c88ff; font-size:18px; font-weight:600;"></h3>
        <button id="closeModalBtn" style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>
      <div id="modalExerciseContent" style="color:#e0e0e0; line-height:1.8; font-size:13px;">
        <!-- ìš´ë™ ìƒì„¸ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </div>
  </div>


  <div style="margin-top:12px; max-height:400px; overflow-y:auto;">
    <table class="tbl">
      <thead><tr><th>í•­ëª©</th><th>Before</th><th>After</th><th>ë³€í™”</th><th>ì •ìƒ</th></tr></thead>
      <tbody>
        <tr><td>CVA(ë‘ê°œê²½ì¶”ê°)</td><td id="cmpCvaB">â€”</td><td id="cmpCvaA">â€”</td><td id="cmpCvaD">â€”</td><td>â‰¥50Â°</td></tr>
        <tr><td>HPD(ë‘ë¶€ì „ë°©ì´ë™)</td><td id="cmpHpdB">â€”</td><td id="cmpHpdA">â€”</td><td id="cmpHpdD">â€”</td><td>â‰¤2cm</td></tr>
        <tr><td>NIA(ê²½ì¶”ê²½ì‚¬ê°)</td><td id="cmpNiaB">â€”</td><td id="cmpNiaA">â€”</td><td id="cmpNiaD">â€”</td><td>0-20Â°</td></tr>
        <tr><td>TIA(ì²´ê°„ê²½ì‚¬ê°)</td><td id="cmpTiaB">â€”</td><td id="cmpTiaA">â€”</td><td id="cmpTiaD">â€”</td><td>0-10Â°</td></tr>
        <tr><td>SAA(ì–´ê¹¨ì „ë°©ê°)</td><td id="cmpSaaB">â€”</td><td id="cmpSaaA">â€”</td><td id="cmpSaaD">â€”</td><td>0-10Â°</td></tr>
        <tr><td>PTA(ê³¨ë°˜ ì „í›„ê²½ì‚¬ê°)</td><td id="cmpPtaB">â€”</td><td id="cmpPtaA">â€”</td><td id="cmpPtaD">â€”</td><td>0-15Â°</td></tr>
        <tr><td>KA(ë¬´ë¦ê°)</td><td id="cmpKaB">â€”</td><td id="cmpKaA">â€”</td><td id="cmpKaD">â€”</td><td>175-185Â°</td></tr>
        <tr><td>Tibial(ê²½ê³¨ê²½ì‚¬ê°)</td><td id="cmpTibialB">â€”</td><td id="cmpTibialA">â€”</td><td id="cmpTibialD">â€”</td><td>0-10Â°</td></tr>
        <tr><td>Q-Angle(Qê°)</td><td id="cmpQangleB">â€”</td><td id="cmpQangleA">â€”</td><td id="cmpQangleD">â€”</td><td>10-20Â°</td></tr>
        <tr><td>Knee Dev(ë¬´ë¦í¸ìœ„)</td><td id="cmpKneedevB">â€”</td><td id="cmpKneedevA">â€”</td><td id="cmpKneedevD">â€”</td><td>0-3Â°</td></tr>
        <tr><td>LLD(í•˜ì§€ê¸¸ì´ì°¨)</td><td id="cmpLldB">â€”</td><td id="cmpLldA">â€”</td><td id="cmpLldD">â€”</td><td>â‰¤1cm</td></tr>
        <tr><td>GSB(ì¤‘ë ¥ì¤‘ì‹¬ì„ )</td><td id="cmpGsbB">â€”</td><td id="cmpGsbA">â€”</td><td id="cmpGsbD">â€”</td><td>â‰¤2cm</td></tr>
        <tr><td>BVA(ì²´ì¤‘ì „ë°©ì´ë™)</td><td id="cmpBvaB">â€”</td><td id="cmpBvaA">â€”</td><td id="cmpBvaD">â€”</td><td>â‰¤2cm</td></tr>
        <tr><td>SCI(ì²™ì¶”ê³¡ë¥ ì§€ìˆ˜)</td><td id="cmpSciB">â€”</td><td id="cmpSciA">â€”</td><td id="cmpSciD">â€”</td><td>0.15-0.35</td></tr>
        <tr><td>HPA(ê³ ê´€ì ˆê°)</td><td id="cmpHpaB">â€”</td><td id="cmpHpaA">â€”</td><td id="cmpHpaD">â€”</td><td>0-10Â°</td></tr>
        <tr><td>PDS(ìì„¸ì ìˆ˜)</td><td id="cmpPdsB">â€”</td><td id="cmpPdsA">â€”</td><td id="cmpPdsD">â€”</td><td>0-10</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">STA(ì–´ê¹¨ê¸°ìš¸ê¸°ê°)</td><td id="cmpStaB">â€”</td><td id="cmpStaA">â€”</td><td id="cmpStaD">â€”</td><td>â‰¤3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">POA(ê³¨ë°˜ê¸°ìš¸ê¸°ê°)</td><td id="cmpPoaB">â€”</td><td id="cmpPoaA">â€”</td><td id="cmpPoaD">â€”</td><td>â‰¤3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">LLD(í•˜ì§€ê¸¸ì´ì°¨)</td><td id="cmpLldfB">â€”</td><td id="cmpLldfA">â€”</td><td id="cmpLldfD">â€”</td><td>â‰¤1cm</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">TD(ì²´ê°„í¸ìœ„)</td><td id="cmpTdB">â€”</td><td id="cmpTdA">â€”</td><td id="cmpTdD">â€”</td><td>0-3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">HTA(ë¨¸ë¦¬ê¸°ìš¸ê¸°ê°)</td><td id="cmpHtaB">â€”</td><td id="cmpHtaA">â€”</td><td id="cmpHtaD">â€”</td><td>â‰¤3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">SPP(ì–´ê¹¨ê³¨ë°˜í‰í–‰ë„)</td><td id="cmpSppB">â€”</td><td id="cmpSppA">â€”</td><td id="cmpSppD">â€”</td><td>0-3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">KAS(ë¬´ë¦ì •ë ¬ëŒ€ì¹­ì„±)</td><td id="cmpKasB">â€”</td><td id="cmpKasA">â€”</td><td id="cmpKasD">â€”</td><td>0-3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">LLAS(í•˜ì§€ì¶•ëŒ€ì¹­ì„±)</td><td id="cmpLlasB">â€”</td><td id="cmpLlasA">â€”</td><td id="cmpLlasD">â€”</td><td>0-3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">FBA(ë°œì •ë ¬ê°)</td><td id="cmpFbaB">â€”</td><td id="cmpFbaA">â€”</td><td id="cmpFbaD">â€”</td><td>0-3Â°</td></tr>
        <tr style="background:#f0f0f0; font-weight:600;"><td>ì²´í˜• ì ìˆ˜</td><td id="cmpScoreB">â€”</td><td id="cmpScoreA">â€”</td><td id="cmpScoreD">â€”</td><td>0â€“100</td></tr>
      </tbody>
    </table>
  </div>
</aside>
<main class="panel canvasWrap" style="order: 2;">
  <canvas id="cv" width="1600" height="1000"></canvas>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466862/camera_utils.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1675466124/drawing_utils.js"></script>
<script>
const { jsPDF } = window.jspdf;
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
let DPR = window.devicePixelRatio || 1;
let dragKey = null;
let editMode = false;
let selectedPoint = null;
let originalCanvasSize = { width: 0, height: 0, styleWidth: 0, styleHeight: 0 };
let currentZoom = 1;
let isScrolling = false;
let scrollStartX = 0;
let scrollStartY = 0;
let touchStartTime = 0;
let scrollDistance = 0; // ìŠ¤í¬ë¡¤ ì‹œì‘ í›„ ì´ë™ ê±°ë¦¬
let longPressTimer = null;
let longPressDetected = false;
let longPressNearPoint = null; // long pressê°€ ê°ì§€ëœ ì 

// ì˜†ëª¨ìŠµ í‚¤í¬ì¸íŠ¸
// ì¸¡ë©´ í‚¤í¬ì¸íŠ¸ (Flutterì™€ 1:1 ë§¤ì¹­: ì†Œë¬¸ì í†µì¼)
const keypointsSide = [
  {key:'tragus', color:'#7c9cff'},
  {key:'c7', color:'#7c9cff'},
  {key:'acromion', color:'#7c9cff'},
  {key:'hip', color:'#7c9cff'},
  {key:'knee', color:'#7c9cff'},
  {key:'ankle', color:'#7c9cff'},
  {key:'asis', color:'#ffb86c'},
  {key:'psis', color:'#ffb86c'},
];

// ì •ë©´ í‚¤í¬ì¸íŠ¸ (Flutterì™€ 1:1 ë§¤ì¹­)
const keypointsFront = [
  {key:'c7', color:'#7c9cff'},
  {key:'L_acromion', color:'#7c9cff'},
  {key:'R_acromion', color:'#7c9cff'},
  {key:'L_asis', color:'#ffb86c'},
  {key:'R_asis', color:'#ffb86c'},
  {key:'L_ankle', color:'#7c9cff'},
  {key:'R_ankle', color:'#7c9cff'},
  {key:'L_knee', color:'#7c9cff'},
  {key:'R_knee', color:'#7c9cff'},
  {key:'L_patella', color:'#ff6b6b'},  // Q-angle ì¸¡ì •ìš©: ìŠ¬ê°œê³¨ ì¤‘ì‹¬
  {key:'R_patella', color:'#ff6b6b'},  // Q-angle ì¸¡ì •ìš©: ìŠ¬ê°œê³¨ ì¤‘ì‹¬
  {key:'L_tibial_tub', color:'#ff6b6b'},  // Q-angle ì¸¡ì •ìš©: ê²½ê³¨ ê²°ì ˆ
  {key:'R_tibial_tub', color:'#ff6b6b'},  // Q-angle ì¸¡ì •ìš©: ê²½ê³¨ ê²°ì ˆ
];

// ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•´ keypoints ë³€ìˆ˜ ìœ ì§€ (getKeypoints í•¨ìˆ˜ë¡œ ë™ì  ë°˜í™˜)
let keypoints = keypointsSide; // ê¸°ë³¸ê°’

const sessions = {
  Before: { 
    imgSide:null, 
    imgFront:null, 
    sidePoints:new Map(),  // ì¸¡ë©´ í‚¤í¬ì¸íŠ¸ (tragus, c7, acromion, asis, psis, hip, knee, ankle)
    frontPoints:new Map(), // ì •ë©´ í‚¤í¬ì¸íŠ¸ (L_acromion, R_acromion, L_asis, R_asis, L_knee, R_knee, L_ankle, R_ankle)
    metrics:{}, 
    score:null, 
    analysis:null 
  },
  After: { 
    imgSide:null, 
    imgFront:null, 
    sidePoints:new Map(),
    frontPoints:new Map(),
    metrics:{}, 
    score:null, 
    analysis:null 
  }
};
let cur = "Before";

const clamp = (v,min,max) => Math.min(max,Math.max(min,v));
const rad2deg = r => r * 180 / Math.PI;
const deg2rad = d => d * Math.PI / 180;
const angleBetween = (a,b) => Math.atan2(b.y - a.y, b.x - a.x);

// ë‘ ì  ì‚¬ì´ ê°ë„(ìˆ˜í‰ ê¸°ì¤€, p1->p2), í™”ë©´ y-down ì¢Œí‘œê³„ ê°€ì •
function angleP1P2(p1, p2) {
  return rad2deg(Math.atan2(p2.y - p1.y, p2.x - p1.x));
}

// ë‘ ì  ì‚¬ì´ ê±°ë¦¬(í”½ì…€)
function dist(p1, p2) {
  const dx = p1.x - p2.x;
  const dy = p1.y - p2.y;
  return Math.sqrt(dx*dx + dy*dy);
}

// ì™¸ì /ë‚´ì  ê¸°ë°˜ ê°ë„(pA-vertex-pB)
function angleAt(v, a, b) {
  const ax = a.x - v.x;
  const ay = a.y - v.y;
  const bx = b.x - v.x;
  const by = b.y - v.y;
  const dot = ax*bx + ay*by;
  const na = Math.sqrt(ax*ax + ay*ay);
  const nb = Math.sqrt(bx*bx + by*by);
  if (na === 0 || nb === 0) return NaN;
  return rad2deg(Math.acos(Math.max(-1, Math.min(1, dot / (na*nb)))));
}

// ìˆ˜ì§ì„ (90Â°)ê³¼ ë¼ì¸ ê°ë„ ì°¨ì´ ì ˆëŒ€ê°’
function angleToVertical(p1, p2) {
  const a = angleP1P2(p1, p2);
  // 180ë„ê°€ ì™„ì „ ìˆ˜ì§, 0ë„ë„ ì™„ì „ ìˆ˜ì§ (ë°˜ëŒ€ ë°©í–¥)
  // ì‚¬ìš©ì ìš”êµ¬ì‚¬í•­: 180ë„ â†’ 0ë„ TIA, 170ë„ â†’ 10ë„ TIA
  // ìˆ˜ì§(180ë„)ì—ì„œ ë²—ì–´ë‚œ ê°ë„ë¥¼ ê³„ì‚°
  return Math.abs(180 - Math.abs(a));
}

// ìˆ˜í‰ì„ ê³¼ ë¼ì¸ ê°ë„ ì ˆëŒ€ê°’
function angleToHorizontal(p1, p2) {
  return Math.abs(angleP1P2(p1, p2));
}

// ë²”ìœ„ ë¶„ë¥˜ í•¨ìˆ˜ (normal, mild, moderate, severe)
function classifyRange({
  v,
  nMin = null, nMax = null,
  mildMin = null, mildMax = null,
  modMin = null, modMax = null,
  sevMin = null, sevMax = null,
  higherIsWorse = false
}) {
  function inRange(x, lo, hi) {
    return (lo == null || x >= lo) && (hi == null || x <= hi);
  }
  
  if (inRange(v, nMin, nMax)) return "normal";
  if (inRange(v, mildMin, mildMax)) return "mild";
  if (inRange(v, modMin, modMax)) return "moderate";
  if (inRange(v, sevMin, sevMax)) return "severe";
  
  // ë°©í–¥ì„± íŒíŠ¸
  return higherIsWorse
    ? (v > (nMax ?? v) ? "worse_high" : "worse_low")
    : (v < (nMin ?? v) ? "worse_low" : "worse_high");
}

// pxâ†’cm ë³€í™˜
function pxToCm(px, scalePxPerCm = 50) {
  return px / scalePxPerCm;
}

// âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ìœ í‹¸: ë‘ ì  ê°„ ê±°ë¦¬ë¡œ pxPerCm ê³„ì‚°
function calibratePxPerCm(pointA, pointB, realLengthCm) {
  if (realLengthCm <= 0) {
    throw new Error("realLengthCm must be > 0");
  }
  const distPx = dist(pointA, pointB);
  return distPx / realLengthCm;
}

// âœ… ì¸¡ë©´ ìì„¸ ë¶„ì„ (ì „ì²´ ì§€í‘œ í¬í•¨)
function analyzeFullPosture(points, pxPerCm = 50.0) {
  function p(k) {
    const v = points[k];
    if (!v || v.x == null || v.y == null) return null;
    return { x: Number(v.x), y: Number(v.y) };
  }
  
  const result = {};
  
  // Flutter 1:1 ë§¤ì¹­ í‚¤ (ì†Œë¬¸ì ìš°ì„ , ê¸°ì¡´ ëŒ€ë¬¸ìëŠ” fallback)
  const tragus = p("tragus") || p("Tragus");
  const C7 = p("c7") || p("C7");
  const acromion = p("acromion") || p("Shoulder") || p("Acromion");
  const ASIS = p("asis") || p("ASIS");
  const PSIS = p("psis") || p("PSIS");
  const hip = p("hip") || p("Hip");
  const knee = p("knee") || p("Knee");
  const ankle = p("ankle") || p("Ankle");
  
  // 1ï¸âƒ£ CVA (Craniovertebral Angle): angle(line(C7, Tragus), horizontal)
  // ìŠ¤í™: C7ì—ì„œ Tragusë¡œ ê°€ëŠ” ë¼ì¸ì´ ìˆ˜í‰ì„ ê³¼ ì´ë£¨ëŠ” ê°ë„
  if (tragus && C7) {
    const cva = angleToHorizontal(C7, tragus);
    
    result.CVA = {
      value: cva,
      status: classifyRange({
        v: cva,
        nMin: 50, nMax: 90,
        mildMin: 45, mildMax: 49,
        modMin: 40, modMax: 44,
        sevMin: null, sevMax: 40,
        higherIsWorse: false
      }),
      unit: "Â°",
      desc: "Craniovertebral Angle (ê±°ë¶ëª© í‰ê°€)"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.CVA.value_deg = cva;
    result.CVA.meaning = result.CVA.desc;
  }
  
  // 2ï¸âƒ£ HPD (Head Protrusion Distance): tragusì™€ acromion ê±°ë¦¬
  if (tragus && acromion) {
    const hpd = pxToCm(dist(tragus, acromion), pxPerCm);
    result.HPD = {
      value: hpd,
      status: classifyRange({
        v: hpd,
        nMin: 0, nMax: 2,
        mildMin: 2, mildMax: 4,
        modMin: 4, modMax: 6,
        sevMin: 6, sevMax: null,
        higherIsWorse: true
      }),
      unit: "cm",
      desc: "Head Protrusion Distance (ë¨¸ë¦¬ ëŒì¶œ)"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.HPD.value_cm = hpd;
    result.HPD.meaning = result.HPD.desc;
  }
  
  // 3ï¸âƒ£ NIA (Neck Inclination Angle): angle(line(Acromion, Tragus), horizontal)
  // ìŠ¤í™: Acromionì—ì„œ Tragusë¡œ ê°€ëŠ” ë¼ì¸ì´ ìˆ˜í‰ì„ ê³¼ ì´ë£¨ëŠ” ê°ë„
  // ì •ìƒ ë²”ìœ„: 10Â°â€“20Â° (ìˆ˜í‰ì„  ê¸°ì¤€)
  if (tragus && acromion) {
    const rawAngle = angleToHorizontal(acromion, tragus);
    // ìŠ¤í™: ìˆ˜í‰ì„  ê¸°ì¤€ ê°ë„ë¥¼ ì§ì ‘ ì‚¬ìš© (10-20ë„ê°€ ì •ìƒ)
    const nia = rawAngle;
    result.NIA = {
      value: nia,
      status: classifyRange({
        v: nia,
        nMin: 10, nMax: 20,
        mildMin: 5, mildMax: 9,
        modMin: 21, modMax: 30,
        sevMin: 30, sevMax: null,
        higherIsWorse: false
      }),
      unit: "Â°",
      desc: "Neck Inclination Angle"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.NIA.value_deg = nia;
    result.NIA.meaning = result.NIA.desc;
  }
  
  // 4ï¸âƒ£ TIA (Trunk Inclination Angle): angle(line(Hip, Acromion), vertical)
  // ìŠ¤í™: Hipì—ì„œ Acromionìœ¼ë¡œ ê°€ëŠ” ë¼ì¸ì´ ìˆ˜ì§ì„ ê³¼ ì´ë£¨ëŠ” ê°ë„
  // ì •ìƒ ë²”ìœ„: 0Â°â€“5Â° (ìˆ˜ì§ì„  ê¸°ì¤€)
  if (acromion && hip) {
    const tia = angleToVertical(hip, acromion);
    result.TIA = {
      value: tia,
      status: classifyRange({
        v: tia,
        nMin: 0, nMax: 5,
        mildMin: 5, mildMax: 10,
        modMin: 10, modMax: 15,
        sevMin: 15, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Trunk Inclination Angle"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.TIA.value_deg = tia;
    result.TIA.meaning = result.TIA.desc;
  }
  
  // 5ï¸âƒ£ SAA (Scapular Alignment Angle): angle(line(PSIS, Acromion), horizontal)
  // ìŠ¤í™: PSISì—ì„œ Acromionìœ¼ë¡œ ê°€ëŠ” ë¼ì¸ì´ ìˆ˜í‰ì„ ê³¼ ì´ë£¨ëŠ” ê°ë„
  // ì •ìƒ ë²”ìœ„: 0Â°â€“10Â°
  if (acromion && PSIS) {
    const saa = angleToHorizontal(PSIS, acromion);
    result.SAA = {
      value: saa,
      status: classifyRange({
        v: saa,
        nMin: 0, nMax: 10,
        mildMin: 10, mildMax: 15,
        modMin: 15, modMax: 20,
        sevMin: 20, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Scapular Alignment Angle"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.SAA.value_deg = saa;
    result.SAA.meaning = result.SAA.desc;
  }
  
  // 6ï¸âƒ£ PTA (Pelvic Tilt Angle): PSISâ€“ASISì™€ ìˆ˜í‰ì„  (Dart: angleToHorizontal(psis, asis))
  if (ASIS && PSIS) {
    const pta = angleToHorizontal(PSIS, ASIS);
    result.PTA = {
      value: pta,
      status: classifyRange({
        v: pta,
        nMin: 5, nMax: 15,
        mildMin: 0, mildMax: 4,
        modMin: 16, modMax: 20,
        sevMin: null, sevMax: null,
        higherIsWorse: false
      }),
      unit: "Â°",
      desc: "Pelvic Tilt Angle"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.PTA.value_deg = pta;
    result.PTA.meaning = result.PTA.desc;
  }
  
  // 7ï¸âƒ£ KA (Knee Alignment Angle): hipâ€“kneeâ€“ankle ì„¸ ì  ê°ë„
  if (hip && knee && ankle) {
    const ka = angleAt(knee, hip, ankle);
    result.KA = {
      value: ka,
      status: classifyRange({
        v: ka,
        nMin: 175, nMax: 180,
        mildMin: 172, mildMax: 174,
        modMin: 168, modMax: 171,
        sevMin: null, sevMax: null,
        higherIsWorse: false
      }),
      unit: "Â°",
      desc: "Knee Alignment Angle"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.KA.value_deg = ka;
    result.KA.meaning = result.KA.desc;
  }
  
  // 8ï¸âƒ£ Tibial_Angle (Tibial Inclination): angle(line(Knee, Ankle), vertical)
  // ìŠ¤í™: Kneeì—ì„œ Ankleë¡œ ê°€ëŠ” ë¼ì¸ì´ ìˆ˜ì§ì„ ê³¼ ì´ë£¨ëŠ” ê°ë„
  // ì •ìƒ ë²”ìœ„: 85Â°â€“90Â° (ìˆ˜ì§ì„  ê¸°ì¤€)
  if (knee && ankle) {
    const tba = angleToVertical(knee, ankle);
    // ìŠ¤í™: 85-90ë„ê°€ ì •ìƒì´ë¯€ë¡œ, ìˆ˜ì§ì„ ì—ì„œ ë²—ì–´ë‚œ ê°ë„ë¥¼ ê³„ì‚°
    const tbaValue = Math.abs(90 - tba);
    result.Tibial_Angle = {
      value: tbaValue,
      status: classifyRange({
        v: tbaValue,
        nMin: 0, nMax: 5,
        mildMin: 5, mildMax: 8,
        modMin: 8, modMax: 12,
        sevMin: 12, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Tibial Inclination"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.Tibial_Angle.value_deg = tbaValue;
    result.Tibial_Angle.meaning = result.Tibial_Angle.desc;
    result.Tibial_Inclination = result.Tibial_Angle;
  }
  
  // 9ï¸âƒ£ GSB (Global Sagittal Balance): tragusâ€“ankle xì¢Œí‘œ ì°¨ì´
  if (tragus && ankle) {
    const gsbPx = Math.abs(tragus.x - ankle.x);
    const gsb = pxToCm(gsbPx, pxPerCm);
    result.GSB = {
      value: gsb,
      status: classifyRange({
        v: gsb,
        nMin: 0, nMax: 2,
        mildMin: 2, mildMax: 4,
        modMin: 4, modMax: 6,
        sevMin: 6, sevMax: null,
        higherIsWorse: true
      }),
      unit: "cm",
      desc: "Global Sagittal Balance"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.GSB.value_cm = gsb;
    result.GSB.meaning = result.GSB.desc;
  }
  
  // 1ï¸âƒ£0ï¸âƒ£ BVA (Body Vertical Alignment): angle(line(Ankle, Tragus), vertical)
  // ìŠ¤í™: Ankleì—ì„œ Tragusë¡œ ê°€ëŠ” ë¼ì¸ì´ ìˆ˜ì§ì„ ê³¼ ì´ë£¨ëŠ” ê°ë„
  // ì •ìƒ ë²”ìœ„: Â±2Â° (ìˆ˜ì§ì„  ê¸°ì¤€)
  if (tragus && ankle) {
    const bva = angleToVertical(ankle, tragus);
    result.BVA = {
      value: Math.abs(bva),
      value_signed: bva, // ë¶€í˜¸ í¬í•¨ ê°’ (ë‚´ë¶€ ì‚¬ìš©)
      status: classifyRange({
        v: Math.abs(bva),
        nMin: 0, nMax: 2,
        mildMin: 2, mildMax: 4,
        modMin: 4, modMax: 6,
        sevMin: 6, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Body Vertical Alignment"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.BVA.value_deg = Math.abs(bva);
    result.BVA.value_cm = pxToCm(Math.abs(tragus.x - ankle.x), pxPerCm); // ê¸°ì¡´ cm ê°’ ìœ ì§€
    result.BVA.meaning = result.BVA.desc;
  }
  
  // 1ï¸âƒ£1ï¸âƒ£ SCI (Spinal Curvature Index): C7â€“PSISâ€“ankle ê³¡ë¥  ë¹„ìœ¨
  if (C7 && PSIS && ankle) {
    const total = dist(C7, ankle);
    const mid = dist(C7, PSIS) + dist(PSIS, ankle);
    const sci = total > 0 ? mid / total : 1.0;
    result.SCI = {
      value: sci,
      status: sci >= 0.95 && sci <= 1.05 ? "neutral" : sci > 1.1 ? "kyphotic" : "flat",
      unit: "ratio",
      desc: "Spinal Curvature Index"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.SCI.meaning = result.SCI.desc;
  }
  
  // 1ï¸âƒ£2ï¸âƒ£ HPA (Headâ€“Pelvis Angle): angle(line(PSIS, Tragus), vertical)
  // ìŠ¤í™: PSISì—ì„œ Tragusë¡œ ê°€ëŠ” ë¼ì¸ì´ ìˆ˜ì§ì„ ê³¼ ì´ë£¨ëŠ” ê°ë„
  // ì •ìƒ ë²”ìœ„: 0Â°â€“5Â° (ìˆ˜ì§ì„  ê¸°ì¤€)
  if (tragus && PSIS) {
    const hpa = angleToVertical(PSIS, tragus);
    result.HPA = {
      value: hpa,
      status: classifyRange({
        v: hpa,
        nMin: 0, nMax: 5,
        mildMin: 5, mildMax: 10,
        modMin: 10, modMax: 15,
        sevMin: 15, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Headâ€“Pelvis Angle"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.HPA.value_deg = hpa;
    result.HPA.meaning = result.HPA.desc;
  }
  
  // Q-Angleì€ ì •ë©´ ë¶„ì„ì—ì„œë§Œ ì¸¡ì • (ì¸¡ë©´ ë¶„ì„ì—ì„œëŠ” ì œê±°)
  
  // 1ï¸âƒ£4ï¸âƒ£ Knee_Deviation (ë¬´ë¦ ë†’ì´ ì°¨ì´): L_kneeì™€ R_knee ìˆ˜í‰ì„  ê°ë„
  const L_knee = p("L_knee") || p("L_Knee");
  const R_knee = p("R_knee") || p("R_Knee");
  if (L_knee && R_knee) {
    const kd = angleToHorizontal(L_knee, R_knee);
    result.Knee_Deviation = {
      value: kd,
      status: classifyRange({
        v: kd,
        nMin: 0, nMax: 3,
        mildMin: 3, mildMax: 6,
        modMin: 6, modMax: 10,
        sevMin: 10, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Knee Height Difference"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.Knee_Deviation.value_deg = kd;
    result.Knee_Deviation.meaning = result.Knee_Deviation.desc;
  }
  
  // 1ï¸âƒ£5ï¸âƒ£ LLD (Leg Length Discrepancy): ì¢Œìš° ë‹¤ë¦¬ ê¸¸ì´ ì°¨ì´
  const L_asis = p("L_asis") || p("L_ASIS");
  const R_asis = p("R_asis") || p("R_ASIS");
  const L_ankle = p("L_ankle") || p("L_Ankle");
  const R_ankle = p("R_ankle") || p("R_Ankle");
  if (L_asis && L_ankle && R_asis && R_ankle) {
    const lLen = dist(L_asis, L_ankle);
    const rLen = dist(R_asis, R_ankle);
    const lld = pxToCm(Math.abs(lLen - rLen), pxPerCm);
    result.LLD = {
      value: lld,
      status: lld <= 1 ? "normal" : lld <= 2 ? "mild" : "severe",
      unit: "cm",
      desc: "Leg Length Discrepancy"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.LLD.value_cm = lld;
    result.LLD.meaning = result.LLD.desc;
  }
  
  // 1ï¸âƒ£6ï¸âƒ£ PDS (Postural Deviation Score): ëª¨ë“  ì§€í‘œ í•©ì‚°ì§€ìˆ˜
  let pdsScore = 0;
  const statusMap = { "normal": 0, "mild": 1, "moderate": 2, "severe": 3, "abnormal": 2, "neutral": 0, "kyphotic": 2, "flat": 2 };
  Object.keys(result).forEach(key => {
    if (key !== "PDS" && result[key] && result[key].status) {
      pdsScore += statusMap[result[key].status] || 0;
    }
  });
  
  result.PDS = {
    value: pdsScore,
    status: pdsScore <= 10 ? "normal" : pdsScore <= 15 ? "mild" : "moderate",
    unit: "score",
    desc: "Postural Deviation Score (0â€“10: normal, 10â†‘: ë¶ˆê· í˜•)"
  };
  // í•˜ìœ„ í˜¸í™˜ì„±
  result.PDS.meaning = result.PDS.desc;
  
  return result;
}

// âœ… ì •ë©´ ìì„¸ ë¶„ì„
function analyzeFrontPosture(points, pxPerCm = 50.0) {
  // ì•ˆì „ ì ‘ê·¼ í—¬í¼
  function p(k) {
    const v = points[k];
    if (!v || v.x == null || v.y == null) return null;
    return { x: Number(v.x), y: Number(v.y) };
  }
  
  const result = {};
  
  const L_acr = p("L_acromion") || p("L_Shoulder");
  const R_acr = p("R_acromion") || p("R_Shoulder");
  const L_asis = p("L_asis") || p("L_ASIS");
  const R_asis = p("R_asis") || p("R_ASIS");
  // Flutter 1:1 ë§¤ì¹­ í‚¤ (ì†Œë¬¸ì ìš°ì„ )
  const C7 = p("c7") || p("C7");
  const L_ankle = p("L_ankle");
  const R_ankle = p("R_ankle");
  
  // ìŠ¤í™ ê¸°ë°˜: ì •ë©´ ì§€í‘œ ì¶”ê°€ (TypeScript spec v1.0)
  
  // 1ï¸âƒ£ STA_F (Shoulder Tilt Angle): ì–´ê¹¨ ì¢Œìš° ê¸°ìš¸ê¸°
  // 0Â° = ìˆ˜í‰, +ê°ë„ = ì˜¤ë¥¸ìª½ ì–´ê¹¨ê°€ ë†’ì„ ë•Œ, -ê°ë„ = ì™¼ìª½ ì–´ê¹¨ê°€ ë†’ì„ ë•Œ
  if (L_acr && R_acr) {
    const verticalDiff = L_acr.y - R_acr.y; // Lì´ ë†’ìœ¼ë©´ ì–‘ìˆ˜, Rì´ ë†’ìœ¼ë©´ ìŒìˆ˜
    const horizontalDist = Math.abs(L_acr.x - R_acr.x);
    // ìˆ˜í‰ì„  ê¸°ì¤€ ê°ë„: atan2(verticalDiff, horizontalDist)
    // verticalDiff > 0 (Lì´ ë†’ìŒ) â†’ ìŒìˆ˜ ê°ë„
    // verticalDiff < 0 (Rì´ ë†’ìŒ) â†’ ì–‘ìˆ˜ ê°ë„
    const sta = horizontalDist > 0 ? rad2deg(Math.atan2(-verticalDiff, horizontalDist)) : 0;
    
    result.STA_F = {
      value: Math.abs(sta), // í‘œì‹œëŠ” ì ˆëŒ€ê°’
      value_signed: sta, // ë¶€í˜¸ í¬í•¨ ê°’ (ë‚´ë¶€ ì‚¬ìš©)
      status: classifyRange({
        v: Math.abs(sta),
        nMin: 0, nMax: 3,
        mildMin: 3, mildMax: 6,
        modMin: 6, modMax: 10,
        sevMin: 10, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Shoulder Tilt Angle (ì–´ê¹¨ ì¢Œìš° ê¸°ìš¸ê¸°)"
    };
    result.STA_F.value_deg = Math.abs(sta);
    result.STA_F.meaning = result.STA_F.desc;
    
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.Shoulder_Tilt = result.STA_F;
  }
  
  // 2ï¸âƒ£ POA_F (Pelvic Obliquity Angle): ê³¨ë°˜ ì¢Œìš° ê¸°ìš¸ê¸°
  // 0Â° = ìˆ˜í‰, +ê°ë„ = ì˜¤ë¥¸ìª½ ASISê°€ ë†’ì„ ë•Œ, -ê°ë„ = ì™¼ìª½ ASISê°€ ë†’ì„ ë•Œ
  if (L_asis && R_asis) {
    const verticalDiff = L_asis.y - R_asis.y; // Lì´ ë†’ìœ¼ë©´ ì–‘ìˆ˜, Rì´ ë†’ìœ¼ë©´ ìŒìˆ˜
    const horizontalDist = Math.abs(L_asis.x - R_asis.x);
    // ìˆ˜í‰ì„  ê¸°ì¤€ ê°ë„: atan2(verticalDiff, horizontalDist)
    // verticalDiff > 0 (Lì´ ë†’ìŒ) â†’ ìŒìˆ˜ ê°ë„
    // verticalDiff < 0 (Rì´ ë†’ìŒ) â†’ ì–‘ìˆ˜ ê°ë„
    const poa = horizontalDist > 0 ? rad2deg(Math.atan2(-verticalDiff, horizontalDist)) : 0;
    
    result.POA_F = {
      value: Math.abs(poa), // í‘œì‹œëŠ” ì ˆëŒ€ê°’
      value_signed: poa, // ë¶€í˜¸ í¬í•¨ ê°’ (ë‚´ë¶€ ì‚¬ìš©)
      status: classifyRange({
        v: Math.abs(poa),
        nMin: 0, nMax: 3,
        mildMin: 3, mildMax: 6,
        modMin: 6, modMax: 10,
        sevMin: 10, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Pelvic Obliquity Angle (ê³¨ë°˜ ì¢Œìš° ê¸°ìš¸ê¸°)"
    };
    result.POA_F.value_deg = Math.abs(poa);
    result.POA_F.meaning = result.POA_F.desc;
    
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.POA = result.POA_F;
    result.Pelvic_Obliquity = result.POA_F;
    
    // PRA (Pelvic Rotation): ì¢Œìš° ASIS ê°„ xì¢Œí‘œ ì°¨ì´ (ìŠ¤í™ì—ëŠ” ì—†ì§€ë§Œ ìœ ì§€)
    const pra = pxToCm(Math.abs(R_asis.x - L_asis.x), pxPerCm);
    result.PRA = {
      value: pra,
      value_cm: pra,
      status: pra <= 1 ? "normal" : pra <= 2 ? "mild" : pra <= 3 ? "moderate" : "severe",
      unit: "cm",
      meaning: "Pelvic Rotation (ê³¨ë°˜ ì¢Œìš° ë¹„í‹€ë¦¼)"
    };
  }
  
  // 3ï¸âƒ£ LLD_F (Leg Length Discrepancy): ë‹¤ë¦¬ ê¸¸ì´ ì°¨ì´
  if (L_asis && L_ankle && R_asis && R_ankle) {
    const lLen = dist(L_asis, L_ankle);
    const rLen = dist(R_asis, R_ankle);
    const lld = pxToCm(Math.abs(lLen - rLen), pxPerCm);
    
    result.LLD_F = {
      value: lld,
      status: classifyRange({
        v: lld,
        nMin: 0, nMax: 1,
        mildMin: 1, mildMax: 2,
        modMin: 2, modMax: 3,
        sevMin: 3, sevMax: null,
        higherIsWorse: true
      }),
      unit: "cm",
      desc: "Leg Length Discrepancy (í•˜ì§€ ê¸¸ì´ ì°¨)"
    };
    result.LLD_F.value_cm = lld;
    result.LLD_F.meaning = result.LLD_F.desc;
    
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.LLD = result.LLD_F;
    if (L_ankle && R_ankle) {
      const diffPx = Math.abs(L_ankle.y - R_ankle.y);
      const diffCm = pxToCm(diffPx, pxPerCm);
      result.Leg_Length_Diff = {
        value_cm: diffCm,
        status: diffCm <= 1 ? "normal" : diffCm <= 2 ? "mild" : diffCm <= 3 ? "moderate" : "severe",
        meaning: "ë‹¤ë¦¬ ê¸¸ì´ ì°¨ì´ (1cm ì´í•˜ ì •ìƒ)",
      };
    }
  }
  
  // 4ï¸âƒ£ TD (Trunk Deviation): ì²´ê°„ ì¢Œìš° í¸ìœ„
  // 0Â° = C7ì´ midline ìœ„ì—, +ê°ë„ = ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™, -ê°ë„ = ì™¼ìª½ìœ¼ë¡œ ì´ë™
  if (C7 && L_ankle && R_ankle) {
    // ì¤‘ê°„ì„ : ì¢Œìš° ë°œëª© ì¤‘ì 
    const midlineX = (L_ankle.x + R_ankle.x) / 2;
    const midlineY = (L_ankle.y + R_ankle.y) / 2;
    
    // C7ì—ì„œ ì¤‘ê°„ì„ ê¹Œì§€ì˜ ìˆ˜í‰ ê±°ë¦¬ (ì˜¤ë¥¸ìª½ì´ë©´ ì–‘ìˆ˜, ì™¼ìª½ì´ë©´ ìŒìˆ˜)
    const horizontalDeviation = C7.x - midlineX;
    const verticalDist = Math.abs(C7.y - midlineY);
    // ìˆ˜ì§ì„  ê¸°ì¤€ ê°ë„: atan2(horizontalDeviation, verticalDist)
    // horizontalDeviation > 0 (ì˜¤ë¥¸ìª½) â†’ ì–‘ìˆ˜ ê°ë„
    // horizontalDeviation < 0 (ì™¼ìª½) â†’ ìŒìˆ˜ ê°ë„
    const td = verticalDist > 0 ? rad2deg(Math.atan2(horizontalDeviation, verticalDist)) : 0;
    
    result.TD = {
      value: Math.abs(td), // í‘œì‹œëŠ” ì ˆëŒ€ê°’
      value_signed: td, // ë¶€í˜¸ í¬í•¨ ê°’ (ë‚´ë¶€ ì‚¬ìš©)
      status: classifyRange({
        v: Math.abs(td),
        nMin: 0, nMax: 2,
        mildMin: 2, mildMax: 5,
        modMin: 5, mildMax: 8,
        sevMin: 8, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Trunk Deviation (ì²´ê°„ ì¢Œìš° í¸ìœ„)"
    };
    result.TD.value_deg = Math.abs(td);
    result.TD.meaning = result.TD.desc;
    
    // í•˜ìœ„ í˜¸í™˜ì„±
    if (L_asis && R_asis) {
    const pelvisMid = {
      x: (L_asis.x + R_asis.x) / 2,
      y: (L_asis.y + R_asis.y) / 2
    };
    const dx = C7.x - pelvisMid.x;
    const dy = C7.y - pelvisMid.y;
      const angle = rad2deg(Math.atan2(Math.abs(dx), Math.abs(dy)));
    result.Trunk_Lateral_Tilt = {
      value_deg: angle,
        status: angle <= 2 ? "normal" : angle <= 5 ? "mild" : angle <= 8 ? "moderate" : "severe",
      meaning: "ì²´ê°„ì˜ ì¢Œìš° ê¸°ìš¸ê¸°",
    };
    }
  }
  
  // 5ï¸âƒ£ HTA (Head Tilt Angle): ë¨¸ë¦¬ ì¢Œìš° ê¸°ìš¸ê¸°
  // 0Â° = ìˆ˜í‰, +ê°ë„ = ì˜¤ë¥¸ìª½ Tragusê°€ ë†’ì„ ë•Œ, -ê°ë„ = ì™¼ìª½ Tragusê°€ ë†’ì„ ë•Œ
  const L_tragus = p("L_tragus");
  const R_tragus = p("R_tragus");
  if (L_tragus && R_tragus) {
    const verticalDiff = L_tragus.y - R_tragus.y; // Lì´ ë†’ìœ¼ë©´ ì–‘ìˆ˜, Rì´ ë†’ìœ¼ë©´ ìŒìˆ˜
    const horizontalDist = Math.abs(L_tragus.x - R_tragus.x);
    // ìˆ˜í‰ì„  ê¸°ì¤€ ê°ë„: atan2(verticalDiff, horizontalDist)
    // verticalDiff > 0 (Lì´ ë†’ìŒ) â†’ ìŒìˆ˜ ê°ë„
    // verticalDiff < 0 (Rì´ ë†’ìŒ) â†’ ì–‘ìˆ˜ ê°ë„
    const hta = horizontalDist > 0 ? rad2deg(Math.atan2(-verticalDiff, horizontalDist)) : 0;
    
    result.HTA = {
      value: Math.abs(hta), // í‘œì‹œëŠ” ì ˆëŒ€ê°’
      value_signed: hta, // ë¶€í˜¸ í¬í•¨ ê°’ (ë‚´ë¶€ ì‚¬ìš©)
      status: classifyRange({
        v: Math.abs(hta),
        nMin: 0, nMax: 3,
        mildMin: 3, mildMax: 6,
        modMin: 6, modMax: 10,
        sevMin: 10, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Head Tilt Angle (ë¨¸ë¦¬ ì¢Œìš° ê¸°ìš¸ê¸°)"
    };
    result.HTA.value_deg = Math.abs(hta);
    result.HTA.meaning = result.HTA.desc;
  }
  
  // 6ï¸âƒ£ SPP (Shoulderâ€“Pelvis Parallelism): ì–´ê¹¨-ê³¨ë°˜ í‰í–‰ë„
  if (L_acr && R_acr && L_asis && R_asis) {
    // ì–´ê¹¨ì„  ê°ë„
    const shoulderDx = R_acr.x - L_acr.x;
    const shoulderDy = R_acr.y - L_acr.y;
    const shoulderAngle = rad2deg(Math.atan2(shoulderDy, shoulderDx));
    
    // ê³¨ë°˜ì„  ê°ë„
    const pelvisDx = R_asis.x - L_asis.x;
    const pelvisDy = R_asis.y - L_asis.y;
    const pelvisAngle = rad2deg(Math.atan2(pelvisDy, pelvisDx));
    
    // ê°ë„ ì°¨ì´
    let angleDiff = Math.abs(shoulderAngle - pelvisAngle);
    if (angleDiff > 90) angleDiff = 180 - angleDiff; // 0-90ë„ ë²”ìœ„ë¡œ ì •ê·œí™”
    
    result.SPP = {
      value: angleDiff,
      status: classifyRange({
        v: angleDiff,
        nMin: 0, nMax: 3,
        mildMin: 3, mildMax: 6,
        modMin: 6, modMax: 10,
        sevMin: 10, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Shoulderâ€“Pelvis Parallelism (ì–´ê¹¨-ê³¨ë°˜ í‰í–‰ë„)"
    };
    result.SPP.value_deg = angleDiff;
    result.SPP.meaning = result.SPP.desc;
  }
  
  // 7ï¸âƒ£ FBA (Foot Base Angle): ë°œ ì •ë ¬ ê°ë„
  // 0Â° = ë°œì´ ì¤‘ì‹¬ì„ ê³¼ ì¼ì§ì„ ì¼ ë•Œ, +ê°ë„ = ë°œëì´ ë°”ê¹¥ìª½(ì™¸íšŒì „), -ê°ë„ = ë°œëì´ ì•ˆìª½(ë‚´íšŒì „)
  // ë°œê°€ë½ ì¢Œí‘œê°€ ì—†ìœ¼ë©´ ê³„ì‚°í•˜ì§€ ì•ŠìŒ
  const L_toe = p("L_toe");
  const R_toe = p("R_toe");
  if (L_ankle && L_toe && R_ankle && R_toe) {
    // ì‹ ì²´ ì¤‘ì‹¬ì„  (midline)
    const midlineX = (L_ankle.x + R_ankle.x) / 2;
    
    // ì¢Œì¸¡ ë°œ ì •ë ¬: ankle-toe ë¼ì¸ê³¼ ì¤‘ì‹¬ì„ ì˜ ê°ë„
    const L_dx = L_toe.x - L_ankle.x;
    const L_dy = L_toe.y - L_ankle.y;
    // ì¤‘ì‹¬ì„  ê¸°ì¤€ ê°ë„: atan2(dy, dx) - ì¤‘ì‹¬ì„ ì´ ìˆ˜ì§ì´ë¯€ë¡œ x ë°©í–¥ ê¸°ì¤€
    // ë°œëì´ ì˜¤ë¥¸ìª½(ë°”ê¹¥ìª½)ì´ë©´ ì–‘ìˆ˜, ì™¼ìª½(ì•ˆìª½)ì´ë©´ ìŒìˆ˜
    const L_angle = rad2deg(Math.atan2(L_dy, L_dx - midlineX));
    
    // ìš°ì¸¡ ë°œ ì •ë ¬
    const R_dx = R_toe.x - R_ankle.x;
    const R_dy = R_toe.y - R_ankle.y;
    const R_angle = rad2deg(Math.atan2(R_dy, R_dx - midlineX));
    
    // í‰ê·  ê°ë„ (ì™¸íšŒì „ ê°ë„)
    const avgAngle = (L_angle + R_angle) / 2;
    // 0Â° = ì¤‘ì‹¬ì„ ê³¼ ì¼ì§ì„ , ì–‘ìˆ˜ = ì™¸íšŒì „, ìŒìˆ˜ = ë‚´íšŒì „
    const fba = Math.abs(avgAngle); // í‘œì‹œëŠ” ì ˆëŒ€ê°’
    
    result.FBA = {
      value: fba,
      value_signed: avgAngle, // ë¶€í˜¸ í¬í•¨ ê°’ (ë‚´ë¶€ ì‚¬ìš©)
      status: classifyRange({
        v: fba,
        nMin: 0, nMax: 10,
        mildMin: 10, mildMax: 20,
        modMin: 20, modMax: 30,
        sevMin: 30, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Foot Base Angle (ë°œ ì •ë ¬ ê°ë„)"
    };
    result.FBA.value_deg = fba;
    result.FBA.meaning = result.FBA.desc;
  }
  
  
  // 6ï¸âƒ£ Knee Deviation (Front): ì¢Œìš° knee ë†’ì´ ì°¨ì´
  const L_knee = p("L_knee") || p("L_Knee");
  const R_knee = p("R_knee") || p("R_Knee");
  if (L_knee && R_knee) {
    const diffPx = Math.abs(L_knee.y - R_knee.y);
    const diffCm = pxToCm(diffPx, pxPerCm);
    const angle = rad2deg(Math.atan2(diffPx, Math.abs(L_knee.x - R_knee.x) || 1));
    result.Knee_Deviation = {
      value_deg: angle,
      status: classifyRange({
        v: angle,
        nMin: null, nMax: 3,
        mildMin: 3, mildMax: 6,
        modMin: 6, modMax: 10,
        sevMin: 10, sevMax: null,
        higherIsWorse: true
      }),
      meaning: "ë¬´ë¦ ë†’ì´ ì°¨ì´ (â‰¤3Â° ì •ìƒ)"
    };
  }
  
  // 7ï¸âƒ£ Q-Angle: ASIS â†’ patella ì¤‘ì‹¬ â†’ tibial tuberosity
  // (ì •ë©´ì—ì„œë§Œ ì¸¡ì • ê°€ëŠ¥)
  const L_patella = p("L_patella") || p("L_Patella");
  const R_patella = p("R_patella") || p("R_Patella");
  const L_tibial_tub = p("L_tibial_tub") || p("L_Tibial_Tub");
  const R_tibial_tub = p("R_tibial_tub") || p("R_Tibial_Tub");
  
  // ì¢Œì¸¡ Q-Angle ê³„ì‚°
  if (L_asis && L_patella && L_tibial_tub) {
    // Q-Angle: ASIS â†’ patella ì¤‘ì‹¬ â†’ tibial tuberosity ê°ë„
    const qAngleL = angleAt(L_patella, L_asis, L_tibial_tub);
    result.Q_Angle_L = {
      value: qAngleL,
      value_deg: qAngleL,
      status: classifyRange({
        v: qAngleL,
        nMin: 10, nMax: 20, // ì¼ë°˜ì ìœ¼ë¡œ ì—¬ì„±ì´ ë” í¼
        mildMin: 20, mildMax: 25,
        modMin: 25, modMax: 30,
        sevMin: 30, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Q-Angle Left (ì¢Œì¸¡ ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)",
      meaning: "ì¢Œì¸¡ Q-Angle (10â€“20Â° ì •ìƒ, ì—¬ì„±ì´ ë” í¼)"
    };
  }
  
  // ìš°ì¸¡ Q-Angle ê³„ì‚°
  if (R_asis && R_patella && R_tibial_tub) {
    const qAngleR = angleAt(R_patella, R_asis, R_tibial_tub);
    result.Q_Angle_R = {
      value: qAngleR,
      value_deg: qAngleR,
      status: classifyRange({
        v: qAngleR,
        nMin: 10, nMax: 20,
        mildMin: 20, mildMax: 25,
        modMin: 25, modMax: 30,
        sevMin: 30, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Q-Angle Right (ìš°ì¸¡ ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)",
      meaning: "ìš°ì¸¡ Q-Angle (10â€“20Â° ì •ìƒ, ì—¬ì„±ì´ ë” í¼)"
    };
  }
  
  // í‰ê·  Q-Angle (ì¢Œìš° ëª¨ë‘ ìˆì„ ë•Œ)
  if (result.Q_Angle_L && result.Q_Angle_R) {
    const avgQAngle = (result.Q_Angle_L.value + result.Q_Angle_R.value) / 2;
    result.Q_Angle = {
      value: avgQAngle,
      value_deg: avgQAngle,
      status: classifyRange({
        v: avgQAngle,
        nMin: 10, nMax: 20,
        mildMin: 20, mildMax: 25,
        modMin: 25, modMax: 30,
        sevMin: 30, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Q-Angle (ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)",
      meaning: "Q-Angle í‰ê·  (10â€“20Â° ì •ìƒ, ì—¬ì„±ì´ ë” í¼)"
    };
  } else if (result.Q_Angle_L) {
    // ì¢Œì¸¡ë§Œ ìˆì„ ë•Œ
    result.Q_Angle = result.Q_Angle_L;
    result.Q_Angle.desc = "Q-Angle (ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)";
    result.Q_Angle.meaning = "Q-Angle (10â€“20Â° ì •ìƒ, ì—¬ì„±ì´ ë” í¼)";
  } else if (result.Q_Angle_R) {
    // ìš°ì¸¡ë§Œ ìˆì„ ë•Œ
    result.Q_Angle = result.Q_Angle_R;
    result.Q_Angle.desc = "Q-Angle (ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)";
    result.Q_Angle.meaning = "Q-Angle (10â€“20Â° ì •ìƒ, ì—¬ì„±ì´ ë” í¼)";
  }
  
  // í•˜ìœ„ í˜¸í™˜ì„±: patellaë‚˜ tibial_tubê°€ ì—†ì„ ë•Œ ë¬´ë¦ ì¤‘ì‹¬ ì‚¬ìš© (ê¸°ì¡´ ë°©ì‹)
  if (!result.Q_Angle && L_asis && L_knee && L_ankle) {
    const qAngle = angleAt(L_knee, L_asis, L_ankle);
    result.Q_Angle = {
      value: qAngle,
      value_deg: qAngle,
      status: classifyRange({
        v: qAngle,
        nMin: 10, nMax: 20,
        mildMin: 20, mildMax: 25,
        modMin: 25, modMax: 30,
        sevMin: 30, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Q-Angle (ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)",
      meaning: "Q-Angle (10â€“20Â° ì •ìƒ, ì—¬ì„±ì´ ë” í¼)"
    };
  }
  
  // 8ï¸âƒ£ KAS (Knee Alignment Symmetry): ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„±
  if (L_knee && L_ankle && R_knee && R_ankle) {
    // ì¢Œì¸¡ ë¬´ë¦-ë°œëª© ì„ ì˜ ê°ë„
    const L_dx = L_ankle.x - L_knee.x;
    const L_dy = L_ankle.y - L_knee.y;
    const L_angle = rad2deg(Math.atan2(L_dy, L_dx));
    
    // ìš°ì¸¡ ë¬´ë¦-ë°œëª© ì„ ì˜ ê°ë„
    const R_dx = R_ankle.x - R_knee.x;
    const R_dy = R_ankle.y - R_knee.y;
    const R_angle = rad2deg(Math.atan2(R_dy, R_dx));
    
    // ê°ë„ ì°¨ì´
    let angleDiff = Math.abs(L_angle - R_angle);
    if (angleDiff > 90) angleDiff = 180 - angleDiff; // 0-90ë„ ë²”ìœ„ë¡œ ì •ê·œí™”
    
    result.KAS = {
      value: angleDiff,
      value_deg: angleDiff,
      status: classifyRange({
        v: angleDiff,
        nMin: 0, nMax: 2,
        mildMin: 2, mildMax: 5,
        modMin: 5, modMax: 8,
        sevMin: 8, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Knee Alignment Symmetry (ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„±)",
      meaning: "ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„± (ëŒ€ì¹­ Â±2Â° ì´ë‚´)"
    };
  }
  
  // 9ï¸âƒ£ LLAS (Lower Limb Axis Symmetry): í•˜ì§€ ì¶• ëŒ€ì¹­ì„±
  if (L_asis && L_ankle && R_asis && R_ankle) {
    // ì¢Œì¸¡ ASIS-ë°œëª© ì„ ì˜ ê°ë„
    const L_dx = L_ankle.x - L_asis.x;
    const L_dy = L_ankle.y - L_asis.y;
    const L_angle = rad2deg(Math.atan2(L_dy, L_dx));
    
    // ìš°ì¸¡ ASIS-ë°œëª© ì„ ì˜ ê°ë„
    const R_dx = R_ankle.x - R_asis.x;
    const R_dy = R_ankle.y - R_asis.y;
    const R_angle = rad2deg(Math.atan2(R_dy, R_dx));
    
    // ê°ë„ ì°¨ì´
    let angleDiff = Math.abs(L_angle - R_angle);
    if (angleDiff > 90) angleDiff = 180 - angleDiff; // 0-90ë„ ë²”ìœ„ë¡œ ì •ê·œí™”
    
    result.LLAS = {
      value: angleDiff,
      value_deg: angleDiff,
      status: classifyRange({
        v: angleDiff,
        nMin: 0, nMax: 2,
        mildMin: 2, mildMax: 5,
        modMin: 5, modMax: 8,
        sevMin: 8, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Lower Limb Axis Symmetry (í•˜ì§€ ì¶• ëŒ€ì¹­ì„±)",
      meaning: "í•˜ì§€ ì¶• ëŒ€ì¹­ì„± (Â±2Â° ì´ë‚´)"
    };
  }
  
  return result;
}

// âœ… ë¶„ì„ ê²°ê³¼ ìš”ì•½ HTML ìƒì„±
function buildAnalysisSummaryHtml(analysisResult) {
  const side = analysisResult.side || {};
  const front = analysisResult.front || {};
  const summary = analysisResult.summary || {};
  
  let html = '<div style="margin-bottom:20px; padding:15px; background:#f5f5f5; border-radius:8px;">';
  
  // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼
  if(side.status !== "not_available") {
    html += '<div style="font-size:14px; font-weight:700; margin-bottom:8px; color:#0b0f14;">ì¸¡ë©´ ë¶„ì„ ê²°ê³¼</div>';
    for(const [key, value] of Object.entries(side)) {
      if(value && typeof value === 'object' && value.value != null && key !== 'status') {
        const unit = value.value_cm != null ? 'cm' : 'Â°';
        const val = value.value_deg != null ? value.value_deg : value.value_cm;
        const status = value.status || 'unknown';
        html += `<div style="font-size:11px; margin-bottom:4px; line-height:1.5;">${key}: ${val.toFixed(2)}${unit} (${status})</div>`;
      }
    }
    html += '<div style="margin-bottom:12px;"></div>';
  }
  
  // ì •ë©´ ë¶„ì„ ê²°ê³¼
  if(front.status !== "not_available") {
    html += '<div style="font-size:14px; font-weight:700; margin-bottom:8px; color:#0b0f14;">ì •ë©´ ë¶„ì„ ê²°ê³¼</div>';
    for(const [key, value] of Object.entries(front)) {
      if(value && typeof value === 'object' && value.value != null && key !== 'status') {
        const unit = value.value_cm != null ? 'cm' : 'Â°';
        const val = value.value_deg != null ? value.value_deg : value.value_cm;
        const status = value.status || 'unknown';
        html += `<div style="font-size:11px; margin-bottom:4px; line-height:1.5;">${key}: ${val.toFixed(2)}${unit} (${status})</div>`;
      }
    }
    html += '<div style="margin-bottom:12px;"></div>';
  }
  
  // ì¢…í•© ì ìˆ˜
  html += '<div style="border-top:1px solid #ddd; padding-top:12px; margin-top:12px;"></div>';
  if(summary.PDS_total != null) {
    html += `<div style="font-size:12px; font-weight:700; color:#6b46c1;">PDS ì¢…í•©ì ìˆ˜: ${summary.PDS_total} (${summary.risk_level})</div>`;
  } else {
    html += '<div style="font-size:11px; color:#666;">ì¢…í•©ë¶„ì„: í•´ë‹¹ì—†ìŒ</div>';
  }
  
  html += '</div>';
  return html;
}

// âœ… ìš´ë™ ì¶”ì²œ ì—”ì§„ - ë¶„ì„ ê²°ê³¼ë¥¼ ë°›ì•„ì„œ íŒ¨í„´ë³„ ê·¼ìœ¡ê³¼ ìš´ë™ ì¶”ì²œ ìƒì„±
function generatePostureRecommendations(analysis) {
  const patterns = [];
  
  function addPattern({pattern, condition, tight, weak, exercises}) {
    patterns.push({
      pattern: pattern,
      condition: condition,
      tight_muscles: tight,
      weak_muscles: weak,
      recommended_exercises: exercises
    });
  }
  
  // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ì—ì„œ ê°’ ì¶”ì¶œ
  const side = analysis.side || {};
  const front = analysis.front || {};
  
  // ì¸¡ë©´ ì§€í‘œ
  const cva = side.CVA?.value_deg;
  const nia = side.NIA?.value_deg;
  const hpd = side.HPD?.value_cm;
  const saa = side.SAA?.value_deg;
  const pta = side.PTA?.value_deg;
  const ka = side.KA?.value_deg;
  const bva = side.BVA?.value_deg;
  const gsb = side.GSB?.value_cm;
  
  // ì •ë©´ ì§€í‘œ
  const frontKA = front.KA?.value_deg;
  
  // ê±°ë¶ëª© (FHP)
  if (cva != null && cva < 50) {
    addPattern({
      pattern: "ê±°ë¶ëª©(FHP)",
      condition: "CVAâ†“ / NIAâ†‘ / HPDâ†‘",
      tight: ["SCM", "ìƒë¶€ìŠ¹ëª¨", "ê²¬ê°‘ê±°ê·¼", "ì†Œí‰ê·¼"],
      weak: ["ì‹¬ë¶€ê²½ë¶€êµ´ê·¼", "í•˜ë¶€ìŠ¹ëª¨", "ì „ê±°ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Chin Tuck & Axial Elongation (í„±ë‹¹ê¸°ê¸° + ì¶•ì‹ ì¥)", "Swan Prep"],
        "ë¦¬í¬ë¨¸": ["Pulling Straps"],
        "ìºë”œë½": ["Tower Swan"],
        "ì²´ì–´": ["Press Down Front"],
        "ë°”ë ": ["Swan on Ladder Barrel"]
      }
    });
  }
  
  // ë¼ìš´ë“œìˆ„ë” (RSP)
  if (saa != null && saa > 10) {
    addPattern({
      pattern: "ë¼ìš´ë“œìˆ„ë”(RSP)",
      condition: "SAAâ†‘",
      tight: ["ëŒ€í‰ê·¼", "ì†Œí‰ê·¼", "ìƒë¶€ìŠ¹ëª¨"],
      weak: ["í•˜ë¶€ìŠ¹ëª¨", "ëŠ¥í˜•ê·¼", "ì „ê±°ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Prone Scapular Retraction"],
        "ë¦¬í¬ë¨¸": ["Rowing Back", "Pulling Straps"],
        "ìºë”œë½": ["Arm Springs - Extension"],
        "ì²´ì–´": ["Spine Stretch Forward (Chair Ver.)"],
        "ë°”ë ": ["Shoulder Extension on Barrel"]
      }
    });
  }
  
  // ê³¼ì „ê²½ì‚¬ ê³¨ë°˜ (Anterior Tilt)
  if (pta != null && pta > 15) {
    addPattern({
      pattern: "ê³¼ì „ê²½ì‚¬ ê³¨ë°˜ (Anterior Tilt)",
      condition: "PTAâ†‘, ASIS í•˜ê°•, PSIS ìƒìŠ¹",
      tight: ["ì¥ìš”ê·¼", "ëŒ€í‡´ì§ê·¼", "ì²™ì¶”ê¸°ë¦½ê·¼"],
      weak: ["ë³µì§ê·¼", "ë³µíš¡ê·¼", "ë‘”ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Pelvic Curl", "Dead Bug / Toe Tap"],
        "ë¦¬í¬ë¨¸": ["Bridge on Reformer"],
        "ìºë”œë½": ["Roll Down with Push Through Bar"],
        "ì²´ì–´": ["Standing Hip Extension"],
        "ë°”ë ": ["Short Box Round Back"]
      }
    });
  }
  
  // í›„ê²½ì‚¬ ê³¨ë°˜ (Posterior Tilt)
  if (pta != null && pta < 5) {
    addPattern({
      pattern: "í›„ê²½ì‚¬ ê³¨ë°˜ (Posterior Tilt)",
      condition: "PTAâ†“, PSIS í•˜ê°•",
      tight: ["í–„ìŠ¤íŠ¸ë§", "ë³µì§ê·¼"],
      weak: ["ì¥ìš”ê·¼", "ëŒ€í‡´ì§ê·¼", "ì²™ì¶”ê¸°ë¦½ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Leg Pull Front"],
        "ë¦¬í¬ë¨¸": ["Footwork - Parallel Heels"],
        "ìºë”œë½": ["Leg Springs - Supine"],
        "ì²´ì–´": ["Swan Press"],
        "ë°”ë ": ["Swan on Barrel"]
      }
    });
  }
  
  // Xì ë‹¤ë¦¬ (Genu Valgum) - ì¸¡ë©´ ë˜ëŠ” ì •ë©´ KA ì‚¬ìš©
  const kaValue = ka || frontKA;
  if (kaValue != null && kaValue < 175) {
    addPattern({
      pattern: "Xì ë‹¤ë¦¬ (Genu Valgum)",
      condition: "KAâ†“, Q-Angleâ†‘",
      tight: ["ë‚´ì „ê·¼", "ë‚´ì¸¡ê´‘ê·¼"],
      weak: ["ì¤‘ë‘”ê·¼", "ì™¸íšŒì „ê·¼", "ì™¸ì¸¡ê´‘ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Side-Lying Leg Lift"],
        "ë¦¬í¬ë¨¸": ["Side Splits"],
        "ìºë”œë½": ["Standing Hip Abduction"],
        "ì²´ì–´": ["Step Up Lateral"],
        "ë°”ë ": ["Side Bend Stretch"]
      }
    });
  }
  
  // Oì ë‹¤ë¦¬ (Genu Varum)
  if (kaValue != null && kaValue > 180) {
    addPattern({
      pattern: "Oì ë‹¤ë¦¬ (Genu Varum)",
      condition: "KAâ†‘",
      tight: ["ì™¸ì¸¡ê´‘ê·¼", "ë¹„ë³µê·¼", "ëŒ€í‡´ì´ë‘"],
      weak: ["ë‚´ì „ê·¼", "ë‚´ì¸¡ê´‘ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Ball Squeeze Bridge"],
        "ë¦¬í¬ë¨¸": ["Footwork - Small V Position"],
        "ìºë”œë½": ["Standing Leg Press - Adduction"],
        "ì²´ì–´": ["Seated Adduction"],
        "ë°”ë ": ["Adductor Stretch on Barrel"]
      }
    });
  }
  
  // ì „ë°© ì²´ì¤‘ ì¤‘ì‹¬ (Forward Center)
  if (gsb != null && gsb > 2) {
    addPattern({
      pattern: "ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© (Forward Center)",
      condition: "GSBâ†‘, BVAâ†‘",
      tight: ["ëŒ€í‡´ì§ê·¼", "ìš”ì¶”ê¸°ë¦½ê·¼", "ì¢…ì•„ë¦¬ê·¼"],
      weak: ["ë‘”ê·¼", "í–„ìŠ¤íŠ¸ë§", "ë³µë¶€"],
      exercises: {
        "ë§¤íŠ¸": ["Pelvic Curl"],
        "ë¦¬í¬ë¨¸": ["Scooter"],
        "ìºë”œë½": ["Tower Roll Up"],
        "ì²´ì–´": ["Standing Leg Press"],
        "ë°”ë ": ["Swan"]
      }
    });
  }
  
  // í›„ë°© ì²´ì¤‘ ì¤‘ì‹¬ (Backward Center)
  if (gsb != null && gsb < -2) {
    addPattern({
      pattern: "ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°© (Backward Center)",
      condition: "GSBâ†“, BVAâ†“",
      tight: ["í–„ìŠ¤íŠ¸ë§", "ë‘”ê·¼"],
      weak: ["ì¥ìš”ê·¼", "ëŒ€í‡´ì§ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Hip Flexor Stretch"],
        "ë¦¬í¬ë¨¸": ["Standing Lunge"],
        "ìºë”œë½": ["Leg Springs - Supine"],
        "ì²´ì–´": ["Step Up Front"],
        "ë°”ë ": ["Lunge on Barrel"]
      }
    });
  }
  
  return { patterns: patterns };
}

// âœ… í†µí•© ë¶„ì„ í•¨ìˆ˜ - ì¸¡ë©´/ì •ë©´ ìë™ ê°ì§€
function analyzePostureAuto(options = {}) {
  const {
    sidePts = null,
    frontPts = null,
    pxPerCm = 50.0
  } = options;
  
  const result = {
    side: {},
    front: {},
    summary: {}
  };
  
  // ì¸¡ë©´ ë¶„ì„
  if (sidePts != null && Object.keys(sidePts).length > 0) {
    result.side = analyzeFullPosture(sidePts, pxPerCm);
  } else {
    result.side.status = "not_available";
  }
  
  // ì •ë©´ ë¶„ì„
  if (frontPts != null && Object.keys(frontPts).length > 0) {
    result.front = analyzeFrontPosture(frontPts, pxPerCm);
  } else {
    result.front.status = "not_available";
  }
  
  // í†µí•© ì ìˆ˜ ê³„ì‚°
  const sidePDS = result.side.PDS?.value || 0;
  const frontPDS = result.front.PDS?.value || 0;
  
  const availableCount = [
    result.side.status !== "not_available",
    result.front.status !== "not_available"
  ].filter(e => e).length;
  
  if (availableCount > 0) {
    const avg = (sidePDS + frontPDS) / (availableCount === 2 ? 2 : 1);
    result.summary = {
      PDS_total: avg.toFixed(1),
      risk_level: avg < 10 
        ? "ì •ìƒ" 
        : avg < 15 
          ? "ê²½ë¯¸í•œ ë¶ˆê· í˜•" 
          : "ì¤‘ë“±ë„ ì´ìƒ ë¶ˆê· í˜•"
    };
  } else {
    result.summary.status = "not_available";
  }
  
  return result;
}

// âœ… í†µí•© ë¶„ì„ + ìš´ë™ ì¶”ì²œ ê²°í•©
function analyzePostureAutoWithRecommendation(options = {}) {
  const {
    sidePts = null,
    frontPts = null,
    pxPerCm = 50.0
  } = options;
  
  // ê¸°ë³¸ í†µí•© ë¶„ì„ ì‹¤í–‰
  const result = analyzePostureAuto({
    sidePts: sidePts,
    frontPts: frontPts,
    pxPerCm: pxPerCm
  });
  
  // ë¶„ì„ ê²°ê³¼ë¥¼ í†µí•©í•˜ì—¬ ìš´ë™ ì¶”ì²œ ìƒì„±
  const analysis = {
    side: result.side,
    front: result.front,
    summary: result.summary
  };
  
  // ìš´ë™ ì¶”ì²œ ìƒì„±
  const recommendation = generatePostureRecommendations(analysis);
  result.recommendations = recommendation;
  
  return result;
}

// âœ… ì‹¤ì‹œê°„ ë¶„ì„ ì—”ì§„ (Stream ê¸°ë°˜)
class LivePostureAnalyzer {
  constructor() {
    this.listeners = [];
    this.isAnalyzing = false;
    this.lastResult = null;
  }
  
  // ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì‹¤ì‹œê°„ ê²°ê³¼ ìˆ˜ì‹ )
  addListener(callback) {
    this.listeners.push(callback);
  }
  
  // ë¦¬ìŠ¤ë„ˆ ì œê±°
  removeListener(callback) {
    const index = this.listeners.indexOf(callback);
    if (index > -1) {
      this.listeners.splice(index, 1);
    }
  }
  
  // ê²°ê³¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸
  _broadcast(result) {
    this.lastResult = result;
    this.listeners.forEach(callback => {
      try {
        callback(result);
      } catch (error) {
        console.error('Listener error:', error);
      }
    });
  }
  
  // ì‹¤ì‹œê°„ ë¶„ì„ ì‹¤í–‰ (ë§¤ í”„ë ˆì„/ì¢Œí‘œ ë³€ê²½ ì‹œ)
  analyzeFrame(options = {}) {
    if (this.isAnalyzing) {
      return this.lastResult; // ì´ë¯¸ ë¶„ì„ ì¤‘ì´ë©´ ë§ˆì§€ë§‰ ê²°ê³¼ ë°˜í™˜
    }
    
    this.isAnalyzing = true;
    
    try {
      const {
        sidePts = null,
        frontPts = null,
        pxPerCm = 50.0
      } = options;
      
      // í†µí•© ë¶„ì„ ì‹¤í–‰
      const analysisResult = analyzePostureAutoWithRecommendation({
        sidePts: sidePts,
        frontPts: frontPts,
        pxPerCm: pxPerCm
      });
      
      // ì‹¤ì‹œê°„ ê²°ê³¼ í¬ë§· (JSON ì¶œë ¥ ì˜ˆì‹œ êµ¬ì¡°)
      const result = {
        timestamp: new Date().toISOString(),
        analysis: {
          side: analysisResult.side,
          front: analysisResult.front,
          summary: analysisResult.summary
        },
        recommendations: analysisResult.recommendations || { patterns: [] }
      };
      
      // ì£¼ìš” ì§€í‘œ ì¶”ì¶œ (ì‹¤ì‹œê°„ í‘œì‹œìš©)
      const sideMetrics = analysisResult.side || {};
      const frontMetrics = analysisResult.front || {};
      const summary = analysisResult.summary || {};
      
      result.liveMetrics = {
        CVA: sideMetrics.CVA ? { value: sideMetrics.CVA.value_deg, status: sideMetrics.CVA.status } : null,
        PTA: sideMetrics.PTA ? { value: sideMetrics.PTA.value_deg, status: sideMetrics.PTA.status } : null,
        KA: sideMetrics.KA ? { value: sideMetrics.KA.value_deg, status: sideMetrics.KA.status } : (frontMetrics.KA ? { value: frontMetrics.KA.value_deg, status: frontMetrics.KA.status } : null),
        PDS: summary.PDS_total ? parseFloat(summary.PDS_total) : 0,
        risk_level: summary.risk_level || 'unknown'
      };
      
      // ë¸Œë¡œë“œìºìŠ¤íŠ¸
      this._broadcast(result);
      
      return result;
    } finally {
      this.isAnalyzing = false;
    }
  }
  
  // í˜„ì¬ ì„¸ì…˜ì˜ í‚¤í¬ì¸íŠ¸ë¡œ ì‹¤ì‹œê°„ ë¶„ì„
  analyzeCurrentSession() {
    const S = sessions[cur];
    const pxPerCm = S.pxPerCm || 50.0;
    
    // ì¸¡ë©´ ë° ì •ë©´ í‚¤í¬ì¸íŠ¸ ë³€í™˜
    const sidePoints = {};
    const frontPoints = {};
    
    for(const [key, value] of S.sidePoints.entries()) {
      if(value && value.x != null && value.y != null) {
        sidePoints[key] = { x: value.x, y: value.y };
      }
    }
    
    for(const [key, value] of S.frontPoints.entries()) {
      if(value && value.x != null && value.y != null) {
        frontPoints[key] = { x: value.x, y: value.y };
      }
    }
    
    return this.analyzeFrame({
      sidePts: Object.keys(sidePoints).length > 0 ? sidePoints : null,
      frontPts: Object.keys(frontPoints).length > 0 ? frontPoints : null,
      pxPerCm: pxPerCm
    });
  }
}

// ì „ì—­ ì‹¤ì‹œê°„ ë¶„ì„ê¸° ì¸ìŠ¤í„´ìŠ¤
const liveAnalyzer = new LivePostureAnalyzer();

// ğŸ‹ï¸â€â™€ï¸ íŒ¨í„´ ê¸°ë°˜ í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ì‹œìŠ¤í…œ (BASI/Polestar/STOTT ê¸°ì¤€)
const pilatesPatterns = {
  // 1ï¸âƒ£ ê±°ë¶ëª©(FHP): CVAâ†“, NIAâ†‘, HPDâ†‘
  'FHP': {
    name: 'ê±°ë¶ëª© (Forward Head Posture)',
    condition: 'CVAâ†“ / NIAâ†‘ / HPDâ†‘',
    tight: ['SCM', 'ìƒë¶€ìŠ¹ëª¨', 'ê²¬ê°‘ê±°ê·¼', 'ì†Œí‰ê·¼'],
    weak: ['ì‹¬ë¶€ê²½ë¶€êµ´ê·¼', 'í•˜ë¶€ìŠ¹ëª¨', 'ì „ê±°ê·¼'],
    interpretation: 'ë¨¸ë¦¬ ì „ë°© ëŒì¶œ, ê²½ì¶” ì „ë§Œ ê°ì†Œ',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Chin Tuck & Axial Elongation', ko: 'í„±ë‹¹ê¸°ê¸° + ì¶•ì‹ ì¥', purpose: 'ê²½ì¶” ì•ˆì •í™”' },
        { en: 'Swan Prep', ko: 'ìŠ¤ì™„ ì¤€ë¹„', purpose: 'í‰ì¶” ì‹ ì „, ìŠ¹ëª¨ê·¼ í•˜ë¶€ ê°•í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Pulling Straps', ko: 'í’€ë§ ìŠ¤íŠ¸ë©', purpose: 'ê²¬ê°‘ í›„ë°© ì•ˆì •í™”' }
      ],
      ìºë”œë½: [
        { en: 'Tower Swan', ko: 'íƒ€ì›Œ ìŠ¤ì™„', purpose: 'í‰ì¶” ì‹ ì „ + ê²¬ê°‘ í›„ë°©ìš´ë™' }
      ],
      ì²´ì–´: [
        { en: 'Press Down Front', ko: 'í”„ë ˆìŠ¤ ë‹¤ìš´ í”„ë¡ íŠ¸', purpose: 'ê²½ì¶” ì •ë ¬ + ì „ê±°ê·¼ í™œì„±í™”' }
      ],
      ë°”ë : [
        { en: 'Swan on Ladder Barrel', ko: 'ë˜ë” ë°°ëŸ´ ìŠ¤ì™„', purpose: 'í‰ì¶” ê°€ë™ì„±, ìŠ¹ëª¨í•˜ë¶€ ê°•í™”' }
      ]
    }
  },
  
  // 2ï¸âƒ£ ë¼ìš´ë“œìˆ„ë”(RSP): SAAâ†‘
  'RSP': {
    name: 'ë¼ìš´ë“œìˆ„ë” (Rounded Shoulder Posture)',
    condition: 'SAAâ†‘',
    tight: ['ëŒ€í‰ê·¼', 'ì†Œí‰ê·¼', 'ìƒë¶€ìŠ¹ëª¨'],
    weak: ['í•˜ë¶€ìŠ¹ëª¨', 'ëŠ¥í˜•ê·¼', 'ì „ê±°ê·¼'],
    interpretation: 'ê²¬ê°‘ ì „ì¸Â·ìƒë°©íšŒì „',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Prone Scapular Retraction', ko: 'í”„ë¡  ì‚¬íˆ¬ë¼ ê²¬ê°‘ê³¨ í›„ì¸', purpose: 'ê²¬ê°‘ê³¨ í›„ì¸ ê°•í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Rowing Back / Pulling Straps', ko: 'ë¡œì‰ ë°± / í’€ë§ ìŠ¤íŠ¸ë©', purpose: 'ê²¬ê°‘ ì•ˆì •í™”' }
      ],
      ìºë”œë½: [
        { en: 'Arm Springs - Extension', ko: 'ì•” ìŠ¤í”„ë§ - ìµìŠ¤í…ì…˜', purpose: 'ì–´ê¹¨ í›„ë°©ê·¼ ê°•í™”' }
      ],
      ì²´ì–´: [
        { en: 'Spine Stretch Forward (Chair Ver.)', ko: 'ìŠ¤íŒŒì¸ ìŠ¤íŠ¸ë ˆì¹˜ í¬ì›Œë“œ (ì²´ì–´ ë²„ì „)', purpose: 'ê²¬ê°‘ ì•ˆì •í™” ë° í‰ì¶” ì‹ ì „' }
      ],
      ë°”ë : [
        { en: 'Shoulder Extension on Barrel', ko: 'ë°°ëŸ´ ì–´ê¹¨ ìµìŠ¤í…ì…˜', purpose: 'í‰ì¶” ê°€ë™ì„± + ì–´ê¹¨ í›„ì¸ê·¼ ê°•í™”' }
      ]
    }
  },
  
  // 3ï¸âƒ£ ê³¼ì „ê²½ì‚¬ ê³¨ë°˜: PTAâ†‘
  'AnteriorTilt': {
    name: 'ê³¼ì „ê²½ì‚¬ ê³¨ë°˜ (Anterior Pelvic Tilt)',
    condition: 'PTAâ†‘, ASIS í•˜ê°•, PSIS ìƒìŠ¹',
    tight: ['ì¥ìš”ê·¼', 'ëŒ€í‡´ì§ê·¼', 'ì²™ì¶”ê¸°ë¦½ê·¼'],
    weak: ['ë³µì§ê·¼', 'ë³µíš¡ê·¼', 'ë‘”ê·¼'],
    interpretation: 'ê³¨ë°˜ ì „ë°©ê²½ì‚¬ / ìš”ì¶” ì „ë§Œ ì¦ê°€',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Pelvic Curl', ko: 'í ë¹… ì»¬', purpose: 'ê³¨ë°˜ í›„ê²½ì‚¬ ìœ ë„' },
        { en: 'Dead Bug / Toe Tap', ko: 'ë°ë“œ ë²„ê·¸ / í†  íƒ­', purpose: 'ë³µíš¡ê·¼ í™œì„±í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Bridge on Reformer', ko: 'ë¦¬í¬ë¨¸ ë¸Œë¦¿ì§€', purpose: 'í›„ë°© ì‚¬ìŠ¬ ê°•í™”' }
      ],
      ìºë”œë½: [
        { en: 'Roll Down with Push Through Bar', ko: 'ë¡¤ ë‹¤ìš´ (í‘¸ì‹œ ìŠ¤ë£¨ ë°”)', purpose: 'ë³µë¶€ ì½”ì–´ ì¡°ì ˆ' }
      ],
      ì²´ì–´: [
        { en: 'Standing Hip Extension', ko: 'ìŠ¤íƒ ë”© í™ ìµìŠ¤í…ì…˜', purpose: 'ë‘”ê·¼ ê°•í™”' }
      ],
      ë°”ë : [
        { en: 'Short Box Round Back', ko: 'ìˆ ë°•ìŠ¤ ë¼ìš´ë“œ ë°±', purpose: 'ì½”ì–´ + í›„ë°© ì‚¬ìŠ¬ ê°•í™”' }
      ]
    }
  },
  
  // 4ï¸âƒ£ í›„ê²½ì‚¬ ê³¨ë°˜: PTAâ†“
  'PosteriorTilt': {
    name: 'í›„ê²½ì‚¬ ê³¨ë°˜ (Posterior Pelvic Tilt)',
    condition: 'PTAâ†“, PSIS í•˜ê°•',
    tight: ['í–„ìŠ¤íŠ¸ë§', 'ë³µì§ê·¼'],
    weak: ['ì¥ìš”ê·¼', 'ëŒ€í‡´ì§ê·¼', 'ì²™ì¶”ê¸°ë¦½ê·¼'],
    interpretation: 'ê³¨ë°˜ í›„ë°©ê²½ì‚¬ / ìš”ì¶” í¸í‰',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Leg Pull Front', ko: 'ë ˆê·¸ í’€ í”„ë¡ íŠ¸', purpose: 'ì „ë°© ì‚¬ìŠ¬ ê°•í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Footwork - Parallel Heels', ko: 'í’‹ì›Œí¬ - íŒ¨ëŸ´ë  íì¦ˆ', purpose: 'ê³ ê´€ì ˆ ì‹ ì „ í™œì„±í™”' }
      ],
      ìºë”œë½: [
        { en: 'Leg Springs - Supine', ko: 'ë ˆê·¸ ìŠ¤í”„ë§ - ìŠˆíŒŒì¸', purpose: 'ì¥ìš”ê·¼ ê¸°ëŠ¥ì  ìˆ˜ì¶•' }
      ],
      ì²´ì–´: [
        { en: 'Swan Press', ko: 'ìŠ¤ì™„ í”„ë ˆìŠ¤', purpose: 'ìš”ì¶” ì‹ ì „ ê°•í™”' }
      ],
      ë°”ë : [
        { en: 'Swan on Barrel', ko: 'ë°°ëŸ´ ìŠ¤ì™„', purpose: 'ìš”ì¶” ê°€ë™ì„± í–¥ìƒ' }
      ]
    }
  },
  
  // 5ï¸âƒ£ Xì ë‹¤ë¦¬: KAâ†“, Q-Angleâ†‘
  'GenuValgum': {
    name: 'Xì ë‹¤ë¦¬ (Genu Valgum)',
    condition: 'KAâ†“, Q-Angleâ†‘',
    tight: ['ë‚´ì „ê·¼', 'ë‚´ì¸¡ê´‘ê·¼'],
    weak: ['ì¤‘ë‘”ê·¼', 'ì™¸íšŒì „ê·¼', 'ì™¸ì¸¡ê´‘ê·¼'],
    interpretation: 'ìŠ¬ê°œê³¨ ì™¸ì¸¡ ì••ë°• íŒ¨í„´',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Side-Lying Leg Lift', ko: 'ì‚¬ì´ë“œ ë¼ì‰ ë ˆê·¸ ë¦¬í”„íŠ¸', purpose: 'ì¤‘ë‘”ê·¼ ê°•í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Side Splits', ko: 'ì‚¬ì´ë“œ ìŠ¤í”Œë¦¿', purpose: 'ì™¸ì¸¡ ì•ˆì •í™”' }
      ],
      ìºë”œë½: [
        { en: 'Standing Hip Abduction', ko: 'ìŠ¤íƒ ë”© í™ ì™¸ì „', purpose: 'ê³ ê´€ì ˆ ì™¸ì „ ê°•í™”' }
      ],
      ì²´ì–´: [
        { en: 'Step Up Lateral', ko: 'ìŠ¤í… ì—… ë ˆí„°ëŸ´', purpose: 'í•˜ì§€ ì™¸ì¸¡ ì•ˆì •ì„±' }
      ],
      ë°”ë : [
        { en: 'Side Bend Stretch', ko: 'ì‚¬ì´ë“œ ë²¤ë“œ ìŠ¤íŠ¸ë ˆì¹˜', purpose: 'ê³ ê´€ì ˆ ì •ë ¬ ë° ì•ˆì •ì„± ê°œì„ ' }
      ]
    }
  },
  
  // 6ï¸âƒ£ Oì ë‹¤ë¦¬: KAâ†‘
  'GenuVarum': {
    name: 'Oì ë‹¤ë¦¬ (Genu Varum)',
    condition: 'KAâ†‘',
    tight: ['ì™¸ì¸¡ê´‘ê·¼', 'ë¹„ë³µê·¼', 'ëŒ€í‡´ì´ë‘'],
    weak: ['ë‚´ì „ê·¼', 'ë‚´ì¸¡ê´‘ê·¼'],
    interpretation: 'ì™¸ì¸¡ ê³¼ë¶€í•˜',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Ball Squeeze Bridge', ko: 'ë³¼ ìŠ¤í€´ì¦ˆ ë¸Œë¦¿ì§€', purpose: 'ë‚´ì „ê·¼ í™œì„±í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Footwork - Small V Position', ko: 'í’‹ì›Œí¬ - ìŠ¤ëª° V í¬ì§€ì…˜', purpose: 'ë‚´ì¸¡ê´‘ê·¼ ê°•í™”' }
      ],
      ìºë”œë½: [
        { en: 'Standing Leg Press - Adduction', ko: 'ìŠ¤íƒ ë”© ë ˆê·¸ í”„ë ˆìŠ¤ - ë‚´ì „', purpose: 'ë‚´ì „ê·¼ ê°•í™”' }
      ],
      ì²´ì–´: [
        { en: 'Seated Adduction', ko: 'ì‹œí‹°ë“œ ë‚´ì „', purpose: 'ë‚´ì¸¡ ê·¼ìœ¡ ì¡°ì ˆ' }
      ],
      ë°”ë : [
        { en: 'Adductor Stretch on Barrel', ko: 'ë°°ëŸ´ ë‚´ì „ê·¼ ìŠ¤íŠ¸ë ˆì¹˜', purpose: 'ë‚´ì „ê·¼ ê°€ë™ì„± í–¥ìƒ' }
      ]
    }
  },
  
  // 7ï¸âƒ£ ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°©: GSBâ†‘, BVAâ†‘
  'ForwardCenter': {
    name: 'ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© (Forward Center)',
    condition: 'GSBâ†‘, BVAâ†‘',
    tight: ['ëŒ€í‡´ì§ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼', 'ì¢…ì•„ë¦¬ê·¼'],
    weak: ['ë‘”ê·¼', 'í–„ìŠ¤íŠ¸ë§', 'ë³µë¶€'],
    interpretation: 'ì²´ê°„ ì „ë°©ê¸°ìš¸ì„',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Pelvic Curl', ko: 'í ë¹… ì»¬', purpose: 'ë‘”ê·¼/í–„ìŠ¤íŠ¸ë§ ê°•í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Scooter', ko: 'ìŠ¤ì¿ í„°', purpose: 'ë‘”ê·¼ ì‹ ì „ ì¡°ì ˆ' }
      ],
      ìºë”œë½: [
        { en: 'Tower Roll Up', ko: 'íƒ€ì›Œ ë¡¤ ì—…', purpose: 'ì½”ì–´ í™œì„±í™”' }
      ],
      ì²´ì–´: [
        { en: 'Standing Leg Press', ko: 'ìŠ¤íƒ ë”© ë ˆê·¸ í”„ë ˆìŠ¤', purpose: 'í›„ë°© ì²´ì¤‘ ì´ë™ í›ˆë ¨' }
      ],
      ë°”ë : [
        { en: 'Swan', ko: 'ìŠ¤ì™„', purpose: 'í‰ì¶” ì•ˆì •í™”' }
      ]
    }
  },
  
  // 8ï¸âƒ£ ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°©: GSBâ†“, BVAâ†“
  'BackwardCenter': {
    name: 'ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°© (Backward Center)',
    condition: 'GSBâ†“, BVAâ†“',
    tight: ['í–„ìŠ¤íŠ¸ë§', 'ë‘”ê·¼'],
    weak: ['ì¥ìš”ê·¼', 'ëŒ€í‡´ì§ê·¼'],
    interpretation: 'ì²´ê°„ í›„ë°©ê¸°ìš¸ì„',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Hip Flexor Stretch', ko: 'í™ í”Œë ‰ì„œ ìŠ¤íŠ¸ë ˆì¹˜', purpose: 'ì „ë°© ì‚¬ìŠ¬ í™œì„±í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Standing Lunge', ko: 'ìŠ¤íƒ ë”© ëŸ°ì§€', purpose: 'ê³ ê´€ì ˆ ì‹ ì „/êµ´ê³¡ ë°¸ëŸ°ìŠ¤' }
      ],
      ìºë”œë½: [
        { en: 'Leg Springs - Supine', ko: 'ë ˆê·¸ ìŠ¤í”„ë§ - ìŠˆíŒŒì¸', purpose: 'ì¥ìš”ê·¼ ê°•í™”' }
      ],
      ì²´ì–´: [
        { en: 'Step Up Front', ko: 'ìŠ¤í… ì—… í”„ë¡ íŠ¸', purpose: 'í•˜ì§€ ì „ë°© ì•ˆì •í™”' }
      ],
      ë°”ë : [
        { en: 'Lunge on Barrel', ko: 'ë°°ëŸ´ ëŸ°ì§€', purpose: 'ê³ ê´€ì ˆ ì „ë°©ì´ë™ í›ˆë ¨' }
      ]
    }
  }
};

// í•„ë¼í…ŒìŠ¤ ìš´ë™ ìƒì„¸ ì„¤ëª… ë°ì´í„°ë² ì´ìŠ¤
const pilatesExerciseDescriptions = {
  // ê±°ë¶ëª©(FHP) ê´€ë ¨ ìš´ë™
  'Chin Tuck & Axial Elongation': {
    ko: 'í„±ë‹¹ê¸°ê¸° + ì¶•ì‹ ì¥',
    description: 'ëª©ê³¼ ì²™ì¶”ë¥¼ ì •ë ¬í•˜ë©´ì„œ ê²½ì¶”ë¥¼ ì•ˆì •í™”í•˜ëŠ” ê¸°ë³¸ ë™ì‘ì…ë‹ˆë‹¤. ë²½ì— ë“±ì„ ëŒ€ê³  ì„œì„œ í„±ì„ ë’¤ë¡œ ë‹¹ê¸°ë©° ë¨¸ë¦¬ ê¼­ëŒ€ê¸°ë¥¼ ì²œì¥ ë°©í–¥ìœ¼ë¡œ ëŠ˜ë¦½ë‹ˆë‹¤. ìƒë¶€ ìŠ¹ëª¨ê·¼ì˜ ê¸´ì¥ì„ ì™„í™”í•˜ê³  ì‹¬ë¶€ ê²½ë¶€ êµ´ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë²½ì— ë“±ì„ ëŒ€ê³  ì„œì„œ ë’¤í†µìˆ˜ê°€ ë²½ì— ë‹¿ë„ë¡ í•©ë‹ˆë‹¤. 2) í„±ì„ ë’¤ë¡œ ë‹¹ê¸°ë©° ëª© ì•ìª½ ê·¼ìœ¡ì„ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 3) ë¨¸ë¦¬ ê¼­ëŒ€ê¸°ë¥¼ ì²œì¥ ë°©í–¥ìœ¼ë¡œ ëŠ˜ë¦¬ë©° 10ì´ˆ ìœ ì§€í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ì›ë˜ ìì„¸ë¡œ ëŒì•„ì˜µë‹ˆë‹¤. 5íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê²½ì¶” ì •ë ¬ ê°œì„ , ìƒë¶€ ìŠ¹ëª¨ê·¼ ê¸´ì¥ ì™„í™”, ì‹¬ë¶€ ê²½ë¶€ êµ´ê·¼ ê°•í™”, ê±°ë¶ëª© ìì„¸ êµì •',
    precautions: 'ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ê³¼ë„í•œ í˜ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.'
  },
  'Swan Prep': {
    ko: 'ìŠ¤ì™„ ì¤€ë¹„',
    description: 'í‰ì¶” ì‹ ì „ì„ ìœ ë„í•˜ë©´ì„œ í•˜ë¶€ ìŠ¹ëª¨ê·¼ì„ ê°•í™”í•˜ëŠ” ë™ì‘ì…ë‹ˆë‹¤. ë³µë¶€ì™€ ë‘”ê·¼ì„ í™œì„±í™”í•˜ì—¬ ì²™ì¶”ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì§€ì§€í•˜ë©´ì„œ ìƒì²´ë¥¼ ë“¤ì–´ì˜¬ë¦½ë‹ˆë‹¤.',
    instructions: '1) ì—ë“œë¦° ìì„¸ì—ì„œ ì†ë°”ë‹¥ì„ ì–´ê¹¨ ì˜†ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ì™€ ë‘”ê·¼ì„ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤. 3) ìƒì²´ë¥¼ ì²œì²œíˆ ë“¤ì–´ì˜¬ë¦¬ë©° ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìë‹ˆë‹¤. 4) ëª©ì€ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ì¥í•˜ì—¬ í„±ì´ ì•ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤. 5) 5-10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ë‚´ë ¤ì˜µë‹ˆë‹¤. 5íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'í‰ì¶” ì‹ ì „ ê°œì„ , í•˜ë¶€ ìŠ¹ëª¨ê·¼ ê°•í™”, ì–´ê¹¨ë¼ˆ ì•ˆì •í™”, ê±°ë¶ëª© ìì„¸ ë³´ì¡° êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë†’ì´ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Pulling Straps': {
    ko: 'í’€ë§ ìŠ¤íŠ¸ë©',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ ê²¬ê°‘ í›„ë°© ì•ˆì •í™” ìš´ë™ì…ë‹ˆë‹¤. ì–´ê¹¨ë¼ˆë¥¼ í›„ì¸ì‹œí‚¤ê³  í•˜ë¶€ ìŠ¹ëª¨ê·¼ì„ í™œì„±í™”í•˜ì—¬ ë¼ìš´ë“œ ìˆ„ë”ì™€ ê±°ë¶ëª© ìì„¸ë¥¼ êµì •í•©ë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ì•‰ì•„ ìŠ¤íŠ¸ë©ì„ ì¡ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) íŒ”ì„ ì•ìœ¼ë¡œ ë»—ì€ ìƒíƒœì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤. 4) ì–´ê¹¨ë¼ˆë¥¼ ëª¨ìœ¼ë©° íŒ”ê¿ˆì¹˜ë¥¼ ë’¤ë¡œ ë‹¹ê¹ë‹ˆë‹¤. 5) ì–´ê¹¨ë¼ˆê°€ ì•„ë˜ë¡œ ëˆŒëŸ¬ì§€ë„ë¡ ì˜ì‹í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê²¬ê°‘ í›„ì¸ ê°•í™”, í•˜ë¶€ ìŠ¹ëª¨ê·¼ í™œì„±í™”, ë¼ìš´ë“œ ìˆ„ë” êµì •, ì–´ê¹¨ ì•ˆì •ì„± í–¥ìƒ',
    precautions: 'ëª©ì„ ì•ìœ¼ë¡œ ë‚´ë°€ì§€ ì•Šê³ , ì–´ê¹¨ë¥¼ ì˜¬ë¦¬ì§€ ì•Šë„ë¡ ì£¼ì˜í•©ë‹ˆë‹¤.'
  },
  'Tower Swan': {
    ko: 'íƒ€ì›Œ ìŠ¤ì™„',
    description: 'ìºë”œë½ íƒ€ì›Œë¥¼ ì‚¬ìš©í•œ í‰ì¶” ì‹ ì „ ë° ê²¬ê°‘ í›„ë°© ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©´ì„œ ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìœ„ì¹˜ì‹œí‚¤ê³  í‰ì¶” ê°€ë™ì„±ì„ ê°œì„ í•©ë‹ˆë‹¤.',
    instructions: '1) ìºë”œë½ íƒ€ì›Œ ì•ì— ì—ë“œë¦½ë‹ˆë‹¤. 2) íŒ”ì„ íƒ€ì›Œ ë°”ì— ì˜¬ë ¤ë†“ê³  ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 3) ìƒì²´ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©° ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìë‹ˆë‹¤. 4) í‰ì¶”ë¥¼ ì°¨ë¡€ë¡œ ì‹ ì „ì‹œí‚¤ë©° ì²™ì¶”ë¥¼ ì—°ì¥í•©ë‹ˆë‹¤. 5) 5-10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ë‚´ë ¤ì˜µë‹ˆë‹¤. 5íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'í‰ì¶” ì‹ ì „ ê°œì„ , ì–´ê¹¨ë¼ˆ ì•ˆì •í™”, í•˜ë¶€ ìŠ¹ëª¨ê·¼ ê°•í™”, ê±°ë¶ëª© ìì„¸ êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Press Down Front': {
    ko: 'í”„ë ˆìŠ¤ ë‹¤ìš´ í”„ë¡ íŠ¸',
    description: 'í•„ë¼í…ŒìŠ¤ ì²´ì–´ë¥¼ ì‚¬ìš©í•œ ê²½ì¶” ì •ë ¬ ë° ì „ê±°ê·¼ í™œì„±í™” ìš´ë™ì…ë‹ˆë‹¤. íŒ”ì„ ì•„ë˜ë¡œ ëˆ„ë¥´ë©´ì„œ ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •í™”í•˜ê³  ê²½ì¶”ë¥¼ ì¤‘ë¦½ ìœ„ì¹˜ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.',
    instructions: '1) ì²´ì–´ì— ì•‰ì•„ ì†ë°”ë‹¥ì„ íŒ”ê±¸ì´ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) íŒ”ì„ ì•„ë˜ë¡œ ëˆ„ë¥´ë©´ì„œ ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤. 4) ëª©ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ì¥í•˜ì—¬ í„±ì´ ì•ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤. 5) 5-10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê²½ì¶” ì •ë ¬ ê°œì„ , ì „ê±°ê·¼ í™œì„±í™”, ì–´ê¹¨ë¼ˆ ì•ˆì •í™”, ê±°ë¶ëª© ìì„¸ êµì •',
    precautions: 'ì–´ê¹¨ë¥¼ ì˜¬ë¦¬ì§€ ì•Šê³ , ëª©ì— ê³¼ë„í•œ ê¸´ì¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.'
  },
  'Swan on Ladder Barrel': {
    ko: 'ë˜ë” ë°°ëŸ´ ìŠ¤ì™„',
    description: 'ë˜ë” ë°°ëŸ´ì„ ì‚¬ìš©í•œ í‰ì¶” ê°€ë™ì„± ë° ìŠ¹ëª¨ê·¼ í•˜ë¶€ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ í‰ì¶”ë¥¼ ì‹ ì „ì‹œí‚¤ê³  ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë˜ë” ë°°ëŸ´ì— ë“±ì„ ëŒ€ê³  ì•‰ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤. 3) ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ í‰ì¶”ë¥¼ ì°¨ë¡€ë¡œ ì‹ ì „ì‹œí‚µë‹ˆë‹¤. 4) ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìœ¼ë©° í•˜ë¶€ ìŠ¹ëª¨ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 5) 5-10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 5íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'í‰ì¶” ê°€ë™ì„± í–¥ìƒ, ìŠ¹ëª¨ê·¼ í•˜ë¶€ ê°•í™”, ì–´ê¹¨ë¼ˆ ì•ˆì •í™”, ê±°ë¶ëª© ìì„¸ ë³´ì¡° êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  
  // ë¼ìš´ë“œ ìˆ„ë”(RSP) ê´€ë ¨ ìš´ë™
  'Prone Scapular Retraction': {
    ko: 'í”„ë¡  ì‚¬íˆ¬ë¼ ê²¬ê°‘ê³¨ í›„ì¸',
    description: 'ì—ë“œë¦° ìì„¸ì—ì„œ ì–´ê¹¨ë¼ˆë¥¼ í›„ì¸ì‹œí‚¤ëŠ” ìš´ë™ì…ë‹ˆë‹¤. ëŠ¥í˜•ê·¼ê³¼ ì¤‘ë¶€ ìŠ¹ëª¨ê·¼ì„ í™œì„±í™”í•˜ì—¬ ë¼ìš´ë“œ ìˆ„ë”ë¥¼ êµì •í•©ë‹ˆë‹¤.',
    instructions: '1) ì—ë“œë¦° ìì„¸ì—ì„œ íŒ”ì„ ì˜†ìœ¼ë¡œ ë»—ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤. 3) ì–´ê¹¨ë¼ˆë¥¼ ëª¨ìœ¼ë©° íŒ”ì„ ì•½ê°„ ë“¤ì–´ì˜¬ë¦½ë‹ˆë‹¤. 4) ì–´ê¹¨ë¼ˆê°€ ì•„ë˜ë¡œ ëˆŒëŸ¬ì§€ë„ë¡ ì˜ì‹í•˜ë©° 10ì´ˆ ìœ ì§€í•©ë‹ˆë‹¤. 5) ì²œì²œíˆ ë‚´ë ¤ì˜µë‹ˆë‹¤. 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê²¬ê°‘ í›„ì¸ ê°•í™”, ëŠ¥í˜•ê·¼ í™œì„±í™”, ë¼ìš´ë“œ ìˆ„ë” êµì •, ì–´ê¹¨ ì•ˆì •ì„± í–¥ìƒ',
    precautions: 'ì–´ê¹¨ë¥¼ ì˜¬ë¦¬ì§€ ì•Šê³ , ëª©ì— ê¸´ì¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.'
  },
  'Rowing Back / Pulling Straps': {
    ko: 'ë¡œì‰ ë°± / í’€ë§ ìŠ¤íŠ¸ë©',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ ê²¬ê°‘ ì•ˆì •í™” ìš´ë™ì…ë‹ˆë‹¤. íŒ”ì„ ë’¤ë¡œ ë‹¹ê¸°ë©´ì„œ ì–´ê¹¨ë¼ˆë¥¼ í›„ì¸ì‹œí‚¤ê³  í•˜ë¶€ ìŠ¹ëª¨ê·¼ì„ ê°•í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ì•‰ì•„ ìŠ¤íŠ¸ë©ì„ ì¡ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) íŒ”ì„ ì•ìœ¼ë¡œ ë»—ì€ ìƒíƒœì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤. 4) ì–´ê¹¨ë¼ˆë¥¼ ëª¨ìœ¼ë©° íŒ”ê¿ˆì¹˜ë¥¼ ë’¤ë¡œ ë‹¹ê¹ë‹ˆë‹¤. 5) ì–´ê¹¨ë¼ˆê°€ ì•„ë˜ë¡œ ëˆŒëŸ¬ì§€ë„ë¡ ì˜ì‹í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê²¬ê°‘ ì•ˆì •í™”, í•˜ë¶€ ìŠ¹ëª¨ê·¼ ê°•í™”, ë¼ìš´ë“œ ìˆ„ë” êµì •, ì–´ê¹¨ í›„ë°©ê·¼ í™œì„±í™”',
    precautions: 'ëª©ì„ ì•ìœ¼ë¡œ ë‚´ë°€ì§€ ì•Šê³ , ì–´ê¹¨ë¥¼ ì˜¬ë¦¬ì§€ ì•Šë„ë¡ ì£¼ì˜í•©ë‹ˆë‹¤.'
  },
  'Arm Springs - Extension': {
    ko: 'ì•” ìŠ¤í”„ë§ - ìµìŠ¤í…ì…˜',
    description: 'ìºë”œë½ ì•” ìŠ¤í”„ë§ì„ ì‚¬ìš©í•œ ì–´ê¹¨ í›„ë°©ê·¼ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. íŒ”ì„ ë’¤ë¡œ ë»—ìœ¼ë©´ì„œ ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •í™”í•˜ê³  í›„ë°© ê·¼ìœ¡ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ìºë”œë½ì— ì•‰ì•„ ì•” ìŠ¤í”„ë§ì„ ì¡ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) íŒ”ì„ ì•ìœ¼ë¡œ ë»—ì€ ìƒíƒœì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤. 4) ì–´ê¹¨ë¼ˆë¥¼ ëª¨ìœ¼ë©° íŒ”ì„ ë’¤ë¡œ ë»—ìŠµë‹ˆë‹¤. 5) ì–´ê¹¨ë¼ˆê°€ ì•„ë˜ë¡œ ëˆŒëŸ¬ì§€ë„ë¡ ì˜ì‹í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ì–´ê¹¨ í›„ë°©ê·¼ ê°•í™”, ê²¬ê°‘ ì•ˆì •í™”, ë¼ìš´ë“œ ìˆ„ë” êµì •, ì–´ê¹¨ ê°€ë™ì„± í–¥ìƒ',
    precautions: 'ì–´ê¹¨ë¥¼ ì˜¬ë¦¬ì§€ ì•Šê³ , ëª©ì— ê¸´ì¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.'
  },
  'Spine Stretch Forward (Chair Ver.)': {
    ko: 'ìŠ¤íŒŒì¸ ìŠ¤íŠ¸ë ˆì¹˜ í¬ì›Œë“œ (ì²´ì–´ ë²„ì „)',
    description: 'í•„ë¼í…ŒìŠ¤ ì²´ì–´ë¥¼ ì‚¬ìš©í•œ ê²¬ê°‘ ì•ˆì •í™” ë° í‰ì¶” ì‹ ì „ ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ ì•ìœ¼ë¡œ ìˆ™ì´ë©´ì„œ ì²™ì¶”ë¥¼ ì—°ì¥ì‹œí‚¤ê³  ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ì²´ì–´ì— ì•‰ì•„ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© ì•ìœ¼ë¡œ êµ½íˆë©´ì„œ ìƒì²´ë¥¼ ìˆ™ì…ë‹ˆë‹¤. 3) ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìœ¼ë©° ì•ˆì •í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© í´ë©´ì„œ ëŒì•„ì˜µë‹ˆë‹¤. 5) 5-10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê²¬ê°‘ ì•ˆì •í™”, í‰ì¶” ê°€ë™ì„± í–¥ìƒ, ì²™ì¶” ì—°ì¥, ë¼ìš´ë“œ ìˆ„ë” ë³´ì¡° êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Shoulder Extension on Barrel': {
    ko: 'ë°°ëŸ´ ì–´ê¹¨ ìµìŠ¤í…ì…˜',
    description: 'ë°°ëŸ´ì„ ì‚¬ìš©í•œ í‰ì¶” ê°€ë™ì„± ë° ì–´ê¹¨ í›„ì¸ê·¼ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ í‰ì¶”ë¥¼ ì‹ ì „ì‹œí‚¤ê³  ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë°°ëŸ´ì— ë“±ì„ ëŒ€ê³  ì•‰ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤. 3) ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ í‰ì¶”ë¥¼ ì°¨ë¡€ë¡œ ì‹ ì „ì‹œí‚µë‹ˆë‹¤. 4) ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìœ¼ë©° í›„ì¸ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 5) 5-10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 5íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'í‰ì¶” ê°€ë™ì„± í–¥ìƒ, ì–´ê¹¨ í›„ì¸ê·¼ ê°•í™”, ì–´ê¹¨ë¼ˆ ì•ˆì •í™”, ë¼ìš´ë“œ ìˆ„ë” êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  
  // ê³¼ì „ê²½ì‚¬ ê³¨ë°˜ ê´€ë ¨ ìš´ë™
  'Pelvic Curl': {
    ko: 'í ë¹… ì»¬',
    description: 'ê³¨ë°˜ í›„ê²½ì‚¬ë¥¼ ìœ ë„í•˜ëŠ” ê¸°ë³¸ ë™ì‘ì…ë‹ˆë‹¤. ë³µë¶€ì™€ ë‘”ê·¼ì„ í™œì„±í™”í•˜ì—¬ ê³¨ë°˜ì„ ë’¤ë¡œ ê¸°ìš¸ì´ê³  ìš”ì¶” ì „ë§Œì„ ê°ì†Œì‹œí‚µë‹ˆë‹¤.',
    instructions: '1) ëˆ„ì›Œì„œ ë¬´ë¦ì„ êµ¬ë¶€ë¦¬ê³  ë°œì„ ë°”ë‹¥ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ê³¨ë°˜ì„ ë’¤ë¡œ ê¸°ìš¸ì´ë©° ì—‰ë©ì´ë¥¼ ì²œì²œíˆ ë“¤ì–´ì˜¬ë¦½ë‹ˆë‹¤. 4) ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© ë°”ë‹¥ì—ì„œ ë–¼ì–´ëƒ…ë‹ˆë‹¤. 5) ìµœê³ ì ì—ì„œ 5-10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ë‚´ë ¤ì˜µë‹ˆë‹¤. 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê³¨ë°˜ í›„ê²½ì‚¬ ìœ ë„, ë‘”ê·¼ ê°•í™”, ìš”ì¶” ì „ë§Œ ê°ì†Œ, ê³¨ë°˜ ì•ˆì •í™”',
    precautions: 'ëª© í†µì¦ì´ ìˆìœ¼ë©´ ë² ê°œë¥¼ ì‚¬ìš©í•˜ê³ , ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì…ë‹ˆë‹¤.'
  },
  'Dead Bug / Toe Tap': {
    ko: 'ë°ë“œ ë²„ê·¸ / í†  íƒ­',
    description: 'ë³µíš¡ê·¼ì„ í™œì„±í™”í•˜ëŠ” ì½”ì–´ ì•ˆì •í™” ìš´ë™ì…ë‹ˆë‹¤. íŒ”ê³¼ ë‹¤ë¦¬ë¥¼ ì›€ì§ì´ë©´ì„œ ë³µë¶€ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•˜ì—¬ ê³¨ë°˜ ì „ë°©ê²½ì‚¬ë¥¼ êµì •í•©ë‹ˆë‹¤.',
    instructions: '1) ëˆ„ì›Œì„œ ë¬´ë¦ì„ 90ë„ë¡œ êµ¬ë¶€ë¦¬ê³  íŒ”ì„ ìœ„ë¡œ ì˜¬ë¦½ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë°˜ëŒ€í¸ íŒ”ê³¼ ë‹¤ë¦¬ë¥¼ ì²œì²œíˆ ë‚´ë¦½ë‹ˆë‹¤. 4) ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° ì›ë˜ ìì„¸ë¡œ ëŒì•„ì˜µë‹ˆë‹¤. 5) ì¢Œìš° êµëŒ€ë¡œ 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ë³µíš¡ê·¼ í™œì„±í™”, ì½”ì–´ ì•ˆì •í™”, ê³¨ë°˜ ì „ë°©ê²½ì‚¬ êµì •, ìš”ì¶” ì•ˆì •ì„± í–¥ìƒ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Bridge on Reformer': {
    ko: 'ë¦¬í¬ë¨¸ ë¸Œë¦¿ì§€',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ í›„ë°© ì‚¬ìŠ¬ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ë‘”ê·¼ê³¼ í–„ìŠ¤íŠ¸ë§ì„ í™œì„±í™”í•˜ì—¬ ê³¨ë°˜ì„ ì•ˆì •í™”í•˜ê³  ìš”ì¶” ì „ë§Œì„ ê°ì†Œì‹œí‚µë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ëˆ„ì›Œ ë°œì„ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ê³¨ë°˜ì„ ë’¤ë¡œ ê¸°ìš¸ì´ë©° ì—‰ë©ì´ë¥¼ ì²œì²œíˆ ë“¤ì–´ì˜¬ë¦½ë‹ˆë‹¤. 4) ë‘”ê·¼ê³¼ í–„ìŠ¤íŠ¸ë§ì„ í™œì„±í™”í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'í›„ë°© ì‚¬ìŠ¬ ê°•í™”, ë‘”ê·¼ í™œì„±í™”, ê³¨ë°˜ ì•ˆì •í™”, ìš”ì¶” ì „ë§Œ ê°ì†Œ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ë² ê°œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.'
  },
  'Roll Down with Push Through Bar': {
    ko: 'ë¡¤ ë‹¤ìš´ (í‘¸ì‹œ ìŠ¤ë£¨ ë°”)',
    description: 'ìºë”œë½ í‘¸ì‹œ ìŠ¤ë£¨ ë°”ë¥¼ ì‚¬ìš©í•œ ë³µë¶€ ì½”ì–´ ì¡°ì ˆ ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ êµ½íˆë©´ì„œ ë³µíš¡ê·¼ì„ í™œì„±í™”í•˜ì—¬ ê³¨ë°˜ ì „ë°©ê²½ì‚¬ë¥¼ êµì •í•©ë‹ˆë‹¤.',
    instructions: '1) ìºë”œë½ì— ì•‰ì•„ í‘¸ì‹œ ìŠ¤ë£¨ ë°”ë¥¼ ì¡ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© êµ½íˆë©´ì„œ ìƒì²´ë¥¼ ì•ìœ¼ë¡œ ìˆ™ì…ë‹ˆë‹¤. 4) ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 5) 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ë³µë¶€ ì½”ì–´ ì¡°ì ˆ, ë³µíš¡ê·¼ í™œì„±í™”, ê³¨ë°˜ ì „ë°©ê²½ì‚¬ êµì •, ì²™ì¶” ê°€ë™ì„± í–¥ìƒ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Standing Hip Extension': {
    ko: 'ìŠ¤íƒ ë”© í™ ìµìŠ¤í…ì…˜',
    description: 'ì„œì„œ í•˜ëŠ” ë‘”ê·¼ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. í•œìª½ ë‹¤ë¦¬ë¥¼ ë’¤ë¡œ ë»—ìœ¼ë©´ì„œ ë‘”ê·¼ì„ í™œì„±í™”í•˜ì—¬ ê³¨ë°˜ì„ ì•ˆì •í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ì„œì„œ í•œìª½ ì†ì„ ë²½ì— ëŒ€ê³  ê· í˜•ì„ ìœ ì§€í•©ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) í•œìª½ ë‹¤ë¦¬ë¥¼ ë’¤ë¡œ ë»—ìœ¼ë©° ë‘”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ê³¨ë°˜ì´ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ë‘”ê·¼ ê°•í™”, ê³¨ë°˜ ì•ˆì •í™”, ìš”ì¶” ì „ë§Œ ê°ì†Œ, í•˜ì§€ í›„ë°© ì‚¬ìŠ¬ í™œì„±í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ê· í˜• ë¬¸ì œê°€ ìˆìœ¼ë©´ ë²½ì„ ì¡ìŠµë‹ˆë‹¤.'
  },
  'Short Box Round Back': {
    ko: 'ìˆ ë°•ìŠ¤ ë¼ìš´ë“œ ë°±',
    description: 'ìˆ ë°•ìŠ¤ë¥¼ ì‚¬ìš©í•œ ì½”ì–´ ë° í›„ë°© ì‚¬ìŠ¬ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ êµ½íˆë©´ì„œ ë³µë¶€ë¥¼ í™œì„±í™”í•˜ê³  ë‘”ê·¼ì„ ê°•í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ìˆ ë°•ìŠ¤ì— ì•‰ì•„ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© êµ½íˆë©´ì„œ ìƒì²´ë¥¼ ì•ìœ¼ë¡œ ìˆ™ì…ë‹ˆë‹¤. 3) ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 4) 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ì½”ì–´ ê°•í™”, í›„ë°© ì‚¬ìŠ¬ í™œì„±í™”, ê³¨ë°˜ ì „ë°©ê²½ì‚¬ êµì •, ì²™ì¶” ì•ˆì •ì„± í–¥ìƒ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  
  // í›„ê²½ì‚¬ ê³¨ë°˜ ê´€ë ¨ ìš´ë™
  'Leg Pull Front': {
    ko: 'ë ˆê·¸ í’€ í”„ë¡ íŠ¸',
    description: 'ì „ë°© ì‚¬ìŠ¬ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. í”Œë­í¬ ìì„¸ì—ì„œ í•œìª½ ë‹¤ë¦¬ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©´ì„œ ë³µë¶€ì™€ ëŒ€í‡´ì§ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) í”Œë­í¬ ìì„¸ì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) í•œìª½ ë‹¤ë¦¬ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©° ëŒ€í‡´ì§ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ê³¨ë°˜ì´ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ì „ë°© ì‚¬ìŠ¬ ê°•í™”, ë³µë¶€ í™œì„±í™”, ëŒ€í‡´ì§ê·¼ ê°•í™”, ê³¨ë°˜ í›„ê²½ì‚¬ êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ì–´ê¹¨ í†µì¦ì´ ìˆìœ¼ë©´ ë¬´ë¦ì„ ë‚´ë¦½ë‹ˆë‹¤.'
  },
  'Footwork - Parallel Heels': {
    ko: 'í’‹ì›Œí¬ - íŒ¨ëŸ´ë  íì¦ˆ',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ ê³ ê´€ì ˆ ì‹ ì „ í™œì„±í™” ìš´ë™ì…ë‹ˆë‹¤. ë°œë’¤ê¿ˆì¹˜ë¥¼ í’‹ë°”ì— ëŒ€ê³  ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ê³ ê´€ì ˆ ì‹ ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ëˆ„ì›Œ ë°œë’¤ê¿ˆì¹˜ë¥¼ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ê³ ê´€ì ˆì„ ì‹ ì „ì‹œí‚µë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê³ ê´€ì ˆ ì‹ ì „ í™œì„±í™”, ì¥ìš”ê·¼ ê¸°ëŠ¥ì  ìˆ˜ì¶•, ê³¨ë°˜ í›„ê²½ì‚¬ êµì •, í•˜ì§€ ì „ë°© ì‚¬ìŠ¬ ê°•í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Leg Springs - Supine': {
    ko: 'ë ˆê·¸ ìŠ¤í”„ë§ - ìŠˆíŒŒì¸',
    description: 'ìºë”œë½ ë ˆê·¸ ìŠ¤í”„ë§ì„ ì‚¬ìš©í•œ ì¥ìš”ê·¼ ê¸°ëŠ¥ì  ìˆ˜ì¶• ìš´ë™ì…ë‹ˆë‹¤. ëˆ„ìš´ ìì„¸ì—ì„œ ë‹¤ë¦¬ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©´ì„œ ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ìºë”œë½ì— ëˆ„ì›Œ ë ˆê·¸ ìŠ¤í”„ë§ì— ë‹¤ë¦¬ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©° ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ë‚´ë¦¬ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ì¥ìš”ê·¼ ê¸°ëŠ¥ì  ìˆ˜ì¶•, ê³ ê´€ì ˆ êµ´ê³¡ í™œì„±í™”, ê³¨ë°˜ í›„ê²½ì‚¬ êµì •, í•˜ì§€ ì „ë°© ì‚¬ìŠ¬ ê°•í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Swan Press': {
    ko: 'ìŠ¤ì™„ í”„ë ˆìŠ¤',
    description: 'í•„ë¼í…ŒìŠ¤ ì²´ì–´ë¥¼ ì‚¬ìš©í•œ ìš”ì¶” ì‹ ì „ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ ì²™ì¶”ê¸°ë¦½ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ì²´ì–´ì— ì•‰ì•„ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© ë’¤ë¡œ ì –íˆë©´ì„œ ìƒì²´ë¥¼ ì—°ì¥í•©ë‹ˆë‹¤. 3) ì²™ì¶”ê¸°ë¦½ê·¼ì„ í™œì„±í™”í•˜ë©° 5-10ì´ˆ ìœ ì§€í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ìš”ì¶” ì‹ ì „ ê°•í™”, ì²™ì¶”ê¸°ë¦½ê·¼ í™œì„±í™”, ê³¨ë°˜ í›„ê²½ì‚¬ êµì •, ì²™ì¶” ê°€ë™ì„± í–¥ìƒ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Swan on Barrel': {
    ko: 'ë°°ëŸ´ ìŠ¤ì™„',
    description: 'ë°°ëŸ´ì„ ì‚¬ìš©í•œ ìš”ì¶” ê°€ë™ì„± í–¥ìƒ ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ ì²™ì¶”ë¥¼ ì‹ ì „ì‹œí‚¤ê³  ê°€ë™ì„±ì„ ê°œì„ í•©ë‹ˆë‹¤.',
    instructions: '1) ë°°ëŸ´ì— ë“±ì„ ëŒ€ê³  ì•‰ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤. 3) ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ ì²™ì¶”ë¥¼ ì°¨ë¡€ë¡œ ì‹ ì „ì‹œí‚µë‹ˆë‹¤. 4) 5-10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 5) 5íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ìš”ì¶” ê°€ë™ì„± í–¥ìƒ, ì²™ì¶”ê¸°ë¦½ê·¼ í™œì„±í™”, ê³¨ë°˜ í›„ê²½ì‚¬ êµì •, ì²™ì¶” ì—°ì¥',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  
  // Xì ë‹¤ë¦¬ ê´€ë ¨ ìš´ë™
  'Side-Lying Leg Lift': {
    ko: 'ì‚¬ì´ë“œ ë¼ì‰ ë ˆê·¸ ë¦¬í”„íŠ¸',
    description: 'ì˜†ìœ¼ë¡œ ëˆ„ì›Œì„œ í•˜ëŠ” ì¤‘ë‘”ê·¼ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ë‹¤ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ë“¤ì–´ì˜¬ë¦¬ë©´ì„œ ê³ ê´€ì ˆ ì™¸ì „ê·¼ì„ í™œì„±í™”í•˜ì—¬ Xì ë‹¤ë¦¬ë¥¼ êµì •í•©ë‹ˆë‹¤.',
    instructions: '1) ì˜†ìœ¼ë¡œ ëˆ„ì›Œì„œ ì•„ë˜ìª½ íŒ”ë¡œ ë¨¸ë¦¬ë¥¼ ì§€ì§€í•©ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ìœ„ìª½ ë‹¤ë¦¬ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©° ì¤‘ë‘”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ê³¨ë°˜ì´ ì•ë’¤ë¡œ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 15íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ìœ¼ë¡œ ëŒì•„ì„œ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ì¤‘ë‘”ê·¼ ê°•í™”, ê³ ê´€ì ˆ ì™¸ì „ í™œì„±í™”, Xì ë‹¤ë¦¬ êµì •, ê³¨ë°˜ ì•ˆì •í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Side Splits': {
    ko: 'ì‚¬ì´ë“œ ìŠ¤í”Œë¦¿',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ ì™¸ì¸¡ ì•ˆì •í™” ìš´ë™ì…ë‹ˆë‹¤. ë‹¤ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ë²Œë¦¬ë©´ì„œ ê³ ê´€ì ˆ ì™¸ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ì•‰ì•„ ë‹¤ë¦¬ë¥¼ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ë²Œë¦¬ë©° ê³ ê´€ì ˆ ì™¸ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëª¨ìœ¼ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ì™¸ì¸¡ ì•ˆì •í™”, ê³ ê´€ì ˆ ì™¸ì „ ê°•í™”, Xì ë‹¤ë¦¬ êµì •, ê³¨ë°˜ ì•ˆì •ì„± í–¥ìƒ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Standing Hip Abduction': {
    ko: 'ìŠ¤íƒ ë”© í™ ì™¸ì „',
    description: 'ì„œì„œ í•˜ëŠ” ê³ ê´€ì ˆ ì™¸ì „ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. í•œìª½ ë‹¤ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ë»—ìœ¼ë©´ì„œ ì¤‘ë‘”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ì„œì„œ í•œìª½ ì†ì„ ë²½ì— ëŒ€ê³  ê· í˜•ì„ ìœ ì§€í•©ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) í•œìª½ ë‹¤ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ë»—ìœ¼ë©° ì¤‘ë‘”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ê³¨ë°˜ì´ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 15íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ê³ ê´€ì ˆ ì™¸ì „ ê°•í™”, ì¤‘ë‘”ê·¼ í™œì„±í™”, Xì ë‹¤ë¦¬ êµì •, ê³¨ë°˜ ì•ˆì •í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ê· í˜• ë¬¸ì œê°€ ìˆìœ¼ë©´ ë²½ì„ ì¡ìŠµë‹ˆë‹¤.'
  },
  'Step Up Lateral': {
    ko: 'ìŠ¤í… ì—… ë ˆí„°ëŸ´',
    description: 'ì˜†ìœ¼ë¡œ ì˜¬ë¼ê°€ëŠ” í•˜ì§€ ì™¸ì¸¡ ì•ˆì •ì„± ìš´ë™ì…ë‹ˆë‹¤. ë°•ìŠ¤ë¥¼ ì˜†ìœ¼ë¡œ ì˜¬ë¼ê°€ë©´ì„œ ê³ ê´€ì ˆ ì™¸ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë°•ìŠ¤ ì˜†ì— ì„œì„œ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) í•œìª½ ë‹¤ë¦¬ë¡œ ë°•ìŠ¤ì— ì˜¬ë¼ê°€ë©° ì¤‘ë‘”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 3) ê³¨ë°˜ì´ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 4) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'í•˜ì§€ ì™¸ì¸¡ ì•ˆì •ì„±, ê³ ê´€ì ˆ ì™¸ì „ ê°•í™”, Xì ë‹¤ë¦¬ êµì •, ê¸°ëŠ¥ì  ì›€ì§ì„ ê°œì„ ',
    precautions: 'ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ê· í˜• ë¬¸ì œê°€ ìˆìœ¼ë©´ ë²½ì„ ì¡ìŠµë‹ˆë‹¤.'
  },
  'Side Bend Stretch': {
    ko: 'ì‚¬ì´ë“œ ë²¤ë“œ ìŠ¤íŠ¸ë ˆì¹˜',
    description: 'ë°°ëŸ´ì„ ì‚¬ìš©í•œ ê³ ê´€ì ˆ ì •ë ¬ ë° ì•ˆì •ì„± ê°œì„  ìš´ë™ì…ë‹ˆë‹¤. ì˜†ìœ¼ë¡œ ê¸°ìš¸ë©´ì„œ ê³ ê´€ì ˆ ì™¸ì „ê·¼ì„ ìŠ¤íŠ¸ë ˆì¹­í•˜ê³  ì•ˆì •í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë°°ëŸ´ ì˜†ì— ì„œì„œ í•œìª½ ë‹¤ë¦¬ë¥¼ ë°°ëŸ´ì— ì˜¬ë¦½ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ì˜†ìœ¼ë¡œ ê¸°ìš¸ë©´ì„œ ê³ ê´€ì ˆ ì™¸ì „ê·¼ì„ ìŠ¤íŠ¸ë ˆì¹­í•©ë‹ˆë‹¤. 4) 30ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ìœ¼ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ê³ ê´€ì ˆ ì •ë ¬ ê°œì„ , ì™¸ì „ê·¼ ìŠ¤íŠ¸ë ˆì¹­, ì•ˆì •ì„± í–¥ìƒ, Xì ë‹¤ë¦¬ ë³´ì¡° êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  
  // Oì ë‹¤ë¦¬ ê´€ë ¨ ìš´ë™
  'Ball Squeeze Bridge': {
    ko: 'ë³¼ ìŠ¤í€´ì¦ˆ ë¸Œë¦¿ì§€',
    description: 'ë³¼ì„ ë¬´ë¦ ì‚¬ì´ì— ë¼ìš°ê³  í•˜ëŠ” ë‚´ì „ê·¼ í™œì„±í™” ìš´ë™ì…ë‹ˆë‹¤. ì—‰ë©ì´ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©´ì„œ ë‚´ì „ê·¼ì„ ìˆ˜ì¶•í•˜ì—¬ Oì ë‹¤ë¦¬ë¥¼ êµì •í•©ë‹ˆë‹¤.',
    instructions: '1) ëˆ„ì›Œì„œ ë¬´ë¦ì„ êµ¬ë¶€ë¦¬ê³  ë°œì„ ë°”ë‹¥ì— ë‘¡ë‹ˆë‹¤. 2) ë¬´ë¦ ì‚¬ì´ì— ë³¼ì„ ë¼ì›ë‹ˆë‹¤. 3) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 4) ë³¼ì„ ì¥ì–´ì§œë©° ì—‰ë©ì´ë¥¼ ë“¤ì–´ì˜¬ë¦½ë‹ˆë‹¤. 5) 10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ë‚´ë ¤ì˜µë‹ˆë‹¤. 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ë‚´ì „ê·¼ í™œì„±í™”, ë‘”ê·¼ ê°•í™”, Oì ë‹¤ë¦¬ êµì •, ê³¨ë°˜ ì•ˆì •í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Footwork - Small V Position': {
    ko: 'í’‹ì›Œí¬ - ìŠ¤ëª° V í¬ì§€ì…˜',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ ë‚´ì¸¡ê´‘ê·¼ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ë°œì„ ì‘ì€ Vì í˜•íƒœë¡œ ë‘ê³  ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ë‚´ì¸¡ ê·¼ìœ¡ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ëˆ„ì›Œ ë°œì„ ì‘ì€ Vì í˜•íƒœë¡œ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ë‚´ì¸¡ê´‘ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ë‚´ì¸¡ê´‘ê·¼ ê°•í™”, ë‚´ì „ê·¼ í™œì„±í™”, Oì ë‹¤ë¦¬ êµì •, ë¬´ë¦ ì •ë ¬ ê°œì„ ',
    precautions: 'ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì…ë‹ˆë‹¤.'
  },
  'Standing Leg Press - Adduction': {
    ko: 'ìŠ¤íƒ ë”© ë ˆê·¸ í”„ë ˆìŠ¤ - ë‚´ì „',
    description: 'ìºë”œë½ì„ ì‚¬ìš©í•œ ë‚´ì „ê·¼ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ì„œì„œ ë‹¤ë¦¬ë¥¼ ì•ˆìª½ìœ¼ë¡œ ë‹¹ê¸°ë©´ì„œ ë‚´ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ìºë”œë½ ì˜†ì— ì„œì„œ í•œìª½ ë‹¤ë¦¬ë¥¼ ìŠ¤í”„ë§ì— ì—°ê²°í•©ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ì•ˆìª½ìœ¼ë¡œ ë‹¹ê¸°ë©° ë‚´ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ë‚´ì „ê·¼ ê°•í™”, ë‚´ì¸¡ ê·¼ìœ¡ í™œì„±í™”, Oì ë‹¤ë¦¬ êµì •, ê³¨ë°˜ ì•ˆì •í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Seated Adduction': {
    ko: 'ì‹œí‹°ë“œ ë‚´ì „',
    description: 'í•„ë¼í…ŒìŠ¤ ì²´ì–´ë¥¼ ì‚¬ìš©í•œ ë‚´ì¸¡ ê·¼ìœ¡ ì¡°ì ˆ ìš´ë™ì…ë‹ˆë‹¤. ì•‰ì•„ì„œ ë‹¤ë¦¬ë¥¼ ëª¨ìœ¼ë©´ì„œ ë‚´ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ì²´ì–´ì— ì•‰ì•„ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) ë‹¤ë¦¬ë¥¼ ëª¨ìœ¼ë©° ë‚´ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 3) ê³¨ë°˜ì´ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ë‚´ì¸¡ ê·¼ìœ¡ ì¡°ì ˆ, ë‚´ì „ê·¼ í™œì„±í™”, Oì ë‹¤ë¦¬ êµì •, ê³¨ë°˜ ì•ˆì •í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Adductor Stretch on Barrel': {
    ko: 'ë°°ëŸ´ ë‚´ì „ê·¼ ìŠ¤íŠ¸ë ˆì¹˜',
    description: 'ë°°ëŸ´ì„ ì‚¬ìš©í•œ ë‚´ì „ê·¼ ê°€ë™ì„± í–¥ìƒ ìš´ë™ì…ë‹ˆë‹¤. ë‹¤ë¦¬ë¥¼ ë²Œë¦¬ë©´ì„œ ë‚´ì „ê·¼ì„ ìŠ¤íŠ¸ë ˆì¹­í•˜ê³  ê°€ë™ì„±ì„ ê°œì„ í•©ë‹ˆë‹¤.',
    instructions: '1) ë°°ëŸ´ì— ë“±ì„ ëŒ€ê³  ì•‰ì•„ ë‹¤ë¦¬ë¥¼ ë²Œë¦½ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‚´ì „ê·¼ì„ ìŠ¤íŠ¸ë ˆì¹­í•˜ë©° 30ì´ˆ ìœ ì§€í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤.',
    benefits: 'ë‚´ì „ê·¼ ê°€ë™ì„± í–¥ìƒ, ìŠ¤íŠ¸ë ˆì¹­, Oì ë‹¤ë¦¬ ë³´ì¡° êµì •, ê³ ê´€ì ˆ ê°€ë™ì„± ê°œì„ ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  
  // ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© ê´€ë ¨ ìš´ë™
  'Scooter': {
    ko: 'ìŠ¤ì¿ í„°',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ ë‘”ê·¼ ì‹ ì „ ì¡°ì ˆ ìš´ë™ì…ë‹ˆë‹¤. í•œìª½ ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ë‘”ê·¼ì„ í™œì„±í™”í•˜ì—¬ ì²´ì¤‘ ì¤‘ì‹¬ì„ í›„ë°©ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ì•‰ì•„ í•œìª½ ë‹¤ë¦¬ë¥¼ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ë‘”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ë‘”ê·¼ ì‹ ì „ ì¡°ì ˆ, ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°© ì´ë™, ê³¨ë°˜ ì•ˆì •í™”, í•˜ì§€ í›„ë°© ì‚¬ìŠ¬ í™œì„±í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Tower Roll Up': {
    ko: 'íƒ€ì›Œ ë¡¤ ì—…',
    description: 'ìºë”œë½ íƒ€ì›Œë¥¼ ì‚¬ìš©í•œ ì½”ì–´ í™œì„±í™” ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ êµ½íˆë©´ì„œ ë³µë¶€ë¥¼ í™œì„±í™”í•˜ì—¬ ì²´ì¤‘ ì¤‘ì‹¬ì„ ì¡°ì ˆí•©ë‹ˆë‹¤.',
    instructions: '1) ìºë”œë½ íƒ€ì›Œ ì•ì— ì•‰ì•„ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© êµ½íˆë©´ì„œ ìƒì²´ë¥¼ ì•ìœ¼ë¡œ ìˆ™ì…ë‹ˆë‹¤. 3) ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 4) 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ì½”ì–´ í™œì„±í™”, ë³µë¶€ ê°•í™”, ì²´ì¤‘ ì¤‘ì‹¬ ì¡°ì ˆ, ì²™ì¶” ì•ˆì •ì„± í–¥ìƒ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Standing Leg Press': {
    ko: 'ìŠ¤íƒ ë”© ë ˆê·¸ í”„ë ˆìŠ¤',
    description: 'í•„ë¼í…ŒìŠ¤ ì²´ì–´ë¥¼ ì‚¬ìš©í•œ í›„ë°© ì²´ì¤‘ ì´ë™ í›ˆë ¨ì…ë‹ˆë‹¤. ì„œì„œ ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ì²´ì¤‘ ì¤‘ì‹¬ì„ í›„ë°©ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.',
    instructions: '1) ì²´ì–´ ì˜†ì— ì„œì„œ í•œìª½ ë‹¤ë¦¬ë¥¼ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ì²´ì¤‘ì„ í›„ë°©ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'í›„ë°© ì²´ì¤‘ ì´ë™ í›ˆë ¨, ë‘”ê·¼ í™œì„±í™”, ì²´ì¤‘ ì¤‘ì‹¬ ì¡°ì ˆ, ê¸°ëŠ¥ì  ì›€ì§ì„ ê°œì„ ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ê· í˜• ë¬¸ì œê°€ ìˆìœ¼ë©´ ë²½ì„ ì¡ìŠµë‹ˆë‹¤.'
  },
  
  // ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°© ê´€ë ¨ ìš´ë™
  'Standing Lunge': {
    ko: 'ìŠ¤íƒ ë”© ëŸ°ì§€',
    description: 'ì„œì„œ í•˜ëŠ” ê³ ê´€ì ˆ ì‹ ì „/êµ´ê³¡ ë°¸ëŸ°ìŠ¤ ìš´ë™ì…ë‹ˆë‹¤. ì•ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ì¥ìš”ê·¼ì„ í™œì„±í™”í•˜ì—¬ ì²´ì¤‘ ì¤‘ì‹¬ì„ ì „ë°©ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ ì˜†ì— ì„œì„œ í•œìª½ ë‹¤ë¦¬ë¥¼ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ì•ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ê³ ê´€ì ˆ ì‹ ì „/êµ´ê³¡ ë°¸ëŸ°ìŠ¤, ì¥ìš”ê·¼ í™œì„±í™”, ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© ì´ë™, í•˜ì§€ ì „ë°© ì‚¬ìŠ¬ ê°•í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Step Up Front': {
    ko: 'ìŠ¤í… ì—… í”„ë¡ íŠ¸',
    description: 'ì•ìœ¼ë¡œ ì˜¬ë¼ê°€ëŠ” í•˜ì§€ ì „ë°© ì•ˆì •í™” ìš´ë™ì…ë‹ˆë‹¤. ë°•ìŠ¤ë¥¼ ì•ìœ¼ë¡œ ì˜¬ë¼ê°€ë©´ì„œ ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë°•ìŠ¤ ì•ì— ì„œì„œ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) í•œìª½ ë‹¤ë¦¬ë¡œ ë°•ìŠ¤ì— ì˜¬ë¼ê°€ë©° ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 3) ê³¨ë°˜ì´ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 4) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'í•˜ì§€ ì „ë°© ì•ˆì •í™”, ì¥ìš”ê·¼ í™œì„±í™”, ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© ì´ë™, ê¸°ëŠ¥ì  ì›€ì§ì„ ê°œì„ ',
    precautions: 'ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ê· í˜• ë¬¸ì œê°€ ìˆìœ¼ë©´ ë²½ì„ ì¡ìŠµë‹ˆë‹¤.'
  },
  'Lunge on Barrel': {
    ko: 'ë°°ëŸ´ ëŸ°ì§€',
    description: 'ë°°ëŸ´ì„ ì‚¬ìš©í•œ ê³ ê´€ì ˆ ì „ë°©ì´ë™ í›ˆë ¨ì…ë‹ˆë‹¤. í•œìª½ ë‹¤ë¦¬ë¥¼ ì•ìœ¼ë¡œ ë‚´ë°€ë©´ì„œ ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë°°ëŸ´ ì•ì— ì„œì„œ í•œìª½ ë‹¤ë¦¬ë¥¼ ë°°ëŸ´ì— ì˜¬ë¦½ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ì•ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ê³ ê´€ì ˆ ì „ë°©ì´ë™ í›ˆë ¨, ì¥ìš”ê·¼ í™œì„±í™”, ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© ì´ë™, í•˜ì§€ ì „ë°© ì‚¬ìŠ¬ ê°•í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  }
};

// í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•œ ê¸°ì¡´ pilatesData ìœ ì§€
const pilatesData = {
  'ëª© ì‹ ì „ê·¼ ê¸´ì¥': {
    ë§¤íŠ¸: ['Roll-Up', 'Spine Stretch Forward'],
    ë¦¬í¬ë¨¸: ['Neck Stretch on Box'],
    ìºë”œë½: ['Tower - Arm Springs'],
    ì²´ì–´: ['Tricep Dips'],
    ë°”ë : ['Chest Stretch']
  },
  'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥': {
    ë§¤íŠ¸: ['Arm Circles', 'Swimming Prep'],
    ë¦¬í¬ë¨¸: ['Rowing - From Chest'],
    ìºë”œë½: ['Arm Springs - Chest Expansion'],
    ì²´ì–´: ['Tricep Press'],
    ë°”ë : ['Side Stretch Over']
  },
  'ì „ë°©ì–´ê¹¨ìì„¸': {
    ë§¤íŠ¸: ['Swan Dive', 'T-Raise'],
    ë¦¬í¬ë¨¸: ['Backstroke', 'Pulling Straps'],
    ìºë”œë½: ['Push Through Bar'],
    ì²´ì–´: ['Push Down - Front'],
    ë°”ë : ['Chest Expansion']
  },
  'ì–´ê¹¨ì•ˆì •ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Plank to Pike', 'Side Plank'],
    ë¦¬í¬ë¨¸: ['Long Stretch Series'],
    ìºë”œë½: ['Arm Springs - Bug'],
    ì²´ì–´: ['Mountain Climber'],
    ë°”ë : ['Side Arm Work']
  },
  'íšŒì „ê·¼ê°œ ë¶ˆê· í˜•': {
    ë§¤íŠ¸: ['Side Lying Arm Series'],
    ë¦¬í¬ë¨¸: ['Arm Work - Salute'],
    ìºë”œë½: ['Tower - Rotation'],
    ì²´ì–´: ['Seated Rotation'],
    ë°”ë : ['Spiral Stretch']
  },
  'ë³µì§ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['The Hundred', 'Teaser'],
    ë¦¬í¬ë¨¸: ['Stomach Series - Hundred'],
    ìºë”œë½: ['Roll Down Bar'],
    ì²´ì–´: ['Teaser Prep'],
    ë°”ë : ['Sit Up Series']
  },
  'ë³µì‚¬ê·¼ ë¶ˆê· í˜•': {
    ë§¤íŠ¸: ['Criss Cross', 'Saw'],
    ë¦¬í¬ë¨¸: ['Short Box - Twist'],
    ìºë”œë½: ['Twist & Reach'],
    ì²´ì–´: ['Side Bend'],
    ë°”ë : ['Twist on Barrel']
  },
  'ê¹Šì€ì½”ì–´ ì•½í™”': {
    ë§¤íŠ¸: ['Dead Bug', 'Modified Hundred'],
    ë¦¬í¬ë¨¸: ['Footwork - Parallel'],
    ìºë”œë½: ['Breathing with Springs'],
    ì²´ì–´: ['Seated Balance'],
    ë°”ë : ['Core Integration']
  },
  'í‰ì¶” ê³¼í›„ë§Œ': {
    ë§¤íŠ¸: ['Swan', 'Extension Series'],
    ë¦¬í¬ë¨¸: ['Short Box - Arch'],
    ìºë”œë½: ['Monkey Stretch'],
    ì²´ì–´: ['Back Extension'],
    ë°”ë : ['Chest Opening']
  },
  'ìš”ì¶” ê³¼ì „ë§Œ': {
    ë§¤íŠ¸: ['Pelvic Curl', 'Imprint & Release'],
    ë¦¬í¬ë¨¸: ['Pelvic Press', 'Knee Stretches'],
    ìºë”œë½: ['Tower - Hip Work'],
    ì²´ì–´: ['Hip Flexor Stretch'],
    ë°”ë : ['Hip Opening']
  },
  'ì²™ì¶”ê¸°ë¦½ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Swimming', 'Rocking'],
    ë¦¬í¬ë¨¸: ['Long Back Stretch'],
    ìºë”œë½: ['Back Extension Springs'],
    ì²´ì–´: ['Swan on Chair'],
    ë°”ë : ['Round Back']
  },
  'ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ë‹¨ì¶•': {
    ë§¤íŠ¸: ['Hip Flexor Stretch', 'Lunge'],
    ë¦¬í¬ë¨¸: ['Lunge Series', 'Runner Stretch'],
    ìºë”œë½: ['Tower - Hip Stretch'],
    ì²´ì–´: ['Standing Lunge'],
    ë°”ë : ['Hip Flexor Series']
  },
  'ë‘”ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Bridge Series', 'Clam'],
    ë¦¬í¬ë¨¸: ['Footwork - RelevÃ©', 'Leg Press'],
    ìºë”œë½: ['Leg Springs - Circles'],
    ì²´ì–´: ['Glute Press Back'],
    ë°”ë : ['Hip Extension']
  },
  'ê³¨ë°˜ ë¶ˆì•ˆì •': {
    ë§¤íŠ¸: ['Single Leg Bridge', 'Single Leg Stretch'],
    ë¦¬í¬ë¨¸: ['Single Leg Work'],
    ìºë”œë½: ['Leg Springs - Adduction'],
    ì²´ì–´: ['Standing Balance'],
    ë°”ë : ['Stability Challenge']
  },
  'ëŒ€í‡´ì‚¬ë‘ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Wall Squat', 'Single Leg Squat'],
    ë¦¬í¬ë¨¸: ['Footwork - Heels', 'Squats'],
    ìºë”œë½: ['Leg Press Springs'],
    ì²´ì–´: ['Standing Press Down'],
    ë°”ë : ['Leg Strengthening']
  },
  'í–„ìŠ¤íŠ¸ë§ ë‹¨ì¶•': {
    ë§¤íŠ¸: ['Leg Pull Front', 'Roll Over'],
    ë¦¬í¬ë¨¸: ['Hamstring Stretch', 'Tendon Stretch'],
    ìºë”œë½: ['Tower - Leg Stretch'],
    ì²´ì–´: ['Leg Pull Back'],
    ë°”ë : ['Hip Flexor Stretch']
  },
  'ì¢…ì•„ë¦¬ ê·¼ìœ¡ ê¸´ì¥': {
    ë§¤íŠ¸: ['Calf Stretch', 'Ankle Circles'],
    ë¦¬í¬ë¨¸: ['Calf Raises', 'Tendon Stretch'],
    ìºë”œë½: ['Foot Corrector Work'],
    ì²´ì–´: ['Heel Raises'],
    ë°”ë : ['Ankle Mobility']
  }
};

// ê·¼ìœ¡ ì´ë¦„ì„ í•„ë¼í…ŒìŠ¤ ë¬¸ì œë¡œ ë§¤í•‘
function mapMuscleToPilatesIssue(muscleName) {
  const mapping = {
    'ìƒë¶€ìŠ¹ëª¨ê·¼': 'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥',
    'ê²¬ê°‘ê±°ê·¼': 'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥',
    'SCM': 'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥',
    'í‰ì‡„ìœ ëŒê·¼': 'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥',
    'ì‹¬ë¶€ê²½ë¶€êµ´ê·¼': 'ëª© êµ´ê³¡ê·¼ ì•½í™”',
    'ì „ê±°ê·¼': 'ëª© êµ´ê³¡ê·¼ ì•½í™”',
    'í•˜ë¶€ìŠ¹ëª¨ê·¼': 'ì „ë°©ì–´ê¹¨ìì„¸',
    'ì¥ìš”ê·¼': 'ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ë‹¨ì¶•',
    'ìš”ì¶”ê¸°ë¦½ê·¼': 'ìš”ì¶” ê³¼ì „ë§Œ',
    'ëŒ€í‡´ì§ê·¼': 'ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ë‹¨ì¶•',
    'í‰ìš”ê·¼ë§‰': 'ìš”ì¶” ê³¼ì „ë§Œ',
    'ë³µíš¡ê·¼': 'ê¹Šì€ì½”ì–´ ì•½í™”',
    'ë‘”ê·¼': 'ë‘”ê·¼ ì•½í™”',
    'ëŒ€ë‘”ê·¼': 'ë‘”ê·¼ ì•½í™”',
    'ì¤‘ë‘”ê·¼': 'ë‘”ê·¼ ì•½í™”',
    'í•˜ë‘”ê·¼': 'ë‘”ê·¼ ì•½í™”',
    'ë³µì§ê·¼': 'ë³µì§ê·¼ ì•½í™”',
    'ëŒ€í‡´ì‚¬ë‘ê·¼': 'ëŒ€í‡´ì‚¬ë‘ê·¼ ì•½í™”',
    'í–„ìŠ¤íŠ¸ë§': 'í–„ìŠ¤íŠ¸ë§ ë‹¨ì¶•',
    'ë¹„ë³µê·¼': 'ì¢…ì•„ë¦¬ ê·¼ìœ¡ ê¸´ì¥',
    'ê°€ìë¯¸ê·¼': 'ì¢…ì•„ë¦¬ ê·¼ìœ¡ ê¸´ì¥',
    'ìŠ¬ì™€ê·¼': 'í–„ìŠ¤íŠ¸ë§ ë‹¨ì¶•'
  };
  return mapping[muscleName] || null;
}

// í•„ë¼í…ŒìŠ¤ ë™ì‘ ì¶”ì²œ í•¨ìˆ˜
function recommendPilates(tight, weak) {
  const pilatesIssues = new Map();
  
  // ê¸´ì¥ëœ ê·¼ìœ¡ì— ëŒ€í•œ í•„ë¼í…ŒìŠ¤
  tight.forEach(muscle => {
    const issue = mapMuscleToPilatesIssue(muscle);
    if(issue && pilatesData[issue]) {
      if(!pilatesIssues.has(issue)) {
        pilatesIssues.set(issue, { type: 'ê¸´ì¥', muscles: [], pilates: pilatesData[issue] });
      }
      pilatesIssues.get(issue).muscles.push(muscle);
    }
  });
  
  // ì•½í™”ëœ ê·¼ìœ¡ì— ëŒ€í•œ í•„ë¼í…ŒìŠ¤
  weak.forEach(muscle => {
    const issue = mapMuscleToPilatesIssue(muscle);
    if(issue && pilatesData[issue]) {
      if(!pilatesIssues.has(issue)) {
        pilatesIssues.set(issue, { type: 'ì•½í™”', muscles: [], pilates: pilatesData[issue] });
      }
      pilatesIssues.get(issue).muscles.push(muscle);
    }
  });
  
  return Array.from(pilatesIssues.entries()).map(([issue, data]) => ({
    issue,
    type: data.type,
    muscles: [...new Set(data.muscles)],
    pilates: data.pilates
  }));
}
const internalAngle = (a,b,c) => {
  const ab = Math.atan2(a.y - b.y, a.x - b.x);
  const cb = Math.atan2(c.y - b.y, c.x - b.x);
  let d = Math.abs(ab - cb);
  if(d > Math.PI) d = 2 * Math.PI - d;
  return d;
};

// Before/After ì„¸ì…˜ ì „í™˜ ë²„íŠ¼ (DOM ë¡œë“œ í›„ ì•ˆì „í•˜ê²Œ ì—°ê²°)
function initSessionButtons() {
  console.log("initSessionButtons í˜¸ì¶œë¨, readyState:", document.readyState);
  const btnBefore = document.getElementById("btnBefore");
  const btnAfter = document.getElementById("btnAfter");
  const btnOrientationSide = document.getElementById("btnOrientationSide");
  const btnOrientationFront = document.getElementById("btnOrientationFront");
  
  console.log("ë²„íŠ¼ ìš”ì†Œ:", {btnBefore, btnAfter, btnOrientationSide, btnOrientationFront});
  
  if(btnBefore) {
    btnBefore.onclick = () => {
      console.log("Before ë²„íŠ¼ í´ë¦­ë¨");
      switchSession("Before");
    };
  } else {
    console.error("btnBeforeë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
  }
  
  if(btnAfter) {
    btnAfter.onclick = () => {
      console.log("After ë²„íŠ¼ í´ë¦­ë¨");
      switchSession("After");
    };
  } else {
    console.error("btnAfterë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
  }
  
  if(btnOrientationSide) {
    btnOrientationSide.onclick = () => {
      console.log("ì˜†ëª¨ìŠµ ë²„íŠ¼ í´ë¦­ë¨");
      setOrientation("side");
    };
  } else {
    console.error("btnOrientationSideë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
  }
  
  if(btnOrientationFront) {
    btnOrientationFront.onclick = () => {
      console.log("ì •ë©´ ë²„íŠ¼ í´ë¦­ë¨");
      setOrientation("front");
    };
  } else {
    console.error("btnOrientationFrontë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
  }
  
  console.log("initSessionButtons ì™„ë£Œ");
}

// DOM ë¡œë“œ í›„ ë²„íŠ¼ ì´ë²¤íŠ¸ ì´ˆê¸°í™” (ì£¼ì„ ì²˜ë¦¬ - ì•„ë˜ ë‘ ë²ˆì§¸ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ì—ì„œ í†µí•© ì²˜ë¦¬)
// if(document.readyState === 'loading') {
//   console.log("DOMì´ ì•„ì§ ë¡œë”© ì¤‘, DOMContentLoaded ì´ë²¤íŠ¸ ëŒ€ê¸°");
//   document.addEventListener('DOMContentLoaded', () => {
//     console.log("DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ");
//     initSessionButtons();
//   });
// } else {
//   console.log("DOMì´ ì´ë¯¸ ë¡œë“œë¨, ì¦‰ì‹œ initSessionButtons í˜¸ì¶œ");
//   initSessionButtons();
// }

// ì¶”ê°€ ì•ˆì „ ì¥ì¹˜: window.onloadì—ì„œë„ í•œ ë²ˆ ë” í˜¸ì¶œ (ì£¼ì„ ì²˜ë¦¬)
// window.addEventListener('load', () => {
//   console.log("window.onload ì´ë²¤íŠ¸ ë°œìƒ, initSessionButtons ì¬í˜¸ì¶œ");
//   initSessionButtons();
// });

function updateCoordSelectOptions() {
  const selectEl = document.getElementById("coordSelectPoint");
  if(!selectEl) return;
  
  const orientation = sessions[cur].poseData?.orientation || "side";
  const currentKeypoints = orientation === "front" ? keypointsFront : keypointsSide;
  const currentValue = selectEl.value;
  
  // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ì˜µì…˜ì¸ "ì  ì„ íƒ..." ì œì™¸)
  while(selectEl.options.length > 1) {
    selectEl.remove(1);
  }
  
  // í˜„ì¬ orientationì— ë§ëŠ” í‚¤í¬ì¸íŠ¸ ì¶”ê°€
  currentKeypoints.forEach(kp => {
    const option = document.createElement('option');
    option.value = kp.key;
    option.textContent = kp.key;
    selectEl.appendChild(option);
  });
  
  // ì´ì „ì— ì„ íƒëœ ì ì´ í˜„ì¬ í‚¤í¬ì¸íŠ¸ ëª©ë¡ì— ìˆìœ¼ë©´ ìœ ì§€
  if(currentValue && currentKeypoints.some(kp => kp.key === currentValue)) {
    selectEl.value = currentValue;
  } else {
    selectEl.value = "";
    selectedPoint = null;
  }
}

function setOrientation(orientation) {
  if(!sessions[cur].poseData) {
    sessions[cur].poseData = { orientation: orientation, landmarks: null };
  } else {
    sessions[cur].poseData.orientation = orientation;
  }
  
  const btnSide = document.getElementById("btnOrientationSide");
  const btnFront = document.getElementById("btnOrientationFront");
  if(btnSide) btnSide.classList.toggle("active", orientation === "side");
  if(btnFront) btnFront.classList.toggle("active", orientation === "front");
  
  console.log(`${cur} ì„¸ì…˜ì˜ ë°©í–¥ì„ ${orientation === "side" ? "ì˜†ëª¨ìŠµ" : "ì •ë©´"}ìœ¼ë¡œ ì„¤ì •`);
  
  // ì¢Œí‘œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
  updateCoordSelectOptions();
  
  // ì›ë³¸ í¬ê¸° ì´ˆê¸°í™” (orientationë§ˆë‹¤ ë‹¤ë¥¸ ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŒ)
  originalCanvasSize.width = 0;
  originalCanvasSize.height = 0;
  originalCanvasSize.styleWidth = 0;
  originalCanvasSize.styleHeight = 0;
  
  // orientation ë³€ê²½ ì‹œ ìº”ë²„ìŠ¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  const currentImg = orientation === "front" ? sessions[cur].imgFront : sessions[cur].imgSide;
  if(currentImg && currentImg.complete && currentImg.naturalWidth > 0) {
    resizeCanvasFor(currentImg);
    draw();
  } else {
    // ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ë¡œë“œ ì¤‘ì´ë©´ ê¸°ë³¸ í¬ê¸°ë¡œ ì„¤ì •í•˜ê³  ê·¸ë¦¬ê¸°
    resizeCanvasFor(null);
  draw();
  }
}

function switchSession(s) {
  cur = s;
  
  const btnBefore = document.getElementById("btnBefore");
  const btnAfter = document.getElementById("btnAfter");
  const currentSessionEl = document.getElementById("currentSession");
  
  if(btnBefore) btnBefore.classList.toggle("active", s === "Before");
  if(btnAfter) btnAfter.classList.toggle("active", s === "After");
  if(currentSessionEl) currentSessionEl.textContent = s;
  
  // ì„¸ì…˜ ì „í™˜ ì‹œ orientation ë²„íŠ¼ ì—…ë°ì´íŠ¸
  const orientation = sessions[s].poseData?.orientation || "side";
  const btnSide = document.getElementById("btnOrientationSide");
  const btnFront = document.getElementById("btnOrientationFront");
  if(btnSide) btnSide.classList.toggle("active", orientation === "side");
  if(btnFront) btnFront.classList.toggle("active", orientation === "front");
  
  // ì¢Œí‘œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
  updateCoordSelectOptions();
  
  // ì›ë³¸ í¬ê¸° ì´ˆê¸°í™” (ì„¸ì…˜ë§ˆë‹¤ ë‹¤ë¥¸ ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŒ)
  originalCanvasSize.width = 0;
  originalCanvasSize.height = 0;
  originalCanvasSize.styleWidth = 0;
  originalCanvasSize.styleHeight = 0;
  
  // ì„¸ì…˜ì˜ ì´ë¯¸ì§€ë¡œ ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
  const img = orientation === "front" ? sessions[s].imgFront : sessions[s].imgSide;
  if(img && img.complete && img.naturalWidth > 0) {
    resizeCanvasFor(img);
  draw();
  } else {
    // ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ë¡œë“œ ì¤‘ì´ë©´ ê¸°ë³¸ í¬ê¸°ë¡œ ì„¤ì •í•˜ê³  ê·¸ë¦¬ê¸°
    resizeCanvasFor(null);
    draw();
  }
  
  // ì„¸ì…˜ ì „í™˜ ì‹œì—ëŠ” ê¸°ì¡´ ë¶„ì„ì´ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ metricsë§Œ ê³„ì‚°
  if(sessions[s].analysis) {
    // ê¸°ì¡´ ë¶„ì„ì´ ìˆìœ¼ë©´ ì „ì²´ ì—…ë°ì´íŠ¸
    const score = sessions[s].score;
    const metrics = sessions[s].metrics;
    const analysis = sessions[s].analysis;
    updateScoreAndAnalysis(score, metrics.cva, metrics.pelvic, metrics.knee, analysis);
  } else {
    computeMetricsOnly(); // ë¶„ì„ì´ ì—†ìœ¼ë©´ metricsë§Œ ê³„ì‚°
  }
  updateCompare();
}

function resizeCanvasFor(img) {
  const canvasWrap = cv.parentElement;
  if(!canvasWrap) {
    console.error("canvasWrapë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
    return;
  }
  
  const maxW = Math.max(canvasWrap.clientWidth - 24, 600);
  const maxH = Math.max(canvasWrap.clientHeight - 24, 400);
  
  // ì›ë³¸ í¬ê¸° ê³„ì‚° (ì²˜ìŒ í•œ ë²ˆë§Œ ë˜ëŠ” editModeê°€ ì•„ë‹ ë•Œ)
  let baseW, baseH;
  if(!editMode || originalCanvasSize.width === 0 || originalCanvasSize.height === 0) {
    if(img && img.naturalWidth > 0 && img.naturalHeight > 0) {
    // ì»¨í…Œì´ë„ˆì— ë§ê²Œ ì›ë³¸ ë¹„ìœ¨ ìœ ì§€í•˜ë©° í¬ê¸° ê³„ì‚°
    const r = Math.min(maxW / img.naturalWidth, maxH / img.naturalHeight);
    baseW = Math.round(img.naturalWidth * r);
    baseH = Math.round(img.naturalHeight * r);
      console.log("ì´ë¯¸ì§€ ê¸°ë°˜ ìº”ë²„ìŠ¤ í¬ê¸°:", {baseW, baseH, naturalW: img.naturalWidth, naturalH: img.naturalHeight});
  } else {
      baseW = Math.min(maxW, 1200);
      baseH = Math.min(maxH, 800);
      console.log("ê¸°ë³¸ ìº”ë²„ìŠ¤ í¬ê¸°:", {baseW, baseH});
  }
  
    // ì›ë³¸ í¬ê¸° ì €ì¥
    originalCanvasSize.width = baseW;
    originalCanvasSize.height = baseH;
    originalCanvasSize.styleWidth = baseW;
    originalCanvasSize.styleHeight = baseH;
  } else {
    // ì´ë¯¸ ì €ì¥ëœ ì›ë³¸ í¬ê¸° ì‚¬ìš© (editModeì—ì„œ í™•ëŒ€ ì‹œ)
    baseW = originalCanvasSize.width;
    baseH = originalCanvasSize.height;
  }
  
  // í™•ëŒ€ ë°°ìœ¨ ì ìš© (ë¹„ìœ¨ ìœ ì§€)
  const zoomMultiplier = editMode ? currentZoom : 1;
  const finalW = baseW * zoomMultiplier;
  const finalH = baseH * zoomMultiplier;
  
  // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
  cv.width = finalW * DPR;
  cv.height = finalH * DPR;
  cv.style.width = finalW + "px";
  cv.style.height = finalH + "px";
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  
  // í™•ëŒ€ëœ ê²½ìš° ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
  if(editMode && currentZoom > 1) {
    canvasWrap.classList.add("zoomed");
    canvasWrap.style.overflow = "auto";
    canvasWrap.style.overflowX = "auto";
    canvasWrap.style.overflowY = "auto";
  } else {
    canvasWrap.classList.remove("zoomed");
    canvasWrap.style.overflow = "auto";
    canvasWrap.style.overflowX = "hidden";
    canvasWrap.style.overflowY = "hidden";
  }
  
  // ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  draw();
}

function ensureDefaultPoints(session) {
  const S = sessions[session];
  // ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì¢Œí‘œ ê³„ì‚°
  const W = originalCanvasSize.width || (cv.width / DPR / (editMode ? currentZoom : 1));
  const H = originalCanvasSize.height || (cv.height / DPR / (editMode ? currentZoom : 1));
  
  const orientation = S.poseData?.orientation || "side";
  const currentImg = orientation === "front" ? S.imgFront : S.imgSide;
  const currentKeypoints = orientation === "front" ? keypointsFront : keypointsSide;
  const currentPoints = orientation === "front" ? S.frontPoints : S.sidePoints;
  
  if(currentPoints.size === 0 && currentImg) {
    // Flutter 1:1 ë§¤ì¹­ í‚¤ë¡œ ê¸°ë³¸ê°’ ì„¤ì •
    const defaults = orientation === "front" ? {
      c7: {x:W*0.5, y:H*0.2},
      L_acromion: {x:W*0.3, y:H*0.3},
      R_acromion: {x:W*0.7, y:H*0.3},
      L_asis: {x:W*0.35, y:H*0.5},
      R_asis: {x:W*0.65, y:H*0.5},
      L_knee: {x:W*0.4, y:H*0.75},
      R_knee: {x:W*0.6, y:H*0.75},
      L_ankle: {x:W*0.4, y:H*0.95},
      R_ankle: {x:W*0.6, y:H*0.95},
      // Q-angle ì¸¡ì •ìš© dot (ë¬´ë¦ ì¤‘ì‹¬ ê·¼ì²˜)
      L_patella: {x:W*0.4, y:H*0.75},  // ì¢Œì¸¡ ìŠ¬ê°œê³¨ ì¤‘ì‹¬
      R_patella: {x:W*0.6, y:H*0.75},  // ìš°ì¸¡ ìŠ¬ê°œê³¨ ì¤‘ì‹¬
      L_tibial_tub: {x:W*0.4, y:H*0.78},  // ì¢Œì¸¡ ê²½ê³¨ ê²°ì ˆ (ìŠ¬ê°œê³¨ ì•„ë˜ ì•½ê°„)
      R_tibial_tub: {x:W*0.6, y:H*0.78},  // ìš°ì¸¡ ê²½ê³¨ ê²°ì ˆ (ìŠ¬ê°œê³¨ ì•„ë˜ ì•½ê°„)
    } : {
      tragus: {x:W*0.35, y:H*0.3},
      c7: {x:W*0.3, y:H*0.35},
      acromion: {x:W*0.35, y:H*0.4},
      hip: {x:W*0.38, y:H*0.6},
      knee: {x:W*0.42, y:H*0.8},
      ankle: {x:W*0.44, y:H*0.95},
      asis: {x:W*0.40, y:H*0.58},
      psis: {x:W*0.35, y:H*0.6},
    };
    for(const kp of currentKeypoints) {
      if(defaults[kp.key]) currentPoints.set(kp.key, {...defaults[kp.key]});
    }
  }
}

function getPts(session) {
  const orientation = sessions[session].poseData?.orientation || "side";
  const map = orientation === "front" ? sessions[session].frontPoints : sessions[session].sidePoints;
  const currentKeypoints = orientation === "front" ? keypointsFront : keypointsSide;
  const out = {};
  
  // ìƒˆë¡œìš´ ì†Œë¬¸ì í‚¤ë¡œ ì €ì¥ëœ ê°’ ê°€ì ¸ì˜¤ê¸°
  for(const k of currentKeypoints) {
    out[k.key] = map.get(k.key);
  }
  
  // ê¸°ì¡´ ëŒ€ë¬¸ì í‚¤ í˜¸í™˜ì„± ë ˆì´ì–´ (draw, computeMetricsOnly ë“±ì—ì„œ ì‚¬ìš©)
  if(orientation === "side") {
    out['Tragus'] = out['tragus'];
    out['C7'] = out['c7'];
    out['Shoulder'] = out['acromion'];  // ê¸°ì¡´ Shoulder í‚¤ ì§€ì›
    out['Acromion'] = out['acromion'];
    out['Hip'] = out['hip'];
    out['Knee'] = out['knee'];
    out['Ankle'] = out['ankle'];
    out['ASIS'] = out['asis'];
    out['PSIS'] = out['psis'];
  }
  // ì •ë©´ì€ ì´ë¯¸ ì¼ì¹˜í•˜ë¯€ë¡œ ì¶”ê°€ ë§¤í•‘ ë¶ˆí•„ìš” (c7ë§Œ ì²˜ë¦¬)
  if(orientation === "front") {
    out['C7'] = out['c7'];
  }
  
  return out;
}

// í˜„ì¬ orientationì— ë§ëŠ” í‚¤í¬ì¸íŠ¸ ë°˜í™˜
function getKeypoints() {
  const orientation = sessions[cur].poseData?.orientation || "side";
  return orientation === "front" ? keypointsFront : keypointsSide;
}

function draw() {
  const S = sessions[cur];
  const W = cv.width / DPR, H = cv.height / DPR;
  ctx.clearRect(0, 0, cv.width, cv.height);
  ctx.fillStyle = "#0a0e13";
  ctx.fillRect(0, 0, W, H);

  // orientationì— ë”°ë¼ ì ì ˆí•œ ì´ë¯¸ì§€ ì„ íƒ
  const orientation = S.poseData?.orientation || "side";
  const currentImg = orientation === "front" ? S.imgFront : S.imgSide;

  if(currentImg && currentImg.complete && currentImg.naturalWidth > 0 && currentImg.naturalHeight > 0) {
    // ì›ë³¸ í¬ê¸° ì €ì¥ (ì²˜ìŒ í•œ ë²ˆë§Œ)
    if(originalCanvasSize.width === 0) {
      const maxW = cv.parentElement.clientWidth - 24;
      const maxH = cv.parentElement.clientHeight - 24;
      const r = Math.min(maxW / currentImg.naturalWidth, maxH / currentImg.naturalHeight);
      originalCanvasSize.width = Math.round(currentImg.naturalWidth * r);
      originalCanvasSize.height = Math.round(currentImg.naturalHeight * r);
      originalCanvasSize.styleWidth = originalCanvasSize.width;
      originalCanvasSize.styleHeight = originalCanvasSize.height;
    }
    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ë¹„ìœ¨ ìœ ì§€í•˜ë©° í™•ëŒ€ëœ í¬ê¸°ë¡œ)
    try {
    ctx.drawImage(currentImg, 0, 0, W, H);
    } catch(err) {
      console.error("ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° ì‹¤íŒ¨:", err);
    }
  } else if(currentImg && !currentImg.complete) {
    // ì´ë¯¸ì§€ê°€ ì•„ì§ ë¡œë“œ ì¤‘ì´ë©´ ë‹¤ì‹œ ì‹œë„
    currentImg.onload = () => {
      resizeCanvasFor(currentImg);
      draw();
    };
  }

  ensureDefaultPoints(cur);
  const P = getPts(cur);
  const currentKeypoints = getKeypoints();

  // í™•ëŒ€ ë°°ìœ¨ ì ìš©
  const scaleX = editMode ? currentZoom : 1;
  const scaleY = editMode ? currentZoom : 1;

  // ë³´ì¡°ì„  ê·¸ë¦¬ê¸°
  ctx.lineWidth = 2;
  ctx.setLineDash([8, 6]);
  ctx.strokeStyle = 'rgba(124,156,255,0.85)';

  if(P.C7 && P.Tragus) {
    ctx.beginPath();
    ctx.moveTo(0, P.C7.y * scaleY);
    ctx.lineTo(W, P.C7.y * scaleY);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(P.C7.x * scaleX, P.C7.y * scaleY);
    ctx.lineTo(P.Tragus.x * scaleX, P.Tragus.y * scaleY);
    ctx.stroke();
  }

  if(P.Shoulder && P.Hip) {
    ctx.beginPath();
    ctx.moveTo(P.Shoulder.x * scaleX, P.Shoulder.y * scaleY);
    ctx.lineTo(P.Hip.x * scaleX, P.Hip.y * scaleY);
    ctx.stroke();
  }
  if(P.Hip && P.Knee) {
    ctx.beginPath();
    ctx.moveTo(P.Hip.x * scaleX, P.Hip.y * scaleY);
    ctx.lineTo(P.Knee.x * scaleX, P.Knee.y * scaleY);
    ctx.stroke();
  }
  if(P.Knee && P.Ankle) {
    ctx.beginPath();
    ctx.moveTo(P.Knee.x * scaleX, P.Knee.y * scaleY);
    ctx.lineTo(P.Ankle.x * scaleX, P.Ankle.y * scaleY);
    ctx.stroke();
  }

  if(P.ASIS && P.PSIS) {
    ctx.strokeStyle = 'rgba(255,184,108,0.95)';
    ctx.beginPath();
    ctx.moveTo(P.ASIS.x * scaleX, P.ASIS.y * scaleY);
    ctx.lineTo(P.PSIS.x * scaleX, P.PSIS.y * scaleY);
    ctx.stroke();
    ctx.strokeStyle = 'rgba(255,184,108,0.35)';
    const midy = (P.ASIS.y + P.PSIS.y) / 2;
    ctx.beginPath();
    ctx.moveTo(0, midy * scaleY);
    ctx.lineTo(W, midy * scaleY);
    ctx.stroke();
  }

  ctx.setLineDash([]);

  // ëª¨ë“  dotë“¤ì„ ì—°ê²°í•˜ëŠ” ì ì„  ê·¸ë¦¬ê¸°
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 4]);
  ctx.strokeStyle = 'rgba(100,100,100,0.4)';
  ctx.beginPath();
  let firstPoint = true;
  for(const kp of currentKeypoints) {
    const pt = P[kp.key];
    if(!pt) continue;
    const x = pt.x * scaleX;
    const y = pt.y * scaleY;
    if(firstPoint) {
      ctx.moveTo(x, y);
      firstPoint = false;
    } else {
      ctx.lineTo(x, y);
    }
  }
  ctx.stroke();
  ctx.setLineDash([]);

  // ì  ê·¸ë¦¬ê¸° (orientationì— ë§ëŠ” í‚¤í¬ì¸íŠ¸ ì‚¬ìš©)
  for(const kp of currentKeypoints) {
    const pt = P[kp.key];
    if(!pt) continue;
    const isSelected = editMode && selectedPoint === kp.key;
    drawHandle(pt.x * scaleX, pt.y * scaleY, kp.key, kp.color, isSelected);
  }
  
  // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì—ì„œ ì„ íƒëœ ì ì´ ìˆê³  ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì•ˆë‚´ í‘œì‹œ
  if(editMode && selectedPoint && !P[selectedPoint]) {
    const W = cv.width / DPR, H = cv.height / DPR;
    ctx.fillStyle = 'rgba(124,156,255,0.7)';
    ctx.font = 'bold 16px "Noto Sans KR"';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('ì¢Œí‘œë¥¼ ì…ë ¥í•˜ê³  "ì ìš©" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', W / 2, H / 2);
    ctx.textAlign = 'left';
    ctx.textBaseline = 'alphabetic';
  }
  
  // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì  í‘œì‹œ (ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œì¼ ë•Œ)
  if(calibrationMode && S.calibrationPoint1) {
    ctx.fillStyle = '#ffb86c';
    ctx.strokeStyle = '#ffb86c';
    ctx.lineWidth = 2;
    
    // ì  1 í‘œì‹œ
    const p1 = S.calibrationPoint1;
    ctx.beginPath();
    ctx.arc(p1.x * scaleX, p1.y * scaleY, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.stroke();
    
    // ì  2ê°€ ìˆìœ¼ë©´ í‘œì‹œí•˜ê³  ì„  ê·¸ë¦¬ê¸°
    if(S.calibrationPoint2) {
      const p2 = S.calibrationPoint2;
      ctx.beginPath();
      ctx.arc(p2.x * scaleX, p2.y * scaleY, 8, 0, Math.PI * 2);
      ctx.fill();
      ctx.stroke();
      
      // ë‘ ì  ì‚¬ì´ ì„  ê·¸ë¦¬ê¸°
      ctx.beginPath();
      ctx.moveTo(p1.x * scaleX, p1.y * scaleY);
      ctx.lineTo(p2.x * scaleX, p2.y * scaleY);
      ctx.stroke();
    }
  }
}

function drawHandle(x, y, label, color, isSelected = false) {
  // ì„ íƒëœ ì ì€ ë” í¬ê³  ê°•ì¡° í‘œì‹œ
  const radius = isSelected ? 12 : 8;
  const strokeWidth = isSelected ? 3 : 2;
  
  // ì„ íƒëœ ì ì€ ì™¸ê³½ ë§ í‘œì‹œ
  if(isSelected) {
    ctx.fillStyle = 'rgba(124,156,255,0.3)';
    ctx.beginPath();
    ctx.arc(x, y, radius + 4, 0, Math.PI * 2);
    ctx.fill();
  }
  
  // ì ì„ ë” í¬ê²Œ ê·¸ë¦¬ê³  ë“œë˜ê·¸ ì˜ì—­ì„ ë„“ê²Œ
  ctx.fillStyle = color;
  ctx.strokeStyle = isSelected ? 'rgba(124,156,255,1)' : 'rgba(0,0,0,0.8)';
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  ctx.fill();
  ctx.lineWidth = strokeWidth;
  ctx.stroke();
  ctx.font = '12px "Noto Sans KR"';
  const pad = 4;
  const tw = ctx.measureText(label).width;
  const th = 16;
  ctx.fillStyle = isSelected ? 'rgba(124,156,255,0.8)' : 'rgba(0,0,0,0.6)';
  ctx.fillRect(x + 10, y - 12, tw + pad * 2, th);
  ctx.fillStyle = '#e7eef7';
  ctx.fillText(label, x + 10 + pad, y + 1);
}

// ê°ë„ì™€ ì ìˆ˜ë§Œ ê³„ì‚° (ì‹¤ì‹œê°„ í‘œì‹œìš©, AI ë¶„ì„ ì—†ìŒ)
function computeMetricsOnly() {
  const S = sessions[cur];
  const P = getPts(cur);
  let cva = null, pelvic = null, knee = null;

  if(P.C7 && P.Tragus) {
    // CVA: C7 SPì—ì„œ ì‹œì‘í•˜ëŠ” ìˆ˜í‰ì„ ê³¼ C7 SPì—ì„œ Tragusë¡œ ê°€ëŠ” ë²¡í„° ì‚¬ì´ì˜ ê°ë„
    const dx = P.Tragus.x - P.C7.x;
    const dy = P.Tragus.y - P.C7.y;
    const angle = Math.atan2(dy, dx);
    let cvaDeg = rad2deg(angle);
    
    // CVAëŠ” 0~90ë„ ë²”ìœ„ë¡œ ì •ê·œí™”
    if(cvaDeg < 0) {
      cvaDeg = 180 + cvaDeg;
    }
    if(cvaDeg > 90) {
      cvaDeg = 180 - cvaDeg;
    }
    cva = cvaDeg;
  }
  if(P.ASIS && P.PSIS) {
    // TRUNK ê°ë„: ìˆ˜í‰ì„ ê³¼ ASIS-PSIS ì„  ì‚¬ì´ì˜ ê°ë„
    // ASISì—ì„œ PSISë¡œ ê°€ëŠ” ë²¡í„°ì˜ ê°ë„ë¥¼ ê³„ì‚°
    const dx = P.PSIS.x - P.ASIS.x;
    const dy = P.PSIS.y - P.ASIS.y;
    const angle = Math.atan2(dy, dx);
    let pelvicDeg = rad2deg(angle);
    
    // ìˆ˜í‰ì„  ê¸°ì¤€ìœ¼ë¡œ ê°ë„ ì •ê·œí™” (-90~90ë„ ë²”ìœ„)
    // -176.4ë„ëŠ” 180 + (-176.4) = 3.6ë„ë¡œ ë³€í™˜ë˜ì–´ì•¼ í•¨
    // ê°ë„ë¥¼ -180~180 ë²”ìœ„ì—ì„œ -90~90 ë²”ìœ„ë¡œ ë³€í™˜
    if(pelvicDeg < -90) {
      // -176.4ë„ ê°™ì€ ê²½ìš°: 180 + (-176.4) = 3.6ë„
      pelvicDeg = 180 + pelvicDeg;
    } else if(pelvicDeg > 90) {
      // 176.4ë„ ê°™ì€ ê²½ìš°: 176.4 - 180 = -3.6ë„
      pelvicDeg = pelvicDeg - 180;
    }
    
    pelvic = pelvicDeg;
  }
  if(P.Hip && P.Knee && P.Ankle) {
    knee = rad2deg(internalAngle(P.Hip, P.Knee, P.Ankle));
  }

  S.metrics = { cva, pelvic, knee };
  const score = computeScore(cva, pelvic, knee);
  S.score = score;
  
  // AI ë¶„ì„ì€ í•˜ì§€ ì•ŠìŒ (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ)
  
  updateDisplay();
  updateCompare();
  // ì ìˆ˜ë§Œ ì—…ë°ì´íŠ¸ (AI ë¶„ì„ ì—†ìŒ)
  const scoreEl = document.getElementById("totalScore");
  const reasonEl = document.getElementById("scoreReason");
  if(scoreEl && score) {
    scoreEl.textContent = score.score;
    if(score >= 85) {
      scoreEl.style.color = "#2ec4b6";
    } else if(score >= 70) {
      scoreEl.style.color = "#ffd166";
    } else {
      scoreEl.style.color = "#ff6b6b";
    }
  }
  if(reasonEl && score) {
    if(score.reasons && score.reasons.length > 0) {
      reasonEl.textContent = "ê°ì  ê·¼ê±°: " + score.reasons.join(", ");
    } else {
      reasonEl.textContent = "ëª¨ë“  ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.";
    }
  }
}

// ì „ì²´ ê³„ì‚° (AI ë¶„ì„ í¬í•¨) - ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ í˜¸ì¶œ
function computeAll() {
  const S = sessions[cur];
  const pxPerCm = S.pxPerCm || 50.0;
  
  // ì¸¡ë©´ ë° ì •ë©´ í‚¤í¬ì¸íŠ¸ë¥¼ Map í˜•íƒœë¡œ ë³€í™˜
  const sidePoints = {};
  const frontPoints = {};
  
  // ì¸¡ë©´ í‚¤í¬ì¸íŠ¸
  for(const [key, value] of S.sidePoints.entries()) {
    if(value && value.x != null && value.y != null) {
      sidePoints[key] = { x: value.x, y: value.y };
    }
  }
  
  // ì •ë©´ í‚¤í¬ì¸íŠ¸
  for(const [key, value] of S.frontPoints.entries()) {
    if(value && value.x != null && value.y != null) {
      frontPoints[key] = { x: value.x, y: value.y };
    }
  }
  
  // í†µí•© ë¶„ì„ ì‹¤í–‰ (ìš´ë™ ì¶”ì²œ í¬í•¨)
  const analysisResult = analyzePostureAutoWithRecommendation({
    sidePts: Object.keys(sidePoints).length > 0 ? sidePoints : null,
    frontPts: Object.keys(frontPoints).length > 0 ? frontPoints : null,
    pxPerCm: pxPerCm
  });
  
  // í†µí•© ë¶„ì„ ê²°ê³¼ ì €ì¥
  S.analysisResult = analysisResult;
  
  // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ ì²˜ë¦¬
  const sideMetrics = analysisResult.side;
  const frontMetrics = analysisResult.front;
  
  // ì¸¡ë©´ ë° ì •ë©´ ë¶„ì„ ê²°ê³¼ë¥¼ í†µí•©í•˜ì—¬ fullMetricsì— ì €ì¥
  const mergedMetrics = {};
  
  // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ í†µí•©
  if(sideMetrics.status !== "not_available") {
    Object.assign(mergedMetrics, sideMetrics);
  }
  
  // ì •ë©´ ë¶„ì„ ê²°ê³¼ í†µí•© (ì¸¡ë©´ ê²°ê³¼ì™€ ë³‘í•©)
  if(frontMetrics.status !== "not_available") {
    Object.assign(mergedMetrics, frontMetrics);
  }
  
  // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œë„ ì €ì¥
  if(sideMetrics.status !== "not_available") {
    const cva = sideMetrics.CVA?.value_deg || null;
    const pelvic = sideMetrics.PTA?.value_deg || null;
    const knee = sideMetrics.KA?.value_deg || null;
    
    S.metrics = { 
      cva, 
      pelvic, 
      knee,
      fullMetrics: mergedMetrics,  // ì¸¡ë©´ + ì •ë©´ í†µí•© ê²°ê³¼
      orientation: "side",
      frontMetrics: frontMetrics.status !== "not_available" ? frontMetrics : null  // ì •ë©´ ë¶„ì„ ê²°ê³¼ ë³„ë„ ì €ì¥
    };
    
    const score = computeScore(cva, pelvic, knee);
    S.score = score;
    
    // AI ë¶„ì„ ì‹¤í–‰ (í†µí•©ëœ fullMetrics ì‚¬ìš©)
    const analysis = analyzeMuscles(cva, pelvic, knee, mergedMetrics);
    S.analysis = analysis;
    
    updateDisplay();
    updateCompare();
    updateScoreAndAnalysis(score, cva, pelvic, knee, analysis);
    
  } else if(frontMetrics.status !== "not_available") {
    // ì •ë©´ ë¶„ì„ë§Œ ìˆëŠ” ê²½ìš°
    S.metrics = { 
      fullMetrics: mergedMetrics,  // ì •ë©´ ë¶„ì„ ê²°ê³¼
      orientation: "front",
      frontMetrics: frontMetrics
    };
    S.score = null;
    S.analysis = { 
      fullMetrics: mergedMetrics,
      orientation: "front",
      comments: [],
      details: [],
      exercises: []
    };
    updateDisplay();
    updateCompare();
    displayFrontAnalysis(frontMetrics);
    // ì „ì²´ í•­ëª© í‘œì‹œë¥¼ ìœ„í•´ updateScoreAndAnalysis í˜¸ì¶œ
    updateScoreAndAnalysis(null, null, null, null, S.analysis);
  } else {
    // ë¶„ì„ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°
    S.metrics = {};
    S.score = null;
    S.analysis = null;
    updateDisplay();
    updateCompare();
    // ë¹ˆ ë°ì´í„°ë¡œ UI ì´ˆê¸°í™”
    updateScoreAndAnalysis(null, null, null, null, null);
  }
}

// ì •ë©´ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
function displayFrontAnalysis(fullMetrics) {
  const commentEl = document.getElementById("aiComment");
  const commentPanel = document.getElementById("aiCommentPanel");
  
  if(!fullMetrics || Object.keys(fullMetrics).length === 0) {
    commentPanel.style.display = "none";
    return;
  }
  
  let commentText = "ğŸ“· ì •ë©´ ìì„¸ ë¶„ì„ ê²°ê³¼:\n\n";
  const details = [];
  
  for(const [key, value] of Object.entries(fullMetrics)) {
    if(value && value.value_deg != null) {
      const statusText = {
        "normal": "âœ… ì •ìƒ",
        "mild": "âš ï¸ ê²½ë¯¸",
        "moderate": "âš ï¸ ì¤‘ë“±ë„",
        "severe": "ğŸ”´ ì‹¬ê°"
      }[value.status] || value.status;
      
      commentText += `${key}: ${value.value_deg.toFixed(1)}Â° (${statusText})\n`;
      details.push(`â€¢ ${value.meaning || key}`);
    } else if(value && value.value_cm != null) {
      const statusText = {
        "normal": "âœ… ì •ìƒ",
        "mild": "âš ï¸ ê²½ë¯¸",
        "moderate": "âš ï¸ ì¤‘ë“±ë„",
        "severe": "ğŸ”´ ì‹¬ê°"
      }[value.status] || value.status;
      
      commentText += `${key}: ${value.value_cm.toFixed(2)}cm (${statusText})\n`;
      details.push(`â€¢ ${value.meaning || key}`);
    }
  }
  
  if(details.length > 0) {
    commentText += "\n" + details.join("\n");
  }
  
  commentEl.innerHTML = commentText.replace(/\n/g, '<br>');
  commentPanel.style.display = "block";
  
}


// ì „ì²´ ë¶„ì„ í•­ëª© ê¸°ì¤€ìœ¼ë¡œ ì²´í˜• ì¢…í•© ì ìˆ˜ ê³„ì‚°
function computeScoreFromFullMetrics(fullMetrics) {
  if(!fullMetrics || Object.keys(fullMetrics).length === 0) {
    return { score: null, reasons: [], penalties: 0 };
  }
  
  let penalties = 0;
  let reasons = [];
  
  // 1. CVA (Craniovertebral Angle) - ì •ìƒ â‰¥50Â°
  const cva = fullMetrics.CVA?.value;
  if(cva != null) {
    if(cva < 50) {
      const delta = 50 - cva;
      const penalty = Math.min(40, delta * 1.6);
      penalties += penalty;
      reasons.push(`CVA ${cva.toFixed(1)}Â° (ì •ìƒ â‰¥50Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  // 2. HPD (Head Protrusion Distance) - ì •ìƒ â‰¤2cm
  const hpd = fullMetrics.HPD?.value;
  if(hpd != null && hpd > 2) {
    const delta = hpd - 2;
    const penalty = Math.min(20, delta * 5);
    penalties += penalty;
    reasons.push(`HPD ${hpd.toFixed(1)}cm (ì •ìƒ â‰¤2cm) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 3. NIA (Neck Inclination Angle) - ì •ìƒ 0-20Â°
  const nia = fullMetrics.NIA?.value;
  if(nia != null && nia > 20) {
    const delta = nia - 20;
    const penalty = Math.min(15, delta * 1.5);
    penalties += penalty;
    reasons.push(`NIA ${nia.toFixed(1)}Â° (ì •ìƒ 0-20Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 4. TIA (Trunk Inclination Angle) - ì •ìƒ 0-10Â°
  const tia = fullMetrics.TIA?.value;
  if(tia != null && tia > 10) {
    const delta = tia - 10;
    const penalty = Math.min(20, delta * 2);
    penalties += penalty;
    reasons.push(`TIA ${tia.toFixed(1)}Â° (ì •ìƒ 0-10Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 5. SAA (Scapular Alignment Angle) - ì •ìƒ 0-10Â°
  const saa = fullMetrics.SAA?.value;
  if(saa != null && saa > 10) {
    const delta = saa - 10;
    const penalty = Math.min(15, delta * 1.5);
    penalties += penalty;
    reasons.push(`SAA ${saa.toFixed(1)}Â° (ì •ìƒ 0-10Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 6. PTA (Pelvic Tilt Angle) - ì •ìƒ 0-15Â°
  const pta = fullMetrics.PTA?.value;
  if(pta != null) {
    if(pta > 15) {
      const delta = pta - 15;
      const penalty = Math.min(30, delta * 2);
      penalties += penalty;
      reasons.push(`PTA ${pta.toFixed(1)}Â° (ì •ìƒ 0-15Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    } else if(pta < 0) {
      const delta = Math.abs(pta);
      const penalty = Math.min(20, delta * 2);
      penalties += penalty;
      reasons.push(`PTA ${pta.toFixed(1)}Â° (ì •ìƒ 0-15Â°, í›„ë°© ê²½ì‚¬) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  // 7. KA (Knee Alignment Angle) - ì •ìƒ 175-185Â°
  const ka = fullMetrics.KA?.value;
  if(ka != null) {
    if(ka < 175) {
      const delta = 175 - ka;
      const penalty = Math.min(25, delta * 2.5);
      penalties += penalty;
      reasons.push(`KA ${ka.toFixed(1)}Â° (ì •ìƒ 175-185Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    } else if(ka > 185) {
      const delta = ka - 185;
      const penalty = Math.min(25, delta * 2.5);
      penalties += penalty;
      reasons.push(`KA ${ka.toFixed(1)}Â° (ì •ìƒ 175-185Â°, ê³¼ì‹ ì „) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  // 8. Tibial Angle - ì •ìƒ 0-10Â°
  const tibial = fullMetrics.Tibial_Angle?.value;
  if(tibial != null && tibial > 10) {
    const delta = tibial - 10;
    const penalty = Math.min(15, delta * 1.5);
    penalties += penalty;
    reasons.push(`Tibial ${tibial.toFixed(1)}Â° (ì •ìƒ 0-10Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 9. Q-Angle - ì •ìƒ 10-20Â° (ë‚¨ì„± 10-15Â°, ì—¬ì„± 15-20Â°)
  const qAngle = fullMetrics.Q_Angle?.value;
  if(qAngle != null) {
    if(qAngle < 10) {
      const delta = 10 - qAngle;
      const penalty = Math.min(15, delta * 1.5);
      penalties += penalty;
      reasons.push(`Q-Angle ${qAngle.toFixed(1)}Â° (ì •ìƒ 10-20Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    } else if(qAngle > 20) {
      const delta = qAngle - 20;
      const penalty = Math.min(20, delta * 2);
      penalties += penalty;
      reasons.push(`Q-Angle ${qAngle.toFixed(1)}Â° (ì •ìƒ 10-20Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  // 10. Knee Deviation - ì •ìƒ 0-3Â°
  const kneeDev = fullMetrics.Knee_Deviation?.value;
  if(kneeDev != null && kneeDev > 3) {
    const delta = kneeDev - 3;
    const penalty = Math.min(15, delta * 3);
    penalties += penalty;
    reasons.push(`Knee Dev ${kneeDev.toFixed(1)}Â° (ì •ìƒ 0-3Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 11. LLD (Leg Length Discrepancy) - ì •ìƒ â‰¤1cm
  const lld = fullMetrics.LLD?.value;
  if(lld != null && lld > 1) {
    const delta = lld - 1;
    const penalty = Math.min(25, delta * 10);
    penalties += penalty;
    reasons.push(`LLD ${lld.toFixed(1)}cm (ì •ìƒ â‰¤1cm) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 12. GSB (Global Sagittal Balance) - ì •ìƒ â‰¤2cm
  const gsb = fullMetrics.GSB?.value;
  if(gsb != null && gsb > 2) {
    const delta = gsb - 2;
    const penalty = Math.min(20, delta * 5);
    penalties += penalty;
    reasons.push(`GSB ${gsb.toFixed(1)}cm (ì •ìƒ â‰¤2cm) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 13. BVA (Body Vertical Alignment) - ì •ìƒ â‰¤2cm
  const bva = fullMetrics.BVA?.value;
  if(bva != null && bva > 2) {
    const delta = bva - 2;
    const penalty = Math.min(20, delta * 5);
    penalties += penalty;
    reasons.push(`BVA ${bva.toFixed(1)}cm (ì •ìƒ â‰¤2cm) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 14. SCI (Spinal Curvature Index) - ì •ìƒ 0.15-0.35
  const sci = fullMetrics.SCI?.value;
  if(sci != null) {
    if(sci < 0.15) {
      const delta = 0.15 - sci;
      const penalty = Math.min(15, delta * 50);
      penalties += penalty;
      reasons.push(`SCI ${sci.toFixed(2)} (ì •ìƒ 0.15-0.35, ë§Œê³¡ ë¶€ì¡±) - ${penalty.toFixed(0)}ì  ê°ì `);
    } else if(sci > 0.35) {
      const delta = sci - 0.35;
      const penalty = Math.min(15, delta * 50);
      penalties += penalty;
      reasons.push(`SCI ${sci.toFixed(2)} (ì •ìƒ 0.15-0.35, ê³¼ë§Œê³¡) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  // 15. HPA (Headâ€“Pelvis Angle) - ì •ìƒ 0-10Â°
  const hpa = fullMetrics.HPA?.value;
  if(hpa != null && hpa > 10) {
    const delta = hpa - 10;
    const penalty = Math.min(15, delta * 1.5);
    penalties += penalty;
    reasons.push(`HPA ${hpa.toFixed(1)}Â° (ì •ìƒ 0-10Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // ì •ë©´ í•­ëª© (ì²­ë¡ìƒ‰ìœ¼ë¡œ í‘œì‹œë˜ëŠ” í•­ëª©ë“¤)
  
  // 16. STA (Shoulder Tilt Angle) - ì •ìƒ â‰¤3Â°
  const sta = fullMetrics.STA_F?.value || fullMetrics.STA?.value;
  if(sta != null && sta > 3) {
    const delta = sta - 3;
    const penalty = Math.min(15, delta * 3);
    penalties += penalty;
    reasons.push(`STA ${sta.toFixed(1)}Â° (ì •ìƒ â‰¤3Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 17. POA (Pelvic Obliquity Angle) - ì •ìƒ â‰¤3Â°
  const poa = fullMetrics.POA_F?.value || fullMetrics.POA?.value;
  if(poa != null && poa > 3) {
    const delta = poa - 3;
    const penalty = Math.min(15, delta * 3);
    penalties += penalty;
    reasons.push(`POA ${poa.toFixed(1)}Â° (ì •ìƒ â‰¤3Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 18. LLD_F (Leg Length Discrepancy) - ì •ìƒ â‰¤1cm (ì¸¡ë©´ LLDì™€ ì¤‘ë³µë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ê³„ì‚°)
  const lld_f = fullMetrics.LLD_F?.value;
  if(lld_f != null && lld_f > 1) {
    // ì¸¡ë©´ LLDê°€ ì´ë¯¸ ê³„ì‚°ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ ê³„ì‚°
    if(!fullMetrics.LLD || fullMetrics.LLD.value === lld_f) {
      const delta = lld_f - 1;
      const penalty = Math.min(25, delta * 10);
      penalties += penalty;
      reasons.push(`LLD_F ${lld_f.toFixed(1)}cm (ì •ìƒ â‰¤1cm) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  // 19. TD (Trunk Deviation) - ì •ìƒ Â±2Â°
  const td = fullMetrics.TD?.value;
  if(td != null && td > 2) {
    const delta = td - 2;
    const penalty = Math.min(15, delta * 3);
    penalties += penalty;
    reasons.push(`TD ${td.toFixed(1)}Â° (ì •ìƒ Â±2Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 20. HTA (Head Tilt Angle) - ì •ìƒ â‰¤3Â°
  const hta = fullMetrics.HTA?.value;
  if(hta != null && hta > 3) {
    const delta = hta - 3;
    const penalty = Math.min(15, delta * 3);
    penalties += penalty;
    reasons.push(`HTA ${hta.toFixed(1)}Â° (ì •ìƒ â‰¤3Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 21. SPP (Shoulderâ€“Pelvis Parallelism) - ì •ìƒ 0-3Â°
  const spp = fullMetrics.SPP?.value;
  if(spp != null && spp > 3) {
    const delta = spp - 3;
    const penalty = Math.min(15, delta * 3);
    penalties += penalty;
    reasons.push(`SPP ${spp.toFixed(1)}Â° (ì •ìƒ 0-3Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 22. KAS (Knee Alignment Symmetry) - ì •ìƒ Â±2Â°
  const kas = fullMetrics.KAS?.value;
  if(kas != null && kas > 2) {
    const delta = kas - 2;
    const penalty = Math.min(15, delta * 3);
    penalties += penalty;
    reasons.push(`KAS ${kas.toFixed(1)}Â° (ì •ìƒ Â±2Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 23. LLAS (Lower Limb Axis Symmetry) - ì •ìƒ Â±2Â°
  const llas = fullMetrics.LLAS?.value;
  if(llas != null && llas > 2) {
    const delta = llas - 2;
    const penalty = Math.min(15, delta * 3);
    penalties += penalty;
    reasons.push(`LLAS ${llas.toFixed(1)}Â° (ì •ìƒ Â±2Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
  }
  
  // 24. FBA (Foot Base Angle) - ì •ìƒ 0-10Â°
  const fba = fullMetrics.FBA?.value;
  if(fba != null) {
    if(fba > 10) {
      const delta = fba - 10;
      const penalty = Math.min(15, delta * 1.5);
      penalties += penalty;
      reasons.push(`FBA ${fba.toFixed(1)}Â° (ì •ìƒ 0-10Â°, ê³¼ë„í•œ ì™¸íšŒì „) - ${penalty.toFixed(0)}ì  ê°ì `);
    } else if(fba < 0) {
      const delta = Math.abs(fba);
      const penalty = Math.min(10, delta * 2);
      penalties += penalty;
      reasons.push(`FBA ${fba.toFixed(1)}Â° (ì •ìƒ 0-10Â°, íšŒë‚´ ê²½í–¥) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  // PDSëŠ” ë³„ë„ë¡œ ê³„ì‚°ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì œì™¸
  
  const score = Math.round(clamp(100 - penalties, 0, 100));
  return { score, reasons, penalties };
}

// ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ í•¨ìˆ˜ (í•˜ìœ„ í˜¸í™˜)
function computeScore(cva, pelvic, knee) {
  // fullMetricsê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
  const S = sessions[cur];
  const fullMetrics = S.metrics?.fullMetrics;
  if(fullMetrics && Object.keys(fullMetrics).length > 0) {
    return computeScoreFromFullMetrics(fullMetrics);
  }
  
  // ê¸°ì¡´ ë°©ì‹ (fallback)
  let penalties = 0;
  let reasons = [];
  
  if(cva != null) {
    const target = 50;
    const delta = Math.max(0, target - cva);
    const penalty = Math.min(40, delta * 1.6);
    penalties += penalty;
    if(penalty > 0) {
      reasons.push(`CVA ${cva.toFixed(1)}Â° (ëª©í‘œ ${target}Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  if(pelvic != null) {
    const abs = Math.abs(pelvic);
    const target = 0;
    const penalty = Math.min(30, abs * 2.0);
    penalties += penalty;
    if(penalty > 0) {
      reasons.push(`ê³¨ë°˜ ê¸°ìš¸ê¸° ${pelvic.toFixed(1)}Â° (ëª©í‘œ ${target}Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  if(knee != null) {
    const target = 180;
    const delta = Math.max(0, target - knee);
    const penalty = Math.min(30, delta * 1.0);
    penalties += penalty;
    if(penalty > 0) {
      reasons.push(`ë¬´ë¦ ê° ${knee.toFixed(1)}Â° (ëª©í‘œ ${target}Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  const score = Math.round(clamp(100 - penalties, 0, 100));
  return { score, reasons, penalties };
}

function analyzeMuscles(cva, pelvic, knee, fullMetrics = null) {
  const tight = [];
  const weak = [];
  const comments = [];
  const details = [];
  const exercises = [];
  
  // âš™ï¸ í•´ì„ ìš”ì•½ íŒ¨í„´ ë¶„ì„
  const patterns = [];
  
  // íŒ¨í„´ 1: ê±°ë¶ëª©(FHP): CVAâ†“, NIAâ†‘, HPDâ†‘
  if(fullMetrics) {
    const cvaVal = fullMetrics.CVA?.value_deg;
    const niaVal = fullMetrics.NIA?.value_deg;
    const hpdVal = fullMetrics.HPD?.value_cm;
    
    if(cvaVal != null && cvaVal < 50 && niaVal != null && niaVal > 20 && hpdVal != null && hpdVal > 2) {
      patterns.push({
        name: "ê±°ë¶ëª©(FHP)",
        description: `CVAâ†“(${cvaVal.toFixed(1)}Â°), NIAâ†‘(${niaVal.toFixed(1)}Â°), HPDâ†‘(${hpdVal.toFixed(1)}cm)`,
        meaning: "ê²½ì¶” ì‹ ì „, ì‹¬ë¶€ êµ´ê·¼ ì•½í™”",
        priority: "high"
      });
      tight.push('ìƒë¶€ìŠ¹ëª¨ê·¼', 'ê²¬ê°‘ê±°ê·¼', 'SCM', 'í‰ì‡„ìœ ëŒê·¼');
      weak.push('ì‹¬ë¶€ê²½ë¶€êµ´ê·¼', 'ì „ê±°ê·¼');
    }
    
    // íŒ¨í„´ 2: ë¼ìš´ë“œ ìˆ„ë”(RSP): acromion ì „ë°© ì´ë™, SAAâ†‘
    const saaVal = fullMetrics.SAA?.value_deg;
    if(saaVal != null && saaVal > 10) {
      patterns.push({
        name: "ë¼ìš´ë“œ ìˆ„ë”(RSP)",
        description: `SAAâ†‘(${saaVal.toFixed(1)}Â°)`,
        meaning: "í‰ê·¼ ë‹¨ì¶•, í•˜ë¶€ìŠ¹ëª¨ ì•½í™”",
        priority: "high"
      });
      tight.push('í‰ê·¼', 'ì†Œí‰ê·¼');
      weak.push('í•˜ë¶€ìŠ¹ëª¨', 'ì „ê±°ê·¼', 'ì¤‘ë¶€ìŠ¹ëª¨');
    }
    
    // íŒ¨í„´ 3: ê³¼ì „ê²½ì‚¬ ê³¨ë°˜: PTAâ†‘ (>15Â°), ASISâ†“(í•˜ê°•)
    const ptaVal = fullMetrics.PTA?.value_deg;
    if(ptaVal != null && ptaVal > 15) {
      patterns.push({
        name: "ê³¼ì „ê²½ì‚¬ ê³¨ë°˜(Anterior Tilt)",
        description: `PTAâ†‘(${ptaVal.toFixed(1)}Â°)`,
        meaning: "ìš”ì¶” ì „ë§Œ ì¦ê°€, hip flexor ë‹¨ì¶•",
        priority: "high"
      });
      tight.push('ì¥ìš”ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼', 'ëŒ€í‡´ì§ê·¼', 'í‰ìš”ê·¼ë§‰');
      weak.push('ë³µíš¡ê·¼', 'ë‘”ê·¼', 'ëŒ€ë‘”ê·¼', 'ì¤‘ë‘”ê·¼', 'í•˜ë‘”ê·¼');
    }
    
    // íŒ¨í„´ 4: í›„ê²½ì‚¬ ê³¨ë°˜: PTAâ†“ (<5Â°), PSISâ†“(í•˜ê°•)
    if(ptaVal != null && ptaVal < 5) {
      patterns.push({
        name: "í›„ê²½ì‚¬ ê³¨ë°˜(Posterior Tilt)",
        description: `PTAâ†“(${ptaVal.toFixed(1)}Â°)`,
        meaning: "í–„ìŠ¤íŠ¸ë§/ë³µê·¼ ë‹¨ì¶•",
        priority: "medium"
      });
      tight.push('í–„ìŠ¤íŠ¸ë§', 'ë³µì§ê·¼', 'ë³µíš¡ê·¼');
      weak.push('ì¥ìš”ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼');
    }
    
    // íŒ¨í„´ 5: Xì ë‹¤ë¦¬(Valgus): KAâ†“ (<175Â°), Q-angleâ†‘
    const kaVal = fullMetrics.KA?.value_deg;
    const qAngleVal = fullMetrics.Q_Angle?.value_deg;
    if(kaVal != null && kaVal < 175) {
      patterns.push({
        name: "Xì ë‹¤ë¦¬(Valgus)",
        description: `KAâ†“(${kaVal.toFixed(1)}Â°)${qAngleVal != null ? `, Q-angleâ†‘(${qAngleVal.toFixed(1)}Â°)` : ''}`,
        meaning: "ë‚´ì¸¡ ë¬´ë¦ ë¶€í•˜ ì¦ê°€",
        priority: "high"
      });
      tight.push('ëŒ€í‡´ë‚´ì „ê·¼', 'ë¹„ë³µê·¼');
      weak.push('ëŒ€ë‘”ê·¼', 'ì¤‘ë‘”ê·¼', 'ëŒ€í‡´ì™¸ì „ê·¼');
    }
    
    // íŒ¨í„´ 6: Oì ë‹¤ë¦¬(Varus): KAâ†‘ (>180Â°)
    if(kaVal != null && kaVal > 180) {
      patterns.push({
        name: "Oì ë‹¤ë¦¬(Varus)",
        description: `KAâ†‘(${kaVal.toFixed(1)}Â°)`,
        meaning: "ì™¸ì¸¡ ë¬´ë¦ ë¶€í•˜ ì¦ê°€",
        priority: "high"
      });
      tight.push('ëŒ€í‡´ì™¸ì „ê·¼', 'ë¹„ë³µê·¼');
      weak.push('ëŒ€ë‘”ê·¼', 'ì¤‘ë‘”ê·¼', 'ëŒ€í‡´ë‚´ì „ê·¼');
    }
    
    // íŒ¨í„´ 7: ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© ì´ë™: BVAâ†‘, GSBâ†‘
    const bvaVal = fullMetrics.BVA?.value_deg;
    const gsbVal = fullMetrics.GSB?.value_cm;
    if(bvaVal != null && bvaVal > 2 && gsbVal != null && gsbVal > 2) {
      patterns.push({
        name: "ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© ì´ë™",
        description: `BVAâ†‘(${bvaVal.toFixed(1)}Â°), GSBâ†‘(${gsbVal.toFixed(1)}cm)`,
        meaning: "ìš”ì¶” ì „ë§Œ, ì¢…ê³¨ ìŠ¤íŠ¸ë ˆìŠ¤",
        priority: "medium"
      });
      tight.push('ì¥ìš”ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼');
      weak.push('ë³µíš¡ê·¼', 'ë‘”ê·¼');
    }
    
    // íŒ¨í„´ 8: ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°© ì´ë™: BVAâ†“, GSBâ†“
    if(bvaVal != null && bvaVal < -2 || (gsbVal != null && gsbVal < -2)) {
      patterns.push({
        name: "ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°© ì´ë™",
        description: `BVAâ†“(${bvaVal.toFixed(1)}Â°), GSBâ†“(${gsbVal.toFixed(1)}cm)`,
        meaning: "ë‘”ê·¼ ê¸´ì¥, í–„ìŠ¤íŠ¸ë§ ë‹¨ì¶•",
        priority: "medium"
      });
      tight.push('ë‘”ê·¼', 'í–„ìŠ¤íŠ¸ë§');
      weak.push('ëŒ€í‡´ì‚¬ë‘ê·¼', 'ì¥ìš”ê·¼');
    }
    
    // íŒ¨í„´ ì •ë³´ë¥¼ commentsì— ì¶”ê°€
    if(patterns.length > 0) {
      comments.push(`\nğŸ“Š ìì„¸ íŒ¨í„´ ë¶„ì„:`);
      patterns.forEach((p, idx) => {
        comments.push(`${idx + 1}. ${p.name}: ${p.description} â†’ ${p.meaning}`);
      });
    }
  }
  
  // CVA ë¶„ì„ (ìƒì„¸)
  // CVA >= 50ë„ëŠ” ì •ìƒ ë²”ìœ„
  if(cva != null) {
    if(cva >= 50) {
      // 50ë„ ì´ìƒì´ë©´ ì •ìƒ ë²”ìœ„
      if(cva <= 55) {
        comments.push(`ê²½ì¶” ì •ë ¬ ì–‘í˜¸: CVA ${cva.toFixed(1)}Â° (ì •ìƒ ë²”ìœ„)`);
        details.push(`â€¢ ê²½ì¶” ì •ë ¬ì´ ì–‘í˜¸í•œ ìƒíƒœì…ë‹ˆë‹¤.`);
        details.push(`â€¢ í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•œ ì •ê¸°ì ì¸ ìŠ¤íŠ¸ë ˆì¹­ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`);
      } else {
        // 55ë„ ì´ˆê³¼ëŠ” í›„ë°© ê²½ì‚¬ (ê³¼ë„í•œ ê²½ìš°)
        comments.push(`ê²½ì¶” í›„ë°© ê²½ì‚¬: CVA ${cva.toFixed(1)}Â°ë¡œ ì •ìƒ ë²”ìœ„ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
        details.push(`â€¢ ê²½ì¶”ê°€ ê³¼ë„í•˜ê²Œ í›„ë°©ìœ¼ë¡œ ê¸°ìš¸ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.`);
        exercises.push('1. ê²½ì¶” ì „ë°© êµ´ê³¡ ìš´ë™: ì²œì²œíˆ í„±ì„ ê°€ìŠ´ ë°©í–¥ìœ¼ë¡œ ë‚´ë¦¬ê¸° (10íšŒÃ—2ì„¸íŠ¸)');
      }
    } else {
      // 50ë„ ë¯¸ë§Œì€ ì „ë°©ë‘ ìì„¸
      if(cva < 45) {
        tight.push('ìƒë¶€ìŠ¹ëª¨ê·¼', 'ê²¬ê°‘ê±°ê·¼', 'SCM', 'í‰ì‡„ìœ ëŒê·¼');
        weak.push('ì‹¬ë¶€ê²½ë¶€êµ´ê·¼', 'í•˜ë¶€ìŠ¹ëª¨ê·¼', 'ì „ê±°ê·¼');
        comments.push(`ì „ë°©ë‘ ìì„¸ ì‹¬ê°: CVA ${cva.toFixed(1)}Â°ë¡œ ì •ìƒ ë²”ìœ„(â‰¥50Â°)ë³´ë‹¤ ${(50-cva).toFixed(1)}Â° ë‚®ìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ìƒë¶€ìŠ¹ëª¨ê·¼ê³¼ ê²¬ê°‘ê±°ê·¼ì´ ì§€ì†ì ìœ¼ë¡œ ìˆ˜ì¶•ë˜ì–´ ëª©ê³¼ ì–´ê¹¨ í†µì¦ì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ì‹¬ë¶€ê²½ë¶€êµ´ê·¼ì´ ì•½í™”ë˜ì–´ ë¨¸ë¦¬ ë¬´ê²Œë¥¼ ì§€ì§€í•˜ì§€ ëª»í•´ ì „ë°© ì´ë™ì´ ê°€ì†í™”ë©ë‹ˆë‹¤.`);
        details.push(`â€¢ ì¥ê¸°ì ìœ¼ë¡œ ê²½ì¶” ë””ìŠ¤í¬ ì••ë ¥ ì¦ê°€ ë° ë‘í†µ, ì–´ê¹¨ ë»£ë»£í•¨ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        exercises.push('1. í„± ë‹¹ê¸°ê¸° ìš´ë™: ë²½ì— ë“±ì„ ëŒ€ê³  í„±ì„ ë’¤ë¡œ ë‹¹ê¸°ë©° 10ì´ˆ ìœ ì§€ (3ì„¸íŠ¸)');
        exercises.push('2. ì‹¬ë¶€ê²½ë¶€êµ´ê·¼ í™œì„±í™”: ëˆ„ì›Œì„œ í„±ì„ ê°€ìŠ´ì— ê°€ê¹ê²Œ ë‹¹ê¸°ë©° ë¨¸ë¦¬ë§Œ ì‚´ì§ ë“¤ì–´ì˜¬ë¦¬ê¸° (10íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('3. í•˜ë¶€ìŠ¹ëª¨ê·¼ ê°•í™”: íŒ”ì„ 30ë„ ê°ë„ë¡œ ì˜¬ë¦¬ë©° ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìœ¼ê¸° (15íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('4. ìƒë¶€ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ë¨¸ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ê¸°ìš¸ì—¬ ë°˜ëŒ€í¸ ì–´ê¹¨ ë°©í–¥ìœ¼ë¡œ ìŠ¤íŠ¸ë ˆì¹­ (ì¢Œìš° ê° 30ì´ˆ)');
      } else {
        tight.push('ìƒë¶€ìŠ¹ëª¨ê·¼', 'ê²¬ê°‘ê±°ê·¼');
        weak.push('ì‹¬ë¶€ê²½ë¶€êµ´ê·¼');
        comments.push(`ì „ë°©ë‘ ìì„¸ ê²½ë¯¸: CVA ${cva.toFixed(1)}Â°ë¡œ ì •ìƒ ë²”ìœ„(â‰¥50Â°)ì— ê·¼ì ‘í•©ë‹ˆë‹¤.`);
        details.push(`â€¢ ìƒë¶€ìŠ¹ëª¨ê·¼ê³¼ ê²¬ê°‘ê±°ê·¼ì— ì•½ê°„ì˜ ê¸´ì¥ì´ ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ì‹¬ë¶€ê²½ë¶€êµ´ê·¼ í™œì„±í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
        exercises.push('1. í„± ë‹¹ê¸°ê¸° ìš´ë™: ë²½ì— ë“±ì„ ëŒ€ê³  í„±ì„ ë’¤ë¡œ ë‹¹ê¸°ê¸° (10ì´ˆÃ—3ì„¸íŠ¸)');
        exercises.push('2. ì‹¬ë¶€ê²½ë¶€êµ´ê·¼ ê°•í™”: ëˆ„ì›Œì„œ ë¨¸ë¦¬ë§Œ ì‚´ì§ ë“¤ì–´ì˜¬ë¦¬ê¸° (10íšŒÃ—2ì„¸íŠ¸)');
        exercises.push('3. ìƒë¶€ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ì¢Œìš° ê° 30ì´ˆì”© ìŠ¤íŠ¸ë ˆì¹­');
      }
    }
  }
  
  // ê³¨ë°˜ ê¸°ìš¸ê¸° ë¶„ì„ (ìƒì„¸)
  if(pelvic != null) {
    const abs = Math.abs(pelvic);
    if(abs > 5) {
      if(pelvic > 0) {
        tight.push('ì¥ìš”ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼', 'ëŒ€í‡´ì§ê·¼', 'í‰ìš”ê·¼ë§‰');
        weak.push('ë³µíš¡ê·¼', 'ë‘”ê·¼', 'ëŒ€ë‘”ê·¼', 'ì¤‘ë‘”ê·¼', 'í•˜ë‘”ê·¼');
        comments.push(`ê³¨ë°˜ ì „ë°©ê²½ì‚¬ ì‹¬ê°: ${pelvic.toFixed(1)}Â°ë¡œ ëª©í‘œ 0Â°ë³´ë‹¤ ${pelvic.toFixed(1)}Â° í½ë‹ˆë‹¤.`);
        details.push(`â€¢ ì¥ìš”ê·¼ì´ ë‹¨ì¶•ë˜ì–´ ê³¨ë°˜ì„ ì•ìœ¼ë¡œ ë‹¹ê¸°ê³  ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ìš”ì¶” ì „ë§Œì´ ì¦ê°€í•˜ì—¬ í—ˆë¦¬ í†µì¦ ìœ„í—˜ì´ ë†’ìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ë³µíš¡ê·¼ê³¼ ë‘”ê·¼ì´ ì•½í™”ë˜ì–´ ê³¨ë°˜ ì•ˆì •ì„±ì´ ë–¨ì–´ì§‘ë‹ˆë‹¤.`);
        exercises.push('1. ì¥ìš”ê·¼ ìŠ¤íŠ¸ë ˆì¹­: í•œìª½ ë¬´ë¦ì„ ì•ìœ¼ë¡œ ë‚´ë°€ê³  ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¥¼ ë’¤ë¡œ ë»—ì–´ ìŠ¤íŠ¸ë ˆì¹­ (ì¢Œìš° ê° 30ì´ˆÃ—3íšŒ)');
        exercises.push('2. ë‘”ê·¼ ê°•í™”: ëˆ„ì›Œì„œ ì—‰ë©ì´ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©° ë‘”ê·¼ ìˆ˜ì¶• (15íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('3. ë³µíš¡ê·¼ í™œì„±í™”: ë„¤ ë°œë¡œ ì—ë“œë ¤ì„œ ë³µë¶€ë¥¼ ì•ˆìœ¼ë¡œ ë‹¹ê¸°ë©° í˜¸í¡ (10íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('4. í™ ë¸Œë¦¿ì§€: ëˆ„ì›Œì„œ ë¬´ë¦ì„ êµ¬ë¶€ë¦¬ê³  ì—‰ë©ì´ë¥¼ ë“¤ì–´ì˜¬ë¦¬ê¸° (15íšŒÃ—3ì„¸íŠ¸)');
      } else {
        tight.push('ë‘”ê·¼', 'í–„ìŠ¤íŠ¸ë§', 'ìš”ì¶”ì‹ ê·¼');
        weak.push('ë³µì§ê·¼', 'ì¥ìš”ê·¼', 'ëŒ€í‡´ì‚¬ë‘ê·¼');
        comments.push(`ê³¨ë°˜ í›„ë°©ê²½ì‚¬: ${pelvic.toFixed(1)}Â°ë¡œ ëª©í‘œ 0Â°ë³´ë‹¤ ì‘ìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ë‘”ê·¼ê³¼ í–„ìŠ¤íŠ¸ë§ì´ ê³¼ë„í•˜ê²Œ ê¸´ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ë³µì§ê·¼ê³¼ ì¥ìš”ê·¼ì´ ì•½í™”ë˜ì–´ ê³¨ë°˜ì´ ë’¤ë¡œ ê¸°ìš¸ì–´ì§‘ë‹ˆë‹¤.`);
        exercises.push('1. ë‘”ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ì•‰ì•„ì„œ í•œìª½ ë¬´ë¦ì„ ê°€ìŠ´ì— ë‹¹ê¸°ê¸° (ì¢Œìš° ê° 30ì´ˆ)');
        exercises.push('2. í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­: ë‹¤ë¦¬ë¥¼ ë»—ê³  ì•ìœ¼ë¡œ ìˆ™ì´ê¸° (30ì´ˆÃ—3íšŒ)');
        exercises.push('3. ë³µì§ê·¼ ê°•í™”: í¬ëŸ°ì¹˜ ìš´ë™ (15íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('4. ì¥ìš”ê·¼ ê°•í™”: ë¬´ë¦ ë‹¹ê¸°ê¸° ìš´ë™ (10íšŒÃ—3ì„¸íŠ¸)');
      }
    } else {
      comments.push(`ê³¨ë°˜ ì •ë ¬ ì–‘í˜¸: ${pelvic.toFixed(1)}Â°`);
      details.push(`â€¢ ê³¨ë°˜ ì •ë ¬ì´ ì–‘í˜¸í•œ ìƒíƒœì…ë‹ˆë‹¤.`);
    }
  }
  
  // ë¬´ë¦ ê°ë„ ë¶„ì„ (ìƒì„¸)
  if(knee != null) {
    if(knee < 175) {
      if(knee < 165) {
        tight.push('í–„ìŠ¤íŠ¸ë§', 'ë¹„ë³µê·¼', 'ê°€ìë¯¸ê·¼', 'ìŠ¬ì™€ê·¼');
        weak.push('ëŒ€í‡´ì‚¬ë‘ê·¼', 'ë‘”ê·¼', 'ëŒ€í‡´ì§ê·¼');
        comments.push(`ë¬´ë¦ ê³¼êµ´ê³¡ ì‹¬ê°: ${knee.toFixed(1)}Â°ë¡œ ëª©í‘œ 180Â°ë³´ë‹¤ ${(180-knee).toFixed(1)}Â° ë‚®ìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ í–„ìŠ¤íŠ¸ë§ê³¼ ë¹„ë³µê·¼ì´ ì‹¬ê°í•˜ê²Œ ë‹¨ì¶•ë˜ì–´ ë¬´ë¦ì„ êµ¬ë¶€ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ëŒ€í‡´ì‚¬ë‘ê·¼ì´ ì•½í™”ë˜ì–´ ë¬´ë¦ì„ í´ì§€ ëª»í•©ë‹ˆë‹¤.`);
        details.push(`â€¢ ì¥ê¸°ì ìœ¼ë¡œ ë¬´ë¦ ê´€ì ˆ ì••ë ¥ ì¦ê°€ ë° ì „ë°© ì‹­ìì¸ëŒ€ ë¶€ìƒ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.`);
        exercises.push('1. í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­: ì„œì„œ ë‹¤ë¦¬ë¥¼ ì˜¬ë¦¬ê³  ì•ìœ¼ë¡œ ìˆ™ì´ê¸° (ì¢Œìš° ê° 30ì´ˆÃ—3íšŒ)');
        exercises.push('2. ë¹„ë³µê·¼ ìŠ¤íŠ¸ë ˆì¹­: ë²½ì— ì†ì„ ëŒ€ê³  í•œìª½ ë‹¤ë¦¬ë¥¼ ë’¤ë¡œ ë‚´ë°€ë©° ìŠ¤íŠ¸ë ˆì¹­ (ì¢Œìš° ê° 30ì´ˆ)');
        exercises.push('3. ëŒ€í‡´ì‚¬ë‘ê·¼ ê°•í™”: ì˜ìì— ì•‰ì•„ ë‹¤ë¦¬ë¥¼ í´ë©° ë¬´ë¦ ë½ (10ì´ˆ ìœ ì§€Ã—10íšŒ)');
        exercises.push('4. ìŠ¤ì¿¼íŠ¸: ì²œì²œíˆ ì•‰ì•˜ë‹¤ ì¼ì–´ì„œê¸° (10íšŒÃ—3ì„¸íŠ¸)');
      } else {
        tight.push('í–„ìŠ¤íŠ¸ë§', 'ë¹„ë³µê·¼');
        weak.push('ëŒ€í‡´ì‚¬ë‘ê·¼');
        comments.push(`ë¬´ë¦ ì•½ê°„ êµ´ê³¡: ${knee.toFixed(1)}Â°ë¡œ ëª©í‘œì— ê·¼ì ‘í•©ë‹ˆë‹¤.`);
        details.push(`â€¢ í–„ìŠ¤íŠ¸ë§ê³¼ ë¹„ë³µê·¼ì— ì•½ê°„ì˜ ê¸´ì¥ì´ ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ëŒ€í‡´ì‚¬ë‘ê·¼ ê°•í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
        exercises.push('1. í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­: ì¢Œìš° ê° 30ì´ˆì”© ìŠ¤íŠ¸ë ˆì¹­');
        exercises.push('2. ëŒ€í‡´ì‚¬ë‘ê·¼ ê°•í™”: ì˜ìì— ì•‰ì•„ ë‹¤ë¦¬ í´ê¸° (10íšŒÃ—2ì„¸íŠ¸)');
        exercises.push('3. ìŠ¤ì¿¼íŠ¸: 10íšŒÃ—2ì„¸íŠ¸');
      }
    } else if(knee <= 185) {
      comments.push(`ë¬´ë¦ ì •ë ¬ ì–‘í˜¸: ${knee.toFixed(1)}Â°`);
      details.push(`â€¢ ë¬´ë¦ ì •ë ¬ì´ ì–‘í˜¸í•œ ìƒíƒœì…ë‹ˆë‹¤.`);
    } else {
      comments.push(`ë¬´ë¦ ê³¼ì‹ ì „: ${knee.toFixed(1)}Â°ë¡œ ëª©í‘œë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
      details.push(`â€¢ ë¬´ë¦ì´ ê³¼ë„í•˜ê²Œ í´ì ¸ ìˆì–´ í›„ë°© ì‹­ìì¸ëŒ€ ë¶€ìƒ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.`);
      exercises.push('1. ë¬´ë¦ ë¯¸ì„¸ êµ´ê³¡ ì—°ìŠµ: ì„œì„œ ë¬´ë¦ì„ ì‚´ì§ êµ¬ë¶€ë¦¬ê¸° (10íšŒÃ—2ì„¸íŠ¸)');
      exercises.push('2. ëŒ€í‡´ì‚¬ë‘ê·¼ ì´ì™„: ëˆ„ì›Œì„œ ë¬´ë¦ ì•„ë˜ì— ë² ê°œë¥¼ ë„£ê³  ìŠ¤íŠ¸ë ˆì¹­');
    }
  }
  
  // ì¢…í•© ìš´ë™ ì¶”ì²œ
  if(exercises.length === 0 && (tight.length > 0 || weak.length > 0)) {
    exercises.push('1. ì „ì‹  ìŠ¤íŠ¸ë ˆì¹­: ë§¤ì¼ ì•„ì¹¨ 10ë¶„ê°„ ì „ì‹  ìŠ¤íŠ¸ë ˆì¹­');
    exercises.push('2. ì½”ì–´ ê°•í™”: í”Œë­í¬ 30ì´ˆ ìœ ì§€ (3ì„¸íŠ¸)');
    exercises.push('3. ìì„¸ êµì • ìš´ë™: ë²½ì— ë“±ì„ ëŒ€ê³  ì„œì„œ ëª¸ ì •ë ¬ ìœ ì§€ (1ë¶„Ã—3íšŒ)');
  }
  
  // í•„ë¼í…ŒìŠ¤ ì¶”ì²œ (íŒ¨í„´ ê¸°ë°˜)
  const pilates = [];
  
  if(fullMetrics) {
    // íŒ¨í„´ ê¸°ë°˜ í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ìƒì„±
    // 1. ê±°ë¶ëª©(FHP)
    const cvaVal = fullMetrics.CVA?.value_deg;
    const niaVal = fullMetrics.NIA?.value_deg;
    const hpdVal = fullMetrics.HPD?.value_cm;
    if(cvaVal != null && cvaVal < 50 && niaVal != null && niaVal > 20 && hpdVal != null && hpdVal > 2) {
      if(pilatesPatterns.FHP) {
        pilates.push({
          pattern: 'FHP',
          name: pilatesPatterns.FHP.name,
          condition: pilatesPatterns.FHP.condition,
          interpretation: pilatesPatterns.FHP.interpretation,
          tight: pilatesPatterns.FHP.tight,
          weak: pilatesPatterns.FHP.weak,
          exercises: pilatesPatterns.FHP.exercises
        });
      }
    }
    
    // 2. ë¼ìš´ë“œ ìˆ„ë”(RSP)
    const saaVal = fullMetrics.SAA?.value_deg;
    if(saaVal != null && saaVal > 10) {
      if(pilatesPatterns.RSP) {
        pilates.push({
          pattern: 'RSP',
          name: pilatesPatterns.RSP.name,
          condition: pilatesPatterns.RSP.condition,
          interpretation: pilatesPatterns.RSP.interpretation,
          tight: pilatesPatterns.RSP.tight,
          weak: pilatesPatterns.RSP.weak,
          exercises: pilatesPatterns.RSP.exercises
        });
      }
    }
    
    // 3. ê³¼ì „ê²½ì‚¬ ê³¨ë°˜
    const ptaVal = fullMetrics.PTA?.value_deg;
    if(ptaVal != null && ptaVal > 15) {
      if(pilatesPatterns.AnteriorTilt) {
        pilates.push({
          pattern: 'AnteriorTilt',
          name: pilatesPatterns.AnteriorTilt.name,
          condition: pilatesPatterns.AnteriorTilt.condition,
          interpretation: pilatesPatterns.AnteriorTilt.interpretation,
          tight: pilatesPatterns.AnteriorTilt.tight,
          weak: pilatesPatterns.AnteriorTilt.weak,
          exercises: pilatesPatterns.AnteriorTilt.exercises
        });
      }
    }
    
    // 4. í›„ê²½ì‚¬ ê³¨ë°˜
    if(ptaVal != null && ptaVal < 5) {
      if(pilatesPatterns.PosteriorTilt) {
        pilates.push({
          pattern: 'PosteriorTilt',
          name: pilatesPatterns.PosteriorTilt.name,
          condition: pilatesPatterns.PosteriorTilt.condition,
          interpretation: pilatesPatterns.PosteriorTilt.interpretation,
          tight: pilatesPatterns.PosteriorTilt.tight,
          weak: pilatesPatterns.PosteriorTilt.weak,
          exercises: pilatesPatterns.PosteriorTilt.exercises
        });
      }
    }
    
    // 5. Xì ë‹¤ë¦¬
    const kaVal = fullMetrics.KA?.value_deg;
    const qAngleVal = fullMetrics.Q_Angle?.value_deg;
    if(kaVal != null && kaVal < 175) {
      if(pilatesPatterns.GenuValgum) {
        pilates.push({
          pattern: 'GenuValgum',
          name: pilatesPatterns.GenuValgum.name,
          condition: pilatesPatterns.GenuValgum.condition,
          interpretation: pilatesPatterns.GenuValgum.interpretation,
          tight: pilatesPatterns.GenuValgum.tight,
          weak: pilatesPatterns.GenuValgum.weak,
          exercises: pilatesPatterns.GenuValgum.exercises
        });
      }
    }
    
    // 6. Oì ë‹¤ë¦¬
    if(kaVal != null && kaVal > 180) {
      if(pilatesPatterns.GenuVarum) {
        pilates.push({
          pattern: 'GenuVarum',
          name: pilatesPatterns.GenuVarum.name,
          condition: pilatesPatterns.GenuVarum.condition,
          interpretation: pilatesPatterns.GenuVarum.interpretation,
          tight: pilatesPatterns.GenuVarum.tight,
          weak: pilatesPatterns.GenuVarum.weak,
          exercises: pilatesPatterns.GenuVarum.exercises
        });
      }
    }
    
    // 7. ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°©
    const bvaVal = fullMetrics.BVA?.value_deg;
    const gsbVal = fullMetrics.GSB?.value_cm;
    if(bvaVal != null && bvaVal > 2 && gsbVal != null && gsbVal > 2) {
      if(pilatesPatterns.ForwardCenter) {
        pilates.push({
          pattern: 'ForwardCenter',
          name: pilatesPatterns.ForwardCenter.name,
          condition: pilatesPatterns.ForwardCenter.condition,
          interpretation: pilatesPatterns.ForwardCenter.interpretation,
          tight: pilatesPatterns.ForwardCenter.tight,
          weak: pilatesPatterns.ForwardCenter.weak,
          exercises: pilatesPatterns.ForwardCenter.exercises
        });
      }
    }
    
    // 8. ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°©
    if(bvaVal != null && bvaVal < -2 || (gsbVal != null && gsbVal < -2)) {
      if(pilatesPatterns.BackwardCenter) {
        pilates.push({
          pattern: 'BackwardCenter',
          name: pilatesPatterns.BackwardCenter.name,
          condition: pilatesPatterns.BackwardCenter.condition,
          interpretation: pilatesPatterns.BackwardCenter.interpretation,
          tight: pilatesPatterns.BackwardCenter.tight,
          weak: pilatesPatterns.BackwardCenter.weak,
          exercises: pilatesPatterns.BackwardCenter.exercises
        });
      }
    }
  }
  
  // íŒ¨í„´ ê¸°ë°˜ ì¶”ì²œì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
  if(pilates.length === 0) {
    const oldPilates = recommendPilates([...new Set(tight)], [...new Set(weak)]);
    pilates.push(...oldPilates);
  }
  
  return { 
    tight: [...new Set(tight)], 
    weak: [...new Set(weak)], 
    comments,
    details,
    exercises: [...new Set(exercises)],
    pilates
  };
}

// ì²´í˜• ìœ í˜• ë¶„ì„ í•¨ìˆ˜
function analyzePostureType(metrics) {
  if(!metrics || Object.keys(metrics).length === 0) {
    return "ë¶„ì„ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
  }
  
  let analysis = [];
  let summarySection = '';
  let detailSections = [];
  let recommendations = [];
  
  // ì¸¡ì •ê°’ ì¶”ì¶œ
  const cva = metrics.CVA?.value;
  const hpd = metrics.HPD?.value;
  const nia = metrics.NIA?.value;
  const pta = metrics.PTA?.value;
  const tia = metrics.TIA?.value;
  const ka = metrics.KA?.value;
  const lld = metrics.LLD?.value;
  const bva = metrics.BVA?.value;
  const gsb = metrics.GSB?.value;
  const sci = metrics.SCI?.value;
  const hpa = metrics.HPA?.value;
  const qAngle = metrics['Q_Angle']?.value;
  const kneeDev = metrics['Knee_Deviation']?.value;
  const pds = metrics.PDS?.value;
  const pdsStatus = metrics.PDS?.status;
  
  // ë¬¸ì œ ì¹´ìš´íŠ¸
  let issueCount = 0;
  
  // === 1. ê±°ë¶ëª© ìì„¸ (Forward Head Posture) ===
  if(cva != null && cva < 50) {
    issueCount++;
    const severity = cva < 40 ? 'ì‹¬ê°' : cva < 45 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
    detailSections.push(`
      <div style="border-left:3px solid #ff6b6b; padding-left:12px; margin-bottom:16px;">
        <strong style="color:#ff6b6b; font-size:13px;">ğŸ“ ê±°ë¶ëª© ìì„¸ (Forward Head Posture) - ${severity}</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
          <strong>í˜„ì¬ ìƒíƒœ:</strong> CVA ${cva.toFixed(1)}Â° (ì •ìƒ: â‰¥50Â°), HPD ${hpd != null ? hpd.toFixed(1) + 'cm' : 'ë¯¸ì¸¡ì •'}<br>
          <strong>ì£¼ìš” ì›ì¸:</strong> ì¥ì‹œê°„ ìŠ¤ë§ˆíŠ¸í°Â·ì»´í“¨í„° ì‚¬ìš©, ì˜ëª»ëœ ë² ê°œ ë†’ì´, ê¹Šì€ ê·¼ìœ¡(Deep neck flexor) ì•½í™”<br>
          <strong>ë°œìƒ ì¦ìƒ:</strong> 
          â€¢ ëª©ë’¤ í†µì¦ ë° ê²½ì§ (Upper trapezius, Levator scapulae ê¸´ì¥)
          â€¢ ë‘í†µ (Tension headache), ì–´ì§€ëŸ¼ì¦
          â€¢ ì–´ê¹¨ ê²°ë¦¼ ë° ë‚ ê°œë¼ˆ í†µì¦
          â€¢ í„±ê´€ì ˆ ì¥ì• (TMJ disorder) ìœ ë°œ ê°€ëŠ¥<br>
          <strong>ê·¼ìœ¡ ë¶ˆê· í˜•:</strong>
          â€¢ ê¸´ì¥ëœ ê·¼ìœ¡: ìƒë¶€ ìŠ¹ëª¨ê·¼, ê²¬ê°‘ê±°ê·¼, í‰ì‡„ìœ ëŒê·¼, í›„ë‘í•˜ê·¼
          â€¢ ì•½í™”ëœ ê·¼ìœ¡: ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼(Longus colli, capitis), í•˜ë¶€ ìŠ¹ëª¨ê·¼<br>
          <strong>êµì • ë°©í–¥:</strong>
          â‘  í„±ë‹¹ê¹€ ìš´ë™(Chin tuck): ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼ ê°•í™”
          â‘¡ í‰ì¶” ì‹ ì „ ìš´ë™: ë“± ìœ—ë¶€ë¶„ ìœ ì—°ì„± í™•ë³´
          â‘¢ ê²¬ê°‘ê³¨ í›„ì¸ ìš´ë™: ì–´ê¹¨ë¥¼ ë’¤ë¡œ ë‹¹ê¸°ëŠ” ê·¼ìœ¡ ê°•í™”
          â‘£ ì‘ì—… í™˜ê²½ ê°œì„ : ëª¨ë‹ˆí„° ëˆˆë†’ì´ ì¡°ì •, ìŠ¤ë§ˆíŠ¸í° ì‚¬ìš© ìì„¸ ê°œì„ <br>
          <strong>ì£¼ì˜ì‚¬í•­:</strong> ê¸‰ê²©í•œ êµì • ì‹œë„ëŠ” ê²½ì¶” ë””ìŠ¤í¬ì— ë¬´ë¦¬ë¥¼ ì¤„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì ì§„ì ìœ¼ë¡œ ì ‘ê·¼í•´ì•¼ í•©ë‹ˆë‹¤.
        </div>
      </div>
    `);
  }
  
  // === 2. ê³¨ë°˜ ê²½ì‚¬ ë¬¸ì œ ===
  if(pta != null && (pta > 15 || pta < 0)) {
    issueCount++;
    if(pta > 15) {
      const severity = pta > 25 ? 'ì‹¬ê°' : pta > 20 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      detailSections.push(`
        <div style="border-left:3px solid #ffb86c; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#ffb86c; font-size:13px;">ğŸ“ ê³¨ë°˜ ì „ë°© ê²½ì‚¬ (Anterior Pelvic Tilt) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> PTA ${pta.toFixed(1)}Â° (ì •ìƒ: 0-15Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> ì¥ì‹œê°„ ì•‰ì•„ìˆëŠ” ìƒí™œ, í•˜ì´í ì°©ìš©, ë³µë¶€ ê·¼ë ¥ ì•½í™”, ì„ì‹  í›„ íšŒë³µ ë¶€ì¡±<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong>
            â€¢ ìš”ì¶” ê³¼ì „ë§Œ(Hyperlordosis)ìœ¼ë¡œ ì¸í•œ ë§Œì„± ìš”í†µ
            â€¢ í•˜ë³µë¶€ ëŒì¶œ (pseudo-pregnancy appearance)
            â€¢ ì—‰ë©ì´ê°€ ë’¤ë¡œ íŠ€ì–´ë‚˜ì˜¨ ìì„¸
            â€¢ ê³ ê´€ì ˆ êµ´ê³¡ê·¼(Hip flexor) ë‹¨ì¶•ìœ¼ë¡œ ì¸í•œ ë³´í–‰ ì¥ì• <br>
            <strong>ê·¼ìœ¡ ë¶ˆê· í˜•:</strong>
            â€¢ ê¸´ì¥Â·ë‹¨ì¶•ëœ ê·¼ìœ¡: ì¥ìš”ê·¼(Iliopsoas), ëŒ€í‡´ì§ê·¼(Rectus femoris), ì²™ì¶”ê¸°ë¦½ê·¼(Erector spinae)
            â€¢ ì•½í™”Â·ì‹ ì¥ëœ ê·¼ìœ¡: ë³µì§ê·¼(Rectus abdominis), ëŒ€ë‘”ê·¼(Gluteus maximus), í–„ìŠ¤íŠ¸ë§<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ëŸ°ì§€ ìì„¸ì—ì„œ ì¥ìš”ê·¼ ëŠ˜ë¦¬ê¸°
            â‘¡ ì½”ì–´ ê°•í™”: í”Œë­í¬, ë°ë“œë²„ê·¸(Dead bug) ìš´ë™
            â‘¢ ëŒ€ë‘”ê·¼ í™œì„±í™”: ë¸Œë¦¿ì§€, í™ ì“°ëŸ¬ìŠ¤íŠ¸, í´ë¨ì‰˜
            â‘£ ê³¨ë°˜ í›„ë°© ê²½ì‚¬ ì—°ìŠµ: ë²½ì— ë“±ëŒ€ê³  ê³¨ë°˜ ì¤‘ë¦½ ìì„¸ í•™ìŠµ<br>
            <strong>ë³µí•© ì¦í›„êµ°:</strong> Lower Cross Syndrome(í•˜ë¶€ êµì°¨ ì¦í›„êµ°)ì˜ í•µì‹¬ íŠ¹ì§•ì…ë‹ˆë‹¤.
          </div>
        </div>
      `);
    } else if(pta < 0) {
      detailSections.push(`
        <div style="border-left:3px solid #ffb86c; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#ffb86c; font-size:13px;">ğŸ“ ê³¨ë°˜ í›„ë°© ê²½ì‚¬ (Posterior Pelvic Tilt)</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> PTA ${pta.toFixed(1)}Â° (ì •ìƒ: 0-15Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> ê³¼ë„í•œ ì½”ì–´ ìš´ë™, ì¥ì‹œê°„ êµ¬ë¶€ì •í•œ ì•‰ì€ ìì„¸, í–„ìŠ¤íŠ¸ë§ ê³¼ê¸´ì¥<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong>
            â€¢ í‰í‰í•œ í—ˆë¦¬(Flat back)ë¡œ ì¸í•œ ì¶©ê²© í¡ìˆ˜ ê°ì†Œ
            â€¢ ê³¨ë°˜ì €ê·¼ ê¸°ëŠ¥ ì €í•˜
            â€¢ ì—‰ë©ì´ í¸í‰í™”, í•˜ì²´ í˜ˆì•¡ìˆœí™˜ ì €í•˜<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­
            â‘¡ ëŒ€ë‘”ê·¼Â·ì²™ì¶”ê¸°ë¦½ê·¼ ê°•í™”
            â‘¢ ê³¨ë°˜ ì „ë°© ê²½ì‚¬ ì—°ìŠµ (ë‹¨, ê³¼í•˜ì§€ ì•Šê²Œ)
          </div>
        </div>
      `);
    }
  }
  
  // === 3. ìƒë¶€ êµì°¨ ì¦í›„êµ° (Upper Cross Syndrome) ì²´í¬ ===
  const hasUpperCross = (cva != null && cva < 50) && (nia != null && nia > 20);
  if(hasUpperCross) {
    issueCount++;
    detailSections.push(`
      <div style="border-left:3px solid #ff6b6b; padding-left:12px; margin-bottom:16px; background:rgba(255,107,107,0.05); padding:10px;">
        <strong style="color:#ff6b6b; font-size:13px;">âš ï¸ ìƒë¶€ êµì°¨ ì¦í›„êµ° (Upper Cross Syndrome) ì˜ì‹¬</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
          <strong>ì¦í›„êµ° ì„¤ëª…:</strong> ê±°ë¶ëª©ê³¼ ë‘¥ê·¼ ì–´ê¹¨ê°€ ë™ì‹œì— ë‚˜íƒ€ë‚˜ëŠ” í˜„ëŒ€ì¸ì˜ ëŒ€í‘œì  ìì„¸ ë¶ˆê· í˜• íŒ¨í„´ì…ë‹ˆë‹¤.<br>
          <strong>ì „í˜•ì  íŠ¹ì§•:</strong>
          â€¢ ë¨¸ë¦¬ ì „ë°© ëŒì¶œ (CVA: ${cva.toFixed(1)}Â°)
          â€¢ ëª© ê³¼ë„í•œ ì‹ ì „ (NIA: ${nia != null ? nia.toFixed(1) + 'Â°' : 'ë¯¸ì¸¡ì •'})
          â€¢ í‰ì¶” í›„ë§Œ ì¦ê°€ (ë“±ì´ êµ½ìŒ)
          â€¢ ì–´ê¹¨ ì „ë°© íšŒì „<br>
          <strong>êµì • ìš°ì„ ìˆœìœ„:</strong>
          â‘  ê¸´ì¥ í•´ì†Œ: ìƒë¶€ ìŠ¹ëª¨ê·¼, ëŒ€í‰ê·¼, í‰ì‡„ìœ ëŒê·¼ ì´ì™„
          â‘¡ í™œì„±í™”: ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼, ì¤‘Â·í•˜ë¶€ ìŠ¹ëª¨ê·¼, ì „ê±°ê·¼
          â‘¢ ìì„¸ êµìœ¡: ì•‰ì€ ìì„¸ì—ì„œ í‰ì¶” ì‹ ì „ ìœ ì§€
        </div>
      </div>
    `);
  }
  
  // === 4. ë¬´ë¦ ì •ë ¬ ë¬¸ì œ ===
  if(ka != null && (ka > 185 || ka < 175)) {
    issueCount++;
    if(ka > 185) {
      const severity = ka > 195 ? 'ì‹¬ê°' : ka > 190 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      detailSections.push(`
        <div style="border-left:3px solid #ffd166; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#ffd166; font-size:13px;">ğŸ“ ë¬´ë¦ ê³¼ì‹ ì „ (Genu Recurvatum) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> KA ${ka.toFixed(1)}Â° (ì •ìƒ: 175-185Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> ê´€ì ˆ ê³¼ì´ì™„ì„±(Joint hypermobility), ëŒ€í‡´ì‚¬ë‘ê·¼ ìš°ì„¸, í–„ìŠ¤íŠ¸ë§ ì•½í™”, ì˜ëª»ëœ ì„œê¸° ìŠµê´€<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong>
            â€¢ ë¬´ë¦ í›„ë°© ì¸ëŒ€ ê³¼ë¶€í•˜ (PCL, í›„ë°© ê´€ì ˆë‚­ ìŠ¤íŠ¸ë ˆìŠ¤)
            â€¢ ìŠ¬ê°œê³¨ ì••ë°• ì¦ê°€ë¡œ ìŠ¬ê°œëŒ€í‡´ í†µì¦ ì¦í›„êµ° ìœ„í—˜
            â€¢ ë¬´ë¦ ë¶ˆì•ˆì •ì„±, ì¥ê¸°ì ìœ¼ë¡œ ì¡°ê¸° ê´€ì ˆì—¼ ìœ ë°œ<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  í–„ìŠ¤íŠ¸ë§ ê°•í™”: ë ˆê·¸ì»¬, ë£¨ë§ˆë‹ˆì•ˆ ë°ë“œë¦¬í”„íŠ¸
            â‘¡ ëŒ€í‡´ì‚¬ë‘ê·¼ ê³¼ê¸´ì¥ ì™„í™”
            â‘¢ ì„œê¸° ìì„¸ êµì •: ë¬´ë¦ì„ ì‚´ì§ êµ¬ë¶€ë¦° ìƒíƒœ ìœ ì§€ ì—°ìŠµ
            â‘£ ê³ ìœ ìˆ˜ìš©ì„± í›ˆë ¨: í•œ ë°œ ì„œê¸°, ë°¸ëŸ°ìŠ¤ ë³´ë“œ<br>
            <strong>ì£¼ì˜ì‚¬í•­:</strong> ë¬´ë¦ì„ "ë”±" í´ëŠ” ìŠµê´€ì„ ì¦‰ì‹œ ì¤‘ë‹¨í•´ì•¼ í•©ë‹ˆë‹¤.
          </div>
        </div>
      `);
    } else {
      detailSections.push(`
        <div style="border-left:3px solid #ffd166; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#ffd166; font-size:13px;">ğŸ“ ë¬´ë¦ ê³¼êµ´ê³¡ ìì„¸</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> KA ${ka.toFixed(1)}Â° (ì •ìƒ: 175-185Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> í–„ìŠ¤íŠ¸ë§ ê³¼ê¸´ì¥, ì¢…ì•„ë¦¬ ê·¼ìœ¡ ë‹¨ì¶•, ê³¨ë°˜ í›„ë°© ê²½ì‚¬ ë™ë°˜<br>
            <strong>êµì • ë°©í–¥:</strong> í–„ìŠ¤íŠ¸ë§Â·ì¢…ì•„ë¦¬ ìŠ¤íŠ¸ë ˆì¹­, ëŒ€í‡´ì‚¬ë‘ê·¼ ê°•í™”
          </div>
        </div>
      `);
    }
  }
  
  // === 5. ë‹¤ë¦¬ ê¸¸ì´ ë¶ˆê· í˜• & ì¸¡ë§Œ ìœ„í—˜ ===
  if(lld != null && lld > 1) {
    issueCount++;
    const severity = lld > 2 ? 'ì‹¬ê°' : lld > 1.5 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
    detailSections.push(`
      <div style="border-left:3px solid #ff6b6b; padding-left:12px; margin-bottom:16px;">
        <strong style="color:#ff6b6b; font-size:13px;">ğŸ“ ë‹¤ë¦¬ ê¸¸ì´ ë¶ˆê· í˜• (Leg Length Discrepancy) - ${severity}</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
          <strong>í˜„ì¬ ìƒíƒœ:</strong> LLD ${lld.toFixed(1)}cm (ì •ìƒ: â‰¤1cm)<br>
          <strong>êµ¬ë¶„:</strong>
          â€¢ êµ¬ì¡°ì  ë¶ˆê· í˜•: ì‹¤ì œ ë¼ˆ ê¸¸ì´ ì°¨ì´ (X-ray ì´¬ì˜ í•„ìš”)
          â€¢ ê¸°ëŠ¥ì  ë¶ˆê· í˜•: ê·¼ìœ¡ ë¶ˆê· í˜•Â·ê³¨ë°˜ íšŒì „ìœ¼ë¡œ ì¸í•œ ê²‰ë³´ê¸° ì°¨ì´<br>
          <strong>ë°œìƒ ì¦ìƒ:</strong>
          â€¢ ê³¨ë°˜ ê¸°ìš¸ì–´ì§ â†’ ì²™ì¶” ì¸¡ë§Œì¦(Scoliosis) ìœ ë°œ
          â€¢ ë³´í–‰ ì‹œ ë¹„ëŒ€ì¹­ â†’ ë¬´ë¦Â·ê³ ê´€ì ˆÂ·í—ˆë¦¬ í†µì¦
          â€¢ í•œìª½ ë‹¤ë¦¬ í”¼ë¡œ ëˆ„ì <br>
          <strong>êµì • ë°©í–¥:</strong>
          â‘  ê¸°ëŠ¥ì  ë¶ˆê· í˜•: ê³¨ë°˜ êµì • ìš´ë™, ì¤‘ë‘”ê·¼(Gluteus medius) ê°•í™”, TFLÂ·QL ìŠ¤íŠ¸ë ˆì¹­
          â‘¡ êµ¬ì¡°ì  ë¶ˆê· í˜•: ê¹”ì°½(Heel lift) ì‚¬ìš© ê³ ë ¤, ì „ë¬¸ì˜ ìƒë‹´ í•„ìˆ˜<br>
          <strong>ì—°ì‡„ ë°˜ì‘:</strong> LLD â†’ ê³¨ë°˜ ê¸°ìš¸ì–´ì§ â†’ ì²™ì¶” ì¸¡ë§Œ â†’ ì–´ê¹¨ ë†’ì´ ì°¨ì´ â†’ ëª© í†µì¦
        </div>
      </div>
    `);
  }
  
  // === 6. ì „ì‹  ê· í˜• ë¬¸ì œ ===
  if((bva != null && bva > 2) || (gsb != null && gsb > 2)) {
    issueCount++;
    detailSections.push(`
      <div style="border-left:3px solid #ff6b6b; padding-left:12px; margin-bottom:16px;">
        <strong style="color:#ff6b6b; font-size:13px;">ğŸ“ ì „ì‹  ì •ë ¬ ë¶ˆê· í˜• (Global Postural Imbalance)</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
          <strong>í˜„ì¬ ìƒíƒœ:</strong> BVA ${bva != null ? bva.toFixed(1) + 'cm' : 'ë¯¸ì¸¡ì •'}, GSB ${gsb != null ? gsb.toFixed(1) + 'cm' : 'ë¯¸ì¸¡ì •'}<br>
          <strong>ì˜ë¯¸:</strong> ì£¼ìš” ê´€ì ˆë“¤ì´ ìˆ˜ì§ ì¤‘ë ¥ì„ ì—ì„œ í¬ê²Œ ë²—ì–´ë‚˜ ìˆì–´ ì „ì‹  ê·¼ê³¨ê²©ê³„ì— ê³¼ë¶€í•˜ê°€ ê±¸ë¦° ìƒíƒœì…ë‹ˆë‹¤.<br>
          <strong>ë°œìƒ ì¦ìƒ:</strong>
          â€¢ ì‰½ê²Œ í”¼ë¡œí•¨, ì¥ì‹œê°„ ì„œ ìˆê±°ë‚˜ ê±·ê¸° í˜ë“¦
          â€¢ ë§Œì„± í†µì¦ì˜ ë‹¤ë°œì„± ë°œìƒ (ëª©, ì–´ê¹¨, í—ˆë¦¬, ë¬´ë¦ ë“±)
          â€¢ ì—ë„ˆì§€ ì†Œëª¨ ì¦ê°€, í˜¸í¡ íš¨ìœ¨ ê°ì†Œ<br>
          <strong>êµì • ë°©í–¥:</strong>
          â‘  ì „ì²´ì ì¸ ìì„¸ ì¬ì •ë ¬ í”„ë¡œê·¸ë¨ í•„ìš” (í†µí•©ì  ì ‘ê·¼)
          â‘¡ í•„ë¼í…ŒìŠ¤, ìš”ê°€ ë“± ì „ì‹  ê· í˜• ìš´ë™
          â‘¢ ì „ë¬¸ê°€(ë¬¼ë¦¬ì¹˜ë£Œì‚¬, ì¹´ì´ë¡œí”„ë™í„°) ìƒë‹´ ê¶Œì¥
        </div>
      </div>
    `);
  }
  
  // === 7. ì²™ì¶” ë§Œê³¡ ì´ìƒ ===
  if(sci != null && (sci < 0.15 || sci > 0.35)) {
    issueCount++;
    if(sci < 0.15) {
      detailSections.push(`
        <div style="border-left:3px solid #ffb86c; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#ffb86c; font-size:13px;">ğŸ“ ì²™ì¶” ë§Œê³¡ ë¶€ì¡± (Hypolordosis / Flat Back)</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> SCI ${sci.toFixed(2)} (ì •ìƒ: 0.15-0.35)<br>
            <strong>ì˜ë¯¸:</strong> ì²™ì¶”ì˜ ìì—°ìŠ¤ëŸ¬ìš´ Sì ê³¡ì„ ì´ ë¶€ì¡±í•˜ì—¬ ì¶©ê²© í¡ìˆ˜ ëŠ¥ë ¥ì´ ì €í•˜ëœ ìƒíƒœ<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong> í—ˆë¦¬ í”¼ë¡œ ì¦ê°€, ë””ìŠ¤í¬ ì••ë ¥ ì¦ê°€, ë»£ë»£í•œ ë“±<br>
            <strong>êµì • ë°©í–¥:</strong> ì²™ì¶” ì‹ ì „ ìš´ë™(Cat-Cow, Cobra pose), í‰ì¶” ëª¨ë¹Œë¦¬í‹° í™•ë³´
          </div>
        </div>
      `);
    } else {
      detailSections.push(`
        <div style="border-left:3px solid #ffb86c; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#ffb86c; font-size:13px;">ğŸ“ ì²™ì¶” ê³¼ë§Œê³¡ (Hyperlordosis / Swayback)</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> SCI ${sci.toFixed(2)} (ì •ìƒ: 0.15-0.35)<br>
            <strong>ì˜ë¯¸:</strong> ì²™ì¶” ë§Œê³¡ì´ ê³¼ë„í•˜ì—¬ ë””ìŠ¤í¬ì™€ í›„ê´€ì ˆì— ì••ë°•ì´ ê°€ì¤‘ë¨<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong> ìš”í†µ, ë””ìŠ¤í¬ ì••ë°•, ì²™ì¶” ë¶ˆì•ˆì •ì„±<br>
            <strong>êµì • ë°©í–¥:</strong> ì½”ì–´ ì•ˆì •í™”, ê³¨ë°˜ ì¤‘ë¦½ ìì„¸ í›ˆë ¨, ê³¼ì „ë§Œ ê°ì†Œ ìš´ë™
          </div>
        </div>
      `);
    }
  }
  
  // === ì¢…í•© í‰ê°€ ë° ìš”ì•½ ===
  if(pds != null) {
    if(pdsStatus === 'normal') {
      summarySection = `<div style="background:rgba(46,196,182,0.1); padding:12px; border-radius:8px; margin-bottom:16px;">
        <strong style="color:#2ec4b6; font-size:14px;">âœ“ ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸í•œ ìì„¸</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.6; color:var(--muted);">
          ëŒ€ë¶€ë¶„ì˜ ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ì— ìˆìŠµë‹ˆë‹¤. (PDS: ${pds.toFixed(1)}ì )<br>
          í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ê·œì¹™ì ì¸ ìŠ¤íŠ¸ë ˆì¹­ê³¼ ê·¼ë ¥ ìš´ë™ì„ ì§€ì†í•˜ì„¸ìš”.
        </div>
      </div>`;
    } else if(pdsStatus === 'mild') {
      summarySection = `<div style="background:rgba(255,209,102,0.1); padding:12px; border-radius:8px; margin-bottom:16px;">
        <strong style="color:#ffd166; font-size:14px;">âš ï¸ ê²½ë¯¸í•œ ìì„¸ ë¶ˆê· í˜•</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.6; color:var(--muted);">
          ${issueCount}ê°œ í•­ëª©ì—ì„œ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤. (PDS: ${pds.toFixed(1)}ì )<br>
          ì§€ê¸ˆë¶€í„° êµì •ì„ ì‹œì‘í•˜ë©´ ë‹¨ê¸°ê°„ ë‚´ ê°œì„ ì´ ê°€ëŠ¥í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤.
        </div>
      </div>`;
    } else if(pdsStatus === 'moderate') {
      summarySection = `<div style="background:rgba(255,184,108,0.1); padding:12px; border-radius:8px; margin-bottom:16px;">
        <strong style="color:#ffb86c; font-size:14px;">âš ï¸ ì¤‘ë“±ë„ ìì„¸ ë¶ˆê· í˜•</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.6; color:var(--muted);">
          ${issueCount}ê°œ í•­ëª©ì—ì„œ êµì •ì´ í•„ìš”í•©ë‹ˆë‹¤. (PDS: ${pds.toFixed(1)}ì )<br>
          ì²´ê³„ì ì¸ êµì • ìš´ë™ í”„ë¡œê·¸ë¨ê³¼ ìƒí™œ ìŠµê´€ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </div>
      </div>`;
    } else {
      summarySection = `<div style="background:rgba(255,107,107,0.1); padding:12px; border-radius:8px; margin-bottom:16px;">
        <strong style="color:#ff6b6b; font-size:14px;">ğŸš¨ ì‹¬ê°í•œ ìì„¸ ë¶ˆê· í˜•</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.6; color:var(--muted);">
          ${issueCount}ê°œ í•­ëª©ì—ì„œ ì •ìƒ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. (PDS: ${pds.toFixed(1)}ì )<br>
          <strong>ì „ë¬¸ê°€ ìƒë‹´ì„ ê°•ë ¥íˆ ê¶Œì¥í•©ë‹ˆë‹¤.</strong> (ë¬¼ë¦¬ì¹˜ë£Œì‚¬, ì •í˜•ì™¸ê³¼ ì „ë¬¸ì˜, ì¹´ì´ë¡œí”„ë™í„°)<br>
          ë°©ì¹˜ ì‹œ ë§Œì„± í†µì¦ ë° êµ¬ì¡°ì  ë³€í˜•ì´ ê³ ì°©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>`;
    }
  }
  
  // === í†µí•© ê¶Œì¥ì‚¬í•­ ===
  if(issueCount > 0) {
    recommendations.push(`
      <div style="background:rgba(124,156,255,0.08); padding:12px; border-radius:8px; margin-top:16px;">
        <strong style="color:#7c9cff; font-size:13px;">ğŸ’¡ í†µí•© êµì • ê¶Œì¥ì‚¬í•­</strong>
        <div style="margin-top:8px; font-size:11px; line-height:1.7; color:var(--muted);">
          <strong>1. ì¼ìƒìƒí™œ ê°œì„ :</strong><br>
          â€¢ ì‘ì—… í™˜ê²½: ëª¨ë‹ˆí„° ëˆˆë†’ì´, ì˜ì ë†’ì´, ì±…ìƒ ê±°ë¦¬ ì¡°ì •<br>
          â€¢ ìˆ˜ë©´ ìì„¸: ê²½ì¶” ì§€ì§€ ë² ê°œ, ì˜†ìœ¼ë¡œ ëˆ„ì›Œ ìê¸°<br>
          â€¢ ìŠ¤ë§ˆíŠ¸í°: ëˆˆë†’ì´ê¹Œì§€ ë“¤ê³  ë³´ê¸°, ì‚¬ìš© ì‹œê°„ ì œí•œ<br><br>
          
          <strong>2. ìš´ë™ í”„ë¡œê·¸ë¨:</strong><br>
          â€¢ ë§¤ì¼: ìŠ¤íŠ¸ë ˆì¹­ 10-15ë¶„ (ê¸´ì¥ëœ ê·¼ìœ¡ ì´ì™„)<br>
          â€¢ ì£¼ 3-4íšŒ: ê·¼ë ¥ ìš´ë™ 30ë¶„ (ì•½í™”ëœ ê·¼ìœ¡ ê°•í™”)<br>
          â€¢ ì£¼ 2-3íšŒ: ìœ ì‚°ì†Œ ìš´ë™ 30ë¶„ (ì „ì‹  ìˆœí™˜ ê°œì„ )<br><br>
          
          <strong>3. ì „ë¬¸ê°€ ë„ì›€:</strong><br>
          â€¢ ë¬¼ë¦¬ì¹˜ë£Œ: ìˆ˜ê¸° ì¹˜ë£Œ, ë„ìˆ˜ ì¹˜ë£Œ, ìš´ë™ ì¹˜ë£Œ<br>
          â€¢ í•„ë¼í…ŒìŠ¤/ìš”ê°€: ì „ë¬¸ ê°•ì‚¬ì˜ 1:1 êµì • ìˆ˜ì—…<br>
          â€¢ ì •ê¸° ê²€ì§„: 3-6ê°œì›”ë§ˆë‹¤ ìì„¸ ì¬í‰ê°€<br><br>
          
          <strong>4. êµì • ìˆœì„œ:</strong><br>
          â‘  1-2ì£¼ì°¨: ê¸´ì¥ëœ ê·¼ìœ¡ ì´ì™„ (ë§ˆì‚¬ì§€, í¼ë¡¤ëŸ¬, ìŠ¤íŠ¸ë ˆì¹­)<br>
          â‘¡ 3-4ì£¼ì°¨: ì•½í™”ëœ ê·¼ìœ¡ í™œì„±í™” (ì €ê°•ë„ ìš´ë™)<br>
          â‘¢ 5ì£¼ì°¨ ì´í›„: ì ì§„ì  ê°•í™” ë° ìì„¸ í†µí•© í›ˆë ¨
        </div>
      </div>
    `);
  }
  
  // === ìµœì¢… ì¶œë ¥ ì¡°í•© ===
  if(detailSections.length === 0) {
    return summarySection || "í˜„ì¬ ìì„¸ëŠ” ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸í•©ë‹ˆë‹¤.";
  }
  
  return summarySection + detailSections.join('') + recommendations.join('');
}

function updateScoreAndAnalysis(scoreData, cva, pelvic, knee, analysis) {
  const scoreEl = document.getElementById("totalScore");
  const reasonEl = document.getElementById("scoreReason");
  const commentEl = document.getElementById("aiComment");
  const commentPanel = document.getElementById("aiCommentPanel");
  const musclePanel = document.getElementById("musclePanel");
  const tightList = document.getElementById("muscleTightList");
  const weakList = document.getElementById("muscleWeakList");
  const detailList = document.getElementById("muscleDetailList");
  const exercisePanel = document.getElementById("exercisePanel");
  const exerciseList = document.getElementById("exerciseList");
  const pilatesPanel = document.getElementById("pilatesPanel");
  const pilatesList = document.getElementById("pilatesList");
  const allMetricsList = document.getElementById("allMetricsList");
  const pdsValueEl = document.getElementById("pdsValue");
  
  // ì „ì²´ ë¶„ì„ í•­ëª© í‘œì‹œ
  const S = sessions[cur];
  const fullMetrics = S.metrics?.fullMetrics || {};
  if(allMetricsList && fullMetrics) {
    // ì¸¡ë©´ í•­ëª© (íŒŒë€ìƒ‰ #7c9cff)
    const sideMetricsOrder = [
      {key: 'CVA', name: 'CVA(ë‘ê°œê²½ì¶”ê°)', unit: 'Â°', type: 'side'},
      {key: 'HPD', name: 'HPD(ë‘ë¶€ì „ë°©ì´ë™)', unit: 'cm', type: 'side'},
      {key: 'NIA', name: 'NIA(ê²½ì¶”ê²½ì‚¬ê°)', unit: 'Â°', type: 'side'},
      {key: 'TIA', name: 'TIA(ì²´ê°„ê²½ì‚¬ê°)', unit: 'Â°', type: 'side'},
      {key: 'SAA', name: 'SAA(ì–´ê¹¨ì „ë°©ê°)', unit: 'Â°', type: 'side'},
      {key: 'PTA', name: 'PTA(ê³¨ë°˜ ì „í›„ê²½ì‚¬ê°)', unit: 'Â°', type: 'side'},
      {key: 'KA', name: 'KA(ë¬´ë¦ê°)', unit: 'Â°', type: 'side'},
      {key: 'Tibial_Angle', name: 'Tibial(ê²½ê³¨ê²½ì‚¬ê°)', unit: 'Â°', type: 'side'},
      {key: 'Knee_Deviation', name: 'Knee Dev(ë¬´ë¦í¸ìœ„)', unit: 'Â°', type: 'side'},
      {key: 'LLD', name: 'LLD(í•˜ì§€ê¸¸ì´ì°¨)', unit: 'cm', type: 'side'},
      {key: 'GSB', name: 'GSB(ì¤‘ë ¥ì¤‘ì‹¬ì„ )', unit: 'cm', type: 'side'},
      {key: 'BVA', name: 'BVA(ì²´ì¤‘ì „ë°©ì´ë™)', unit: 'cm', type: 'side'},
      {key: 'SCI', name: 'SCI(ì²™ì¶”ê³¡ë¥ ì§€ìˆ˜)', unit: 'ratio', type: 'side'},
      {key: 'HPA', name: 'HPA(ê³ ê´€ì ˆê°)', unit: 'Â°', type: 'side'},
      {key: 'PDS', name: 'PDS(ìì„¸ì ìˆ˜)', unit: 'score', type: 'side'}
    ];
    
    // ì •ë©´ í•­ëª© (ì²­ë¡ìƒ‰ #2ec4b6)
    const frontMetricsOrder = [
      {key: 'STA_F', name: 'STA(ì–´ê¹¨ê¸°ìš¸ê¸°ê°)', unit: 'Â°', type: 'front'},
      {key: 'STA', name: 'STA(ì–´ê¹¨ê¸°ìš¸ê¸°ê°)', unit: 'Â°', type: 'front'}, // í•˜ìœ„ í˜¸í™˜ì„±
      {key: 'POA_F', name: 'POA(ê³¨ë°˜ê¸°ìš¸ê¸°ê°)', unit: 'Â°', type: 'front'},
      {key: 'POA', name: 'POA(ê³¨ë°˜ê¸°ìš¸ê¸°ê°)', unit: 'Â°', type: 'front'}, // í•˜ìœ„ í˜¸í™˜ì„±
      {key: 'LLD_F', name: 'LLD(í•˜ì§€ê¸¸ì´ì°¨)', unit: 'cm', type: 'front'},
      {key: 'TD', name: 'TD(ì²´ê°„í¸ìœ„)', unit: 'Â°', type: 'front'},
      {key: 'HTA', name: 'HTA(ë¨¸ë¦¬ê¸°ìš¸ê¸°ê°)', unit: 'Â°', type: 'front'},
      {key: 'SPP', name: 'SPP(ì–´ê¹¨ê³¨ë°˜í‰í–‰ë„)', unit: 'Â°', type: 'front'},
      {key: 'Q_Angle', name: 'Q-Angle(Qê°)', unit: 'Â°', type: 'front'},  // ì •ë©´ ë¶„ì„ í•­ëª©ìœ¼ë¡œ ì´ë™
      {key: 'KAS', name: 'KAS(ë¬´ë¦ì •ë ¬ëŒ€ì¹­ì„±)', unit: 'Â°', type: 'front'},
      {key: 'LLAS', name: 'LLAS(í•˜ì§€ì¶•ëŒ€ì¹­ì„±)', unit: 'Â°', type: 'front'},
      {key: 'FBA', name: 'FBA(ë°œì •ë ¬ê°)', unit: 'Â°', type: 'front'}
    ];
    
    // ëª¨ë“  í•­ëª© í•©ì¹˜ê¸° (ì¸¡ë©´ ë¨¼ì €, ì •ë©´ ë‚˜ì¤‘)
    const metricsOrder = [...sideMetricsOrder, ...frontMetricsOrder];
    
    let html = '';
    const processedKeys = new Set(); // ì¤‘ë³µ ë°©ì§€
    
    metricsOrder.forEach(m => {
      // ì´ë¯¸ ì²˜ë¦¬ëœ í‚¤ëŠ” ê±´ë„ˆë›°ê¸°
      if(processedKeys.has(m.key)) return;
      
      // STA_Fì™€ STA ì¤‘ í•˜ë‚˜ë§Œ, POA_Fì™€ POA ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒ
      let metricKey = m.key;
      if(m.key === 'STA' && fullMetrics['STA_F']) {
        metricKey = 'STA_F';
        if(processedKeys.has('STA_F')) return;
      }
      if(m.key === 'POA' && fullMetrics['POA_F']) {
        metricKey = 'POA_F';
        if(processedKeys.has('POA_F')) return;
      }
      
      const metric = fullMetrics[metricKey] || fullMetrics[m.key];
      if(metric) {
        processedKeys.add(metricKey);
        if(m.key !== metricKey) processedKeys.add(m.key);
        
        const value = metric.value !== undefined ? metric.value : (metric.value_deg !== undefined ? metric.value_deg : (metric.value_cm !== undefined ? metric.value_cm : null));
        const status = metric.status || 'unknown';
        const unit = metric.unit || m.unit;
        if(value !== null && value !== undefined) {
          const statusColor = status === 'normal' ? '#2ec4b6' : status === 'mild' ? '#ffd166' : status === 'moderate' ? '#ffb86c' : '#ff6b6b';
          const statusText = status === 'normal' ? 'âœ“' : status === 'mild' ? 'âš ' : status === 'moderate' ? 'âš âš ' : status === 'severe' ? 'âœ—' : '?';
          
          // ì¸¡ë©´ í•­ëª©ì€ íŒŒë€ìƒ‰, ì •ë©´ í•­ëª©ì€ ì²­ë¡ìƒ‰ìœ¼ë¡œ ì´ë¦„ í‘œì‹œ
          const nameColor = m.type === 'front' ? '#2ec4b6' : '#7c9cff';
          
          html += `<div style="display:flex; justify-content:space-between; margin-bottom:3px; padding:2px 0;">
            <span style="color:${nameColor}; font-weight:${m.type === 'front' ? '600' : '400'};">${m.name}:</span>
            <span style="color:${statusColor};">${value.toFixed(1)}${unit} ${statusText}</span>
          </div>`;
        }
      }
    });
    allMetricsList.innerHTML = html || '<div style="color:var(--muted);">ë¶„ì„ ë°ì´í„° ì—†ìŒ</div>';
    
    // PDS í‘œì‹œ
    if(fullMetrics.PDS && pdsValueEl) {
      const pds = fullMetrics.PDS.value;
      const pdsStatus = fullMetrics.PDS.status;
      const pdsColor = pdsStatus === 'normal' ? '#2ec4b6' : pdsStatus === 'mild' ? '#ffd166' : '#ff6b6b';
      pdsValueEl.textContent = `${pds.toFixed(1)} (${pdsStatus})`;
      pdsValueEl.style.color = pdsColor;
    } else if(pdsValueEl) {
      pdsValueEl.textContent = 'â€”';
    }
  }
  
  // ì „ì²´ ë¶„ì„ í•­ëª© ê¸°ì¤€ìœ¼ë¡œ ì ìˆ˜ ì¬ê³„ì‚° (fullMetricsê°€ ìˆìœ¼ë©´)
  if(fullMetrics && Object.keys(fullMetrics).length > 0) {
    const scoreResult = computeScoreFromFullMetrics(fullMetrics);
    if(scoreResult.score != null) {
      scoreData = scoreResult;
    }
  }
  
  if(scoreData && scoreData.score != null) {
    const score = scoreData.score;
    scoreEl.textContent = score;
    
    // ì ìˆ˜ ìƒ‰ìƒ
    if(score >= 85) {
      scoreEl.style.color = "#2ec4b6";
    } else if(score >= 70) {
      scoreEl.style.color = "#ffd166";
    } else {
      scoreEl.style.color = "#ff6b6b";
    }
    
    // ì ìˆ˜ ê·¼ê±°
    if(scoreData.reasons && scoreData.reasons.length > 0) {
      reasonEl.textContent = "ê°ì  ê·¼ê±°: " + scoreData.reasons.join(", ");
    } else {
      reasonEl.textContent = "ëª¨ë“  ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.";
    }
  } else {
    scoreEl.textContent = "â€”";
    reasonEl.textContent = "";
  }
  
  // AI ì½”ë©˜íŠ¸ (ë” ìƒì„¸í•˜ê²Œ)
  if(analysis && analysis.comments && analysis.comments.length > 0) {
    let commentText = analysis.comments.join(" ");
    if(analysis.details && analysis.details.length > 0) {
      commentText += "\n\n" + analysis.details.join("\n");
    }
    commentEl.innerHTML = commentText.replace(/\n/g, '<br>');
    commentPanel.style.display = "block";
    
    // ì²´í˜• ìœ í˜• ë¶„ì„ ì¶”ê°€
    const postureTypeContent = document.getElementById("postureTypeContent");
    if(postureTypeContent && fullMetrics) {
      let postureType = analyzePostureType(fullMetrics);
      postureTypeContent.innerHTML = postureType;
    }
  } else {
    commentPanel.style.display = "none";
  }
  
  // ê·¼ìœ¡ ë¶„ì„ (ìƒì„¸)
  if(analysis && (analysis.tight.length > 0 || analysis.weak.length > 0)) {
    if(analysis.tight.length > 0) {
      tightList.innerHTML = analysis.tight.join(", ").replace(/,/g, ', ');
    } else {
      tightList.textContent = "ì—†ìŒ";
      tightList.style.color = "var(--muted)";
    }
    
    if(analysis.weak.length > 0) {
      weakList.innerHTML = analysis.weak.join(", ").replace(/,/g, ', ');
    } else {
      weakList.textContent = "ì—†ìŒ";
      weakList.style.color = "var(--muted)";
    }
    
    // ìƒì„¸ ë¶„ì„ í‘œì‹œ
    if(analysis.details && analysis.details.length > 0) {
      detailList.innerHTML = analysis.details.join("<br>");
    } else {
      detailList.textContent = "ìƒì„¸ ë¶„ì„ ì—†ìŒ";
    }
    
    musclePanel.style.display = "block";
  } else {
    musclePanel.style.display = "none";
  }
  
  // ìš´ë™ ì¶”ì²œ
  if(analysis && analysis.exercises && analysis.exercises.length > 0) {
    exerciseList.innerHTML = analysis.exercises.map(ex => `<div style="margin-bottom:6px;">${ex}</div>`).join("");
    exercisePanel.style.display = "block";
  } else {
    exercisePanel.style.display = "none";
  }
  
  // í•„ë¼í…ŒìŠ¤ ì¶”ì²œ (íŒ¨í„´ ê¸°ë°˜)
  if(analysis && analysis.pilates && analysis.pilates.length > 0) {
    let pilatesHTML = '';
    analysis.pilates.forEach((item, idx) => {
      const itemName = item.name || item.issue || `íŒ¨í„´ ${idx + 1}`;
      const itemCondition = item.condition || '';
      const itemInterpretation = item.interpretation || '';
      const itemTight = item.tight || item.muscles || [];
      const itemWeak = item.weak || [];
      const itemExercises = item.exercises || item.pilates || {};
      
      pilatesHTML += `<div style="margin-bottom:15px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px;">`;
      pilatesHTML += `<div style="font-size:13px; font-weight:600; margin-bottom:6px; color:#9c88ff;">${idx + 1}. ${itemName}</div>`;
      if(itemCondition) {
        pilatesHTML += `<div style="font-size:11px; color:var(--muted); margin-bottom:4px;">ì¡°ê±´: ${itemCondition}</div>`;
      }
      if(itemInterpretation) {
        pilatesHTML += `<div style="font-size:11px; color:var(--muted); margin-bottom:4px;">í•´ì„: ${itemInterpretation}</div>`;
      }
      if(itemTight.length > 0) {
        pilatesHTML += `<div style="font-size:11px; margin-bottom:4px;"><span style="color:#ff6b6b;">ê¸´ì¥ëœ ê·¼ìœ¡:</span> <span style="color:var(--ink);">${Array.isArray(itemTight) ? itemTight.join(', ') : itemTight}</span></div>`;
      }
      if(itemWeak.length > 0) {
        pilatesHTML += `<div style="font-size:11px; margin-bottom:6px;"><span style="color:#7c9cff;">ì•½í™”ëœ ê·¼ìœ¡:</span> <span style="color:var(--ink);">${Array.isArray(itemWeak) ? itemWeak.join(', ') : itemWeak}</span></div>`;
      }
      
      const tools = ['ë§¤íŠ¸', 'ë¦¬í¬ë¨¸', 'ìºë”œë½', 'ì²´ì–´', 'ë°”ë '];
      tools.forEach(tool => {
        if(itemExercises[tool] && itemExercises[tool].length > 0) {
          pilatesHTML += `<div style="margin-top:6px; font-size:11px;"><strong style="color:#9c88ff;">${tool}:</strong>`;
          itemExercises[tool].forEach((exercise, exIdx) => {
            // exerciseê°€ ê°ì²´ì¸ ê²½ìš° (en, ko, purpose í¬í•¨)
            if(typeof exercise === 'object' && exercise.en) {
              const exerciseName = `${exercise.en} (${exercise.ko})`;
              const exerciseId = `exercise-${idx}-${tool}-${exIdx}`;
              pilatesHTML += `<div style="margin-left:8px; margin-top:2px;">`;
              pilatesHTML += `<span id="${exerciseId}" style="color:#2ec4b6; cursor:pointer; text-decoration:underline; border-bottom:1px dotted #2ec4b6;" onclick="showExerciseModal('${exercise.en}', '${exercise.ko}', '${exercise.purpose || ''}')">${exerciseName}</span>`;
              if(exercise.purpose) {
                pilatesHTML += ` <span style="color:var(--muted); font-size:10px;">(${exercise.purpose})</span>`;
              }
              pilatesHTML += `</div>`;
            } else {
              // exerciseê°€ ë¬¸ìì—´ì¸ ê²½ìš° (ê¸°ì¡´ ë°©ì‹ í˜¸í™˜)
              const exerciseName = typeof exercise === 'string' ? exercise : '';
              const exerciseId = `exercise-${idx}-${tool}-${exIdx}`;
              pilatesHTML += `<div style="margin-left:8px; margin-top:2px;">`;
              pilatesHTML += `<span id="${exerciseId}" style="color:#2ec4b6; cursor:pointer; text-decoration:underline; border-bottom:1px dotted #2ec4b6;" onclick="showExerciseModal('${exerciseName}', '${exerciseName}', '')">${exerciseName}</span>`;
              pilatesHTML += `</div>`;
            }
          });
          pilatesHTML += `</div>`;
        }
      });
      pilatesHTML += `</div>`;
    });
    pilatesList.innerHTML = pilatesHTML;
    pilatesPanel.style.display = "block";
  } else {
    pilatesPanel.style.display = "none";
  }
}

// í•„ë¼í…ŒìŠ¤ ìš´ë™ ìƒì„¸ ì„¤ëª… ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
function showExerciseModal(exerciseEn, exerciseKo, purpose) {
  const modal = document.getElementById("pilatesExerciseModal");
  const modalTitle = document.getElementById("modalExerciseTitle");
  const modalContent = document.getElementById("modalExerciseContent");
  const closeBtn = document.getElementById("closeModalBtn");
  
  if(!modal || !modalTitle || !modalContent) return;
  
  // ìš´ë™ ì„¤ëª… ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const exerciseDesc = pilatesExerciseDescriptions[exerciseEn];
  
  modalTitle.textContent = `${exerciseEn} (${exerciseKo})`;
  
  let contentHTML = '';
  
  if(exerciseDesc) {
    contentHTML += `<div style="margin-bottom:20px;">`;
    contentHTML += `<h4 style="color:#2ec4b6; font-size:15px; margin-bottom:10px; border-bottom:2px solid #2ec4b6; padding-bottom:5px;">ìš´ë™ ì„¤ëª…</h4>`;
    contentHTML += `<p style="margin-bottom:15px; line-height:1.8;">${exerciseDesc.description}</p>`;
    contentHTML += `</div>`;
    
    contentHTML += `<div style="margin-bottom:20px;">`;
    contentHTML += `<h4 style="color:#2ec4b6; font-size:15px; margin-bottom:10px; border-bottom:2px solid #2ec4b6; padding-bottom:5px;">ìˆ˜í–‰ ë°©ë²•</h4>`;
    contentHTML += `<p style="margin-bottom:15px; line-height:1.8; white-space:pre-line;">${exerciseDesc.instructions}</p>`;
    contentHTML += `</div>`;
    
    contentHTML += `<div style="margin-bottom:20px;">`;
    contentHTML += `<h4 style="color:#2ec4b6; font-size:15px; margin-bottom:10px; border-bottom:2px solid #2ec4b6; padding-bottom:5px;">ìš´ë™ íš¨ê³¼</h4>`;
    contentHTML += `<p style="margin-bottom:15px; line-height:1.8;">${exerciseDesc.benefits}</p>`;
    contentHTML += `</div>`;
    
    contentHTML += `<div style="margin-bottom:20px;">`;
    contentHTML += `<h4 style="color:#ff6b6b; font-size:15px; margin-bottom:10px; border-bottom:2px solid #ff6b6b; padding-bottom:5px;">ì£¼ì˜ì‚¬í•­</h4>`;
    contentHTML += `<p style="margin-bottom:15px; line-height:1.8; color:#ffb86c;">${exerciseDesc.precautions}</p>`;
    contentHTML += `</div>`;
  } else {
    // ìš´ë™ ì„¤ëª… ë°ì´í„°ê°€ ì—†ì„ ë•Œ
    contentHTML += `<div style="margin-bottom:20px;">`;
    contentHTML += `<p style="margin-bottom:15px; line-height:1.8;">${exerciseKo}</p>`;
    if(purpose) {
      contentHTML += `<p style="margin-bottom:15px; line-height:1.8; color:#2ec4b6;">ëª©ì : ${purpose}</p>`;
    }
    contentHTML += `<p style="margin-bottom:15px; line-height:1.8; color:var(--muted);">ìƒì„¸ ì„¤ëª…ì€ ê³§ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>`;
    contentHTML += `</div>`;
  }
  
  modalContent.innerHTML = contentHTML;
  modal.style.display = "block";
  
  // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
  closeBtn.onclick = () => {
    modal.style.display = "none";
  };
  
  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  modal.onclick = (e) => {
    if(e.target === modal) {
      modal.style.display = "none";
    }
  };
  
  // ESC í‚¤ë¡œ ë‹«ê¸°
  document.addEventListener('keydown', function escHandler(e) {
    if(e.key === 'Escape' && modal.style.display === 'block') {
      modal.style.display = "none";
      document.removeEventListener('keydown', escHandler);
    }
  });
}

function updateDisplay() {
  const M = sessions[cur].metrics;
  document.getElementById("dispCva").textContent = M.cva != null ? M.cva.toFixed(1) + "Â°" : "â€”";
  document.getElementById("dispPel").textContent = M.pelvic != null ? M.pelvic.toFixed(1) + "Â°" : "â€”";
  document.getElementById("dispKnee").textContent = M.knee != null ? M.knee.toFixed(1) + "Â°" : "â€”";
}

function fmtDeg(v) {
  return (v == null || isNaN(v)) ? "â€”" : v.toFixed(1) + "Â°";
}

function deltaStr(b, a, suf = "") {
  if(b == null || a == null || isNaN(b) || isNaN(a)) return "â€”";
  const d = a - b;
  const sign = d > 0 ? "+" : "";
  return sign + d.toFixed(1) + (suf || "");
}

function updateCompare() {
  const B = sessions.Before, A = sessions.After;
  
  // fullMetricsì—ì„œ 16ê°€ì§€ í•­ëª© ê°€ì ¸ì˜¤ê¸°
  const bMetrics = B.metrics?.fullMetrics || {};
  const aMetrics = A.metrics?.fullMetrics || {};
  
  // í—¬í¼ í•¨ìˆ˜: ë©”íŠ¸ë¦­ ê°’ ê°€ì ¸ì˜¤ê¸°
  const getMetricValue = (metrics, key) => {
    const metric = metrics[key];
    if(!metric) return null;
    return metric.value !== undefined ? metric.value : 
           (metric.value_deg !== undefined ? metric.value_deg : 
           (metric.value_cm !== undefined ? metric.value_cm : null));
  };
  
  // ì¸¡ë©´ + ì •ë©´ í•­ëª© ì—…ë°ì´íŠ¸
  const compareItems = [
    // ì¸¡ë©´ í•­ëª©
    {key: 'CVA', id: 'Cva', unit: 'Â°'},
    {key: 'HPD', id: 'Hpd', unit: 'cm'},
    {key: 'NIA', id: 'Nia', unit: 'Â°'},
    {key: 'TIA', id: 'Tia', unit: 'Â°'},
    {key: 'SAA', id: 'Saa', unit: 'Â°'},
    {key: 'PTA', id: 'Pta', unit: 'Â°'},
    {key: 'KA', id: 'Ka', unit: 'Â°'},
    {key: 'Tibial_Angle', id: 'Tibial', unit: 'Â°'},
    {key: 'Knee_Deviation', id: 'Kneedev', unit: 'Â°'},
    {key: 'LLD', id: 'Lld', unit: 'cm'},
    {key: 'GSB', id: 'Gsb', unit: 'cm'},
    {key: 'BVA', id: 'Bva', unit: 'cm'},
    {key: 'SCI', id: 'Sci', unit: ''},
    {key: 'HPA', id: 'Hpa', unit: 'Â°'},
    {key: 'PDS', id: 'Pds', unit: ''},
    // ì •ë©´ í•­ëª©
    {key: 'STA_F', altKey: 'STA', id: 'Sta', unit: 'Â°'},
    {key: 'POA_F', altKey: 'POA', id: 'Poa', unit: 'Â°'},
    {key: 'LLD_F', id: 'Lldf', unit: 'cm'},
    {key: 'TD', id: 'Td', unit: 'Â°'},
    {key: 'HTA', id: 'Hta', unit: 'Â°'},
    {key: 'SPP', id: 'Spp', unit: 'Â°'},
    {key: 'Q_Angle', id: 'Qangle', unit: 'Â°'},  // ì •ë©´ ë¶„ì„ í•­ëª©ìœ¼ë¡œ ì´ë™
    {key: 'KAS', id: 'Kas', unit: 'Â°'},
    {key: 'LLAS', id: 'Llas', unit: 'Â°'},
    {key: 'FBA', id: 'Fba', unit: 'Â°'}
  ];
  
  // í—¬í¼ í•¨ìˆ˜: ì •ë©´ ë©”íŠ¸ë¦­ í‚¤ ê°€ì ¸ì˜¤ê¸° (í•˜ìœ„ í˜¸í™˜ì„±)
  const getFrontMetricKey = (metrics, key, altKey) => {
    if(metrics[key]) return key;
    if(altKey && metrics[altKey]) return altKey;
    return key;
  };
  
  compareItems.forEach(item => {
    // ì •ë©´ í•­ëª©ì˜ ê²½ìš° í•˜ìœ„ í˜¸í™˜ì„± í‚¤ í™•ì¸
    const metricKeyB = item.altKey ? getFrontMetricKey(bMetrics, item.key, item.altKey) : item.key;
    const metricKeyA = item.altKey ? getFrontMetricKey(aMetrics, item.key, item.altKey) : item.key;
    
    const vB = getMetricValue(bMetrics, metricKeyB);
    const vA = getMetricValue(aMetrics, metricKeyA);
    
    const elB = document.getElementById(`cmp${item.id}B`);
    const elA = document.getElementById(`cmp${item.id}A`);
    const elD = document.getElementById(`cmp${item.id}D`);
    
    if(elB && elA && elD) {
      if(vB != null) {
        elB.textContent = vB.toFixed(item.unit === '' ? 2 : 1) + item.unit;
      } else {
        elB.textContent = "â€”";
      }
      
      if(vA != null) {
        elA.textContent = vA.toFixed(item.unit === '' ? 2 : 1) + item.unit;
      } else {
        elA.textContent = "â€”";
      }
      
      if(vB != null && vA != null) {
        elD.textContent = deltaStr(vB, vA, item.unit);
      } else {
        elD.textContent = "â€”";
      }
    }
  });
  
  // ì ìˆ˜ ë¹„êµ ì—…ë°ì´íŠ¸
  const sB = B.score ? B.score.score : null, sA = A.score ? A.score.score : null;
  const scoreElB = document.getElementById("cmpScoreB");
  const scoreElA = document.getElementById("cmpScoreA");
  const scoreElD = document.getElementById("cmpScoreD");
  
  if(scoreElB && scoreElA && scoreElD) {
    scoreElB.textContent = sB != null ? sB : "â€”";
    scoreElA.textContent = sA != null ? sA : "â€”";
    if(sB != null && sA != null) {
      scoreElD.textContent = deltaStr(sB, sA, "");
    } else {
      scoreElD.textContent = "â€”";
    }
  }
}

// ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ í† ê¸€
const btnEditCoords = document.getElementById("btnEditCoords");
const coordEditPanel = document.getElementById("coordEditPanel");
if(btnEditCoords && coordEditPanel) {
  btnEditCoords.onclick = () => {
    editMode = !editMode;
    console.log("ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ:", editMode ? "í™œì„±" : "ë¹„í™œì„±");
    if(editMode) {
      // ì›ë³¸ í¬ê¸° ì €ì¥
      if(originalCanvasSize.width === 0) {
        originalCanvasSize.width = cv.width / DPR;
        originalCanvasSize.height = cv.height / DPR;
        originalCanvasSize.styleWidth = parseFloat(cv.style.width) || cv.width / DPR;
        originalCanvasSize.styleHeight = parseFloat(cv.style.height) || cv.height / DPR;
      }
      coordEditPanel.style.display = "block";
      btnEditCoords.style.background = "rgba(124,156,255,0.4)";
      btnEditCoords.textContent = "âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ (í™œì„±)";
      // í™•ëŒ€ ì ìš©
      applyZoom();
    } else {
      // ì›ë˜ í¬ê¸°ë¡œ ë³µì›
      currentZoom = 1;
      coordEditPanel.style.display = "none";
      btnEditCoords.style.background = "rgba(124,156,255,0.2)";
      btnEditCoords.textContent = "âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ";
      selectedPoint = null;
      const selectEl = document.getElementById("coordSelectPoint");
      const xEl = document.getElementById("coordX");
      const yEl = document.getElementById("coordY");
      const zoomEl = document.getElementById("zoomLevel");
      if(selectEl) selectEl.value = "";
      if(xEl) xEl.value = "";
      if(yEl) yEl.value = "";
      if(zoomEl) zoomEl.value = "1";
      // ì›ë³¸ í¬ê¸° ì´ˆê¸°í™”í•˜ì—¬ ë‹¤ì‹œ ê³„ì‚°ë˜ë„ë¡
      originalCanvasSize.width = 0;
      originalCanvasSize.height = 0;
      originalCanvasSize.styleWidth = 0;
      originalCanvasSize.styleHeight = 0;
      // ì›ë³¸ í¬ê¸°ë¡œ ë³µì›
      const S = sessions[cur];
      const orientation = S.poseData?.orientation || "side";
      const img = orientation === "front" ? S.imgFront : S.imgSide;
      if(img) {
        resizeCanvasFor(img);
      }
      draw(); // ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    }
  };
} else {
  console.error("ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", {btnEditCoords, coordEditPanel});
}

// í™•ëŒ€ ì ìš© í•¨ìˆ˜
function applyZoom() {
  const S = sessions[cur];
  const orientation = S.poseData?.orientation || "side";
  const img = orientation === "front" ? S.imgFront : S.imgSide;
  
  if(!editMode || !img) {
    return;
  }
  
  const zoomEl = document.getElementById("zoomLevel");
  if(zoomEl) {
    const newZoom = parseInt(zoomEl.value) || 1;
    currentZoom = clamp(newZoom, 1, 4); // 1~4ë°°ë¡œ ì œí•œ
  }
  
  // ì›ë³¸ ì´ë¯¸ì§€ë¡œ í™•ëŒ€ ì ìš© (ë¹„ìœ¨ ìœ ì§€)
  resizeCanvasFor(img);
  
  // ì¢Œí‘œ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
  if(selectedPoint) {
    const P = getPts(cur);
    const pt = P[selectedPoint];
    if(pt && coordX && coordY) {
      // ì¢Œí‘œëŠ” í•­ìƒ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œ
      coordX.value = pt.x.toFixed(1);
      coordY.value = pt.y.toFixed(1);
    }
  }
}

// í™•ëŒ€ ë°°ìœ¨ ë³€ê²½
const zoomLevel = document.getElementById("zoomLevel");
if(zoomLevel) {
  zoomLevel.addEventListener("change", () => {
    if(editMode) {
      applyZoom();
    }
  });
}

// ì  ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½
const coordSelectPoint = document.getElementById("coordSelectPoint");
const coordX = document.getElementById("coordX");
const coordY = document.getElementById("coordY");

// ì  ì„ íƒ ì‹œ ì¢Œí‘œ í‘œì‹œ í•¨ìˆ˜
function updateCoordDisplay() {
  if(!coordX || !coordY) return;
  
  if(selectedPoint) {
    const P = getPts(cur);
    const pt = P[selectedPoint];
    if(pt) {
      // ì›ë³¸ í¬ê¸° ê¸°ì¤€ ì¢Œí‘œ í‘œì‹œ
      coordX.value = pt.x.toFixed(1);
      coordY.value = pt.y.toFixed(1);
    } else {
      // ì ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì • (ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° ì¤‘ì•™ ê·¼ì²˜)
      if(sessions[cur].img) {
        const originalW = originalCanvasSize.width || (cv.width / DPR);
        const originalH = originalCanvasSize.height || (cv.height / DPR);
        const defaultX = (originalW / 2).toFixed(1);
        const defaultY = (originalH / 2).toFixed(1);
        coordX.value = defaultX;
        coordY.value = defaultY;
      } else {
        coordX.value = "";
        coordY.value = "";
      }
    }
    draw();
  } else {
    coordX.value = "";
    coordY.value = "";
    draw();
  }
}

if(coordSelectPoint && coordX && coordY) {
  coordSelectPoint.addEventListener("change", e => {
    selectedPoint = e.target.value || null;
    console.log("ì„ íƒëœ ì :", selectedPoint);
    updateCoordDisplay();
  });
  
  // ì´ˆê¸°í™” ì‹œì—ë„ ì¢Œí‘œ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì ì´ ì´ë¯¸ ì„ íƒë˜ì–´ ìˆìœ¼ë©´)
  if(selectedPoint) {
    updateCoordDisplay();
  }
} else {
  console.error("ì¢Œí‘œ ì…ë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", {coordSelectPoint, coordX, coordY});
}

// ë“œë˜ê·¸í•  ë•Œë„ ì¢Œí‘œ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
window.updateCoordDisplay = updateCoordDisplay;

// ì¢Œí‘œ ì ìš© (ì €ì¥ ë²„íŠ¼ ì—­í•  - AI ë¶„ì„ ì‹¤í–‰)
const coordApply = document.getElementById("coordApply");
if(coordApply) {
  coordApply.onclick = () => {
    if(!selectedPoint) {
      alert("ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    const x = parseFloat(coordX.value);
    const y = parseFloat(coordY.value);
    if(isNaN(x) || isNaN(y)) {
      alert("ì˜¬ë°”ë¥¸ ì¢Œí‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    // ì¢Œí‘œëŠ” í•­ìƒ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì €ì¥
    const originalW = originalCanvasSize.width || (cv.width / DPR / (editMode ? currentZoom : 1));
    const originalH = originalCanvasSize.height || (cv.height / DPR / (editMode ? currentZoom : 1));
    const orientation = sessions[cur].poseData?.orientation || "side";
    const map = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
    const clampedX = clamp(x, 0, originalW);
    const clampedY = clamp(y, 0, originalH);
    map.set(selectedPoint, {
      x: clampedX,
      y: clampedY
    });
    draw();
    // ì €ì¥ ë²„íŠ¼ì´ë¯€ë¡œ AI ë¶„ì„ ì‹¤í–‰
    computeAll();
    // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
    coordX.value = clampedX.toFixed(1);
    coordY.value = clampedY.toFixed(1);
    
    // ì‹¤ì‹œê°„ ë¶„ì„ ì‹¤í–‰
    if(typeof liveAnalyzer !== 'undefined') {
      liveAnalyzer.analyzeCurrentSession();
    }
    // ì €ì¥ í›„ ì›ë˜ í¬ê¸°ë¡œ ë³µì›
    if(editMode) {
      currentZoom = 1;
      const zoomEl = document.getElementById("zoomLevel");
      if(zoomEl) zoomEl.value = "1";
      if(sessions[cur].img) {
        resizeCanvasFor(sessions[cur].img);
        draw();
      }
    }
  };
}

// ì·¨ì†Œ
const coordCancel = document.getElementById("coordCancel");
if(coordCancel) {
  coordCancel.onclick = () => {
    selectedPoint = null;
    if(coordSelectPoint) coordSelectPoint.value = "";
    if(coordX) coordX.value = "";
    if(coordY) coordY.value = "";
    draw();
  };
}

// X, Y ì¢Œí‘œ ì…ë ¥ í•„ë“œì—ì„œ Enter í‚¤ë¡œë„ ì ìš© ê°€ëŠ¥
if(coordX) {
  coordX.addEventListener("keypress", e => {
    if(e.key === "Enter") {
      if(coordApply) coordApply.click();
    }
  });
}
if(coordY) {
  coordY.addEventListener("keypress", e => {
    if(e.key === "Enter") {
      if(coordApply) coordApply.click();
    }
  });
}

// ì¢Œí‘œ ì¦ê° ë²„íŠ¼ ê¸°ëŠ¥ (ìë™ ì ìš©)
function adjustCoordinate(coordField, delta) {
  if(!coordField) return;
  
  // í˜„ì¬ ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
  let currentValue = parseFloat(coordField.value);
  if(isNaN(currentValue)) {
    // ì¢Œí‘œê°€ ì—†ìœ¼ë©´ ì¤‘ì•™ê°’ìœ¼ë¡œ ì„¤ì •
    const originalW = originalCanvasSize.width || (cv.width / DPR);
    const originalH = originalCanvasSize.height || (cv.height / DPR);
    if(coordField === coordX) {
      currentValue = originalW / 2;
    } else {
      currentValue = originalH / 2;
    }
  }
  
  const newValue = currentValue + delta;
  coordField.value = newValue.toFixed(1);
  
  // ìë™ìœ¼ë¡œ ì ìš© (ì ì´ ì„ íƒë˜ì–´ ìˆê³  ì¢Œí‘œê°€ ìœ íš¨í•œ ê²½ìš°)
  if(selectedPoint && !isNaN(newValue)) {
    const xField = coordX;
    const yField = coordY;
    if(!xField || !yField) return;
    
    const x = parseFloat(xField.value);
    const y = parseFloat(yField.value);
    
    if(!isNaN(x) && !isNaN(y)) {
      // ì¢Œí‘œëŠ” í•­ìƒ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì €ì¥
      const originalW = originalCanvasSize.width || (cv.width / DPR / (editMode ? currentZoom : 1));
      const originalH = originalCanvasSize.height || (cv.height / DPR / (editMode ? currentZoom : 1));
      const orientation = sessions[cur].poseData?.orientation || "side";
      const map = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
      const clampedX = clamp(x, 0, originalW);
      const clampedY = clamp(y, 0, originalH);
      
      map.set(selectedPoint, {
        x: clampedX,
        y: clampedY
      });
      
      // ì…ë ¥ í•„ë“œë„ ì—…ë°ì´íŠ¸ (í´ë¨í•‘ëœ ê°’)
      xField.value = clampedX.toFixed(1);
      yField.value = clampedY.toFixed(1);
      
    draw();
    computeMetricsOnly(); // ì‹¤ì‹œê°„ ë¶„ì„ ì—†ìŒ (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ AI ë¶„ì„)
    }
  }
}

// ì¦ê° ë²„íŠ¼ ì—°ì† í´ë¦­ ë³€ìˆ˜
let incrementTimer = null;
let incrementInterval = null;

function startIncrement(coordField, delta) {
  // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
  adjustCoordinate(coordField, delta);
  
  // ì§§ì€ ë”œë ˆì´ í›„ ì—°ì† ì‹¤í–‰
  incrementTimer = setTimeout(() => {
    incrementInterval = setInterval(() => {
      adjustCoordinate(coordField, delta);
    }, 50); // 50msë§ˆë‹¤ ì‹¤í–‰ (ë¹ ë¥¸ ì¦ê°)
  }, 300); // 300ms í›„ ì—°ì† ì‹¤í–‰ ì‹œì‘
}

function stopIncrement() {
  if(incrementTimer) {
    clearTimeout(incrementTimer);
    incrementTimer = null;
  }
  if(incrementInterval) {
    clearInterval(incrementInterval);
    incrementInterval = null;
  }
}

// X ì¢Œí‘œ ì¦ê° ë²„íŠ¼
const coordXDec = document.getElementById("coordXDec");
const coordXInc = document.getElementById("coordXInc");
if(coordXDec) {
  coordXDec.onmousedown = () => {
    if(coordX) startIncrement(coordX, -0.1);
  };
  coordXDec.onmouseup = stopIncrement;
  coordXDec.onmouseleave = stopIncrement;
  coordXDec.ontouchstart = (e) => {
    e.preventDefault();
    if(coordX) startIncrement(coordX, -0.1);
  };
  coordXDec.ontouchend = (e) => {
    e.preventDefault();
    stopIncrement();
  };
  coordXDec.ontouchcancel = (e) => {
    e.preventDefault();
    stopIncrement();
  };
}
if(coordXInc) {
  coordXInc.onmousedown = () => {
    if(coordX) startIncrement(coordX, 0.1);
  };
  coordXInc.onmouseup = stopIncrement;
  coordXInc.onmouseleave = stopIncrement;
  coordXInc.ontouchstart = (e) => {
    e.preventDefault();
    if(coordX) startIncrement(coordX, 0.1);
  };
  coordXInc.ontouchend = (e) => {
    e.preventDefault();
    stopIncrement();
  };
  coordXInc.ontouchcancel = (e) => {
    e.preventDefault();
    stopIncrement();
  };
}

// Y ì¢Œí‘œ ì¦ê° ë²„íŠ¼ (YëŠ” í™”ë©´ ì•„ë˜ë¡œ ê°ˆìˆ˜ë¡ ê°’ì´ ì»¤ì§€ë¯€ë¡œ ë°˜ëŒ€ë¡œ)
const coordYDec = document.getElementById("coordYDec");
const coordYInc = document.getElementById("coordYInc");
if(coordYDec) {
  coordYDec.onmousedown = () => {
    if(coordY) startIncrement(coordY, 0.1); // YëŠ” ìœ„ë¡œ ê°€ë ¤ë©´ ê°’ì´ ì¦ê°€í•´ì•¼ í•¨
  };
  coordYDec.onmouseup = stopIncrement;
  coordYDec.onmouseleave = stopIncrement;
  coordYDec.ontouchstart = (e) => {
    e.preventDefault();
    if(coordY) startIncrement(coordY, 0.1);
  };
  coordYDec.ontouchend = (e) => {
    e.preventDefault();
    stopIncrement();
  };
  coordYDec.ontouchcancel = (e) => {
    e.preventDefault();
    stopIncrement();
  };
}
if(coordYInc) {
  coordYInc.onmousedown = () => {
    if(coordY) startIncrement(coordY, -0.1); // YëŠ” ì•„ë˜ë¡œ ê°€ë ¤ë©´ ê°’ì´ ê°ì†Œí•´ì•¼ í•¨
  };
  coordYInc.onmouseup = stopIncrement;
  coordYInc.onmouseleave = stopIncrement;
  coordYInc.ontouchstart = (e) => {
    e.preventDefault();
    if(coordY) startIncrement(coordY, -0.1);
  };
  coordYInc.ontouchend = (e) => {
    e.preventDefault();
    stopIncrement();
  };
  coordYInc.ontouchcancel = (e) => {
    e.preventDefault();
    stopIncrement();
  };
}

// ë“œë˜ê·¸ ê¸°ëŠ¥ (ë§ˆìš°ìŠ¤ + í„°ì¹˜)
function getEventPos(e) {
  const r = cv.getBoundingClientRect();
  const clientX = e.touches && e.touches.length > 0 ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches && e.touches.length > 0 ? e.touches[0].clientY : e.clientY;
  
  // ìº”ë²„ìŠ¤ ìƒëŒ€ ì¢Œí‘œ (ìº”ë²„ìŠ¤ ê¸°ì¤€)
  // getBoundingClientRect()ëŠ” ì´ë¯¸ ìŠ¤í¬ë¡¤ëœ ìœ„ì¹˜ë¥¼ ë°˜ì˜í•˜ë¯€ë¡œ
  // clientX - r.leftëŠ” ìº”ë²„ìŠ¤ ì „ì²´ì—ì„œì˜ CSS í”½ì…€ ìœ„ì¹˜ì…ë‹ˆë‹¤
  let x = clientX - r.left;
  let y = clientY - r.top;
  
  // í™•ëŒ€ ëª¨ë“œ
  if(editMode && currentZoom > 1) {
    // x, yëŠ” ì´ë¯¸ í™•ëŒ€ëœ ìº”ë²„ìŠ¤ ì „ì²´ì—ì„œì˜ CSS í”½ì…€ ìœ„ì¹˜ (ìŠ¤í¬ë¡¤ í¬í•¨)
    // ë”°ë¼ì„œ zoomìœ¼ë¡œ ë‚˜ëˆ„ê¸°ë§Œ í•˜ë©´ ì›ë³¸ í¬ê¸° ì¢Œí‘œê°€ ë¨
    x = x / currentZoom;
    y = y / currentZoom;
    
    // ì›ë³¸ í¬ê¸° ë²”ìœ„ë¡œ ì œí•œ
    const originalW = originalCanvasSize.width || (cv.width / DPR / currentZoom);
    const originalH = originalCanvasSize.height || (cv.height / DPR / currentZoom);
    x = Math.max(0, Math.min(x, originalW));
    y = Math.max(0, Math.min(y, originalH));
    
    console.log('í™•ëŒ€ ëª¨ë“œ ì¢Œí‘œ ë³€í™˜:', {
      clientX, clientY,
      rLeft: r.left.toFixed(1), rTop: r.top.toFixed(1),
      beforeZoom: {x: (clientX - r.left).toFixed(1), y: (clientY - r.top).toFixed(1)},
      afterZoom: {x: x.toFixed(1), y: y.toFixed(1)},
      zoom: currentZoom
    });
  } else {
    // ì¼ë°˜ ëª¨ë“œ: CSS ì¢Œí‘œë¥¼ ìº”ë²„ìŠ¤ ë…¼ë¦¬ ì¢Œí‘œë¡œ ë³€í™˜
    const cssWidth = r.width;
    const cssHeight = r.height;
    
    // ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜
    const originalW = originalCanvasSize.width || (cv.width / DPR);
    const originalH = originalCanvasSize.height || (cv.height / DPR);
    
    // CSS ì¢Œí‘œë¥¼ ë…¼ë¦¬ ì¢Œí‘œë¡œ ë³€í™˜
    x = (x / cssWidth) * originalW;
    y = (y / cssHeight) * originalH;
    
    // ë²”ìœ„ ì œí•œ
    x = Math.max(0, Math.min(x, originalW));
    y = Math.max(0, Math.min(y, originalH));
  }
  
  return { x, y };
}

function startDrag(e) {
  // ìƒíƒœ ì´ˆê¸°í™” (touchstartì—ì„œ ì´ë¯¸ ì´ˆê¸°í™”í–ˆì„ ìˆ˜ ìˆì§€ë§Œ ë‹¤ì‹œ ì´ˆê¸°í™”)
  // ì´ì „ ìƒíƒœê°€ ì™„ì „íˆ ì •ë¦¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
  if(dragKey) {
    console.log('âš ï¸ startDrag: ì´ì „ ë“œë˜ê·¸ ìƒíƒœê°€ ì•„ì§ ë‚¨ì•„ìˆìŒ:', dragKey);
  }
  
  // ìƒíƒœ ì´ˆê¸°í™” (ëª…ì‹œì ìœ¼ë¡œ)
  dragKey = null;
  isScrolling = false;
  scrollDistance = 0;
  
  // í„°ì¹˜ ì´ë²¤íŠ¸ì¸ ê²½ìš° ì†ê°€ë½ ê°œìˆ˜ í™•ì¸
  let touchCount = 0;
  if(e.touches) {
    touchCount = e.touches.length;
    touchStartTime = Date.now();
  }
  
  // í™•ëŒ€ ëª¨ë“œì—ì„œ ìŠ¤í¬ë¡¤ì€ ë‘ ì†ê°€ë½ë§Œ í—ˆìš©
  if(editMode && currentZoom > 1 && touchCount === 2) {
    // ë‘ ì†ê°€ë½ í„°ì¹˜: ìŠ¤í¬ë¡¤ ëª¨ë“œë§Œ í—ˆìš© (ì  ë“œë˜ê·¸ ë¶ˆê°€)
    isScrolling = true;
    dragKey = null;
    if(e.touches && e.touches.length > 0) {
      scrollStartX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
      scrollStartY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
    }
    return false;
  }
  
  // í•œ ì†ê°€ë½ í„°ì¹˜ë§Œ ì  ë“œë˜ê·¸ í—ˆìš©
  if(touchCount > 1 && !(editMode && currentZoom > 1)) {
    // í™•ëŒ€ ëª¨ë“œê°€ ì•„ë‹Œë° ë‘ ì†ê°€ë½ ì´ìƒì´ë©´ ë¬´ì‹œ
    return false;
  }
  
  const pos = getEventPos(e);
  const P = getPts(cur);
  
  // Long press ê´€ë ¨ ìƒíƒœ ì´ˆê¸°í™” (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ ì •ë¦¬ìš©)
  if(longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
  longPressDetected = false;
  longPressNearPoint = null;
  
  // ë¨¼ì € ëª¨ë“  ì ì„ ì²´í¬í•˜ì—¬ ì ì„ í„°ì¹˜í–ˆëŠ”ì§€ í™•ì¸
  // getEventPosëŠ” ì´ë¯¸ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì¢Œí‘œë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ, ì  ì¢Œí‘œì™€ ì§ì ‘ ë¹„êµ ê°€ëŠ¥
  let bestPoint = null;
  let bestDistance = 1e9;
  
  // threshold ê³„ì‚°: í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” 1cm ì •ë„ì˜ ê°ì§€ ì˜ì—­ë§Œ ìœ ì§€
  // 1cmë¥¼ í”½ì…€ë¡œ ë³€í™˜ (ì¼ë°˜ì ìœ¼ë¡œ 96 DPI ê¸°ì¤€ ì•½ 37.8í”½ì…€, í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” devicePixelRatio ê³ ë ¤)
  // ì‹¤ì œ í™”ë©´ í¬ê¸°ë¥¼ ê³ ë ¤í•˜ì—¬ ë” ì •í™•í•˜ê²Œ ê³„ì‚°
  const r = cv.getBoundingClientRect();
  const screenWidth = r.width; // CSS í”½ì…€
  
  // 2cmë¥¼ í”½ì…€ë¡œ ë³€í™˜ (96 DPI ê¸°ì¤€: 1cm â‰ˆ 37.8px, 2cm â‰ˆ 75.6px)
  // í•˜ì§€ë§Œ ì‹¤ì œ í™”ë©´ì—ì„œëŠ” devicePixelRatioë¥¼ ê³ ë ¤í•´ì•¼ í•¨
  // ê°„ë‹¨í•˜ê²Œ í™”ë©´ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ 2cmë¥¼ ì¶”ì • (í™”ë©´ ë„ˆë¹„ì˜ ì•½ 5% ì •ë„)
  const cmToPixel = screenWidth * 0.05; // í™”ë©´ ë„ˆë¹„ì˜ 5%ë¥¼ 2cmë¡œ ì¶”ì •
  // í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ì´ë¯€ë¡œ thresholdë¥¼ ì ì ˆíˆ ì„¤ì •
  // ë„ˆë¬´ í¬ë©´ ë¹ˆ í™”ë©´ì„ ëˆŒëŸ¬ë„ ë“œë˜ê·¸ê°€ ì‹œì‘ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì ì ˆí•œ ë²”ìœ„ ìœ ì§€
  const baseThreshold = Math.max(50, Math.min(100, cmToPixel)); // ìµœì†Œ 50px, ìµœëŒ€ 100px (2cm)
  
  // í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ thresholdë¥¼ ê³„ì‚°
  // ëª¨ë“  í™•ëŒ€ ë°°ìœ¨ì—ì„œ ë™ì¼í•œ ì¸ì‹ ë²”ìœ„ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ threshold ì‚¬ìš©
  let threshold;
  if(editMode && currentZoom > 1) {
    // í™•ëŒ€ ëª¨ë“œ: ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ threshold ì„¤ì •
    // ëª¨ë“  í™•ëŒ€ ë°°ìœ¨(2, 3, 4ë°°)ì—ì„œ ë™ì¼í•œ ì¸ì‹ ë²”ìœ„ë¥¼ ìœ ì§€
    // ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ì´ë¯€ë¡œ thresholdëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©
    threshold = baseThreshold; // í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” ì›ë³¸ ê¸°ì¤€ threshold ì‚¬ìš© (ëª¨ë“  ë°°ìœ¨ì—ì„œ ë™ì¼)
  } else {
    // ì¼ë°˜ ëª¨ë“œ: í™”ë©´ í”½ì…€ ê¸°ì¤€ (ë¼ë²¨ ì˜ì—­ í¬í•¨)
    threshold = baseThreshold * 1.5; // ë¼ë²¨ ì˜ì—­ í¬í•¨ì„ ìœ„í•´ ì•½ê°„ ë” í¬ê²Œ
  }
  
  console.log('ë“œë˜ê·¸ ê°ì§€ ì‹œì‘, threshold:', threshold, 'editMode:', editMode, 'zoom:', currentZoom, 'pos:', pos, 'baseThreshold:', baseThreshold);
  
  // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì¼ ë•ŒëŠ” ì„ íƒëœ ì ë§Œ ì²´í¬
  if(editMode && selectedPoint) {
    const pt = P[selectedPoint];
    if(pt) {
      // ë°°ìœ¨ 1ì´ì–´ë„ ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ê±°ë¦¬ ê³„ì‚° (thresholdë„ ì›ë³¸ ê¸°ì¤€)
      // posëŠ” ì´ë¯¸ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜ë˜ì–´ ìˆìŒ
      const d = Math.hypot(pt.x - pos.x, pt.y - pos.y);
      if(d < threshold) {
        bestPoint = selectedPoint;
        bestDistance = d;
        console.log('âœ… ì„ íƒëœ ì  ë“œë˜ê·¸ ì‹œì‘ (ë°°ìœ¨ ' + currentZoom + '):', selectedPoint, 'ê±°ë¦¬:', d.toFixed(2));
      } else {
        console.log('âŒ ì„ íƒëœ ì ì´ ë„ˆë¬´ ë©€ì–´ì„œ ë“œë˜ê·¸ ë¶ˆê°€:', selectedPoint, 'ê±°ë¦¬:', d.toFixed(2), 'threshold:', threshold);
      }
    }
    // ì„ íƒëœ ì ë§Œ ì²´í¬í•˜ë¯€ë¡œ ë‹¤ë¥¸ ì ì€ ì²´í¬í•˜ì§€ ì•ŠìŒ (bestPointê°€ nullì´ë©´ ë“œë˜ê·¸ ì‹œì‘ ì•ˆ ë¨)
  } else if(editMode && !selectedPoint) {
    // editModeì§€ë§Œ ì„ íƒëœ ì ì´ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ë¶ˆê°€
    console.log('âš ï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì´ì§€ë§Œ ì„ íƒëœ ì ì´ ì—†ì–´ì„œ ë“œë˜ê·¸ ë¶ˆê°€');
    return false;
  } else {
    // ì¼ë°˜ ëª¨ë“œ (editModeê°€ false): ëª¨ë“  ì  ì²´í¬ (í˜„ì¬ orientationì— ë§ëŠ” í‚¤í¬ì¸íŠ¸ ì‚¬ìš©)
    const currentKeypoints = getKeypoints();
    for(const k of currentKeypoints) {
      const p = P[k.key];
      if(!p) continue;
      
      // ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” CSS ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ê±°ë¦¬ ê³„ì‚°
        // posëŠ” ì´ë¯¸ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜ë˜ì–´ ìˆìŒ
      const d = Math.hypot(p.x - pos.x, p.y - pos.y);
      
        if(d < threshold) {
        console.log('âœ… ì¼ë°˜ ëª¨ë“œ ì  ê°ì§€:', k.key, 'ì  ì¢Œí‘œ:', p, 'í„°ì¹˜ ì¢Œí‘œ:', pos, 'ê±°ë¦¬:', d.toFixed(2), 'threshold:', threshold, 'zoom:', currentZoom);
      }
      
      if(d < threshold && d < bestDistance) {
        bestPoint = k.key;
        bestDistance = d;
      }
    }
  }
  
  // ì  ê·¼ì²˜ë¥¼ í„°ì¹˜í–ˆì„ ë•Œë§Œ ë“œë˜ê·¸ ëª¨ë“œë¡œ ì „í™˜
  // bestPointê°€ ì„¤ì •ë˜ê³  threshold ë‚´ì— ìˆì„ ë•Œë§Œ ë“œë˜ê·¸ ì‹œì‘
  if(bestPoint && bestDistance < threshold) {
    // preventDefaultëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í•˜ì§€ ì•ŠìŒ
    isScrolling = false;
    dragKey = bestPoint; // í™•ì‹¤í•˜ê²Œ ì„¤ì •
    
    // ìŠ¤í¬ë¡¤ ì‹œì‘ ìœ„ì¹˜ ì €ì¥ (ë“œë˜ê·¸ ì¤‘ì—ë„ ì‚¬ìš©)
    if(e.touches && e.touches.length > 0) {
      scrollStartX = e.touches[0].clientX;
      scrollStartY = e.touches[0].clientY;
    } else {
      scrollStartX = e.clientX;
      scrollStartY = e.clientY;
    }
    
    console.log('âœ… ë“œë˜ê·¸ ì‹œì‘ ì„±ê³µ:', bestPoint, 'ê±°ë¦¬:', bestDistance.toFixed(2), 'threshold:', threshold, 'pos:', pos, 'dragKey:', dragKey, 'editMode:', editMode, 'zoom:', currentZoom);
    return true;
  } else {
    // ì  ê·¼ì²˜ë¥¼ ëˆ„ë¥´ì§€ ì•Šì•˜ìœ¼ë©´ ë“œë˜ê·¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ
    console.log('âŒ ì  ê·¼ì²˜ë¥¼ ëˆ„ë¥´ì§€ ì•ŠìŒ, bestPoint:', bestPoint, 'ê±°ë¦¬:', bestDistance < 1e9 ? bestDistance.toFixed(2) : 'N/A', 'threshold:', threshold, 'pos:', pos);
  }
  
  // ì ì´ ì•„ë‹Œ ë¹ˆ í™”ë©´ì„ í„°ì¹˜í–ˆìœ¼ë©´ ë“œë˜ê·¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ
  // í™•ëŒ€ ëª¨ë“œì—ì„œ í•œ ì†ê°€ë½ í„°ì¹˜ëŠ” ìŠ¤í¬ë¡¤ ë¶ˆê°€ (ë‘ ì†ê°€ë½ë§Œ ìŠ¤í¬ë¡¤)
  // ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•ŠìŒ
  isScrolling = false;
  dragKey = null; // ëª…ì‹œì ìœ¼ë¡œ nullë¡œ ì„¤ì •
  return false;
}

function doDrag(e) {
  // í„°ì¹˜ ì´ë²¤íŠ¸ì¸ ê²½ìš° ì†ê°€ë½ ê°œìˆ˜ í™•ì¸
  let touchCount = 0;
  if(e.touches) {
    touchCount = e.touches.length;
  }
  
  // ë‘ ì†ê°€ë½ í„°ì¹˜: ìŠ¤í¬ë¡¤ë§Œ í—ˆìš© (í™•ëŒ€ ëª¨ë“œì—ì„œë§Œ)
  if(touchCount === 2 && editMode && currentZoom > 1) {
    e.preventDefault();
    e.stopPropagation();
    
    // ìŠ¤í¬ë¡¤ ëª¨ë“œ í™œì„±í™” í™•ì¸
    if(!isScrolling) {
      // ìŠ¤í¬ë¡¤ ëª¨ë“œê°€ ì•„ë‹ˆë©´ ì´ˆê¸°í™”í•˜ê³  ì‹œì‘
      isScrolling = true;
      dragKey = null;
    }
    
    // ë‘ ì†ê°€ë½ì˜ ì¤‘ì‹¬ì  ê³„ì‚°
    const touch1 = e.touches[0];
    const touch2 = e.touches[1];
    const currentX = (touch1.clientX + touch2.clientX) / 2;
    const currentY = (touch1.clientY + touch2.clientY) / 2;
    
    // ìŠ¤í¬ë¡¤ ì‹œì‘ ìœ„ì¹˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì„¤ì •
    if(scrollStartX === 0 && scrollStartY === 0) {
      scrollStartX = currentX;
      scrollStartY = currentY;
      return;
    }
    
    // ìŠ¤í¬ë¡¤ë§Œ ìˆ˜í–‰
    const canvasWrap = cv.parentElement;
    const deltaX = scrollStartX - currentX;
    const deltaY = scrollStartY - currentY;
    canvasWrap.scrollLeft += deltaX;
    canvasWrap.scrollTop += deltaY;
    scrollStartX = currentX;
    scrollStartY = currentY;
    return;
  }
  
  // í•œ ì†ê°€ë½ë§Œ ë“œë˜ê·¸ í—ˆìš© (ë‘ ì†ê°€ë½ ì´ìƒì´ë©´ ë¬´ì‹œ)
  if(touchCount > 1 && !(editMode && currentZoom > 1 && touchCount === 2)) {
    return;
  }
  
  // dragKeyê°€ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ì²˜ë¦¬ ì•ˆ í•¨
  if(!dragKey) {
    return;
  }
  
  // ë“œë˜ê·¸ ëª¨ë“œê°€ ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë“œë˜ê·¸ ì²˜ë¦¬ë§Œ ìˆ˜í–‰ (ìŠ¤í¬ë¡¤ ì™„ì „ ì°¨ë‹¨)
  if(dragKey) {
    e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
    e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨
    
    const pos = getEventPos(e);
    // ì¢Œí‘œëŠ” í•­ìƒ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì €ì¥
    const originalW = originalCanvasSize.width || (cv.width / DPR / (editMode ? currentZoom : 1));
    const originalH = originalCanvasSize.height || (cv.height / DPR / (editMode ? currentZoom : 1));
    const x = clamp(pos.x, 0, originalW);
    const y = clamp(pos.y, 0, originalH);
    const orientation = sessions[cur].poseData?.orientation || "side";
    const map = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
    const p = map.get(dragKey);
    
    if(!p) {
      // ì ì´ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ì¢…ë£Œ
      console.log('ì ì´ ì—†ì–´ ë“œë˜ê·¸ ì¢…ë£Œ:', dragKey);
      dragKey = null;
      isScrolling = false;
      return;
    }
    
    // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” ì„ íƒëœ ì ë§Œ ì´ë™ (ë‹¤ë¥¸ ì ì€ ì ˆëŒ€ ì´ë™ ë¶ˆê°€)
    if(editMode && selectedPoint) {
      if(dragKey !== selectedPoint) {
        // ì„ íƒëœ ì ì´ ì•„ë‹ˆë©´ ë“œë˜ê·¸ ë¬´ì‹œ
        console.log('âš ï¸ ì„ íƒëœ ì ì´ ì•„ë‹ˆë¯€ë¡œ ë“œë˜ê·¸ ë¬´ì‹œ:', 'dragKey:', dragKey, 'selectedPoint:', selectedPoint);
        dragKey = null; // ë“œë˜ê·¸ ì¢…ë£Œ
        return;
      }
    }
    
    // ì¢Œí‘œ ì—…ë°ì´íŠ¸ (ì¦‰ì‹œ ë°˜ì˜)
    p.x = x;
    p.y = y;
    
    // ì…ë ¥ í•„ë“œë„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ì›ë³¸ í¬ê¸° ê¸°ì¤€)
    if(coordX && coordY) {
      coordX.value = x.toFixed(1);
      coordY.value = y.toFixed(1);
    }
    
    // ì„ íƒëœ ì ê³¼ ì¼ì¹˜í•˜ë©´ ì¢Œí‘œ í‘œì‹œ ì—…ë°ì´íŠ¸
    if(selectedPoint === dragKey && typeof window.updateCoordDisplay === 'function') {
      window.updateCoordDisplay();
    }
    
    // ì¦‰ì‹œ í™”ë©´ ì—…ë°ì´íŠ¸
    draw();
    
    // ì‹¤ì‹œê°„ ë¶„ì„ ì—…ë°ì´íŠ¸ (throttle ì ìš©)
    if(!dragUpdateTimer) {
      dragUpdateTimer = requestAnimationFrame(() => {
        computeAll(); // ì „ì²´ ë¶„ì„ ì‹¤í–‰
        dragUpdateTimer = null;
      });
    }
    
    return; // ë“œë˜ê·¸ ëª¨ë“œì—ì„œëŠ” ìŠ¤í¬ë¡¤ ì™„ì „ ì°¨ë‹¨
  }
}

// ë“œë˜ê·¸ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸
let dragUpdateTimer = null;

function endDrag(e) {
  // Long press íƒ€ì´ë¨¸ ì •ë¦¬ (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ ì •ë¦¬ìš©)
  if(longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
  
  // ë“œë˜ê·¸ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì •ë¦¬
  if(dragUpdateTimer) {
    cancelAnimationFrame(dragUpdateTimer);
    dragUpdateTimer = null;
  }
  
  // ë“œë˜ê·¸ê°€ ëë‚˜ë©´ ìƒíƒœ ì™„ì „íˆ ì´ˆê¸°í™” (ë‹¤ìŒ ë“œë˜ê·¸ë¥¼ ìœ„í•´)
  const wasDragging = dragKey !== null;
  if(dragKey) {
    console.log('ë“œë˜ê·¸ ì¢…ë£Œ:', dragKey);
    // ìµœì¢… ë¶„ì„ ì‹¤í–‰
    computeAll();
  }
  
  // ëª¨ë“  ìƒíƒœ ì™„ì „íˆ ì´ˆê¸°í™” (ë§¤ë²ˆ í™•ì‹¤íˆ)
  dragKey = null;
  isScrolling = false;
  scrollDistance = 0;
  scrollStartX = 0;
  scrollStartY = 0;
  longPressDetected = false;
  longPressNearPoint = null;
  
  // ë§ˆìš°ìŠ¤ ìƒíƒœë„ ì´ˆê¸°í™”
  if(typeof isMouseDown !== 'undefined') {
    isMouseDown = false;
  }
  
  // ìƒíƒœ ì´ˆê¸°í™” í™•ì¸ ë¡œê·¸
  if(wasDragging) {
    console.log('ë“œë˜ê·¸ ìƒíƒœ ì´ˆê¸°í™” ì™„ë£Œ, ë‹¤ìŒ ë“œë˜ê·¸ ì¤€ë¹„ë¨');
  }
}

// ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
let isMouseDown = false;
cv.addEventListener('mousedown', (e) => {
  isMouseDown = true;
  startDrag(e);
});

window.addEventListener('mouseup', () => {
  isMouseDown = false;
  endDrag();
});

window.addEventListener('mouseleave', () => {
  isMouseDown = false;
  endDrag();
});

window.addEventListener('mousemove', (e) => {
  if(isMouseDown || dragKey) {
    doDrag(e);
  }
});

// í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ ì§€ì›)
cv.addEventListener('touchstart', (e) => {
  const touchCount = e.touches ? e.touches.length : 0;
  
  // ì´ì „ ìƒíƒœê°€ ë‚¨ì•„ìˆìœ¼ë©´ ì™„ì „íˆ ì´ˆê¸°í™” (ë“œë˜ê·¸ë“  ìŠ¤í¬ë¡¤ì´ë“ )
  // ìŠ¤í¬ë¡¤ í›„ ìƒˆë¡œìš´ ë“œë˜ê·¸ë¥¼ ìœ„í•´ ì™„ì „íˆ ì´ˆê¸°í™”
  if(dragKey || isScrolling) {
    console.log('âš ï¸ ì´ì „ ìƒíƒœê°€ ë‚¨ì•„ìˆìŒ, ì™„ì „íˆ ì •ë¦¬ - dragKey:', dragKey, 'isScrolling:', isScrolling);
    dragKey = null;
    isScrolling = false;
    scrollStartX = 0;
    scrollStartY = 0;
    scrollDistance = 0;
    // endDragë„ í˜¸ì¶œí•˜ì—¬ ì™„ì „íˆ ì •ë¦¬
    endDrag(e);
  }
  
  // ë‘ ì†ê°€ë½ ìŠ¤í¬ë¡¤ì¸ ê²½ìš° ìŠ¤í¬ë¡¤ ì‹œì‘ ìœ„ì¹˜ ì„¤ì •
  if(touchCount === 2 && editMode && currentZoom > 1) {
    const touch1 = e.touches[0];
    const touch2 = e.touches[1];
    scrollStartX = (touch1.clientX + touch2.clientX) / 2;
    scrollStartY = (touch1.clientY + touch2.clientY) / 2;
    isScrolling = true;
    dragKey = null;
    console.log('ë‘ ì†ê°€ë½ ìŠ¤í¬ë¡¤ ì‹œì‘, scrollStartX:', scrollStartX, 'scrollStartY:', scrollStartY);
    e.preventDefault();
    e.stopPropagation();
    return;
  }
  
  // í•œ ì†ê°€ë½ í„°ì¹˜ì¸ ê²½ìš°ì—ë§Œ ì  ì°¾ê¸° ì‹œë„
  if(touchCount === 1) {
    // ìƒˆë¡œìš´ í„°ì¹˜ ì‹œì‘ (ì´ì „ ìƒíƒœëŠ” ì´ë¯¸ ì´ˆê¸°í™”ë¨)
    const result = startDrag(e);
    
    // ì ì„ í„°ì¹˜í–ˆìœ¼ë©´ preventDefault
    if(result === true) {
      e.preventDefault();
      e.stopPropagation();
      console.log('í•œ ì†ê°€ë½ í„°ì¹˜ - ì  ê°ì§€ ì„±ê³µ, dragKey:', dragKey);
    } else {
      console.log('í•œ ì†ê°€ë½ í„°ì¹˜ - ì  ê°ì§€ ì‹¤íŒ¨');
    }
  }
}, {passive: false});

window.addEventListener('touchmove', (e) => {
  const touchCount = e.touches ? e.touches.length : 0;
  
  // ë‘ ì†ê°€ë½ í„°ì¹˜ì¸ ê²½ìš° ìŠ¤í¬ë¡¤ ëª¨ë“œ
  if(touchCount === 2 && editMode && currentZoom > 1) {
    e.preventDefault();
    e.stopPropagation();
    isScrolling = true;
    dragKey = null; // ìŠ¤í¬ë¡¤ ëª¨ë“œì—ì„œëŠ” ë“œë˜ê·¸ í‚¤ ì œê±°
    doDrag(e);
    return;
  }
  
  // ë‘ ì†ê°€ë½ì—ì„œ í•œ ì†ê°€ë½ìœ¼ë¡œ ë³€ê²½ëœ ê²½ìš° (ìŠ¤í¬ë¡¤ ì¢…ë£Œ)
  if(touchCount === 1 && isScrolling && editMode && currentZoom > 1) {
    // ìŠ¤í¬ë¡¤ ëª¨ë“œ ì¢…ë£Œí•˜ê³  ìƒíƒœ ì´ˆê¸°í™”
    console.log('ìŠ¤í¬ë¡¤ ëª¨ë“œ ì¢…ë£Œ (ë‘ ì†ê°€ë½ â†’ í•œ ì†ê°€ë½)');
    isScrolling = false;
    dragKey = null;
    scrollStartX = 0;
    scrollStartY = 0;
    // ë“œë˜ê·¸ ì²˜ë¦¬ ì•ˆ í•¨ (ìƒˆë¡œìš´ í„°ì¹˜ê°€ í•„ìš”)
    return;
  }
  
  // í•œ ì†ê°€ë½ í„°ì¹˜ì¸ ê²½ìš°
  if(touchCount === 1) {
    // dragKeyê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ë“œë˜ê·¸ ëª¨ë“œ (ì  ê·¼ì²˜ë¥¼ ëˆŒë €ì„ ë•Œë§Œ)
    if(dragKey) {
      e.preventDefault();
      e.stopPropagation();
      isScrolling = false; // ë“œë˜ê·¸ ì¤‘ì—ëŠ” ìŠ¤í¬ë¡¤ ì•„ë‹˜
      doDrag(e);
      return;
    }
    
    // dragKeyê°€ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ì²˜ë¦¬ ì•ˆ í•¨ (ì  ê·¼ì²˜ë¥¼ ëˆ„ë¥´ì§€ ì•Šì•˜ìŒ)
    // í™•ëŒ€ ëª¨ë“œì—ì„œë„ ë¹ˆ í™”ë©´ì„ ëˆ„ë¥´ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
    return;
  }
  
  // í„°ì¹˜ê°€ ì—†ê±°ë‚˜ 3ê°œ ì´ìƒì¸ ê²½ìš° ìƒíƒœ ì´ˆê¸°í™”
  if(touchCount === 0 || touchCount > 2) {
    isScrolling = false;
    dragKey = null;
  }
  
  // ê¸°ë³¸ ë™ì‘ì€ í—ˆìš© (ì ì´ ì•„ë‹Œ ê³³ì„ í„°ì¹˜í•œ ê²½ìš°)
}, {passive: false});

window.addEventListener('touchend', (e) => {
  // changedTouchesë¥¼ í™•ì¸í•˜ì—¬ ëë‚œ í„°ì¹˜ê°€ ìˆëŠ”ì§€ ì²´í¬
  const remainingTouches = e.touches ? e.touches.length : 0;
  const endedTouches = e.changedTouches ? e.changedTouches.length : 0;
  
  // ëª¨ë“  í„°ì¹˜ê°€ ëë‚¬ëŠ”ì§€ í™•ì¸
  if(remainingTouches === 0) {
    // ëª¨ë“  í„°ì¹˜ê°€ ëë‚¬ìœ¼ë©´ ë“œë˜ê·¸/ìŠ¤í¬ë¡¤ ì™„ì „íˆ ì¢…ë£Œ
    console.log('ëª¨ë“  í„°ì¹˜ ì¢…ë£Œ, ìƒíƒœ ì™„ì „ ì´ˆê¸°í™”');
    endDrag(e);
    // ì¶”ê°€ë¡œ í™•ì‹¤í•˜ê²Œ ì´ˆê¸°í™”
    dragKey = null;
    isScrolling = false;
    scrollStartX = 0;
    scrollStartY = 0;
    scrollDistance = 0;
  } else if(endedTouches > 0) {
    // ì¼ë¶€ í„°ì¹˜ë§Œ ëë‚¬ëŠ” ê²½ìš°
    // ë‘ ì†ê°€ë½ ìŠ¤í¬ë¡¤ ì¤‘ í•˜ë‚˜ê°€ ë–¨ì–´ì¡Œìœ¼ë©´ ìŠ¤í¬ë¡¤ ëª¨ë“œ ì¢…ë£Œ
    if(isScrolling && remainingTouches === 1) {
      console.log('ìŠ¤í¬ë¡¤ ëª¨ë“œ ì¢…ë£Œ (í•œ ì†ê°€ë½ ë‚¨ìŒ), ìƒíƒœ ì´ˆê¸°í™”');
      isScrolling = false;
      dragKey = null;
      scrollStartX = 0;
      scrollStartY = 0;
      scrollDistance = 0;
      // ë‹¤ìŒ ë“œë˜ê·¸ë¥¼ ìœ„í•´ ì™„ì „íˆ ì´ˆê¸°í™”
    } else if(remainingTouches === 1 && dragKey) {
      // ë“œë˜ê·¸ ì¤‘ì´ì—ˆëŠ”ë° í•œ ì†ê°€ë½ì´ ë‚¨ì•„ìˆìœ¼ë©´ ë“œë˜ê·¸ ê³„ì†
      // endDrag í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
    } else {
      // ê·¸ ì™¸ì˜ ê²½ìš°ëŠ” ìƒíƒœ ì´ˆê¸°í™”
      endDrag(e);
    }
  }
});
window.addEventListener('touchcancel', (e) => {
  // í„°ì¹˜ê°€ ì·¨ì†Œë˜ë©´ ë¬´ì¡°ê±´ ë“œë˜ê·¸/ìŠ¤í¬ë¡¤ ì¢…ë£Œ
  console.log('í„°ì¹˜ ì·¨ì†Œ, ìƒíƒœ ì´ˆê¸°í™”');
  endDrag(e);
});

// ì—…ë¡œë“œ (Before/After ê°ê° í•˜ë‚˜ì˜ ì‚¬ì§„ë§Œ ìœ ì§€)
["filePicker","cameraPicker"].forEach(id => {
  document.getElementById(id).addEventListener("change", async e => {
    const f = e.target.files[0];
    if(!f) return;
    
    // í˜„ì¬ ì„ íƒëœ orientationì— ë”°ë¼ ì ì ˆí•œ ì´ë¯¸ì§€ ì €ì¥
    const orientation = sessions[cur].poseData?.orientation || "side";
    const imgKey = orientation === "front" ? "imgFront" : "imgSide";
    
    const img = new Image();
    img.onerror = (e) => {
      console.error("ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:", e);
      alert("ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    };
    
    img.onload = async () => {
      console.log("ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ:", imgKey, "naturalWidth:", img.naturalWidth, "naturalHeight:", img.naturalHeight);
      
      // ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë©”ëª¨ë¦¬ ì •ë¦¬ (orientationë³„ë¡œ)
      const existingImg = sessions[cur][imgKey];
      if(existingImg && existingImg.src && existingImg.src.startsWith('blob:')) {
        URL.revokeObjectURL(existingImg.src);
      }
      
      // ìƒˆ ì´ë¯¸ì§€ë¡œ êµì²´ (orientationë³„ë¡œ ì €ì¥)
      sessions[cur][imgKey] = img;
      
      // ì›ë³¸ í¬ê¸° ì´ˆê¸°í™” (ìƒˆ ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ë¯€ë¡œ ë‹¤ì‹œ ê³„ì‚°)
      originalCanvasSize.width = 0;
      originalCanvasSize.height = 0;
      originalCanvasSize.styleWidth = 0;
      originalCanvasSize.styleHeight = 0;
      
      // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
      resizeCanvasFor(img);
      
      // í•´ë‹¹ orientationì— ë§ëŠ” í‚¤í¬ì¸íŠ¸ë§Œ ì´ˆê¸°í™”
      const currentPoints = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
      currentPoints.clear();
      
      // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ìº”ë²„ìŠ¤ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°)
      setTimeout(() => {
      draw();
      computeMetricsOnly(); // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì—ëŠ” AI ë¶„ì„ ì•ˆ í•¨
      }, 100);
      
      // í¬ì¦ˆ ê°ì§€ ìë™ ì‹¤í–‰ (ì„ íƒëœ orientation ì‚¬ìš©)
      if(typeof applyPoseDetection === 'function') {
        try {
        await applyPoseDetection(img, cur);
        } catch(err) {
          console.error("í¬ì¦ˆ ê°ì§€ ì‹¤íŒ¨:", err);
        }
      }
    };
    
    img.crossOrigin = "anonymous";
    const blobUrl = URL.createObjectURL(f);
    img.src = blobUrl;
    
    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
    e.target.value = '';
  });
});

// Reset ë²„íŠ¼
document.getElementById("btnReset").onclick = () => {
  const orientation = sessions[cur].poseData?.orientation || "side";
  const currentPoints = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
  currentPoints.clear();
  draw();
  computeMetricsOnly(); // ë¦¬ì…‹ ì‹œì—ëŠ” AI ë¶„ì„ ì•ˆ í•¨
};

// âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê¸°ëŠ¥
let calibrationMode = false;
document.getElementById("btnCalibrate").onclick = () => {
  calibrationMode = !calibrationMode;
  const panel = document.getElementById("calibrationPanel");
  const S = sessions[cur];
  
  if(calibrationMode) {
    panel.style.display = "block";
    // ì„¸ì…˜ì— ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì  ì €ì¥
    S.calibrationPoint1 = null;
    S.calibrationPoint2 = null;
    document.getElementById("calPoint1").textContent = "í´ë¦­í•˜ì—¬ ì„ íƒ";
    document.getElementById("calPoint2").textContent = "í´ë¦­í•˜ì—¬ ì„ íƒ";
    document.getElementById("calibrationResult").textContent = "";
    // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œì—ì„œëŠ” í´ë¦­ ì´ë²¤íŠ¸ë¡œ ì  ì„ íƒ
    cv.style.cursor = "crosshair";
    draw(); // ì´ˆê¸°í™”
  } else {
    panel.style.display = "none";
    cv.style.cursor = "default";
    calibrationMode = false;
    // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì  ì´ˆê¸°í™”
    S.calibrationPoint1 = null;
    S.calibrationPoint2 = null;
    draw();
  }
};

// ìº˜ë¦¬ë¸Œë ˆì´ì…˜ í´ë¦­ í•¸ë“¤ëŸ¬ (ë‹¤ë¥¸ ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€)
cv.addEventListener('click', (e) => {
  if(!calibrationMode) return;
  
  // ë‹¤ë¥¸ ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€
  e.preventDefault();
  e.stopPropagation();
  e.stopImmediatePropagation();
  
  const pos = getEventPos(e);
  const S = sessions[cur];
  
  if(!S.calibrationPoint1) {
    // ì  1 ì €ì¥
    S.calibrationPoint1 = pos;
    document.getElementById("calPoint1").textContent = `(${pos.x.toFixed(1)}, ${pos.y.toFixed(1)})`;
    draw(); // ì ì´ ì˜êµ¬ì ìœ¼ë¡œ í‘œì‹œë¨
    console.log('ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì  1:', pos);
  } else if(!S.calibrationPoint2) {
    // ì  2 ì €ì¥
    S.calibrationPoint2 = pos;
    document.getElementById("calPoint2").textContent = `(${pos.x.toFixed(1)}, ${pos.y.toFixed(1)})`;
    draw(); // ì ê³¼ ì„ ì´ ì˜êµ¬ì ìœ¼ë¡œ í‘œì‹œë¨
    console.log('ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì  2:', pos);
    
    // ë‘ ì  ì‚¬ì´ ê±°ë¦¬ ê³„ì‚°í•´ì„œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    if(S.calibrationPoint1 && S.calibrationPoint2) {
      const distPx = dist(S.calibrationPoint1, S.calibrationPoint2);
      document.getElementById("calibrationResult").textContent = 
        `ê±°ë¦¬: ${distPx.toFixed(1)}px (ì‹¤ì œ ê¸¸ì´ ì…ë ¥ í›„ ê³„ì‚° ë²„íŠ¼ í´ë¦­)`;
      document.getElementById("calibrationResult").style.color = "var(--muted)";
    }
  } else {
    // ë‘ ì  ëª¨ë‘ ì„ íƒë˜ì—ˆìœ¼ë©´ ë‹¤ì‹œ ì‹œì‘
    S.calibrationPoint1 = pos;
    S.calibrationPoint2 = null;
    document.getElementById("calPoint1").textContent = `(${pos.x.toFixed(1)}, ${pos.y.toFixed(1)})`;
    document.getElementById("calPoint2").textContent = "í´ë¦­í•˜ì—¬ ì„ íƒ";
    document.getElementById("calibrationResult").textContent = "";
    draw();
    console.log('ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì¬ì‹œì‘ - ì  1:', pos);
  }
}, true); // capture phaseì—ì„œ ë¨¼ì € ì²˜ë¦¬

document.getElementById("btnCalibrateConfirm").onclick = () => {
  const S = sessions[cur];
  if(!S.calibrationPoint1 || !S.calibrationPoint2) {
    alert("ë‘ ì ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }
  
  const realLengthCm = parseFloat(document.getElementById("calibrationLength").value);
  if(!realLengthCm || realLengthCm <= 0) {
    alert("ì‹¤ì œ ê¸¸ì´(cm)ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  
  try {
    const pxPerCm = calibratePxPerCm(S.calibrationPoint1, S.calibrationPoint2, realLengthCm);
    S.pxPerCm = pxPerCm;
    document.getElementById("calibrationResult").textContent = 
      `âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì™„ë£Œ: ${pxPerCm.toFixed(2)} px/cm`;
    document.getElementById("calibrationResult").style.color = "#2ec4b6";
    
    // ë©”íŠ¸ë¦­ ì¬ê³„ì‚°
    computeMetricsOnly();
    
    console.log(`ìº˜ë¦¬ë¸Œë ˆì´ì…˜: ${pxPerCm.toFixed(2)} px/cm`);
  } catch(err) {
    alert("ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì˜¤ë¥˜: " + err.message);
  }
};

document.getElementById("btnCalibrateCancel").onclick = () => {
  calibrationMode = false;
  document.getElementById("calibrationPanel").style.display = "none";
  const S = sessions[cur];
  S.calibrationPoint1 = null;
  S.calibrationPoint2 = null;
  cv.style.cursor = "default";
  draw();
};

// ì¢Œí‘œ ì €ì¥ (ì €ì¥ ë²„íŠ¼ - AI ë¶„ì„ ì‹¤í–‰)
document.getElementById("btnSaveJSON").onclick = () => {
  // ì €ì¥ ì „ì— AI ë¶„ì„ ì‹¤í–‰
  computeAll();
  
  const orientation = sessions[cur].poseData?.orientation || "side";
  const map = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
  const obj = Object.fromEntries(map);
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${cur}_${orientation}_keypoints.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};

// ì¢Œí‘œ ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById("btnLoadJSON").onclick = () => {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'application/json';
  inp.onchange = e => {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const obj = JSON.parse(r.result);
        const orientation = sessions[cur].poseData?.orientation || "side";
        const map = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
        map.clear();
        for(const k of Object.keys(obj)) map.set(k, obj[k]);
        draw();
        computeAll();
      } catch(err) {
        alert('JSON íŒŒì‹± ì‹¤íŒ¨: ' + err.message);
      }
    };
    r.readAsText(f);
  };
  inp.click();
};

// âœ… PDF ë‚´ë³´ë‚´ê¸° ìœ í‹¸ (í—¤ë”/í‘¸í„° í¬í•¨)
function exportAsPdf(options = {}) {
  const {
    fileName = `DIT_ìì„¸_ë¶„ì„_ë¦¬í¬íŠ¸_${cur}_${new Date().toISOString().split('T')[0]}.pdf`,
    userName = localStorage.getItem('userName') || 'ì‚¬ìš©ì',
    appName = 'DIT ìì„¸ ë¶„ì„ AI',
    logoUrl = null
  } = options;
  
  return new Promise(async (resolve, reject) => {
    try {
      const S = sessions[cur];
      const M = S.metrics || {};
      const scoreData = S.score || {};
      const analysis = S.analysis || {};
      
      // ë‚ ì§œ í¬ë§·
      const now = new Date();
      const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      
      // ì²« í˜ì´ì§€: ì œëª©ê³¼ ì´ë¯¸ì§€
      const page1Container = document.createElement("div");
      page1Container.style.position = "fixed";
      page1Container.style.left = "-9999px";
      page1Container.style.top = "0";
      page1Container.style.width = "794px"; // A4 ë„ˆë¹„ @96dpi
      page1Container.style.padding = "30px 25px";
      page1Container.style.paddingBottom = "40px";
      page1Container.style.background = "#ffffff";
      page1Container.style.color = "#111";
      page1Container.style.fontFamily = '"Noto Sans KR", Arial, sans-serif';
      page1Container.style.fontSize = "12px";
      page1Container.style.lineHeight = "1.6";
      page1Container.style.boxSizing = "border-box";
      page1Container.style.overflow = "hidden";
      page1Container.style.wordWrap = "break-word";
      
      // í†µí•© ë¶„ì„ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸° (ìš´ë™ ì¶”ì²œ í¬í•¨)
      const analysisResult = S.analysisResult || analyzePostureAutoWithRecommendation({
        sidePts: S.sidePoints.size > 0 ? Object.fromEntries(S.sidePoints) : null,
        frontPts: S.frontPoints.size > 0 ? Object.fromEntries(S.frontPoints) : null,
        pxPerCm: S.pxPerCm || 50.0
      });
      
      // ì¸¡ë©´ ë° ì •ë©´ ì´ë¯¸ì§€ ì¤€ë¹„
      const sideImg = S.imgSide ? S.imgSide.src : null;
      const frontImg = S.imgFront ? S.imgFront.src : null;
      
      // ë¡œê³  HTML (ìˆìœ¼ë©´)
      const logoHtml = logoUrl ? `<img src="${logoUrl}" style="width:32px; height:32px; margin-right:8px; vertical-align:middle;" />` : '';
      
      // ë¶„ì„ ê²°ê³¼ ìš”ì•½ HTML ìƒì„±
      const analysisSummaryHtml = buildAnalysisSummaryHtml(analysisResult);
      // ìš´ë™ ì¶”ì²œ HTML ìƒì„±
      const exerciseRecommendationHtml = buildExerciseRecommendationHtml(analysisResult);
      
      page1Container.innerHTML = `
        <!-- í—¤ë” -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #e0e0e0;">
          <div style="display:flex; align-items:center;">
            ${logoHtml}
            <span style="font-size:14px; font-weight:700; color:#0b0f14;">${appName}</span>
          </div>
          <span style="font-size:10px; color:#666;">${dateStr}</span>
        </div>
        
        <h1 style="margin:0; padding:0; font-size:24px; font-weight:800; color:#0b0f14; margin-bottom:12px; line-height:1.3; word-wrap:break-word;">DIT ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
        <div style="font-size:11px; color:#666; margin-bottom:25px; word-wrap:break-word;">ì„¸ì…˜: ${cur}</div>
        
        <!-- ë¶„ì„ ê²°ê³¼ ìš”ì•½ -->
        ${analysisSummaryHtml}
        
        ${sideImg ? `<div style="margin-top:20px;"><div style="font-size:12px; font-weight:600; margin-bottom:8px;">ì¸¡ë©´ ì´ë¯¸ì§€</div><img src="${sideImg}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; max-height:400px; object-fit:contain;" /></div>` : ''}
        
        ${frontImg ? `<div style="margin-top:20px;"><div style="font-size:12px; font-weight:600; margin-bottom:8px;">ì •ë©´ ì´ë¯¸ì§€</div><img src="${frontImg}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; max-height:400px; object-fit:contain;" /></div>` : ''}
        
        <!-- ìš´ë™ ì¶”ì²œ -->
        ${exerciseRecommendationHtml}
        
        <!-- í‘¸í„° -->
        <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
          <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
            <span>Generated by ${appName}</span>
            <span>User: ${userName}</span>
          </div>
        </div>
      `;
    
    document.body.appendChild(page1Container);
    
    // ì²« í˜ì´ì§€ ìº¡ì²˜
    const canvas1 = await html2canvas(page1Container, {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true,
      allowTaint: true,
      logging: false,
      windowWidth: page1Container.scrollWidth,
      windowHeight: page1Container.scrollHeight
    });
    
    document.body.removeChild(page1Container);
    
    // ë‘ ë²ˆì§¸ í˜ì´ì§€: ì²´í˜• ì¢…í•© ì ìˆ˜ë¶€í„° ì‹œì‘
    const page2Container = document.createElement("div");
    page2Container.style.position = "fixed";
    page2Container.style.left = "-9999px";
    page2Container.style.top = "0";
    page2Container.style.width = "794px";
    page2Container.style.padding = "30px 25px";
    page2Container.style.paddingBottom = "40px";
    page2Container.style.background = "#ffffff";
    page2Container.style.color = "#111";
    page2Container.style.fontFamily = '"Noto Sans KR", Arial, sans-serif';
    page2Container.style.fontSize = "12px";
    page2Container.style.lineHeight = "1.6";
    page2Container.style.boxSizing = "border-box";
    page2Container.style.overflow = "hidden";
    page2Container.style.wordWrap = "break-word";
    
    page2Container.innerHTML = `
      <div style="margin-bottom:25px; padding:18px; background:#f5f5f5; border-radius:10px; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:16px; font-weight:700; margin-bottom:12px; line-height:1.4; word-wrap:break-word;">ğŸ“Š ì²´í˜• ì¢…í•© ì ìˆ˜</div>
        <div style="font-size:42px; font-weight:800; color:${scoreData.score >= 85 ? '#2ec4b6' : scoreData.score >= 70 ? '#ffd166' : '#ff6b6b'}; margin-bottom:10px; line-height:1.2;">${scoreData.score != null ? scoreData.score : 'â€”'}</div>
        <div style="font-size:11px; color:#666; line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;">${scoreData.reasons && scoreData.reasons.length > 0 ? scoreData.reasons.join(", ") : "ëª¨ë“  ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤."}</div>
      </div>
      
      <div style="margin-bottom:25px; box-sizing:border-box;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px;">ğŸ“ ì¸¡ì • ê°ë„</div>
        <table style="width:100%; border-collapse:collapse; font-size:12px; table-layout:fixed;">
          <tr style="background:#f0f0f0;"><th style="padding:10px 8px; text-align:left; border:1px solid #ddd; font-weight:600; word-wrap:break-word;">í•­ëª©</th><th style="padding:10px 8px; text-align:left; border:1px solid #ddd; font-weight:600; word-wrap:break-word;">ì¸¡ì •ê°’</th><th style="padding:10px 8px; text-align:left; border:1px solid #ddd; font-weight:600; word-wrap:break-word;">ì •ìƒ ë²”ìœ„</th></tr>
          <tr><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">CVA</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">${M.cva != null ? M.cva.toFixed(1) + "Â°" : "â€”"}</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">â‰¥50Â°</td></tr>
          <tr style="background:#fafafa;"><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">TRUNK</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">${M.pelvic != null ? M.pelvic.toFixed(1) + "Â°" : "â€”"}</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">|0â€“5Â°|</td></tr>
          <tr><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">KNEE</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">${M.knee != null ? M.knee.toFixed(1) + "Â°" : "â€”"}</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">175â€“185Â°</td></tr>
        </table>
      </div>
      
      ${analysis.comments && analysis.comments.length > 0 ? `
      <div style="margin-bottom:25px; padding:18px; background:#e8f5e9; border-radius:10px; border-left:4px solid #2ec4b6; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:14px; font-weight:700; margin-bottom:10px; color:#2ec4b6; line-height:1.4; word-wrap:break-word;">ğŸ¤– AI ì‹¤ì‹œê°„ ë¶„ì„</div>
        <div style="font-size:12px; line-height:1.6; word-wrap:break-word; overflow-wrap:break-word;">${analysis.comments.join(" ")}</div>
        ${analysis.details && analysis.details.length > 0 ? `<div style="margin-top:12px; font-size:11px; line-height:1.6; color:#555; word-wrap:break-word; overflow-wrap:break-word;">${analysis.details.join("<br>")}</div>` : ""}
      </div>
      ` : ""}
      
      ${(analysis.tight && analysis.tight.length > 0) || (analysis.weak && analysis.weak.length > 0) ? `
      <div style="margin-bottom:25px; padding:18px; background:#fff3e0; border-radius:10px; border-left:4px solid #ffb86c; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#ffb86c; line-height:1.4; word-wrap:break-word;">ğŸ’ª ê·¼ìœ¡ ìƒíƒœ ë¶„ì„</div>
        ${analysis.tight && analysis.tight.length > 0 ? `<div style="margin-bottom:10px; line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;"><strong style="color:#ff6b6b;">ğŸ”´ ê¸´ì¥ëœ ê·¼ìœ¡:</strong> <span style="font-size:12px;">${analysis.tight.join(", ")}</span></div>` : ""}
        ${analysis.weak && analysis.weak.length > 0 ? `<div style="line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;"><strong style="color:#7c9cff;">ğŸ”µ ì•½í™”ëœ ê·¼ìœ¡:</strong> <span style="font-size:12px;">${analysis.weak.join(", ")}</span></div>` : ""}
      </div>
      ` : ""}
      
      ${analysis.exercises && analysis.exercises.length > 0 ? `
      <div style="margin-bottom:25px; padding:18px; background:#e0f2f1; border-radius:10px; border-left:4px solid #2ec4b6; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#2ec4b6; line-height:1.4; word-wrap:break-word;">ğŸ‹ï¸ ì¶”ì²œ ìš´ë™</div>
        <div style="font-size:12px; line-height:1.8; word-wrap:break-word; overflow-wrap:break-word;">${analysis.exercises.map(ex => `<div style="margin-bottom:8px;">${ex}</div>`).join("")}</div>
      </div>
      ` : ""}
      
      <div style="margin-top:25px; padding:18px; background:#f5f5f5; border-radius:10px; font-size:11px; color:#666; box-sizing:border-box; overflow:hidden;">
        <div style="margin-bottom:8px; line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;"><strong>Before ì¸¡ì •ê°’:</strong> CVA ${fmtDeg(sessions.Before.metrics.cva)}, TRUNK ${fmtDeg(sessions.Before.metrics.pelvic)}, KNEE ${fmtDeg(sessions.Before.metrics.knee)}</div>
        <div style="line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;"><strong>After ì¸¡ì •ê°’:</strong> CVA ${fmtDeg(sessions.After.metrics.cva)}, TRUNK ${fmtDeg(sessions.After.metrics.pelvic)}, KNEE ${fmtDeg(sessions.After.metrics.knee)}</div>
      </div>
      
      <div style="margin-top:20px; font-size:10px; color:#999; text-align:center; line-height:1.5;">â€» ë³¸ ë¦¬í¬íŠ¸ëŠ” êµìœ¡ìš©ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤. ì˜ë£Œ ì§„ë‹¨ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    `;
    
    document.body.appendChild(page2Container);
    
    // ë‘ ë²ˆì§¸ í˜ì´ì§€ ìº¡ì²˜
    const canvas2 = await html2canvas(page2Container, {
      scale: 3, // ê³ í•´ìƒë„
      backgroundColor: "#ffffff",
      useCORS: true,
      allowTaint: true,
      logging: false,
      windowWidth: page2Container.scrollWidth,
      windowHeight: page2Container.scrollHeight
    });
    
    document.body.removeChild(page2Container);
    
    // PDF ìƒì„± (ë§ˆì§„ 24px = ì•½ 0.6cm)
    const pdf = new jsPDF({orientation:"portrait", unit:"px", format:"a4"});
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const margin = 24; // Dart ì½”ë“œì˜ margin: EdgeInsets.all(24)ì™€ ë™ì¼
    const imgW = pageW - (margin * 2);
    
    // ì²« í˜ì´ì§€: ì œëª©ê³¼ ì´ë¯¸ì§€
    const img1H = canvas1.height * (imgW / canvas1.width);
    const maxImg1H = pageH - (margin * 2);
    if(img1H <= maxImg1H) {
      pdf.addImage(canvas1.toDataURL("image/png"), "PNG", margin, margin, imgW, img1H);
    } else {
      // ì´ë¯¸ì§€ê°€ í¬ë©´ ìë¥´ê¸°
      pdf.addImage(canvas1.toDataURL("image/png"), "PNG", margin, margin, imgW, maxImg1H);
    }
    
    // ë‘ ë²ˆì§¸ í˜ì´ì§€: ì²´í˜• ì¢…í•© ì ìˆ˜ë¶€í„°
    pdf.addPage();
    const img2H = canvas2.height * (imgW / canvas2.width);
    const maxImg2H = pageH - (margin * 2);
    if(img2H <= maxImg2H) {
      pdf.addImage(canvas2.toDataURL("image/png"), "PNG", margin, margin, imgW, img2H);
    } else {
      // ê¸´ ë‚´ìš©ì€ ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë¶„í• 
      let remaining = img2H, sY = 0;
      const onePageH = maxImg2H;
      const sliceH = canvas2.height * (onePageH / img2H);
      while(remaining > 0) {
        const pageCanvas = document.createElement("canvas");
        pageCanvas.width = canvas2.width;
        pageCanvas.height = Math.min(sliceH, canvas2.height - sY);
        const pctx = pageCanvas.getContext("2d");
        pctx.drawImage(canvas2, 0, sY, canvas2.width, pageCanvas.height, 0, 0, canvas2.width, pageCanvas.height);
        const pageImg = pageCanvas.toDataURL("image/png");
        pdf.addImage(pageImg, "PNG", margin, margin, imgW, onePageH * (pageCanvas.height / sliceH));
        remaining -= onePageH;
        sY += sliceH;
        if(remaining > 0) pdf.addPage();
      }
    }
    
    pdf.save(fileName);
    
    resolve();
  } catch(error) {
    console.error("PDF ìƒì„± ì‹¤íŒ¨:", error);
    reject(error);
  }
  });
}

// PDF ì €ì¥ (ëª¨ë°”ì¼ ìµœì í™”, í˜ì´ì§€ ë¶„ë¦¬)
document.getElementById("btnPDF").onclick = async () => {
  try {
    // ëª¨ë°”ì¼ì—ì„œ ë¡œë”© í‘œì‹œ
    const btn = document.getElementById("btnPDF");
    const originalText = btn.textContent;
    btn.textContent = "â³ PDF ìƒì„± ì¤‘...";
    btn.disabled = true;
    
    // ì‚¬ìš©ìëª… ì…ë ¥ ë°›ê¸° (í•œ ë²ˆë§Œ)
    let userName = localStorage.getItem('userName');
    if(!userName) {
      userName = prompt("ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ë‚˜ì¤‘ì— ë³€ê²½ ê°€ëŠ¥):", "ì‚¬ìš©ì") || "ì‚¬ìš©ì";
      localStorage.setItem('userName', userName);
    }
    
    await exportAsPdf({
      userName: userName,
      appName: 'DIT ìì„¸ ë¶„ì„ AI'
    });
    
    btn.textContent = originalText;
    btn.disabled = false;
    
    // ëª¨ë°”ì¼ì—ì„œ ì„±ê³µ ë©”ì‹œì§€
    if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
      alert("PDFê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }
  } catch(error) {
    console.error("PDF ìƒì„± ì‹¤íŒ¨:", error);
    alert("PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    const btn = document.getElementById("btnPDF");
    btn.textContent = "ğŸ“„ PDF ì €ì¥";
    btn.disabled = false;
  }
};

// ê·¸ë¦¼ìœ¼ë¡œ ì €ì¥ (ì „ì²´ ë‚´ìš© í¬í•¨)
document.getElementById("btnImage").onclick = async () => {
  try {
    // ëª¨ë°”ì¼ì—ì„œ ë¡œë”© í‘œì‹œ
    const btn = document.getElementById("btnImage");
    const originalText = btn.textContent;
    btn.textContent = "â³ ì´ë¯¸ì§€ ìƒì„± ì¤‘...";
    btn.disabled = true;
    
    const S = sessions[cur];
    const fullMetrics = S.metrics?.fullMetrics || {};
    const scoreData = S.score || {};
    const analysis = S.analysis || {};
    
    // ì „ì²´ ì»¨í…Œì´ë„ˆ ìƒì„± (ëª¨ë“  ë‚´ìš© í¬í•¨)
    const fullContainer = document.createElement("div");
    fullContainer.style.position = "fixed";
    fullContainer.style.left = "-9999px";
    fullContainer.style.top = "0";
    fullContainer.style.width = "794px"; // A4 ë„ˆë¹„ @96dpi
    fullContainer.style.padding = "30px 25px";
    fullContainer.style.paddingBottom = "40px";
    fullContainer.style.background = "#ffffff";
    fullContainer.style.color = "#111";
    fullContainer.style.fontFamily = '"Noto Sans KR", Arial, sans-serif';
    fullContainer.style.fontSize = "12px";
    fullContainer.style.lineHeight = "1.6";
    fullContainer.style.boxSizing = "border-box";
    fullContainer.style.wordWrap = "break-word";
    
    // ìº”ë²„ìŠ¤ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
    const cvImg = cv.toDataURL("image/png");
    
    // ì „ì²´ ë¶„ì„ í•­ëª© HTML ìƒì„±
    const metricsOrder = [
      // ì¸¡ë©´ í•­ëª©
      {key: 'CVA', name: 'CVA(ë‘ê°œê²½ì¶”ê°)', unit: 'Â°', normal: 'â‰¥50Â°'},
      {key: 'HPD', name: 'HPD(ë‘ë¶€ì „ë°©ì´ë™)', unit: 'cm', normal: 'â‰¤2cm'},
      {key: 'NIA', name: 'NIA(ê²½ì¶”ê²½ì‚¬ê°)', unit: 'Â°', normal: '0-20Â°'},
      {key: 'TIA', name: 'TIA(ì²´ê°„ê²½ì‚¬ê°)', unit: 'Â°', normal: '0-10Â°'},
      {key: 'SAA', name: 'SAA(ì–´ê¹¨ì „ë°©ê°)', unit: 'Â°', normal: '0-10Â°'},
      {key: 'PTA', name: 'PTA(ê³¨ë°˜ ì „í›„ê²½ì‚¬ê°)', unit: 'Â°', normal: '0-15Â°'},
      {key: 'KA', name: 'KA(ë¬´ë¦ê°)', unit: 'Â°', normal: '175-185Â°'},
      {key: 'Tibial_Angle', name: 'Tibial(ê²½ê³¨ê²½ì‚¬ê°)', unit: 'Â°', normal: '0-10Â°'},
      {key: 'Knee_Deviation', name: 'Knee Dev(ë¬´ë¦í¸ìœ„)', unit: 'Â°', normal: '0-3Â°'},
      {key: 'LLD', name: 'LLD(í•˜ì§€ê¸¸ì´ì°¨)', unit: 'cm', normal: 'â‰¤1cm'},
      {key: 'GSB', name: 'GSB(ì¤‘ë ¥ì¤‘ì‹¬ì„ )', unit: 'cm', normal: 'â‰¤2cm'},
      {key: 'BVA', name: 'BVA(ì²´ì¤‘ì „ë°©ì´ë™)', unit: 'cm', normal: 'â‰¤2cm'},
      {key: 'SCI', name: 'SCI(ì²™ì¶”ê³¡ë¥ ì§€ìˆ˜)', unit: '', normal: '0.15-0.35'},
      {key: 'HPA', name: 'HPA(ê³ ê´€ì ˆê°)', unit: 'Â°', normal: '0-10Â°'},
      {key: 'PDS', name: 'PDS(ìì„¸ì ìˆ˜)', unit: 'ì ', normal: 'ì •ìƒ'},
      // ì •ë©´ í•­ëª©
      {key: 'STA_F', altKey: 'STA', name: 'STA(ì–´ê¹¨ê¸°ìš¸ê¸°ê°)', unit: 'Â°', normal: 'â‰¤3Â°'},
      {key: 'POA_F', altKey: 'POA', name: 'POA(ê³¨ë°˜ê¸°ìš¸ê¸°ê°)', unit: 'Â°', normal: 'â‰¤3Â°'},
      {key: 'LLD_F', name: 'LLD(í•˜ì§€ê¸¸ì´ì°¨)', unit: 'cm', normal: 'â‰¤1cm'},
      {key: 'TD', name: 'TD(ì²´ê°„í¸ìœ„)', unit: 'Â°', normal: '0-3Â°'},
      {key: 'HTA', name: 'HTA(ë¨¸ë¦¬ê¸°ìš¸ê¸°ê°)', unit: 'Â°', normal: 'â‰¤3Â°'},
      {key: 'SPP', name: 'SPP(ì–´ê¹¨ê³¨ë°˜í‰í–‰ë„)', unit: 'Â°', normal: '0-3Â°'},
      {key: 'Q_Angle', name: 'Q-Angle(Qê°)', unit: 'Â°', normal: '10-20Â°'},  // ì •ë©´ ë¶„ì„ í•­ëª©ìœ¼ë¡œ ì´ë™
      {key: 'KAS', name: 'KAS(ë¬´ë¦ì •ë ¬ëŒ€ì¹­ì„±)', unit: 'Â°', normal: '0-3Â°'},
      {key: 'LLAS', name: 'LLAS(í•˜ì§€ì¶•ëŒ€ì¹­ì„±)', unit: 'Â°', normal: '0-3Â°'},
      {key: 'FBA', name: 'FBA(ë°œì •ë ¬ê°)', unit: 'Â°', normal: '0-3Â°'}
    ];
    
    let allMetricsHTML = '';
    metricsOrder.forEach(m => {
      // ì •ë©´ í•­ëª©ì˜ ê²½ìš° í•˜ìœ„ í˜¸í™˜ì„± í‚¤ í™•ì¸
      const metricKey = m.altKey && !fullMetrics[m.key] ? m.altKey : m.key;
      const metric = fullMetrics[metricKey] || fullMetrics[m.key];
      if(metric && metric.value != null) {
        const value = metric.value;
        const status = metric.status || 'unknown';
        const statusColor = status === 'normal' ? '#2ec4b6' : status === 'mild' ? '#ffd166' : status === 'moderate' ? '#ffb86c' : '#ff6b6b';
        const statusText = status === 'normal' ? 'âœ“' : status === 'mild' ? 'âš ' : status === 'moderate' ? 'âš âš ' : status === 'severe' ? 'âœ—' : '?';
        allMetricsHTML += `
          <tr>
            <td style="padding:8px; border:1px solid #ddd; word-wrap:break-word;">${m.name}</td>
            <td style="padding:8px; border:1px solid #ddd; word-wrap:break-word; color:${statusColor};"><strong>${value.toFixed(1)}${m.unit}</strong> ${statusText}</td>
            <td style="padding:8px; border:1px solid #ddd; word-wrap:break-word;">${m.normal}</td>
          </tr>
        `;
      }
    });
    
    // Before/After ë¹„êµ HTML ìƒì„±
    const B = sessions.Before;
    const A = sessions.After;
    let compareHTML = '';
    metricsOrder.forEach(m => {
      // ì •ë©´ í•­ëª©ì˜ ê²½ìš° í•˜ìœ„ í˜¸í™˜ì„± í‚¤ í™•ì¸
      const bKey = m.altKey && !B.metrics?.fullMetrics?.[m.key] ? m.altKey : m.key;
      const aKey = m.altKey && !A.metrics?.fullMetrics?.[m.key] ? m.altKey : m.key;
      const bVal = B.metrics?.fullMetrics?.[bKey]?.value || B.metrics?.fullMetrics?.[m.key]?.value;
      const aVal = A.metrics?.fullMetrics?.[aKey]?.value || A.metrics?.fullMetrics?.[m.key]?.value;
      if(bVal != null || aVal != null) {
        const delta = (aVal != null && bVal != null) ? (aVal - bVal) : null;
        const deltaStr = delta != null ? (delta >= 0 ? '+' : '') + delta.toFixed(1) + m.unit : 'â€”';
        compareHTML += `
          <tr>
            <td style="padding:8px; border:1px solid #ddd; word-wrap:break-word;">${m.name}</td>
            <td style="padding:8px; border:1px solid #ddd; word-wrap:break-word;">${bVal != null ? bVal.toFixed(1) + m.unit : 'â€”'}</td>
            <td style="padding:8px; border:1px solid #ddd; word-wrap:break-word;">${aVal != null ? aVal.toFixed(1) + m.unit : 'â€”'}</td>
            <td style="padding:8px; border:1px solid #ddd; word-wrap:break-word; color:${delta != null && delta < 0 ? '#2ec4b6' : delta != null && delta > 0 ? '#ff6b6b' : '#666'};">${deltaStr}</td>
            <td style="padding:8px; border:1px solid #ddd; word-wrap:break-word;">${m.normal}</td>
          </tr>
        `;
      }
    });
    
    // í•„ë¼í…ŒìŠ¤ ì¶”ì²œ HTML ìƒì„±
    let pilatesHTML = '';
    if(analysis.pilates && analysis.pilates.length > 0) {
      analysis.pilates.forEach(item => {
        pilatesHTML += `<div style="margin-bottom:15px; padding:12px; background:#f9f9f9; border-radius:8px; border-left:3px solid #9c88ff;">`;
        pilatesHTML += `<div style="font-size:13px; font-weight:600; margin-bottom:8px; color:#9c88ff;">${item.issue} (${item.muscles.join(', ')})</div>`;
        const tools = ['ë§¤íŠ¸', 'ë¦¬í¬ë¨¸', 'ìºë”œë½', 'ì²´ì–´', 'ë°”ë '];
        tools.forEach(tool => {
          if(item.pilates[tool] && item.pilates[tool].length > 0) {
            pilatesHTML += `<div style="margin-top:6px; font-size:11px;"><strong>${tool}:</strong> ${item.pilates[tool].join(', ')}</div>`;
          }
        });
        pilatesHTML += `</div>`;
      });
    }
    
    fullContainer.innerHTML = `
      <h1 style="margin:0; padding:0; font-size:24px; font-weight:800; color:#0b0f14; margin-bottom:12px; line-height:1.3;">DIT ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
      <div style="font-size:11px; color:#666; margin-bottom:25px;">${new Date().toLocaleString('ko-KR')} | ì„¸ì…˜: ${cur}</div>
      
      <!-- ì´ë¯¸ì§€ -->
      <img src="${cvImg}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; margin-bottom:30px; max-height:950px; object-fit:contain;" />
      
      <!-- ì²´í˜• ì¢…í•© ì ìˆ˜ -->
      <div style="margin-bottom:25px; padding:18px; background:#f5f5f5; border-radius:10px;">
        <div style="font-size:16px; font-weight:700; margin-bottom:12px;">ğŸ“Š ì²´í˜• ì¢…í•© ì ìˆ˜</div>
        <div style="font-size:42px; font-weight:800; color:${scoreData.score >= 85 ? '#2ec4b6' : scoreData.score >= 70 ? '#ffd166' : '#ff6b6b'}; margin-bottom:10px;">${scoreData.score != null ? scoreData.score : 'â€”'}</div>
        <div style="font-size:11px; color:#666; line-height:1.5;">${scoreData.reasons && scoreData.reasons.length > 0 ? scoreData.reasons.join("<br>") : "ëª¨ë“  ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤."}</div>
        ${fullMetrics.PDS ? `<div style="margin-top:10px; font-size:12px; color:#666;">PDS: <strong style="color:#7c9cff;">${fullMetrics.PDS.value.toFixed(1)}</strong> (${fullMetrics.PDS.status})</div>` : ''}
      </div>
      
      <!-- ì „ì²´ ë¶„ì„ í•­ëª© -->
      ${allMetricsHTML ? `
      <div style="margin-bottom:25px;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px;">ğŸ“Š ì „ì²´ ë¶„ì„ í•­ëª© (16ê°€ì§€)</div>
        <table style="width:100%; border-collapse:collapse; font-size:11px;">
          <tr style="background:#f0f0f0;">
            <th style="padding:8px; text-align:left; border:1px solid #ddd; font-weight:600;">í•­ëª©</th>
            <th style="padding:8px; text-align:left; border:1px solid #ddd; font-weight:600;">ì¸¡ì •ê°’</th>
            <th style="padding:8px; text-align:left; border:1px solid #ddd; font-weight:600;">ì •ìƒ ë²”ìœ„</th>
          </tr>
          ${allMetricsHTML}
        </table>
      </div>
      ` : ''}
      
      <!-- Before/After ë¹„êµ -->
      ${compareHTML ? `
      <div style="margin-bottom:25px;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px;">ğŸ“Š Before/After ë¹„êµ</div>
        <table style="width:100%; border-collapse:collapse; font-size:11px;">
          <tr style="background:#f0f0f0;">
            <th style="padding:8px; text-align:left; border:1px solid #ddd; font-weight:600;">í•­ëª©</th>
            <th style="padding:8px; text-align:left; border:1px solid #ddd; font-weight:600;">Before</th>
            <th style="padding:8px; text-align:left; border:1px solid #ddd; font-weight:600;">After</th>
            <th style="padding:8px; text-align:left; border:1px solid #ddd; font-weight:600;">ë³€í™”</th>
            <th style="padding:8px; text-align:left; border:1px solid #ddd; font-weight:600;">ì •ìƒ</th>
          </tr>
          ${compareHTML}
        </table>
      </div>
      ` : ''}
      
      <!-- AI ë¶„ì„ -->
      ${analysis.comments && analysis.comments.length > 0 ? `
      <div style="margin-bottom:25px; padding:18px; background:#e8f5e9; border-radius:10px; border-left:4px solid #2ec4b6;">
        <div style="font-size:14px; font-weight:700; margin-bottom:10px; color:#2ec4b6;">ğŸ¤– AI ì²´í˜• ë¶„ì„</div>
        <div style="font-size:12px; line-height:1.6;">${analysis.comments.join(" ")}</div>
      </div>
      ` : ''}
      
      <!-- ê·¼ìœ¡ ìƒíƒœ -->
      ${(analysis.tight && analysis.tight.length > 0) || (analysis.weak && analysis.weak.length > 0) ? `
      <div style="margin-bottom:25px; padding:18px; background:#fff3e0; border-radius:10px; border-left:4px solid #ffb86c;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#ffb86c;">ğŸ’ª ê·¼ìœ¡ ìƒíƒœ ë¶„ì„</div>
        ${analysis.tight && analysis.tight.length > 0 ? `<div style="margin-bottom:10px; line-height:1.5;"><strong style="color:#ff6b6b;">ğŸ”´ ê¸´ì¥ëœ ê·¼ìœ¡:</strong> <span style="font-size:12px;">${analysis.tight.join(", ")}</span></div>` : ''}
        ${analysis.weak && analysis.weak.length > 0 ? `<div style="line-height:1.5;"><strong style="color:#7c9cff;">ğŸ”µ ì•½í™”ëœ ê·¼ìœ¡:</strong> <span style="font-size:12px;">${analysis.weak.join(", ")}</span></div>` : ''}
      </div>
      ` : ''}
      
      <!-- í•„ë¼í…ŒìŠ¤ ì¶”ì²œ -->
      ${pilatesHTML ? `
      <div style="margin-bottom:25px; padding:18px; background:#f3e5f5; border-radius:10px; border-left:4px solid #9c88ff;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#9c88ff;">ğŸ§˜ í•„ë¼í…ŒìŠ¤ ì„¸ì…˜ ì¶”ì²œ</div>
        ${pilatesHTML}
      </div>
      ` : ''}
      
      <!-- ì¶”ì²œ ìš´ë™ -->
      ${analysis.exercises && analysis.exercises.length > 0 ? `
      <div style="margin-bottom:25px; padding:18px; background:#e0f2f1; border-radius:10px; border-left:4px solid #2ec4b6;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#2ec4b6;">ğŸ‹ï¸ ì¶”ì²œ ìš´ë™</div>
        <div style="font-size:12px; line-height:1.8;">${analysis.exercises.map(ex => `<div style="margin-bottom:8px;">${ex}</div>`).join("")}</div>
      </div>
      ` : ''}
      
      <div style="margin-top:30px; font-size:10px; color:#999; text-align:center;">â€» ë³¸ ë¦¬í¬íŠ¸ëŠ” êµìœ¡ìš©ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤. ì˜ë£Œ ì§„ë‹¨ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    `;
    
    document.body.appendChild(fullContainer);
    
    // ì „ì²´ ì»¨í…Œì´ë„ˆ ìº¡ì²˜
    const fullCanvas = await html2canvas(fullContainer, {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true,
      allowTaint: true,
      logging: false,
      windowWidth: fullContainer.scrollWidth,
      windowHeight: fullContainer.scrollHeight
    });
    
    document.body.removeChild(fullContainer);
    
    // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
    const imgData = fullCanvas.toDataURL("image/png");
    const link = document.createElement("a");
    link.href = imgData;
    link.download = `DIT_ìì„¸_ë¶„ì„_ë¦¬í¬íŠ¸_${cur}_${new Date().toISOString().split('T')[0]}.png`;
    link.click();
    
    btn.textContent = originalText;
    btn.disabled = false;
    
    // ëª¨ë°”ì¼ì—ì„œ ì„±ê³µ ë©”ì‹œì§€
    if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
      alert("ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }
  } catch(error) {
    console.error("ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:", error);
    alert("ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    const btn = document.getElementById("btnImage");
    btn.textContent = "ğŸ–¼ï¸ ê·¸ë¦¼ìœ¼ë¡œ ì €ì¥";
    btn.disabled = false;
  }
};

// ê³µìœ í•˜ê¸° (Web Share API ì‚¬ìš©)
document.getElementById("btnShare").onclick = async () => {
  try {
    const btn = document.getElementById("btnShare");
    const originalText = btn.textContent;
    btn.textContent = "â³ ì¤€ë¹„ ì¤‘...";
    btn.disabled = true;
    
    const S = sessions[cur];
    const M = S.metrics || {};
    const scoreData = S.score || {};
    const analysis = S.analysis || {};
    
    // ê³µìœ í•  ì´ë¯¸ì§€ ìƒì„± (ê°„ë‹¨í•œ ë²„ì „)
    const cvImg = cv.toDataURL("image/png");
    
    // ê³µìœ í•  í…ìŠ¤íŠ¸ ìƒì„±
    const shareText = `DIT ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸ - ${cur}\n\n` +
      `ğŸ“Š ì²´í˜• ì¢…í•© ì ìˆ˜: ${scoreData.score != null ? scoreData.score : 'â€”'}\n` +
      `ğŸ“ ì¸¡ì • ê°ë„:\n` +
      `  - CVA: ${M.cva != null ? M.cva.toFixed(1) + "Â°" : "â€”"} (ì •ìƒ: â‰¥50Â°)\n` +
      `  - TRUNK: ${M.pelvic != null ? M.pelvic.toFixed(1) + "Â°" : "â€”"} (ì •ìƒ: |0â€“5Â°|)\n` +
      `  - KNEE: ${M.knee != null ? M.knee.toFixed(1) + "Â°" : "â€”"} (ì •ìƒ: 175â€“185Â°)\n\n` +
      `${analysis.comments && analysis.comments.length > 0 ? analysis.comments.join(" ") + "\n\n" : ""}` +
      `${analysis.tight && analysis.tight.length > 0 ? "ğŸ”´ ê¸´ì¥ëœ ê·¼ìœ¡: " + analysis.tight.join(", ") + "\n" : ""}` +
      `${analysis.weak && analysis.weak.length > 0 ? "ğŸ”µ ì•½í™”ëœ ê·¼ìœ¡: " + analysis.weak.join(", ") + "\n" : ""}` +
      `\nâ€» ë³¸ ë¦¬í¬íŠ¸ëŠ” êµìœ¡ìš©ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.`;
    
    // Web Share API ì§€ì› ì—¬ë¶€ í™•ì¸
    if (navigator.share) {
      // ì´ë¯¸ì§€ íŒŒì¼ ìƒì„±
      const response = await fetch(cvImg);
      const blob = await response.blob();
      const file = new File([blob], `DIT_ìì„¸_ë¶„ì„_${cur}_${new Date().toISOString().split('T')[0]}.png`, { type: 'image/png' });
      
      // ê³µìœ  ì‹œë„
      try {
        await navigator.share({
          title: `DIT ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸ - ${cur}`,
          text: shareText,
          files: [file]
        });
        
        btn.textContent = originalText;
        btn.disabled = false;
      } catch (shareError) {
        // ì‚¬ìš©ìê°€ ê³µìœ ë¥¼ ì·¨ì†Œí–ˆê±°ë‚˜ ì—ëŸ¬ ë°œìƒ
        if (shareError.name !== 'AbortError') {
          console.error('ê³µìœ  ì‹¤íŒ¨:', shareError);
          // í´ë°±: ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
          const link = document.createElement('a');
          link.href = cvImg;
          link.download = `DIT_ìì„¸_ë¶„ì„_${cur}_${new Date().toISOString().split('T')[0]}.png`;
          link.click();
        }
        btn.textContent = originalText;
        btn.disabled = false;
      }
    } else {
      // Web Share APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš°: í´ë¦½ë³´ë“œì— ë³µì‚¬
      try {
        // í…ìŠ¤íŠ¸ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬
        await navigator.clipboard.writeText(shareText);
        
        // ì´ë¯¸ì§€ë„ ë‹¤ìš´ë¡œë“œ
        const link = document.createElement('a');
        link.href = cvImg;
        link.download = `DIT_ìì„¸_ë¶„ì„_${cur}_${new Date().toISOString().split('T')[0]}.png`;
        link.click();
        
        alert('ë¶„ì„ ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆê³  ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n\në‹¤ë¥¸ ì•±ì— ë¶™ì—¬ë„£ì–´ ê³µìœ í•˜ì„¸ìš”.');
        btn.textContent = originalText;
        btn.disabled = false;
      } catch (clipboardError) {
        console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', clipboardError);
        // ìµœì¢… í´ë°±: ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œë§Œ
        const link = document.createElement('a');
        link.href = cvImg;
        link.download = `DIT_ìì„¸_ë¶„ì„_${cur}_${new Date().toISOString().split('T')[0]}.png`;
        link.click();
        alert('ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ê³µìœ í•´ì£¼ì„¸ìš”.');
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }
  } catch (error) {
    console.error("ê³µìœ  ì‹¤íŒ¨:", error);
    alert("ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    const btn = document.getElementById("btnShare");
    btn.textContent = "ğŸ“¤ ê³µìœ í•˜ê¸°";
    btn.disabled = false;
  }
};

// ì‹¤ì‹œê°„ ë¶„ì„ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (UI ì—…ë°ì´íŠ¸)
// ì£¼ì„: updateLiveAnalysisUI í•¨ìˆ˜ê°€ í•„ìš”í•  ê²½ìš° ì—¬ê¸°ì— êµ¬í˜„
// liveAnalyzer.addListener((result) => {
//   // UI ì—…ë°ì´íŠ¸ ë¡œì§
//   console.log("ì‹¤ì‹œê°„ ë¶„ì„ ê²°ê³¼:", result);
// });

// ì´ˆê¸°í™”
resizeCanvasFor(null);
draw();
computeMetricsOnly(); // ì´ˆê¸°í™” ì‹œì—ëŠ” AI ë¶„ì„ ì•ˆ í•¨
updateCompare();

// ì´ˆê¸° ì‹¤ì‹œê°„ ë¶„ì„ ì‹¤í–‰
setTimeout(() => {
  if(typeof liveAnalyzer !== 'undefined') {
    liveAnalyzer.analyzeCurrentSession();
  }
}, 500);
</script>

<!-- âœ… Pose Detection Libraries -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>

<script>
// í¬ì¦ˆ ê°ì§€ ëª¨ë¸ ê´€ë¦¬
let detectors = { front: null, side: null };

// ì´ˆê¸° orientation ë²„íŠ¼ ìƒíƒœ ì„¤ì • ë° ì¢Œí‘œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
document.addEventListener("DOMContentLoaded", () => {
  console.log("=== DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ ===");

// ì„¸ì…˜ë³„ í¬ì¦ˆ ì •ë³´ ì €ì¥ (ê¸°ì¡´ sessions ê°ì²´ì™€ í†µí•©)
// sessions ê°ì²´ì— orientationê³¼ landmarks ì •ë³´ ì¶”ê°€
if(!sessions.Before.poseData) {
  sessions.Before.poseData = { orientation: "side", landmarks: null };
}
if(!sessions.After.poseData) {
  sessions.After.poseData = { orientation: "side", landmarks: null };
}

  // ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
  initSessionButtons();
  
  // orientation ë²„íŠ¼ ìƒíƒœ ì„¤ì •
  const orientation = sessions[cur].poseData?.orientation || "side";
  const btnSide = document.getElementById("btnOrientationSide");
  const btnFront = document.getElementById("btnOrientationFront");
  
  if(btnSide && btnFront) {
    btnSide.classList.toggle("active", orientation === "side");
    btnFront.classList.toggle("active", orientation === "front");
    console.log("Orientation ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ ì„¤ì • ì™„ë£Œ:", orientation);
  }
  
  // ì¢Œí‘œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
  updateCoordSelectOptions();
  
  console.log("=== ì´ˆê¸°í™” ì™„ë£Œ ===");
});

// âœ… ëª¨ë¸ ë¡œë“œ ìƒíƒœ ì¶”ì 
let modelsLoading = { front: false, side: false };
let modelsLoaded = { front: false, side: false };

// âœ… ëª¨ë¸ ë¡œë“œ (ì •ë©´: MoveNet, ì˜†ëª¨ìŠµ: BlazePose)
async function loadPoseModels() {
  try {
    // ì •ë©´ ëª¨ë¸ ë¡œë“œ
    if (!modelsLoading.front && !modelsLoaded.front) {
      modelsLoading.front = true;
    detectors.front = await poseDetection.createDetector(
      poseDetection.SupportedModels.MoveNet,
      { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING }
    );
      modelsLoaded.front = true;
      modelsLoading.front = false;
      console.log("âœ… ì •ë©´ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ");
    }
    
    // ì˜†ëª¨ìŠµ ëª¨ë¸ ë¡œë“œ
    if (!modelsLoading.side && !modelsLoaded.side) {
      modelsLoading.side = true;
    detectors.side = await poseDetection.createDetector(
      poseDetection.SupportedModels.BlazePose,
      { runtime: "tfjs", modelType: "full", enableSmoothing: true }
    );
      modelsLoaded.side = true;
      modelsLoading.side = false;
      console.log("âœ… ì˜†ëª¨ìŠµ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ");
    }
    
    console.log("âœ… ì •ë©´Â·ì˜†ëª¨ìŠµ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ");
  } catch(error) {
    console.error("ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨:", error);
    modelsLoading.front = false;
    modelsLoading.side = false;
  }
}

loadPoseModels();

// âœ… ë¶„ì„ ì‹œ orientationì— ë§ëŠ” ëª¨ë¸ ì‚¬ìš©
async function detectPose(img, orientation) {
  // ëª¨ë¸ì´ ë¡œë“œ ì¤‘ì´ë©´ ê¸°ë‹¤ë¦¼
  let waitCount = 0;
  const maxWait = 50; // ìµœëŒ€ 5ì´ˆ ëŒ€ê¸° (100ms * 50)
  
  while (!modelsLoaded[orientation] && !detectors[orientation] && waitCount < maxWait) {
    if (!modelsLoading[orientation]) {
      // ëª¨ë¸ ë¡œë“œê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‹œì‘
      await loadPoseModels();
    }
    await new Promise(resolve => setTimeout(resolve, 100)); // 100ms ëŒ€ê¸°
    waitCount++;
  }
  
  const detector = detectors[orientation];
  if (!detector) {
    // ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
    console.log(`${orientation} ëª¨ë¸ ì¬ì‹œë„ ì¤‘...`);
    await loadPoseModels();
    
    if (!detectors[orientation]) {
      alert(`${orientation}ìš© ëª¨ë¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.`);
    return null;
    }
  }
  
  try {
    const poses = await detector.estimatePoses(img);
    if (!poses.length) {
      alert(`${orientation} ë°©í–¥ì—ì„œ ì‚¬ëŒì„ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤`);
      return null;
    }
    return poses[0];
  } catch(error) {
    console.error("í¬ì¦ˆ ê°ì§€ ì‹¤íŒ¨:", error);
    alert("í¬ì¦ˆ ê°ì§€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
    return null;
  }
}

// âœ… í¬ì¦ˆ ì¢Œí‘œë¥¼ ê¸°ì¡´ ì  ì‹œìŠ¤í…œì— ë§¤í•‘ (MediaPipe Pose ëœë“œë§ˆí¬ ì¸ë±ìŠ¤ ê¸°ë°˜)
function mapPoseToKeypoints(pose, orientation) {
  if(!pose || !pose.keypoints) return null;
  
  const keypointMap = {};
  const keypoints = pose.keypoints;
  
  // MediaPipe PoseëŠ” 33ê°œ ëœë“œë§ˆí¬ ì œê³µ (ì¸ë±ìŠ¤ ê¸°ë°˜)
  // 0: nose, 7: left_ear, 8: right_ear, 11: left_shoulder, 12: right_shoulder
  // 23: left_hip, 24: right_hip, 25: left_knee, 26: right_knee
  // 27: left_ankle, 28: right_ankle
  
  if(orientation === "side") {
    // ì˜†ëª¨ìŠµ: ë³´ì´ëŠ” ìª½ì˜ ëœë“œë§ˆí¬ ì‚¬ìš© (confidence ë†’ì€ ìª½ ì„ íƒ)
    const leftEar = keypoints[7];
    const rightEar = keypoints[8];
    const leftShoulder = keypoints[11];
    const rightShoulder = keypoints[12];
    const leftHip = keypoints[23];
    const rightHip = keypoints[24];
    const leftKnee = keypoints[25];
    const rightKnee = keypoints[26];
    const leftAnkle = keypoints[27];
    const rightAnkle = keypoints[28];
    const nose = keypoints[0];
    
    // ì–´ëŠ ìª½ì´ ë” ë³´ì´ëŠ”ì§€ íŒë‹¨ (x ì¢Œí‘œê°€ ë” ì‘ê±°ë‚˜ í° ìª½)
    let useLeft = true;
    if(leftShoulder && rightShoulder) {
      // ì–´ê¹¨ì˜ x ì°¨ì´ë¡œ íŒë‹¨ (ì˜†ëª¨ìŠµì—ì„œëŠ” í•œìª½ì´ ë” ì•ì— ë‚˜ì™€ ìˆìŒ)
      const leftScore = (leftShoulder.visibility || 0) + (leftHip?.visibility || 0) + (leftKnee?.visibility || 0);
      const rightScore = (rightShoulder.visibility || 0) + (rightHip?.visibility || 0) + (rightKnee?.visibility || 0);
      useLeft = leftScore >= rightScore;
    }
    
    console.log('ì˜†ëª¨ìŠµ ê°ì§€:', useLeft ? 'ì™¼ìª½ ì‚¬ìš©' : 'ì˜¤ë¥¸ìª½ ì‚¬ìš©');
    
    // tragus: ear (ë” ë³´ì´ëŠ” ìª½) - Flutter 1:1 ë§¤ì¹­
    const ear = useLeft ? leftEar : rightEar;
    if(ear && ear.visibility >= 0.3) {
      keypointMap['tragus'] = { x: ear.x, y: ear.y, score: ear.visibility };
    } else if(!ear || ear.visibility < 0.3) {
      // earê°€ ì•ˆ ë³´ì´ë©´ nose ì‚¬ìš©
      if(nose && nose.visibility >= 0.3) {
        keypointMap['tragus'] = { x: nose.x, y: nose.y + 0.03, score: nose.visibility * 0.8 };
      }
    }
    
    // acromion: ì–´ê¹¨ (ë” ë³´ì´ëŠ” ìª½) - Flutter 1:1 ë§¤ì¹­
    const shoulder = useLeft ? leftShoulder : rightShoulder;
    if(shoulder && shoulder.visibility >= 0.3) {
      keypointMap['acromion'] = { x: shoulder.x, y: shoulder.y, score: shoulder.visibility };
      
      // c7: ì–´ê¹¨ë³´ë‹¤ ì•½ê°„ ìœ„/ë’¤ - Flutter 1:1 ë§¤ì¹­
      keypointMap['c7'] = { 
        x: shoulder.x - 0.02, // ì–´ê¹¨ë³´ë‹¤ ì•½ê°„ ë’¤
        y: shoulder.y - 0.03, // ì–´ê¹¨ë³´ë‹¤ ì•½ê°„ ìœ„
        score: shoulder.visibility * 0.9
      };
    }
    
    // hip: ê³¨ë°˜ (ë” ë³´ì´ëŠ” ìª½) - Flutter 1:1 ë§¤ì¹­
    const hip = useLeft ? leftHip : rightHip;
    if(hip && hip.visibility >= 0.3) {
      keypointMap['hip'] = { x: hip.x, y: hip.y, score: hip.visibility };
      
      // asis: hipë³´ë‹¤ ì•½ê°„ ì•/ìœ„ - Flutter 1:1 ë§¤ì¹­
      keypointMap['asis'] = { 
        x: hip.x + 0.03, // ì•ìª½
        y: hip.y - 0.01, // ì•½ê°„ ìœ„
        score: hip.visibility * 0.85 
      };
      
      // psis: hipë³´ë‹¤ ì•½ê°„ ë’¤ - Flutter 1:1 ë§¤ì¹­
      keypointMap['psis'] = { 
        x: hip.x - 0.03, // ë’¤ìª½
        y: hip.y - 0.01, // ì•½ê°„ ìœ„
        score: hip.visibility * 0.85 
      };
    }
    
    // knee: ë¬´ë¦ (ë” ë³´ì´ëŠ” ìª½) - Flutter 1:1 ë§¤ì¹­
    const knee = useLeft ? leftKnee : rightKnee;
    if(knee && knee.visibility >= 0.3) {
      keypointMap['knee'] = { x: knee.x, y: knee.y, score: knee.visibility };
    }
    
    // ankle: ë°œëª© (ë” ë³´ì´ëŠ” ìª½) - Flutter 1:1 ë§¤ì¹­
    const ankle = useLeft ? leftAnkle : rightAnkle;
    if(ankle && ankle.visibility >= 0.3) {
      keypointMap['ankle'] = { x: ankle.x, y: ankle.y, score: ankle.visibility };
    }
    
    console.log('ì˜†ëª¨ìŠµ ëœë“œë§ˆí¬ ë§¤í•‘:', Object.keys(keypointMap));
  }
  
  if(orientation === "front") {
    // ì •ë©´: ì–‘ìª½ ëª¨ë‘ í‘œì‹œ
    // MediaPipeì˜ left/rightëŠ” í™˜ì ê¸°ì¤€ì´ì§€ë§Œ, ì´ë¯¸ì§€ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ë§¤í•‘í•´ì•¼ í•¨
    // ì´ë¯¸ì§€ì—ì„œ ì™¼ìª½(x ì‘ìŒ) = L, ì˜¤ë¥¸ìª½(x í¼) = R
    const leftShoulder = keypoints[11];  // MediaPipe: í™˜ì ì™¼ìª½ ì–´ê¹¨
    const rightShoulder = keypoints[12]; // MediaPipe: í™˜ì ì˜¤ë¥¸ìª½ ì–´ê¹¨
    const leftHip = keypoints[23];       // MediaPipe: í™˜ì ì™¼ìª½ ê³¨ë°˜
    const rightHip = keypoints[24];      // MediaPipe: í™˜ì ì˜¤ë¥¸ìª½ ê³¨ë°˜
    const leftKnee = keypoints[25];      // MediaPipe: í™˜ì ì™¼ìª½ ë¬´ë¦
    const rightKnee = keypoints[26];    // MediaPipe: í™˜ì ì˜¤ë¥¸ìª½ ë¬´ë¦
    const leftAnkle = keypoints[27];     // MediaPipe: í™˜ì ì™¼ìª½ ë°œëª©
    const rightAnkle = keypoints[28];    // MediaPipe: í™˜ì ì˜¤ë¥¸ìª½ ë°œëª©
    
    // ì–´ê¹¨: MediaPipe left/rightëŠ” í™˜ì ê¸°ì¤€ì´ë¯€ë¡œ ì´ë¯¸ì§€ ì¢Œí‘œì™€ ë°˜ëŒ€
    // MediaPipe leftShoulder = í™˜ì ì™¼ìª½ = ì´ë¯¸ì§€ ì˜¤ë¥¸ìª½ â†’ R_acromion
    // MediaPipe rightShoulder = í™˜ì ì˜¤ë¥¸ìª½ = ì´ë¯¸ì§€ ì™¼ìª½ â†’ L_acromion
    if(leftShoulder && leftShoulder.visibility >= 0.3 && rightShoulder && rightShoulder.visibility >= 0.3) {
      // ë°˜ëŒ€ë¡œ ë§¤í•‘: MediaPipe left â†’ R, MediaPipe right â†’ L
      keypointMap['L_acromion'] = { x: rightShoulder.x, y: rightShoulder.y, score: rightShoulder.visibility };
      keypointMap['R_acromion'] = { x: leftShoulder.x, y: leftShoulder.y, score: leftShoulder.visibility };
    } else if(leftShoulder && leftShoulder.visibility >= 0.3) {
      // MediaPipe leftë§Œ ìˆìœ¼ë©´ â†’ R_acromion (í™˜ì ì™¼ìª½ = ì´ë¯¸ì§€ ì˜¤ë¥¸ìª½)
      keypointMap['R_acromion'] = { x: leftShoulder.x, y: leftShoulder.y, score: leftShoulder.visibility };
    } else if(rightShoulder && rightShoulder.visibility >= 0.3) {
      // MediaPipe rightë§Œ ìˆìœ¼ë©´ â†’ L_acromion (í™˜ì ì˜¤ë¥¸ìª½ = ì´ë¯¸ì§€ ì™¼ìª½)
      keypointMap['L_acromion'] = { x: rightShoulder.x, y: rightShoulder.y, score: rightShoulder.visibility };
    }
    
    // c7: ì–‘ìª½ ì–´ê¹¨ ì¤‘ê°„ (ëª© ì•„ë˜) - Flutter 1:1 ë§¤ì¹­
    if(keypointMap['L_acromion'] && keypointMap['R_acromion']) {
      keypointMap['c7'] = {
        x: (keypointMap['L_acromion'].x + keypointMap['R_acromion'].x) / 2,
        y: Math.min(keypointMap['L_acromion'].y, keypointMap['R_acromion'].y) - 0.04,
        score: Math.min(keypointMap['L_acromion'].score, keypointMap['R_acromion'].score)
      };
    } else if(keypointMap['L_acromion']) {
      keypointMap['c7'] = {
        x: keypointMap['L_acromion'].x,
        y: keypointMap['L_acromion'].y - 0.04,
        score: keypointMap['L_acromion'].score * 0.8
      };
    } else if(keypointMap['R_acromion']) {
      keypointMap['c7'] = {
        x: keypointMap['R_acromion'].x,
        y: keypointMap['R_acromion'].y - 0.04,
        score: keypointMap['R_acromion'].score * 0.8
      };
    }
    
    // ê³¨ë°˜ (ASIS): MediaPipe left/right ë°˜ëŒ€ë¡œ ë§¤í•‘
    // MediaPipe leftHip = í™˜ì ì™¼ìª½ = ì´ë¯¸ì§€ ì˜¤ë¥¸ìª½ â†’ R_asis
    // MediaPipe rightHip = í™˜ì ì˜¤ë¥¸ìª½ = ì´ë¯¸ì§€ ì™¼ìª½ â†’ L_asis
    if(leftHip && leftHip.visibility >= 0.3 && rightHip && rightHip.visibility >= 0.3) {
      keypointMap['L_asis'] = { x: rightHip.x, y: rightHip.y, score: rightHip.visibility };
      keypointMap['R_asis'] = { x: leftHip.x, y: leftHip.y, score: leftHip.visibility };
    } else if(leftHip && leftHip.visibility >= 0.3) {
      keypointMap['R_asis'] = { x: leftHip.x, y: leftHip.y, score: leftHip.visibility };
    } else if(rightHip && rightHip.visibility >= 0.3) {
      keypointMap['L_asis'] = { x: rightHip.x, y: rightHip.y, score: rightHip.visibility };
    }
    
    // ë¬´ë¦: MediaPipe left/right ë°˜ëŒ€ë¡œ ë§¤í•‘
    // MediaPipe leftKnee = í™˜ì ì™¼ìª½ = ì´ë¯¸ì§€ ì˜¤ë¥¸ìª½ â†’ R_knee
    // MediaPipe rightKnee = í™˜ì ì˜¤ë¥¸ìª½ = ì´ë¯¸ì§€ ì™¼ìª½ â†’ L_knee
    if(leftKnee && leftKnee.visibility >= 0.3 && rightKnee && rightKnee.visibility >= 0.3) {
      keypointMap['L_knee'] = { x: rightKnee.x, y: rightKnee.y, score: rightKnee.visibility };
      keypointMap['R_knee'] = { x: leftKnee.x, y: leftKnee.y, score: leftKnee.visibility };
    } else if(leftKnee && leftKnee.visibility >= 0.3) {
      keypointMap['R_knee'] = { x: leftKnee.x, y: leftKnee.y, score: leftKnee.visibility };
    } else if(rightKnee && rightKnee.visibility >= 0.3) {
      keypointMap['L_knee'] = { x: rightKnee.x, y: rightKnee.y, score: rightKnee.visibility };
    }
    
    // ë°œëª©: MediaPipe left/right ë°˜ëŒ€ë¡œ ë§¤í•‘
    // MediaPipe leftAnkle = í™˜ì ì™¼ìª½ = ì´ë¯¸ì§€ ì˜¤ë¥¸ìª½ â†’ R_ankle
    // MediaPipe rightAnkle = í™˜ì ì˜¤ë¥¸ìª½ = ì´ë¯¸ì§€ ì™¼ìª½ â†’ L_ankle
    if(leftAnkle && leftAnkle.visibility >= 0.3 && rightAnkle && rightAnkle.visibility >= 0.3) {
      keypointMap['L_ankle'] = { x: rightAnkle.x, y: rightAnkle.y, score: rightAnkle.visibility };
      keypointMap['R_ankle'] = { x: leftAnkle.x, y: leftAnkle.y, score: leftAnkle.visibility };
    } else if(leftAnkle && leftAnkle.visibility >= 0.3) {
      keypointMap['R_ankle'] = { x: leftAnkle.x, y: leftAnkle.y, score: leftAnkle.visibility };
    } else if(rightAnkle && rightAnkle.visibility >= 0.3) {
      keypointMap['L_ankle'] = { x: rightAnkle.x, y: rightAnkle.y, score: rightAnkle.visibility };
    }
    
    console.log('ì •ë©´ ëœë“œë§ˆí¬ ë§¤í•‘ (ì´ë¯¸ì§€ ì¢Œí‘œ ê¸°ì¤€):', Object.keys(keypointMap));
  }
  
  return keypointMap;
}

// âœ… í¬ì¦ˆ ê°ì§€ í›„ ê¸°ì¡´ ì‹œìŠ¤í…œì— í†µí•©
async function applyPoseDetection(img, sessionName) {
  const session = sessions[sessionName];
  if(!session) return;
  
  // ì„¸ì…˜ì˜ orientation ì‚¬ìš© (ê¸°ë³¸ê°’: side)
  if(!session.poseData) {
    session.poseData = { orientation: "side", landmarks: null };
  }
  const orientation = session.poseData.orientation || "side";
  
  console.log(`${sessionName} ì„¸ì…˜: ${orientation === "side" ? "ì˜†ëª¨ìŠµ" : "ì •ë©´"} í¬ì¦ˆ ê°ì§€ ì‹œì‘`);
  
  const pose = await detectPose(img, orientation);
  if(!pose) return;
  
  // í¬ì¦ˆ ì •ë³´ ì €ì¥
  session.poseData.landmarks = pose.keypoints;
  
  // ê¸°ì¡´ ì  ì‹œìŠ¤í…œì— ë§¤í•‘ (ì„ íƒì )
  const keypointMap = mapPoseToKeypoints(pose, orientation);
  if(keypointMap) {
    // ë§¤í•‘ëœ í‚¤í¬ì¸íŠ¸ë¥¼ ê¸°ì¡´ ì  ì‹œìŠ¤í…œì— ì ìš©
    const map = orientation === "front" ? session.frontPoints : session.sidePoints;
    
    // ì›ë³¸ í¬ê¸° ê³„ì‚° (ì•„ì§ ì—†ìœ¼ë©´ ê³„ì‚°)
    if(originalCanvasSize.width === 0) {
      const canvasWrap = cv.parentElement;
      const maxW = canvasWrap.clientWidth - 24;
      const maxH = canvasWrap.clientHeight - 24;
      const r = Math.min(maxW / img.naturalWidth, maxH / img.naturalHeight);
      originalCanvasSize.width = Math.round(img.naturalWidth * r);
      originalCanvasSize.height = Math.round(img.naturalHeight * r);
    }
    
    for(const [key, value] of Object.entries(keypointMap)) {
      if(value && value.x !== undefined && value.y !== undefined && value.score >= 0.2) {
        // MediaPipeëŠ” ì •ê·œí™”ëœ ì¢Œí‘œ(0-1)ë¥¼ ì œê³µí•˜ë¯€ë¡œ í”½ì…€ ì¢Œí‘œë¡œ ë³€í™˜
        // ì´ë¯¸ì§€ í¬ê¸°ì— ë§ê²Œ ì¢Œí‘œ ë³€í™˜
        const imgX = value.x * img.naturalWidth;
        const imgY = value.y * img.naturalHeight;
        
        // ìº”ë²„ìŠ¤ í¬ê¸°ì— ë§ê²Œ ìŠ¤ì¼€ì¼ë§
        const scaleX = originalCanvasSize.width / img.naturalWidth;
        const scaleY = originalCanvasSize.height / img.naturalHeight;
        
        const finalX = imgX * scaleX;
        const finalY = imgY * scaleY;
        
        map.set(key, {
          x: finalX,
          y: finalY
        });
        
        console.log(`âœ… ${key} ë§¤í•‘: ì›ë³¸(${value.x.toFixed(3)}, ${value.y.toFixed(3)}) â†’ ì´ë¯¸ì§€í”½ì…€(${imgX.toFixed(1)}, ${imgY.toFixed(1)}) â†’ ìº”ë²„ìŠ¤(${finalX.toFixed(1)}, ${finalY.toFixed(1)}) [confidence: ${value.score.toFixed(2)}]`);
      }
    }
    
    // í™”ë©´ ì—…ë°ì´íŠ¸
    draw();
    computeAll(); // ì „ì²´ ë¶„ì„ ì‹¤í–‰
    console.log(`âœ… ${sessionName} í¬ì¦ˆ ê°ì§€ ë° ì¢Œí‘œ ì ìš© ì™„ë£Œ (${orientation === "side" ? "ì˜†ëª¨ìŠµ" : "ì •ë©´"})`);
  }
  
  return pose;
}

// âœ… í¬ì¦ˆ ê°ì§€ëŠ” ìœ„ì˜ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ì—ì„œ ìë™ìœ¼ë¡œ í˜¸ì¶œë¨
// applyPoseDetection í•¨ìˆ˜ê°€ ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜ë˜ì–´ ìˆìŒ
</script>
  </body>
</html>
