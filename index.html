<!DOCTYPE html>
<html lang="ko">
  <head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIT ìì„¸ ë¶„ì„ AI (ìµœì¢… í†µí•©ë²„ì „)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0b0f14;
  --panel: rgba(30, 34, 42, 0.7);
  --accent: #7c9cff;
  --accent2: #ffb86c;
  --ink: #e7eef7;
  --muted: #9bb0c7;
  --radius: 18px;
}
* { box-sizing: border-box; }
html, body {
  margin: 0; 
  padding: 0;
  height: 100%;
  -webkit-overflow-scrolling: touch;
}
body {
  background: var(--bg); 
  color: var(--ink);
  font-family: "Noto Sans KR", sans-serif;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  overflow-x: hidden;
}
.panel {
  background: var(--panel);
  backdrop-filter: blur(20px);
  border-radius: var(--radius);
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
}
.sidebar { 
  padding: 12px; 
  overflow-y: auto;
  overflow-x: hidden;
  max-height: 50vh;
  -webkit-overflow-scrolling: touch;
}
.title { 
  font-size: 16px; 
  font-weight:800; 
  margin-bottom: 6px; 
  line-height: 1.3;
}
.muted { 
  color: var(--muted); 
  font-size: 11px; 
  line-height: 1.4;
}
.btn {
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 10px 14px;
  background: rgba(255,255,255,0.05);
  color: var(--ink);
  cursor: pointer;
  font-size: 13px;
  width: 100%;
  text-align: center;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.btn:hover, .btn:active { 
  background: rgba(255,255,255,0.12); 
}
.seg { 
  display: flex; 
  border-radius: 10px; 
  overflow: hidden; 
  margin-top: 8px; 
  gap: 4px;
}
.seg button { 
  flex:1; 
  border:0; 
  background: rgba(255,255,255,0.04); 
  color:var(--muted); 
  padding:10px 8px; 
  cursor:pointer; 
  font-size: 13px;
  touch-action: manipulation;
}
.seg button.active { 
  background: rgba(124,156,255,0.25); 
  color:var(--ink); 
}
label.btn { 
  display: block;
  width: 100%;
  margin-bottom: 8px;
}
label.btn input { display:none; }
.tbl { 
  width:100%; 
  border-collapse:collapse; 
  font-size:11px; 
  overflow-x: auto;
  display: table;
  -webkit-overflow-scrolling: touch;
}
.tbl th,.tbl td { 
  border-bottom:1px solid rgba(255,255,255,0.1); 
  padding:6px 4px; 
  text-align: center;
  font-size: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.canvasWrap { 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  flex: 1;
  min-height: 50vh;
  padding: 8px;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  position: relative;
}
.canvasWrap.zoomed {
  align-items: flex-start;
  justify-content: flex-start;
}
canvas { 
  border-radius:var(--radius); 
  background:#0a0e13; 
  cursor: crosshair; 
  touch-action: none; /* ë“œë˜ê·¸ì™€ ìŠ¤í¬ë¡¤ì„ JavaScriptë¡œ ì œì–´ */
  display: block;
  flex-shrink: 0;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
  user-select: none;
  -webkit-user-select: none;
}
</style>
  </head>
  <body>
<aside class="panel sidebar" style="order: 1;">
  <div class="title">ğŸ“¸ DIT ìì„¸ ë¶„ì„ AI</div>
  <div class="muted">íŒŒì¼ ì—…ë¡œë“œ â†’ ì ì„ ë“œë˜ê·¸ë¡œ ì¡°ì • â†’ ê°ë„ ìë™ ê³„ì‚°</div>

  <div class="seg">
    <button id="btnBefore" class="active">Before</button>
    <button id="btnAfter">After</button>
  </div>
  <div style="margin-top:8px; display:flex; flex-direction:column; gap:8px;">
    <label class="btn">ğŸ“· íŒŒì¼ ì„ íƒ
      <input id="filePicker" type="file" accept="image/*">
    </label>
    <label class="btn">ğŸ“¸ ì§ì ‘ ì´¬ì˜
      <input id="cameraPicker" type="file" accept="image/*" capture="environment">
    </label>
    <button class="btn" id="btnReset">â†º ì´ˆê¸°í™”</button>
  </div>

  <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
    <button class="btn" id="btnEditCoords" style="background: rgba(124,156,255,0.2);">âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ</button>
    <button class="btn" id="btnSaveJSON">ğŸ’¾ ì¢Œí‘œ ì €ì¥</button>
    <button class="btn" id="btnLoadJSON">ğŸ“‚ ì¢Œí‘œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button class="btn" id="btnPDF">ğŸ“„ PDF ì €ì¥</button>
    <button class="btn" id="btnImage">ğŸ–¼ï¸ ê·¸ë¦¼ìœ¼ë¡œ ì €ì¥</button>
    <button class="btn" id="btnShare">ğŸ“¤ ê³µìœ í•˜ê¸°</button>
  </div>

  <div id="coordEditPanel" style="margin-top:12px; padding:10px; background:rgba(124,156,255,0.1); border-radius:10px; display:none;">
    <div class="muted" style="margin-bottom:8px; font-weight:600;">ì¢Œí‘œ ìˆ˜ì •</div>
    <div style="margin-bottom:8px;">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">í™•ëŒ€ ë°°ìœ¨</div>
      <select id="zoomLevel" class="btn" style="width:100%; padding:6px; margin-bottom:8px;">
        <option value="1">ì›ë³¸ í¬ê¸° (1ë°°)</option>
        <option value="2">2ë°° í™•ëŒ€ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</option>
        <option value="3">3ë°° í™•ëŒ€ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</option>
        <option value="4">4ë°° í™•ëŒ€ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</option>
      </select>
      <div class="muted" style="font-size:10px; margin-top:4px; margin-bottom:8px; line-height:1.4;">í™•ëŒ€ ì‹œ ì–‘ì†ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì—¬ ì´ë™ ê°€ëŠ¥</div>
    </div>
    <div style="margin-bottom:8px;">
      <select id="coordSelectPoint" class="btn" style="width:100%; padding:6px; margin-bottom:6px;">
        <option value="">ì  ì„ íƒ...</option>
        <option value="Tragus">Tragus</option>
        <option value="C7">C7</option>
        <option value="Shoulder">Shoulder</option>
        <option value="Hip">Hip</option>
        <option value="Knee">Knee</option>
        <option value="Ankle">Ankle</option>
        <option value="ASIS">ASIS</option>
        <option value="PSIS">PSIS</option>
      </select>
    </div>
    <div style="display:flex; flex-direction:column; gap:6px; margin-bottom:6px;">
      <div>
        <div class="muted" style="font-size:11px; margin-bottom:4px;">X ì¢Œí‘œ</div>
        <div style="display:flex; gap:4px; align-items:center;">
          <input type="number" id="coordX" class="btn" style="flex:1; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);" step="0.1" placeholder="X">
          <button class="btn" id="coordXDec" style="padding:8px 12px; background:rgba(255,107,107,0.2); border:1px solid rgba(255,107,107,0.3); min-width:40px;">âˆ’</button>
          <button class="btn" id="coordXInc" style="padding:8px 12px; background:rgba(46,196,182,0.2); border:1px solid rgba(46,196,182,0.3); min-width:40px;">+</button>
        </div>
      </div>
      <div>
        <div class="muted" style="font-size:11px; margin-bottom:4px;">Y ì¢Œí‘œ</div>
        <div style="display:flex; gap:4px; align-items:center;">
          <input type="number" id="coordY" class="btn" style="flex:1; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);" step="0.1" placeholder="Y">
          <button class="btn" id="coordYDec" style="padding:8px 12px; background:rgba(255,107,107,0.2); border:1px solid rgba(255,107,107,0.3); min-width:40px;">âˆ’</button>
          <button class="btn" id="coordYInc" style="padding:8px 12px; background:rgba(46,196,182,0.2); border:1px solid rgba(46,196,182,0.3); min-width:40px;">+</button>
        </div>
      </div>
    </div>
    <button class="btn" id="coordApply" style="width:100%; background:rgba(124,156,255,0.3);">ì ìš©</button>
    <button class="btn" id="coordCancel" style="width:100%; margin-top:6px; background:rgba(255,255,255,0.05);">ì·¨ì†Œ</button>
  </div>

  <div style="margin-top:12px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px;">
    <div class="muted" style="margin-bottom:6px;">í˜„ì¬ ì„¸ì…˜: <span id="currentSession">Before</span></div>
    <div class="muted" style="margin-bottom:6px;">CVA: <span id="dispCva">â€”</span></div>
    <div class="muted" style="margin-bottom:6px;">TRUNK: <span id="dispPel">â€”</span></div>
    <div class="muted" style="margin-bottom:8px;">KNEE: <span id="dispKnee">â€”</span></div>
    
    <div style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1);">
      <div style="font-size:14px; font-weight:600; margin-bottom:8px;">ğŸ“Š ì²´í˜• ì¢…í•© ì ìˆ˜</div>
      <div id="totalScore" style="font-size:32px; font-weight:800; margin-bottom:8px;">â€”</div>
      <div id="scoreReason" class="muted" style="font-size:11px; line-height:1.4; margin-bottom:8px;"></div>
    </div>
  </div>

  <div id="aiCommentPanel" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#2ec4b6;">ğŸ¤– AI ì‹¤ì‹œê°„ ë¶„ì„</div>
    <div id="aiComment" class="muted" style="font-size:12px; line-height:1.5;"></div>
  </div>

  <div id="musclePanel" style="margin-top:12px; padding:12px; background:rgba(255,184,108,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#ffb86c;">ğŸ’ª ê·¼ìœ¡ ìƒíƒœ ë¶„ì„</div>
    <div id="muscleTight" style="margin-bottom:8px;">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">ğŸ”´ ê¸´ì¥ëœ ê·¼ìœ¡:</div>
      <div id="muscleTightList" style="font-size:12px; color:#ff6b6b; line-height:1.5;"></div>
    </div>
    <div id="muscleWeak" style="margin-bottom:8px;">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">ğŸ”µ ì•½í™”ëœ ê·¼ìœ¡:</div>
      <div id="muscleWeakList" style="font-size:12px; color:#7c9cff; line-height:1.5;"></div>
    </div>
    <div id="muscleDetail" style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">ğŸ“‹ ìƒì„¸ ë¶„ì„:</div>
      <div id="muscleDetailList" style="font-size:11px; line-height:1.6; color:var(--ink);"></div>
    </div>
  </div>

  <div id="exercisePanel" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.15); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#2ec4b6;">ğŸ‹ï¸ ì¶”ì²œ ìš´ë™</div>
    <div id="exerciseList" style="font-size:12px; line-height:1.6;"></div>
  </div>

  <div id="pilatesPanel" style="margin-top:12px; padding:12px; background:rgba(156,136,255,0.15); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#9c88ff;">ğŸ§˜ í•„ë¼í…ŒìŠ¤ ì„¸ì…˜ ì¶”ì²œ</div>
    <div id="pilatesList" style="font-size:12px; line-height:1.6;"></div>
  </div>

  <div style="margin-top:12px;">
    <table class="tbl">
      <thead><tr><th>í•­ëª©</th><th>Before</th><th>After</th><th>ë³€í™”</th><th>ì •ìƒ</th></tr></thead>
      <tbody>
        <tr><td>CVA</td><td id="cmpCvaB">â€”</td><td id="cmpCvaA">â€”</td><td id="cmpCvaD">â€”</td><td>â‰¥50Â°</td></tr>
        <tr><td>TRUNK</td><td id="cmpPelB">â€”</td><td id="cmpPelA">â€”</td><td id="cmpPelD">â€”</td><td>|0â€“5Â°|</td></tr>
        <tr><td>KNEE</td><td id="cmpKneeB">â€”</td><td id="cmpKneeA">â€”</td><td id="cmpKneeD">â€”</td><td>175â€“185Â°</td></tr>
      </tbody>
    </table>
  </div>
</aside>
<main class="panel canvasWrap" style="order: 2;">
  <canvas id="cv" width="1600" height="1000"></canvas>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466862/camera_utils.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1675466124/drawing_utils.js"></script>
<script>
const { jsPDF } = window.jspdf;
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
let DPR = window.devicePixelRatio || 1;
let dragKey = null;
let editMode = false;
let selectedPoint = null;
let originalCanvasSize = { width: 0, height: 0, styleWidth: 0, styleHeight: 0 };
let currentZoom = 1;
let isScrolling = false;
let scrollStartX = 0;
let scrollStartY = 0;
let touchStartTime = 0;
let scrollDistance = 0; // ìŠ¤í¬ë¡¤ ì‹œì‘ í›„ ì´ë™ ê±°ë¦¬
let longPressTimer = null;
let longPressDetected = false;
let longPressNearPoint = null; // long pressê°€ ê°ì§€ëœ ì 

const keypoints = [
  {key:'Tragus', color:'#7c9cff'},
  {key:'C7', color:'#7c9cff'},
  {key:'Shoulder', color:'#7c9cff'},
  {key:'Hip', color:'#7c9cff'},
  {key:'Knee', color:'#7c9cff'},
  {key:'Ankle', color:'#7c9cff'},
  {key:'ASIS', color:'#ffb86c'},
  {key:'PSIS', color:'#ffb86c'},
];

const sessions = {
  Before: { img:null, pts:new Map(), metrics:{}, score:null, analysis:null },
  After: { img:null, pts:new Map(), metrics:{}, score:null, analysis:null }
};
let cur = "Before";

const clamp = (v,min,max) => Math.min(max,Math.max(min,v));
const rad2deg = r => r * 180 / Math.PI;
const angleBetween = (a,b) => Math.atan2(b.y - a.y, b.x - a.x);

// í•„ë¼í…ŒìŠ¤ ë™ì‘ ë°ì´í„°
const pilatesData = {
  'ëª© êµ´ê³¡ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Neck Pull', 'Roll-Up'],
    ë¦¬í¬ë¨¸: ['Short Box - Round Back'],
    ìºë”œë½: ['Roll Down Bar'],
    ì²´ì–´: ['Swan Prep'],
    ë°”ë : ['Back Extension']
  },
  'ëª© ì‹ ì „ê·¼ ê¸´ì¥': {
    ë§¤íŠ¸: ['Roll-Up', 'Spine Stretch Forward'],
    ë¦¬í¬ë¨¸: ['Neck Stretch on Box'],
    ìºë”œë½: ['Tower - Arm Springs'],
    ì²´ì–´: ['Tricep Dips'],
    ë°”ë : ['Chest Stretch']
  },
  'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥': {
    ë§¤íŠ¸: ['Arm Circles', 'Swimming Prep'],
    ë¦¬í¬ë¨¸: ['Rowing - From Chest'],
    ìºë”œë½: ['Arm Springs - Chest Expansion'],
    ì²´ì–´: ['Tricep Press'],
    ë°”ë : ['Side Stretch Over']
  },
  'ì „ë°©ì–´ê¹¨ìì„¸': {
    ë§¤íŠ¸: ['Swan Dive', 'T-Raise'],
    ë¦¬í¬ë¨¸: ['Backstroke', 'Pulling Straps'],
    ìºë”œë½: ['Push Through Bar'],
    ì²´ì–´: ['Push Down - Front'],
    ë°”ë : ['Chest Expansion']
  },
  'ì–´ê¹¨ì•ˆì •ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Plank to Pike', 'Side Plank'],
    ë¦¬í¬ë¨¸: ['Long Stretch Series'],
    ìºë”œë½: ['Arm Springs - Bug'],
    ì²´ì–´: ['Mountain Climber'],
    ë°”ë : ['Side Arm Work']
  },
  'íšŒì „ê·¼ê°œ ë¶ˆê· í˜•': {
    ë§¤íŠ¸: ['Side Lying Arm Series'],
    ë¦¬í¬ë¨¸: ['Arm Work - Salute'],
    ìºë”œë½: ['Tower - Rotation'],
    ì²´ì–´: ['Seated Rotation'],
    ë°”ë : ['Spiral Stretch']
  },
  'ë³µì§ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['The Hundred', 'Teaser'],
    ë¦¬í¬ë¨¸: ['Stomach Series - Hundred'],
    ìºë”œë½: ['Roll Down Bar'],
    ì²´ì–´: ['Teaser Prep'],
    ë°”ë : ['Sit Up Series']
  },
  'ë³µì‚¬ê·¼ ë¶ˆê· í˜•': {
    ë§¤íŠ¸: ['Criss Cross', 'Saw'],
    ë¦¬í¬ë¨¸: ['Short Box - Twist'],
    ìºë”œë½: ['Twist & Reach'],
    ì²´ì–´: ['Side Bend'],
    ë°”ë : ['Twist on Barrel']
  },
  'ê¹Šì€ì½”ì–´ ì•½í™”': {
    ë§¤íŠ¸: ['Dead Bug', 'Modified Hundred'],
    ë¦¬í¬ë¨¸: ['Footwork - Parallel'],
    ìºë”œë½: ['Breathing with Springs'],
    ì²´ì–´: ['Seated Balance'],
    ë°”ë : ['Core Integration']
  },
  'í‰ì¶” ê³¼í›„ë§Œ': {
    ë§¤íŠ¸: ['Swan', 'Extension Series'],
    ë¦¬í¬ë¨¸: ['Short Box - Arch'],
    ìºë”œë½: ['Monkey Stretch'],
    ì²´ì–´: ['Back Extension'],
    ë°”ë : ['Chest Opening']
  },
  'ìš”ì¶” ê³¼ì „ë§Œ': {
    ë§¤íŠ¸: ['Pelvic Curl', 'Imprint & Release'],
    ë¦¬í¬ë¨¸: ['Pelvic Press', 'Knee Stretches'],
    ìºë”œë½: ['Tower - Hip Work'],
    ì²´ì–´: ['Hip Flexor Stretch'],
    ë°”ë : ['Hip Opening']
  },
  'ì²™ì¶”ê¸°ë¦½ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Swimming', 'Rocking'],
    ë¦¬í¬ë¨¸: ['Long Back Stretch'],
    ìºë”œë½: ['Back Extension Springs'],
    ì²´ì–´: ['Swan on Chair'],
    ë°”ë : ['Round Back']
  },
  'ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ë‹¨ì¶•': {
    ë§¤íŠ¸: ['Hip Flexor Stretch', 'Lunge'],
    ë¦¬í¬ë¨¸: ['Lunge Series', 'Runner Stretch'],
    ìºë”œë½: ['Tower - Hip Stretch'],
    ì²´ì–´: ['Standing Lunge'],
    ë°”ë : ['Hip Flexor Series']
  },
  'ë‘”ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Bridge Series', 'Clam'],
    ë¦¬í¬ë¨¸: ['Footwork - RelevÃ©', 'Leg Press'],
    ìºë”œë½: ['Leg Springs - Circles'],
    ì²´ì–´: ['Glute Press Back'],
    ë°”ë : ['Hip Extension']
  },
  'ê³¨ë°˜ ë¶ˆì•ˆì •': {
    ë§¤íŠ¸: ['Single Leg Bridge', 'Single Leg Stretch'],
    ë¦¬í¬ë¨¸: ['Single Leg Work'],
    ìºë”œë½: ['Leg Springs - Adduction'],
    ì²´ì–´: ['Standing Balance'],
    ë°”ë : ['Stability Challenge']
  },
  'ëŒ€í‡´ì‚¬ë‘ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Wall Squat', 'Single Leg Squat'],
    ë¦¬í¬ë¨¸: ['Footwork - Heels', 'Squats'],
    ìºë”œë½: ['Leg Press Springs'],
    ì²´ì–´: ['Standing Press Down'],
    ë°”ë : ['Leg Strengthening']
  },
  'í–„ìŠ¤íŠ¸ë§ ë‹¨ì¶•': {
    ë§¤íŠ¸: ['Leg Pull Front', 'Roll Over'],
    ë¦¬í¬ë¨¸: ['Hamstring Stretch', 'Tendon Stretch'],
    ìºë”œë½: ['Tower - Leg Stretch'],
    ì²´ì–´: ['Leg Pull Back'],
    ë°”ë : ['Hip Flexor Stretch']
  },
  'ì¢…ì•„ë¦¬ ê·¼ìœ¡ ê¸´ì¥': {
    ë§¤íŠ¸: ['Calf Stretch', 'Ankle Circles'],
    ë¦¬í¬ë¨¸: ['Calf Raises', 'Tendon Stretch'],
    ìºë”œë½: ['Foot Corrector Work'],
    ì²´ì–´: ['Heel Raises'],
    ë°”ë : ['Ankle Mobility']
  }
};

// ê·¼ìœ¡ ì´ë¦„ì„ í•„ë¼í…ŒìŠ¤ ë¬¸ì œë¡œ ë§¤í•‘
function mapMuscleToPilatesIssue(muscleName) {
  const mapping = {
    'ìƒë¶€ìŠ¹ëª¨ê·¼': 'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥',
    'ê²¬ê°‘ê±°ê·¼': 'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥',
    'SCM': 'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥',
    'í‰ì‡„ìœ ëŒê·¼': 'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥',
    'ì‹¬ë¶€ê²½ë¶€êµ´ê·¼': 'ëª© êµ´ê³¡ê·¼ ì•½í™”',
    'ì „ê±°ê·¼': 'ëª© êµ´ê³¡ê·¼ ì•½í™”',
    'í•˜ë¶€ìŠ¹ëª¨ê·¼': 'ì „ë°©ì–´ê¹¨ìì„¸',
    'ì¥ìš”ê·¼': 'ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ë‹¨ì¶•',
    'ìš”ì¶”ê¸°ë¦½ê·¼': 'ìš”ì¶” ê³¼ì „ë§Œ',
    'ëŒ€í‡´ì§ê·¼': 'ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ë‹¨ì¶•',
    'í‰ìš”ê·¼ë§‰': 'ìš”ì¶” ê³¼ì „ë§Œ',
    'ë³µíš¡ê·¼': 'ê¹Šì€ì½”ì–´ ì•½í™”',
    'ë‘”ê·¼': 'ë‘”ê·¼ ì•½í™”',
    'ëŒ€ë‘”ê·¼': 'ë‘”ê·¼ ì•½í™”',
    'ì¤‘ë‘”ê·¼': 'ë‘”ê·¼ ì•½í™”',
    'í•˜ë‘”ê·¼': 'ë‘”ê·¼ ì•½í™”',
    'ë³µì§ê·¼': 'ë³µì§ê·¼ ì•½í™”',
    'ëŒ€í‡´ì‚¬ë‘ê·¼': 'ëŒ€í‡´ì‚¬ë‘ê·¼ ì•½í™”',
    'í–„ìŠ¤íŠ¸ë§': 'í–„ìŠ¤íŠ¸ë§ ë‹¨ì¶•',
    'ë¹„ë³µê·¼': 'ì¢…ì•„ë¦¬ ê·¼ìœ¡ ê¸´ì¥',
    'ê°€ìë¯¸ê·¼': 'ì¢…ì•„ë¦¬ ê·¼ìœ¡ ê¸´ì¥',
    'ìŠ¬ì™€ê·¼': 'í–„ìŠ¤íŠ¸ë§ ë‹¨ì¶•'
  };
  return mapping[muscleName] || null;
}

// í•„ë¼í…ŒìŠ¤ ë™ì‘ ì¶”ì²œ í•¨ìˆ˜
function recommendPilates(tight, weak) {
  const pilatesIssues = new Map();
  
  // ê¸´ì¥ëœ ê·¼ìœ¡ì— ëŒ€í•œ í•„ë¼í…ŒìŠ¤
  tight.forEach(muscle => {
    const issue = mapMuscleToPilatesIssue(muscle);
    if(issue && pilatesData[issue]) {
      if(!pilatesIssues.has(issue)) {
        pilatesIssues.set(issue, { type: 'ê¸´ì¥', muscles: [], pilates: pilatesData[issue] });
      }
      pilatesIssues.get(issue).muscles.push(muscle);
    }
  });
  
  // ì•½í™”ëœ ê·¼ìœ¡ì— ëŒ€í•œ í•„ë¼í…ŒìŠ¤
  weak.forEach(muscle => {
    const issue = mapMuscleToPilatesIssue(muscle);
    if(issue && pilatesData[issue]) {
      if(!pilatesIssues.has(issue)) {
        pilatesIssues.set(issue, { type: 'ì•½í™”', muscles: [], pilates: pilatesData[issue] });
      }
      pilatesIssues.get(issue).muscles.push(muscle);
    }
  });
  
  return Array.from(pilatesIssues.entries()).map(([issue, data]) => ({
    issue,
    type: data.type,
    muscles: [...new Set(data.muscles)],
    pilates: data.pilates
  }));
}
const internalAngle = (a,b,c) => {
  const ab = Math.atan2(a.y - b.y, a.x - b.x);
  const cb = Math.atan2(c.y - b.y, c.x - b.x);
  let d = Math.abs(ab - cb);
  if(d > Math.PI) d = 2 * Math.PI - d;
  return d;
};

document.getElementById("btnBefore").onclick = () => switchSession("Before");
document.getElementById("btnAfter").onclick = () => switchSession("After");

function switchSession(s) {
  cur = s;
  document.getElementById("btnBefore").classList.toggle("active", s === "Before");
  document.getElementById("btnAfter").classList.toggle("active", s === "After");
  document.getElementById("currentSession").textContent = s;
  draw();
  // ì„¸ì…˜ ì „í™˜ ì‹œì—ëŠ” ê¸°ì¡´ ë¶„ì„ì´ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ metricsë§Œ ê³„ì‚°
  if(sessions[s].analysis) {
    // ê¸°ì¡´ ë¶„ì„ì´ ìˆìœ¼ë©´ ì „ì²´ ì—…ë°ì´íŠ¸
    const score = sessions[s].score;
    const metrics = sessions[s].metrics;
    const analysis = sessions[s].analysis;
    updateScoreAndAnalysis(score, metrics.cva, metrics.pelvic, metrics.knee, analysis);
  } else {
    computeMetricsOnly(); // ë¶„ì„ì´ ì—†ìœ¼ë©´ metricsë§Œ ê³„ì‚°
  }
  updateCompare();
}

function resizeCanvasFor(img) {
  const canvasWrap = cv.parentElement;
  const maxW = canvasWrap.clientWidth - 24;
  const maxH = canvasWrap.clientHeight - 24;
  
  // ì›ë³¸ ì´ë¯¸ì§€ ë¹„ìœ¨ ê³„ì‚°
  let baseW, baseH;
  if(img) {
    // ì»¨í…Œì´ë„ˆì— ë§ê²Œ ì›ë³¸ ë¹„ìœ¨ ìœ ì§€í•˜ë©° í¬ê¸° ê³„ì‚°
    const r = Math.min(maxW / img.naturalWidth, maxH / img.naturalHeight);
    baseW = Math.round(img.naturalWidth * r);
    baseH = Math.round(img.naturalHeight * r);
  } else {
    baseW = 1200;
    baseH = 800;
  }
  
  // ì›ë³¸ í¬ê¸° ì €ì¥ (ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ)
  if(!editMode) {
    originalCanvasSize.width = baseW;
    originalCanvasSize.height = baseH;
    originalCanvasSize.styleWidth = baseW;
    originalCanvasSize.styleHeight = baseH;
  }
  
  // í™•ëŒ€ ë°°ìœ¨ ì ìš© (ë¹„ìœ¨ ìœ ì§€)
  const zoomMultiplier = editMode ? currentZoom : 1;
  const finalW = baseW * zoomMultiplier;
  const finalH = baseH * zoomMultiplier;
  
  // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
  cv.width = finalW * DPR;
  cv.height = finalH * DPR;
  cv.style.width = finalW + "px";
  cv.style.height = finalH + "px";
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  
  // í™•ëŒ€ëœ ê²½ìš° ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
  if(editMode && currentZoom > 1) {
    canvasWrap.classList.add("zoomed");
    canvasWrap.style.overflow = "auto";
    canvasWrap.style.overflowX = finalW > maxW ? "auto" : "hidden";
    canvasWrap.style.overflowY = finalH > maxH ? "auto" : "hidden";
  } else {
    canvasWrap.classList.remove("zoomed");
    canvasWrap.style.overflow = "auto";
    canvasWrap.style.overflowX = "hidden";
    canvasWrap.style.overflowY = "hidden";
  }
  
  // ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  draw();
}

function ensureDefaultPoints(session) {
  const S = sessions[session];
  // ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì¢Œí‘œ ê³„ì‚°
  const W = originalCanvasSize.width || (cv.width / DPR / (editMode ? currentZoom : 1));
  const H = originalCanvasSize.height || (cv.height / DPR / (editMode ? currentZoom : 1));
  if(S.pts.size === 0 && S.img) {
    const defaults = {
      Tragus: {x:W*0.35, y:H*0.3},
      C7: {x:W*0.3, y:H*0.35},
      Shoulder: {x:W*0.35, y:H*0.4},
      Hip: {x:W*0.38, y:H*0.6},
      Knee: {x:W*0.42, y:H*0.8},
      Ankle: {x:W*0.44, y:H*0.95},
      ASIS: {x:W*0.40, y:H*0.58},
      PSIS: {x:W*0.35, y:H*0.6},
    };
    for(const kp of keypoints) {
      if(defaults[kp.key]) S.pts.set(kp.key, {...defaults[kp.key]});
    }
  }
}

function getPts(session) {
  const map = sessions[session].pts;
  const out = {};
  for(const k of keypoints) out[k.key] = map.get(k.key);
  return out;
}

function draw() {
  const S = sessions[cur];
  const W = cv.width / DPR, H = cv.height / DPR;
  ctx.clearRect(0, 0, cv.width, cv.height);
  ctx.fillStyle = "#0a0e13";
  ctx.fillRect(0, 0, W, H);

  if(S.img) {
    // ì›ë³¸ í¬ê¸° ì €ì¥ (ì²˜ìŒ í•œ ë²ˆë§Œ)
    if(originalCanvasSize.width === 0) {
      const maxW = cv.parentElement.clientWidth - 24;
      const maxH = cv.parentElement.clientHeight - 24;
      const r = Math.min(maxW / S.img.naturalWidth, maxH / S.img.naturalHeight);
      originalCanvasSize.width = Math.round(S.img.naturalWidth * r);
      originalCanvasSize.height = Math.round(S.img.naturalHeight * r);
      originalCanvasSize.styleWidth = originalCanvasSize.width;
      originalCanvasSize.styleHeight = originalCanvasSize.height;
    }
    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ë¹„ìœ¨ ìœ ì§€í•˜ë©° í™•ëŒ€ëœ í¬ê¸°ë¡œ)
    ctx.drawImage(S.img, 0, 0, W, H);
  }

  ensureDefaultPoints(cur);
  const P = getPts(cur);

  // ë³´ì¡°ì„  ê·¸ë¦¬ê¸°
  ctx.lineWidth = 2;
  ctx.setLineDash([8, 6]);
  ctx.strokeStyle = 'rgba(124,156,255,0.85)';

  if(P.C7 && P.Tragus) {
    ctx.beginPath();
    ctx.moveTo(0, P.C7.y);
    ctx.lineTo(W, P.C7.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(P.C7.x, P.C7.y);
    ctx.lineTo(P.Tragus.x, P.Tragus.y);
    ctx.stroke();
  }

  if(P.Shoulder && P.Hip) {
    ctx.beginPath();
    ctx.moveTo(P.Shoulder.x, P.Shoulder.y);
    ctx.lineTo(P.Hip.x, P.Hip.y);
    ctx.stroke();
  }
  if(P.Hip && P.Knee) {
    ctx.beginPath();
    ctx.moveTo(P.Hip.x, P.Hip.y);
    ctx.lineTo(P.Knee.x, P.Knee.y);
    ctx.stroke();
  }
  if(P.Knee && P.Ankle) {
    ctx.beginPath();
    ctx.moveTo(P.Knee.x, P.Knee.y);
    ctx.lineTo(P.Ankle.x, P.Ankle.y);
    ctx.stroke();
  }

  if(P.ASIS && P.PSIS) {
    ctx.strokeStyle = 'rgba(255,184,108,0.95)';
    ctx.beginPath();
    ctx.moveTo(P.ASIS.x, P.ASIS.y);
    ctx.lineTo(P.PSIS.x, P.PSIS.y);
    ctx.stroke();
    ctx.strokeStyle = 'rgba(255,184,108,0.35)';
    const midy = (P.ASIS.y + P.PSIS.y) / 2;
    ctx.beginPath();
    ctx.moveTo(0, midy);
    ctx.lineTo(W, midy);
    ctx.stroke();
  }

  ctx.setLineDash([]);

  // ì  ê·¸ë¦¬ê¸° (ì¢Œí‘œëŠ” ì›ë³¸ ê¸°ì¤€ì´ë¯€ë¡œ í™•ëŒ€ ë¹„ìœ¨ ì ìš©)
  for(const kp of keypoints) {
    const pt = P[kp.key];
    if(!pt) continue;
    // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì—ì„œ í™•ëŒ€ëœ ê²½ìš° ì¢Œí‘œë„ í™•ëŒ€
    const scaleX = editMode ? currentZoom : 1;
    const scaleY = editMode ? currentZoom : 1;
    const isSelected = editMode && selectedPoint === kp.key;
    drawHandle(pt.x * scaleX, pt.y * scaleY, kp.key, kp.color, isSelected);
  }
  
  // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì—ì„œ ì„ íƒëœ ì ì´ ìˆê³  ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì•ˆë‚´ í‘œì‹œ
  if(editMode && selectedPoint && !P[selectedPoint]) {
    const W = cv.width / DPR, H = cv.height / DPR;
    ctx.fillStyle = 'rgba(124,156,255,0.7)';
    ctx.font = 'bold 16px "Noto Sans KR"';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('ì¢Œí‘œë¥¼ ì…ë ¥í•˜ê³  "ì ìš©" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', W / 2, H / 2);
    ctx.textAlign = 'left';
    ctx.textBaseline = 'alphabetic';
  }
}

function drawHandle(x, y, label, color, isSelected = false) {
  // ì„ íƒëœ ì ì€ ë” í¬ê³  ê°•ì¡° í‘œì‹œ
  const radius = isSelected ? 12 : 8;
  const strokeWidth = isSelected ? 3 : 2;
  
  // ì„ íƒëœ ì ì€ ì™¸ê³½ ë§ í‘œì‹œ
  if(isSelected) {
    ctx.fillStyle = 'rgba(124,156,255,0.3)';
    ctx.beginPath();
    ctx.arc(x, y, radius + 4, 0, Math.PI * 2);
    ctx.fill();
  }
  
  // ì ì„ ë” í¬ê²Œ ê·¸ë¦¬ê³  ë“œë˜ê·¸ ì˜ì—­ì„ ë„“ê²Œ
  ctx.fillStyle = color;
  ctx.strokeStyle = isSelected ? 'rgba(124,156,255,1)' : 'rgba(0,0,0,0.8)';
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  ctx.fill();
  ctx.lineWidth = strokeWidth;
  ctx.stroke();
  ctx.font = '12px "Noto Sans KR"';
  const pad = 4;
  const tw = ctx.measureText(label).width;
  const th = 16;
  ctx.fillStyle = isSelected ? 'rgba(124,156,255,0.8)' : 'rgba(0,0,0,0.6)';
  ctx.fillRect(x + 10, y - 12, tw + pad * 2, th);
  ctx.fillStyle = '#e7eef7';
  ctx.fillText(label, x + 10 + pad, y + 1);
}

// ê°ë„ì™€ ì ìˆ˜ë§Œ ê³„ì‚° (ì‹¤ì‹œê°„ í‘œì‹œìš©, AI ë¶„ì„ ì—†ìŒ)
function computeMetricsOnly() {
  const S = sessions[cur];
  const P = getPts(cur);
  let cva = null, pelvic = null, knee = null;

  if(P.C7 && P.Tragus) {
    // CVA: C7 SPì—ì„œ ì‹œì‘í•˜ëŠ” ìˆ˜í‰ì„ ê³¼ C7 SPì—ì„œ Tragusë¡œ ê°€ëŠ” ë²¡í„° ì‚¬ì´ì˜ ê°ë„
    const dx = P.Tragus.x - P.C7.x;
    const dy = P.Tragus.y - P.C7.y;
    const angle = Math.atan2(dy, dx);
    let cvaDeg = rad2deg(angle);
    
    // CVAëŠ” 0~90ë„ ë²”ìœ„ë¡œ ì •ê·œí™”
    if(cvaDeg < 0) {
      cvaDeg = 180 + cvaDeg;
    }
    if(cvaDeg > 90) {
      cvaDeg = 180 - cvaDeg;
    }
    cva = cvaDeg;
  }
  if(P.ASIS && P.PSIS) {
    // TRUNK ê°ë„: ìˆ˜í‰ì„ ê³¼ ASIS-PSIS ì„  ì‚¬ì´ì˜ ê°ë„
    // ASISì—ì„œ PSISë¡œ ê°€ëŠ” ë²¡í„°ì˜ ê°ë„ë¥¼ ê³„ì‚°
    const dx = P.PSIS.x - P.ASIS.x;
    const dy = P.PSIS.y - P.ASIS.y;
    const angle = Math.atan2(dy, dx);
    let pelvicDeg = rad2deg(angle);
    
    // ìˆ˜í‰ì„  ê¸°ì¤€ìœ¼ë¡œ ê°ë„ ì •ê·œí™” (-90~90ë„ ë²”ìœ„)
    // -176.4ë„ëŠ” 180 + (-176.4) = 3.6ë„ë¡œ ë³€í™˜ë˜ì–´ì•¼ í•¨
    // ê°ë„ë¥¼ -180~180 ë²”ìœ„ì—ì„œ -90~90 ë²”ìœ„ë¡œ ë³€í™˜
    if(pelvicDeg < -90) {
      // -176.4ë„ ê°™ì€ ê²½ìš°: 180 + (-176.4) = 3.6ë„
      pelvicDeg = 180 + pelvicDeg;
    } else if(pelvicDeg > 90) {
      // 176.4ë„ ê°™ì€ ê²½ìš°: 176.4 - 180 = -3.6ë„
      pelvicDeg = pelvicDeg - 180;
    }
    
    pelvic = pelvicDeg;
  }
  if(P.Hip && P.Knee && P.Ankle) {
    knee = rad2deg(internalAngle(P.Hip, P.Knee, P.Ankle));
  }

  S.metrics = { cva, pelvic, knee };
  const score = computeScore(cva, pelvic, knee);
  S.score = score;
  
  // AI ë¶„ì„ì€ í•˜ì§€ ì•ŠìŒ (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ)
  
  updateDisplay();
  updateCompare();
  // ì ìˆ˜ë§Œ ì—…ë°ì´íŠ¸ (AI ë¶„ì„ ì—†ìŒ)
  const scoreEl = document.getElementById("totalScore");
  const reasonEl = document.getElementById("scoreReason");
  if(scoreEl && score) {
    scoreEl.textContent = score.score;
    if(score >= 85) {
      scoreEl.style.color = "#2ec4b6";
    } else if(score >= 70) {
      scoreEl.style.color = "#ffd166";
    } else {
      scoreEl.style.color = "#ff6b6b";
    }
  }
  if(reasonEl && score) {
    if(score.reasons && score.reasons.length > 0) {
      reasonEl.textContent = "ê°ì  ê·¼ê±°: " + score.reasons.join(", ");
    } else {
      reasonEl.textContent = "ëª¨ë“  ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.";
    }
  }
}

// ì „ì²´ ê³„ì‚° (AI ë¶„ì„ í¬í•¨) - ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ í˜¸ì¶œ
function computeAll() {
  const S = sessions[cur];
  const P = getPts(cur);
  let cva = null, pelvic = null, knee = null;

  if(P.C7 && P.Tragus) {
    const dx = P.Tragus.x - P.C7.x;
    const dy = P.Tragus.y - P.C7.y;
    const angle = Math.atan2(dy, dx);
    let cvaDeg = rad2deg(angle);
    
    if(cvaDeg < 0) {
      cvaDeg = 180 + cvaDeg;
    }
    if(cvaDeg > 90) {
      cvaDeg = 180 - cvaDeg;
    }
    cva = cvaDeg;
  }
  if(P.ASIS && P.PSIS) {
    // TRUNK ê°ë„: ìˆ˜í‰ì„ ê³¼ ASIS-PSIS ì„  ì‚¬ì´ì˜ ê°ë„
    // ASISì—ì„œ PSISë¡œ ê°€ëŠ” ë²¡í„°ì˜ ê°ë„ë¥¼ ê³„ì‚°
    const dx = P.PSIS.x - P.ASIS.x;
    const dy = P.PSIS.y - P.ASIS.y;
    const angle = Math.atan2(dy, dx);
    let pelvicDeg = rad2deg(angle);
    
    // ìˆ˜í‰ì„  ê¸°ì¤€ìœ¼ë¡œ ê°ë„ ì •ê·œí™” (-90~90ë„ ë²”ìœ„)
    // -176.4ë„ëŠ” 180 + (-176.4) = 3.6ë„ë¡œ ë³€í™˜ë˜ì–´ì•¼ í•¨
    // ê°ë„ë¥¼ -180~180 ë²”ìœ„ì—ì„œ -90~90 ë²”ìœ„ë¡œ ë³€í™˜
    if(pelvicDeg < -90) {
      // -176.4ë„ ê°™ì€ ê²½ìš°: 180 + (-176.4) = 3.6ë„
      pelvicDeg = 180 + pelvicDeg;
    } else if(pelvicDeg > 90) {
      // 176.4ë„ ê°™ì€ ê²½ìš°: 176.4 - 180 = -3.6ë„
      pelvicDeg = pelvicDeg - 180;
    }
    
    pelvic = pelvicDeg;
  }
  if(P.Hip && P.Knee && P.Ankle) {
    knee = rad2deg(internalAngle(P.Hip, P.Knee, P.Ankle));
  }

  S.metrics = { cva, pelvic, knee };
  const score = computeScore(cva, pelvic, knee);
  S.score = score;
  
  // AI ë¶„ì„ ì‹¤í–‰ (ì €ì¥ ì‹œì—ë§Œ)
  const analysis = analyzeMuscles(cva, pelvic, knee);
  S.analysis = analysis;
  
  updateDisplay();
  updateCompare();
  updateScoreAndAnalysis(score, cva, pelvic, knee, analysis);
}

function computeScore(cva, pelvic, knee) {
  let penalties = 0;
  let reasons = [];
  
  if(cva != null) {
    const target = 50;
    const delta = Math.max(0, target - cva);
    const penalty = Math.min(40, delta * 1.6);
    penalties += penalty;
    if(penalty > 0) {
      reasons.push(`CVA ${cva.toFixed(1)}Â° (ëª©í‘œ ${target}Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  if(pelvic != null) {
    const abs = Math.abs(pelvic);
    const target = 0;
    const penalty = Math.min(30, abs * 2.0);
    penalties += penalty;
    if(penalty > 0) {
      reasons.push(`ê³¨ë°˜ ê¸°ìš¸ê¸° ${pelvic.toFixed(1)}Â° (ëª©í‘œ ${target}Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  if(knee != null) {
    const target = 180;
    const delta = Math.max(0, target - knee);
    const penalty = Math.min(30, delta * 1.0);
    penalties += penalty;
    if(penalty > 0) {
      reasons.push(`ë¬´ë¦ ê° ${knee.toFixed(1)}Â° (ëª©í‘œ ${target}Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  const score = Math.round(clamp(100 - penalties, 0, 100));
  return { score, reasons, penalties };
}

function analyzeMuscles(cva, pelvic, knee) {
  const tight = [];
  const weak = [];
  const comments = [];
  const details = [];
  const exercises = [];
  
  // CVA ë¶„ì„ (ìƒì„¸)
  if(cva != null) {
    if(cva < 50) {
      if(cva < 45) {
        tight.push('ìƒë¶€ìŠ¹ëª¨ê·¼', 'ê²¬ê°‘ê±°ê·¼', 'SCM', 'í‰ì‡„ìœ ëŒê·¼');
        weak.push('ì‹¬ë¶€ê²½ë¶€êµ´ê·¼', 'í•˜ë¶€ìŠ¹ëª¨ê·¼', 'ì „ê±°ê·¼');
        comments.push(`ì „ë°©ë‘ ìì„¸ ì‹¬ê°: CVA ${cva.toFixed(1)}Â°ë¡œ ëª©í‘œ 50Â°ë³´ë‹¤ ${(50-cva).toFixed(1)}Â° ë‚®ìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ìƒë¶€ìŠ¹ëª¨ê·¼ê³¼ ê²¬ê°‘ê±°ê·¼ì´ ì§€ì†ì ìœ¼ë¡œ ìˆ˜ì¶•ë˜ì–´ ëª©ê³¼ ì–´ê¹¨ í†µì¦ì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ì‹¬ë¶€ê²½ë¶€êµ´ê·¼ì´ ì•½í™”ë˜ì–´ ë¨¸ë¦¬ ë¬´ê²Œë¥¼ ì§€ì§€í•˜ì§€ ëª»í•´ ì „ë°© ì´ë™ì´ ê°€ì†í™”ë©ë‹ˆë‹¤.`);
        details.push(`â€¢ ì¥ê¸°ì ìœ¼ë¡œ ê²½ì¶” ë””ìŠ¤í¬ ì••ë ¥ ì¦ê°€ ë° ë‘í†µ, ì–´ê¹¨ ë»£ë»£í•¨ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        exercises.push('1. í„± ë‹¹ê¸°ê¸° ìš´ë™: ë²½ì— ë“±ì„ ëŒ€ê³  í„±ì„ ë’¤ë¡œ ë‹¹ê¸°ë©° 10ì´ˆ ìœ ì§€ (3ì„¸íŠ¸)');
        exercises.push('2. ì‹¬ë¶€ê²½ë¶€êµ´ê·¼ í™œì„±í™”: ëˆ„ì›Œì„œ í„±ì„ ê°€ìŠ´ì— ê°€ê¹ê²Œ ë‹¹ê¸°ë©° ë¨¸ë¦¬ë§Œ ì‚´ì§ ë“¤ì–´ì˜¬ë¦¬ê¸° (10íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('3. í•˜ë¶€ìŠ¹ëª¨ê·¼ ê°•í™”: íŒ”ì„ 30ë„ ê°ë„ë¡œ ì˜¬ë¦¬ë©° ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìœ¼ê¸° (15íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('4. ìƒë¶€ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ë¨¸ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ê¸°ìš¸ì—¬ ë°˜ëŒ€í¸ ì–´ê¹¨ ë°©í–¥ìœ¼ë¡œ ìŠ¤íŠ¸ë ˆì¹­ (ì¢Œìš° ê° 30ì´ˆ)');
      } else {
        tight.push('ìƒë¶€ìŠ¹ëª¨ê·¼', 'ê²¬ê°‘ê±°ê·¼');
        weak.push('ì‹¬ë¶€ê²½ë¶€êµ´ê·¼');
        comments.push(`ì „ë°©ë‘ ìì„¸ ê²½ë¯¸: CVA ${cva.toFixed(1)}Â°ë¡œ ëª©í‘œì— ê·¼ì ‘í•©ë‹ˆë‹¤.`);
        details.push(`â€¢ ìƒë¶€ìŠ¹ëª¨ê·¼ê³¼ ê²¬ê°‘ê±°ê·¼ì— ì•½ê°„ì˜ ê¸´ì¥ì´ ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ì‹¬ë¶€ê²½ë¶€êµ´ê·¼ í™œì„±í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
        exercises.push('1. í„± ë‹¹ê¸°ê¸° ìš´ë™: ë²½ì— ë“±ì„ ëŒ€ê³  í„±ì„ ë’¤ë¡œ ë‹¹ê¸°ê¸° (10ì´ˆÃ—3ì„¸íŠ¸)');
        exercises.push('2. ì‹¬ë¶€ê²½ë¶€êµ´ê·¼ ê°•í™”: ëˆ„ì›Œì„œ ë¨¸ë¦¬ë§Œ ì‚´ì§ ë“¤ì–´ì˜¬ë¦¬ê¸° (10íšŒÃ—2ì„¸íŠ¸)');
        exercises.push('3. ìƒë¶€ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ì¢Œìš° ê° 30ì´ˆì”© ìŠ¤íŠ¸ë ˆì¹­');
      }
    } else if(cva <= 55) {
      comments.push(`ê²½ì¶” ì •ë ¬ ì–‘í˜¸: CVA ${cva.toFixed(1)}Â°`);
      details.push(`â€¢ ê²½ì¶” ì •ë ¬ì´ ì–‘í˜¸í•œ ìƒíƒœì…ë‹ˆë‹¤.`);
      details.push(`â€¢ í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•œ ì •ê¸°ì ì¸ ìŠ¤íŠ¸ë ˆì¹­ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`);
    } else {
      comments.push(`ê²½ì¶” í›„ë°© ê²½ì‚¬: CVA ${cva.toFixed(1)}Â°ë¡œ ëª©í‘œë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤.`);
      details.push(`â€¢ ê²½ì¶”ê°€ ê³¼ë„í•˜ê²Œ í›„ë°©ìœ¼ë¡œ ê¸°ìš¸ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.`);
      exercises.push('1. ê²½ì¶” ì „ë°© êµ´ê³¡ ìš´ë™: ì²œì²œíˆ í„±ì„ ê°€ìŠ´ ë°©í–¥ìœ¼ë¡œ ë‚´ë¦¬ê¸° (10íšŒÃ—2ì„¸íŠ¸)');
    }
  }
  
  // ê³¨ë°˜ ê¸°ìš¸ê¸° ë¶„ì„ (ìƒì„¸)
  if(pelvic != null) {
    const abs = Math.abs(pelvic);
    if(abs > 5) {
      if(pelvic > 0) {
        tight.push('ì¥ìš”ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼', 'ëŒ€í‡´ì§ê·¼', 'í‰ìš”ê·¼ë§‰');
        weak.push('ë³µíš¡ê·¼', 'ë‘”ê·¼', 'ëŒ€ë‘”ê·¼', 'ì¤‘ë‘”ê·¼', 'í•˜ë‘”ê·¼');
        comments.push(`ê³¨ë°˜ ì „ë°©ê²½ì‚¬ ì‹¬ê°: ${pelvic.toFixed(1)}Â°ë¡œ ëª©í‘œ 0Â°ë³´ë‹¤ ${pelvic.toFixed(1)}Â° í½ë‹ˆë‹¤.`);
        details.push(`â€¢ ì¥ìš”ê·¼ì´ ë‹¨ì¶•ë˜ì–´ ê³¨ë°˜ì„ ì•ìœ¼ë¡œ ë‹¹ê¸°ê³  ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ìš”ì¶” ì „ë§Œì´ ì¦ê°€í•˜ì—¬ í—ˆë¦¬ í†µì¦ ìœ„í—˜ì´ ë†’ìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ë³µíš¡ê·¼ê³¼ ë‘”ê·¼ì´ ì•½í™”ë˜ì–´ ê³¨ë°˜ ì•ˆì •ì„±ì´ ë–¨ì–´ì§‘ë‹ˆë‹¤.`);
        exercises.push('1. ì¥ìš”ê·¼ ìŠ¤íŠ¸ë ˆì¹­: í•œìª½ ë¬´ë¦ì„ ì•ìœ¼ë¡œ ë‚´ë°€ê³  ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¥¼ ë’¤ë¡œ ë»—ì–´ ìŠ¤íŠ¸ë ˆì¹­ (ì¢Œìš° ê° 30ì´ˆÃ—3íšŒ)');
        exercises.push('2. ë‘”ê·¼ ê°•í™”: ëˆ„ì›Œì„œ ì—‰ë©ì´ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©° ë‘”ê·¼ ìˆ˜ì¶• (15íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('3. ë³µíš¡ê·¼ í™œì„±í™”: ë„¤ ë°œë¡œ ì—ë“œë ¤ì„œ ë³µë¶€ë¥¼ ì•ˆìœ¼ë¡œ ë‹¹ê¸°ë©° í˜¸í¡ (10íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('4. í™ ë¸Œë¦¿ì§€: ëˆ„ì›Œì„œ ë¬´ë¦ì„ êµ¬ë¶€ë¦¬ê³  ì—‰ë©ì´ë¥¼ ë“¤ì–´ì˜¬ë¦¬ê¸° (15íšŒÃ—3ì„¸íŠ¸)');
      } else {
        tight.push('ë‘”ê·¼', 'í–„ìŠ¤íŠ¸ë§', 'ìš”ì¶”ì‹ ê·¼');
        weak.push('ë³µì§ê·¼', 'ì¥ìš”ê·¼', 'ëŒ€í‡´ì‚¬ë‘ê·¼');
        comments.push(`ê³¨ë°˜ í›„ë°©ê²½ì‚¬: ${pelvic.toFixed(1)}Â°ë¡œ ëª©í‘œ 0Â°ë³´ë‹¤ ì‘ìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ë‘”ê·¼ê³¼ í–„ìŠ¤íŠ¸ë§ì´ ê³¼ë„í•˜ê²Œ ê¸´ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ë³µì§ê·¼ê³¼ ì¥ìš”ê·¼ì´ ì•½í™”ë˜ì–´ ê³¨ë°˜ì´ ë’¤ë¡œ ê¸°ìš¸ì–´ì§‘ë‹ˆë‹¤.`);
        exercises.push('1. ë‘”ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ì•‰ì•„ì„œ í•œìª½ ë¬´ë¦ì„ ê°€ìŠ´ì— ë‹¹ê¸°ê¸° (ì¢Œìš° ê° 30ì´ˆ)');
        exercises.push('2. í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­: ë‹¤ë¦¬ë¥¼ ë»—ê³  ì•ìœ¼ë¡œ ìˆ™ì´ê¸° (30ì´ˆÃ—3íšŒ)');
        exercises.push('3. ë³µì§ê·¼ ê°•í™”: í¬ëŸ°ì¹˜ ìš´ë™ (15íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('4. ì¥ìš”ê·¼ ê°•í™”: ë¬´ë¦ ë‹¹ê¸°ê¸° ìš´ë™ (10íšŒÃ—3ì„¸íŠ¸)');
      }
    } else {
      comments.push(`ê³¨ë°˜ ì •ë ¬ ì–‘í˜¸: ${pelvic.toFixed(1)}Â°`);
      details.push(`â€¢ ê³¨ë°˜ ì •ë ¬ì´ ì–‘í˜¸í•œ ìƒíƒœì…ë‹ˆë‹¤.`);
    }
  }
  
  // ë¬´ë¦ ê°ë„ ë¶„ì„ (ìƒì„¸)
  if(knee != null) {
    if(knee < 175) {
      if(knee < 165) {
        tight.push('í–„ìŠ¤íŠ¸ë§', 'ë¹„ë³µê·¼', 'ê°€ìë¯¸ê·¼', 'ìŠ¬ì™€ê·¼');
        weak.push('ëŒ€í‡´ì‚¬ë‘ê·¼', 'ë‘”ê·¼', 'ëŒ€í‡´ì§ê·¼');
        comments.push(`ë¬´ë¦ ê³¼êµ´ê³¡ ì‹¬ê°: ${knee.toFixed(1)}Â°ë¡œ ëª©í‘œ 180Â°ë³´ë‹¤ ${(180-knee).toFixed(1)}Â° ë‚®ìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ í–„ìŠ¤íŠ¸ë§ê³¼ ë¹„ë³µê·¼ì´ ì‹¬ê°í•˜ê²Œ ë‹¨ì¶•ë˜ì–´ ë¬´ë¦ì„ êµ¬ë¶€ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ëŒ€í‡´ì‚¬ë‘ê·¼ì´ ì•½í™”ë˜ì–´ ë¬´ë¦ì„ í´ì§€ ëª»í•©ë‹ˆë‹¤.`);
        details.push(`â€¢ ì¥ê¸°ì ìœ¼ë¡œ ë¬´ë¦ ê´€ì ˆ ì••ë ¥ ì¦ê°€ ë° ì „ë°© ì‹­ìì¸ëŒ€ ë¶€ìƒ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.`);
        exercises.push('1. í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­: ì„œì„œ ë‹¤ë¦¬ë¥¼ ì˜¬ë¦¬ê³  ì•ìœ¼ë¡œ ìˆ™ì´ê¸° (ì¢Œìš° ê° 30ì´ˆÃ—3íšŒ)');
        exercises.push('2. ë¹„ë³µê·¼ ìŠ¤íŠ¸ë ˆì¹­: ë²½ì— ì†ì„ ëŒ€ê³  í•œìª½ ë‹¤ë¦¬ë¥¼ ë’¤ë¡œ ë‚´ë°€ë©° ìŠ¤íŠ¸ë ˆì¹­ (ì¢Œìš° ê° 30ì´ˆ)');
        exercises.push('3. ëŒ€í‡´ì‚¬ë‘ê·¼ ê°•í™”: ì˜ìì— ì•‰ì•„ ë‹¤ë¦¬ë¥¼ í´ë©° ë¬´ë¦ ë½ (10ì´ˆ ìœ ì§€Ã—10íšŒ)');
        exercises.push('4. ìŠ¤ì¿¼íŠ¸: ì²œì²œíˆ ì•‰ì•˜ë‹¤ ì¼ì–´ì„œê¸° (10íšŒÃ—3ì„¸íŠ¸)');
      } else {
        tight.push('í–„ìŠ¤íŠ¸ë§', 'ë¹„ë³µê·¼');
        weak.push('ëŒ€í‡´ì‚¬ë‘ê·¼');
        comments.push(`ë¬´ë¦ ì•½ê°„ êµ´ê³¡: ${knee.toFixed(1)}Â°ë¡œ ëª©í‘œì— ê·¼ì ‘í•©ë‹ˆë‹¤.`);
        details.push(`â€¢ í–„ìŠ¤íŠ¸ë§ê³¼ ë¹„ë³µê·¼ì— ì•½ê°„ì˜ ê¸´ì¥ì´ ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ëŒ€í‡´ì‚¬ë‘ê·¼ ê°•í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
        exercises.push('1. í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­: ì¢Œìš° ê° 30ì´ˆì”© ìŠ¤íŠ¸ë ˆì¹­');
        exercises.push('2. ëŒ€í‡´ì‚¬ë‘ê·¼ ê°•í™”: ì˜ìì— ì•‰ì•„ ë‹¤ë¦¬ í´ê¸° (10íšŒÃ—2ì„¸íŠ¸)');
        exercises.push('3. ìŠ¤ì¿¼íŠ¸: 10íšŒÃ—2ì„¸íŠ¸');
      }
    } else if(knee <= 185) {
      comments.push(`ë¬´ë¦ ì •ë ¬ ì–‘í˜¸: ${knee.toFixed(1)}Â°`);
      details.push(`â€¢ ë¬´ë¦ ì •ë ¬ì´ ì–‘í˜¸í•œ ìƒíƒœì…ë‹ˆë‹¤.`);
    } else {
      comments.push(`ë¬´ë¦ ê³¼ì‹ ì „: ${knee.toFixed(1)}Â°ë¡œ ëª©í‘œë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
      details.push(`â€¢ ë¬´ë¦ì´ ê³¼ë„í•˜ê²Œ í´ì ¸ ìˆì–´ í›„ë°© ì‹­ìì¸ëŒ€ ë¶€ìƒ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.`);
      exercises.push('1. ë¬´ë¦ ë¯¸ì„¸ êµ´ê³¡ ì—°ìŠµ: ì„œì„œ ë¬´ë¦ì„ ì‚´ì§ êµ¬ë¶€ë¦¬ê¸° (10íšŒÃ—2ì„¸íŠ¸)');
      exercises.push('2. ëŒ€í‡´ì‚¬ë‘ê·¼ ì´ì™„: ëˆ„ì›Œì„œ ë¬´ë¦ ì•„ë˜ì— ë² ê°œë¥¼ ë„£ê³  ìŠ¤íŠ¸ë ˆì¹­');
    }
  }
  
  // ì¢…í•© ìš´ë™ ì¶”ì²œ
  if(exercises.length === 0 && (tight.length > 0 || weak.length > 0)) {
    exercises.push('1. ì „ì‹  ìŠ¤íŠ¸ë ˆì¹­: ë§¤ì¼ ì•„ì¹¨ 10ë¶„ê°„ ì „ì‹  ìŠ¤íŠ¸ë ˆì¹­');
    exercises.push('2. ì½”ì–´ ê°•í™”: í”Œë­í¬ 30ì´ˆ ìœ ì§€ (3ì„¸íŠ¸)');
    exercises.push('3. ìì„¸ êµì • ìš´ë™: ë²½ì— ë“±ì„ ëŒ€ê³  ì„œì„œ ëª¸ ì •ë ¬ ìœ ì§€ (1ë¶„Ã—3íšŒ)');
  }
  
  // í•„ë¼í…ŒìŠ¤ ì¶”ì²œ
  const pilates = recommendPilates([...new Set(tight)], [...new Set(weak)]);
  
  return { 
    tight: [...new Set(tight)], 
    weak: [...new Set(weak)], 
    comments,
    details,
    exercises: [...new Set(exercises)],
    pilates
  };
}

function updateScoreAndAnalysis(scoreData, cva, pelvic, knee, analysis) {
  const scoreEl = document.getElementById("totalScore");
  const reasonEl = document.getElementById("scoreReason");
  const commentEl = document.getElementById("aiComment");
  const commentPanel = document.getElementById("aiCommentPanel");
  const musclePanel = document.getElementById("musclePanel");
  const tightList = document.getElementById("muscleTightList");
  const weakList = document.getElementById("muscleWeakList");
  const detailList = document.getElementById("muscleDetailList");
  const exercisePanel = document.getElementById("exercisePanel");
  const exerciseList = document.getElementById("exerciseList");
  const pilatesPanel = document.getElementById("pilatesPanel");
  const pilatesList = document.getElementById("pilatesList");
  
  if(scoreData && scoreData.score != null) {
    const score = scoreData.score;
    scoreEl.textContent = score;
    
    // ì ìˆ˜ ìƒ‰ìƒ
    if(score >= 85) {
      scoreEl.style.color = "#2ec4b6";
    } else if(score >= 70) {
      scoreEl.style.color = "#ffd166";
    } else {
      scoreEl.style.color = "#ff6b6b";
    }
    
    // ì ìˆ˜ ê·¼ê±°
    if(scoreData.reasons && scoreData.reasons.length > 0) {
      reasonEl.textContent = "ê°ì  ê·¼ê±°: " + scoreData.reasons.join(", ");
    } else {
      reasonEl.textContent = "ëª¨ë“  ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.";
    }
  } else {
    scoreEl.textContent = "â€”";
    reasonEl.textContent = "";
  }
  
  // AI ì½”ë©˜íŠ¸ (ë” ìƒì„¸í•˜ê²Œ)
  if(analysis && analysis.comments && analysis.comments.length > 0) {
    let commentText = analysis.comments.join(" ");
    if(analysis.details && analysis.details.length > 0) {
      commentText += "\n\n" + analysis.details.join("\n");
    }
    commentEl.innerHTML = commentText.replace(/\n/g, '<br>');
    commentPanel.style.display = "block";
  } else {
    commentPanel.style.display = "none";
  }
  
  // ê·¼ìœ¡ ë¶„ì„ (ìƒì„¸)
  if(analysis && (analysis.tight.length > 0 || analysis.weak.length > 0)) {
    if(analysis.tight.length > 0) {
      tightList.innerHTML = analysis.tight.join(", ").replace(/,/g, ', ');
    } else {
      tightList.textContent = "ì—†ìŒ";
      tightList.style.color = "var(--muted)";
    }
    
    if(analysis.weak.length > 0) {
      weakList.innerHTML = analysis.weak.join(", ").replace(/,/g, ', ');
    } else {
      weakList.textContent = "ì—†ìŒ";
      weakList.style.color = "var(--muted)";
    }
    
    // ìƒì„¸ ë¶„ì„ í‘œì‹œ
    if(analysis.details && analysis.details.length > 0) {
      detailList.innerHTML = analysis.details.join("<br>");
    } else {
      detailList.textContent = "ìƒì„¸ ë¶„ì„ ì—†ìŒ";
    }
    
    musclePanel.style.display = "block";
  } else {
    musclePanel.style.display = "none";
  }
  
  // ìš´ë™ ì¶”ì²œ
  if(analysis && analysis.exercises && analysis.exercises.length > 0) {
    exerciseList.innerHTML = analysis.exercises.map(ex => `<div style="margin-bottom:6px;">${ex}</div>`).join("");
    exercisePanel.style.display = "block";
  } else {
    exercisePanel.style.display = "none";
  }
  
  // í•„ë¼í…ŒìŠ¤ ì¶”ì²œ
  if(analysis && analysis.pilates && analysis.pilates.length > 0) {
    let pilatesHTML = '';
    analysis.pilates.forEach((item, idx) => {
      pilatesHTML += `<div style="margin-bottom:15px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px;">`;
      pilatesHTML += `<div style="font-size:13px; font-weight:600; margin-bottom:6px; color:#9c88ff;">${idx + 1}. ${item.issue} (${item.muscles.join(', ')})</div>`;
      pilatesHTML += `<div style="font-size:11px; color:var(--muted); margin-bottom:6px;">${item.type === 'ê¸´ì¥' ? 'ê¸´ì¥ ì™„í™”' : 'ê°•í™”'} í•„ìš”</div>`;
      const tools = ['ë§¤íŠ¸', 'ë¦¬í¬ë¨¸', 'ìºë”œë½', 'ì²´ì–´', 'ë°”ë '];
      tools.forEach(tool => {
        if(item.pilates[tool] && item.pilates[tool].length > 0) {
          pilatesHTML += `<div style="margin-top:4px; font-size:11px;"><strong style="color:#9c88ff;">${tool}:</strong> <span style="color:var(--ink);">${item.pilates[tool].join(', ')}</span></div>`;
        }
      });
      pilatesHTML += `</div>`;
    });
    pilatesList.innerHTML = pilatesHTML;
    pilatesPanel.style.display = "block";
  } else {
    pilatesPanel.style.display = "none";
  }
}

function updateDisplay() {
  const M = sessions[cur].metrics;
  document.getElementById("dispCva").textContent = M.cva != null ? M.cva.toFixed(1) + "Â°" : "â€”";
  document.getElementById("dispPel").textContent = M.pelvic != null ? M.pelvic.toFixed(1) + "Â°" : "â€”";
  document.getElementById("dispKnee").textContent = M.knee != null ? M.knee.toFixed(1) + "Â°" : "â€”";
}

function fmtDeg(v) {
  return (v == null || isNaN(v)) ? "â€”" : v.toFixed(1) + "Â°";
}

function deltaStr(b, a, suf = "") {
  if(b == null || a == null || isNaN(b) || isNaN(a)) return "â€”";
  const d = a - b;
  const sign = d > 0 ? "+" : "";
  return sign + d.toFixed(1) + (suf || "");
}

function updateCompare() {
  const B = sessions.Before, A = sessions.After;
  const cB = B.metrics.cva, cA = A.metrics.cva;
  document.getElementById("cmpCvaB").textContent = fmtDeg(cB);
  document.getElementById("cmpCvaA").textContent = fmtDeg(cA);
  document.getElementById("cmpCvaD").textContent = deltaStr(cB, cA, "Â°");

  const pB = B.metrics.pelvic, pA = A.metrics.pelvic;
  document.getElementById("cmpPelB").textContent = fmtDeg(pB);
  document.getElementById("cmpPelA").textContent = fmtDeg(pA);
  document.getElementById("cmpPelD").textContent = deltaStr(pB, pA, "Â°");

  const kB = B.metrics.knee, kA = A.metrics.knee;
  document.getElementById("cmpKneeB").textContent = fmtDeg(kB);
  document.getElementById("cmpKneeA").textContent = fmtDeg(kA);
  document.getElementById("cmpKneeD").textContent = deltaStr(kB, kA, "Â°");
  
  // ì ìˆ˜ ë¹„êµ ì¶”ê°€
  const sB = B.score ? B.score.score : null, sA = A.score ? A.score.score : null;
  if(!document.getElementById("cmpScoreRow")) {
    const tbody = document.querySelector(".tbl tbody");
    const row = document.createElement("tr");
    row.id = "cmpScoreRow";
    row.innerHTML = `
      <td>ì²´í˜• ì ìˆ˜</td>
      <td id="cmpScoreB">â€”</td>
      <td id="cmpScoreA">â€”</td>
      <td id="cmpScoreD">â€”</td>
      <td>0â€“100</td>
    `;
    tbody.appendChild(row);
  }
  document.getElementById("cmpScoreB").textContent = sB != null ? sB : "â€”";
  document.getElementById("cmpScoreA").textContent = sA != null ? sA : "â€”";
  document.getElementById("cmpScoreD").textContent = deltaStr(sB, sA, "");
}

// ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ í† ê¸€
const btnEditCoords = document.getElementById("btnEditCoords");
const coordEditPanel = document.getElementById("coordEditPanel");
if(btnEditCoords && coordEditPanel) {
  btnEditCoords.onclick = () => {
    editMode = !editMode;
    console.log("ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ:", editMode ? "í™œì„±" : "ë¹„í™œì„±");
    if(editMode) {
      // ì›ë³¸ í¬ê¸° ì €ì¥
      if(originalCanvasSize.width === 0) {
        originalCanvasSize.width = cv.width / DPR;
        originalCanvasSize.height = cv.height / DPR;
        originalCanvasSize.styleWidth = parseFloat(cv.style.width) || cv.width / DPR;
        originalCanvasSize.styleHeight = parseFloat(cv.style.height) || cv.height / DPR;
      }
      coordEditPanel.style.display = "block";
      btnEditCoords.style.background = "rgba(124,156,255,0.4)";
      btnEditCoords.textContent = "âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ (í™œì„±)";
      // í™•ëŒ€ ì ìš©
      applyZoom();
    } else {
      // ì›ë˜ í¬ê¸°ë¡œ ë³µì›
      currentZoom = 1;
      coordEditPanel.style.display = "none";
      btnEditCoords.style.background = "rgba(124,156,255,0.2)";
      btnEditCoords.textContent = "âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ";
      selectedPoint = null;
      const selectEl = document.getElementById("coordSelectPoint");
      const xEl = document.getElementById("coordX");
      const yEl = document.getElementById("coordY");
      const zoomEl = document.getElementById("zoomLevel");
      if(selectEl) selectEl.value = "";
      if(xEl) xEl.value = "";
      if(yEl) yEl.value = "";
      if(zoomEl) zoomEl.value = "1";
      // ì›ë³¸ í¬ê¸°ë¡œ ë³µì›
      if(sessions[cur].img) {
        resizeCanvasFor(sessions[cur].img);
      }
      draw(); // ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    }
  };
} else {
  console.error("ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", {btnEditCoords, coordEditPanel});
}

// í™•ëŒ€ ì ìš© í•¨ìˆ˜
function applyZoom() {
  if(!editMode || !sessions[cur].img) {
    return;
  }
  const zoomEl = document.getElementById("zoomLevel");
  if(zoomEl) {
    const newZoom = parseInt(zoomEl.value) || 1;
    currentZoom = clamp(newZoom, 1, 4); // 1~4ë°°ë¡œ ì œí•œ
  }
  
  // ì›ë³¸ ì´ë¯¸ì§€ë¡œ í™•ëŒ€ ì ìš© (ë¹„ìœ¨ ìœ ì§€)
  const img = sessions[cur].img;
  resizeCanvasFor(img);
  
  // ì¢Œí‘œ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
  if(selectedPoint) {
    const P = getPts(cur);
    const pt = P[selectedPoint];
    if(pt && coordX && coordY) {
      // ì¢Œí‘œëŠ” í•­ìƒ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œ
      coordX.value = pt.x.toFixed(1);
      coordY.value = pt.y.toFixed(1);
    }
  }
}

// í™•ëŒ€ ë°°ìœ¨ ë³€ê²½
const zoomLevel = document.getElementById("zoomLevel");
if(zoomLevel) {
  zoomLevel.addEventListener("change", () => {
    if(editMode) {
      applyZoom();
    }
  });
}

// ì  ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½
const coordSelectPoint = document.getElementById("coordSelectPoint");
const coordX = document.getElementById("coordX");
const coordY = document.getElementById("coordY");

// ì  ì„ íƒ ì‹œ ì¢Œí‘œ í‘œì‹œ í•¨ìˆ˜
function updateCoordDisplay() {
  if(!coordX || !coordY) return;
  
  if(selectedPoint) {
    const P = getPts(cur);
    const pt = P[selectedPoint];
    if(pt) {
      // ì›ë³¸ í¬ê¸° ê¸°ì¤€ ì¢Œí‘œ í‘œì‹œ
      coordX.value = pt.x.toFixed(1);
      coordY.value = pt.y.toFixed(1);
    } else {
      // ì ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì • (ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° ì¤‘ì•™ ê·¼ì²˜)
      if(sessions[cur].img) {
        const originalW = originalCanvasSize.width || (cv.width / DPR);
        const originalH = originalCanvasSize.height || (cv.height / DPR);
        const defaultX = (originalW / 2).toFixed(1);
        const defaultY = (originalH / 2).toFixed(1);
        coordX.value = defaultX;
        coordY.value = defaultY;
      } else {
        coordX.value = "";
        coordY.value = "";
      }
    }
    draw();
  } else {
    coordX.value = "";
    coordY.value = "";
    draw();
  }
}

if(coordSelectPoint && coordX && coordY) {
  coordSelectPoint.addEventListener("change", e => {
    selectedPoint = e.target.value || null;
    console.log("ì„ íƒëœ ì :", selectedPoint);
    updateCoordDisplay();
  });
  
  // ì´ˆê¸°í™” ì‹œì—ë„ ì¢Œí‘œ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì ì´ ì´ë¯¸ ì„ íƒë˜ì–´ ìˆìœ¼ë©´)
  if(selectedPoint) {
    updateCoordDisplay();
  }
} else {
  console.error("ì¢Œí‘œ ì…ë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", {coordSelectPoint, coordX, coordY});
}

// ë“œë˜ê·¸í•  ë•Œë„ ì¢Œí‘œ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
window.updateCoordDisplay = updateCoordDisplay;

// ì¢Œí‘œ ì ìš© (ì €ì¥ ë²„íŠ¼ ì—­í•  - AI ë¶„ì„ ì‹¤í–‰)
const coordApply = document.getElementById("coordApply");
if(coordApply) {
  coordApply.onclick = () => {
    if(!selectedPoint) {
      alert("ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    const x = parseFloat(coordX.value);
    const y = parseFloat(coordY.value);
    if(isNaN(x) || isNaN(y)) {
      alert("ì˜¬ë°”ë¥¸ ì¢Œí‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    // ì¢Œí‘œëŠ” í•­ìƒ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì €ì¥
    const originalW = originalCanvasSize.width || (cv.width / DPR / (editMode ? currentZoom : 1));
    const originalH = originalCanvasSize.height || (cv.height / DPR / (editMode ? currentZoom : 1));
    const map = sessions[cur].pts;
    const clampedX = clamp(x, 0, originalW);
    const clampedY = clamp(y, 0, originalH);
    map.set(selectedPoint, {
      x: clampedX,
      y: clampedY
    });
    draw();
    // ì €ì¥ ë²„íŠ¼ì´ë¯€ë¡œ AI ë¶„ì„ ì‹¤í–‰
    computeAll();
    // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
    coordX.value = clampedX.toFixed(1);
    coordY.value = clampedY.toFixed(1);
    // ì €ì¥ í›„ ì›ë˜ í¬ê¸°ë¡œ ë³µì›
    if(editMode) {
      currentZoom = 1;
      const zoomEl = document.getElementById("zoomLevel");
      if(zoomEl) zoomEl.value = "1";
      if(sessions[cur].img) {
        resizeCanvasFor(sessions[cur].img);
        draw();
      }
    }
  };
}

// ì·¨ì†Œ
const coordCancel = document.getElementById("coordCancel");
if(coordCancel) {
  coordCancel.onclick = () => {
    selectedPoint = null;
    if(coordSelectPoint) coordSelectPoint.value = "";
    if(coordX) coordX.value = "";
    if(coordY) coordY.value = "";
    draw();
  };
}

// X, Y ì¢Œí‘œ ì…ë ¥ í•„ë“œì—ì„œ Enter í‚¤ë¡œë„ ì ìš© ê°€ëŠ¥
if(coordX) {
  coordX.addEventListener("keypress", e => {
    if(e.key === "Enter") {
      if(coordApply) coordApply.click();
    }
  });
}
if(coordY) {
  coordY.addEventListener("keypress", e => {
    if(e.key === "Enter") {
      if(coordApply) coordApply.click();
    }
  });
}

// ì¢Œí‘œ ì¦ê° ë²„íŠ¼ ê¸°ëŠ¥ (ìë™ ì ìš©)
function adjustCoordinate(coordField, delta) {
  if(!coordField) return;
  
  // í˜„ì¬ ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
  let currentValue = parseFloat(coordField.value);
  if(isNaN(currentValue)) {
    // ì¢Œí‘œê°€ ì—†ìœ¼ë©´ ì¤‘ì•™ê°’ìœ¼ë¡œ ì„¤ì •
    const originalW = originalCanvasSize.width || (cv.width / DPR);
    const originalH = originalCanvasSize.height || (cv.height / DPR);
    if(coordField === coordX) {
      currentValue = originalW / 2;
    } else {
      currentValue = originalH / 2;
    }
  }
  
  const newValue = currentValue + delta;
  coordField.value = newValue.toFixed(1);
  
  // ìë™ìœ¼ë¡œ ì ìš© (ì ì´ ì„ íƒë˜ì–´ ìˆê³  ì¢Œí‘œê°€ ìœ íš¨í•œ ê²½ìš°)
  if(selectedPoint && !isNaN(newValue)) {
    const xField = coordX;
    const yField = coordY;
    if(!xField || !yField) return;
    
    const x = parseFloat(xField.value);
    const y = parseFloat(yField.value);
    
    if(!isNaN(x) && !isNaN(y)) {
      // ì¢Œí‘œëŠ” í•­ìƒ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì €ì¥
      const originalW = originalCanvasSize.width || (cv.width / DPR / (editMode ? currentZoom : 1));
      const originalH = originalCanvasSize.height || (cv.height / DPR / (editMode ? currentZoom : 1));
      const map = sessions[cur].pts;
      const clampedX = clamp(x, 0, originalW);
      const clampedY = clamp(y, 0, originalH);
      
      map.set(selectedPoint, {
        x: clampedX,
        y: clampedY
      });
      
      // ì…ë ¥ í•„ë“œë„ ì—…ë°ì´íŠ¸ (í´ë¨í•‘ëœ ê°’)
      xField.value = clampedX.toFixed(1);
      yField.value = clampedY.toFixed(1);
      
    draw();
    computeMetricsOnly(); // ì‹¤ì‹œê°„ ë¶„ì„ ì—†ìŒ (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ AI ë¶„ì„)
    }
  }
}

// ì¦ê° ë²„íŠ¼ ì—°ì† í´ë¦­ ë³€ìˆ˜
let incrementTimer = null;
let incrementInterval = null;

function startIncrement(coordField, delta) {
  // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
  adjustCoordinate(coordField, delta);
  
  // ì§§ì€ ë”œë ˆì´ í›„ ì—°ì† ì‹¤í–‰
  incrementTimer = setTimeout(() => {
    incrementInterval = setInterval(() => {
      adjustCoordinate(coordField, delta);
    }, 50); // 50msë§ˆë‹¤ ì‹¤í–‰ (ë¹ ë¥¸ ì¦ê°)
  }, 300); // 300ms í›„ ì—°ì† ì‹¤í–‰ ì‹œì‘
}

function stopIncrement() {
  if(incrementTimer) {
    clearTimeout(incrementTimer);
    incrementTimer = null;
  }
  if(incrementInterval) {
    clearInterval(incrementInterval);
    incrementInterval = null;
  }
}

// X ì¢Œí‘œ ì¦ê° ë²„íŠ¼
const coordXDec = document.getElementById("coordXDec");
const coordXInc = document.getElementById("coordXInc");
if(coordXDec) {
  coordXDec.onmousedown = () => {
    if(coordX) startIncrement(coordX, -0.1);
  };
  coordXDec.onmouseup = stopIncrement;
  coordXDec.onmouseleave = stopIncrement;
  coordXDec.ontouchstart = (e) => {
    e.preventDefault();
    if(coordX) startIncrement(coordX, -0.1);
  };
  coordXDec.ontouchend = (e) => {
    e.preventDefault();
    stopIncrement();
  };
  coordXDec.ontouchcancel = (e) => {
    e.preventDefault();
    stopIncrement();
  };
}
if(coordXInc) {
  coordXInc.onmousedown = () => {
    if(coordX) startIncrement(coordX, 0.1);
  };
  coordXInc.onmouseup = stopIncrement;
  coordXInc.onmouseleave = stopIncrement;
  coordXInc.ontouchstart = (e) => {
    e.preventDefault();
    if(coordX) startIncrement(coordX, 0.1);
  };
  coordXInc.ontouchend = (e) => {
    e.preventDefault();
    stopIncrement();
  };
  coordXInc.ontouchcancel = (e) => {
    e.preventDefault();
    stopIncrement();
  };
}

// Y ì¢Œí‘œ ì¦ê° ë²„íŠ¼ (YëŠ” í™”ë©´ ì•„ë˜ë¡œ ê°ˆìˆ˜ë¡ ê°’ì´ ì»¤ì§€ë¯€ë¡œ ë°˜ëŒ€ë¡œ)
const coordYDec = document.getElementById("coordYDec");
const coordYInc = document.getElementById("coordYInc");
if(coordYDec) {
  coordYDec.onmousedown = () => {
    if(coordY) startIncrement(coordY, 0.1); // YëŠ” ìœ„ë¡œ ê°€ë ¤ë©´ ê°’ì´ ì¦ê°€í•´ì•¼ í•¨
  };
  coordYDec.onmouseup = stopIncrement;
  coordYDec.onmouseleave = stopIncrement;
  coordYDec.ontouchstart = (e) => {
    e.preventDefault();
    if(coordY) startIncrement(coordY, 0.1);
  };
  coordYDec.ontouchend = (e) => {
    e.preventDefault();
    stopIncrement();
  };
  coordYDec.ontouchcancel = (e) => {
    e.preventDefault();
    stopIncrement();
  };
}
if(coordYInc) {
  coordYInc.onmousedown = () => {
    if(coordY) startIncrement(coordY, -0.1); // YëŠ” ì•„ë˜ë¡œ ê°€ë ¤ë©´ ê°’ì´ ê°ì†Œí•´ì•¼ í•¨
  };
  coordYInc.onmouseup = stopIncrement;
  coordYInc.onmouseleave = stopIncrement;
  coordYInc.ontouchstart = (e) => {
    e.preventDefault();
    if(coordY) startIncrement(coordY, -0.1);
  };
  coordYInc.ontouchend = (e) => {
    e.preventDefault();
    stopIncrement();
  };
  coordYInc.ontouchcancel = (e) => {
    e.preventDefault();
    stopIncrement();
  };
}

// ë“œë˜ê·¸ ê¸°ëŠ¥ (ë§ˆìš°ìŠ¤ + í„°ì¹˜)
function getEventPos(e) {
  const r = cv.getBoundingClientRect();
  const clientX = e.touches && e.touches.length > 0 ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches && e.touches.length > 0 ? e.touches[0].clientY : e.clientY;
  
  // í™•ëŒ€ ëª¨ë“œì—ì„œ ìŠ¤í¬ë¡¤ ì˜¤í”„ì…‹ ê³ ë ¤
  let x = clientX - r.left;
  let y = clientY - r.top;
  
  if(editMode && currentZoom > 1) {
    const canvasWrap = cv.parentElement;
    const scrollX = canvasWrap.scrollLeft || 0;
    const scrollY = canvasWrap.scrollTop || 0;
    // ìŠ¤í¬ë¡¤ ì˜¤í”„ì…‹ì„ CSS ì¢Œí‘œì— ë”í•¨
    x += scrollX;
    y += scrollY;
  }
  
  // CSS í¬ê¸° ëŒ€ë¹„ ì‹¤ì œ ìº”ë²„ìŠ¤ í¬ê¸° ë¹„ìœ¨ ê³„ì‚°
  const scaleX = cv.width / DPR / r.width;
  const scaleY = cv.height / DPR / r.height;
  
  // ì‹¤ì œ ìº”ë²„ìŠ¤ ì¢Œí‘œë¡œ ë³€í™˜
  x = x * scaleX;
  y = y * scaleY;
  
  // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì—ì„œ í™•ëŒ€ëœ ê²½ìš°, ì¢Œí‘œë¥¼ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜
  if(editMode && currentZoom > 1) {
    x = x / currentZoom;
    y = y / currentZoom;
  }
  
  return { x, y };
}

function startDrag(e) {
  // ì´ì „ ë“œë˜ê·¸ ìƒíƒœ ì™„ì „íˆ ì´ˆê¸°í™” (ë§¤ë²ˆ ìƒˆë¡œìš´ ë“œë˜ê·¸ ì‹œì‘ ì „ì—)
  const hadDragKey = dragKey;
  if(dragKey) {
    console.log('ì´ì „ ë“œë˜ê·¸ ìƒíƒœê°€ ë‚¨ì•„ìˆìŒ, ì´ˆê¸°í™”:', dragKey);
  }
  
  // ìƒíƒœ ì´ˆê¸°í™”
  dragKey = null;
  isScrolling = false;
  scrollDistance = 0;
  
  // í„°ì¹˜ ì´ë²¤íŠ¸ì¸ ê²½ìš° ì†ê°€ë½ ê°œìˆ˜ í™•ì¸
  let touchCount = 0;
  if(e.touches) {
    touchCount = e.touches.length;
    touchStartTime = Date.now();
  }
  
  // í™•ëŒ€ ëª¨ë“œì—ì„œ ìŠ¤í¬ë¡¤ì€ ë‘ ì†ê°€ë½ë§Œ í—ˆìš©
  if(editMode && currentZoom > 1 && touchCount === 2) {
    // ë‘ ì†ê°€ë½ í„°ì¹˜: ìŠ¤í¬ë¡¤ ëª¨ë“œë§Œ í—ˆìš© (ì  ë“œë˜ê·¸ ë¶ˆê°€)
    isScrolling = true;
    dragKey = null;
    if(e.touches && e.touches.length > 0) {
      scrollStartX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
      scrollStartY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
    }
    return false;
  }
  
  // í•œ ì†ê°€ë½ í„°ì¹˜ë§Œ ì  ë“œë˜ê·¸ í—ˆìš©
  if(touchCount > 1 && !(editMode && currentZoom > 1)) {
    // í™•ëŒ€ ëª¨ë“œê°€ ì•„ë‹Œë° ë‘ ì†ê°€ë½ ì´ìƒì´ë©´ ë¬´ì‹œ
    return false;
  }
  
  const pos = getEventPos(e);
  const P = getPts(cur);
  
  // Long press ê´€ë ¨ ìƒíƒœ ì´ˆê¸°í™” (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ ì •ë¦¬ìš©)
  if(longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
  longPressDetected = false;
  longPressNearPoint = null;
  
  // ë¨¼ì € ëª¨ë“  ì ì„ ì²´í¬í•˜ì—¬ ì ì„ í„°ì¹˜í–ˆëŠ”ì§€ í™•ì¸
  // getEventPosëŠ” ì´ë¯¸ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì¢Œí‘œë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ, ì  ì¢Œí‘œì™€ ì§ì ‘ ë¹„êµ ê°€ëŠ¥
  let bestPoint = null;
  let bestDistance = 1e9;
  
  // threshold ê³„ì‚°: í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” 1cm ì •ë„ì˜ ê°ì§€ ì˜ì—­ë§Œ ìœ ì§€
  // 1cmë¥¼ í”½ì…€ë¡œ ë³€í™˜ (ì¼ë°˜ì ìœ¼ë¡œ 96 DPI ê¸°ì¤€ ì•½ 37.8í”½ì…€, í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” devicePixelRatio ê³ ë ¤)
  // ì‹¤ì œ í™”ë©´ í¬ê¸°ë¥¼ ê³ ë ¤í•˜ì—¬ ë” ì •í™•í•˜ê²Œ ê³„ì‚°
  const r = cv.getBoundingClientRect();
  const screenWidth = r.width; // CSS í”½ì…€
  
  // 2cmë¥¼ í”½ì…€ë¡œ ë³€í™˜ (96 DPI ê¸°ì¤€: 1cm â‰ˆ 37.8px, 2cm â‰ˆ 75.6px)
  // í•˜ì§€ë§Œ ì‹¤ì œ í™”ë©´ì—ì„œëŠ” devicePixelRatioë¥¼ ê³ ë ¤í•´ì•¼ í•¨
  // ê°„ë‹¨í•˜ê²Œ í™”ë©´ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ 2cmë¥¼ ì¶”ì • (í™”ë©´ ë„ˆë¹„ì˜ ì•½ 5% ì •ë„)
  const cmToPixel = screenWidth * 0.05; // í™”ë©´ ë„ˆë¹„ì˜ 5%ë¥¼ 2cmë¡œ ì¶”ì •
  const baseThreshold = Math.max(60, Math.min(120, cmToPixel)); // ìµœì†Œ 60px, ìµœëŒ€ 120px (2cm)
  
  // í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ thresholdë¥¼ ê³„ì‚°í•œ í›„ í™•ëŒ€ ë°°ìœ¨ë¡œ ë‚˜ëˆ”
  // ì¦‰, í™•ëŒ€ë˜ì–´ë„ ì‹¤ì œ í™”ë©´ì—ì„œì˜ 1cm ê°ì§€ ì˜ì—­ì„ ìœ ì§€
  let threshold;
  if(editMode && currentZoom > 1) {
    // í™•ëŒ€ ëª¨ë“œ: ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ threshold ì„¤ì • (í™•ëŒ€ ë°°ìœ¨ë¡œ ë‚˜ëˆ”)
    // í™”ë©´ì—ì„œ 1cm ì •ë„ì˜ ê°ì§€ ì˜ì—­ì„ ìœ ì§€í•˜ë ¤ë©´ ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œëŠ” ë” ì‘ì•„ì•¼ í•¨
    threshold = baseThreshold / currentZoom;
  } else {
    // ì¼ë°˜ ëª¨ë“œ: í™”ë©´ í”½ì…€ ê¸°ì¤€ (ë¼ë²¨ ì˜ì—­ í¬í•¨)
    threshold = baseThreshold * 1.5; // ë¼ë²¨ ì˜ì—­ í¬í•¨ì„ ìœ„í•´ ì•½ê°„ ë” í¬ê²Œ
  }
  
  console.log('ë“œë˜ê·¸ ê°ì§€ ì‹œì‘, threshold:', threshold, 'editMode:', editMode, 'zoom:', currentZoom);
  
  // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì¼ ë•ŒëŠ” ì„ íƒëœ ì ë§Œ ì²´í¬
  if(editMode && selectedPoint) {
    const pt = P[selectedPoint];
    if(pt) {
      // í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ê±°ë¦¬ ê³„ì‚° (thresholdë„ ì›ë³¸ ê¸°ì¤€)
      // posëŠ” ì´ë¯¸ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜ë˜ì–´ ìˆìŒ
      const d = Math.hypot(pt.x - pos.x, pt.y - pos.y);
      if(d < threshold) {
        bestPoint = selectedPoint;
        bestDistance = d;
      }
    }
  } else {
    // ì¼ë°˜ ëª¨ë“œ: ëª¨ë“  ì  ì²´í¬
    for(const k of keypoints) {
      const p = P[k.key];
      if(!p) continue;
      
      let d;
      
      if(editMode && currentZoom > 1) {
        // í™•ëŒ€ ëª¨ë“œ: ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ê±°ë¦¬ ê³„ì‚°
        // posëŠ” ì´ë¯¸ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜ë˜ì–´ ìˆìŒ
        d = Math.hypot(p.x - pos.x, p.y - pos.y);
      } else {
        // ì¼ë°˜ ëª¨ë“œ: í™”ë©´ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ê±°ë¦¬ ê³„ì‚° (ë¼ë²¨ ì˜ì—­ í¬í•¨)
        const scaleX = 1;
        const scaleY = 1;
        const screenPtX = p.x * scaleX;
        const screenPtY = p.y * scaleY;
        const screenPosX = pos.x * scaleX;
        const screenPosY = pos.y * scaleY;
        
        // ì ê³¼ì˜ ê±°ë¦¬ ê³„ì‚°
        d = Math.hypot(screenPtX - screenPosX, screenPtY - screenPosY);
        
        // ë¼ë²¨ ì˜ì—­ ì²´í¬ (ì  ì˜¤ë¥¸ìª½ì— ë¼ë²¨ì´ ìˆìŒ)
        // ë¼ë²¨ì€ ì  ì˜¤ë¥¸ìª½ì— ìœ„ì¹˜: x + 10ë¶€í„° ì‹œì‘, ë„ˆë¹„ëŠ” ëŒ€ëµ 100í”½ì…€, ë†’ì´ëŠ” 16í”½ì…€
        const labelX = screenPtX + 10;
        const labelY = screenPtY - 12;
        const labelWidth = 100; // ë¼ë²¨ ìµœëŒ€ ë„ˆë¹„
        const labelHeight = 16;
        
        // ë¼ë²¨ ì˜ì—­ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
        if(screenPosX >= labelX && screenPosX <= labelX + labelWidth &&
           screenPosY >= labelY && screenPosY <= labelY + labelHeight) {
          d = 0; // ë¼ë²¨ ì˜ì—­ ë‚´ì— ìˆìœ¼ë©´ ìµœìš°ì„ 
        }
      }
      
      if(d < threshold && d < bestDistance) {
        bestPoint = k.key;
        bestDistance = d;
      }
    }
  }
  
  // ì  ê·¼ì²˜ë¥¼ í„°ì¹˜í–ˆìœ¼ë©´ ì¦‰ì‹œ ë“œë˜ê·¸ ëª¨ë“œë¡œ ì „í™˜ (Long press ì œê±°)
  if(bestPoint) {
    // preventDefaultëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í•˜ì§€ ì•ŠìŒ
    isScrolling = false;
    dragKey = bestPoint;
    
    // ìŠ¤í¬ë¡¤ ì‹œì‘ ìœ„ì¹˜ ì €ì¥ (ë“œë˜ê·¸ ì¤‘ì—ë„ ì‚¬ìš©)
    if(e.touches && e.touches.length > 0) {
      scrollStartX = e.touches[0].clientX;
      scrollStartY = e.touches[0].clientY;
    } else {
      scrollStartX = e.clientX;
      scrollStartY = e.clientY;
    }
    
    console.log('ë“œë˜ê·¸ ì‹œì‘:', bestPoint, 'pos:', pos, 'dragKey:', dragKey);
    return true;
  }
  
  // ì ì´ ì•„ë‹Œ ë¹ˆ í™”ë©´ì„ í„°ì¹˜í–ˆìœ¼ë©´
  // í™•ëŒ€ ëª¨ë“œì—ì„œ í•œ ì†ê°€ë½ í„°ì¹˜ëŠ” ìŠ¤í¬ë¡¤ ë¶ˆê°€ (ë‘ ì†ê°€ë½ë§Œ ìŠ¤í¬ë¡¤)
  // ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•ŠìŒ
  isScrolling = false;
  dragKey = null;
  return false;
}

function doDrag(e) {
  // í„°ì¹˜ ì´ë²¤íŠ¸ì¸ ê²½ìš° ì†ê°€ë½ ê°œìˆ˜ í™•ì¸
  let touchCount = 0;
  if(e.touches) {
    touchCount = e.touches.length;
  }
  
  // ë‘ ì†ê°€ë½ í„°ì¹˜: ìŠ¤í¬ë¡¤ë§Œ í—ˆìš© (í™•ëŒ€ ëª¨ë“œì—ì„œë§Œ)
  if(touchCount === 2 && editMode && currentZoom > 1) {
    e.preventDefault();
    e.stopPropagation();
    
    // ë‘ ì†ê°€ë½ì˜ ì¤‘ì‹¬ì  ê³„ì‚°
    const touch1 = e.touches[0];
    const touch2 = e.touches[1];
    const currentX = (touch1.clientX + touch2.clientX) / 2;
    const currentY = (touch1.clientY + touch2.clientY) / 2;
    
    // ìŠ¤í¬ë¡¤ë§Œ ìˆ˜í–‰
    const canvasWrap = cv.parentElement;
    const deltaX = scrollStartX - currentX;
    const deltaY = scrollStartY - currentY;
    canvasWrap.scrollLeft += deltaX;
    canvasWrap.scrollTop += deltaY;
    scrollStartX = currentX;
    scrollStartY = currentY;
    return;
  }
  
  // í•œ ì†ê°€ë½ë§Œ ë“œë˜ê·¸ í—ˆìš© (ë‘ ì†ê°€ë½ ì´ìƒì´ë©´ ë¬´ì‹œ)
  if(touchCount > 1 && !(editMode && currentZoom > 1 && touchCount === 2)) {
    return;
  }
  
  // dragKeyê°€ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ì²˜ë¦¬ ì•ˆ í•¨
  if(!dragKey) {
    return;
  }
  
  // ë“œë˜ê·¸ ëª¨ë“œê°€ ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë“œë˜ê·¸ ì²˜ë¦¬ë§Œ ìˆ˜í–‰ (ìŠ¤í¬ë¡¤ ì™„ì „ ì°¨ë‹¨)
  if(dragKey) {
    e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
    e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨
    
    const pos = getEventPos(e);
    // ì¢Œí‘œëŠ” í•­ìƒ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì €ì¥
    const originalW = originalCanvasSize.width || (cv.width / DPR / (editMode ? currentZoom : 1));
    const originalH = originalCanvasSize.height || (cv.height / DPR / (editMode ? currentZoom : 1));
    const x = clamp(pos.x, 0, originalW);
    const y = clamp(pos.y, 0, originalH);
    const map = sessions[cur].pts;
    const p = map.get(dragKey);
    
    if(!p) {
      // ì ì´ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ì¢…ë£Œ
      console.log('ì ì´ ì—†ì–´ ë“œë˜ê·¸ ì¢…ë£Œ:', dragKey);
      dragKey = null;
      isScrolling = false;
      return;
    }
    
    // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” ì„ íƒëœ ì ë§Œ ì´ë™
    if(editMode && selectedPoint) {
      if(dragKey !== selectedPoint) {
        // ì„ íƒëœ ì ì´ ì•„ë‹ˆë©´ ë“œë˜ê·¸ ì¢…ë£Œí•˜ì§€ ì•Šê³  ê³„ì† ì§„í–‰
        // (ë‹¤ë¥¸ ì ì„ ë“œë˜ê·¸í•˜ëŠ” ê²½ìš°ë¥¼ í—ˆìš©)
        return;
      }
    }
    
    // ì¢Œí‘œ ì—…ë°ì´íŠ¸
    p.x = x;
    p.y = y;
    
    // ì…ë ¥ í•„ë“œë„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ì›ë³¸ í¬ê¸° ê¸°ì¤€)
    // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œê°€ ì•„ë‹ˆê±°ë‚˜, ì„ íƒëœ ì ê³¼ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
    if((!editMode || selectedPoint === dragKey) && coordX && coordY) {
      coordX.value = x.toFixed(1);
      coordY.value = y.toFixed(1);
    }
    
    // ì„ íƒëœ ì ê³¼ ì¼ì¹˜í•˜ë©´ ì¢Œí‘œ í‘œì‹œ ì—…ë°ì´íŠ¸
    if(selectedPoint === dragKey && typeof window.updateCoordDisplay === 'function') {
      window.updateCoordDisplay();
    }
    
    draw();
    computeMetricsOnly(); // ì‹¤ì‹œê°„ ë¶„ì„ ì—†ìŒ (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ AI ë¶„ì„)
    return; // ë“œë˜ê·¸ ëª¨ë“œì—ì„œëŠ” ìŠ¤í¬ë¡¤ ì™„ì „ ì°¨ë‹¨
  }
}

function endDrag(e) {
  // Long press íƒ€ì´ë¨¸ ì •ë¦¬ (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ ì •ë¦¬ìš©)
  if(longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
  
  // ë“œë˜ê·¸ê°€ ëë‚˜ë©´ ìƒíƒœ ì™„ì „íˆ ì´ˆê¸°í™” (ë‹¤ìŒ ë“œë˜ê·¸ë¥¼ ìœ„í•´)
  const wasDragging = dragKey !== null;
  if(dragKey) {
    console.log('ë“œë˜ê·¸ ì¢…ë£Œ:', dragKey);
  }
  
  // ëª¨ë“  ìƒíƒœ ì™„ì „íˆ ì´ˆê¸°í™” (ë§¤ë²ˆ í™•ì‹¤íˆ)
  dragKey = null;
  isScrolling = false;
  scrollDistance = 0;
  scrollStartX = 0;
  scrollStartY = 0;
  longPressDetected = false;
  longPressNearPoint = null;
  
  // ë§ˆìš°ìŠ¤ ìƒíƒœë„ ì´ˆê¸°í™”
  if(typeof isMouseDown !== 'undefined') {
    isMouseDown = false;
  }
  
  // ìƒíƒœ ì´ˆê¸°í™” í™•ì¸ ë¡œê·¸
  if(wasDragging) {
    console.log('ë“œë˜ê·¸ ìƒíƒœ ì´ˆê¸°í™” ì™„ë£Œ, ë‹¤ìŒ ë“œë˜ê·¸ ì¤€ë¹„ë¨');
  }
}

// ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
let isMouseDown = false;
cv.addEventListener('mousedown', (e) => {
  isMouseDown = true;
  startDrag(e);
});

window.addEventListener('mouseup', () => {
  isMouseDown = false;
  endDrag();
});

window.addEventListener('mouseleave', () => {
  isMouseDown = false;
  endDrag();
});

window.addEventListener('mousemove', (e) => {
  if(isMouseDown || dragKey) {
    doDrag(e);
  }
});

// í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ ì§€ì›)
cv.addEventListener('touchstart', (e) => {
  // ì´ì „ ë“œë˜ê·¸ ìƒíƒœê°€ ë‚¨ì•„ìˆìœ¼ë©´ ì™„ì „íˆ ì •ë¦¬ (ì•ˆì „ì¥ì¹˜)
  if(dragKey) {
    console.log('âš ï¸ ì´ì „ ë“œë˜ê·¸ ìƒíƒœê°€ ë‚¨ì•„ìˆìŒ, ê°•ì œ ì •ë¦¬:', dragKey);
    endDrag(e); // endDragë¥¼ í˜¸ì¶œí•˜ì—¬ ì™„ì „íˆ ì •ë¦¬
  }
  
  // ìƒˆë¡œìš´ í„°ì¹˜ ì‹œì‘
  const result = startDrag(e);
  
  // ì ì„ í„°ì¹˜í–ˆê±°ë‚˜ ë‘ ì†ê°€ë½ ìŠ¤í¬ë¡¤ì´ë©´ preventDefault
  if(result === true || (e.touches && e.touches.length === 2 && editMode && currentZoom > 1)) {
    e.preventDefault();
    e.stopPropagation();
  }
}, {passive: false});

window.addEventListener('touchmove', (e) => {
  // ë‘ ì†ê°€ë½ í„°ì¹˜ì¸ ê²½ìš° ìŠ¤í¬ë¡¤ ëª¨ë“œ
  if(e.touches && e.touches.length === 2 && editMode && currentZoom > 1) {
    e.preventDefault();
    e.stopPropagation();
    isScrolling = true;
    doDrag(e);
    return;
  }
  
  // í•œ ì†ê°€ë½ í„°ì¹˜ì¸ ê²½ìš°
  if(e.touches && e.touches.length === 1) {
    // dragKeyê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ë“œë˜ê·¸ ëª¨ë“œ
    if(dragKey) {
      e.preventDefault();
      e.stopPropagation();
      doDrag(e);
      return;
    }
    
    // dragKeyê°€ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ì²˜ë¦¬ ì•ˆ í•¨ (ì´ë¯¸ touchstartì—ì„œ ì ì„ ì°¾ì§€ ëª»í–ˆê±°ë‚˜ ì•„ì§ ì²˜ë¦¬ ì¤‘)
    // touchmoveëŠ” touchstart ì´í›„ì—ë§Œ í˜¸ì¶œë˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ë“œë˜ê·¸ë§Œ ì²˜ë¦¬
  }
  
  // ìŠ¤í¬ë¡¤ ëª¨ë“œì¸ ê²½ìš°
  if(isScrolling && editMode && currentZoom > 1) {
    e.preventDefault();
    e.stopPropagation();
    doDrag(e);
    return;
  }
  
  // ê¸°ë³¸ ë™ì‘ì€ í—ˆìš© (ì ì´ ì•„ë‹Œ ê³³ì„ í„°ì¹˜í•œ ê²½ìš°)
}, {passive: false});

window.addEventListener('touchend', (e) => {
  // changedTouchesë¥¼ í™•ì¸í•˜ì—¬ ëë‚œ í„°ì¹˜ê°€ ìˆëŠ”ì§€ ì²´í¬
  // ë˜ëŠ” ëª¨ë“  í„°ì¹˜ê°€ ëë‚¬ëŠ”ì§€ í™•ì¸
  if(e.changedTouches && e.changedTouches.length > 0) {
    // í„°ì¹˜ê°€ ëë‚¬ìœ¼ë©´ ë“œë˜ê·¸ ì¢…ë£Œ
    endDrag(e);
  } else if(e.touches && e.touches.length === 0) {
    endDrag(e);
  }
});
window.addEventListener('touchcancel', (e) => {
  // í„°ì¹˜ê°€ ì·¨ì†Œë˜ë©´ ë¬´ì¡°ê±´ ë“œë˜ê·¸ ì¢…ë£Œ
  endDrag(e);
});

// ì—…ë¡œë“œ
["filePicker","cameraPicker"].forEach(id => {
  document.getElementById(id).addEventListener("change", e => {
    const f = e.target.files[0];
    if(!f) return;
    const img = new Image();
    img.onload = () => {
      sessions[cur].img = img;
      resizeCanvasFor(img);
      sessions[cur].pts.clear();
      draw();
      computeMetricsOnly(); // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì—ëŠ” AI ë¶„ì„ ì•ˆ í•¨
    };
    img.crossOrigin = "anonymous";
    img.src = URL.createObjectURL(f);
  });
});

// Reset ë²„íŠ¼
document.getElementById("btnReset").onclick = () => {
  sessions[cur].pts.clear();
  draw();
  computeMetricsOnly(); // ë¦¬ì…‹ ì‹œì—ëŠ” AI ë¶„ì„ ì•ˆ í•¨
};

// ì¢Œí‘œ ì €ì¥ (ì €ì¥ ë²„íŠ¼ - AI ë¶„ì„ ì‹¤í–‰)
document.getElementById("btnSaveJSON").onclick = () => {
  // ì €ì¥ ì „ì— AI ë¶„ì„ ì‹¤í–‰
  computeAll();
  
  const obj = Object.fromEntries(sessions[cur].pts);
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${cur}_keypoints.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};

// ì¢Œí‘œ ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById("btnLoadJSON").onclick = () => {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'application/json';
  inp.onchange = e => {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const obj = JSON.parse(r.result);
        const map = new Map();
        for(const k of Object.keys(obj)) map.set(k, obj[k]);
        sessions[cur].pts = map;
        draw();
        computeAll();
      } catch(err) {
        alert('JSON íŒŒì‹± ì‹¤íŒ¨: ' + err.message);
      }
    };
    r.readAsText(f);
  };
  inp.click();
};

// PDF ì €ì¥ (ëª¨ë°”ì¼ ìµœì í™”, í˜ì´ì§€ ë¶„ë¦¬)
document.getElementById("btnPDF").onclick = async () => {
  try {
    // ëª¨ë°”ì¼ì—ì„œ ë¡œë”© í‘œì‹œ
    const btn = document.getElementById("btnPDF");
    const originalText = btn.textContent;
    btn.textContent = "â³ PDF ìƒì„± ì¤‘...";
    btn.disabled = true;
    
    const S = sessions[cur];
    const M = S.metrics || {};
    const scoreData = S.score || {};
    const analysis = S.analysis || {};
    
    // ì²« í˜ì´ì§€: ì œëª©ê³¼ ì´ë¯¸ì§€
    const page1Container = document.createElement("div");
    page1Container.style.position = "fixed";
    page1Container.style.left = "-9999px";
    page1Container.style.top = "0";
    page1Container.style.width = "794px"; // A4 ë„ˆë¹„ @96dpi
    page1Container.style.padding = "30px 25px";
    page1Container.style.paddingBottom = "40px";
    page1Container.style.background = "#ffffff";
    page1Container.style.color = "#111";
    page1Container.style.fontFamily = '"Noto Sans KR", Arial, sans-serif';
    page1Container.style.fontSize = "12px";
    page1Container.style.lineHeight = "1.6";
    page1Container.style.boxSizing = "border-box";
    page1Container.style.overflow = "hidden";
    page1Container.style.wordWrap = "break-word";
    
    // ìº”ë²„ìŠ¤ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
    const cvImg = cv.toDataURL("image/png");
    
    page1Container.innerHTML = `
      <h1 style="margin:0; padding:0; font-size:24px; font-weight:800; color:#0b0f14; margin-bottom:12px; line-height:1.3; word-wrap:break-word;">DIT ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
      <div style="font-size:11px; color:#666; margin-bottom:25px; word-wrap:break-word;">${new Date().toLocaleString('ko-KR')} | ì„¸ì…˜: ${cur}</div>
      <img src="${cvImg}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; max-height:950px; object-fit:contain;" />
    `;
    
    document.body.appendChild(page1Container);
    
    // ì²« í˜ì´ì§€ ìº¡ì²˜
    const canvas1 = await html2canvas(page1Container, {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true,
      allowTaint: true,
      logging: false,
      windowWidth: page1Container.scrollWidth,
      windowHeight: page1Container.scrollHeight
    });
    
    document.body.removeChild(page1Container);
    
    // ë‘ ë²ˆì§¸ í˜ì´ì§€: ì²´í˜• ì¢…í•© ì ìˆ˜ë¶€í„° ì‹œì‘
    const page2Container = document.createElement("div");
    page2Container.style.position = "fixed";
    page2Container.style.left = "-9999px";
    page2Container.style.top = "0";
    page2Container.style.width = "794px";
    page2Container.style.padding = "30px 25px";
    page2Container.style.paddingBottom = "40px";
    page2Container.style.background = "#ffffff";
    page2Container.style.color = "#111";
    page2Container.style.fontFamily = '"Noto Sans KR", Arial, sans-serif';
    page2Container.style.fontSize = "12px";
    page2Container.style.lineHeight = "1.6";
    page2Container.style.boxSizing = "border-box";
    page2Container.style.overflow = "hidden";
    page2Container.style.wordWrap = "break-word";
    
    page2Container.innerHTML = `
      <div style="margin-bottom:25px; padding:18px; background:#f5f5f5; border-radius:10px; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:16px; font-weight:700; margin-bottom:12px; line-height:1.4; word-wrap:break-word;">ğŸ“Š ì²´í˜• ì¢…í•© ì ìˆ˜</div>
        <div style="font-size:42px; font-weight:800; color:${scoreData.score >= 85 ? '#2ec4b6' : scoreData.score >= 70 ? '#ffd166' : '#ff6b6b'}; margin-bottom:10px; line-height:1.2;">${scoreData.score != null ? scoreData.score : 'â€”'}</div>
        <div style="font-size:11px; color:#666; line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;">${scoreData.reasons && scoreData.reasons.length > 0 ? scoreData.reasons.join(", ") : "ëª¨ë“  ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤."}</div>
      </div>
      
      <div style="margin-bottom:25px; box-sizing:border-box;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px;">ğŸ“ ì¸¡ì • ê°ë„</div>
        <table style="width:100%; border-collapse:collapse; font-size:12px; table-layout:fixed;">
          <tr style="background:#f0f0f0;"><th style="padding:10px 8px; text-align:left; border:1px solid #ddd; font-weight:600; word-wrap:break-word;">í•­ëª©</th><th style="padding:10px 8px; text-align:left; border:1px solid #ddd; font-weight:600; word-wrap:break-word;">ì¸¡ì •ê°’</th><th style="padding:10px 8px; text-align:left; border:1px solid #ddd; font-weight:600; word-wrap:break-word;">ì •ìƒ ë²”ìœ„</th></tr>
          <tr><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">CVA</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">${M.cva != null ? M.cva.toFixed(1) + "Â°" : "â€”"}</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">â‰¥50Â°</td></tr>
          <tr style="background:#fafafa;"><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">TRUNK</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">${M.pelvic != null ? M.pelvic.toFixed(1) + "Â°" : "â€”"}</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">|0â€“5Â°|</td></tr>
          <tr><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">KNEE</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">${M.knee != null ? M.knee.toFixed(1) + "Â°" : "â€”"}</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">175â€“185Â°</td></tr>
        </table>
      </div>
      
      ${analysis.comments && analysis.comments.length > 0 ? `
      <div style="margin-bottom:25px; padding:18px; background:#e8f5e9; border-radius:10px; border-left:4px solid #2ec4b6; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:14px; font-weight:700; margin-bottom:10px; color:#2ec4b6; line-height:1.4; word-wrap:break-word;">ğŸ¤– AI ì‹¤ì‹œê°„ ë¶„ì„</div>
        <div style="font-size:12px; line-height:1.6; word-wrap:break-word; overflow-wrap:break-word;">${analysis.comments.join(" ")}</div>
        ${analysis.details && analysis.details.length > 0 ? `<div style="margin-top:12px; font-size:11px; line-height:1.6; color:#555; word-wrap:break-word; overflow-wrap:break-word;">${analysis.details.join("<br>")}</div>` : ""}
      </div>
      ` : ""}
      
      ${(analysis.tight && analysis.tight.length > 0) || (analysis.weak && analysis.weak.length > 0) ? `
      <div style="margin-bottom:25px; padding:18px; background:#fff3e0; border-radius:10px; border-left:4px solid #ffb86c; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#ffb86c; line-height:1.4; word-wrap:break-word;">ğŸ’ª ê·¼ìœ¡ ìƒíƒœ ë¶„ì„</div>
        ${analysis.tight && analysis.tight.length > 0 ? `<div style="margin-bottom:10px; line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;"><strong style="color:#ff6b6b;">ğŸ”´ ê¸´ì¥ëœ ê·¼ìœ¡:</strong> <span style="font-size:12px;">${analysis.tight.join(", ")}</span></div>` : ""}
        ${analysis.weak && analysis.weak.length > 0 ? `<div style="line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;"><strong style="color:#7c9cff;">ğŸ”µ ì•½í™”ëœ ê·¼ìœ¡:</strong> <span style="font-size:12px;">${analysis.weak.join(", ")}</span></div>` : ""}
      </div>
      ` : ""}
      
      ${analysis.exercises && analysis.exercises.length > 0 ? `
      <div style="margin-bottom:25px; padding:18px; background:#e0f2f1; border-radius:10px; border-left:4px solid #2ec4b6; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#2ec4b6; line-height:1.4; word-wrap:break-word;">ğŸ‹ï¸ ì¶”ì²œ ìš´ë™</div>
        <div style="font-size:12px; line-height:1.8; word-wrap:break-word; overflow-wrap:break-word;">${analysis.exercises.map(ex => `<div style="margin-bottom:8px;">${ex}</div>`).join("")}</div>
      </div>
      ` : ""}
      
      <div style="margin-top:25px; padding:18px; background:#f5f5f5; border-radius:10px; font-size:11px; color:#666; box-sizing:border-box; overflow:hidden;">
        <div style="margin-bottom:8px; line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;"><strong>Before ì¸¡ì •ê°’:</strong> CVA ${fmtDeg(sessions.Before.metrics.cva)}, TRUNK ${fmtDeg(sessions.Before.metrics.pelvic)}, KNEE ${fmtDeg(sessions.Before.metrics.knee)}</div>
        <div style="line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;"><strong>After ì¸¡ì •ê°’:</strong> CVA ${fmtDeg(sessions.After.metrics.cva)}, TRUNK ${fmtDeg(sessions.After.metrics.pelvic)}, KNEE ${fmtDeg(sessions.After.metrics.knee)}</div>
      </div>
      
      <div style="margin-top:20px; font-size:10px; color:#999; text-align:center; line-height:1.5;">â€» ë³¸ ë¦¬í¬íŠ¸ëŠ” êµìœ¡ìš©ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤. ì˜ë£Œ ì§„ë‹¨ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    `;
    
    document.body.appendChild(page2Container);
    
    // ë‘ ë²ˆì§¸ í˜ì´ì§€ ìº¡ì²˜
    const canvas2 = await html2canvas(page2Container, {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true,
      allowTaint: true,
      logging: false,
      windowWidth: page2Container.scrollWidth,
      windowHeight: page2Container.scrollHeight
    });
    
    document.body.removeChild(page2Container);
    
    // PDF ìƒì„±
    const pdf = new jsPDF({orientation:"portrait", unit:"px", format:"a4"});
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const imgW = pageW - 40;
    
    // ì²« í˜ì´ì§€: ì œëª©ê³¼ ì´ë¯¸ì§€
    const img1H = canvas1.height * (imgW / canvas1.width);
    if(img1H <= pageH - 40) {
      pdf.addImage(canvas1.toDataURL("image/png"), "PNG", 20, 20, imgW, img1H);
    } else {
      // ì´ë¯¸ì§€ê°€ í¬ë©´ ìë¥´ê¸°
      const maxH = pageH - 40;
      pdf.addImage(canvas1.toDataURL("image/png"), "PNG", 20, 20, imgW, maxH);
    }
    
    // ë‘ ë²ˆì§¸ í˜ì´ì§€: ì²´í˜• ì¢…í•© ì ìˆ˜ë¶€í„°
    pdf.addPage();
    const img2H = canvas2.height * (imgW / canvas2.width);
    if(img2H <= pageH - 40) {
      pdf.addImage(canvas2.toDataURL("image/png"), "PNG", 20, 20, imgW, img2H);
    } else {
      // ê¸´ ë‚´ìš©ì€ ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë¶„í• 
      let remaining = img2H, sY = 0;
      const onePageH = pageH - 40;
      const sliceH = canvas2.height * (onePageH / img2H);
      while(remaining > 0) {
        const pageCanvas = document.createElement("canvas");
        pageCanvas.width = canvas2.width;
        pageCanvas.height = Math.min(sliceH, canvas2.height - sY);
        const pctx = pageCanvas.getContext("2d");
        pctx.drawImage(canvas2, 0, sY, canvas2.width, pageCanvas.height, 0, 0, canvas2.width, pageCanvas.height);
        const pageImg = pageCanvas.toDataURL("image/png");
        pdf.addImage(pageImg, "PNG", 20, 20, imgW, onePageH * (pageCanvas.height / sliceH));
        remaining -= onePageH;
        sY += sliceH;
        if(remaining > 0) pdf.addPage();
      }
    }
    
    pdf.save(`DIT_ìì„¸_ë¶„ì„_ë¦¬í¬íŠ¸_${cur}_${new Date().toISOString().split('T')[0]}.pdf`);
    
    btn.textContent = originalText;
    btn.disabled = false;
    
    // ëª¨ë°”ì¼ì—ì„œ ì„±ê³µ ë©”ì‹œì§€
    if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
      alert("PDFê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }
  } catch(error) {
    console.error("PDF ìƒì„± ì‹¤íŒ¨:", error);
    alert("PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    const btn = document.getElementById("btnPDF");
    btn.textContent = "ğŸ“„ PDF ì €ì¥";
    btn.disabled = false;
  }
};

// ê·¸ë¦¼ìœ¼ë¡œ ì €ì¥ (PDFì™€ ë™ì¼í•œ í˜•ì‹)
document.getElementById("btnImage").onclick = async () => {
  try {
    // ëª¨ë°”ì¼ì—ì„œ ë¡œë”© í‘œì‹œ
    const btn = document.getElementById("btnImage");
    const originalText = btn.textContent;
    btn.textContent = "â³ ì´ë¯¸ì§€ ìƒì„± ì¤‘...";
    btn.disabled = true;
    
    const S = sessions[cur];
    const M = S.metrics || {};
    const scoreData = S.score || {};
    const analysis = S.analysis || {};
    
    // ì²« í˜ì´ì§€: ì œëª©ê³¼ ì´ë¯¸ì§€
    const page1Container = document.createElement("div");
    page1Container.style.position = "fixed";
    page1Container.style.left = "-9999px";
    page1Container.style.top = "0";
    page1Container.style.width = "794px"; // A4 ë„ˆë¹„ @96dpi
    page1Container.style.padding = "30px 25px";
    page1Container.style.paddingBottom = "40px";
    page1Container.style.background = "#ffffff";
    page1Container.style.color = "#111";
    page1Container.style.fontFamily = '"Noto Sans KR", Arial, sans-serif';
    page1Container.style.fontSize = "12px";
    page1Container.style.lineHeight = "1.6";
    page1Container.style.boxSizing = "border-box";
    page1Container.style.overflow = "hidden";
    page1Container.style.wordWrap = "break-word";
    
    // ìº”ë²„ìŠ¤ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
    const cvImg = cv.toDataURL("image/png");
    
    page1Container.innerHTML = `
      <h1 style="margin:0; padding:0; font-size:24px; font-weight:800; color:#0b0f14; margin-bottom:12px; line-height:1.3; word-wrap:break-word;">DIT ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
      <div style="font-size:11px; color:#666; margin-bottom:25px; word-wrap:break-word;">${new Date().toLocaleString('ko-KR')} | ì„¸ì…˜: ${cur}</div>
      <img src="${cvImg}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; max-height:950px; object-fit:contain;" />
    `;
    
    document.body.appendChild(page1Container);
    
    // ì²« í˜ì´ì§€ ìº¡ì²˜
    const canvas1 = await html2canvas(page1Container, {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true,
      allowTaint: true,
      logging: false,
      windowWidth: page1Container.scrollWidth,
      windowHeight: page1Container.scrollHeight
    });
    
    document.body.removeChild(page1Container);
    
    // ë‘ ë²ˆì§¸ í˜ì´ì§€: ì²´í˜• ì¢…í•© ì ìˆ˜ë¶€í„° ì‹œì‘
    const page2Container = document.createElement("div");
    page2Container.style.position = "fixed";
    page2Container.style.left = "-9999px";
    page2Container.style.top = "0";
    page2Container.style.width = "794px";
    page2Container.style.padding = "30px 25px";
    page2Container.style.paddingBottom = "40px";
    page2Container.style.background = "#ffffff";
    page2Container.style.color = "#111";
    page2Container.style.fontFamily = '"Noto Sans KR", Arial, sans-serif';
    page2Container.style.fontSize = "12px";
    page2Container.style.lineHeight = "1.6";
    page2Container.style.boxSizing = "border-box";
    page2Container.style.overflow = "hidden";
    page2Container.style.wordWrap = "break-word";
    
    page2Container.innerHTML = `
      <div style="margin-bottom:25px; padding:18px; background:#f5f5f5; border-radius:10px; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:16px; font-weight:700; margin-bottom:12px; line-height:1.4; word-wrap:break-word;">ğŸ“Š ì²´í˜• ì¢…í•© ì ìˆ˜</div>
        <div style="font-size:42px; font-weight:800; color:${scoreData.score >= 85 ? '#2ec4b6' : scoreData.score >= 70 ? '#ffd166' : '#ff6b6b'}; margin-bottom:10px; line-height:1.2;">${scoreData.score != null ? scoreData.score : 'â€”'}</div>
        <div style="font-size:11px; color:#666; line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;">${scoreData.reasons && scoreData.reasons.length > 0 ? scoreData.reasons.join(", ") : "ëª¨ë“  ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤."}</div>
      </div>
      
      <div style="margin-bottom:25px; box-sizing:border-box;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px;">ğŸ“ ì¸¡ì • ê°ë„</div>
        <table style="width:100%; border-collapse:collapse; font-size:12px; table-layout:fixed;">
          <tr style="background:#f0f0f0;"><th style="padding:10px 8px; text-align:left; border:1px solid #ddd; font-weight:600; word-wrap:break-word;">í•­ëª©</th><th style="padding:10px 8px; text-align:left; border:1px solid #ddd; font-weight:600; word-wrap:break-word;">ì¸¡ì •ê°’</th><th style="padding:10px 8px; text-align:left; border:1px solid #ddd; font-weight:600; word-wrap:break-word;">ì •ìƒ ë²”ìœ„</th></tr>
          <tr><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">CVA</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">${M.cva != null ? M.cva.toFixed(1) + "Â°" : "â€”"}</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">â‰¥50Â°</td></tr>
          <tr style="background:#fafafa;"><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">TRUNK</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">${M.pelvic != null ? M.pelvic.toFixed(1) + "Â°" : "â€”"}</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">|0â€“5Â°|</td></tr>
          <tr><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">KNEE</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">${M.knee != null ? M.knee.toFixed(1) + "Â°" : "â€”"}</td><td style="padding:10px 8px; border:1px solid #ddd; word-wrap:break-word;">175â€“185Â°</td></tr>
        </table>
      </div>
      
      ${analysis.comments && analysis.comments.length > 0 ? `
      <div style="margin-bottom:25px; padding:18px; background:#e8f5e9; border-radius:10px; border-left:4px solid #2ec4b6; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:14px; font-weight:700; margin-bottom:10px; color:#2ec4b6; line-height:1.4; word-wrap:break-word;">ğŸ¤– AI ì‹¤ì‹œê°„ ë¶„ì„</div>
        <div style="font-size:12px; line-height:1.6; word-wrap:break-word; overflow-wrap:break-word;">${analysis.comments.join(" ")}</div>
        ${analysis.details && analysis.details.length > 0 ? `<div style="margin-top:12px; font-size:11px; line-height:1.6; color:#555; word-wrap:break-word; overflow-wrap:break-word;">${analysis.details.join("<br>")}</div>` : ""}
      </div>
      ` : ""}
      
      ${(analysis.tight && analysis.tight.length > 0) || (analysis.weak && analysis.weak.length > 0) ? `
      <div style="margin-bottom:25px; padding:18px; background:#fff3e0; border-radius:10px; border-left:4px solid #ffb86c; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#ffb86c; line-height:1.4; word-wrap:break-word;">ğŸ’ª ê·¼ìœ¡ ìƒíƒœ ë¶„ì„</div>
        ${analysis.tight && analysis.tight.length > 0 ? `<div style="margin-bottom:10px; line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;"><strong style="color:#ff6b6b;">ğŸ”´ ê¸´ì¥ëœ ê·¼ìœ¡:</strong> <span style="font-size:12px;">${analysis.tight.join(", ")}</span></div>` : ""}
        ${analysis.weak && analysis.weak.length > 0 ? `<div style="line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;"><strong style="color:#7c9cff;">ğŸ”µ ì•½í™”ëœ ê·¼ìœ¡:</strong> <span style="font-size:12px;">${analysis.weak.join(", ")}</span></div>` : ""}
      </div>
      ` : ""}
      
      ${analysis.exercises && analysis.exercises.length > 0 ? `
      <div style="margin-bottom:25px; padding:18px; background:#e0f2f1; border-radius:10px; border-left:4px solid #2ec4b6; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#2ec4b6; line-height:1.4; word-wrap:break-word;">ğŸ‹ï¸ ì¶”ì²œ ìš´ë™</div>
        <div style="font-size:12px; line-height:1.8; word-wrap:break-word; overflow-wrap:break-word;">${analysis.exercises.map(ex => `<div style="margin-bottom:8px;">${ex}</div>`).join("")}</div>
      </div>
      ` : ""}
      
      <div style="margin-top:25px; padding:18px; background:#f5f5f5; border-radius:10px; font-size:11px; color:#666; box-sizing:border-box; overflow:hidden;">
        <div style="margin-bottom:8px; line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;"><strong>Before ì¸¡ì •ê°’:</strong> CVA ${fmtDeg(sessions.Before.metrics.cva)}, TRUNK ${fmtDeg(sessions.Before.metrics.pelvic)}, KNEE ${fmtDeg(sessions.Before.metrics.knee)}</div>
        <div style="line-height:1.5; word-wrap:break-word; overflow-wrap:break-word;"><strong>After ì¸¡ì •ê°’:</strong> CVA ${fmtDeg(sessions.After.metrics.cva)}, TRUNK ${fmtDeg(sessions.After.metrics.pelvic)}, KNEE ${fmtDeg(sessions.After.metrics.knee)}</div>
      </div>
      
      <div style="margin-top:20px; font-size:10px; color:#999; text-align:center; line-height:1.5;">â€» ë³¸ ë¦¬í¬íŠ¸ëŠ” êµìœ¡ìš©ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤. ì˜ë£Œ ì§„ë‹¨ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    `;
    
    document.body.appendChild(page2Container);
    
    // ë‘ ë²ˆì§¸ í˜ì´ì§€ ìº¡ì²˜
    const canvas2 = await html2canvas(page2Container, {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true,
      allowTaint: true,
      logging: false,
      windowWidth: page2Container.scrollWidth,
      windowHeight: page2Container.scrollHeight
    });
    
    document.body.removeChild(page2Container);
    
    // ë‘ ì´ë¯¸ì§€ë¥¼ ì„¸ë¡œë¡œ í•©ì¹˜ê¸°
    const totalHeight = canvas1.height + canvas2.height + 20; // 20px ì—¬ë°±
    const combinedCanvas = document.createElement("canvas");
    combinedCanvas.width = canvas1.width;
    combinedCanvas.height = totalHeight;
    const ctx = combinedCanvas.getContext("2d");
    
    // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
    ctx.drawImage(canvas1, 0, 0);
    // ë‘ ë²ˆì§¸ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ì—¬ë°± í¬í•¨)
    ctx.drawImage(canvas2, 0, canvas1.height + 20);
    
    // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
    const imgData = combinedCanvas.toDataURL("image/png");
    const link = document.createElement("a");
    link.href = imgData;
    link.download = `DIT_ìì„¸_ë¶„ì„_ë¦¬í¬íŠ¸_${cur}_${new Date().toISOString().split('T')[0]}.png`;
    link.click();
    
    btn.textContent = originalText;
    btn.disabled = false;
    
    // ëª¨ë°”ì¼ì—ì„œ ì„±ê³µ ë©”ì‹œì§€
    if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
      alert("ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }
  } catch(error) {
    console.error("ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:", error);
    alert("ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    const btn = document.getElementById("btnImage");
    btn.textContent = "ğŸ–¼ï¸ ê·¸ë¦¼ìœ¼ë¡œ ì €ì¥";
    btn.disabled = false;
  }
};

// ê³µìœ í•˜ê¸° (Web Share API ì‚¬ìš©)
document.getElementById("btnShare").onclick = async () => {
  try {
    const btn = document.getElementById("btnShare");
    const originalText = btn.textContent;
    btn.textContent = "â³ ì¤€ë¹„ ì¤‘...";
    btn.disabled = true;
    
    const S = sessions[cur];
    const M = S.metrics || {};
    const scoreData = S.score || {};
    const analysis = S.analysis || {};
    
    // ê³µìœ í•  ì´ë¯¸ì§€ ìƒì„± (ê°„ë‹¨í•œ ë²„ì „)
    const cvImg = cv.toDataURL("image/png");
    
    // ê³µìœ í•  í…ìŠ¤íŠ¸ ìƒì„±
    const shareText = `DIT ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸ - ${cur}\n\n` +
      `ğŸ“Š ì²´í˜• ì¢…í•© ì ìˆ˜: ${scoreData.score != null ? scoreData.score : 'â€”'}\n` +
      `ğŸ“ ì¸¡ì • ê°ë„:\n` +
      `  - CVA: ${M.cva != null ? M.cva.toFixed(1) + "Â°" : "â€”"} (ì •ìƒ: â‰¥50Â°)\n` +
      `  - TRUNK: ${M.pelvic != null ? M.pelvic.toFixed(1) + "Â°" : "â€”"} (ì •ìƒ: |0â€“5Â°|)\n` +
      `  - KNEE: ${M.knee != null ? M.knee.toFixed(1) + "Â°" : "â€”"} (ì •ìƒ: 175â€“185Â°)\n\n` +
      `${analysis.comments && analysis.comments.length > 0 ? analysis.comments.join(" ") + "\n\n" : ""}` +
      `${analysis.tight && analysis.tight.length > 0 ? "ğŸ”´ ê¸´ì¥ëœ ê·¼ìœ¡: " + analysis.tight.join(", ") + "\n" : ""}` +
      `${analysis.weak && analysis.weak.length > 0 ? "ğŸ”µ ì•½í™”ëœ ê·¼ìœ¡: " + analysis.weak.join(", ") + "\n" : ""}` +
      `\nâ€» ë³¸ ë¦¬í¬íŠ¸ëŠ” êµìœ¡ìš©ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.`;
    
    // Web Share API ì§€ì› ì—¬ë¶€ í™•ì¸
    if (navigator.share) {
      // ì´ë¯¸ì§€ íŒŒì¼ ìƒì„±
      const response = await fetch(cvImg);
      const blob = await response.blob();
      const file = new File([blob], `DIT_ìì„¸_ë¶„ì„_${cur}_${new Date().toISOString().split('T')[0]}.png`, { type: 'image/png' });
      
      // ê³µìœ  ì‹œë„
      try {
        await navigator.share({
          title: `DIT ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸ - ${cur}`,
          text: shareText,
          files: [file]
        });
        
        btn.textContent = originalText;
        btn.disabled = false;
      } catch (shareError) {
        // ì‚¬ìš©ìê°€ ê³µìœ ë¥¼ ì·¨ì†Œí–ˆê±°ë‚˜ ì—ëŸ¬ ë°œìƒ
        if (shareError.name !== 'AbortError') {
          console.error('ê³µìœ  ì‹¤íŒ¨:', shareError);
          // í´ë°±: ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
          const link = document.createElement('a');
          link.href = cvImg;
          link.download = `DIT_ìì„¸_ë¶„ì„_${cur}_${new Date().toISOString().split('T')[0]}.png`;
          link.click();
        }
        btn.textContent = originalText;
        btn.disabled = false;
      }
    } else {
      // Web Share APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš°: í´ë¦½ë³´ë“œì— ë³µì‚¬
      try {
        // í…ìŠ¤íŠ¸ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬
        await navigator.clipboard.writeText(shareText);
        
        // ì´ë¯¸ì§€ë„ ë‹¤ìš´ë¡œë“œ
        const link = document.createElement('a');
        link.href = cvImg;
        link.download = `DIT_ìì„¸_ë¶„ì„_${cur}_${new Date().toISOString().split('T')[0]}.png`;
        link.click();
        
        alert('ë¶„ì„ ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆê³  ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n\në‹¤ë¥¸ ì•±ì— ë¶™ì—¬ë„£ì–´ ê³µìœ í•˜ì„¸ìš”.');
        btn.textContent = originalText;
        btn.disabled = false;
      } catch (clipboardError) {
        console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', clipboardError);
        // ìµœì¢… í´ë°±: ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œë§Œ
        const link = document.createElement('a');
        link.href = cvImg;
        link.download = `DIT_ìì„¸_ë¶„ì„_${cur}_${new Date().toISOString().split('T')[0]}.png`;
        link.click();
        alert('ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ê³µìœ í•´ì£¼ì„¸ìš”.');
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }
  } catch (error) {
    console.error("ê³µìœ  ì‹¤íŒ¨:", error);
    alert("ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    const btn = document.getElementById("btnShare");
    btn.textContent = "ğŸ“¤ ê³µìœ í•˜ê¸°";
    btn.disabled = false;
  }
};

// ì´ˆê¸°í™”
resizeCanvasFor(null);
draw();
computeMetricsOnly(); // ì´ˆê¸°í™” ì‹œì—ëŠ” AI ë¶„ì„ ì•ˆ í•¨
updateCompare();
</script>
  </body>
</html>
