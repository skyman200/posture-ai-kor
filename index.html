<!DOCTYPE html>
<html lang="ko">
  <head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIT ìì„¸ ë¶„ì„ AI (ìµœì¢… í†µí•©ë²„ì „)</title>
<!-- âœ… 3. favicon.ico 404 ì˜¤ë¥˜ í•´ê²° (ì„ íƒì‚¬í•­) -->
<link rel="icon" type="image/png" href="/posture-ai-kor/pwa-192x192.png">
<style>
:root {
  --bg: #0b0f14;
  --panel: rgba(30, 34, 42, 0.7);
  --accent: #7c9cff;
  --accent2: #ffb86c;
  --ink: #e7eef7;
  --muted: #9bb0c7;
  --radius: 18px;
  --font-body: 'Apple SD Gothic Neo', 'Malgun Gothic', 'Nanum Gothic', 'Noto Sans KR', 'Pretendard', 'Segoe UI', 'Roboto', sans-serif;
}

/* PDFìš© ì•ˆì „ í°íŠ¸ ë° ìˆ¨ê¹€ ë Œë”ë§ (êµ¬ê¸€ í°íŠ¸ ì œì™¸) */
/* PDFìš© ì•ˆì „ ì»¨í…Œì´ë„ˆ - ë³´ì´ì§€ ì•Šì§€ë§Œ ë Œë”ë§ì€ ë¨ */
.pdf-safe {
  position: absolute !important;
  left: -9999px !important;
  top: 0 !important;
  /* ğŸ› ï¸ ìˆ˜ì •: ë„ˆë¹„ ê³ ì •(520px) ì œê±° ë° 100%ë¡œ ë³€ê²½í•˜ì—¬ ì˜ë¦¼ ë¬¸ì œ í•´ê²° */
  width: 100% !important;
  max-width: 1000px !important; /* PDF ìƒì„± ì‹œ ìµœëŒ€ ë„ˆë¹„ë¡œ ì„¤ì •í•˜ì—¬ ì•ˆì „ì„± í™•ë³´ */
  padding: 30px !important;
  background: white !important;
  font-family: 'Pretendard', 'Apple SD Gothic Neo', sans-serif !important;
  opacity: 0 !important;           /* í•µì‹¬: visibility â†’ opacity */
  pointer-events: none !important;
  z-index: -1 !important;
  box-sizing: border-box !important;
  visibility: visible !important;  /* ìì‹ì€ ë³´ì´ê²Œ */
  display: block !important;      /* âœ… display: none ëŒ€ì‹  block ì‚¬ìš© (ì˜ë¦¼ ë°©ì§€) */
}

.pdf-safe * {
  opacity: 1 !important;
  visibility: visible !important;
  /* í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ ê°•ì œ ì ìš© */
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  word-break: break-word !important;
  white-space: normal !important; /* nowrap ê°•ì œ í•´ì œ */
  /* overflow: visibleì€ img/video/canvasì— ì ìš©í•˜ì§€ ì•ŠìŒ (deprecated ê²½ê³  ë°©ì§€) */
  text-overflow: clip !important; /* ellipsis ê°•ì œ í•´ì œ */
}

/* img/video/canvasê°€ ì•„ë‹Œ ìš”ì†Œì—ë§Œ overflow: visible ì ìš© */
.pdf-safe *:not(img):not(video):not(canvas) {
  overflow: visible !important; /* hidden ê°•ì œ í•´ì œ (img/video/canvas ì œì™¸) */
}

/* í…Œì´ë¸” ì…€ì— ëŒ€í•œ ê°•ì œ ì˜¤ë²„ë¼ì´ë“œ (ê°€ì¥ ì¤‘ìš”) */
.pdf-safe .tbl th, .pdf-safe .tbl td {
  white-space: normal !important;
  overflow: visible !important;
  text-overflow: clip !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  word-break: break-word !important;
}

/* ê²°ë¡  ë° í–¥í›„ ê¶Œì¥ì‚¬í•­ ì„¹ì…˜ ë†’ì´ ì œí•œ í•´ì œ (img/video/canvas ì œì™¸) */
.pdf-safe div[style*="ê²°ë¡ "]:not(img):not(video):not(canvas), 
.pdf-safe div[style*="ê¶Œì¥ì‚¬í•­"]:not(img):not(video):not(canvas),
.pdf-safe #conclusionContent:not(img):not(video):not(canvas),
.pdf-safe [id*="conclusion"]:not(img):not(video):not(canvas) {
  height: auto !important;
  max-height: none !important;
  overflow: visible !important;
  white-space: pre-wrap !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  text-overflow: clip !important;
}

/* ëª¨ë“  div ìš”ì†Œì˜ ë†’ì´ ì œí•œ í•´ì œ (PDF ìƒì„± ì‹œ) */
.pdf-safe div {
  max-height: none !important;
}
* { box-sizing: border-box; }
html, body {
  margin: 0; 
  padding: 0;
  height: 100%;
  -webkit-overflow-scrolling: touch;
}
body {
  background: var(--bg); 
  color: var(--ink);
  font-family: var(--font-body);
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  overflow-x: hidden;
}
button, input, select, textarea {
  font-family: var(--font-body);
}
.panel {
  background: var(--panel);
  backdrop-filter: blur(20px);
  border-radius: var(--radius);
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
}
.sidebar { 
  padding: 12px; 
  overflow-y: auto;
  overflow-x: hidden;
  max-height: 50vh;
  -webkit-overflow-scrolling: touch;
}
.title { 
  font-size: 16px; 
  font-weight:800; 
  margin-bottom: 6px; 
  line-height: 1.3;
}
.muted { 
  color: var(--muted); 
  font-size: 11px; 
  line-height: 1.4;
}
.btn {
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 10px 14px;
  background: rgba(255,255,255,0.05);
  color: var(--ink);
  cursor: pointer;
  font-size: 13px;
  width: 100%;
  text-align: center;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.btn:hover, .btn:active { 
  background: rgba(255,255,255,0.12); 
}
.seg { 
  display: flex; 
  border-radius: 10px; 
  overflow: hidden; 
  margin-top: 8px; 
  gap: 4px;
}
.seg button { 
  flex:1; 
  border:0; 
  background: rgba(255,255,255,0.04); 
  color:var(--muted); 
  padding:10px 8px; 
  cursor:pointer; 
  font-size: 13px;
  touch-action: manipulation;
}
.seg button.active { 
  background: rgba(124,156,255,0.25); 
  color:var(--ink); 
}
label.btn { 
  display: block;
  width: 100%;
  margin-bottom: 8px;
  position: relative;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
label.btn input { 
  position: absolute;
  opacity: 0;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  cursor: pointer;
  z-index: 10;
  pointer-events: auto;
  -webkit-tap-highlight-color: transparent;
  font-size: 0;
  margin: 0;
  padding: 0;
  border: 0;
}
.tbl { 
  width:100%; 
  border-collapse:collapse; 
  font-size:11px; 
  overflow-x: auto;
  display: table;
  -webkit-overflow-scrolling: touch;
}
.tbl th,.tbl td { 
  border-bottom:1px solid rgba(255,255,255,0.1); 
  padding:6px 4px; 
  text-align: center;
  font-size: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.canvasWrap { 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  flex: 1;
  min-height: 50vh;
  padding: 8px;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  position: relative;
}
.canvasWrap.zoomed {
  align-items: flex-start;
  justify-content: flex-start;
}
canvas { 
  border-radius:var(--radius); 
  background:#0a0e13; 
  cursor: crosshair; 
  touch-action: none; /* ë“œë˜ê·¸ì™€ ìŠ¤í¬ë¡¤ì„ JavaScriptë¡œ ì œì–´ */
  display: block;
  flex-shrink: 0;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
  -moz-user-select: none;
       user-select: none;
  -webkit-user-select: none;
}
</style>
    <script type="module" crossorigin src="/posture-ai-kor/assets/main-B5Qt9EMX.js"></script>
  </head>
  <body>
<aside class="panel sidebar" style="order: 1;">
  <div class="title">ğŸ“¸ DIT ìì„¸ ë¶„ì„ AI</div>
  <div class="muted">íŒŒì¼ ì—…ë¡œë“œ â†’ ì ì„ ë“œë˜ê·¸ë¡œ ì¡°ì • â†’ ê°ë„ ìë™ ê³„ì‚°</div>

  <div class="seg">
    <button id="btnBefore" class="active">Before</button>
    <button id="btnAfter">After</button>
  </div>
  <div style="margin-top:8px; display:flex; flex-direction:column; gap:8px;">
    <div class="seg" style="margin-bottom:4px;">
      <button id="btnOrientationSide" class="active">ğŸ“ ì˜†ëª¨ìŠµ</button>
      <button id="btnOrientationFront">ğŸ“· ì •ë©´</button>
    </div>
    <label class="btn" for="filePicker">ğŸ“· íŒŒì¼ ì„ íƒ
      <input id="filePicker" type="file" accept="image/*">
    </label>
    <label class="btn" for="cameraPicker">ğŸ“¸ ì§ì ‘ ì´¬ì˜
      <input id="cameraPicker" type="file" accept="image/*" capture="environment">
    </label>
    <button class="btn" id="btnReset">â†º ì´ˆê¸°í™”</button>
    <button class="btn" id="btnCalibrate" style="background: rgba(255,184,108,0.2);">ğŸ“ ìº˜ë¦¬ë¸Œë ˆì´ì…˜</button>
  </div>

  <div id="calibrationPanel" style="margin-top:12px; padding:10px; background:rgba(255,184,108,0.1); border-radius:10px; display:none;">
    <div class="muted" style="margin-bottom:8px; font-weight:600;">ğŸ“ ìº˜ë¦¬ë¸Œë ˆì´ì…˜</div>
    <div class="muted" style="font-size:11px; margin-bottom:8px;">ê¸°ì¤€ ë§ˆì»¤ ë‘ ì ì„ ì°ê³  ì‹¤ì œ ê¸¸ì´(cm)ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
    <div style="margin-bottom:8px;">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">í™•ëŒ€ ë°°ìœ¨</div>
      <select id="calibrationZoomLevel" class="btn" style="width:100%; padding:6px; margin-bottom:8px;">
        <option value="1">ì›ë³¸ í¬ê¸° (1ë°°)</option>
        <option value="2">2ë°° í™•ëŒ€ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</option>
        <option value="3">3ë°° í™•ëŒ€ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</option>
        <option value="4">4ë°° í™•ëŒ€ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</option>
      </select>
      <div class="muted" style="font-size:10px; margin-top:4px; margin-bottom:8px; line-height:1.4;">í™•ëŒ€ ì‹œ ì–‘ì†ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì—¬ ì´ë™ ê°€ëŠ¥</div>
    </div>
    <div style="margin-bottom:8px;">
      <input type="number" id="calibrationLength" placeholder="ì‹¤ì œ ê¸¸ì´ (cm)" step="0.1" min="0.1" style="width:100%; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.3); color:var(--ink);">
    </div>
    <div class="muted" style="font-size:11px; margin-bottom:4px;">ì  1: <span id="calPoint1">í´ë¦­í•˜ì—¬ ì„ íƒ</span></div>
    <div class="muted" style="font-size:11px; margin-bottom:8px;">ì  2: <span id="calPoint2">í´ë¦­í•˜ì—¬ ì„ íƒ</span></div>
    <button class="btn" id="btnCalibrateConfirm" style="width:100%; margin-bottom:8px;">âœ… ê³„ì‚°</button>
    <button class="btn" id="btnCalibrateCancel" style="width:100%;">âŒ ì·¨ì†Œ</button>
    <div id="calibrationResult" class="muted" style="font-size:11px; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);"></div>
  </div>

  <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
    <button class="btn" id="btnEditCoords" style="background: rgba(124,156,255,0.2);">âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ</button>
    <button class="btn" id="btnSaveJSON">ğŸ’¾ ì¢Œí‘œ ì €ì¥</button>
    <button class="btn" id="btnLoadJSON">ğŸ“‚ ì¢Œí‘œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button class="btn" id="btnPDF">ğŸ“„ PDF ì €ì¥</button>
    <button class="btn" id="btnImage">ğŸ–¼ï¸ ê·¸ë¦¼ìœ¼ë¡œ ì €ì¥</button>
    <button class="btn" id="btnShare">ğŸ“¤ ê³µìœ í•˜ê¸°</button>
    <button class="btn" id="btnAIAnalysis" style="background: rgba(46,196,182,0.3); border: 1px solid rgba(46,196,182,0.5);">ğŸ¤– AI ë¶„ì„</button>
  </div>

  <!-- ê³¨ë°˜ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
  <div id="pelvicDesc" style="white-space: pre-line; line-height:1.6; font-size:15px; margin-top:10px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px; display:none;"></div>

  <div id="coordEditPanel" style="margin-top:12px; padding:10px; background:rgba(124,156,255,0.1); border-radius:10px; display:none;">
    <div class="muted" style="margin-bottom:8px; font-weight:600;">ì¢Œí‘œ ìˆ˜ì •</div>
    <div style="margin-bottom:8px;">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">í™•ëŒ€ ë°°ìœ¨</div>
      <select id="zoomLevel" class="btn" style="width:100%; padding:6px; margin-bottom:8px;">
        <option value="1">ì›ë³¸ í¬ê¸° (1ë°°)</option>
        <option value="2">2ë°° í™•ëŒ€ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</option>
        <option value="3">3ë°° í™•ëŒ€ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</option>
        <option value="4">4ë°° í™•ëŒ€ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</option>
      </select>
      <div class="muted" style="font-size:10px; margin-top:4px; margin-bottom:8px; line-height:1.4;">í™•ëŒ€ ì‹œ ì–‘ì†ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì—¬ ì´ë™ ê°€ëŠ¥</div>
    </div>
    <div style="margin-bottom:8px;">
      <select id="coordSelectPoint" class="btn" style="width:100%; padding:6px; margin-bottom:6px;">
        <option value="">ì  ì„ íƒ...</option>
        <!-- ì˜µì…˜ì€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨ -->
      </select>
    </div>
    <div style="display:flex; flex-direction:column; gap:6px; margin-bottom:6px;">
      <div>
        <div class="muted" style="font-size:11px; margin-bottom:4px;">X ì¢Œí‘œ</div>
        <div style="display:flex; gap:4px; align-items:center;">
          <input type="number" id="coordX" class="btn" style="flex:1; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);" step="0.1" placeholder="X">
          <button class="btn" id="coordXDec" style="padding:8px 12px; background:rgba(255,107,107,0.2); border:1px solid rgba(255,107,107,0.3); min-width:40px;">âˆ’</button>
          <button class="btn" id="coordXInc" style="padding:8px 12px; background:rgba(46,196,182,0.2); border:1px solid rgba(46,196,182,0.3); min-width:40px;">+</button>
        </div>
      </div>
      <div>
        <div class="muted" style="font-size:11px; margin-bottom:4px;">Y ì¢Œí‘œ</div>
        <div style="display:flex; gap:4px; align-items:center;">
          <input type="number" id="coordY" class="btn" style="flex:1; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);" step="0.1" placeholder="Y">
          <button class="btn" id="coordYDec" style="padding:8px 12px; background:rgba(255,107,107,0.2); border:1px solid rgba(255,107,107,0.3); min-width:40px;">âˆ’</button>
          <button class="btn" id="coordYInc" style="padding:8px 12px; background:rgba(46,196,182,0.2); border:1px solid rgba(46,196,182,0.3); min-width:40px;">+</button>
        </div>
      </div>
    </div>
    <button class="btn" id="coordApply" style="width:100%; background:rgba(124,156,255,0.3);">ì ìš©</button>
    <button class="btn" id="coordCancel" style="width:100%; margin-top:6px; background:rgba(255,255,255,0.05);">ì·¨ì†Œ</button>
  </div>

  <div style="margin-top:12px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px;">
    <div class="muted" style="margin-bottom:6px;">í˜„ì¬ ì„¸ì…˜: <span id="currentSession">Before</span></div>
    
    <!-- ì£¼ìš” ì§€í‘œ (ê°„ëµ í‘œì‹œ) -->
    <div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.1);">
      <div class="muted" style="margin-bottom:4px;">CVA: <span id="dispCva">â€”</span></div>
      <div class="muted" style="margin-bottom:4px;">TRUNK: <span id="dispPel">â€”</span></div>
      <div class="muted" style="margin-bottom:4px;">KNEE: <span id="dispKnee">â€”</span></div>
    </div>
    
    <!-- ì „ì²´ ë¶„ì„ í•­ëª© (16ê°€ì§€) -->
    <div id="allMetricsPanel" style="max-height:300px; overflow-y:auto; margin-bottom:8px;">
      <div style="font-size:12px; font-weight:600; margin-bottom:6px; color:#7c9cff;">ğŸ“Š ì „ì²´ ë¶„ì„ í•­ëª©</div>
      <div id="allMetricsList" style="font-size:11px; line-height:1.6;"></div>
    </div>
    
    <div style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1);">
      <div style="font-size:14px; font-weight:600; margin-bottom:8px;">ğŸ“Š ì²´í˜• ì¢…í•© ì ìˆ˜</div>
      <div id="totalScore" style="font-size:32px; font-weight:800; margin-bottom:8px;">â€”</div>
      <div id="scoreReason" class="muted" style="font-size:11px; line-height:1.4; margin-bottom:8px;"></div>
      <div id="pdsScore" class="muted" style="font-size:12px; margin-top:6px;">PDS: <span id="pdsValue">â€”</span></div>
    </div>
  </div>


  <!-- AI PRO ë¦¬í¬íŠ¸ í‘œì‹œ ì˜ì—­ -->
  <div id="report-box" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.1); border-radius:10px; display:none; white-space: pre-wrap; font-size:12px; line-height:1.5; max-height:400px; overflow-y:auto; color:var(--ink); font-family: 'Noto Sans KR', sans-serif;"></div>
  
  <!-- 16ê°œ í•­ëª© ìƒì„¸ ì„¤ëª… -->
  <div id="metricsDescPanel" style="margin-top:12px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#7c9cff;">ğŸ“‹ ë¶„ì„ í•­ëª© ì„¤ëª…</div>
    <div style="font-size:11px; color:#7c9cff; margin-bottom:8px; padding:4px 8px; background:rgba(124,156,255,0.2); border-radius:4px; display:inline-block;">ì¸¡ë©´ í•­ëª© (ì˜†ëª¨ìŠµ)</div>
    <div style="font-size:11px; color:#2ec4b6; margin-bottom:8px; padding:4px 8px; background:rgba(46,196,182,0.2); border-radius:4px; display:inline-block; margin-left:8px;">ì •ë©´ í•­ëª© (ì•ëª¨ìŠµ)</div>
    <div id="metricsDescContent" style="max-height:400px; overflow-y:auto; font-size:11px; line-height:1.6;">
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">CVA (Craniovertebral Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ê·€ ë’¤ ìœ ì–‘ëŒê¸°(Tragus)ì™€ ì œ7ê²½ì¶”(C7) ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ê±°ë¶ëª© ìì„¸ì˜ ì •ë„ë¥¼ í‰ê°€í•˜ëŠ” ê°€ì¥ ì¤‘ìš”í•œ ì§€í‘œì…ë‹ˆë‹¤. ê°ë„ê°€ ì‘ì„ìˆ˜ë¡ ë¨¸ë¦¬ê°€ ì•ìœ¼ë¡œ ë‚˜ì˜¨ ìƒíƒœì…ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¥50Â° (ê°ë„ê°€ í´ìˆ˜ë¡ ì¢‹ìŒ)<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> CVA &lt; 50Â°ëŠ” ì „ë°©ë‘ë¶€ìì„¸(FHP)ë¥¼ ì˜ë¯¸í•˜ë©°, ê²½ì¶” ê·¼ìœ¡ ê¸´ì¥, ë‘í†µ, ëª© í†µì¦ì˜ ì›ì¸ì´ ë©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">HPD (Head Protrusion Distance)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ê·€(Tragus)ì™€ ì–´ê¹¨(Acromion) ì‚¬ì´ì˜ ìˆ˜í‰ ê±°ë¦¬<br>
          <strong>ì˜ë¯¸:</strong> ë¨¸ë¦¬ê°€ ëª¸í†µì—ì„œ ì–¼ë§ˆë‚˜ ì•ìœ¼ë¡œ ëŒì¶œë˜ì–´ ìˆëŠ”ì§€ë¥¼ cm ë‹¨ìœ„ë¡œ ì¸¡ì •í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤2cm<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> 2cm ì´ˆê³¼ ì‹œ ê²½ì¶” ë¶€ë‹´ ì¦ê°€, ìƒë¶€ ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥, ëª©-ì–´ê¹¨ í†µì¦ ìœ ë°œ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">TIA (Trunk Inclination Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ì–´ê¹¨(Acromion)ì™€ ê³¨ë°˜(Hip)ì„ ì—°ê²°í•œ ì„ ê³¼ ìˆ˜ì§ì„  ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ëª¸í†µì˜ ì•ë’¤ ê¸°ìš¸ê¸°ë¥¼ í‰ê°€í•˜ì—¬ ì „ì²´ì ì¸ ì²´ê°„ ì •ë ¬ì„ í™•ì¸í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-10Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> 10Â° ì´ˆê³¼ ì‹œ ìš”ì¶” ê³¼ì „ë§Œ ë˜ëŠ” í‰í‰í•œ ë“±(Flat Back) ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">SAA (Scapular Alignment Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ì–´ê¹¨(Acromion)ì™€ ê³¨ë°˜ í›„ë©´(PSIS)ì„ ì—°ê²°í•œ ì„ ê³¼ ìˆ˜í‰ì„  ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ì–´ê¹¨ë¼ˆì˜ ì •ë ¬ ìƒíƒœì™€ ìƒë¶€ ì²´ê°„ì˜ ìì„¸ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-10Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> ì´ìƒ ì‹œ ê²¬ê°‘ê³¨ ë‚ ê°œë¼ˆ(Winging) ë˜ëŠ” ì–´ê¹¨ ì „ë°© ë§ë¦¼ì´ ì˜ì‹¬ë©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">PTA (Pelvic Tilt Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> í›„ìƒì¥ê³¨ê·¹(PSIS)ê³¼ ì „ìƒì¥ê³¨ê·¹(ASIS)ì„ ì—°ê²°í•œ ì„ ê³¼ ìˆ˜í‰ì„  ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ê³¨ë°˜ì˜ ì „ë°© ë˜ëŠ” í›„ë°© ê¸°ìš¸ê¸°ë¥¼ í‰ê°€í•˜ëŠ” í•µì‹¬ ì§€í‘œì…ë‹ˆë‹¤.<br>
          <strong>í•´ì„ ê¸°ì¤€:</strong> PSIS ê¸°ì¤€ìœ¼ë¡œ ASISì™€ ê°™ì€ ë†’ì´ = 0ë„, ASISê°€ PSISë³´ë‹¤ ìœ„ìª½ì— ìˆìœ¼ë©´ = ê³¨ë°˜ í›„ë°©ê²½ì‚¬(ìŒìˆ˜, -1ë„ë¶€í„°), ASISê°€ PSISë³´ë‹¤ ë°‘ìª½ì— ìˆìœ¼ë©´ = ê³¨ë°˜ ì „ë°©ê²½ì‚¬(ì–‘ìˆ˜, 1ë„ë¶€í„°)<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-15Â° (ì•½ê°„ì˜ ì „ë°© ê²½ì‚¬ëŠ” ì •ìƒ)<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> &gt;15Â° (ì–‘ìˆ˜)ëŠ” ê³¨ë°˜ ì „ë°© ê²½ì‚¬(ìš”ì¶” ê³¼ì „ë§Œ), &lt;0Â° (ìŒìˆ˜)ëŠ” ê³¨ë°˜ í›„ë°© ê²½ì‚¬(ìš”ì¶” í‰í‰)ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">KA (Knee Alignment Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ê³ ê´€ì ˆ(Hip)-ë¬´ë¦(Knee)-ë°œëª©(Ankle) ì„¸ ì ì´ ì´ë£¨ëŠ” ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ë¬´ë¦ ê´€ì ˆì˜ ì‹ ì „(í´ì§) ì •ë„ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 175-185Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> &lt;175Â°ëŠ” ë¬´ë¦ ê³¼êµ´ê³¡(ìŠ¬ê°œê±´ ë¶€ë‹´), &gt;185Â°ëŠ” ë¬´ë¦ ê³¼ì‹ ì „(ê´€ì ˆ ë¶ˆì•ˆì •ì„±)ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">Tibial Angle (ê²½ê³¨ ê²½ì‚¬ê°)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ë¬´ë¦(Knee)ê³¼ ë°œëª©(Ankle)ì„ ì—°ê²°í•œ ì„ ê³¼ ìˆ˜ì§ì„  ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ì •ê°•ì´(ê²½ê³¨)ì˜ ì•ë’¤ ê¸°ìš¸ê¸°ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-10Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> ê³¼ë„í•œ ê²½ì‚¬ëŠ” ë°œëª© ë¶ˆì•ˆì •ì„± ë° ì¢…ì•„ë¦¬ ê·¼ìœ¡ ë¶ˆê· í˜•ì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">Knee Deviation (ë¬´ë¦ ë†’ì´ ì°¨)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ì¢Œìš° ë¬´ë¦ì˜ ë†’ì´ ì°¨ì´ë¥¼ ê°ë„ë¡œ í™˜ì‚°<br>
          <strong>ì˜ë¯¸:</strong> ì–‘ìª½ ë¬´ë¦ì˜ ìˆ˜í‰ ì •ë ¬ì„ í‰ê°€í•˜ì—¬ ê³¨ë°˜ ê¸°ìš¸ê¸°ë¥¼ ê°„ì ‘ì ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-3Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> 3Â° ì´ˆê³¼ ì‹œ ê³¨ë°˜ íšŒì „(Pelvic Rotation) ë˜ëŠ” ì²™ì¶” ì¸¡ë§Œì¦ì´ ì˜ì‹¬ë©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">GSB (Global Sagittal Balance)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ê·€(Tragus)ì™€ ë°œëª©(Ankle)ì˜ ìˆ˜í‰ ê±°ë¦¬<br>
          <strong>ì˜ë¯¸:</strong> ì „ì‹ ì˜ ì‹œìƒë©´(ì˜†ì—ì„œ ë³¸) ê· í˜•ì„ ì¢…í•©ì ìœ¼ë¡œ í‰ê°€í•˜ëŠ” ì§€í‘œì…ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤2cm<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> 2cm ì´ˆê³¼ ì‹œ ì¤‘ë ¥ ì¤‘ì‹¬ì„  ì´íƒˆë¡œ ì¸í•œ ì „ì²´ ê·¼ê³¨ê²©ê³„ ë¶€ë‹´ ì¦ê°€ ë° ì—ë„ˆì§€ ì†Œëª¨ê°€ ì¦ê°€í•©ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">HPA (Headâ€“Pelvis Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ë¨¸ë¦¬(Tragus)ì™€ ê³¨ë°˜(PSIS)ì„ ì—°ê²°í•œ ì„ ê³¼ ìˆ˜ì§ì„  ì‚¬ì´ì˜ ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ë¨¸ë¦¬ì™€ ê³¨ë°˜ì˜ ìƒëŒ€ì  ìœ„ì¹˜ ê´€ê³„ë¥¼ í†µí•´ ì „ì‹  ìì„¸ë¥¼ ì¢…í•© í‰ê°€í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-10Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> ì´ìƒ ê°ë„ëŠ” ë¨¸ë¦¬-ê³¨ë°˜ ë¶„ì ˆ ê°„ í˜‘ì‘ ë¶€ì¡±ì„ ë‚˜íƒ€ë‚´ë©°, ì „ì‹  ìì„¸ ë¶ˆê· í˜•ì˜ ì§€í‘œì…ë‹ˆë‹¤.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">PDS (Postural Deviation Score)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ìœ„ 15ê°œ í•­ëª©ì˜ ë¹„ì •ìƒ ì •ë„ë¥¼ ì ìˆ˜í™”í•˜ì—¬ í•©ì‚°<br>
          <strong>ì˜ë¯¸:</strong> ì „ì²´ì ì¸ ìì„¸ ë¶ˆê· í˜•ì˜ ì •ë„ë¥¼ í•˜ë‚˜ì˜ ìˆ«ìë¡œ ìš”ì•½í•œ ì¢…í•© ì§€í‘œì…ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0-10ì <br>
          <strong>ë¶„ë¥˜:</strong> 0-10 (ì •ìƒ), 11-20 (ê²½ë¯¸), 21-30 (ì¤‘ë“±ë„), 31+ (ì‹¬ê°)<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> ì ìˆ˜ê°€ ë†’ì„ìˆ˜ë¡ ë‹¤ì–‘í•œ ìì„¸ ë¬¸ì œê°€ ë³µí•©ì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ë©°, ì „ë¬¸ì ì¸ êµì • ì¹˜ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.
        </div>
      </details>
      
      <!-- ì •ë©´ í•­ëª© (ì•ëª¨ìŠµ) - ìƒ‰ìƒ: #2ec4b6 -->
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">STA (Shoulder Tilt Angle) - ì–´ê¹¨ ì¢Œìš° ê¸°ìš¸ê¸°</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle(line(L_acromion, R_acromion), horizontal)<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì¹´ë©”ë¼ë¥¼ ê°€ìŠ´ ì¤‘ì•™ ë†’ì´ì— ê³ ì •í•˜ê³  í”¼í—˜ìëŠ” ì •ë©´ìœ¼ë¡œ ì„  ìì„¸ ìœ ì§€. â‘¡ ì¢ŒÂ·ìš° Acromionì˜ ì¢Œí‘œë¥¼ ì¸ì‹. â‘¢ Î”yë¥¼ ê°ë„ë¡œ ë³€í™˜(atan(Î”y / Î”x)).<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤ 3Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ ì–´ê¹¨ ì¢Œìš° ë¶ˆê· í˜•, ìŠ¹ëª¨ê·¼Â·ëŠ¥í˜•ê·¼ ê¸´ì¥ ì°¨ì´ ê°€ëŠ¥ì„±.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">POA (Pelvic Obliquity Angle) - ê³¨ë°˜ ì¢Œìš° ê¸°ìš¸ê¸°</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle(line(L_ASIS, R_ASIS), horizontal)<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì¹´ë©”ë¼ë¥¼ ê³¨ë°˜ ë†’ì´ì— ë§ì¶”ê³  ì •ë©´ì—ì„œ ì´¬ì˜. â‘¡ ì¢ŒÂ·ìš° ASISë¥¼ ì¸ì‹í•˜ê³  Î”y ê³„ì‚°. â‘¢ ê°ë„ ê³„ì‚°: POA = atan(Î”y / Î”x).<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤ 3Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ ê³¨ë°˜ ì¢Œìš° ë¹„ëŒ€ì¹­ / í•˜ì§€ ê¸¸ì´ ì°¨ / ìš”ì¶” ì¸¡ë§Œ ê°€ëŠ¥ì„±.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">LLD (Leg Length Discrepancy) - í•˜ì§€ ê¸¸ì´ ì°¨</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> |distance(L_ASIS, L_ankle) - distance(R_ASIS, R_ankle)|<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì „ì‹ ì´ ë³´ì´ë„ë¡ ì •ë©´ ì´¬ì˜. â‘¡ ì¢ŒÂ·ìš° ASIS ë° ë°œëª©(Ankle) ì¢Œí‘œ ì¸ì‹. â‘¢ ê±°ë¦¬(cm) í™˜ì‚°(pxPerCm ë³´ì •).<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤ 1 cm<br>
          <strong>í•´ì„:</strong> â†‘ â†’ êµ¬ì¡°ì  ë˜ëŠ” ê¸°ëŠ¥ì  í•˜ì§€ ê¸¸ì´ ì°¨ ì¡´ì¬.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">TD (Trunk Deviation) - ì²´ê°„ í¸ìœ„</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> horizontal deviation(C7, midline(L_ankle, R_ankle))<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì¹´ë©”ë¼ë¥¼ ì •ë©´, ì–‘ ë°œëª©ì´ ìˆ˜í‰ì— ì˜¤ë„ë¡ ì´¬ì˜. â‘¡ L/R Ankle ì¢Œí‘œë¡œ ì¤‘ê°„ì„ (midpoint) ê³„ì‚°. â‘¢ C7ì˜ ìˆ˜í‰ ê±°ë¦¬ í¸ì°¨ ê³„ì‚°.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> Â± 2Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ ì²´ê°„ì´ ì¢Œìš°ë¡œ ê¸°ìš¸ì–´ì§ / ì²´ì¤‘ ì¤‘ì‹¬ ë¶ˆê· í˜•.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">HTA (Head Tilt Angle) - ë¨¸ë¦¬ ì¢Œìš° ê¸°ìš¸ê¸°</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle(line(L_tragus, R_tragus), horizontal)<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì •ë©´ì—ì„œ Tragus ì¢Œìš°ê°€ ëª…í™•íˆ ë³´ì´ë„ë¡ ì´¬ì˜. â‘¡ ë‘ ì ì˜ yì¢Œí‘œ ì°¨ì´ ê³„ì‚° â†’ ê°ë„ë¡œ ë³€í™˜.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> â‰¤ 3Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ ê²½ë¶€ ì¸¡êµ´ ë˜ëŠ” ì¸¡ë§Œì„± ê¸´ì¥ íŒ¨í„´.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">SPP (Shoulderâ€“Pelvis Parallelism) - ì–´ê¹¨-ê³¨ë°˜ í‰í–‰ë„</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle_diff(line(L_acromion, R_acromion), line(L_ASIS, R_ASIS))<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì •ë©´ ì´¬ì˜ ì‹œ L/R ì–´ê¹¨ì™€ L/R ASISê°€ ëª¨ë‘ ë³´ì—¬ì•¼ í•¨. â‘¡ ë‘ ì„ ì˜ ê°ë„ ì°¨ ê³„ì‚°.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> 0â€“3Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ ì²´ê°„ íšŒì „ / ê³¨ë°˜ ë¹„í‹€ë¦¼ / ì²™ì¶” íšŒì „ì„± ë¶ˆê· í˜•.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">Q-Angle (ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ë°©ë²•:</strong> ASIS-ë¬´ë¦(Knee)-ê²½ê³¨ì¡°ë©´(Tibial Tuberosity) ì„¸ ì ì´ ì´ë£¨ëŠ” ê°ë„<br>
          <strong>ì˜ë¯¸:</strong> ëŒ€í‡´ì‚¬ë‘ê·¼ì˜ ë‹¹ê¹€ ë°©í–¥ì„ í‰ê°€í•˜ì—¬ ë¬´ë¦ ì •ë ¬ì„ í™•ì¸í•©ë‹ˆë‹¤.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> ë‚¨ì„± 10-15Â°, ì—¬ì„± 15-20Â°<br>
          <strong>ì„ìƒì  ì˜ë¯¸:</strong> &gt;20Â°ëŠ” ìŠ¬ê°œê³¨ ì™¸ì¸¡ ì „ìœ„ ë° ìŠ¬ê°œëŒ€í‡´ í†µì¦ ì¦í›„êµ°ì˜ ìœ„í—˜ ìš”ì¸ì…ë‹ˆë‹¤.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">KAS (Knee Alignment Symmetry) - ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„±</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle_diff(line(L_knee, L_ankle), line(R_knee, R_ankle))<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì •ë©´ì—ì„œ ë¬´ë¦ê³¼ ë°œëª© ëª¨ë‘ ì¸ì‹. â‘¡ ê° ë¬´ë¦â€“ë°œëª© ìˆ˜ì§ì„ ì˜ ê°ë„ ë¹„êµ.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> ëŒ€ì¹­(Â±2Â° ì´ë‚´)<br>
          <strong>í•´ì„:</strong> â†‘ â†’ í•œìª½ ë‚´ë°˜/ì™¸ë°˜ ë˜ëŠ” í•˜ì§€ íšŒì „ íŒ¨í„´.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">LLAS (Lower Limb Axis Symmetry) - í•˜ì§€ ì¶• ëŒ€ì¹­ì„±</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>ì¸¡ì • ê¸°ì¤€:</strong> angle_diff(line(L_ASIS, L_ankle), line(R_ASIS, R_ankle))<br>
          <strong>ì¸¡ì • ë°©ë²•:</strong> â‘  ì •ë©´ì—ì„œ í•˜ì§€ ì „ì²´ ì´¬ì˜. â‘¡ ê° í•˜ì§€ì¶• ë¼ì¸ ê°ë„ ë¹„êµ.<br>
          <strong>ì •ìƒ ë²”ìœ„:</strong> Â±2Â°<br>
          <strong>í•´ì„:</strong> â†‘ â†’ í•œìª½ íšŒë‚´Â·íšŒì™¸ ë˜ëŠ” í•˜ì§€ íšŒì „ì„± ë¶ˆê· í˜•.
        </div>
      </details>
      
    </div>
  </div>
  
  <!-- ì‹¤ì‹œê°„ ë¶„ì„ ê²°ê³¼ íŒ¨ë„ -->
  <div id="liveAnalysisPanel" style="margin-top:12px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#7c9cff;">ğŸ“Š ì‹¤ì‹œê°„ AI ë¶„ì„ ê²°ê³¼</div>
    <div id="livePDS" style="font-size:16px; font-weight:700; margin-bottom:8px; color:#7c9cff;">PDS: â€”</div>
    <div id="livePatterns" style="font-size:12px; line-height:1.6;"></div>
  </div>

  <!-- ê·¼ìœ¡ ìƒíƒœ ë¶„ì„ (ë¨¼ì € í‘œì‹œ) -->
  <div id="musclePanel" style="margin-top:12px; padding:12px; background:rgba(255,184,108,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#ffb86c; font-family: 'Noto Sans KR', sans-serif;">ğŸ’ª ê·¼ìœ¡ ìƒíƒœ ë¶„ì„</div>
    <div id="muscleTight" style="margin-bottom:8px;">
      <div class="muted" style="font-size:12px; margin-bottom:4px; font-family: 'Noto Sans KR', sans-serif;">ğŸ”´ ê¸´ì¥ëœ ê·¼ìœ¡:</div>
      <div id="muscleTightList" style="font-size:12px; color:#ff6b6b; line-height:1.6; font-family: 'Noto Sans KR', sans-serif;"></div>
    </div>
    <div id="muscleWeak" style="margin-bottom:8px;">
      <div class="muted" style="font-size:12px; margin-bottom:4px; font-family: 'Noto Sans KR', sans-serif;">ğŸ”µ ì•½í™”ëœ ê·¼ìœ¡:</div>
      <div id="muscleWeakList" style="font-size:12px; color:#7c9cff; line-height:1.6; font-family: 'Noto Sans KR', sans-serif;"></div>
    </div>
  </div>

  <!-- AI ì²´í˜• ë¶„ì„ (ê·¼ìœ¡ ìƒíƒœ ë¶„ì„ ë‹¤ìŒ) -->
  <div id="aiCommentPanel" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.1); border-radius:10px; display:none; font-family: 'Noto Sans KR', sans-serif;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#2ec4b6; font-family: 'Noto Sans KR', sans-serif;">ğŸ¤– AI ì²´í˜• ë¶„ì„</div>
    <div id="aiComment" class="muted" style="font-size:12px; line-height:1.6; font-family: 'Noto Sans KR', sans-serif; color:var(--ink);"></div>
    
    <!-- ê°œì¸ë³„ ì²´í˜• ë¶„ì„ ì„¤ëª… -->
    <div id="postureTypeDesc" style="margin-top:12px; padding:10px; background:rgba(255,255,255,0.1); border-radius:8px; border-left:3px solid #2ec4b6; font-family: 'Noto Sans KR', sans-serif;">
      <div style="font-size:13px; font-weight:600; margin-bottom:6px; color:#2ec4b6; font-family: 'Noto Sans KR', sans-serif;">ğŸ“Œ ì²´í˜• ìœ í˜• ë¶„ì„</div>
      <div id="postureTypeContent" style="font-size:12px; line-height:1.6; color:var(--muted); font-family: 'Noto Sans KR', sans-serif;"></div>
    </div>
  </div>

  <!-- ì¶”ì²œ ìš´ë™ -->
  <div id="exercisePanel" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.15); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#2ec4b6; font-family: 'Noto Sans KR', sans-serif;">ğŸ‹ï¸ ì¶”ì²œ ìš´ë™</div>
    <div id="exerciseList" style="font-size:12px; line-height:1.6; font-family: 'Noto Sans KR', sans-serif;"></div>
  </div>

  <!-- í•„ë¼í…ŒìŠ¤ ì„¸ì…˜ ì¶”ì²œ -->
  <div id="pilatesPanel" style="margin-top:12px; padding:12px; background:rgba(156,136,255,0.15); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#9c88ff; font-family: 'Noto Sans KR', sans-serif;">ğŸ§˜ í•„ë¼í…ŒìŠ¤ ì„¸ì…˜ ì¶”ì²œ</div>
    <div id="pilatesList" style="font-size:12px; line-height:1.6; font-family: 'Noto Sans KR', sans-serif;"></div>
  </div>

  <!-- í•„ë¼í…ŒìŠ¤ ìš´ë™ ìƒì„¸ ì„¤ëª… ëª¨ë‹¬ -->
  <div id="pilatesExerciseModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; overflow-y:auto; padding:20px; box-sizing:border-box;">
    <div style="max-width:600px; margin:0 auto; background:#1a1a2e; border-radius:12px; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 id="modalExerciseTitle" style="margin:0; color:#9c88ff; font-size:18px; font-weight:600;"></h3>
        <button id="closeModalBtn" style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>
      <div id="modalExerciseContent" style="color:#e0e0e0; line-height:1.8; font-size:13px;">
        <!-- ìš´ë™ ìƒì„¸ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </div>
  </div>


  <!-- ê²°ë¡  ë° í–¥í›„ ê¶Œì¥ì‚¬í•­ (íšŒì› ì´ë¦„ í¬í•¨, ì„ìƒ ì¤‘ì‹¬) -->
  <div id="conclusionPanel" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#2ec4b6; font-family: 'Noto Sans KR', sans-serif;">âœ… ê²°ë¡  ë° í–¥í›„ ê¶Œì¥ì‚¬í•­</div>
    <div id="conclusionContent" style="font-size:12px; line-height:1.8; color:var(--ink); font-family: 'Noto Sans KR', sans-serif; white-space:pre-wrap; word-wrap:break-word;"></div>
  </div>

  <!-- í•­ëª© (Before/After ë¹„êµ í…Œì´ë¸”) -->
  <div style="margin-top:12px; max-height:400px; overflow-y:auto;">
    <table class="tbl">
      <thead><tr><th>í•­ëª©</th><th>Before</th><th>After</th><th>ë³€í™”</th><th>ì •ìƒ</th></tr></thead>
      <tbody>
        <tr><td>CVA(ë‘ê°œê²½ì¶”ê°)</td><td id="cmpCvaB">â€”</td><td id="cmpCvaA">â€”</td><td id="cmpCvaD">â€”</td><td>â‰¥50Â°</td></tr>
        <tr><td>HPD(ë‘ë¶€ì „ë°©ì´ë™)</td><td id="cmpHpdB">â€”</td><td id="cmpHpdA">â€”</td><td id="cmpHpdD">â€”</td><td>â‰¤2cm</td></tr>
        <tr><td>TIA(ì²´ê°„ê²½ì‚¬ê°)</td><td id="cmpTiaB">â€”</td><td id="cmpTiaA">â€”</td><td id="cmpTiaD">â€”</td><td>0-10Â°</td></tr>
        <tr><td>SAA(ì–´ê¹¨ì „ë°©ê°)</td><td id="cmpSaaB">â€”</td><td id="cmpSaaA">â€”</td><td id="cmpSaaD">â€”</td><td>0-10Â°</td></tr>
        <tr><td>PTA(ê³¨ë°˜ ì „í›„ê²½ì‚¬ê°)</td><td id="cmpPtaB">â€”</td><td id="cmpPtaA">â€”</td><td id="cmpPtaD">â€”</td><td>0-15Â°</td></tr>
        <tr><td>KA(ë¬´ë¦ê°)</td><td id="cmpKaB">â€”</td><td id="cmpKaA">â€”</td><td id="cmpKaD">â€”</td><td>175-185Â°</td></tr>
        <tr><td>Tibial(ê²½ê³¨ê²½ì‚¬ê°)</td><td id="cmpTibialB">â€”</td><td id="cmpTibialA">â€”</td><td id="cmpTibialD">â€”</td><td>0-10Â°</td></tr>
        <tr><td>GSB(ì¤‘ë ¥ì¤‘ì‹¬ì„ )</td><td id="cmpGsbB">â€”</td><td id="cmpGsbA">â€”</td><td id="cmpGsbD">â€”</td><td>â‰¤2cm</td></tr>
        <tr><td>HPA(ê³ ê´€ì ˆê°)</td><td id="cmpHpaB">â€”</td><td id="cmpHpaA">â€”</td><td id="cmpHpaD">â€”</td><td>0-10Â°</td></tr>
        <tr><td>PDS(ìì„¸ì ìˆ˜)</td><td id="cmpPdsB">â€”</td><td id="cmpPdsA">â€”</td><td id="cmpPdsD">â€”</td><td>0-10</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">STA(ì–´ê¹¨ê¸°ìš¸ê¸°ê°)</td><td id="cmpStaB">â€”</td><td id="cmpStaA">â€”</td><td id="cmpStaD">â€”</td><td>â‰¤3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">POA(ê³¨ë°˜ê¸°ìš¸ê¸°ê°)</td><td id="cmpPoaB">â€”</td><td id="cmpPoaA">â€”</td><td id="cmpPoaD">â€”</td><td>â‰¤3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">LLD(í•˜ì§€ê¸¸ì´ì°¨)</td><td id="cmpLldfB">â€”</td><td id="cmpLldfA">â€”</td><td id="cmpLldfD">â€”</td><td>â‰¤1cm</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">Q-Angle(Qê°)</td><td id="cmpQangleB">â€”</td><td id="cmpQangleA">â€”</td><td id="cmpQangleD">â€”</td><td>10-20Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">Knee Dev(ë¬´ë¦í¸ìœ„)</td><td id="cmpKneedevB">â€”</td><td id="cmpKneedevA">â€”</td><td id="cmpKneedevD">â€”</td><td>0-3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">TD(ì²´ê°„í¸ìœ„)</td><td id="cmpTdB">â€”</td><td id="cmpTdA">â€”</td><td id="cmpTdD">â€”</td><td>0-3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">HTA(ë¨¸ë¦¬ê¸°ìš¸ê¸°ê°)</td><td id="cmpHtaB">â€”</td><td id="cmpHtaA">â€”</td><td id="cmpHtaD">â€”</td><td>â‰¤3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">SPP(ì–´ê¹¨ê³¨ë°˜í‰í–‰ë„)</td><td id="cmpSppB">â€”</td><td id="cmpSppA">â€”</td><td id="cmpSppD">â€”</td><td>0-3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">KAS(ë¬´ë¦ì •ë ¬ëŒ€ì¹­ì„±)</td><td id="cmpKasB">â€”</td><td id="cmpKasA">â€”</td><td id="cmpKasD">â€”</td><td>0-3Â°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">LLAS(í•˜ì§€ì¶•ëŒ€ì¹­ì„±)</td><td id="cmpLlasB">â€”</td><td id="cmpLlasA">â€”</td><td id="cmpLlasD">â€”</td><td>0-3Â°</td></tr>
        <tr style="background:#f0f0f0; font-weight:600;"><td>ì²´í˜• ì ìˆ˜</td><td id="cmpScoreB">â€”</td><td id="cmpScoreA">â€”</td><td id="cmpScoreD">â€”</td><td>0â€“100</td></tr>
      </tbody>
    </table>
  </div>
</aside>
<main class="panel canvasWrap" style="order: 2;">
  <canvas id="cv" width="1600" height="1000"></canvas>
</main>

<!-- âœ… ì „ì—­ ì¶©ëŒ ë°©ì–´ ë° ê°•ì œ ë“±ë¡ (ìµœìš°ì„  ì‹¤í–‰) -->
<script>
// ---- ì „ì—­ ì¶©ëŒ ë°©ì–´ ----
// sessionsëŠ” ë‚˜ì¤‘ì— ê°ì²´ë¡œ ì •ì˜ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” undefined ì²´í¬ë§Œ
if (typeof window.sessions === 'undefined') {
  window.sessions = null; // ì„ì‹œë¡œ null, ë‚˜ì¤‘ì— ì‹¤ì œ ê°ì²´ë¡œ êµì²´ë¨
}
window.analyzePostureAI = window.analyzePostureAI || function(before, after) {
  console.log("âœ… analyzePostureAI ê°•ì œ ë°”ì¸ë”© ì‹¤í–‰ë¨", { before, after });
  // ì‹¤ì œ í•¨ìˆ˜ê°€ ë‚˜ì¤‘ì— ì •ì˜ë˜ë©´ ë®ì–´ì”Œì›Œì§
  return { results: [], findings: [], muscles: { tight: [], weak: [] } };
};


// ---- íŒŒì¼ ì—…ë¡œë“œ ê°•ì œ ë“±ë¡ ----
window.setupFileUploads = window.setupFileUploads || function() {
  console.log("ğŸ“Œ setupFileUploads ê°•ì œ í™œì„±í™”");
  
  const fileInputs = document.querySelectorAll("input[type=file]");
  fileInputs.forEach(input => {
    // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° í›„ ì¬ë“±ë¡
    const newInput = input.cloneNode(true);
    input.parentNode.replaceChild(newInput, input);
    
    newInput.addEventListener("change", (e) => {
      console.log("ğŸ“ íŒŒì¼ ì„ íƒë¨:", e.target.files);
      const file = e.target.files[0];
      if (!file) return;
      
      // ì‹¤ì œ íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ê°€ ìˆìœ¼ë©´ í˜¸ì¶œ (ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ í•¨ìˆ˜ê°€ ì •ì˜ë  ë•Œê¹Œì§€ ëŒ€ê¸°)
      setTimeout(() => {
        if (typeof window.handleFileUpload === 'function') {
          window.handleFileUpload(e);
        } else if (typeof handleFileUpload === 'function') {
          handleFileUpload(e);
        } else {
          console.warn("âš ï¸ handleFileUpload í•¨ìˆ˜ê°€ ì•„ì§ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.");
          // 200ms í›„ ë‹¤ì‹œ ì‹œë„
          setTimeout(() => {
            if (typeof window.handleFileUpload === 'function') {
              window.handleFileUpload(e);
            } else if (typeof handleFileUpload === 'function') {
              handleFileUpload(e);
            } else {
              console.error("âŒ handleFileUpload í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
          }, 200);
        }
      }, 100);
    });
  });
};

// DOM ì¤€ë¹„ë˜ë©´ ì¦‰ì‹œ ì‹¤í–‰ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
let appInitialized = false;

function initializeAppOnce() {
  if (appInitialized) {
    console.log("ğŸš« ì•±ì´ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    return;
  }
  appInitialized = true;

    console.log("ğŸ”¥ DOM ì¤€ë¹„ë¨ â†’ íŒŒì¼ ì²¨ë¶€ ê¸°ëŠ¥ ì£¼ì…");
    if (window.setupFileUploads) {
      window.setupFileUploads();
    }
  // ì•± ì´ˆê¸°í™”
  initializeApp();
}

if (document.readyState === 'loading') {
  document.addEventListener("DOMContentLoaded", initializeAppOnce);
} else {
  // ì´ë¯¸ ë¡œë“œ ì™„ë£Œëœ ê²½ìš° ì¦‰ì‹œ ì‹¤í–‰
  initializeAppOnce();
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js"></script>
<!-- AI ìë™ ë¶„ì„ ëª¨ë“ˆ í†µí•© -->
<!-- PRO í†µí•© ë²„ì „ (ê¸°ì¡´ + DB ê¸°ë°˜ ë¶„ì„): main_pro_compatible.js -->
<!-- <script type="module" src="./js/main_pro_compatible.js"></script> -->
<script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466862/camera_utils.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1675466124/drawing_utils.js"></script>
<script>
// ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸ í•¨ìˆ˜
function checkLibraries() {
  if (!window.jspdf || !window.jspdf.jsPDF) {
    throw new Error("jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
  }
  if (typeof html2canvas === 'undefined') {
    throw new Error("html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
  }
  return true;
}

// jsPDFëŠ” í•¨ìˆ˜ ë‚´ì—ì„œ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜´ (ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸ í›„)
const cv = document.getElementById("cv");
const ctx = cv ? cv.getContext("2d") : null;
let DPR = window.devicePixelRatio || 1;
let dragKey = null;
let autoFollowKey = null; // ìë™ ì¶”ì  ëª¨ë“œ (í´ë¦­ ì‹œ ë”°ë¼ì˜¤ëŠ” dot)
let editMode = false;
let selectedPoint = null;
let originalCanvasSize = { width: 0, height: 0, styleWidth: 0, styleHeight: 0 };
let currentZoom = 1;
let isScrolling = false;
let scrollStartX = 0;
let scrollStartY = 0;
let touchStartTime = 0;
let scrollDistance = 0; // ìŠ¤í¬ë¡¤ ì‹œì‘ í›„ ì´ë™ ê±°ë¦¬
let longPressTimer = null;
let longPressDetected = false;
let longPressNearPoint = null; // long pressê°€ ê°ì§€ëœ ì 

// ì˜†ëª¨ìŠµ í‚¤í¬ì¸íŠ¸
// ì¸¡ë©´ í‚¤í¬ì¸íŠ¸ (Flutterì™€ 1:1 ë§¤ì¹­: ì†Œë¬¸ì í†µì¼)
const keypointsSide = [
  {key:'tragus', color:'#7c9cff'},
  {key:'c7', color:'#7c9cff'},
  {key:'acromion', color:'#7c9cff'},
  {key:'hip', color:'#7c9cff'},
  {key:'knee', color:'#7c9cff'},
  {key:'ankle', color:'#7c9cff'},
  {key:'asis', color:'#ffb86c'},
  {key:'psis', color:'#ffb86c'},
];

// ì •ë©´ í‚¤í¬ì¸íŠ¸ (Flutterì™€ 1:1 ë§¤ì¹­)
const keypointsFront = [
  {key:'L_tragus', color:'#7c9cff'},  // ì •ë©´: ì™¼ìª½ ê·€
  {key:'R_tragus', color:'#7c9cff'},  // ì •ë©´: ì˜¤ë¥¸ìª½ ê·€
  {key:'c7', color:'#7c9cff'},
  {key:'L_acromion', color:'#7c9cff'},
  {key:'R_acromion', color:'#7c9cff'},
  {key:'L_asis', color:'#ffb86c'},
  {key:'R_asis', color:'#ffb86c'},
  {key:'L_ankle', color:'#7c9cff'},
  {key:'R_ankle', color:'#7c9cff'},
  {key:'L_knee', color:'#7c9cff'},
  {key:'R_knee', color:'#7c9cff'},
  {key:'L_tibial_tub', color:'#ff6b6b'},  // Q-angle ì¸¡ì •ìš©: ê²½ê³¨ ê²°ì ˆ
  {key:'R_tibial_tub', color:'#ff6b6b'},  // Q-angle ì¸¡ì •ìš©: ê²½ê³¨ ê²°ì ˆ
];

// ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•´ keypoints ë³€ìˆ˜ ìœ ì§€ (getKeypoints í•¨ìˆ˜ë¡œ ë™ì  ë°˜í™˜)
let keypoints = keypointsSide; // ê¸°ë³¸ê°’

// í˜„ì¬ ì„¸ì…˜ ì„¤ì •
let cur = "Before";

const clamp = (v,min,max) => Math.min(max,Math.max(min,v));
const rad2deg = r => r * 180 / Math.PI;
const deg2rad = d => d * Math.PI / 180;
const angleBetween = (a,b) => Math.atan2(b.y - a.y, b.x - a.x);

// âœ… ìƒˆë¡œìš´ ê°ë„ ìœ í‹¸ í•¨ìˆ˜ë“¤ (ì •ê·œí™” ë° ì •í™•í•œ ê³„ì‚°)
function angleFromHorizontalDeg(a, b) {
  return Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI; // -180~+180
}

// -90~+90 ë¡œ ì •ê·œí™”(í•­ìƒ ì˜ˆê°)
function normalizeToAcuteDeg(theta) {
  let t = theta;
  if (t > 90)  t -= 180;
  if (t < -90) t += 180;
  return t;
}

// ìˆ˜ì§ ê¸°ì¤€ì—ì„œ ì „/í›„ë°© ë¶€í˜¸(+ì „ë°©, -í›„ë°©)
function angleFromVerticalSignedDeg(top, bottom) {
  const dx = top.x - bottom.x;
  const dy = bottom.y - top.y; // ìœ„->ì•„ë˜
  const acute = Math.atan2(Math.abs(dx), Math.abs(dy)) * 180 / Math.PI; // 0~90
  return dx >= 0 ? +acute : -acute;
}

// ê´€ì ˆë‚´ë¶€ê° (B-vertex)
function jointAngleDeg(a, b, c) {
  const v1x = a.x - b.x, v1y = a.y - b.y;
  const v2x = c.x - b.x, v2y = c.y - b.y;
  const dot = v1x*v2x + v1y*v2y;
  const m1 = Math.hypot(v1x, v1y), m2 = Math.hypot(v2x, v2y);
  const cos = Math.min(1, Math.max(-1, dot/(m1*m2)));
  return Math.acos(cos) * 180/Math.PI;
}

// ì¢Œ/ìš° ì •ê·œí™” ìœ í‹¸
function isRightSideView(pts) {
  const t = pts["tragus"] || pts["Tragus"];
  const c7 = pts["c7"] || pts["C7"];
  if (!t || !c7) return false;
  return t.x < c7.x;
}

function mirrorToLeft(points, imageWidth) {
  const out = {};
  for (const k in points) {
    const p = points[k];
    out[k] = { x: imageWidth - p.x, y: p.y };
  }
  return out;
}

function ensureLeftSide(points, imageWidth) {
  return isRightSideView(points) ? mirrorToLeft(points, imageWidth) : points;
}

// ë‘ ì  ì‚¬ì´ ê°ë„(ìˆ˜í‰ ê¸°ì¤€, p1->p2), í™”ë©´ y-down ì¢Œí‘œê³„ ê°€ì • (í•˜ìœ„ í˜¸í™˜ì„±)
function angleP1P2(p1, p2) {
  return angleFromHorizontalDeg(p1, p2);
}

// ë‘ ì  ì‚¬ì´ ê±°ë¦¬(í”½ì…€)
function dist(p1, p2) {
  const dx = p1.x - p2.x;
  const dy = p1.y - p2.y;
  return Math.sqrt(dx*dx + dy*dy);
}

// ì™¸ì /ë‚´ì  ê¸°ë°˜ ê°ë„(pA-vertex-pB)
function angleAt(v, a, b) {
  const ax = a.x - v.x;
  const ay = a.y - v.y;
  const bx = b.x - v.x;
  const by = b.y - v.y;
  const dot = ax*bx + ay*by;
  const na = Math.sqrt(ax*ax + ay*ay);
  const nb = Math.sqrt(bx*bx + by*by);
  if (na === 0 || nb === 0) return NaN;
  return rad2deg(Math.acos(Math.max(-1, Math.min(1, dot / (na*nb)))));
}

// ìˆ˜ì§ì„ (90Â°)ê³¼ ë¼ì¸ ê°ë„ ì°¨ì´ ì ˆëŒ€ê°’
function angleToVertical(p1, p2) {
  const a = angleP1P2(p1, p2);
  // 180ë„ê°€ ì™„ì „ ìˆ˜ì§, 0ë„ë„ ì™„ì „ ìˆ˜ì§ (ë°˜ëŒ€ ë°©í–¥)
  // ì‚¬ìš©ì ìš”êµ¬ì‚¬í•­: 180ë„ â†’ 0ë„ TIA, 170ë„ â†’ 10ë„ TIA
  // ìˆ˜ì§(180ë„)ì—ì„œ ë²—ì–´ë‚œ ê°ë„ë¥¼ ê³„ì‚°
  return Math.abs(180 - Math.abs(a));
}

// ìˆ˜í‰ì„ ê³¼ ë¼ì¸ ê°ë„ ì ˆëŒ€ê°’
function angleToHorizontal(p1, p2) {
  return Math.abs(angleP1P2(p1, p2));
}

// ë²”ìœ„ ë¶„ë¥˜ í•¨ìˆ˜ (normal, mild, moderate, severe)
function classifyRange({
  v,
  nMin = null, nMax = null,
  mildMin = null, mildMax = null,
  modMin = null, modMax = null,
  sevMin = null, sevMax = null,
  higherIsWorse = false
}) {
  function inRange(x, lo, hi) {
    return (lo == null || x >= lo) && (hi == null || x <= hi);
  }
  
  if (inRange(v, nMin, nMax)) return "normal";
  if (inRange(v, mildMin, mildMax)) return "mild";
  if (inRange(v, modMin, modMax)) return "moderate";
  if (inRange(v, sevMin, sevMax)) return "severe";
  
  // ë°©í–¥ì„± íŒíŠ¸
  return higherIsWorse
    ? (v > (nMax ?? v) ? "worse_high" : "worse_low")
    : (v < (nMin ?? v) ? "worse_low" : "worse_high");
}

// pxâ†’cm ë³€í™˜
function pxToCm(px, scalePxPerCm = 50) {
  return px / scalePxPerCm;
}

// âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ìœ í‹¸: ë‘ ì  ê°„ ê±°ë¦¬ë¡œ pxPerCm ê³„ì‚°
function calibratePxPerCm(pointA, pointB, realLengthCm) {
  if (realLengthCm <= 0) {
    throw new Error("realLengthCm must be > 0");
  }
  const distPx = dist(pointA, pointB);
  return distPx / realLengthCm;
}

// âœ… ì¸¡ë©´ ìì„¸ ë¶„ì„ (ì „ì²´ ì§€í‘œ í¬í•¨)
function analyzeFullPosture(points, pxPerCm = 50.0, imageWidth = 1080) {
  // ì¢Œìš° ì •ê·œí™”: ì˜¤ë¥¸ì˜† ì‚¬ì§„ì´ë©´ ì™¼ì˜†ìœ¼ë¡œ ë¯¸ëŸ¬ë§
  const normalizedPoints = ensureLeftSide(points, imageWidth);
  
  function p(k) {
    const v = normalizedPoints[k];
    if (!v || v.x == null || v.y == null) return null;
    return { x: Number(v.x), y: Number(v.y) };
  }
  
  const result = {};
  
  // Flutter 1:1 ë§¤ì¹­ í‚¤ (ì†Œë¬¸ì ìš°ì„ , ê¸°ì¡´ ëŒ€ë¬¸ìëŠ” fallback)
  const tragus = p("tragus") || p("Tragus");
  const C7 = p("c7") || p("C7");
  const acromion = p("acromion") || p("Shoulder") || p("Acromion");
  const ASIS = p("asis") || p("ASIS");
  const PSIS = p("psis") || p("PSIS");
  const hip = p("hip") || p("Hip");
  const knee = p("knee") || p("Knee");
  const ankle = p("ankle") || p("Ankle");
  
  // 1ï¸âƒ£ CVA (Craniovertebral Angle): C7 ìˆ˜í‰ë©´ ê¸°ì¤€ ê°ë„
  // ìŠ¤í™: C7 ìˆ˜í‰ë©´ì„ 0ë„ ê¸°ì¤€ìœ¼ë¡œ, C7->Tragus ì„ ì´ ìˆ˜í‰ë©´ê³¼ ì´ë£¨ëŠ” ê°ë„
  if (tragus && C7) {
    const cv_theta = angleFromHorizontalDeg(C7, tragus);
    const cv_acute = normalizeToAcuteDeg(cv_theta);
    // C7 ìˆ˜í‰ë©´ ê¸°ì¤€: ìˆ˜í‰ì„ ê³¼ ì´ë£¨ëŠ” ê°ë„ì˜ ì ˆëŒ“ê°’ (0ë„ = ìˆ˜í‰ë©´)
    const cva = Math.abs(cv_acute);
    
    result.CVA = {
      value: cva,
      status: classifyRange({
        v: cva,
        nMin: 50, nMax: 90,
        mildMin: 45, mildMax: 49,
        modMin: 40, modMax: 44,
        sevMin: null, sevMax: 40,
        higherIsWorse: false
      }),
      unit: "Â°",
      desc: "Craniovertebral Angle (ê±°ë¶ëª© í‰ê°€)"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.CVA.value_deg = cva;
    result.CVA.meaning = result.CVA.desc;
  }
  
  // 2ï¸âƒ£ HPD (Head Protrusion Distance): tragusì™€ acromion ê±°ë¦¬
  if (tragus && acromion) {
    const hpd = pxToCm(dist(tragus, acromion), pxPerCm);
    result.HPD = {
      value: hpd,
      status: classifyRange({
        v: hpd,
        nMin: 0, nMax: 2,
        mildMin: 2, mildMax: 4,
        modMin: 4, modMax: 6,
        sevMin: 6, sevMax: null,
        higherIsWorse: true
      }),
      unit: "cm",
      desc: "Head Protrusion Distance (ë¨¸ë¦¬ ëŒì¶œ)"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.HPD.value_cm = hpd;
    result.HPD.meaning = result.HPD.desc;
  }
  
  // 4ï¸âƒ£ TIA (Trunk Inclination Angle): vertical signed (ìœ—ì =Acromion, +ì „ë°©/-í›„ë°©)
  if (acromion && hip) {
    const tia = angleFromVerticalSignedDeg(acromion, hip);
    result.TIA = {
      value: Math.abs(tia),
      value_signed: tia, // ë¶€í˜¸ í¬í•¨ ê°’
      status: classifyRange({
        v: Math.abs(tia),
        nMin: 0, nMax: 5,
        mildMin: 5, mildMax: 10,
        modMin: 10, modMax: 15,
        sevMin: 15, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Trunk Inclination Angle"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.TIA.value_deg = Math.abs(tia);
    result.TIA.meaning = result.TIA.desc;
  }
  
  // 5ï¸âƒ£ SAA (Shoulder Anterior Angle): PSIS ê¸°ì¤€ ìˆ˜ì§ì„ ê³¼ Acromionì˜ ê°ë„
  // 0Â° = Acromionê³¼ PSISê°€ ê°™ì€ xì¶• (ìˆ˜ì§ ì •ë ¬)
  // +ê°: Acromionì´ PSISë³´ë‹¤ ì „ë°©(ì•)ìœ¼ë¡œ ì´ë™ â†’ Rounded Shoulder
  // -ê°: Acromionì´ PSISë³´ë‹¤ í›„ë°©(ë’¤)ìœ¼ë¡œ ì´ë™ â†’ ê²¬ê°‘ í›„ì¸ ê³¼ë‹¤
  // PSISê°€ ì¶•(ê¸°ì¤€ì ), Acromionì´ ì „ë°©ì´ë©´ +ê°ë„ (1ë„ë¶€í„° ì‹œì‘)
  if (acromion && PSIS) {
    const saa = angleFromVerticalSignedDeg(acromion, PSIS); // ìˆ˜ì§ì„  ê¸°ì¤€ ê°ë„
    result.SAA = {
      value: Math.abs(saa), // ì ˆëŒ“ê°’ (0~90Â°)
      value_signed: saa, // ë¶€í˜¸ í¬í•¨ ê°’ (+ì „ë°©/-í›„ë°©)
      status: classifyRange({
        v: Math.abs(saa),
        nMin: 0, nMax: 10,
        mildMin: 10, mildMax: 15,
        modMin: 15, modMax: 20,
        sevMin: 20, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Shoulder Anterior Angle (ì–´ê¹¨ ì „ë°©ê°)"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.SAA.value_deg = Math.abs(saa);
    result.SAA.meaning = result.SAA.desc;
  }
  
  // 6ï¸âƒ£ PTA (Pelvic Tilt Angle): ì„ìƒë¶€í˜¸ (+ì „ë°©/-í›„ë°©)
  // PSIS ê¸°ì¤€: ASISì™€ ê°™ì€ ë†’ì´ = 0ë„
  // ASISê°€ PSISë³´ë‹¤ ìœ„ìª½ì— ìˆìœ¼ë©´ = ê³¨ë°˜ í›„ë°©ê²½ì‚¬ (Posterior Tilt) = ìŒìˆ˜ (-1ë„ë¶€í„°)
  // ASISê°€ PSISë³´ë‹¤ ë°‘ìª½ì— ìˆìœ¼ë©´ = ê³¨ë°˜ ì „ë°©ê²½ì‚¬ (Anterior Tilt) = ì–‘ìˆ˜ (1ë„ë¶€í„°)
  if (ASIS && PSIS) {
    const pta_theta = angleFromHorizontalDeg(PSIS, ASIS);
    const pta_abs = Math.abs(normalizeToAcuteDeg(pta_theta));
    // ì´ë¯¸ì§€ ì¢Œí‘œê³„: yì¶• ì•„ë˜ë¡œ ì¦ê°€
    // ASIS.y < PSIS.y â†’ ASISê°€ ìœ„ìª½(ë†’ìŒ) â†’ í›„ë°©ê²½ì‚¬(ìŒìˆ˜, ìµœì†Œ -1ë„)
    // ASIS.y > PSIS.y â†’ ASISê°€ ë°‘ìª½(ë‚®ìŒ) â†’ ì „ë°©ê²½ì‚¬(ì–‘ìˆ˜, ìµœì†Œ 1ë„)
    let pta;
    if (ASIS.y < PSIS.y) {
      // í›„ë°©ê²½ì‚¬: ASISê°€ PSISë³´ë‹¤ ìœ„ìª½ â†’ ìŒìˆ˜, ìµœì†Œ -1ë„
      pta = -Math.max(1, pta_abs || 1);
    } else if (ASIS.y > PSIS.y) {
      // ì „ë°©ê²½ì‚¬: ASISê°€ PSISë³´ë‹¤ ë°‘ìª½ â†’ ì–‘ìˆ˜, ìµœì†Œ 1ë„
      pta = Math.max(1, pta_abs || 1);
    } else {
      // ê°™ì€ ë†’ì´: 0ë„
      pta = 0;
    }
    result.PTA = {
      value: Math.abs(pta),
      value_signed: pta, // ë¶€í˜¸ í¬í•¨ ê°’
      status: classifyRange({
        v: Math.abs(pta),
        nMin: 5, nMax: 15,
        mildMin: 0, mildMax: 4,
        modMin: 16, modMax: 20,
        sevMin: null, sevMax: null,
        higherIsWorse: false
      }),
      unit: "Â°",
      desc: "Pelvic Tilt Angle"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.PTA.value_deg = Math.abs(pta);
    result.PTA.meaning = result.PTA.desc;
  }
  
  // 7ï¸âƒ£ KA (Knee Alignment Angle): âˆ (Hip, Knee, Ankle)
  // ì¸¡ì • ê¸°ì¤€: ê³ ê´€ì ˆ-ë¬´ë¦-ë°œëª©ì´ ì¼ì§ì„ ì¼ ë•Œ 180Â°
  // ë¬´ë¦ì´ ë’¤ìª½ìœ¼ë¡œ ê°ˆìˆ˜ë¡ 181Â°ë¶€í„° ì¦ê°€, ì•ìª½ìœ¼ë¡œ ë‚˜ê°ˆìˆ˜ë¡ 179Â°ë¶€í„° ê°ì†Œ
  if (hip && knee && ankle) {
    // ê³ ê´€ì ˆ-ë°œëª© ë²¡í„°
    const hipAnkleDx = ankle.x - hip.x;
    const hipAnkleDy = ankle.y - hip.y;
    
    // ê³ ê´€ì ˆ-ë¬´ë¦ ë²¡í„°
    const hipKneeDx = knee.x - hip.x;
    const hipKneeDy = knee.y - hip.y;
    
    // ì™¸ì ì„ ì‚¬ìš©í•˜ì—¬ ë¬´ë¦ì´ ê³ ê´€ì ˆ-ë°œëª© ì„ ì˜ ì–´ëŠ ìª½ì— ìˆëŠ”ì§€ íŒë‹¨
    // ì™¸ì  = (hipAnkleDx, hipAnkleDy) Ã— (hipKneeDx, hipKneeDy)
    // ì´ë¯¸ì§€ ì¢Œí‘œê³„(yì¶• ì•„ë˜ë¡œ ì¦ê°€)ì—ì„œ: ì–‘ìˆ˜ë©´ ë¬´ë¦ì´ ë’¤ìª½, ìŒìˆ˜ë©´ ì•ìª½
    const crossProduct = hipAnkleDx * hipKneeDy - hipAnkleDy * hipKneeDx;
    
    // ë‚´ë¶€ ê°ë„ ê³„ì‚° (0~180ë„)
    const internalAngle = jointAngleDeg(hip, knee, ankle);
    
    // ë¬´ë¦ì´ ê³ ê´€ì ˆ-ë°œëª© ì„ ì˜ ë’¤ìª½ì— ìˆìœ¼ë©´ ê³¼ì‹ ì „ (ê°ë„ ì¦ê°€, 181Â° ì´ìƒ)
    // ë¬´ë¦ì´ ê³ ê´€ì ˆ-ë°œëª© ì„ ì˜ ì•ìª½ì— ìˆìœ¼ë©´ ê³¼êµ´ê³¡ (ê°ë„ ê°ì†Œ, 179Â° ì´í•˜)
    // ì¼ì§ì„ ì¼ ë•Œ 180Â°ê°€ ë˜ë„ë¡ ì¡°ì •
    let ka;
    const threshold = 0.1; // ì¼ì§ì„  íŒë‹¨ ì„ê³„ê°’
    if (Math.abs(crossProduct) < threshold) {
      // ê±°ì˜ ì¼ì§ì„ 
      ka = 180.0;
    } else {
      // ë‚´ë¶€ ê°ë„ì—ì„œ 180ë„ê¹Œì§€ì˜ í¸ì°¨ ê³„ì‚°
      const deviation = 180 - internalAngle;
      
      if (crossProduct > 0) {
        // ë¬´ë¦ì´ ë’¤ìª½ = ê³¼ì‹ ì „ = ê°ë„ ì¦ê°€ (181Â° ì´ìƒ)
        ka = 180 + Math.abs(deviation);
      } else {
        // ë¬´ë¦ì´ ì•ìª½ = ê³¼êµ´ê³¡ = ê°ë„ ê°ì†Œ (179Â° ì´í•˜)
        ka = 180 - Math.abs(deviation);
      }
    }
    
    result.KA = {
      value: ka,
      status: classifyRange({
        v: ka,
        nMin: 175, nMax: 185,
        mildMin: 172, mildMax: 174,
        modMin: 168, modMax: 171,
        sevMin: null, sevMax: null,
        higherIsWorse: false
      }),
      unit: "Â°",
      desc: "Knee Alignment Angle"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.KA.value_deg = ka;
    result.KA.meaning = result.KA.desc;
  }
  
  // 8ï¸âƒ£ Tibial_Angle (Tibial Inclination): vertical signed (ìœ—ì =Knee)
  if (knee && ankle) {
    const tba = angleFromVerticalSignedDeg(knee, ankle);
    // ìŠ¤í™: 85-90ë„ê°€ ì •ìƒì´ë¯€ë¡œ, ìˆ˜ì§ì„ ì—ì„œ ë²—ì–´ë‚œ ê°ë„ë¥¼ ê³„ì‚°
    const tbaValue = Math.abs(tba);
    result.Tibial_Angle = {
      value: tbaValue,
      status: classifyRange({
        v: tbaValue,
        nMin: 0, nMax: 5,
        mildMin: 5, mildMax: 8,
        modMin: 8, modMax: 12,
        sevMin: 12, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Tibial Inclination"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.Tibial_Angle.value_deg = tbaValue;
    result.Tibial_Angle.meaning = result.Tibial_Angle.desc;
    result.Tibial_Inclination = result.Tibial_Angle;
  }
  
  // 9ï¸âƒ£ GSB (Global Sagittal Balance): tragusâ€“ankle xì¢Œí‘œ ì°¨ì´
  if (tragus && ankle) {
    const gsbPx = Math.abs(tragus.x - ankle.x);
    const gsb = pxToCm(gsbPx, pxPerCm);
    result.GSB = {
      value: gsb,
      status: classifyRange({
        v: gsb,
        nMin: 0, nMax: 2,
        mildMin: 2, mildMax: 4,
        modMin: 4, modMax: 6,
        sevMin: 6, sevMax: null,
        higherIsWorse: true
      }),
      unit: "cm",
      desc: "Global Sagittal Balance"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.GSB.value_cm = gsb;
    result.GSB.meaning = result.GSB.desc;
  }
  
  // 1ï¸âƒ£2ï¸âƒ£ HPA (Headâ€“Pelvis Angle): vertical signed (ìœ—ì =Tragus, ì•„ë«ì =PSIS)
  if (tragus && PSIS) {
    const hpa = angleFromVerticalSignedDeg(tragus, PSIS);
    result.HPA = {
      value: Math.abs(hpa),
      value_signed: hpa, // ë¶€í˜¸ í¬í•¨ ê°’
      status: classifyRange({
        v: Math.abs(hpa),
        nMin: 0, nMax: 5,
        mildMin: 5, mildMax: 10,
        modMin: 10, modMax: 15,
        sevMin: 15, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Headâ€“Pelvis Angle"
    };
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.HPA.value_deg = hpa;
    result.HPA.meaning = result.HPA.desc;
  }
  
  // Q-Angle, Knee_Deviation, LLDëŠ” ì •ë©´ ë¶„ì„ì—ì„œë§Œ ì¸¡ì • (ì¸¡ë©´ ë¶„ì„ì—ì„œëŠ” ì œê±°)
  // ì´ í•­ëª©ë“¤ì€ ì •ë©´ ë¶„ì„ í•¨ìˆ˜(analyzePostureFront)ì—ì„œë§Œ ê³„ì‚°ë¨
  
  // 1ï¸âƒ£6ï¸âƒ£ PDS (Postural Deviation Score): ëª¨ë“  ì§€í‘œ í•©ì‚°ì§€ìˆ˜
  let pdsScore = 0;
  const statusMap = { "normal": 0, "mild": 1, "moderate": 2, "severe": 3, "abnormal": 2, "neutral": 0, "kyphotic": 2, "flat": 2 };
  Object.keys(result).forEach(key => {
    if (key !== "PDS" && result[key] && result[key].status) {
      pdsScore += statusMap[result[key].status] || 0;
    }
  });
  
  result.PDS = {
    value: pdsScore,
    status: pdsScore <= 10 ? "normal" : pdsScore <= 15 ? "mild" : "moderate",
    unit: "score",
    desc: "Postural Deviation Score (0â€“10: normal, 10â†‘: ë¶ˆê· í˜•)"
  };
  // í•˜ìœ„ í˜¸í™˜ì„±
  result.PDS.meaning = result.PDS.desc;
  
  return result;
}

// âœ… ì •ë©´ ìì„¸ ë¶„ì„
function analyzeFrontPosture(points, pxPerCm = 50.0) {
  // ì•ˆì „ ì ‘ê·¼ í—¬í¼
  function p(k) {
    const v = points[k];
    if (!v || v.x == null || v.y == null) return null;
    return { x: Number(v.x), y: Number(v.y) };
  }
  
  const result = {};
  
  const L_acr = p("L_acromion") || p("L_Shoulder");
  const R_acr = p("R_acromion") || p("R_Shoulder");
  const L_asis = p("L_asis") || p("L_ASIS");
  const R_asis = p("R_asis") || p("R_ASIS");
  // Flutter 1:1 ë§¤ì¹­ í‚¤ (ì†Œë¬¸ì ìš°ì„ )
  const C7 = p("c7") || p("C7");
  const L_ankle = p("L_ankle");
  const R_ankle = p("R_ankle");
  
  // ìŠ¤í™ ê¸°ë°˜: ì •ë©´ ì§€í‘œ ì¶”ê°€ (TypeScript spec v1.0)
  
  // 1ï¸âƒ£ STA_F (Shoulder Tilt Angle): ì–´ê¹¨ ì¢Œìš° ê¸°ìš¸ê¸°
  // 0Â° = ìˆ˜í‰, +ê°ë„ = ì˜¤ë¥¸ìª½ ì–´ê¹¨ê°€ ë†’ì„ ë•Œ, -ê°ë„ = ì™¼ìª½ ì–´ê¹¨ê°€ ë†’ì„ ë•Œ
  if (L_acr && R_acr) {
    const verticalDiff = L_acr.y - R_acr.y; // Lì´ ë†’ìœ¼ë©´ ì–‘ìˆ˜, Rì´ ë†’ìœ¼ë©´ ìŒìˆ˜
    const horizontalDist = Math.abs(L_acr.x - R_acr.x);
    // ìˆ˜í‰ì„  ê¸°ì¤€ ê°ë„: atan2(verticalDiff, horizontalDist)
    // verticalDiff > 0 (Lì´ ë†’ìŒ) â†’ ìŒìˆ˜ ê°ë„
    // verticalDiff < 0 (Rì´ ë†’ìŒ) â†’ ì–‘ìˆ˜ ê°ë„
    const sta = horizontalDist > 0 ? rad2deg(Math.atan2(-verticalDiff, horizontalDist)) : 0;
    
    result.STA_F = {
      value: Math.abs(sta), // í‘œì‹œëŠ” ì ˆëŒ€ê°’
      value_signed: sta, // ë¶€í˜¸ í¬í•¨ ê°’ (ë‚´ë¶€ ì‚¬ìš©)
      status: classifyRange({
        v: Math.abs(sta),
        nMin: 0, nMax: 3,
        mildMin: 3, mildMax: 6,
        modMin: 6, modMax: 10,
        sevMin: 10, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Shoulder Tilt Angle (ì–´ê¹¨ ì¢Œìš° ê¸°ìš¸ê¸°)"
    };
    result.STA_F.value_deg = Math.abs(sta);
    result.STA_F.meaning = result.STA_F.desc;
    
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.Shoulder_Tilt = result.STA_F;
  }
  
  // 2ï¸âƒ£ POA_F (Pelvic Obliquity Angle): ê³¨ë°˜ ì¢Œìš° ê¸°ìš¸ê¸°
  // 0Â° = ìˆ˜í‰, +ê°ë„ = ì˜¤ë¥¸ìª½ ASISê°€ ë†’ì„ ë•Œ, -ê°ë„ = ì™¼ìª½ ASISê°€ ë†’ì„ ë•Œ
  if (L_asis && R_asis) {
    const verticalDiff = L_asis.y - R_asis.y; // Lì´ ë†’ìœ¼ë©´ ì–‘ìˆ˜, Rì´ ë†’ìœ¼ë©´ ìŒìˆ˜
    const horizontalDist = Math.abs(L_asis.x - R_asis.x);
    // ìˆ˜í‰ì„  ê¸°ì¤€ ê°ë„: atan2(verticalDiff, horizontalDist)
    // verticalDiff > 0 (Lì´ ë†’ìŒ) â†’ ìŒìˆ˜ ê°ë„
    // verticalDiff < 0 (Rì´ ë†’ìŒ) â†’ ì–‘ìˆ˜ ê°ë„
    const poa = horizontalDist > 0 ? rad2deg(Math.atan2(-verticalDiff, horizontalDist)) : 0;
    
    result.POA_F = {
      value: Math.abs(poa), // í‘œì‹œëŠ” ì ˆëŒ€ê°’
      value_signed: poa, // ë¶€í˜¸ í¬í•¨ ê°’ (ë‚´ë¶€ ì‚¬ìš©)
      status: classifyRange({
        v: Math.abs(poa),
        nMin: 0, nMax: 3,
        mildMin: 3, mildMax: 6,
        modMin: 6, modMax: 10,
        sevMin: 10, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Pelvic Obliquity Angle (ê³¨ë°˜ ì¢Œìš° ê¸°ìš¸ê¸°)"
    };
    result.POA_F.value_deg = Math.abs(poa);
    result.POA_F.meaning = result.POA_F.desc;
    
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.POA = result.POA_F;
    result.Pelvic_Obliquity = result.POA_F;
    
    // PRA (Pelvic Rotation): ì¢Œìš° ASIS ê°„ xì¢Œí‘œ ì°¨ì´ (ìŠ¤í™ì—ëŠ” ì—†ì§€ë§Œ ìœ ì§€)
    const pra = pxToCm(Math.abs(R_asis.x - L_asis.x), pxPerCm);
    result.PRA = {
      value: pra,
      value_cm: pra,
      status: pra <= 1 ? "normal" : pra <= 2 ? "mild" : pra <= 3 ? "moderate" : "severe",
      unit: "cm",
      meaning: "Pelvic Rotation (ê³¨ë°˜ ì¢Œìš° ë¹„í‹€ë¦¼)"
    };
  }
  
  // 3ï¸âƒ£ LLD_F (Leg Length Discrepancy): ë‹¤ë¦¬ ê¸¸ì´ ì°¨ì´
  if (L_asis && L_ankle && R_asis && R_ankle) {
    const lLen = dist(L_asis, L_ankle);
    const rLen = dist(R_asis, R_ankle);
    const lld = pxToCm(Math.abs(lLen - rLen), pxPerCm);
    
    result.LLD_F = {
      value: lld,
      status: classifyRange({
        v: lld,
        nMin: 0, nMax: 1,
        mildMin: 1, mildMax: 2,
        modMin: 2, modMax: 3,
        sevMin: 3, sevMax: null,
        higherIsWorse: true
      }),
      unit: "cm",
      desc: "Leg Length Discrepancy (í•˜ì§€ ê¸¸ì´ ì°¨)"
    };
    result.LLD_F.value_cm = lld;
    result.LLD_F.meaning = result.LLD_F.desc;
    
    // í•˜ìœ„ í˜¸í™˜ì„±
    result.LLD = result.LLD_F;
    if (L_ankle && R_ankle) {
      const diffPx = Math.abs(L_ankle.y - R_ankle.y);
      const diffCm = pxToCm(diffPx, pxPerCm);
      result.Leg_Length_Diff = {
        value_cm: diffCm,
        status: diffCm <= 1 ? "normal" : diffCm <= 2 ? "mild" : diffCm <= 3 ? "moderate" : "severe",
        meaning: "ë‹¤ë¦¬ ê¸¸ì´ ì°¨ì´ (1cm ì´í•˜ ì •ìƒ)",
      };
    }
  }
  
  // 4ï¸âƒ£ TD (Trunk Deviation): ì²´ê°„ ì¢Œìš° í¸ìœ„
  // 0Â° = C7ì´ midline ìœ„ì—, +ê°ë„ = ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™, -ê°ë„ = ì™¼ìª½ìœ¼ë¡œ ì´ë™
  if (C7 && L_ankle && R_ankle) {
    // ì¤‘ê°„ì„ : ì¢Œìš° ë°œëª© ì¤‘ì 
    const midlineX = (L_ankle.x + R_ankle.x) / 2;
    const midlineY = (L_ankle.y + R_ankle.y) / 2;
    
    // C7ì—ì„œ ì¤‘ê°„ì„ ê¹Œì§€ì˜ ìˆ˜í‰ ê±°ë¦¬ (ì˜¤ë¥¸ìª½ì´ë©´ ì–‘ìˆ˜, ì™¼ìª½ì´ë©´ ìŒìˆ˜)
    const horizontalDeviation = C7.x - midlineX;
    const verticalDist = Math.abs(C7.y - midlineY);
    // ìˆ˜ì§ì„  ê¸°ì¤€ ê°ë„: atan2(horizontalDeviation, verticalDist)
    // horizontalDeviation > 0 (ì˜¤ë¥¸ìª½) â†’ ì–‘ìˆ˜ ê°ë„
    // horizontalDeviation < 0 (ì™¼ìª½) â†’ ìŒìˆ˜ ê°ë„
    const td = verticalDist > 0 ? rad2deg(Math.atan2(horizontalDeviation, verticalDist)) : 0;
    
    result.TD = {
      value: Math.abs(td), // í‘œì‹œëŠ” ì ˆëŒ€ê°’
      value_signed: td, // ë¶€í˜¸ í¬í•¨ ê°’ (ë‚´ë¶€ ì‚¬ìš©)
      status: classifyRange({
        v: Math.abs(td),
        nMin: 0, nMax: 2,
        mildMin: 2, mildMax: 5,
        modMin: 5, mildMax: 8,
        sevMin: 8, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Trunk Deviation (ì²´ê°„ ì¢Œìš° í¸ìœ„)"
    };
    result.TD.value_deg = Math.abs(td);
    result.TD.meaning = result.TD.desc;
    
    // í•˜ìœ„ í˜¸í™˜ì„±
    if (L_asis && R_asis) {
    const pelvisMid = {
      x: (L_asis.x + R_asis.x) / 2,
      y: (L_asis.y + R_asis.y) / 2
    };
    const dx = C7.x - pelvisMid.x;
    const dy = C7.y - pelvisMid.y;
      const angle = rad2deg(Math.atan2(Math.abs(dx), Math.abs(dy)));
    result.Trunk_Lateral_Tilt = {
      value_deg: angle,
        status: angle <= 2 ? "normal" : angle <= 5 ? "mild" : angle <= 8 ? "moderate" : "severe",
      meaning: "ì²´ê°„ì˜ ì¢Œìš° ê¸°ìš¸ê¸°",
    };
    }
  }
  
  // 5ï¸âƒ£ HTA (Head Tilt Angle): ë¨¸ë¦¬ ì¢Œìš° ê¸°ìš¸ê¸°
  // 0Â° = ìˆ˜í‰, +ê°ë„ = ì˜¤ë¥¸ìª½ Tragusê°€ ë†’ì„ ë•Œ, -ê°ë„ = ì™¼ìª½ Tragusê°€ ë†’ì„ ë•Œ
  const L_tragus = p("L_tragus");
  const R_tragus = p("R_tragus");
  if (L_tragus && R_tragus) {
    const verticalDiff = L_tragus.y - R_tragus.y; // Lì´ ë†’ìœ¼ë©´ ì–‘ìˆ˜, Rì´ ë†’ìœ¼ë©´ ìŒìˆ˜
    const horizontalDist = Math.abs(L_tragus.x - R_tragus.x);
    // ìˆ˜í‰ì„  ê¸°ì¤€ ê°ë„: atan2(verticalDiff, horizontalDist)
    // verticalDiff > 0 (Lì´ ë†’ìŒ) â†’ ìŒìˆ˜ ê°ë„
    // verticalDiff < 0 (Rì´ ë†’ìŒ) â†’ ì–‘ìˆ˜ ê°ë„
    const hta = horizontalDist > 0 ? rad2deg(Math.atan2(-verticalDiff, horizontalDist)) : 0;
    
    result.HTA = {
      value: Math.abs(hta), // í‘œì‹œëŠ” ì ˆëŒ€ê°’
      value_signed: hta, // ë¶€í˜¸ í¬í•¨ ê°’ (ë‚´ë¶€ ì‚¬ìš©)
      status: classifyRange({
        v: Math.abs(hta),
        nMin: 0, nMax: 3,
        mildMin: 3, mildMax: 6,
        modMin: 6, modMax: 10,
        sevMin: 10, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Head Tilt Angle (ë¨¸ë¦¬ ì¢Œìš° ê¸°ìš¸ê¸°)"
    };
    result.HTA.value_deg = Math.abs(hta);
    result.HTA.meaning = result.HTA.desc;
  }
  
  // 6ï¸âƒ£ SPP (Shoulderâ€“Pelvis Parallelism): ì–´ê¹¨-ê³¨ë°˜ í‰í–‰ë„
  if (L_acr && R_acr && L_asis && R_asis) {
    // ì–´ê¹¨ì„  ê°ë„
    const shoulderDx = R_acr.x - L_acr.x;
    const shoulderDy = R_acr.y - L_acr.y;
    const shoulderAngle = rad2deg(Math.atan2(shoulderDy, shoulderDx));
    
    // ê³¨ë°˜ì„  ê°ë„
    const pelvisDx = R_asis.x - L_asis.x;
    const pelvisDy = R_asis.y - L_asis.y;
    const pelvisAngle = rad2deg(Math.atan2(pelvisDy, pelvisDx));
    
    // ê°ë„ ì°¨ì´
    let angleDiff = Math.abs(shoulderAngle - pelvisAngle);
    if (angleDiff > 90) angleDiff = 180 - angleDiff; // 0-90ë„ ë²”ìœ„ë¡œ ì •ê·œí™”
    
    result.SPP = {
      value: angleDiff,
      status: classifyRange({
        v: angleDiff,
        nMin: 0, nMax: 3,
        mildMin: 3, mildMax: 6,
        modMin: 6, modMax: 10,
        sevMin: 10, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Shoulderâ€“Pelvis Parallelism (ì–´ê¹¨-ê³¨ë°˜ í‰í–‰ë„)"
    };
    result.SPP.value_deg = angleDiff;
    result.SPP.meaning = result.SPP.desc;
  }
  
  // 6ï¸âƒ£ Knee Deviation (Front): ì¢Œìš° knee ë†’ì´ ì°¨ì´
  const L_knee = p("L_knee") || p("L_Knee");
  const R_knee = p("R_knee") || p("R_Knee");
  if (L_knee && R_knee) {
    const diffPx = Math.abs(L_knee.y - R_knee.y);
    const diffCm = pxToCm(diffPx, pxPerCm);
    const angle = rad2deg(Math.atan2(diffPx, Math.abs(L_knee.x - R_knee.x) || 1));
    result.Knee_Deviation = {
      value_deg: angle,
      status: classifyRange({
        v: angle,
        nMin: null, nMax: 3,
        mildMin: 3, mildMax: 6,
        modMin: 6, modMax: 10,
        sevMin: 10, sevMax: null,
        higherIsWorse: true
      }),
      meaning: "ë¬´ë¦ ë†’ì´ ì°¨ì´ (â‰¤3Â° ì •ìƒ)"
    };
  }
  
  // 7ï¸âƒ£ Q-Angle: ASIS â†’ KNEE â†’ tibial tuberosity
  // (ì •ë©´ì—ì„œë§Œ ì¸¡ì • ê°€ëŠ¥, ASIS-KNEE-Tibial tub ì„¸ ì  ì‚¬ìš©)
  // Q-Angleì€ ASISì—ì„œ ë¬´ë¦ì„ ê±°ì³ ê²½ê³¨ ê²°ì ˆê¹Œì§€ì˜ ê°ë„ (ì •ìƒ 10-20Â°)
  const L_tibial_tub = p("L_tibial_tub") || p("L_Tibial_Tub");
  const R_tibial_tub = p("R_tibial_tub") || p("R_Tibial_Tub");
  
  // ì¢Œì¸¡ Q-Angle ê³„ì‚°: ASIS â†’ KNEE â†’ Tibial tub
  if (L_asis && L_knee && L_tibial_tub) {
    // Q-Angle: ASIS â†’ KNEE â†’ tibial tuberosity ê°ë„
    // angleAt(vertex, point1, point2)ëŠ” vertexì—ì„œ point1ê³¼ point2 ì‚¬ì´ì˜ ê°ë„ë¥¼ ê³„ì‚°
    let qAngleL = angleAt(L_knee, L_asis, L_tibial_tub);
    
    // ê°ë„ê°€ 90ë„ë³´ë‹¤ í¬ë©´ ë³´ì™„ê°ì„ ì‚¬ìš© (Q-Angleì€ ë³´í†µ ì˜ˆê°)
    if (qAngleL > 90) {
      qAngleL = 180 - qAngleL;
    }
    
    // ê°ë„ê°€ ì—¬ì „íˆ ë¹„ì •ìƒì ìœ¼ë¡œ í¬ë©´ (ì˜ˆ: 170ë„ ì´ìƒ), ì ë“¤ì˜ ìˆœì„œê°€ ì˜ëª»ë˜ì—ˆì„ ìˆ˜ ìˆìŒ
    // ASISê°€ ë¬´ë¦ë³´ë‹¤ ìœ„ì— ìˆì–´ì•¼ í•˜ë¯€ë¡œ y ì¢Œí‘œ í™•ì¸
    if (qAngleL > 90 && L_asis.y < L_knee.y && L_knee.y < L_tibial_tub.y) {
      // ì ë“¤ì´ ê±°ì˜ ì¼ì§ì„ ì— ìˆìœ¼ë©´ ê°ë„ë¥¼ ì¬ê³„ì‚°
      const dx1 = L_asis.x - L_knee.x;
      const dy1 = L_asis.y - L_knee.y;
      const dx2 = L_tibial_tub.x - L_knee.x;
      const dy2 = L_tibial_tub.y - L_knee.y;
      const angle1 = Math.atan2(dy1, dx1) * 180 / Math.PI;
      const angle2 = Math.atan2(dy2, dx2) * 180 / Math.PI;
      qAngleL = Math.abs(angle1 - angle2);
      if (qAngleL > 90) qAngleL = 180 - qAngleL;
    }
    
    result.Q_Angle_L = {
      value: qAngleL,
      value_deg: qAngleL,
      status: classifyRange({
        v: qAngleL,
        nMin: 10, nMax: 20, // ì¼ë°˜ì ìœ¼ë¡œ ì—¬ì„±ì´ ë” í¼
        mildMin: 20, mildMax: 25,
        modMin: 25, modMax: 30,
        sevMin: 30, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Q-Angle Left (ì¢Œì¸¡ ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)",
      meaning: "ì¢Œì¸¡ Q-Angle (10â€“20Â° ì •ìƒ, ì—¬ì„±ì´ ë” í¼)"
    };
  }
  
  // ìš°ì¸¡ Q-Angle ê³„ì‚°: ASIS â†’ KNEE â†’ Tibial tub
  if (R_asis && R_knee && R_tibial_tub) {
    let qAngleR = angleAt(R_knee, R_asis, R_tibial_tub);
    
    // ê°ë„ê°€ 90ë„ë³´ë‹¤ í¬ë©´ ë³´ì™„ê°ì„ ì‚¬ìš©
    if (qAngleR > 90) {
      qAngleR = 180 - qAngleR;
    }
    
    // ê°ë„ê°€ ì—¬ì „íˆ ë¹„ì •ìƒì ìœ¼ë¡œ í¬ë©´ ì¬ê³„ì‚°
    if (qAngleR > 90 && R_asis.y < R_knee.y && R_knee.y < R_tibial_tub.y) {
      const dx1 = R_asis.x - R_knee.x;
      const dy1 = R_asis.y - R_knee.y;
      const dx2 = R_tibial_tub.x - R_knee.x;
      const dy2 = R_tibial_tub.y - R_knee.y;
      const angle1 = Math.atan2(dy1, dx1) * 180 / Math.PI;
      const angle2 = Math.atan2(dy2, dx2) * 180 / Math.PI;
      qAngleR = Math.abs(angle1 - angle2);
      if (qAngleR > 90) qAngleR = 180 - qAngleR;
    }
    
    result.Q_Angle_R = {
      value: qAngleR,
      value_deg: qAngleR,
      status: classifyRange({
        v: qAngleR,
        nMin: 10, nMax: 20,
        mildMin: 20, mildMax: 25,
        modMin: 25, modMax: 30,
        sevMin: 30, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Q-Angle Right (ìš°ì¸¡ ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)",
      meaning: "ìš°ì¸¡ Q-Angle (10â€“20Â° ì •ìƒ, ì—¬ì„±ì´ ë” í¼)"
    };
  }
  
  // í‰ê·  Q-Angle (ì¢Œìš° ëª¨ë‘ ìˆì„ ë•Œ)
  if (result.Q_Angle_L && result.Q_Angle_R) {
    const avgQAngle = (result.Q_Angle_L.value + result.Q_Angle_R.value) / 2;
    result.Q_Angle = {
      value: avgQAngle,
      value_deg: avgQAngle,
      status: classifyRange({
        v: avgQAngle,
        nMin: 10, nMax: 20,
        mildMin: 20, mildMax: 25,
        modMin: 25, modMax: 30,
        sevMin: 30, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Q-Angle (ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)",
      meaning: "Q-Angle í‰ê·  (10â€“20Â° ì •ìƒ, ì—¬ì„±ì´ ë” í¼)"
    };
  } else if (result.Q_Angle_L) {
    // ì¢Œì¸¡ë§Œ ìˆì„ ë•Œ
    result.Q_Angle = result.Q_Angle_L;
    result.Q_Angle.desc = "Q-Angle (ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)";
    result.Q_Angle.meaning = "Q-Angle (10â€“20Â° ì •ìƒ, ì—¬ì„±ì´ ë” í¼)";
  } else if (result.Q_Angle_R) {
    // ìš°ì¸¡ë§Œ ìˆì„ ë•Œ
    result.Q_Angle = result.Q_Angle_R;
    result.Q_Angle.desc = "Q-Angle (ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)";
    result.Q_Angle.meaning = "Q-Angle (10â€“20Â° ì •ìƒ, ì—¬ì„±ì´ ë” í¼)";
  }
  
  // í•˜ìœ„ í˜¸í™˜ì„±: tibial_tubê°€ ì—†ì„ ë•Œ ë°œëª©ì„ ì‚¬ìš© (ê¸°ì¡´ ë°©ì‹)
  if (!result.Q_Angle && L_asis && L_knee && L_ankle) {
    const qAngle = angleAt(L_knee, L_asis, L_ankle);
    result.Q_Angle = {
      value: qAngle,
      value_deg: qAngle,
      status: classifyRange({
        v: qAngle,
        nMin: 10, nMax: 20,
        mildMin: 20, mildMax: 25,
        modMin: 25, modMax: 30,
        sevMin: 30, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Q-Angle (ëŒ€í‡´ì‚¬ë‘ê·¼ ê°ë„)",
      meaning: "Q-Angle (10â€“20Â° ì •ìƒ, ì—¬ì„±ì´ ë” í¼)"
    };
  }
  
  // 8ï¸âƒ£ KAS (Knee Alignment Symmetry): ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„±
  if (L_knee && L_ankle && R_knee && R_ankle) {
    // ì¢Œì¸¡ ë¬´ë¦-ë°œëª© ì„ ì˜ ê°ë„
    const L_dx = L_ankle.x - L_knee.x;
    const L_dy = L_ankle.y - L_knee.y;
    const L_angle = rad2deg(Math.atan2(L_dy, L_dx));
    
    // ìš°ì¸¡ ë¬´ë¦-ë°œëª© ì„ ì˜ ê°ë„
    const R_dx = R_ankle.x - R_knee.x;
    const R_dy = R_ankle.y - R_knee.y;
    const R_angle = rad2deg(Math.atan2(R_dy, R_dx));
    
    // ê°ë„ ì°¨ì´
    let angleDiff = Math.abs(L_angle - R_angle);
    if (angleDiff > 90) angleDiff = 180 - angleDiff; // 0-90ë„ ë²”ìœ„ë¡œ ì •ê·œí™”
    
    result.KAS = {
      value: angleDiff,
      value_deg: angleDiff,
      status: classifyRange({
        v: angleDiff,
        nMin: 0, nMax: 2,
        mildMin: 2, mildMax: 5,
        modMin: 5, modMax: 8,
        sevMin: 8, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Knee Alignment Symmetry (ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„±)",
      meaning: "ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„± (ëŒ€ì¹­ Â±2Â° ì´ë‚´)"
    };
  }
  
  // 9ï¸âƒ£ LLAS (Lower Limb Axis Symmetry): í•˜ì§€ ì¶• ëŒ€ì¹­ì„±
  if (L_asis && L_ankle && R_asis && R_ankle) {
    // ì¢Œì¸¡ ASIS-ë°œëª© ì„ ì˜ ê°ë„
    const L_dx = L_ankle.x - L_asis.x;
    const L_dy = L_ankle.y - L_asis.y;
    const L_angle = rad2deg(Math.atan2(L_dy, L_dx));
    
    // ìš°ì¸¡ ASIS-ë°œëª© ì„ ì˜ ê°ë„
    const R_dx = R_ankle.x - R_asis.x;
    const R_dy = R_ankle.y - R_asis.y;
    const R_angle = rad2deg(Math.atan2(R_dy, R_dx));
    
    // ê°ë„ ì°¨ì´
    let angleDiff = Math.abs(L_angle - R_angle);
    if (angleDiff > 90) angleDiff = 180 - angleDiff; // 0-90ë„ ë²”ìœ„ë¡œ ì •ê·œí™”
    
    result.LLAS = {
      value: angleDiff,
      value_deg: angleDiff,
      status: classifyRange({
        v: angleDiff,
        nMin: 0, nMax: 2,
        mildMin: 2, mildMax: 5,
        modMin: 5, modMax: 8,
        sevMin: 8, sevMax: null,
        higherIsWorse: true
      }),
      unit: "Â°",
      desc: "Lower Limb Axis Symmetry (í•˜ì§€ ì¶• ëŒ€ì¹­ì„±)",
      meaning: "í•˜ì§€ ì¶• ëŒ€ì¹­ì„± (Â±2Â° ì´ë‚´)"
    };
  }
  
  return result;
}

// âœ… ë¶„ì„ ê²°ê³¼ ìš”ì•½ HTML ìƒì„± (ê°œì„  ë²„ì „: Before-After ë¹„êµ ì§€ì›)
function buildAnalysisSummaryHtml(analysisResult, metrics = null, rules = null) {
  // Before-After ë¹„êµê°€ ê°€ëŠ¥í•œ ê²½ìš° (metricsì™€ rules ì œê³µ ì‹œ)
  if(metrics && rules) {
    const chunks = [];
    Object.keys(metrics).forEach(k => {
      const m = metrics[k];
      const rule = rules[k];
      if (!rule || m.before == null || m.after == null) return;
      const delta = m.after - m.before;
      const res = rule.analyze ? rule.analyze(m.before, m.after, delta) : null;
      if (!res) return;
      const icon = res.status === 'improved' ? 'âœ…' : res.status === 'worsened' ? 'âš ï¸' : 'â–';
      chunks.push(
        `<div style="margin-bottom:8px; padding:8px; background:#f9f9f9; border-radius:4px;">` +
        `<strong>${icon} ${rule.name}</strong>: ${m.before}${rule.unit} â†’ ${m.after}${rule.unit} (Î” ${delta.toFixed(1)}${rule.unit})<br>` +
        `<span style="font-size:10px; color:#666;">${res.comment}</span></div>`
      );
    });
    return chunks.length > 0 ? chunks.join('') : '<div>ë¹„êµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
  }
  
  // ê¸°ì¡´ ë°©ì‹ (analysisResult ì‚¬ìš©)
  const side = analysisResult?.side || {};
  const front = analysisResult?.front || {};
  const summary = analysisResult?.summary || {};
  
  let html = '<div style="margin-bottom:20px; padding:15px; background:#f5f5f5; border-radius:8px; box-sizing:border-box; overflow:hidden; word-wrap:break-word;">';
  
  // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼
  if(side.status !== "not_available") {
    html += '<div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#0b0f14;">ì¸¡ë©´ ë¶„ì„ ê²°ê³¼</div>';
    for(const [key, value] of Object.entries(side)) {
      if(value && typeof value === 'object' && value.value != null && key !== 'status') {
        const unit = value.value_cm != null ? 'cm' : 'Â°';
        const val = value.value_deg != null ? value.value_deg : (value.value_cm != null ? value.value_cm : value.value);
        const status = value.status || 'unknown';
        if(val != null && typeof val === 'number') {
          html += `<div style="font-size:12px; margin-bottom:4px; line-height:1.5; word-wrap:break-word;">${key}: ${val.toFixed(2)}${unit} (${status})</div>`;
        }
      }
    }
    html += '<div style="margin-bottom:12px;"></div>';
  }
  
  // ì •ë©´ ë¶„ì„ ê²°ê³¼
  if(front.status !== "not_available") {
    html += '<div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#0b0f14;">ì •ë©´ ë¶„ì„ ê²°ê³¼</div>';
    for(const [key, value] of Object.entries(front)) {
      if(value && typeof value === 'object' && value.value != null && key !== 'status') {
        const unit = value.value_cm != null ? 'cm' : 'Â°';
        const val = value.value_deg != null ? value.value_deg : (value.value_cm != null ? value.value_cm : value.value);
        const status = value.status || 'unknown';
        if(val != null && typeof val === 'number') {
          html += `<div style="font-size:12px; margin-bottom:4px; line-height:1.5; word-wrap:break-word;">${key}: ${val.toFixed(2)}${unit} (${status})</div>`;
        }
      }
    }
    html += '<div style="margin-bottom:12px;"></div>';
  }
  
  // ì¢…í•© ì ìˆ˜
  html += '<div style="border-top:1px solid #ddd; padding-top:12px; margin-top:12px;"></div>';
  if(summary.PDS_total != null) {
    html += `<div style="font-size:12px; font-weight:600; color:#6b46c1; word-wrap:break-word;">PDS ì¢…í•©ì ìˆ˜: ${summary.PDS_total} (${summary.risk_level})</div>`;
  } else {
    html += '<div style="font-size:12px; color:#666; word-wrap:break-word;">ì¢…í•©ë¶„ì„: í•´ë‹¹ì—†ìŒ</div>';
  }
  
  html += '</div>';
  return html;
}

// ì´ë¯¸ì§€ base64 ë³€í™˜ê¸° (CORS ì•ˆì „)
async function toDataUrl(url) {
  try {
    // ì´ë¯¸ base64ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
    if(url.startsWith('data:')) {
      return url;
    }
    
    // Blob URLì¸ ê²½ìš°
    if(url.startsWith('blob:')) {
      const res = await fetch(url);
      const blob = await res.blob();
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }
    
    // ì¼ë°˜ URLì¸ ê²½ìš° (CORS í—ˆìš© í•„ìš”)
    const res = await fetch(url, { mode: 'cors' });
    const blob = await res.blob();
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  } catch(err) {
    console.warn('ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨, ì›ë³¸ URL ë°˜í™˜:', err);
    return url; // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
  }
}

// âœ… ìš´ë™ ì¶”ì²œ HTML ìƒì„± í•¨ìˆ˜
function buildExerciseRecommendationHtml(analysisResult) {
  const analysis = analysisResult.analysis || {};
  let html = '';
  
  // í•„ë¼í…ŒìŠ¤ ì¶”ì²œ HTML ìƒì„±
  let pilatesHTML = '';
  if(analysis.pilates && Array.isArray(analysis.pilates) && analysis.pilates.length > 0) {
    pilatesHTML = analysis.pilates.map((item, idx) => renderPilatesItemCard(item, { context:'ui', index: idx })).join('');
  }
  
  // ìš´ë™ ì¶”ì²œ HTML ìƒì„±
  let exercisesHTML = '';
  if(analysis.exercises && Array.isArray(analysis.exercises) && analysis.exercises.length > 0) {
    exercisesHTML = analysis.exercises.filter(ex => ex != null).map(ex => `<div style="margin-bottom:8px; font-size:12px;">${ex}</div>`).join("");
  }
  
  // ì „ì²´ HTML ì¡°í•©
  if(pilatesHTML) {
    html += `<div style="margin-top:20px; padding:18px; background:#f3e5f5; border-radius:10px; border-left:4px solid #9c88ff; box-sizing:border-box; overflow:hidden;">
      <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#9c88ff; line-height:1.4; word-wrap:break-word;">ğŸ§˜ í•„ë¼í…ŒìŠ¤ ì„¸ì…˜ ì¶”ì²œ</div>
      ${pilatesHTML}
    </div>`;
  }
  
  if(exercisesHTML) {
    html += `<div style="margin-top:20px; padding:18px; background:#e0f2f1; border-radius:10px; border-left:4px solid #2ec4b6; box-sizing:border-box; overflow:hidden;">
      <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#2ec4b6; line-height:1.4; word-wrap:break-word;">ğŸ‹ï¸ ì¶”ì²œ ìš´ë™</div>
      <div style="font-size:12px; line-height:1.8; word-wrap:break-word; overflow-wrap:break-word;">${exercisesHTML}</div>
    </div>`;
  }
  
  return html;
}

// âœ… Before-After ë¹„êµ ë¶„ì„ í•¨ìˆ˜
function analyzeBeforeAfterComparison() {
  const B = sessions.Before;
  const A = sessions.After;
  
  if(!B || !A || !B.metrics || !A.metrics) {
    return null;
  }
  
  const bMetrics = B.metrics?.fullMetrics || {};
  const aMetrics = A.metrics?.fullMetrics || {};
  
  // í—¬í¼ í•¨ìˆ˜: ë©”íŠ¸ë¦­ ê°’ ê°€ì ¸ì˜¤ê¸° (í‚¤ ë³„ì¹­ í¬í•¨)
  const getMetricValue = (metrics, key) => {
    // ì›ë³¸ í‚¤ í™•ì¸
    let metric = metrics[key];
    
    // í‚¤ ë³„ì¹­ í™•ì¸ (ì •ë©´ ì§€í‘œ)
    if (!metric) {
      if (key === 'STA' && metrics['STA_F']) metric = metrics['STA_F'];
      else if (key === 'POA' && metrics['POA_F']) metric = metrics['POA_F'];
      else if (key === 'LLD' && metrics['LLD_F']) metric = metrics['LLD_F'];
      else if (key === 'Q_Angle' && metrics['QAngle']) metric = metrics['QAngle'];
      else if (key === 'Knee_Deviation' && metrics['KneeDev']) metric = metrics['KneeDev'];
      else if (key === 'Tibial_Angle' && metrics['Tibial']) metric = metrics['Tibial'];
    }
    
    if(!metric) return null;
    return metric.value !== undefined ? metric.value : 
           (metric.value_deg !== undefined ? metric.value_deg : 
           (metric.value_cm !== undefined ? metric.value_cm : null));
  };
  
  // ì§€í‘œë³„ ë¶„ì„ ê·œì¹™
  const metricRules = {
    'CVA': {
      name: 'CVA(ë‘ê°œê²½ì¶”ê°)',
      unit: 'Â°',
      normal: 'â‰¥50Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        if(delta > 5) return { status: 'improved', comment: `CVAê°€ ${delta.toFixed(1)}Â° ì¦ê°€í•˜ì—¬ ê±°ë¶ëª© ìì„¸ê°€ ì •ìƒ ë²”ìœ„ë¡œ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(delta < -5) return { status: 'worsened', comment: `CVAê°€ ${Math.abs(delta).toFixed(1)}Â° ê°ì†Œí•˜ì—¬ ê±°ë¶ëª© ìì„¸ê°€ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `CVAëŠ” ${after.toFixed(1)}Â°ë¡œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'HPD': {
      name: 'HPD(ë‘ë¶€ì „ë°©ì´ë™)',
      unit: 'cm',
      normal: 'â‰¤2cm',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        if(delta < -0.5) return { status: 'improved', comment: `ë‘ë¶€ ì „ë°©ì´ë™ì´ ${Math.abs(delta).toFixed(1)}cm ê°ì†Œí•˜ì—¬ ë‘ë¶€ ì •ë ¬ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(delta > 0.5) return { status: 'worsened', comment: `ë‘ë¶€ ì „ë°©ì´ë™ì´ ${delta.toFixed(1)}cm ì¦ê°€í•˜ì—¬ ê±°ë¶ëª© íŒ¨í„´ì´ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ë‘ë¶€ ì „ë°©ì´ë™ì€ ë³€í™”ê°€ ë¯¸ë¯¸í•˜ì—¬ ì•ˆì •ëœ ë‘ë¶€ ì •ë ¬ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'TIA': {
      name: 'TIA(ì²´ê°„ê²½ì‚¬ê°)',
      unit: 'Â°',
      normal: '0-10Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = after >= 0 && after <= 10;
        if(inRange && Math.abs(delta) < 2) return { status: 'stable', comment: `ì²´ê°„ ì „ë°©ê¸°ìš¸ê¸°ê°€ ì•½ê°„ ë³€í™”í–ˆìœ¼ë‚˜ ì—¬ì „íˆ ì •ìƒë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.` };
        if(delta > 2) return { status: 'worsened', comment: `ì²´ê°„ ì „ë°©ê¸°ìš¸ê¸°ê°€ ${delta.toFixed(1)}Â° ì¦ê°€í•˜ì—¬ ì „ë°© ê¸°ìš¸ê¸°ê°€ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(delta < -2) return { status: 'improved', comment: `ì²´ê°„ ì „ë°©ê¸°ìš¸ê¸°ê°€ ${Math.abs(delta).toFixed(1)}Â° ê°ì†Œí•˜ì—¬ ì²´ê°„ ì •ë ¬ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ì²´ê°„ ê²½ì‚¬ê°ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'SAA': {
      name: 'SAA(ì–´ê¹¨ì „ë°©ê°)',
      unit: 'Â°',
      normal: '0-10Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        if(delta < -2) return { status: 'improved', comment: `ì–´ê¹¨ ì „ë°©ê°ì´ ${Math.abs(delta).toFixed(1)}Â° ê°ì†Œí•˜ì—¬ ë‘¥ê·¼ì–´ê¹¨ íŒ¨í„´ì´ ì™„í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(delta > 2) return { status: 'worsened', comment: `ì–´ê¹¨ ì „ë°©ê°ì´ ${delta.toFixed(1)}Â° ì¦ê°€í•˜ì—¬ ë‘¥ê·¼ì–´ê¹¨ íŒ¨í„´ì´ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ì–´ê¹¨ ì „ë°©ê°ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'PTA': {
      name: 'PTA(ê³¨ë°˜ ì „í›„ê²½ì‚¬ê°)',
      unit: 'Â°',
      normal: '0-15Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = after >= 0 && after <= 15;
        if(inRange && Math.abs(delta) < 2) return { status: 'stable', comment: `ê³¨ë°˜ ì „ë°©ê²½ì‚¬ê°€ ì•½ê°„ ë³€í™”í–ˆìœ¼ë‚˜ ì •ìƒë²”ìœ„ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.` };
        if(delta > 2) return { status: 'worsened', comment: `ê³¨ë°˜ ì „ë°©ê²½ì‚¬ê°€ ${delta.toFixed(1)}Â° ì¦ê°€í•˜ì—¬ ê³¨ë°˜ ê¸°ìš¸ê¸°ê°€ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(delta < -2) return { status: 'improved', comment: `ê³¨ë°˜ ì „ë°©ê²½ì‚¬ê°€ ${Math.abs(delta).toFixed(1)}Â° ê°ì†Œí•˜ì—¬ ê³¨ë°˜ ì •ë ¬ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ê³¨ë°˜ ì „í›„ê²½ì‚¬ê°ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'KA': {
      name: 'KA(ë¬´ë¦ê°)',
      unit: 'Â°',
      normal: '175-185Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = after >= 175 && after <= 185;
        const closerTo180 = Math.abs(after - 180) < Math.abs(before - 180);
        if(inRange && closerTo180) return { status: 'improved', comment: `í•˜ì§€ ì •ë ¬ì´ ë³´ë‹¤ ì§ì„ í™”ë˜ì–´ ê· í˜•ì ì¸ ì •ë ¬ì„ ë³´ì…ë‹ˆë‹¤.` };
        if(inRange && Math.abs(delta) < 3) return { status: 'stable', comment: `ë¬´ë¦ê°ì€ ì •ìƒë²”ìœ„ ë‚´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
        if(!inRange && delta > 0 && after < 180) return { status: 'worsened', comment: `ë¬´ë¦ê°ì´ ${delta.toFixed(1)}Â° ì¦ê°€í•˜ì—¬ ê³¼ì‹ ì „ íŒ¨í„´ì´ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(!inRange && delta < 0 && after > 185) return { status: 'worsened', comment: `ë¬´ë¦ê°ì´ ${Math.abs(delta).toFixed(1)}Â° ê°ì†Œí•˜ì—¬ êµ´ê³¡ íŒ¨í„´ì´ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ë¬´ë¦ê°ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'Tibial_Angle': {
      name: 'Tibial(ê²½ê³¨ê²½ì‚¬ê°)',
      unit: 'Â°',
      normal: '0-10Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = after >= 0 && after <= 10;
        if(inRange && Math.abs(delta) < 2) return { status: 'stable', comment: `í•˜í‡´ì˜ ì „ë°©ê¸°ìš¸ê¸°ê°€ ë³€í™”í–ˆìœ¼ë‚˜ ê¸°ëŠ¥ì ìœ¼ë¡œ ì•ˆì •ì ì¸ ë²”ìœ„ì…ë‹ˆë‹¤.` };
        if(delta > 2) return { status: 'worsened', comment: `ê²½ê³¨ê²½ì‚¬ê°ì´ ${delta.toFixed(1)}Â° ì¦ê°€í•˜ì—¬ í•˜í‡´ ì •ë ¬ì´ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(delta < -2) return { status: 'improved', comment: `ê²½ê³¨ê²½ì‚¬ê°ì´ ${Math.abs(delta).toFixed(1)}Â° ê°ì†Œí•˜ì—¬ í•˜í‡´ ì •ë ¬ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ê²½ê³¨ê²½ì‚¬ê°ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'GSB': {
      name: 'GSB(ì¤‘ë ¥ì¤‘ì‹¬ì„ )',
      unit: 'cm',
      normal: 'â‰¤2cm',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        if(delta < -0.5) return { status: 'improved', comment: `ì²´ì¤‘ ì¤‘ì‹¬ì„  í¸ì°¨ê°€ ${Math.abs(delta).toFixed(1)}cm ì¤„ì–´ë“¤ì–´ ìì„¸ ì•ˆì •ì„±ì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(delta > 0.5) return { status: 'worsened', comment: `ì²´ì¤‘ ì¤‘ì‹¬ì„  í¸ì°¨ê°€ ${delta.toFixed(1)}cm ì¦ê°€í•˜ì—¬ ìì„¸ ë¶ˆì•ˆì •ì„±ì´ ì¦ê°€í–ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ì²´ì¤‘ ì¤‘ì‹¬ì„ ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'HPA': {
      name: 'HPA(ê³ ê´€ì ˆê°)',
      unit: 'Â°',
      normal: '0-10Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        if(delta < -2) return { status: 'improved', comment: `ë¨¸ë¦¬-ê³¨ë°˜ ì •ë ¬ì´ ê°œì„ ë˜ì–´ ì²´ê°„ í˜‘ì‘ì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(delta > 2) return { status: 'worsened', comment: `ë¨¸ë¦¬-ê³¨ë°˜ ì •ë ¬ì´ ì•…í™”ë˜ì–´ ì²´ê°„ í˜‘ì‘ì´ ì €í•˜ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ë¨¸ë¦¬-ê³¨ë°˜ ì •ë ¬ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'PDS': {
      name: 'PDS(ìì„¸ì ìˆ˜)',
      unit: 'ì ',
      normal: 'ì •ìƒ',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        // PDSëŠ” ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ
        if(delta < -2) return { status: 'improved', comment: `ì „ë°˜ì ì¸ ìì„¸ ì ìˆ˜ê°€ ${Math.abs(delta).toFixed(1)}ì  ê°œì„ ë˜ì–´ ìì„¸ í’ˆì§ˆì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(delta > 2) return { status: 'worsened', comment: `ì „ë°˜ì ì¸ ìì„¸ ì ìˆ˜ê°€ ${delta.toFixed(1)}ì  ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ì „ë°˜ì ì¸ ìì„¸ ì ìˆ˜ëŠ” ì¼ì •í•˜ë©°, ì•ˆì •ì ì¸ ìì„¸ íŒ¨í„´ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    // âœ… ì •ë©´ ì§€í‘œ ì¶”ê°€
    'STA': {
      name: 'STA(ì–´ê¹¨ê¸°ìš¸ê¸°ê°)',
      unit: 'Â°',
      normal: 'â‰¤3Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = Math.abs(after) <= 3;
        if(inRange && Math.abs(delta) < 1) return { status: 'stable', comment: `ì–´ê¹¨ ê¸°ìš¸ê¸°ëŠ” ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) < -1) return { status: 'improved', comment: `ì–´ê¹¨ ê¸°ìš¸ê¸°ê°€ ${Math.abs(delta).toFixed(1)}Â° ê°ì†Œí•˜ì—¬ ì–´ê¹¨ ëŒ€ì¹­ì„±ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) > 1) return { status: 'worsened', comment: `ì–´ê¹¨ ê¸°ìš¸ê¸°ê°€ ${Math.abs(delta).toFixed(1)}Â° ì¦ê°€í•˜ì—¬ ì–´ê¹¨ ë¹„ëŒ€ì¹­ì´ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ì–´ê¹¨ ê¸°ìš¸ê¸°ëŠ” ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'POA': {
      name: 'POA(ê³¨ë°˜ê¸°ìš¸ê¸°ê°)',
      unit: 'Â°',
      normal: 'â‰¤3Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = Math.abs(after) <= 3;
        if(inRange && Math.abs(delta) < 1) return { status: 'stable', comment: `ê³¨ë°˜ ê¸°ìš¸ê¸°ëŠ” ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) < -1) return { status: 'improved', comment: `ê³¨ë°˜ ê¸°ìš¸ê¸°ê°€ ${Math.abs(delta).toFixed(1)}Â° ê°ì†Œí•˜ì—¬ ê³¨ë°˜ ëŒ€ì¹­ì„±ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) > 1) return { status: 'worsened', comment: `ê³¨ë°˜ ê¸°ìš¸ê¸°ê°€ ${Math.abs(delta).toFixed(1)}Â° ì¦ê°€í•˜ì—¬ ê³¨ë°˜ ë¹„ëŒ€ì¹­ì´ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ê³¨ë°˜ ê¸°ìš¸ê¸°ëŠ” ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'LLD': {
      name: 'LLD(í•˜ì§€ê¸¸ì´ì°¨)',
      unit: 'cm',
      normal: 'â‰¤1cm',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = Math.abs(after) <= 1;
        if(inRange && Math.abs(delta) < 0.5) return { status: 'stable', comment: `í•˜ì§€ ê¸¸ì´ ì°¨ì´ëŠ” ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
        if(delta < -0.5) return { status: 'improved', comment: `í•˜ì§€ ê¸¸ì´ ì°¨ì´ê°€ ${Math.abs(delta).toFixed(1)}cm ê°ì†Œí•˜ì—¬ í•˜ì§€ ëŒ€ì¹­ì„±ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(delta > 0.5) return { status: 'worsened', comment: `í•˜ì§€ ê¸¸ì´ ì°¨ì´ê°€ ${delta.toFixed(1)}cm ì¦ê°€í•˜ì—¬ í•˜ì§€ ë¹„ëŒ€ì¹­ì´ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `í•˜ì§€ ê¸¸ì´ ì°¨ì´ëŠ” ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'Q_Angle': {
      name: 'Q-Angle(Qê°)',
      unit: 'Â°',
      normal: '10-20Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = after >= 10 && after <= 20;
        if(inRange && Math.abs(delta) < 2) return { status: 'stable', comment: `Qê°ì€ ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
        if(!inRange && after < 10) return { status: 'worsened', comment: `Qê°ì´ ${after.toFixed(1)}Â°ë¡œ ì •ìƒ ë²”ìœ„(10-20Â°)ë³´ë‹¤ ë‚®ì•„ ë¬´ë¦ ì •ë ¬ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.` };
        if(!inRange && after > 20) return { status: 'worsened', comment: `Qê°ì´ ${after.toFixed(1)}Â°ë¡œ ì •ìƒ ë²”ìœ„(10-20Â°)ë³´ë‹¤ ë†’ì•„ ë¬´ë¦ ì •ë ¬ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.` };
        if(inRange && delta > 0 && before < 10) return { status: 'improved', comment: `Qê°ì´ ì •ìƒ ë²”ìœ„ë¡œ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(inRange && delta < 0 && before > 20) return { status: 'improved', comment: `Qê°ì´ ì •ìƒ ë²”ìœ„ë¡œ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `Qê°ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'Knee_Deviation': {
      name: 'Knee Dev(ë¬´ë¦í¸ìœ„)',
      unit: 'Â°',
      normal: '0-3Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = Math.abs(after) <= 3;
        if(inRange && Math.abs(delta) < 1) return { status: 'stable', comment: `ë¬´ë¦ í¸ìœ„ëŠ” ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) < -1) return { status: 'improved', comment: `ë¬´ë¦ í¸ìœ„ê°€ ${Math.abs(delta).toFixed(1)}Â° ê°ì†Œí•˜ì—¬ ë¬´ë¦ ì •ë ¬ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) > 1) return { status: 'worsened', comment: `ë¬´ë¦ í¸ìœ„ê°€ ${Math.abs(delta).toFixed(1)}Â° ì¦ê°€í•˜ì—¬ ë¬´ë¦ ì •ë ¬ì´ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ë¬´ë¦ í¸ìœ„ëŠ” ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'TD': {
      name: 'TD(ì²´ê°„í¸ìœ„)',
      unit: 'Â°',
      normal: '0-3Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = Math.abs(after) <= 3;
        if(inRange && Math.abs(delta) < 1) return { status: 'stable', comment: `ì²´ê°„ í¸ìœ„ëŠ” ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) < -1) return { status: 'improved', comment: `ì²´ê°„ í¸ìœ„ê°€ ${Math.abs(delta).toFixed(1)}Â° ê°ì†Œí•˜ì—¬ ì²´ê°„ ì •ë ¬ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) > 1) return { status: 'worsened', comment: `ì²´ê°„ í¸ìœ„ê°€ ${Math.abs(delta).toFixed(1)}Â° ì¦ê°€í•˜ì—¬ ì²´ê°„ ì •ë ¬ì´ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ì²´ê°„ í¸ìœ„ëŠ” ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'HTA': {
      name: 'HTA(ë¨¸ë¦¬ê¸°ìš¸ê¸°ê°)',
      unit: 'Â°',
      normal: 'â‰¤3Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = Math.abs(after) <= 3;
        if(inRange && Math.abs(delta) < 1) return { status: 'stable', comment: `ë¨¸ë¦¬ ê¸°ìš¸ê¸°ëŠ” ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) < -1) return { status: 'improved', comment: `ë¨¸ë¦¬ ê¸°ìš¸ê¸°ê°€ ${Math.abs(delta).toFixed(1)}Â° ê°ì†Œí•˜ì—¬ ë¨¸ë¦¬ ëŒ€ì¹­ì„±ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) > 1) return { status: 'worsened', comment: `ë¨¸ë¦¬ ê¸°ìš¸ê¸°ê°€ ${Math.abs(delta).toFixed(1)}Â° ì¦ê°€í•˜ì—¬ ë¨¸ë¦¬ ë¹„ëŒ€ì¹­ì´ ì•…í™”ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ë¨¸ë¦¬ ê¸°ìš¸ê¸°ëŠ” ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'SPP': {
      name: 'SPP(ì–´ê¹¨ê³¨ë°˜í‰í–‰ë„)',
      unit: 'Â°',
      normal: '0-3Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        // SPPëŠ” ì ˆëŒ“ê°’ìœ¼ë¡œ íŒë‹¨
        const afterAbs = Math.abs(after);
        const beforeAbs = Math.abs(before);
        const inRange = afterAbs <= 3;
        if(inRange && Math.abs(afterAbs - beforeAbs) < 1) return { status: 'stable', comment: `ì–´ê¹¨-ê³¨ë°˜ í‰í–‰ë„ëŠ” ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
        if(afterAbs < beforeAbs - 1) return { status: 'improved', comment: `ì–´ê¹¨-ê³¨ë°˜ í‰í–‰ë„ê°€ ${(beforeAbs - afterAbs).toFixed(1)}Â° ê°œì„ ë˜ì–´ ì–´ê¹¨-ê³¨ë°˜ ì •ë ¬ì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(afterAbs > beforeAbs + 1) return { status: 'worsened', comment: `ì–´ê¹¨-ê³¨ë°˜ í‰í–‰ë„ê°€ ${(afterAbs - beforeAbs).toFixed(1)}Â° ì•…í™”ë˜ì–´ ì–´ê¹¨-ê³¨ë°˜ ì •ë ¬ì´ ì €í•˜ë˜ì—ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ì–´ê¹¨-ê³¨ë°˜ í‰í–‰ë„ëŠ” ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'KAS': {
      name: 'KAS(ë¬´ë¦ì •ë ¬ëŒ€ì¹­ì„±)',
      unit: 'Â°',
      normal: '0-3Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = Math.abs(after) <= 3;
        if(inRange && Math.abs(delta) < 1) return { status: 'stable', comment: `ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„±ì€ ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) < -1) return { status: 'improved', comment: `ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„±ì´ ${Math.abs(delta).toFixed(1)}Â° ê°œì„ ë˜ì–´ ë¬´ë¦ ëŒ€ì¹­ì„±ì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) > 1) return { status: 'worsened', comment: `ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„±ì´ ${Math.abs(delta).toFixed(1)}Â° ì•…í™”ë˜ì–´ ë¬´ë¦ ë¹„ëŒ€ì¹­ì´ ì¦ê°€í–ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„±ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    },
    'LLAS': {
      name: 'LLAS(í•˜ì§€ì¶•ëŒ€ì¹­ì„±)',
      unit: 'Â°',
      normal: '0-3Â°',
      analyze: (before, after, delta) => {
        if(before == null || after == null) return null;
        const inRange = Math.abs(after) <= 3;
        if(inRange && Math.abs(delta) < 1) return { status: 'stable', comment: `í•˜ì§€ ì¶• ëŒ€ì¹­ì„±ì€ ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) < -1) return { status: 'improved', comment: `í•˜ì§€ ì¶• ëŒ€ì¹­ì„±ì´ ${Math.abs(delta).toFixed(1)}Â° ê°œì„ ë˜ì–´ í•˜ì§€ ëŒ€ì¹­ì„±ì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.` };
        if(Math.abs(delta) > 1) return { status: 'worsened', comment: `í•˜ì§€ ì¶• ëŒ€ì¹­ì„±ì´ ${Math.abs(delta).toFixed(1)}Â° ì•…í™”ë˜ì–´ í•˜ì§€ ë¹„ëŒ€ì¹­ì´ ì¦ê°€í–ˆìŠµë‹ˆë‹¤.` };
        return { status: 'stable', comment: `í•˜ì§€ ì¶• ëŒ€ì¹­ì„±ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤.` };
      }
    }
  };
  
  const results = [];
  let improvedCount = 0;
  let worsenedCount = 0;
  let stableCount = 0;
  let highlightItem = null;
  let maxImprovement = 0;
  
  // ê° ì§€í‘œ ë¶„ì„ (ì¸¡ë©´ + ì •ë©´ ëª¨ë‘ í¬í•¨)
  Object.keys(metricRules).forEach(key => {
    const rule = metricRules[key];
    const before = getMetricValue(bMetrics, key);
    const after = getMetricValue(aMetrics, key);
    
    // âœ… Before ë˜ëŠ” After ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ë¶„ì„ (ë‘˜ ë‹¤ nullì´ ì•„ë‹ˆì–´ì•¼ í•¨)
    if(before == null && after == null) return;
    
    // âœ… Beforeê°€ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ, Afterê°€ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ê±´ë„ˆëœ€
    // ì‹¤ì œë¡œëŠ” ë‘˜ ë‹¤ ìˆì–´ì•¼ ë¹„êµ ê°€ëŠ¥í•˜ì§€ë§Œ, ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ í•˜ë‚˜ë§Œ ìˆì–´ë„ í‘œì‹œ
    if(before == null || after == null) {
      // í•˜ë‚˜ë§Œ ìˆëŠ” ê²½ìš°ëŠ” ë¹„êµ ë¶ˆê°€ì´ë¯€ë¡œ ê±´ë„ˆëœ€
      return;
    }
    
    const delta = after - before;
    const analysis = rule.analyze(before, after, delta);
    
    if(analysis) {
      results.push({
        key,
        name: rule.name,
        unit: rule.unit,
        normal: rule.normal,
        before,
        after,
        delta,
        ...analysis
      });
      
      if(analysis.status === 'improved') {
        improvedCount++;
        if(Math.abs(delta) > maxImprovement) {
          maxImprovement = Math.abs(delta);
          highlightItem = rule.name;
        }
      } else if(analysis.status === 'worsened') {
        worsenedCount++;
      } else {
        stableCount++;
      }
    }
  });
  
  // ì „ì²´ ìš”ì•½ ì½”ë©˜íŠ¸ ìƒì„±
  const focusRegion = improvedCount > worsenedCount ? 'ìƒë¶€ ì²´ê°„' : worsenedCount > 0 ? 'ì „ì‹  ì •ë ¬' : 'ì•ˆì •í™”';
  const overallComment = `ğŸ“Š ì „ë°˜ì ì¸ ë¶„ì„ ê²°ê³¼, ${improvedCount}ê°œ í•­ëª©ì—ì„œ ìì„¸ê°€ ê°œì„ ë˜ì—ˆìœ¼ë©° ${stableCount}ê°œ í•­ëª©ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.${worsenedCount > 0 ? ` ${worsenedCount}ê°œ í•­ëª©ì—ì„œ ì•…í™”ê°€ ê´€ì°°ë˜ì—ˆìŠµë‹ˆë‹¤.` : ''}${highlightItem ? ` íŠ¹íˆ ${highlightItem} ì§€í‘œì—ì„œ ë‘ë“œëŸ¬ì§„ í–¥ìƒì´ ê´€ì°°ë˜ë©°,` : ''} ì „ì‹ ì˜ ìˆ˜ì§ì •ë ¬ê³¼ ì²´ê°„-ê³¨ë°˜ í˜‘ì‘ì´ ${improvedCount > worsenedCount ? 'í–¥ìƒ' : improvedCount === worsenedCount ? 'ìœ ì§€' : 'ê°œì„  í•„ìš”'}ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ë¼í…ŒìŠ¤ í”„ë¡œê·¸ë¨ì—ì„œëŠ” ${focusRegion} ë¶€ìœ„ì˜ ê·¼ê¸´ì¥ ì¡°ì ˆ ë° ì•ˆì •í™” ìš´ë™ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì§„í–‰í•˜ëŠ” ê²ƒì´ íš¨ê³¼ì ì…ë‹ˆë‹¤.`;
  
  return {
    results,
    summary: {
      improvedCount,
      worsenedCount,
      stableCount,
      highlightItem,
      overallComment
    }
  };
}

// âœ… ìš´ë™ ì¶”ì²œ ì—”ì§„ - ë¶„ì„ ê²°ê³¼ë¥¼ ë°›ì•„ì„œ íŒ¨í„´ë³„ ê·¼ìœ¡ê³¼ ìš´ë™ ì¶”ì²œ ìƒì„±
function generatePostureRecommendations(analysis) {
  const patterns = [];
  
  function addPattern({pattern, condition, tight, weak, exercises}) {
    patterns.push({
      pattern: pattern,
      condition: condition,
      tight_muscles: tight,
      weak_muscles: weak,
      recommended_exercises: exercises
    });
  }
  
  // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ì—ì„œ ê°’ ì¶”ì¶œ
  const side = analysis.side || {};
  const front = analysis.front || {};
  
  // ì¸¡ë©´ ì§€í‘œ
  const cva = side.CVA?.value_deg;
  const hpd = side.HPD?.value_cm;
  const saa = side.SAA?.value_deg;
  const pta = side.PTA?.value_deg;
  const ka = side.KA?.value_deg;
  const gsb = side.GSB?.value_cm;
  
  // ì •ë©´ ì§€í‘œ
  const frontKA = front.KA?.value_deg;
  
  // ê±°ë¶ëª© (FHP)
  if (cva != null && cva < 50) {
    addPattern({
      pattern: "ê±°ë¶ëª©(FHP)",
      condition: "CVAâ†“ / HPDâ†‘",
      tight: ["SCM", "ìƒë¶€ìŠ¹ëª¨", "ê²¬ê°‘ê±°ê·¼", "ì†Œí‰ê·¼"],
      weak: ["ì‹¬ë¶€ê²½ë¶€êµ´ê·¼", "í•˜ë¶€ìŠ¹ëª¨", "ì „ê±°ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Chin Tuck & Axial Elongation (í„±ë‹¹ê¸°ê¸° + ì¶•ì‹ ì¥)", "Swan Prep"],
        "ë¦¬í¬ë¨¸": ["Pulling Straps"],
        "ìºë”œë½": ["Tower Swan"],
        "ì²´ì–´": ["Press Down Front"],
        "ë°”ë ": ["Swan on Ladder Barrel"]
      }
    });
  }
  
  // ë¼ìš´ë“œìˆ„ë” (RSP)
  if (saa != null && saa > 10) {
    addPattern({
      pattern: "ë¼ìš´ë“œìˆ„ë”(RSP)",
      condition: "SAAâ†‘",
      tight: ["ëŒ€í‰ê·¼", "ì†Œí‰ê·¼", "ìƒë¶€ìŠ¹ëª¨"],
      weak: ["í•˜ë¶€ìŠ¹ëª¨", "ëŠ¥í˜•ê·¼", "ì „ê±°ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Prone Scapular Retraction"],
        "ë¦¬í¬ë¨¸": ["Rowing Back", "Pulling Straps"],
        "ìºë”œë½": ["Arm Springs - Extension"],
        "ì²´ì–´": ["Spine Stretch Forward (Chair Ver.)"],
        "ë°”ë ": ["Shoulder Extension on Barrel"]
      }
    });
  }
  
  // ê³¼ì „ê²½ì‚¬ ê³¨ë°˜ (Anterior Tilt) - ASISê°€ PSISë³´ë‹¤ ë‚®ìŒ (ì–‘ìˆ˜ ê°’)
  if (pta != null && pta > 15) {
    addPattern({
      pattern: "ê³¼ì „ê²½ì‚¬ ê³¨ë°˜ (Anterior Tilt)",
      condition: "PTAâ†‘ (ì–‘ìˆ˜), ASISê°€ PSISë³´ë‹¤ ë‚®ìŒ",
      tight: ["ì¥ìš”ê·¼", "ëŒ€í‡´ì§ê·¼", "ì²™ì¶”ê¸°ë¦½ê·¼"],
      weak: ["ë³µì§ê·¼", "ë³µíš¡ê·¼", "ë‘”ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Pelvic Curl", "Dead Bug / Toe Tap"],
        "ë¦¬í¬ë¨¸": ["Bridge on Reformer"],
        "ìºë”œë½": ["Roll Down with Push Through Bar"],
        "ì²´ì–´": ["Standing Hip Extension"],
        "ë°”ë ": ["Short Box Round Back"]
      }
    });
  }
  
  // í›„ê²½ì‚¬ ê³¨ë°˜ (Posterior Tilt) - ASISê°€ PSISë³´ë‹¤ ë†’ìŒ (ìŒìˆ˜ ê°’)
  if (pta != null && (pta < 0 || pta < 5)) {
    addPattern({
      pattern: "í›„ê²½ì‚¬ ê³¨ë°˜ (Posterior Tilt)",
      condition: "PTAâ†“ (ìŒìˆ˜ ë˜ëŠ” ì‘ì€ ê°’), ASISê°€ PSISë³´ë‹¤ ë†’ìŒ",
      tight: ["í–„ìŠ¤íŠ¸ë§", "ë³µì§ê·¼"],
      weak: ["ì¥ìš”ê·¼", "ëŒ€í‡´ì§ê·¼", "ì²™ì¶”ê¸°ë¦½ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Leg Pull Front"],
        "ë¦¬í¬ë¨¸": ["Footwork - Parallel Heels"],
        "ìºë”œë½": ["Leg Springs - Supine"],
        "ì²´ì–´": ["Swan Press"],
        "ë°”ë ": ["Swan on Barrel"]
      }
    });
  }
  
  // Xì ë‹¤ë¦¬ (Genu Valgum) - ì¸¡ë©´ ë˜ëŠ” ì •ë©´ KA ì‚¬ìš©
  const kaValue = ka || frontKA;
  if (kaValue != null && kaValue < 175) {
    addPattern({
      pattern: "Xì ë‹¤ë¦¬ (Genu Valgum)",
      condition: "KAâ†“, Q-Angleâ†‘",
      tight: ["ë‚´ì „ê·¼", "ë‚´ì¸¡ê´‘ê·¼"],
      weak: ["ì¤‘ë‘”ê·¼", "ì™¸íšŒì „ê·¼", "ì™¸ì¸¡ê´‘ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Side-Lying Leg Lift"],
        "ë¦¬í¬ë¨¸": ["Side Splits"],
        "ìºë”œë½": ["Standing Hip Abduction"],
        "ì²´ì–´": ["Step Up Lateral"],
        "ë°”ë ": ["Side Bend Stretch"]
      }
    });
  }
  
  // Oì ë‹¤ë¦¬ (Genu Varum)
  if (kaValue != null && kaValue > 180) {
    addPattern({
      pattern: "Oì ë‹¤ë¦¬ (Genu Varum)",
      condition: "KAâ†‘",
      tight: ["ì™¸ì¸¡ê´‘ê·¼", "ë¹„ë³µê·¼", "ëŒ€í‡´ì´ë‘"],
      weak: ["ë‚´ì „ê·¼", "ë‚´ì¸¡ê´‘ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Ball Squeeze Bridge"],
        "ë¦¬í¬ë¨¸": ["Footwork - Small V Position"],
        "ìºë”œë½": ["Standing Leg Press - Adduction"],
        "ì²´ì–´": ["Seated Adduction"],
        "ë°”ë ": ["Adductor Stretch on Barrel"]
      }
    });
  }
  
  // ì „ë°© ì²´ì¤‘ ì¤‘ì‹¬ (Forward Center)
  if (gsb != null && gsb > 2) {
    addPattern({
      pattern: "ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© (Forward Center)",
      condition: "GSBâ†‘",
      tight: ["ëŒ€í‡´ì§ê·¼", "ìš”ì¶”ê¸°ë¦½ê·¼", "ì¢…ì•„ë¦¬ê·¼"],
      weak: ["ë‘”ê·¼", "í–„ìŠ¤íŠ¸ë§", "ë³µë¶€"],
      exercises: {
        "ë§¤íŠ¸": ["Pelvic Curl"],
        "ë¦¬í¬ë¨¸": ["Scooter"],
        "ìºë”œë½": ["Tower Roll Up"],
        "ì²´ì–´": ["Standing Leg Press"],
        "ë°”ë ": ["Swan"]
      }
    });
  }
  
  // í›„ë°© ì²´ì¤‘ ì¤‘ì‹¬ (Backward Center)
  if (gsb != null && gsb < -2) {
    addPattern({
      pattern: "ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°© (Backward Center)",
      condition: "GSBâ†“",
      tight: ["í–„ìŠ¤íŠ¸ë§", "ë‘”ê·¼"],
      weak: ["ì¥ìš”ê·¼", "ëŒ€í‡´ì§ê·¼"],
      exercises: {
        "ë§¤íŠ¸": ["Hip Flexor Stretch"],
        "ë¦¬í¬ë¨¸": ["Standing Lunge"],
        "ìºë”œë½": ["Leg Springs - Supine"],
        "ì²´ì–´": ["Step Up Front"],
        "ë°”ë ": ["Lunge on Barrel"]
      }
    });
  }
  
  return { patterns: patterns };
}

// âœ… í†µí•© ë¶„ì„ í•¨ìˆ˜ - ì¸¡ë©´/ì •ë©´ ìë™ ê°ì§€
function analyzePostureAuto(options = {}) {
  const {
    sidePts = null,
    frontPts = null,
    pxPerCm = 50.0,
    imageWidth = cv ? (cv.width / DPR) : 1080 // ìº”ë²„ìŠ¤ ë„ˆë¹„ ë˜ëŠ” ê¸°ë³¸ê°’
  } = options;
  
  const result = {
    side: {},
    front: {},
    summary: {}
  };
  
  // ì¸¡ë©´ ë¶„ì„
  if (sidePts != null && Object.keys(sidePts).length > 0) {
    result.side = analyzeFullPosture(sidePts, pxPerCm, imageWidth);
  } else {
    result.side.status = "not_available";
  }
  
  // ì •ë©´ ë¶„ì„
  if (frontPts != null && Object.keys(frontPts).length > 0) {
    result.front = analyzeFrontPosture(frontPts, pxPerCm);
  } else {
    result.front.status = "not_available";
  }
  
  // í†µí•© ì ìˆ˜ ê³„ì‚°
  const sidePDS = result.side.PDS?.value || 0;
  const frontPDS = result.front.PDS?.value || 0;
  
  const availableCount = [
    result.side.status !== "not_available",
    result.front.status !== "not_available"
  ].filter(e => e).length;
  
  if (availableCount > 0) {
    const avg = (sidePDS + frontPDS) / (availableCount === 2 ? 2 : 1);
    result.summary = {
      PDS_total: avg.toFixed(1),
      risk_level: avg < 10 
        ? "ì •ìƒ" 
        : avg < 15 
          ? "ê²½ë¯¸í•œ ë¶ˆê· í˜•" 
          : "ì¤‘ë“±ë„ ì´ìƒ ë¶ˆê· í˜•"
    };
  } else {
    result.summary.status = "not_available";
  }
  
  return result;
}

// âœ… í†µí•© ë¶„ì„ + ìš´ë™ ì¶”ì²œ ê²°í•©
function analyzePostureAutoWithRecommendation(options = {}) {
  const {
    sidePts = null,
    frontPts = null,
    pxPerCm = 50.0
  } = options;
  
  // ê¸°ë³¸ í†µí•© ë¶„ì„ ì‹¤í–‰
  const imageWidth = cv ? (cv.width / DPR) : 1080; // ìº”ë²„ìŠ¤ ë„ˆë¹„ ë˜ëŠ” ê¸°ë³¸ê°’
  const result = analyzePostureAuto({
    sidePts: sidePts,
    frontPts: frontPts,
    pxPerCm: pxPerCm,
    imageWidth: imageWidth
  });
  
  // ë¶„ì„ ê²°ê³¼ë¥¼ í†µí•©í•˜ì—¬ ìš´ë™ ì¶”ì²œ ìƒì„±
  const analysis = {
    side: result.side,
    front: result.front,
    summary: result.summary
  };
  
  // ìš´ë™ ì¶”ì²œ ìƒì„±
  const recommendation = generatePostureRecommendations(analysis);
  result.recommendations = recommendation;
  
  return result;
}

// âœ… ì‹¤ì‹œê°„ ë¶„ì„ ì—”ì§„ (Stream ê¸°ë°˜)
class LivePostureAnalyzer {
  constructor() {
    this.listeners = [];
    this.isAnalyzing = false;
    this.lastResult = null;
  }
  
  // ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì‹¤ì‹œê°„ ê²°ê³¼ ìˆ˜ì‹ )
  addListener(callback) {
    this.listeners.push(callback);
  }
  
  // ë¦¬ìŠ¤ë„ˆ ì œê±°
  removeListener(callback) {
    const index = this.listeners.indexOf(callback);
    if (index > -1) {
      this.listeners.splice(index, 1);
    }
  }
  
  // ê²°ê³¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸
  _broadcast(result) {
    this.lastResult = result;
    this.listeners.forEach(callback => {
      try {
        callback(result);
      } catch (error) {
        console.error('Listener error:', error);
      }
    });
  }
  
  // ì‹¤ì‹œê°„ ë¶„ì„ ì‹¤í–‰ (ë§¤ í”„ë ˆì„/ì¢Œí‘œ ë³€ê²½ ì‹œ)
  analyzeFrame(options = {}) {
    if (this.isAnalyzing) {
      return this.lastResult; // ì´ë¯¸ ë¶„ì„ ì¤‘ì´ë©´ ë§ˆì§€ë§‰ ê²°ê³¼ ë°˜í™˜
    }
    
    this.isAnalyzing = true;
    
    try {
      const {
        sidePts = null,
        frontPts = null,
        pxPerCm = 50.0
      } = options;
      
      // í†µí•© ë¶„ì„ ì‹¤í–‰
      const analysisResult = analyzePostureAutoWithRecommendation({
        sidePts: sidePts,
        frontPts: frontPts,
        pxPerCm: pxPerCm
      });
      
      // ì‹¤ì‹œê°„ ê²°ê³¼ í¬ë§· (JSON ì¶œë ¥ ì˜ˆì‹œ êµ¬ì¡°)
      const result = {
        timestamp: new Date().toISOString(),
        analysis: {
          side: analysisResult.side,
          front: analysisResult.front,
          summary: analysisResult.summary
        },
        recommendations: analysisResult.recommendations || { patterns: [] }
      };
      
      // ì£¼ìš” ì§€í‘œ ì¶”ì¶œ (ì‹¤ì‹œê°„ í‘œì‹œìš©)
      const sideMetrics = analysisResult.side || {};
      const frontMetrics = analysisResult.front || {};
      const summary = analysisResult.summary || {};
      
      result.liveMetrics = {
        CVA: sideMetrics.CVA ? { value: sideMetrics.CVA.value_deg, status: sideMetrics.CVA.status } : null,
        PTA: sideMetrics.PTA ? { value: sideMetrics.PTA.value_deg, status: sideMetrics.PTA.status } : null,
        KA: sideMetrics.KA ? { value: sideMetrics.KA.value_deg, status: sideMetrics.KA.status } : (frontMetrics.KA ? { value: frontMetrics.KA.value_deg, status: frontMetrics.KA.status } : null),
        PDS: summary.PDS_total ? parseFloat(summary.PDS_total) : 0,
        risk_level: summary.risk_level || 'unknown'
      };
      
      // ë¸Œë¡œë“œìºìŠ¤íŠ¸
      this._broadcast(result);
      
      return result;
    } finally {
      this.isAnalyzing = false;
    }
  }
  
  // í˜„ì¬ ì„¸ì…˜ì˜ í‚¤í¬ì¸íŠ¸ë¡œ ì‹¤ì‹œê°„ ë¶„ì„
  analyzeCurrentSession() {
    const S = sessions[cur];
    const pxPerCm = S.pxPerCm || 50.0;
    
    // ì¸¡ë©´ ë° ì •ë©´ í‚¤í¬ì¸íŠ¸ ë³€í™˜
    const sidePoints = {};
    const frontPoints = {};
    
    for(const [key, value] of S.sidePoints.entries()) {
      if(value && value.x != null && value.y != null) {
        sidePoints[key] = { x: value.x, y: value.y };
      }
    }
    
    for(const [key, value] of S.frontPoints.entries()) {
      if(value && value.x != null && value.y != null) {
        frontPoints[key] = { x: value.x, y: value.y };
      }
    }
    
    return this.analyzeFrame({
      sidePts: Object.keys(sidePoints).length > 0 ? sidePoints : null,
      frontPts: Object.keys(frontPoints).length > 0 ? frontPoints : null,
      pxPerCm: pxPerCm
    });
  }
}

// ì „ì—­ ì‹¤ì‹œê°„ ë¶„ì„ê¸° ì¸ìŠ¤í„´ìŠ¤
const liveAnalyzer = new LivePostureAnalyzer();

// ğŸ‹ï¸â€â™€ï¸ íŒ¨í„´ ê¸°ë°˜ í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ì‹œìŠ¤í…œ (BASI/Polestar/STOTT ê¸°ì¤€)
const pilatesPatterns = {
  // 1ï¸âƒ£ ê±°ë¶ëª©(FHP): CVAâ†“, HPDâ†‘
  'FHP': {
    name: 'ê±°ë¶ëª© (Forward Head Posture)',
    condition: 'CVAâ†“ / HPDâ†‘',
    tight: ['SCM', 'ìƒë¶€ìŠ¹ëª¨', 'ê²¬ê°‘ê±°ê·¼', 'ì†Œí‰ê·¼'],
    weak: ['ì‹¬ë¶€ê²½ë¶€êµ´ê·¼', 'í•˜ë¶€ìŠ¹ëª¨', 'ì „ê±°ê·¼'],
    interpretation: 'ë¨¸ë¦¬ ì „ë°© ëŒì¶œ, ê²½ì¶” ì „ë§Œ ê°ì†Œ',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Chin Tuck & Axial Elongation', ko: 'í„±ë‹¹ê¸°ê¸° + ì¶•ì‹ ì¥', purpose: 'ê²½ì¶” ì•ˆì •í™”' },
        { en: 'Swan Prep', ko: 'ìŠ¤ì™„ ì¤€ë¹„', purpose: 'í‰ì¶” ì‹ ì „, ìŠ¹ëª¨ê·¼ í•˜ë¶€ ê°•í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Pulling Straps', ko: 'í’€ë§ ìŠ¤íŠ¸ë©', purpose: 'ê²¬ê°‘ í›„ë°© ì•ˆì •í™”' }
      ],
      ìºë”œë½: [
        { en: 'Tower Swan', ko: 'íƒ€ì›Œ ìŠ¤ì™„', purpose: 'í‰ì¶” ì‹ ì „ + ê²¬ê°‘ í›„ë°©ìš´ë™' }
      ],
      ì²´ì–´: [
        { en: 'Press Down Front', ko: 'í”„ë ˆìŠ¤ ë‹¤ìš´ í”„ë¡ íŠ¸', purpose: 'ê²½ì¶” ì •ë ¬ + ì „ê±°ê·¼ í™œì„±í™”' }
      ],
      ë°”ë : [
        { en: 'Swan on Ladder Barrel', ko: 'ë˜ë” ë°°ëŸ´ ìŠ¤ì™„', purpose: 'í‰ì¶” ê°€ë™ì„±, ìŠ¹ëª¨í•˜ë¶€ ê°•í™”' }
      ]
    }
  },
  
  // 2ï¸âƒ£ ë¼ìš´ë“œìˆ„ë”(RSP): SAAâ†‘
  'RSP': {
    name: 'ë¼ìš´ë“œìˆ„ë” (Rounded Shoulder Posture)',
    condition: 'SAAâ†‘',
    tight: ['ëŒ€í‰ê·¼', 'ì†Œí‰ê·¼', 'ìƒë¶€ìŠ¹ëª¨'],
    weak: ['í•˜ë¶€ìŠ¹ëª¨', 'ëŠ¥í˜•ê·¼', 'ì „ê±°ê·¼'],
    interpretation: 'ê²¬ê°‘ ì „ì¸Â·ìƒë°©íšŒì „',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Prone Scapular Retraction', ko: 'í”„ë¡  ì‚¬íˆ¬ë¼ ê²¬ê°‘ê³¨ í›„ì¸', purpose: 'ê²¬ê°‘ê³¨ í›„ì¸ ê°•í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Rowing Back / Pulling Straps', ko: 'ë¡œì‰ ë°± / í’€ë§ ìŠ¤íŠ¸ë©', purpose: 'ê²¬ê°‘ ì•ˆì •í™”' }
      ],
      ìºë”œë½: [
        { en: 'Arm Springs - Extension', ko: 'ì•” ìŠ¤í”„ë§ - ìµìŠ¤í…ì…˜', purpose: 'ì–´ê¹¨ í›„ë°©ê·¼ ê°•í™”' }
      ],
      ì²´ì–´: [
        { en: 'Spine Stretch Forward (Chair Ver.)', ko: 'ìŠ¤íŒŒì¸ ìŠ¤íŠ¸ë ˆì¹˜ í¬ì›Œë“œ (ì²´ì–´ ë²„ì „)', purpose: 'ê²¬ê°‘ ì•ˆì •í™” ë° í‰ì¶” ì‹ ì „' }
      ],
      ë°”ë : [
        { en: 'Shoulder Extension on Barrel', ko: 'ë°°ëŸ´ ì–´ê¹¨ ìµìŠ¤í…ì…˜', purpose: 'í‰ì¶” ê°€ë™ì„± + ì–´ê¹¨ í›„ì¸ê·¼ ê°•í™”' }
      ]
    }
  },
  
  // 3ï¸âƒ£ ê³¼ì „ê²½ì‚¬ ê³¨ë°˜: PTAâ†‘ (ì–‘ìˆ˜ ê°’, ASISê°€ PSISë³´ë‹¤ ë‚®ìŒ)
  'AnteriorTilt': {
    name: 'ê³¼ì „ê²½ì‚¬ ê³¨ë°˜ (Anterior Pelvic Tilt)',
    condition: 'PTAâ†‘ (ì–‘ìˆ˜), ASISê°€ PSISë³´ë‹¤ ë‚®ìŒ',
    tight: ['ì¥ìš”ê·¼', 'ëŒ€í‡´ì§ê·¼', 'ì²™ì¶”ê¸°ë¦½ê·¼'],
    weak: ['ë³µì§ê·¼', 'ë³µíš¡ê·¼', 'ë‘”ê·¼'],
    interpretation: 'ê³¨ë°˜ ì „ë°©ê²½ì‚¬ / ìš”ì¶” ì „ë§Œ ì¦ê°€',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Pelvic Curl', ko: 'í ë¹… ì»¬', purpose: 'ê³¨ë°˜ í›„ê²½ì‚¬ ìœ ë„' },
        { en: 'Dead Bug / Toe Tap', ko: 'ë°ë“œ ë²„ê·¸ / í†  íƒ­', purpose: 'ë³µíš¡ê·¼ í™œì„±í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Bridge on Reformer', ko: 'ë¦¬í¬ë¨¸ ë¸Œë¦¿ì§€', purpose: 'í›„ë°© ì‚¬ìŠ¬ ê°•í™”' }
      ],
      ìºë”œë½: [
        { en: 'Roll Down with Push Through Bar', ko: 'ë¡¤ ë‹¤ìš´ (í‘¸ì‹œ ìŠ¤ë£¨ ë°”)', purpose: 'ë³µë¶€ ì½”ì–´ ì¡°ì ˆ' }
      ],
      ì²´ì–´: [
        { en: 'Standing Hip Extension', ko: 'ìŠ¤íƒ ë”© í™ ìµìŠ¤í…ì…˜', purpose: 'ë‘”ê·¼ ê°•í™”' }
      ],
      ë°”ë : [
        { en: 'Short Box Round Back', ko: 'ìˆ ë°•ìŠ¤ ë¼ìš´ë“œ ë°±', purpose: 'ì½”ì–´ + í›„ë°© ì‚¬ìŠ¬ ê°•í™”' }
      ]
    }
  },
  
  // 4ï¸âƒ£ í›„ê²½ì‚¬ ê³¨ë°˜: PTAâ†“ (ìŒìˆ˜ ê°’, ASISê°€ PSISë³´ë‹¤ ë†’ìŒ)
  'PosteriorTilt': {
    name: 'í›„ê²½ì‚¬ ê³¨ë°˜ (Posterior Pelvic Tilt)',
    condition: 'PTAâ†“ (ìŒìˆ˜ ë˜ëŠ” ì‘ì€ ê°’), ASISê°€ PSISë³´ë‹¤ ë†’ìŒ',
    tight: ['í–„ìŠ¤íŠ¸ë§', 'ë³µì§ê·¼'],
    weak: ['ì¥ìš”ê·¼', 'ëŒ€í‡´ì§ê·¼', 'ì²™ì¶”ê¸°ë¦½ê·¼'],
    interpretation: 'ê³¨ë°˜ í›„ë°©ê²½ì‚¬ / ìš”ì¶” í¸í‰',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Leg Pull Front', ko: 'ë ˆê·¸ í’€ í”„ë¡ íŠ¸', purpose: 'ì „ë°© ì‚¬ìŠ¬ ê°•í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Footwork - Parallel Heels', ko: 'í’‹ì›Œí¬ - íŒ¨ëŸ´ë  íì¦ˆ', purpose: 'ê³ ê´€ì ˆ ì‹ ì „ í™œì„±í™”' }
      ],
      ìºë”œë½: [
        { en: 'Leg Springs - Supine', ko: 'ë ˆê·¸ ìŠ¤í”„ë§ - ìŠˆíŒŒì¸', purpose: 'ì¥ìš”ê·¼ ê¸°ëŠ¥ì  ìˆ˜ì¶•' }
      ],
      ì²´ì–´: [
        { en: 'Swan Press', ko: 'ìŠ¤ì™„ í”„ë ˆìŠ¤', purpose: 'ìš”ì¶” ì‹ ì „ ê°•í™”' }
      ],
      ë°”ë : [
        { en: 'Swan on Barrel', ko: 'ë°°ëŸ´ ìŠ¤ì™„', purpose: 'ìš”ì¶” ê°€ë™ì„± í–¥ìƒ' }
      ]
    }
  },
  
  // 5ï¸âƒ£ Xì ë‹¤ë¦¬: KAâ†“, Q-Angleâ†‘
  'GenuValgum': {
    name: 'Xì ë‹¤ë¦¬ (Genu Valgum)',
    condition: 'KAâ†“, Q-Angleâ†‘',
    tight: ['ë‚´ì „ê·¼', 'ë‚´ì¸¡ê´‘ê·¼'],
    weak: ['ì¤‘ë‘”ê·¼', 'ì™¸íšŒì „ê·¼', 'ì™¸ì¸¡ê´‘ê·¼'],
    interpretation: 'ìŠ¬ê°œê³¨ ì™¸ì¸¡ ì••ë°• íŒ¨í„´',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Side-Lying Leg Lift', ko: 'ì‚¬ì´ë“œ ë¼ì‰ ë ˆê·¸ ë¦¬í”„íŠ¸', purpose: 'ì¤‘ë‘”ê·¼ ê°•í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Side Splits', ko: 'ì‚¬ì´ë“œ ìŠ¤í”Œë¦¿', purpose: 'ì™¸ì¸¡ ì•ˆì •í™”' }
      ],
      ìºë”œë½: [
        { en: 'Standing Hip Abduction', ko: 'ìŠ¤íƒ ë”© í™ ì™¸ì „', purpose: 'ê³ ê´€ì ˆ ì™¸ì „ ê°•í™”' }
      ],
      ì²´ì–´: [
        { en: 'Step Up Lateral', ko: 'ìŠ¤í… ì—… ë ˆí„°ëŸ´', purpose: 'í•˜ì§€ ì™¸ì¸¡ ì•ˆì •ì„±' }
      ],
      ë°”ë : [
        { en: 'Side Bend Stretch', ko: 'ì‚¬ì´ë“œ ë²¤ë“œ ìŠ¤íŠ¸ë ˆì¹˜', purpose: 'ê³ ê´€ì ˆ ì •ë ¬ ë° ì•ˆì •ì„± ê°œì„ ' }
      ]
    }
  },
  
  // 6ï¸âƒ£ Oì ë‹¤ë¦¬: KAâ†‘
  'GenuVarum': {
    name: 'Oì ë‹¤ë¦¬ (Genu Varum)',
    condition: 'KAâ†‘',
    tight: ['ì™¸ì¸¡ê´‘ê·¼', 'ë¹„ë³µê·¼', 'ëŒ€í‡´ì´ë‘'],
    weak: ['ë‚´ì „ê·¼', 'ë‚´ì¸¡ê´‘ê·¼'],
    interpretation: 'ì™¸ì¸¡ ê³¼ë¶€í•˜',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Ball Squeeze Bridge', ko: 'ë³¼ ìŠ¤í€´ì¦ˆ ë¸Œë¦¿ì§€', purpose: 'ë‚´ì „ê·¼ í™œì„±í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Footwork - Small V Position', ko: 'í’‹ì›Œí¬ - ìŠ¤ëª° V í¬ì§€ì…˜', purpose: 'ë‚´ì¸¡ê´‘ê·¼ ê°•í™”' }
      ],
      ìºë”œë½: [
        { en: 'Standing Leg Press - Adduction', ko: 'ìŠ¤íƒ ë”© ë ˆê·¸ í”„ë ˆìŠ¤ - ë‚´ì „', purpose: 'ë‚´ì „ê·¼ ê°•í™”' }
      ],
      ì²´ì–´: [
        { en: 'Seated Adduction', ko: 'ì‹œí‹°ë“œ ë‚´ì „', purpose: 'ë‚´ì¸¡ ê·¼ìœ¡ ì¡°ì ˆ' }
      ],
      ë°”ë : [
        { en: 'Adductor Stretch on Barrel', ko: 'ë°°ëŸ´ ë‚´ì „ê·¼ ìŠ¤íŠ¸ë ˆì¹˜', purpose: 'ë‚´ì „ê·¼ ê°€ë™ì„± í–¥ìƒ' }
      ]
    }
  },
  
  // 7ï¸âƒ£ ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°©: GSBâ†‘
  'ForwardCenter': {
    name: 'ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© (Forward Center)',
    condition: 'GSBâ†‘',
    tight: ['ëŒ€í‡´ì§ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼', 'ì¢…ì•„ë¦¬ê·¼'],
    weak: ['ë‘”ê·¼', 'í–„ìŠ¤íŠ¸ë§', 'ë³µë¶€'],
    interpretation: 'ì²´ê°„ ì „ë°©ê¸°ìš¸ì„',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Pelvic Curl', ko: 'í ë¹… ì»¬', purpose: 'ë‘”ê·¼/í–„ìŠ¤íŠ¸ë§ ê°•í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Scooter', ko: 'ìŠ¤ì¿ í„°', purpose: 'ë‘”ê·¼ ì‹ ì „ ì¡°ì ˆ' }
      ],
      ìºë”œë½: [
        { en: 'Tower Roll Up', ko: 'íƒ€ì›Œ ë¡¤ ì—…', purpose: 'ì½”ì–´ í™œì„±í™”' }
      ],
      ì²´ì–´: [
        { en: 'Standing Leg Press', ko: 'ìŠ¤íƒ ë”© ë ˆê·¸ í”„ë ˆìŠ¤', purpose: 'í›„ë°© ì²´ì¤‘ ì´ë™ í›ˆë ¨' }
      ],
      ë°”ë : [
        { en: 'Swan', ko: 'ìŠ¤ì™„', purpose: 'í‰ì¶” ì•ˆì •í™”' }
      ]
    }
  },
  
  // 8ï¸âƒ£ ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°©: GSBâ†“
  'BackwardCenter': {
    name: 'ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°© (Backward Center)',
    condition: 'GSBâ†“',
    tight: ['í–„ìŠ¤íŠ¸ë§', 'ë‘”ê·¼'],
    weak: ['ì¥ìš”ê·¼', 'ëŒ€í‡´ì§ê·¼'],
    interpretation: 'ì²´ê°„ í›„ë°©ê¸°ìš¸ì„',
    exercises: {
      ë§¤íŠ¸: [
        { en: 'Hip Flexor Stretch', ko: 'í™ í”Œë ‰ì„œ ìŠ¤íŠ¸ë ˆì¹˜', purpose: 'ì „ë°© ì‚¬ìŠ¬ í™œì„±í™”' }
      ],
      ë¦¬í¬ë¨¸: [
        { en: 'Standing Lunge', ko: 'ìŠ¤íƒ ë”© ëŸ°ì§€', purpose: 'ê³ ê´€ì ˆ ì‹ ì „/êµ´ê³¡ ë°¸ëŸ°ìŠ¤' }
      ],
      ìºë”œë½: [
        { en: 'Leg Springs - Supine', ko: 'ë ˆê·¸ ìŠ¤í”„ë§ - ìŠˆíŒŒì¸', purpose: 'ì¥ìš”ê·¼ ê°•í™”' }
      ],
      ì²´ì–´: [
        { en: 'Step Up Front', ko: 'ìŠ¤í… ì—… í”„ë¡ íŠ¸', purpose: 'í•˜ì§€ ì „ë°© ì•ˆì •í™”' }
      ],
      ë°”ë : [
        { en: 'Lunge on Barrel', ko: 'ë°°ëŸ´ ëŸ°ì§€', purpose: 'ê³ ê´€ì ˆ ì „ë°©ì´ë™ í›ˆë ¨' }
      ]
    }
  }
};

// í•„ë¼í…ŒìŠ¤ ìš´ë™ ìƒì„¸ ì„¤ëª… ë°ì´í„°ë² ì´ìŠ¤
const pilatesExerciseDescriptions = {
  // ê±°ë¶ëª©(FHP) ê´€ë ¨ ìš´ë™
  'Chin Tuck & Axial Elongation': {
    ko: 'í„±ë‹¹ê¸°ê¸° + ì¶•ì‹ ì¥',
    description: 'ëª©ê³¼ ì²™ì¶”ë¥¼ ì •ë ¬í•˜ë©´ì„œ ê²½ì¶”ë¥¼ ì•ˆì •í™”í•˜ëŠ” ê¸°ë³¸ ë™ì‘ì…ë‹ˆë‹¤. ë²½ì— ë“±ì„ ëŒ€ê³  ì„œì„œ í„±ì„ ë’¤ë¡œ ë‹¹ê¸°ë©° ë¨¸ë¦¬ ê¼­ëŒ€ê¸°ë¥¼ ì²œì¥ ë°©í–¥ìœ¼ë¡œ ëŠ˜ë¦½ë‹ˆë‹¤. ìƒë¶€ ìŠ¹ëª¨ê·¼ì˜ ê¸´ì¥ì„ ì™„í™”í•˜ê³  ì‹¬ë¶€ ê²½ë¶€ êµ´ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë²½ì— ë“±ì„ ëŒ€ê³  ì„œì„œ ë’¤í†µìˆ˜ê°€ ë²½ì— ë‹¿ë„ë¡ í•©ë‹ˆë‹¤. 2) í„±ì„ ë’¤ë¡œ ë‹¹ê¸°ë©° ëª© ì•ìª½ ê·¼ìœ¡ì„ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 3) ë¨¸ë¦¬ ê¼­ëŒ€ê¸°ë¥¼ ì²œì¥ ë°©í–¥ìœ¼ë¡œ ëŠ˜ë¦¬ë©° 10ì´ˆ ìœ ì§€í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ì›ë˜ ìì„¸ë¡œ ëŒì•„ì˜µë‹ˆë‹¤. 5íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê²½ì¶” ì •ë ¬ ê°œì„ , ìƒë¶€ ìŠ¹ëª¨ê·¼ ê¸´ì¥ ì™„í™”, ì‹¬ë¶€ ê²½ë¶€ êµ´ê·¼ ê°•í™”, ê±°ë¶ëª© ìì„¸ êµì •',
    precautions: 'ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ê³¼ë„í•œ í˜ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.'
  },
  'Swan Prep': {
    ko: 'ìŠ¤ì™„ ì¤€ë¹„',
    description: 'í‰ì¶” ì‹ ì „ì„ ìœ ë„í•˜ë©´ì„œ í•˜ë¶€ ìŠ¹ëª¨ê·¼ì„ ê°•í™”í•˜ëŠ” ë™ì‘ì…ë‹ˆë‹¤. ë³µë¶€ì™€ ë‘”ê·¼ì„ í™œì„±í™”í•˜ì—¬ ì²™ì¶”ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì§€ì§€í•˜ë©´ì„œ ìƒì²´ë¥¼ ë“¤ì–´ì˜¬ë¦½ë‹ˆë‹¤.',
    instructions: '1) ì—ë“œë¦° ìì„¸ì—ì„œ ì†ë°”ë‹¥ì„ ì–´ê¹¨ ì˜†ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ì™€ ë‘”ê·¼ì„ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤. 3) ìƒì²´ë¥¼ ì²œì²œíˆ ë“¤ì–´ì˜¬ë¦¬ë©° ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìë‹ˆë‹¤. 4) ëª©ì€ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ì¥í•˜ì—¬ í„±ì´ ì•ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤. 5) 5-10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ë‚´ë ¤ì˜µë‹ˆë‹¤. 5íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'í‰ì¶” ì‹ ì „ ê°œì„ , í•˜ë¶€ ìŠ¹ëª¨ê·¼ ê°•í™”, ì–´ê¹¨ë¼ˆ ì•ˆì •í™”, ê±°ë¶ëª© ìì„¸ ë³´ì¡° êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë†’ì´ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Pulling Straps': {
    ko: 'í’€ë§ ìŠ¤íŠ¸ë©',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ ê²¬ê°‘ í›„ë°© ì•ˆì •í™” ìš´ë™ì…ë‹ˆë‹¤. ì–´ê¹¨ë¼ˆë¥¼ í›„ì¸ì‹œí‚¤ê³  í•˜ë¶€ ìŠ¹ëª¨ê·¼ì„ í™œì„±í™”í•˜ì—¬ ë¼ìš´ë“œ ìˆ„ë”ì™€ ê±°ë¶ëª© ìì„¸ë¥¼ êµì •í•©ë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ì•‰ì•„ ìŠ¤íŠ¸ë©ì„ ì¡ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) íŒ”ì„ ì•ìœ¼ë¡œ ë»—ì€ ìƒíƒœì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤. 4) ì–´ê¹¨ë¼ˆë¥¼ ëª¨ìœ¼ë©° íŒ”ê¿ˆì¹˜ë¥¼ ë’¤ë¡œ ë‹¹ê¹ë‹ˆë‹¤. 5) ì–´ê¹¨ë¼ˆê°€ ì•„ë˜ë¡œ ëˆŒëŸ¬ì§€ë„ë¡ ì˜ì‹í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê²¬ê°‘ í›„ì¸ ê°•í™”, í•˜ë¶€ ìŠ¹ëª¨ê·¼ í™œì„±í™”, ë¼ìš´ë“œ ìˆ„ë” êµì •, ì–´ê¹¨ ì•ˆì •ì„± í–¥ìƒ',
    precautions: 'ëª©ì„ ì•ìœ¼ë¡œ ë‚´ë°€ì§€ ì•Šê³ , ì–´ê¹¨ë¥¼ ì˜¬ë¦¬ì§€ ì•Šë„ë¡ ì£¼ì˜í•©ë‹ˆë‹¤.'
  },
  'Tower Swan': {
    ko: 'íƒ€ì›Œ ìŠ¤ì™„',
    description: 'ìºë”œë½ íƒ€ì›Œë¥¼ ì‚¬ìš©í•œ í‰ì¶” ì‹ ì „ ë° ê²¬ê°‘ í›„ë°© ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©´ì„œ ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìœ„ì¹˜ì‹œí‚¤ê³  í‰ì¶” ê°€ë™ì„±ì„ ê°œì„ í•©ë‹ˆë‹¤.',
    instructions: '1) ìºë”œë½ íƒ€ì›Œ ì•ì— ì—ë“œë¦½ë‹ˆë‹¤. 2) íŒ”ì„ íƒ€ì›Œ ë°”ì— ì˜¬ë ¤ë†“ê³  ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 3) ìƒì²´ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©° ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìë‹ˆë‹¤. 4) í‰ì¶”ë¥¼ ì°¨ë¡€ë¡œ ì‹ ì „ì‹œí‚¤ë©° ì²™ì¶”ë¥¼ ì—°ì¥í•©ë‹ˆë‹¤. 5) 5-10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ë‚´ë ¤ì˜µë‹ˆë‹¤. 5íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'í‰ì¶” ì‹ ì „ ê°œì„ , ì–´ê¹¨ë¼ˆ ì•ˆì •í™”, í•˜ë¶€ ìŠ¹ëª¨ê·¼ ê°•í™”, ê±°ë¶ëª© ìì„¸ êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Press Down Front': {
    ko: 'í”„ë ˆìŠ¤ ë‹¤ìš´ í”„ë¡ íŠ¸',
    description: 'í•„ë¼í…ŒìŠ¤ ì²´ì–´ë¥¼ ì‚¬ìš©í•œ ê²½ì¶” ì •ë ¬ ë° ì „ê±°ê·¼ í™œì„±í™” ìš´ë™ì…ë‹ˆë‹¤. íŒ”ì„ ì•„ë˜ë¡œ ëˆ„ë¥´ë©´ì„œ ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •í™”í•˜ê³  ê²½ì¶”ë¥¼ ì¤‘ë¦½ ìœ„ì¹˜ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.',
    instructions: '1) ì²´ì–´ì— ì•‰ì•„ ì†ë°”ë‹¥ì„ íŒ”ê±¸ì´ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) íŒ”ì„ ì•„ë˜ë¡œ ëˆ„ë¥´ë©´ì„œ ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤. 4) ëª©ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ì¥í•˜ì—¬ í„±ì´ ì•ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤. 5) 5-10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê²½ì¶” ì •ë ¬ ê°œì„ , ì „ê±°ê·¼ í™œì„±í™”, ì–´ê¹¨ë¼ˆ ì•ˆì •í™”, ê±°ë¶ëª© ìì„¸ êµì •',
    precautions: 'ì–´ê¹¨ë¥¼ ì˜¬ë¦¬ì§€ ì•Šê³ , ëª©ì— ê³¼ë„í•œ ê¸´ì¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.'
  },
  'Swan on Ladder Barrel': {
    ko: 'ë˜ë” ë°°ëŸ´ ìŠ¤ì™„',
    description: 'ë˜ë” ë°°ëŸ´ì„ ì‚¬ìš©í•œ í‰ì¶” ê°€ë™ì„± ë° ìŠ¹ëª¨ê·¼ í•˜ë¶€ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ í‰ì¶”ë¥¼ ì‹ ì „ì‹œí‚¤ê³  ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë˜ë” ë°°ëŸ´ì— ë“±ì„ ëŒ€ê³  ì•‰ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤. 3) ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ í‰ì¶”ë¥¼ ì°¨ë¡€ë¡œ ì‹ ì „ì‹œí‚µë‹ˆë‹¤. 4) ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìœ¼ë©° í•˜ë¶€ ìŠ¹ëª¨ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 5) 5-10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 5íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'í‰ì¶” ê°€ë™ì„± í–¥ìƒ, ìŠ¹ëª¨ê·¼ í•˜ë¶€ ê°•í™”, ì–´ê¹¨ë¼ˆ ì•ˆì •í™”, ê±°ë¶ëª© ìì„¸ ë³´ì¡° êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  
  // ë¼ìš´ë“œ ìˆ„ë”(RSP) ê´€ë ¨ ìš´ë™
  'Prone Scapular Retraction': {
    ko: 'í”„ë¡  ì‚¬íˆ¬ë¼ ê²¬ê°‘ê³¨ í›„ì¸',
    description: 'ì—ë“œë¦° ìì„¸ì—ì„œ ì–´ê¹¨ë¼ˆë¥¼ í›„ì¸ì‹œí‚¤ëŠ” ìš´ë™ì…ë‹ˆë‹¤. ëŠ¥í˜•ê·¼ê³¼ ì¤‘ë¶€ ìŠ¹ëª¨ê·¼ì„ í™œì„±í™”í•˜ì—¬ ë¼ìš´ë“œ ìˆ„ë”ë¥¼ êµì •í•©ë‹ˆë‹¤.',
    instructions: '1) ì—ë“œë¦° ìì„¸ì—ì„œ íŒ”ì„ ì˜†ìœ¼ë¡œ ë»—ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤. 3) ì–´ê¹¨ë¼ˆë¥¼ ëª¨ìœ¼ë©° íŒ”ì„ ì•½ê°„ ë“¤ì–´ì˜¬ë¦½ë‹ˆë‹¤. 4) ì–´ê¹¨ë¼ˆê°€ ì•„ë˜ë¡œ ëˆŒëŸ¬ì§€ë„ë¡ ì˜ì‹í•˜ë©° 10ì´ˆ ìœ ì§€í•©ë‹ˆë‹¤. 5) ì²œì²œíˆ ë‚´ë ¤ì˜µë‹ˆë‹¤. 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê²¬ê°‘ í›„ì¸ ê°•í™”, ëŠ¥í˜•ê·¼ í™œì„±í™”, ë¼ìš´ë“œ ìˆ„ë” êµì •, ì–´ê¹¨ ì•ˆì •ì„± í–¥ìƒ',
    precautions: 'ì–´ê¹¨ë¥¼ ì˜¬ë¦¬ì§€ ì•Šê³ , ëª©ì— ê¸´ì¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.'
  },
  'Rowing Back / Pulling Straps': {
    ko: 'ë¡œì‰ ë°± / í’€ë§ ìŠ¤íŠ¸ë©',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ ê²¬ê°‘ ì•ˆì •í™” ìš´ë™ì…ë‹ˆë‹¤. íŒ”ì„ ë’¤ë¡œ ë‹¹ê¸°ë©´ì„œ ì–´ê¹¨ë¼ˆë¥¼ í›„ì¸ì‹œí‚¤ê³  í•˜ë¶€ ìŠ¹ëª¨ê·¼ì„ ê°•í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ì•‰ì•„ ìŠ¤íŠ¸ë©ì„ ì¡ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) íŒ”ì„ ì•ìœ¼ë¡œ ë»—ì€ ìƒíƒœì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤. 4) ì–´ê¹¨ë¼ˆë¥¼ ëª¨ìœ¼ë©° íŒ”ê¿ˆì¹˜ë¥¼ ë’¤ë¡œ ë‹¹ê¹ë‹ˆë‹¤. 5) ì–´ê¹¨ë¼ˆê°€ ì•„ë˜ë¡œ ëˆŒëŸ¬ì§€ë„ë¡ ì˜ì‹í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê²¬ê°‘ ì•ˆì •í™”, í•˜ë¶€ ìŠ¹ëª¨ê·¼ ê°•í™”, ë¼ìš´ë“œ ìˆ„ë” êµì •, ì–´ê¹¨ í›„ë°©ê·¼ í™œì„±í™”',
    precautions: 'ëª©ì„ ì•ìœ¼ë¡œ ë‚´ë°€ì§€ ì•Šê³ , ì–´ê¹¨ë¥¼ ì˜¬ë¦¬ì§€ ì•Šë„ë¡ ì£¼ì˜í•©ë‹ˆë‹¤.'
  },
  'Arm Springs - Extension': {
    ko: 'ì•” ìŠ¤í”„ë§ - ìµìŠ¤í…ì…˜',
    description: 'ìºë”œë½ ì•” ìŠ¤í”„ë§ì„ ì‚¬ìš©í•œ ì–´ê¹¨ í›„ë°©ê·¼ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. íŒ”ì„ ë’¤ë¡œ ë»—ìœ¼ë©´ì„œ ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •í™”í•˜ê³  í›„ë°© ê·¼ìœ¡ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ìºë”œë½ì— ì•‰ì•„ ì•” ìŠ¤í”„ë§ì„ ì¡ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) íŒ”ì„ ì•ìœ¼ë¡œ ë»—ì€ ìƒíƒœì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤. 4) ì–´ê¹¨ë¼ˆë¥¼ ëª¨ìœ¼ë©° íŒ”ì„ ë’¤ë¡œ ë»—ìŠµë‹ˆë‹¤. 5) ì–´ê¹¨ë¼ˆê°€ ì•„ë˜ë¡œ ëˆŒëŸ¬ì§€ë„ë¡ ì˜ì‹í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ì–´ê¹¨ í›„ë°©ê·¼ ê°•í™”, ê²¬ê°‘ ì•ˆì •í™”, ë¼ìš´ë“œ ìˆ„ë” êµì •, ì–´ê¹¨ ê°€ë™ì„± í–¥ìƒ',
    precautions: 'ì–´ê¹¨ë¥¼ ì˜¬ë¦¬ì§€ ì•Šê³ , ëª©ì— ê¸´ì¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.'
  },
  'Spine Stretch Forward (Chair Ver.)': {
    ko: 'ìŠ¤íŒŒì¸ ìŠ¤íŠ¸ë ˆì¹˜ í¬ì›Œë“œ (ì²´ì–´ ë²„ì „)',
    description: 'í•„ë¼í…ŒìŠ¤ ì²´ì–´ë¥¼ ì‚¬ìš©í•œ ê²¬ê°‘ ì•ˆì •í™” ë° í‰ì¶” ì‹ ì „ ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ ì•ìœ¼ë¡œ ìˆ™ì´ë©´ì„œ ì²™ì¶”ë¥¼ ì—°ì¥ì‹œí‚¤ê³  ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ì²´ì–´ì— ì•‰ì•„ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© ì•ìœ¼ë¡œ êµ½íˆë©´ì„œ ìƒì²´ë¥¼ ìˆ™ì…ë‹ˆë‹¤. 3) ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìœ¼ë©° ì•ˆì •í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© í´ë©´ì„œ ëŒì•„ì˜µë‹ˆë‹¤. 5) 5-10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê²¬ê°‘ ì•ˆì •í™”, í‰ì¶” ê°€ë™ì„± í–¥ìƒ, ì²™ì¶” ì—°ì¥, ë¼ìš´ë“œ ìˆ„ë” ë³´ì¡° êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Shoulder Extension on Barrel': {
    ko: 'ë°°ëŸ´ ì–´ê¹¨ ìµìŠ¤í…ì…˜',
    description: 'ë°°ëŸ´ì„ ì‚¬ìš©í•œ í‰ì¶” ê°€ë™ì„± ë° ì–´ê¹¨ í›„ì¸ê·¼ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ í‰ì¶”ë¥¼ ì‹ ì „ì‹œí‚¤ê³  ì–´ê¹¨ë¼ˆë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë°°ëŸ´ì— ë“±ì„ ëŒ€ê³  ì•‰ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤. 3) ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ í‰ì¶”ë¥¼ ì°¨ë¡€ë¡œ ì‹ ì „ì‹œí‚µë‹ˆë‹¤. 4) ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìœ¼ë©° í›„ì¸ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 5) 5-10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 5íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'í‰ì¶” ê°€ë™ì„± í–¥ìƒ, ì–´ê¹¨ í›„ì¸ê·¼ ê°•í™”, ì–´ê¹¨ë¼ˆ ì•ˆì •í™”, ë¼ìš´ë“œ ìˆ„ë” êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  
  // ê³¼ì „ê²½ì‚¬ ê³¨ë°˜ ê´€ë ¨ ìš´ë™
  'Pelvic Curl': {
    ko: 'í ë¹… ì»¬',
    description: 'ê³¨ë°˜ í›„ê²½ì‚¬ë¥¼ ìœ ë„í•˜ëŠ” ê¸°ë³¸ ë™ì‘ì…ë‹ˆë‹¤. ë³µë¶€ì™€ ë‘”ê·¼ì„ í™œì„±í™”í•˜ì—¬ ê³¨ë°˜ì„ ë’¤ë¡œ ê¸°ìš¸ì´ê³  ìš”ì¶” ì „ë§Œì„ ê°ì†Œì‹œí‚µë‹ˆë‹¤.',
    instructions: '1) ëˆ„ì›Œì„œ ë¬´ë¦ì„ êµ¬ë¶€ë¦¬ê³  ë°œì„ ë°”ë‹¥ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ê³¨ë°˜ì„ ë’¤ë¡œ ê¸°ìš¸ì´ë©° ì—‰ë©ì´ë¥¼ ì²œì²œíˆ ë“¤ì–´ì˜¬ë¦½ë‹ˆë‹¤. 4) ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© ë°”ë‹¥ì—ì„œ ë–¼ì–´ëƒ…ë‹ˆë‹¤. 5) ìµœê³ ì ì—ì„œ 5-10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ë‚´ë ¤ì˜µë‹ˆë‹¤. 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê³¨ë°˜ í›„ê²½ì‚¬ ìœ ë„, ë‘”ê·¼ ê°•í™”, ìš”ì¶” ì „ë§Œ ê°ì†Œ, ê³¨ë°˜ ì•ˆì •í™”',
    precautions: 'ëª© í†µì¦ì´ ìˆìœ¼ë©´ ë² ê°œë¥¼ ì‚¬ìš©í•˜ê³ , ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì…ë‹ˆë‹¤.'
  },
  'Dead Bug / Toe Tap': {
    ko: 'ë°ë“œ ë²„ê·¸ / í†  íƒ­',
    description: 'ë³µíš¡ê·¼ì„ í™œì„±í™”í•˜ëŠ” ì½”ì–´ ì•ˆì •í™” ìš´ë™ì…ë‹ˆë‹¤. íŒ”ê³¼ ë‹¤ë¦¬ë¥¼ ì›€ì§ì´ë©´ì„œ ë³µë¶€ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•˜ì—¬ ê³¨ë°˜ ì „ë°©ê²½ì‚¬ë¥¼ êµì •í•©ë‹ˆë‹¤.',
    instructions: '1) ëˆ„ì›Œì„œ ë¬´ë¦ì„ 90ë„ë¡œ êµ¬ë¶€ë¦¬ê³  íŒ”ì„ ìœ„ë¡œ ì˜¬ë¦½ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë°˜ëŒ€í¸ íŒ”ê³¼ ë‹¤ë¦¬ë¥¼ ì²œì²œíˆ ë‚´ë¦½ë‹ˆë‹¤. 4) ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° ì›ë˜ ìì„¸ë¡œ ëŒì•„ì˜µë‹ˆë‹¤. 5) ì¢Œìš° êµëŒ€ë¡œ 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ë³µíš¡ê·¼ í™œì„±í™”, ì½”ì–´ ì•ˆì •í™”, ê³¨ë°˜ ì „ë°©ê²½ì‚¬ êµì •, ìš”ì¶” ì•ˆì •ì„± í–¥ìƒ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Bridge on Reformer': {
    ko: 'ë¦¬í¬ë¨¸ ë¸Œë¦¿ì§€',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ í›„ë°© ì‚¬ìŠ¬ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ë‘”ê·¼ê³¼ í–„ìŠ¤íŠ¸ë§ì„ í™œì„±í™”í•˜ì—¬ ê³¨ë°˜ì„ ì•ˆì •í™”í•˜ê³  ìš”ì¶” ì „ë§Œì„ ê°ì†Œì‹œí‚µë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ëˆ„ì›Œ ë°œì„ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ê³¨ë°˜ì„ ë’¤ë¡œ ê¸°ìš¸ì´ë©° ì—‰ë©ì´ë¥¼ ì²œì²œíˆ ë“¤ì–´ì˜¬ë¦½ë‹ˆë‹¤. 4) ë‘”ê·¼ê³¼ í–„ìŠ¤íŠ¸ë§ì„ í™œì„±í™”í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'í›„ë°© ì‚¬ìŠ¬ ê°•í™”, ë‘”ê·¼ í™œì„±í™”, ê³¨ë°˜ ì•ˆì •í™”, ìš”ì¶” ì „ë§Œ ê°ì†Œ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ë² ê°œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.'
  },
  'Roll Down with Push Through Bar': {
    ko: 'ë¡¤ ë‹¤ìš´ (í‘¸ì‹œ ìŠ¤ë£¨ ë°”)',
    description: 'ìºë”œë½ í‘¸ì‹œ ìŠ¤ë£¨ ë°”ë¥¼ ì‚¬ìš©í•œ ë³µë¶€ ì½”ì–´ ì¡°ì ˆ ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ êµ½íˆë©´ì„œ ë³µíš¡ê·¼ì„ í™œì„±í™”í•˜ì—¬ ê³¨ë°˜ ì „ë°©ê²½ì‚¬ë¥¼ êµì •í•©ë‹ˆë‹¤.',
    instructions: '1) ìºë”œë½ì— ì•‰ì•„ í‘¸ì‹œ ìŠ¤ë£¨ ë°”ë¥¼ ì¡ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© êµ½íˆë©´ì„œ ìƒì²´ë¥¼ ì•ìœ¼ë¡œ ìˆ™ì…ë‹ˆë‹¤. 4) ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 5) 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ë³µë¶€ ì½”ì–´ ì¡°ì ˆ, ë³µíš¡ê·¼ í™œì„±í™”, ê³¨ë°˜ ì „ë°©ê²½ì‚¬ êµì •, ì²™ì¶” ê°€ë™ì„± í–¥ìƒ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Standing Hip Extension': {
    ko: 'ìŠ¤íƒ ë”© í™ ìµìŠ¤í…ì…˜',
    description: 'ì„œì„œ í•˜ëŠ” ë‘”ê·¼ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. í•œìª½ ë‹¤ë¦¬ë¥¼ ë’¤ë¡œ ë»—ìœ¼ë©´ì„œ ë‘”ê·¼ì„ í™œì„±í™”í•˜ì—¬ ê³¨ë°˜ì„ ì•ˆì •í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ì„œì„œ í•œìª½ ì†ì„ ë²½ì— ëŒ€ê³  ê· í˜•ì„ ìœ ì§€í•©ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) í•œìª½ ë‹¤ë¦¬ë¥¼ ë’¤ë¡œ ë»—ìœ¼ë©° ë‘”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ê³¨ë°˜ì´ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ë‘”ê·¼ ê°•í™”, ê³¨ë°˜ ì•ˆì •í™”, ìš”ì¶” ì „ë§Œ ê°ì†Œ, í•˜ì§€ í›„ë°© ì‚¬ìŠ¬ í™œì„±í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ê· í˜• ë¬¸ì œê°€ ìˆìœ¼ë©´ ë²½ì„ ì¡ìŠµë‹ˆë‹¤.'
  },
  'Short Box Round Back': {
    ko: 'ìˆ ë°•ìŠ¤ ë¼ìš´ë“œ ë°±',
    description: 'ìˆ ë°•ìŠ¤ë¥¼ ì‚¬ìš©í•œ ì½”ì–´ ë° í›„ë°© ì‚¬ìŠ¬ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ êµ½íˆë©´ì„œ ë³µë¶€ë¥¼ í™œì„±í™”í•˜ê³  ë‘”ê·¼ì„ ê°•í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ìˆ ë°•ìŠ¤ì— ì•‰ì•„ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© êµ½íˆë©´ì„œ ìƒì²´ë¥¼ ì•ìœ¼ë¡œ ìˆ™ì…ë‹ˆë‹¤. 3) ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 4) 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ì½”ì–´ ê°•í™”, í›„ë°© ì‚¬ìŠ¬ í™œì„±í™”, ê³¨ë°˜ ì „ë°©ê²½ì‚¬ êµì •, ì²™ì¶” ì•ˆì •ì„± í–¥ìƒ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  
  // í›„ê²½ì‚¬ ê³¨ë°˜ ê´€ë ¨ ìš´ë™
  'Leg Pull Front': {
    ko: 'ë ˆê·¸ í’€ í”„ë¡ íŠ¸',
    description: 'ì „ë°© ì‚¬ìŠ¬ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. í”Œë­í¬ ìì„¸ì—ì„œ í•œìª½ ë‹¤ë¦¬ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©´ì„œ ë³µë¶€ì™€ ëŒ€í‡´ì§ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) í”Œë­í¬ ìì„¸ì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) í•œìª½ ë‹¤ë¦¬ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©° ëŒ€í‡´ì§ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ê³¨ë°˜ì´ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ì „ë°© ì‚¬ìŠ¬ ê°•í™”, ë³µë¶€ í™œì„±í™”, ëŒ€í‡´ì§ê·¼ ê°•í™”, ê³¨ë°˜ í›„ê²½ì‚¬ êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ì–´ê¹¨ í†µì¦ì´ ìˆìœ¼ë©´ ë¬´ë¦ì„ ë‚´ë¦½ë‹ˆë‹¤.'
  },
  'Footwork - Parallel Heels': {
    ko: 'í’‹ì›Œí¬ - íŒ¨ëŸ´ë  íì¦ˆ',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ ê³ ê´€ì ˆ ì‹ ì „ í™œì„±í™” ìš´ë™ì…ë‹ˆë‹¤. ë°œë’¤ê¿ˆì¹˜ë¥¼ í’‹ë°”ì— ëŒ€ê³  ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ê³ ê´€ì ˆ ì‹ ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ëˆ„ì›Œ ë°œë’¤ê¿ˆì¹˜ë¥¼ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ê³ ê´€ì ˆì„ ì‹ ì „ì‹œí‚µë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ê³ ê´€ì ˆ ì‹ ì „ í™œì„±í™”, ì¥ìš”ê·¼ ê¸°ëŠ¥ì  ìˆ˜ì¶•, ê³¨ë°˜ í›„ê²½ì‚¬ êµì •, í•˜ì§€ ì „ë°© ì‚¬ìŠ¬ ê°•í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Leg Springs - Supine': {
    ko: 'ë ˆê·¸ ìŠ¤í”„ë§ - ìŠˆíŒŒì¸',
    description: 'ìºë”œë½ ë ˆê·¸ ìŠ¤í”„ë§ì„ ì‚¬ìš©í•œ ì¥ìš”ê·¼ ê¸°ëŠ¥ì  ìˆ˜ì¶• ìš´ë™ì…ë‹ˆë‹¤. ëˆ„ìš´ ìì„¸ì—ì„œ ë‹¤ë¦¬ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©´ì„œ ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ìºë”œë½ì— ëˆ„ì›Œ ë ˆê·¸ ìŠ¤í”„ë§ì— ë‹¤ë¦¬ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©° ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ë‚´ë¦¬ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ì¥ìš”ê·¼ ê¸°ëŠ¥ì  ìˆ˜ì¶•, ê³ ê´€ì ˆ êµ´ê³¡ í™œì„±í™”, ê³¨ë°˜ í›„ê²½ì‚¬ êµì •, í•˜ì§€ ì „ë°© ì‚¬ìŠ¬ ê°•í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Swan Press': {
    ko: 'ìŠ¤ì™„ í”„ë ˆìŠ¤',
    description: 'í•„ë¼í…ŒìŠ¤ ì²´ì–´ë¥¼ ì‚¬ìš©í•œ ìš”ì¶” ì‹ ì „ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ ì²™ì¶”ê¸°ë¦½ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ì²´ì–´ì— ì•‰ì•„ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© ë’¤ë¡œ ì –íˆë©´ì„œ ìƒì²´ë¥¼ ì—°ì¥í•©ë‹ˆë‹¤. 3) ì²™ì¶”ê¸°ë¦½ê·¼ì„ í™œì„±í™”í•˜ë©° 5-10ì´ˆ ìœ ì§€í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ìš”ì¶” ì‹ ì „ ê°•í™”, ì²™ì¶”ê¸°ë¦½ê·¼ í™œì„±í™”, ê³¨ë°˜ í›„ê²½ì‚¬ êµì •, ì²™ì¶” ê°€ë™ì„± í–¥ìƒ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Swan on Barrel': {
    ko: 'ë°°ëŸ´ ìŠ¤ì™„',
    description: 'ë°°ëŸ´ì„ ì‚¬ìš©í•œ ìš”ì¶” ê°€ë™ì„± í–¥ìƒ ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ ì²™ì¶”ë¥¼ ì‹ ì „ì‹œí‚¤ê³  ê°€ë™ì„±ì„ ê°œì„ í•©ë‹ˆë‹¤.',
    instructions: '1) ë°°ëŸ´ì— ë“±ì„ ëŒ€ê³  ì•‰ìŠµë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤. 3) ìƒì²´ë¥¼ ë’¤ë¡œ ì –íˆë©´ì„œ ì²™ì¶”ë¥¼ ì°¨ë¡€ë¡œ ì‹ ì „ì‹œí‚µë‹ˆë‹¤. 4) 5-10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 5) 5íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ìš”ì¶” ê°€ë™ì„± í–¥ìƒ, ì²™ì¶”ê¸°ë¦½ê·¼ í™œì„±í™”, ê³¨ë°˜ í›„ê²½ì‚¬ êµì •, ì²™ì¶” ì—°ì¥',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ëª© í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  
  // Xì ë‹¤ë¦¬ ê´€ë ¨ ìš´ë™
  'Side-Lying Leg Lift': {
    ko: 'ì‚¬ì´ë“œ ë¼ì‰ ë ˆê·¸ ë¦¬í”„íŠ¸',
    description: 'ì˜†ìœ¼ë¡œ ëˆ„ì›Œì„œ í•˜ëŠ” ì¤‘ë‘”ê·¼ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ë‹¤ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ë“¤ì–´ì˜¬ë¦¬ë©´ì„œ ê³ ê´€ì ˆ ì™¸ì „ê·¼ì„ í™œì„±í™”í•˜ì—¬ Xì ë‹¤ë¦¬ë¥¼ êµì •í•©ë‹ˆë‹¤.',
    instructions: '1) ì˜†ìœ¼ë¡œ ëˆ„ì›Œì„œ ì•„ë˜ìª½ íŒ”ë¡œ ë¨¸ë¦¬ë¥¼ ì§€ì§€í•©ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ìœ„ìª½ ë‹¤ë¦¬ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©° ì¤‘ë‘”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ê³¨ë°˜ì´ ì•ë’¤ë¡œ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 15íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ìœ¼ë¡œ ëŒì•„ì„œ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ì¤‘ë‘”ê·¼ ê°•í™”, ê³ ê´€ì ˆ ì™¸ì „ í™œì„±í™”, Xì ë‹¤ë¦¬ êµì •, ê³¨ë°˜ ì•ˆì •í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Side Splits': {
    ko: 'ì‚¬ì´ë“œ ìŠ¤í”Œë¦¿',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ ì™¸ì¸¡ ì•ˆì •í™” ìš´ë™ì…ë‹ˆë‹¤. ë‹¤ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ë²Œë¦¬ë©´ì„œ ê³ ê´€ì ˆ ì™¸ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ì•‰ì•„ ë‹¤ë¦¬ë¥¼ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ë²Œë¦¬ë©° ê³ ê´€ì ˆ ì™¸ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëª¨ìœ¼ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ì™¸ì¸¡ ì•ˆì •í™”, ê³ ê´€ì ˆ ì™¸ì „ ê°•í™”, Xì ë‹¤ë¦¬ êµì •, ê³¨ë°˜ ì•ˆì •ì„± í–¥ìƒ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Standing Hip Abduction': {
    ko: 'ìŠ¤íƒ ë”© í™ ì™¸ì „',
    description: 'ì„œì„œ í•˜ëŠ” ê³ ê´€ì ˆ ì™¸ì „ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. í•œìª½ ë‹¤ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ë»—ìœ¼ë©´ì„œ ì¤‘ë‘”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ì„œì„œ í•œìª½ ì†ì„ ë²½ì— ëŒ€ê³  ê· í˜•ì„ ìœ ì§€í•©ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) í•œìª½ ë‹¤ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ë»—ìœ¼ë©° ì¤‘ë‘”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ê³¨ë°˜ì´ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 15íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ê³ ê´€ì ˆ ì™¸ì „ ê°•í™”, ì¤‘ë‘”ê·¼ í™œì„±í™”, Xì ë‹¤ë¦¬ êµì •, ê³¨ë°˜ ì•ˆì •í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ê· í˜• ë¬¸ì œê°€ ìˆìœ¼ë©´ ë²½ì„ ì¡ìŠµë‹ˆë‹¤.'
  },
  'Step Up Lateral': {
    ko: 'ìŠ¤í… ì—… ë ˆí„°ëŸ´',
    description: 'ì˜†ìœ¼ë¡œ ì˜¬ë¼ê°€ëŠ” í•˜ì§€ ì™¸ì¸¡ ì•ˆì •ì„± ìš´ë™ì…ë‹ˆë‹¤. ë°•ìŠ¤ë¥¼ ì˜†ìœ¼ë¡œ ì˜¬ë¼ê°€ë©´ì„œ ê³ ê´€ì ˆ ì™¸ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë°•ìŠ¤ ì˜†ì— ì„œì„œ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) í•œìª½ ë‹¤ë¦¬ë¡œ ë°•ìŠ¤ì— ì˜¬ë¼ê°€ë©° ì¤‘ë‘”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 3) ê³¨ë°˜ì´ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 4) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'í•˜ì§€ ì™¸ì¸¡ ì•ˆì •ì„±, ê³ ê´€ì ˆ ì™¸ì „ ê°•í™”, Xì ë‹¤ë¦¬ êµì •, ê¸°ëŠ¥ì  ì›€ì§ì„ ê°œì„ ',
    precautions: 'ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ê· í˜• ë¬¸ì œê°€ ìˆìœ¼ë©´ ë²½ì„ ì¡ìŠµë‹ˆë‹¤.'
  },
  'Side Bend Stretch': {
    ko: 'ì‚¬ì´ë“œ ë²¤ë“œ ìŠ¤íŠ¸ë ˆì¹˜',
    description: 'ë°°ëŸ´ì„ ì‚¬ìš©í•œ ê³ ê´€ì ˆ ì •ë ¬ ë° ì•ˆì •ì„± ê°œì„  ìš´ë™ì…ë‹ˆë‹¤. ì˜†ìœ¼ë¡œ ê¸°ìš¸ë©´ì„œ ê³ ê´€ì ˆ ì™¸ì „ê·¼ì„ ìŠ¤íŠ¸ë ˆì¹­í•˜ê³  ì•ˆì •í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë°°ëŸ´ ì˜†ì— ì„œì„œ í•œìª½ ë‹¤ë¦¬ë¥¼ ë°°ëŸ´ì— ì˜¬ë¦½ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ì˜†ìœ¼ë¡œ ê¸°ìš¸ë©´ì„œ ê³ ê´€ì ˆ ì™¸ì „ê·¼ì„ ìŠ¤íŠ¸ë ˆì¹­í•©ë‹ˆë‹¤. 4) 30ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ìœ¼ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ê³ ê´€ì ˆ ì •ë ¬ ê°œì„ , ì™¸ì „ê·¼ ìŠ¤íŠ¸ë ˆì¹­, ì•ˆì •ì„± í–¥ìƒ, Xì ë‹¤ë¦¬ ë³´ì¡° êµì •',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  
  // Oì ë‹¤ë¦¬ ê´€ë ¨ ìš´ë™
  'Ball Squeeze Bridge': {
    ko: 'ë³¼ ìŠ¤í€´ì¦ˆ ë¸Œë¦¿ì§€',
    description: 'ë³¼ì„ ë¬´ë¦ ì‚¬ì´ì— ë¼ìš°ê³  í•˜ëŠ” ë‚´ì „ê·¼ í™œì„±í™” ìš´ë™ì…ë‹ˆë‹¤. ì—‰ë©ì´ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©´ì„œ ë‚´ì „ê·¼ì„ ìˆ˜ì¶•í•˜ì—¬ Oì ë‹¤ë¦¬ë¥¼ êµì •í•©ë‹ˆë‹¤.',
    instructions: '1) ëˆ„ì›Œì„œ ë¬´ë¦ì„ êµ¬ë¶€ë¦¬ê³  ë°œì„ ë°”ë‹¥ì— ë‘¡ë‹ˆë‹¤. 2) ë¬´ë¦ ì‚¬ì´ì— ë³¼ì„ ë¼ì›ë‹ˆë‹¤. 3) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 4) ë³¼ì„ ì¥ì–´ì§œë©° ì—‰ë©ì´ë¥¼ ë“¤ì–´ì˜¬ë¦½ë‹ˆë‹¤. 5) 10ì´ˆ ìœ ì§€ í›„ ì²œì²œíˆ ë‚´ë ¤ì˜µë‹ˆë‹¤. 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ë‚´ì „ê·¼ í™œì„±í™”, ë‘”ê·¼ ê°•í™”, Oì ë‹¤ë¦¬ êµì •, ê³¨ë°˜ ì•ˆì •í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Footwork - Small V Position': {
    ko: 'í’‹ì›Œí¬ - ìŠ¤ëª° V í¬ì§€ì…˜',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ ë‚´ì¸¡ê´‘ê·¼ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ë°œì„ ì‘ì€ Vì í˜•íƒœë¡œ ë‘ê³  ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ë‚´ì¸¡ ê·¼ìœ¡ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ëˆ„ì›Œ ë°œì„ ì‘ì€ Vì í˜•íƒœë¡œ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ë‚´ì¸¡ê´‘ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ë‚´ì¸¡ê´‘ê·¼ ê°•í™”, ë‚´ì „ê·¼ í™œì„±í™”, Oì ë‹¤ë¦¬ êµì •, ë¬´ë¦ ì •ë ¬ ê°œì„ ',
    precautions: 'ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì…ë‹ˆë‹¤.'
  },
  'Standing Leg Press - Adduction': {
    ko: 'ìŠ¤íƒ ë”© ë ˆê·¸ í”„ë ˆìŠ¤ - ë‚´ì „',
    description: 'ìºë”œë½ì„ ì‚¬ìš©í•œ ë‚´ì „ê·¼ ê°•í™” ìš´ë™ì…ë‹ˆë‹¤. ì„œì„œ ë‹¤ë¦¬ë¥¼ ì•ˆìª½ìœ¼ë¡œ ë‹¹ê¸°ë©´ì„œ ë‚´ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ìºë”œë½ ì˜†ì— ì„œì„œ í•œìª½ ë‹¤ë¦¬ë¥¼ ìŠ¤í”„ë§ì— ì—°ê²°í•©ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ì•ˆìª½ìœ¼ë¡œ ë‹¹ê¸°ë©° ë‚´ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ë‚´ì „ê·¼ ê°•í™”, ë‚´ì¸¡ ê·¼ìœ¡ í™œì„±í™”, Oì ë‹¤ë¦¬ êµì •, ê³¨ë°˜ ì•ˆì •í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Seated Adduction': {
    ko: 'ì‹œí‹°ë“œ ë‚´ì „',
    description: 'í•„ë¼í…ŒìŠ¤ ì²´ì–´ë¥¼ ì‚¬ìš©í•œ ë‚´ì¸¡ ê·¼ìœ¡ ì¡°ì ˆ ìš´ë™ì…ë‹ˆë‹¤. ì•‰ì•„ì„œ ë‹¤ë¦¬ë¥¼ ëª¨ìœ¼ë©´ì„œ ë‚´ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ì²´ì–´ì— ì•‰ì•„ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) ë‹¤ë¦¬ë¥¼ ëª¨ìœ¼ë©° ë‚´ì „ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 3) ê³¨ë°˜ì´ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ë‚´ì¸¡ ê·¼ìœ¡ ì¡°ì ˆ, ë‚´ì „ê·¼ í™œì„±í™”, Oì ë‹¤ë¦¬ êµì •, ê³¨ë°˜ ì•ˆì •í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Adductor Stretch on Barrel': {
    ko: 'ë°°ëŸ´ ë‚´ì „ê·¼ ìŠ¤íŠ¸ë ˆì¹˜',
    description: 'ë°°ëŸ´ì„ ì‚¬ìš©í•œ ë‚´ì „ê·¼ ê°€ë™ì„± í–¥ìƒ ìš´ë™ì…ë‹ˆë‹¤. ë‹¤ë¦¬ë¥¼ ë²Œë¦¬ë©´ì„œ ë‚´ì „ê·¼ì„ ìŠ¤íŠ¸ë ˆì¹­í•˜ê³  ê°€ë™ì„±ì„ ê°œì„ í•©ë‹ˆë‹¤.',
    instructions: '1) ë°°ëŸ´ì— ë“±ì„ ëŒ€ê³  ì•‰ì•„ ë‹¤ë¦¬ë¥¼ ë²Œë¦½ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‚´ì „ê·¼ì„ ìŠ¤íŠ¸ë ˆì¹­í•˜ë©° 30ì´ˆ ìœ ì§€í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤.',
    benefits: 'ë‚´ì „ê·¼ ê°€ë™ì„± í–¥ìƒ, ìŠ¤íŠ¸ë ˆì¹­, Oì ë‹¤ë¦¬ ë³´ì¡° êµì •, ê³ ê´€ì ˆ ê°€ë™ì„± ê°œì„ ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  
  // ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© ê´€ë ¨ ìš´ë™
  'Scooter': {
    ko: 'ìŠ¤ì¿ í„°',
    description: 'ë¦¬í¬ë¨¸ë¥¼ ì‚¬ìš©í•œ ë‘”ê·¼ ì‹ ì „ ì¡°ì ˆ ìš´ë™ì…ë‹ˆë‹¤. í•œìª½ ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ë‘”ê·¼ì„ í™œì„±í™”í•˜ì—¬ ì²´ì¤‘ ì¤‘ì‹¬ì„ í›„ë°©ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ì— ì•‰ì•„ í•œìª½ ë‹¤ë¦¬ë¥¼ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ë‘”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ë‘”ê·¼ ì‹ ì „ ì¡°ì ˆ, ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°© ì´ë™, ê³¨ë°˜ ì•ˆì •í™”, í•˜ì§€ í›„ë°© ì‚¬ìŠ¬ í™œì„±í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Tower Roll Up': {
    ko: 'íƒ€ì›Œ ë¡¤ ì—…',
    description: 'ìºë”œë½ íƒ€ì›Œë¥¼ ì‚¬ìš©í•œ ì½”ì–´ í™œì„±í™” ìš´ë™ì…ë‹ˆë‹¤. ìƒì²´ë¥¼ êµ½íˆë©´ì„œ ë³µë¶€ë¥¼ í™œì„±í™”í•˜ì—¬ ì²´ì¤‘ ì¤‘ì‹¬ì„ ì¡°ì ˆí•©ë‹ˆë‹¤.',
    instructions: '1) ìºë”œë½ íƒ€ì›Œ ì•ì— ì•‰ì•„ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) ì²™ì¶”ë¥¼ í•˜ë‚˜ì”© êµ½íˆë©´ì„œ ìƒì²´ë¥¼ ì•ìœ¼ë¡œ ìˆ™ì…ë‹ˆë‹¤. 3) ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° ì²œì²œíˆ ëŒì•„ì˜µë‹ˆë‹¤. 4) 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤.',
    benefits: 'ì½”ì–´ í™œì„±í™”, ë³µë¶€ ê°•í™”, ì²´ì¤‘ ì¤‘ì‹¬ ì¡°ì ˆ, ì²™ì¶” ì•ˆì •ì„± í–¥ìƒ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë³µë¶€ê°€ íŠ€ì–´ë‚˜ì˜¤ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Standing Leg Press': {
    ko: 'ìŠ¤íƒ ë”© ë ˆê·¸ í”„ë ˆìŠ¤',
    description: 'í•„ë¼í…ŒìŠ¤ ì²´ì–´ë¥¼ ì‚¬ìš©í•œ í›„ë°© ì²´ì¤‘ ì´ë™ í›ˆë ¨ì…ë‹ˆë‹¤. ì„œì„œ ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ì²´ì¤‘ ì¤‘ì‹¬ì„ í›„ë°©ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.',
    instructions: '1) ì²´ì–´ ì˜†ì— ì„œì„œ í•œìª½ ë‹¤ë¦¬ë¥¼ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ì²´ì¤‘ì„ í›„ë°©ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'í›„ë°© ì²´ì¤‘ ì´ë™ í›ˆë ¨, ë‘”ê·¼ í™œì„±í™”, ì²´ì¤‘ ì¤‘ì‹¬ ì¡°ì ˆ, ê¸°ëŠ¥ì  ì›€ì§ì„ ê°œì„ ',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ê· í˜• ë¬¸ì œê°€ ìˆìœ¼ë©´ ë²½ì„ ì¡ìŠµë‹ˆë‹¤.'
  },
  
  // ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°© ê´€ë ¨ ìš´ë™
  'Standing Lunge': {
    ko: 'ìŠ¤íƒ ë”© ëŸ°ì§€',
    description: 'ì„œì„œ í•˜ëŠ” ê³ ê´€ì ˆ ì‹ ì „/êµ´ê³¡ ë°¸ëŸ°ìŠ¤ ìš´ë™ì…ë‹ˆë‹¤. ì•ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ì¥ìš”ê·¼ì„ í™œì„±í™”í•˜ì—¬ ì²´ì¤‘ ì¤‘ì‹¬ì„ ì „ë°©ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.',
    instructions: '1) ë¦¬í¬ë¨¸ ì˜†ì— ì„œì„œ í•œìª½ ë‹¤ë¦¬ë¥¼ í’‹ë°”ì— ë‘¡ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ì•ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ê³ ê´€ì ˆ ì‹ ì „/êµ´ê³¡ ë°¸ëŸ°ìŠ¤, ì¥ìš”ê·¼ í™œì„±í™”, ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© ì´ë™, í•˜ì§€ ì „ë°© ì‚¬ìŠ¬ ê°•í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  },
  'Step Up Front': {
    ko: 'ìŠ¤í… ì—… í”„ë¡ íŠ¸',
    description: 'ì•ìœ¼ë¡œ ì˜¬ë¼ê°€ëŠ” í•˜ì§€ ì „ë°© ì•ˆì •í™” ìš´ë™ì…ë‹ˆë‹¤. ë°•ìŠ¤ë¥¼ ì•ìœ¼ë¡œ ì˜¬ë¼ê°€ë©´ì„œ ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë°•ìŠ¤ ì•ì— ì„œì„œ ë³µë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤. 2) í•œìª½ ë‹¤ë¦¬ë¡œ ë°•ìŠ¤ì— ì˜¬ë¼ê°€ë©° ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 3) ê³¨ë°˜ì´ ê¸°ìš¸ì–´ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 4) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'í•˜ì§€ ì „ë°© ì•ˆì •í™”, ì¥ìš”ê·¼ í™œì„±í™”, ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© ì´ë™, ê¸°ëŠ¥ì  ì›€ì§ì„ ê°œì„ ',
    precautions: 'ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ê· í˜• ë¬¸ì œê°€ ìˆìœ¼ë©´ ë²½ì„ ì¡ìŠµë‹ˆë‹¤.'
  },
  'Lunge on Barrel': {
    ko: 'ë°°ëŸ´ ëŸ°ì§€',
    description: 'ë°°ëŸ´ì„ ì‚¬ìš©í•œ ê³ ê´€ì ˆ ì „ë°©ì´ë™ í›ˆë ¨ì…ë‹ˆë‹¤. í•œìª½ ë‹¤ë¦¬ë¥¼ ì•ìœ¼ë¡œ ë‚´ë°€ë©´ì„œ ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.',
    instructions: '1) ë°°ëŸ´ ì•ì— ì„œì„œ í•œìª½ ë‹¤ë¦¬ë¥¼ ë°°ëŸ´ì— ì˜¬ë¦½ë‹ˆë‹¤. 2) ë³µë¶€ë¥¼ ìˆ˜ì¶•í•˜ì—¬ ì²™ì¶”ë¥¼ ì¤‘ë¦½ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. 3) ì•ë‹¤ë¦¬ë¥¼ ë°€ë©´ì„œ ì¥ìš”ê·¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 4) ì²œì²œíˆ ëŒì•„ì˜¤ë©° 10íšŒ ë°˜ë³µí•©ë‹ˆë‹¤. 5) ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¡œ êµëŒ€í•©ë‹ˆë‹¤.',
    benefits: 'ê³ ê´€ì ˆ ì „ë°©ì´ë™ í›ˆë ¨, ì¥ìš”ê·¼ í™œì„±í™”, ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© ì´ë™, í•˜ì§€ ì „ë°© ì‚¬ìŠ¬ ê°•í™”',
    precautions: 'ìš”í†µì´ ìˆìœ¼ë©´ ë²”ìœ„ë¥¼ ì¤„ì´ê³ , ë¬´ë¦ í†µì¦ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.'
  }
};

// í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•œ ê¸°ì¡´ pilatesData ìœ ì§€
const pilatesData = {
  'ëª© ì‹ ì „ê·¼ ê¸´ì¥': {
    ë§¤íŠ¸: ['Roll-Up', 'Spine Stretch Forward'],
    ë¦¬í¬ë¨¸: ['Neck Stretch on Box'],
    ìºë”œë½: ['Tower - Arm Springs'],
    ì²´ì–´: ['Tricep Dips'],
    ë°”ë : ['Chest Stretch']
  },
  'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥': {
    ë§¤íŠ¸: ['Arm Circles', 'Swimming Prep'],
    ë¦¬í¬ë¨¸: ['Rowing - From Chest'],
    ìºë”œë½: ['Arm Springs - Chest Expansion'],
    ì²´ì–´: ['Tricep Press'],
    ë°”ë : ['Side Stretch Over']
  },
  'ì „ë°©ì–´ê¹¨ìì„¸': {
    ë§¤íŠ¸: ['Swan Dive', 'T-Raise'],
    ë¦¬í¬ë¨¸: ['Backstroke', 'Pulling Straps'],
    ìºë”œë½: ['Push Through Bar'],
    ì²´ì–´: ['Push Down - Front'],
    ë°”ë : ['Chest Expansion']
  },
  'ì–´ê¹¨ì•ˆì •ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Plank to Pike', 'Side Plank'],
    ë¦¬í¬ë¨¸: ['Long Stretch Series'],
    ìºë”œë½: ['Arm Springs - Bug'],
    ì²´ì–´: ['Mountain Climber'],
    ë°”ë : ['Side Arm Work']
  },
  'íšŒì „ê·¼ê°œ ë¶ˆê· í˜•': {
    ë§¤íŠ¸: ['Side Lying Arm Series'],
    ë¦¬í¬ë¨¸: ['Arm Work - Salute'],
    ìºë”œë½: ['Tower - Rotation'],
    ì²´ì–´: ['Seated Rotation'],
    ë°”ë : ['Spiral Stretch']
  },
  'ë³µì§ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['The Hundred', 'Teaser'],
    ë¦¬í¬ë¨¸: ['Stomach Series - Hundred'],
    ìºë”œë½: ['Roll Down Bar'],
    ì²´ì–´: ['Teaser Prep'],
    ë°”ë : ['Sit Up Series']
  },
  'ë³µì‚¬ê·¼ ë¶ˆê· í˜•': {
    ë§¤íŠ¸: ['Criss Cross', 'Saw'],
    ë¦¬í¬ë¨¸: ['Short Box - Twist'],
    ìºë”œë½: ['Twist & Reach'],
    ì²´ì–´: ['Side Bend'],
    ë°”ë : ['Twist on Barrel']
  },
  'ê¹Šì€ì½”ì–´ ì•½í™”': {
    ë§¤íŠ¸: ['Dead Bug', 'Modified Hundred'],
    ë¦¬í¬ë¨¸: ['Footwork - Parallel'],
    ìºë”œë½: ['Breathing with Springs'],
    ì²´ì–´: ['Seated Balance'],
    ë°”ë : ['Core Integration']
  },
  'í‰ì¶” ê³¼í›„ë§Œ': {
    ë§¤íŠ¸: ['Swan', 'Extension Series'],
    ë¦¬í¬ë¨¸: ['Short Box - Arch'],
    ìºë”œë½: ['Monkey Stretch'],
    ì²´ì–´: ['Back Extension'],
    ë°”ë : ['Chest Opening']
  },
  'ìš”ì¶” ê³¼ì „ë§Œ': {
    ë§¤íŠ¸: ['Pelvic Curl', 'Imprint & Release'],
    ë¦¬í¬ë¨¸: ['Pelvic Press', 'Knee Stretches'],
    ìºë”œë½: ['Tower - Hip Work'],
    ì²´ì–´: ['Hip Flexor Stretch'],
    ë°”ë : ['Hip Opening']
  },
  'ì²™ì¶”ê¸°ë¦½ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Swimming', 'Rocking'],
    ë¦¬í¬ë¨¸: ['Long Back Stretch'],
    ìºë”œë½: ['Back Extension Springs'],
    ì²´ì–´: ['Swan on Chair'],
    ë°”ë : ['Round Back']
  },
  'ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ë‹¨ì¶•': {
    ë§¤íŠ¸: ['Hip Flexor Stretch', 'Lunge'],
    ë¦¬í¬ë¨¸: ['Lunge Series', 'Runner Stretch'],
    ìºë”œë½: ['Tower - Hip Stretch'],
    ì²´ì–´: ['Standing Lunge'],
    ë°”ë : ['Hip Flexor Series']
  },
  'ë‘”ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Bridge Series', 'Clam'],
    ë¦¬í¬ë¨¸: ['Footwork - RelevÃ©', 'Leg Press'],
    ìºë”œë½: ['Leg Springs - Circles'],
    ì²´ì–´: ['Glute Press Back'],
    ë°”ë : ['Hip Extension']
  },
  'ê³¨ë°˜ ë¶ˆì•ˆì •': {
    ë§¤íŠ¸: ['Single Leg Bridge', 'Single Leg Stretch'],
    ë¦¬í¬ë¨¸: ['Single Leg Work'],
    ìºë”œë½: ['Leg Springs - Adduction'],
    ì²´ì–´: ['Standing Balance'],
    ë°”ë : ['Stability Challenge']
  },
  'ëŒ€í‡´ì‚¬ë‘ê·¼ ì•½í™”': {
    ë§¤íŠ¸: ['Wall Squat', 'Single Leg Squat'],
    ë¦¬í¬ë¨¸: ['Footwork - Heels', 'Squats'],
    ìºë”œë½: ['Leg Press Springs'],
    ì²´ì–´: ['Standing Press Down'],
    ë°”ë : ['Leg Strengthening']
  },
  'í–„ìŠ¤íŠ¸ë§ ë‹¨ì¶•': {
    ë§¤íŠ¸: ['Leg Pull Front', 'Roll Over'],
    ë¦¬í¬ë¨¸: ['Hamstring Stretch', 'Tendon Stretch'],
    ìºë”œë½: ['Tower - Leg Stretch'],
    ì²´ì–´: ['Leg Pull Back'],
    ë°”ë : ['Hip Flexor Stretch']
  },
  'ì¢…ì•„ë¦¬ ê·¼ìœ¡ ê¸´ì¥': {
    ë§¤íŠ¸: ['Calf Stretch', 'Ankle Circles'],
    ë¦¬í¬ë¨¸: ['Calf Raises', 'Tendon Stretch'],
    ìºë”œë½: ['Foot Corrector Work'],
    ì²´ì–´: ['Heel Raises'],
    ë°”ë : ['Ankle Mobility']
  }
};

// ê·¼ìœ¡ ì´ë¦„ì„ í•„ë¼í…ŒìŠ¤ ë¬¸ì œë¡œ ë§¤í•‘
function mapMuscleToPilatesIssue(muscleName) {
  const mapping = {
    'ìƒë¶€ìŠ¹ëª¨ê·¼': 'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥',
    'ê²¬ê°‘ê±°ê·¼': 'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥',
    'SCM': 'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥',
    'í‰ì‡„ìœ ëŒê·¼': 'ìƒë¶€ìŠ¹ëª¨ê·¼ ê³¼ê¸´ì¥',
    'ì‹¬ë¶€ê²½ë¶€êµ´ê·¼': 'ëª© êµ´ê³¡ê·¼ ì•½í™”',
    'ì „ê±°ê·¼': 'ëª© êµ´ê³¡ê·¼ ì•½í™”',
    'í•˜ë¶€ìŠ¹ëª¨ê·¼': 'ì „ë°©ì–´ê¹¨ìì„¸',
    'ì¥ìš”ê·¼': 'ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ë‹¨ì¶•',
    'ìš”ì¶”ê¸°ë¦½ê·¼': 'ìš”ì¶” ê³¼ì „ë§Œ',
    'ëŒ€í‡´ì§ê·¼': 'ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ë‹¨ì¶•',
    'í‰ìš”ê·¼ë§‰': 'ìš”ì¶” ê³¼ì „ë§Œ',
    'ë³µíš¡ê·¼': 'ê¹Šì€ì½”ì–´ ì•½í™”',
    'ë‘”ê·¼': 'ë‘”ê·¼ ì•½í™”',
    'ëŒ€ë‘”ê·¼': 'ë‘”ê·¼ ì•½í™”',
    'ì¤‘ë‘”ê·¼': 'ë‘”ê·¼ ì•½í™”',
    'í•˜ë‘”ê·¼': 'ë‘”ê·¼ ì•½í™”',
    'ë³µì§ê·¼': 'ë³µì§ê·¼ ì•½í™”',
    'ëŒ€í‡´ì‚¬ë‘ê·¼': 'ëŒ€í‡´ì‚¬ë‘ê·¼ ì•½í™”',
    'í–„ìŠ¤íŠ¸ë§': 'í–„ìŠ¤íŠ¸ë§ ë‹¨ì¶•',
    'ë¹„ë³µê·¼': 'ì¢…ì•„ë¦¬ ê·¼ìœ¡ ê¸´ì¥',
    'ê°€ìë¯¸ê·¼': 'ì¢…ì•„ë¦¬ ê·¼ìœ¡ ê¸´ì¥',
    'ìŠ¬ì™€ê·¼': 'í–„ìŠ¤íŠ¸ë§ ë‹¨ì¶•'
  };
  return mapping[muscleName] || null;
}

// í•„ë¼í…ŒìŠ¤ ë™ì‘ ì¶”ì²œ í•¨ìˆ˜
function recommendPilates(tight, weak) {
  const pilatesIssues = new Map();
  
  // ê¸´ì¥ëœ ê·¼ìœ¡ì— ëŒ€í•œ í•„ë¼í…ŒìŠ¤
  tight.forEach(muscle => {
    const issue = mapMuscleToPilatesIssue(muscle);
    if(issue && pilatesData[issue]) {
      if(!pilatesIssues.has(issue)) {
        pilatesIssues.set(issue, { type: 'ê¸´ì¥', muscles: [], pilates: pilatesData[issue] });
      }
      pilatesIssues.get(issue).muscles.push(muscle);
    }
  });
  
  // ì•½í™”ëœ ê·¼ìœ¡ì— ëŒ€í•œ í•„ë¼í…ŒìŠ¤
  weak.forEach(muscle => {
    const issue = mapMuscleToPilatesIssue(muscle);
    if(issue && pilatesData[issue]) {
      if(!pilatesIssues.has(issue)) {
        pilatesIssues.set(issue, { type: 'ì•½í™”', muscles: [], pilates: pilatesData[issue] });
      }
      pilatesIssues.get(issue).muscles.push(muscle);
    }
  });
  
  return Array.from(pilatesIssues.entries()).map(([issue, data]) => ({
    issue,
    type: data.type,
    muscles: [...new Set(data.muscles)],
    pilates: data.pilates
  }));
}
const internalAngle = (a,b,c) => {
  const ab = Math.atan2(a.y - b.y, a.x - b.x);
  const cb = Math.atan2(c.y - b.y, c.x - b.x);
  let d = Math.abs(ab - cb);
  if(d > Math.PI) d = 2 * Math.PI - d;
  return d;
};

// ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ í—¬í¼ í•¨ìˆ˜
function addMobileTouchSupport(element, handler) {
  if(!element) return;
  
  // í´ë¦­ ì´ë²¤íŠ¸
  element.addEventListener('click', handler, { passive: true });
  
  // í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ ëŒ€ì‘)
  let touchStartTime = 0;
  let touchMoved = false;
  
  element.addEventListener('touchstart', (e) => {
    touchStartTime = Date.now();
    touchMoved = false;
  }, { passive: true });
  
  element.addEventListener('touchmove', () => {
    touchMoved = true;
  }, { passive: true });
  
  element.addEventListener('touchend', (e) => {
    // í„°ì¹˜ê°€ ì´ë™í–ˆê±°ë‚˜ ë„ˆë¬´ ê¸¸ë©´ í´ë¦­ìœ¼ë¡œ ê°„ì£¼í•˜ì§€ ì•ŠìŒ
    if(touchMoved || (Date.now() - touchStartTime) > 500) {
      return;
    }
    e.preventDefault();
    e.stopPropagation();
    handler(e);
  }, { passive: false });
}

// Before/After ì„¸ì…˜ ì „í™˜ ë²„íŠ¼ (DOM ë¡œë“œ í›„ ì•ˆì „í•˜ê²Œ ì—°ê²°)
function initSessionButtons() {
  console.log("initSessionButtons í˜¸ì¶œë¨, readyState:", document.readyState);
  const btnBefore = document.getElementById("btnBefore");
  const btnAfter = document.getElementById("btnAfter");
  const btnOrientationSide = document.getElementById("btnOrientationSide");
  const btnOrientationFront = document.getElementById("btnOrientationFront");
  
  console.log("ë²„íŠ¼ ìš”ì†Œ:", {btnBefore, btnAfter, btnOrientationSide, btnOrientationFront});
  
  if(btnBefore) {
    addMobileTouchSupport(btnBefore, () => {
      console.log("Before ë²„íŠ¼ í´ë¦­ë¨");
      switchSession("Before");
    });
  } else {
    console.error("btnBeforeë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
  }
  
  if(btnAfter) {
    addMobileTouchSupport(btnAfter, () => {
      console.log("After ë²„íŠ¼ í´ë¦­ë¨");
      switchSession("After");
    });
  } else {
    console.error("btnAfterë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
  }
  
  if(btnOrientationSide) {
    addMobileTouchSupport(btnOrientationSide, () => {
      console.log("ì˜†ëª¨ìŠµ ë²„íŠ¼ í´ë¦­ë¨");
      setOrientation("side", { manual: true });
    });
  } else {
    console.error("btnOrientationSideë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
  }
  
  if(btnOrientationFront) {
    addMobileTouchSupport(btnOrientationFront, () => {
      console.log("ì •ë©´ ë²„íŠ¼ í´ë¦­ë¨");
      setOrientation("front", { manual: true });
    });
  } else {
    console.error("btnOrientationFrontë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
  }
  
  console.log("initSessionButtons ì™„ë£Œ");
}

// DOM ë¡œë“œ í›„ ë²„íŠ¼ ì´ë²¤íŠ¸ ì´ˆê¸°í™” (ì£¼ì„ ì²˜ë¦¬ - ì•„ë˜ ë‘ ë²ˆì§¸ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ì—ì„œ í†µí•© ì²˜ë¦¬)
// if(document.readyState === 'loading') {
//   console.log("DOMì´ ì•„ì§ ë¡œë”© ì¤‘, DOMContentLoaded ì´ë²¤íŠ¸ ëŒ€ê¸°");
//   document.addEventListener('DOMContentLoaded', () => {
//     console.log("DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ");
//     initSessionButtons();
//   });
// } else {
//   console.log("DOMì´ ì´ë¯¸ ë¡œë“œë¨, ì¦‰ì‹œ initSessionButtons í˜¸ì¶œ");
//   initSessionButtons();
// }

// ì¶”ê°€ ì•ˆì „ ì¥ì¹˜: window.onloadì—ì„œë„ í•œ ë²ˆ ë” í˜¸ì¶œ (ì£¼ì„ ì²˜ë¦¬)
// window.addEventListener('load', () => {
//   console.log("window.onload ì´ë²¤íŠ¸ ë°œìƒ, initSessionButtons ì¬í˜¸ì¶œ");
//   initSessionButtons();
// });

function updateCoordSelectOptions() {
  const selectEl = document.getElementById("coordSelectPoint");
  if(!selectEl) return;
  
  const orientation = sessions[cur].poseData?.orientation || "side";
  const currentKeypoints = orientation === "front" ? keypointsFront : keypointsSide;
  const currentValue = selectEl.value;
  
  // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ì˜µì…˜ì¸ "ì  ì„ íƒ..." ì œì™¸)
  while(selectEl.options.length > 1) {
    selectEl.remove(1);
  }
  
  // í˜„ì¬ orientationì— ë§ëŠ” í‚¤í¬ì¸íŠ¸ ì¶”ê°€
  currentKeypoints.forEach(kp => {
    const option = document.createElement('option');
    option.value = kp.key;
    option.textContent = kp.key;
    selectEl.appendChild(option);
  });
  
  // ì´ì „ì— ì„ íƒëœ ì ì´ í˜„ì¬ í‚¤í¬ì¸íŠ¸ ëª©ë¡ì— ìˆìœ¼ë©´ ìœ ì§€
  if(currentValue && currentKeypoints.some(kp => kp.key === currentValue)) {
    selectEl.value = currentValue;
  } else {
    selectEl.value = "";
    selectedPoint = null;
  }
}

function setOrientation(orientation, options = {}) {
  const sessionName = options.sessionName || cur;
  const manual = !!options.manual;
  const unlock = !!options.unlock;
  const session = sessions[sessionName];
  if(!session) return;
  
  if(!session.poseData) {
    session.poseData = { 
      orientation, 
      landmarks: null,
      orientationMode: manual ? "manual" : "auto"
    };
  } else {
    session.poseData.orientation = orientation;
    if(manual) {
      session.poseData.orientationMode = "manual";
    } else if(unlock) {
      session.poseData.orientationMode = "auto";
    } else if(!session.poseData.orientationMode) {
      session.poseData.orientationMode = "auto";
    }
  }
  
  const isCurrent = sessionName === cur;
  if(!isCurrent) {
    return;
  }
  
  const btnSide = document.getElementById("btnOrientationSide");
  const btnFront = document.getElementById("btnOrientationFront");
  if(btnSide) btnSide.classList.toggle("active", orientation === "side");
  if(btnFront) btnFront.classList.toggle("active", orientation === "front");
  
  console.log(`${sessionName} ì„¸ì…˜ì˜ ë°©í–¥ì„ ${orientation === "side" ? "ì˜†ëª¨ìŠµ" : "ì •ë©´"}ìœ¼ë¡œ ì„¤ì •`);
  
  // ì¢Œí‘œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
  updateCoordSelectOptions();
  
  // ì›ë³¸ í¬ê¸° ì´ˆê¸°í™” (orientationë§ˆë‹¤ ë‹¤ë¥¸ ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŒ)
  originalCanvasSize.width = 0;
  originalCanvasSize.height = 0;
  originalCanvasSize.styleWidth = 0;
  originalCanvasSize.styleHeight = 0;
  
  // orientation ë³€ê²½ ì‹œ ìº”ë²„ìŠ¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  const currentImg = orientation === "front" ? session.imgFront : session.imgSide;
  if(currentImg && currentImg.complete && currentImg.naturalWidth > 0) {
    resizeCanvasFor(currentImg);
    draw();
  } else {
    // ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ë¡œë“œ ì¤‘ì´ë©´ ê¸°ë³¸ í¬ê¸°ë¡œ ì„¤ì •í•˜ê³  ê·¸ë¦¬ê¸°
    resizeCanvasFor(null);
    draw();
  }
  
  // âœ… orientation ë³€ê²½ ì‹œ í•´ë‹¹ orientationì— ë§ëŠ” ë¶„ì„ ê²°ê³¼ ë‹¤ì‹œ í‘œì‹œ
  if(session.metrics) {
    const fullMetrics = session.metrics.fullMetrics || {};
    
    // âœ… orientationë³„ë¡œ ë³„ë„ ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ í™•ì¸
    // ì¸¡ë©´ ë¶„ì„: session.sideAnalysis ë˜ëŠ” (session.analysis && analysis.orientation === "side")
    // ì •ë©´ ë¶„ì„: session.frontAnalysis ë˜ëŠ” (session.analysis && analysis.orientation === "front")
    let analysis = null;
    if(orientation === "side") {
      // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ ìš°ì„  í™•ì¸
      if(session.sideAnalysis) {
        analysis = session.sideAnalysis;
      } else if(session.analysis && (session.analysis.orientation === "side" || session.metrics.orientation === "side")) {
        analysis = session.analysis;
      }
    } else if(orientation === "front") {
      // ì •ë©´ ë¶„ì„ ê²°ê³¼ ìš°ì„  í™•ì¸
      if(session.frontAnalysis) {
        analysis = session.frontAnalysis;
      } else if(session.analysis && (session.analysis.orientation === "front" || session.metrics.orientation === "front")) {
        analysis = session.analysis;
      }
    }
    
    // âœ… scoreDataë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬: ê°ì²´ì¸ ê²½ìš° score ì†ì„± í™•ì¸
    let scoreData = null;
    if(session.metrics.scoreData) {
      if(typeof session.metrics.scoreData === 'object' && session.metrics.scoreData !== null) {
        // scoreDataê°€ ê°ì²´ì¸ ê²½ìš°, score ì†ì„±ì´ ìˆëŠ”ì§€ í™•ì¸
        if(typeof session.metrics.scoreData.score === 'number') {
          scoreData = session.metrics.scoreData;
        } else {
          // score ì†ì„±ì´ ì—†ìœ¼ë©´ fullMetricsì—ì„œ ì¬ê³„ì‚°
          scoreData = null;
        }
      } else if(typeof session.metrics.scoreData === 'number') {
        scoreData = session.metrics.scoreData;
      }
    }
    
    // scoreDataê°€ ì—†ìœ¼ë©´ session.score í™•ì¸
    if(!scoreData) {
      if(typeof session.score === 'object' && session.score !== null && typeof session.score.score === 'number') {
        scoreData = session.score;
      } else if(typeof session.score === 'number') {
        scoreData = session.score;
      } else if(Object.keys(fullMetrics).length > 0) {
        // fullMetricsì—ì„œ ì ìˆ˜ ì¬ê³„ì‚°
        scoreData = null; // updateScoreAndAnalysisì—ì„œ ìë™ìœ¼ë¡œ ê³„ì‚°í•˜ë„ë¡
      }
    }
    
    // âœ… orientationì— ë§ëŠ” ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
    // sideAnalysisë‚˜ frontAnalysisì— ì ìˆ˜ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
    let orientationScore = null;
    if(orientation === "side" && session.sideAnalysis) {
      // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ì—ì„œ ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
      if(session.sideAnalysis.fullMetrics) {
        // âœ… ì¸¡ë©´ ë©”íŠ¸ë¦­ì´ ìœ íš¨í•œì§€ í™•ì¸ í›„ ì ìˆ˜ ê³„ì‚° (ê²½ê³  ë°©ì§€)
        const hasValidSideMetrics = Object.keys(session.sideAnalysis.fullMetrics).some(key => {
          if (key === 'orientation') return false;
          const metric = session.sideAnalysis.fullMetrics[key];
          if (!metric || typeof metric !== 'object') return false;
          const val = metric.value != null ? metric.value : 
                      (metric.value_deg != null ? metric.value_deg : 
                      (metric.value_cm != null ? metric.value_cm : null));
          return val != null && !isNaN(val) && isFinite(val);
        });
        if (hasValidSideMetrics) {
          orientationScore = computeScoreFromFullMetrics(session.sideAnalysis.fullMetrics);
        }
      } else if(session.sideAnalysis.score) {
        orientationScore = session.sideAnalysis.score;
      }
    } else if(orientation === "front" && session.frontAnalysis) {
      // ì •ë©´ ë¶„ì„ ê²°ê³¼ì—ì„œ ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
      if(session.frontAnalysis.fullMetrics) {
        // âœ… ì •ë©´ ë©”íŠ¸ë¦­ì´ ìœ íš¨í•œì§€ í™•ì¸ í›„ ì ìˆ˜ ê³„ì‚° (ê²½ê³  ë°©ì§€)
        const hasValidFrontMetrics = Object.keys(session.frontAnalysis.fullMetrics).some(key => {
          if (key === 'orientation') return false;
          const metric = session.frontAnalysis.fullMetrics[key];
          if (!metric || typeof metric !== 'object') return false;
          const val = metric.value != null ? metric.value : 
                      (metric.value_deg != null ? metric.value_deg : 
                      (metric.value_cm != null ? metric.value_cm : null));
          return val != null && !isNaN(val) && isFinite(val);
        });
        if (hasValidFrontMetrics) {
          orientationScore = computeScoreFromFullMetrics(session.frontAnalysis.fullMetrics);
        }
      } else if(session.frontAnalysis.score) {
        orientationScore = session.frontAnalysis.score;
      }
    }
    
    // orientationë³„ ì ìˆ˜ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ scoreData ì‚¬ìš©
    if(!orientationScore) {
      orientationScore = scoreData;
    }
    
    // orientationì— ë§ëŠ” ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸
    if(orientation === "side") {
      // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
      const cva = session.metrics.cva;
      const pelvic = session.metrics.pelvic;
      const knee = session.metrics.knee;
      updateScoreAndAnalysis(orientationScore, cva, pelvic, knee, analysis);
    } else if(orientation === "front") {
      // ì •ë©´ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
      updateScoreAndAnalysis(orientationScore, null, null, null, analysis);
    }
  }
}

function switchSession(s) {
  cur = s;
  
  const btnBefore = document.getElementById("btnBefore");
  const btnAfter = document.getElementById("btnAfter");
  const currentSessionEl = document.getElementById("currentSession");
  
  if(btnBefore) btnBefore.classList.toggle("active", s === "Before");
  if(btnAfter) btnAfter.classList.toggle("active", s === "After");
  if(currentSessionEl) currentSessionEl.textContent = s;
  
  // ì„¸ì…˜ ì „í™˜ ì‹œ orientation ë²„íŠ¼ ì—…ë°ì´íŠ¸
  const orientation = sessions[s].poseData?.orientation || "side";
  const btnSide = document.getElementById("btnOrientationSide");
  const btnFront = document.getElementById("btnOrientationFront");
  if(btnSide) btnSide.classList.toggle("active", orientation === "side");
  if(btnFront) btnFront.classList.toggle("active", orientation === "front");
  
  // ì¢Œí‘œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
  updateCoordSelectOptions();
  
  // ì›ë³¸ í¬ê¸° ì´ˆê¸°í™” (ì„¸ì…˜ë§ˆë‹¤ ë‹¤ë¥¸ ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŒ)
  originalCanvasSize.width = 0;
  originalCanvasSize.height = 0;
  originalCanvasSize.styleWidth = 0;
  originalCanvasSize.styleHeight = 0;
  
  // ì„¸ì…˜ì˜ ì´ë¯¸ì§€ë¡œ ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
  const img = orientation === "front" ? sessions[s].imgFront : sessions[s].imgSide;
  if(img && img.complete && img.naturalWidth > 0) {
    resizeCanvasFor(img);
  draw();
  } else {
    // ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ë¡œë“œ ì¤‘ì´ë©´ ê¸°ë³¸ í¬ê¸°ë¡œ ì„¤ì •í•˜ê³  ê·¸ë¦¬ê¸°
    resizeCanvasFor(null);
    draw();
  }
  
  // ì„¸ì…˜ ì „í™˜ ì‹œì—ëŠ” ê¸°ì¡´ ë¶„ì„ì´ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ metricsë§Œ ê³„ì‚°
  // âœ… orientationì— ë§ëŠ” ë¶„ì„ ê²°ê³¼ì™€ ì ìˆ˜ ì‚¬ìš©
  const currentOrientation = sessions[s].poseData?.orientation || "side";
  let analysis = null;
  let orientationScore = null;
  
  if(currentOrientation === "side" && sessions[s].sideAnalysis) {
    analysis = sessions[s].sideAnalysis;
    if(analysis.fullMetrics) {
      orientationScore = computeScoreFromFullMetrics(analysis.fullMetrics);
    }
  } else if(currentOrientation === "front" && sessions[s].frontAnalysis) {
    analysis = sessions[s].frontAnalysis;
    if(analysis.fullMetrics) {
      orientationScore = computeScoreFromFullMetrics(analysis.fullMetrics);
    }
  } else if(sessions[s].analysis) {
    // í•˜ìœ„ í˜¸í™˜ì„±: ê¸°ì¡´ analysis ì‚¬ìš©
    analysis = sessions[s].analysis;
  }
  
  // orientationë³„ ì ìˆ˜ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ score ì‚¬ìš©
  if(!orientationScore) {
    orientationScore = sessions[s].score;
  }
  
  if(analysis || sessions[s].metrics) {
    // ê¸°ì¡´ ë¶„ì„ì´ ìˆìœ¼ë©´ ì „ì²´ ì—…ë°ì´íŠ¸
    const metrics = sessions[s].metrics;
    if(currentOrientation === "side") {
      updateScoreAndAnalysis(orientationScore, metrics?.cva, metrics?.pelvic, metrics?.knee, analysis);
    } else if(currentOrientation === "front") {
      updateScoreAndAnalysis(orientationScore, null, null, null, analysis);
    } else {
      // orientationì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹
      updateScoreAndAnalysis(orientationScore, metrics?.cva, metrics?.pelvic, metrics?.knee, analysis);
    }
  } else {
    computeMetricsOnly(); // ë¶„ì„ì´ ì—†ìœ¼ë©´ metricsë§Œ ê³„ì‚°
  }
  updateCompare();
}

function resizeCanvasFor(img) {
  const canvasWrap = cv.parentElement;
  if(!canvasWrap) {
    console.error("canvasWrapë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
    return;
  }
  
  const maxW = Math.max(canvasWrap.clientWidth - 24, 600);
  const maxH = Math.max(canvasWrap.clientHeight - 24, 400);
  
  // ì›ë³¸ í¬ê¸° ê³„ì‚° (ì²˜ìŒ í•œ ë²ˆë§Œ ë˜ëŠ” editModeê°€ ì•„ë‹ ë•Œ)
  let baseW, baseH;
  if(!editMode || originalCanvasSize.width === 0 || originalCanvasSize.height === 0) {
    if(img && img.naturalWidth > 0 && img.naturalHeight > 0) {
    // ì»¨í…Œì´ë„ˆì— ë§ê²Œ ì›ë³¸ ë¹„ìœ¨ ìœ ì§€í•˜ë©° í¬ê¸° ê³„ì‚°
    const r = Math.min(maxW / img.naturalWidth, maxH / img.naturalHeight);
    baseW = Math.round(img.naturalWidth * r);
    baseH = Math.round(img.naturalHeight * r);
      console.log("ì´ë¯¸ì§€ ê¸°ë°˜ ìº”ë²„ìŠ¤ í¬ê¸°:", {baseW, baseH, naturalW: img.naturalWidth, naturalH: img.naturalHeight});
  } else {
      baseW = Math.min(maxW, 1200);
      baseH = Math.min(maxH, 800);
      console.log("ê¸°ë³¸ ìº”ë²„ìŠ¤ í¬ê¸°:", {baseW, baseH});
  }
  
    // ì›ë³¸ í¬ê¸° ì €ì¥
    originalCanvasSize.width = baseW;
    originalCanvasSize.height = baseH;
    originalCanvasSize.styleWidth = baseW;
    originalCanvasSize.styleHeight = baseH;
  } else {
    // ì´ë¯¸ ì €ì¥ëœ ì›ë³¸ í¬ê¸° ì‚¬ìš© (editModeì—ì„œ í™•ëŒ€ ì‹œ)
    baseW = originalCanvasSize.width;
    baseH = originalCanvasSize.height;
  }
  
  // í™•ëŒ€ ë°°ìœ¨ ì ìš© (ë¹„ìœ¨ ìœ ì§€) - editMode ë˜ëŠ” calibrationModeì¼ ë•Œ
  const zoomMultiplier = (editMode || calibrationMode) ? currentZoom : 1;
  const finalW = baseW * zoomMultiplier;
  const finalH = baseH * zoomMultiplier;
  
  // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
  cv.width = finalW * DPR;
  cv.height = finalH * DPR;
  cv.style.width = finalW + "px";
  cv.style.height = finalH + "px";
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  
  // í™•ëŒ€ëœ ê²½ìš° ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • (editMode ë˜ëŠ” calibrationMode)
  if((editMode || calibrationMode) && currentZoom > 1) {
    canvasWrap.classList.add("zoomed");
    canvasWrap.style.overflow = "auto";
    canvasWrap.style.overflowX = "auto";
    canvasWrap.style.overflowY = "auto";
  } else {
    canvasWrap.classList.remove("zoomed");
    canvasWrap.style.overflow = "auto";
    canvasWrap.style.overflowX = "hidden";
    canvasWrap.style.overflowY = "hidden";
  }
  
  // ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  draw();
}

function ensureDefaultPoints(session) {
  const S = sessions[session];
  // ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì¢Œí‘œ ê³„ì‚°
  const W = originalCanvasSize.width || (cv.width / DPR / ((editMode || calibrationMode) ? currentZoom : 1));
  const H = originalCanvasSize.height || (cv.height / DPR / ((editMode || calibrationMode) ? currentZoom : 1));
  
  const orientation = S.poseData?.orientation || "side";
  const currentImg = orientation === "front" ? S.imgFront : S.imgSide;
  const currentKeypoints = orientation === "front" ? keypointsFront : keypointsSide;
  const currentPoints = orientation === "front" ? S.frontPoints : S.sidePoints;
  
  if(currentImg) {
    // Flutter 1:1 ë§¤ì¹­ í‚¤ë¡œ ê¸°ë³¸ê°’ ì„¤ì •
    const defaults = orientation === "front" ? {
      L_tragus: {x:W*0.25, y:H*0.25},  // ì •ë©´: ì™¼ìª½ ê·€
      R_tragus: {x:W*0.75, y:H*0.25},  // ì •ë©´: ì˜¤ë¥¸ìª½ ê·€
      c7: {x:W*0.5, y:H*0.2},
      L_acromion: {x:W*0.3, y:H*0.3},
      R_acromion: {x:W*0.7, y:H*0.3},
      L_asis: {x:W*0.35, y:H*0.5},
      R_asis: {x:W*0.65, y:H*0.5},
      L_knee: {x:W*0.4, y:H*0.11},  // âœ… ë¬´ë¦ ìœ„ì¹˜ 50% ì˜¬ë¦¬ê¸° (0.22 â†’ 0.11)
      R_knee: {x:W*0.6, y:H*0.11},  // âœ… ë¬´ë¦ ìœ„ì¹˜ 50% ì˜¬ë¦¬ê¸° (0.22 â†’ 0.11)
      L_ankle: {x:W*0.4, y:H*0.14},  // âœ… ë°œëª© ìœ„ì¹˜ 50% ì˜¬ë¦¬ê¸° (0.28 â†’ 0.14)
      R_ankle: {x:W*0.6, y:H*0.14},  // âœ… ë°œëª© ìœ„ì¹˜ 50% ì˜¬ë¦¬ê¸° (0.28 â†’ 0.14)
      // Q-angle ì¸¡ì •ìš© dot (ASIS-KNEE-Tibial tub ì‚¬ìš©)
      L_tibial_tub: {x:W*0.4, y:H*0.115},  // âœ… ì¢Œì¸¡ ê²½ê³¨ ê²°ì ˆ 50% ì˜¬ë¦¬ê¸° (0.23 â†’ 0.115)
      R_tibial_tub: {x:W*0.6, y:H*0.115},  // âœ… ìš°ì¸¡ ê²½ê³¨ ê²°ì ˆ 50% ì˜¬ë¦¬ê¸° (0.23 â†’ 0.115)
    } : {
      tragus: {x:W*0.35, y:H*0.3},
      c7: {x:W*0.3, y:H*0.35},
      acromion: {x:W*0.35, y:H*0.4},
      hip: {x:W*0.38, y:H*0.6},
      knee: {x:W*0.42, y:H*0.8},
      ankle: {x:W*0.44, y:H*0.95},
      asis: {x:W*0.40, y:H*0.58},
      psis: {x:W*0.35, y:H*0.6},
    };
    // âœ… ê° ì ì„ ê°œë³„ì ìœ¼ë¡œ í™•ì¸í•˜ì—¬ ì—†ëŠ” ì ë§Œ ê¸°ë³¸ê°’ ì„¤ì • (ê¸°ì¡´ ì ì€ ë®ì–´ì“°ì§€ ì•ŠìŒ)
    for(const kp of currentKeypoints) {
      if(defaults[kp.key] && !currentPoints.has(kp.key)) {
        currentPoints.set(kp.key, {...defaults[kp.key]});
      }
    }
  }
}

function getPts(session) {
  const orientation = sessions[session].poseData?.orientation || "side";
  const map = orientation === "front" ? sessions[session].frontPoints : sessions[session].sidePoints;
  const currentKeypoints = orientation === "front" ? keypointsFront : keypointsSide;
  const out = {};
  
  // ìƒˆë¡œìš´ ì†Œë¬¸ì í‚¤ë¡œ ì €ì¥ëœ ê°’ ê°€ì ¸ì˜¤ê¸°
  for(const k of currentKeypoints) {
    out[k.key] = map.get(k.key);
  }
  
  // ê¸°ì¡´ ëŒ€ë¬¸ì í‚¤ í˜¸í™˜ì„± ë ˆì´ì–´ (draw, computeMetricsOnly ë“±ì—ì„œ ì‚¬ìš©)
  if(orientation === "side") {
    out['Tragus'] = out['tragus'];
    out['C7'] = out['c7'];
    out['Shoulder'] = out['acromion'];  // ê¸°ì¡´ Shoulder í‚¤ ì§€ì›
    out['Acromion'] = out['acromion'];
    out['Hip'] = out['hip'];
    out['Knee'] = out['knee'];
    out['Ankle'] = out['ankle'];
    out['ASIS'] = out['asis'];
    out['PSIS'] = out['psis'];
  }
  // ì •ë©´ì€ ì´ë¯¸ ì¼ì¹˜í•˜ë¯€ë¡œ ì¶”ê°€ ë§¤í•‘ ë¶ˆí•„ìš” (c7ë§Œ ì²˜ë¦¬)
  if(orientation === "front") {
    out['C7'] = out['c7'];
  }
  
  return out;
}

// í˜„ì¬ orientationì— ë§ëŠ” í‚¤í¬ì¸íŠ¸ ë°˜í™˜
function getKeypoints() {
  const orientation = sessions[cur].poseData?.orientation || "side";
  return orientation === "front" ? keypointsFront : keypointsSide;
}

function draw() {
  // ìº”ë²„ìŠ¤ì™€ ì»¨í…ìŠ¤íŠ¸ í™•ì¸
  if(!cv || !ctx) {
    console.error("draw() í˜¸ì¶œ ì‹œ ìº”ë²„ìŠ¤ ë˜ëŠ” ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // sessionsê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¬´ì‹œ
  if(!sessions || !sessions[cur]) {
    console.warn("draw() í˜¸ì¶œ ì‹œ sessionsê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  const S = sessions[cur];
  
  const W = cv.width / DPR, H = cv.height / DPR;
  ctx.clearRect(0, 0, cv.width, cv.height);
  ctx.fillStyle = "#0a0e13";
  ctx.fillRect(0, 0, W, H);

  // orientationì— ë”°ë¼ ì ì ˆí•œ ì´ë¯¸ì§€ ì„ íƒ
  const orientation = S.poseData?.orientation || "side";
  const currentImg = orientation === "front" ? S.imgFront : S.imgSide;

  if(currentImg && currentImg.complete && currentImg.naturalWidth > 0 && currentImg.naturalHeight > 0) {
    // ì›ë³¸ í¬ê¸° ì €ì¥ (ì²˜ìŒ í•œ ë²ˆë§Œ)
    if(originalCanvasSize.width === 0) {
      const maxW = cv.parentElement.clientWidth - 24;
      const maxH = cv.parentElement.clientHeight - 24;
      const r = Math.min(maxW / currentImg.naturalWidth, maxH / currentImg.naturalHeight);
      originalCanvasSize.width = Math.round(currentImg.naturalWidth * r);
      originalCanvasSize.height = Math.round(currentImg.naturalHeight * r);
      originalCanvasSize.styleWidth = originalCanvasSize.width;
      originalCanvasSize.styleHeight = originalCanvasSize.height;
    }
    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ë¹„ìœ¨ ìœ ì§€í•˜ë©° í™•ëŒ€ëœ í¬ê¸°ë¡œ)
    try {
    ctx.drawImage(currentImg, 0, 0, W, H);
    } catch(err) {
      console.error("ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° ì‹¤íŒ¨:", err);
    }
  } else if(currentImg && !currentImg.complete) {
    // ì´ë¯¸ì§€ê°€ ì•„ì§ ë¡œë“œ ì¤‘ì´ë©´ ë‹¤ì‹œ ì‹œë„
    currentImg.onload = () => {
      resizeCanvasFor(currentImg);
      draw();
    };
  }

  ensureDefaultPoints(cur);
  const P = getPts(cur);
  const currentKeypoints = getKeypoints();

  // ë””ë²„ê¹…: Pì™€ currentKeypoints í™•ì¸
  if(editMode && Object.keys(P).length === 0) {
    console.warn("âš ï¸ draw(): P ê°ì²´ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ensureDefaultPointsê°€ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
  }
  if(editMode && currentKeypoints.length === 0) {
    console.warn("âš ï¸ draw(): currentKeypointsê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
  }

  // í™•ëŒ€ ë°°ìœ¨ ì ìš©
  const scaleX = (editMode || calibrationMode) ? currentZoom : 1;
  const scaleY = (editMode || calibrationMode) ? currentZoom : 1;

  // ë³´ì¡°ì„  ê·¸ë¦¬ê¸°
  ctx.lineWidth = 2;
  ctx.setLineDash([8, 6]);
  ctx.strokeStyle = 'rgba(124,156,255,0.85)';

  if(P.C7 && P.Tragus) {
    ctx.beginPath();
    ctx.moveTo(0, P.C7.y * scaleY);
    ctx.lineTo(W, P.C7.y * scaleY);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(P.C7.x * scaleX, P.C7.y * scaleY);
    ctx.lineTo(P.Tragus.x * scaleX, P.Tragus.y * scaleY);
    ctx.stroke();
  }

  if(P.Shoulder && P.Hip) {
    ctx.beginPath();
    ctx.moveTo(P.Shoulder.x * scaleX, P.Shoulder.y * scaleY);
    ctx.lineTo(P.Hip.x * scaleX, P.Hip.y * scaleY);
    ctx.stroke();
  }
  if(P.Hip && P.Knee) {
    ctx.beginPath();
    ctx.moveTo(P.Hip.x * scaleX, P.Hip.y * scaleY);
    ctx.lineTo(P.Knee.x * scaleX, P.Knee.y * scaleY);
    ctx.stroke();
  }
  if(P.Knee && P.Ankle) {
    ctx.beginPath();
    ctx.moveTo(P.Knee.x * scaleX, P.Knee.y * scaleY);
    ctx.lineTo(P.Ankle.x * scaleX, P.Ankle.y * scaleY);
    ctx.stroke();
  }

  if(P.ASIS && P.PSIS) {
    ctx.strokeStyle = 'rgba(255,184,108,0.95)';
    ctx.beginPath();
    ctx.moveTo(P.ASIS.x * scaleX, P.ASIS.y * scaleY);
    ctx.lineTo(P.PSIS.x * scaleX, P.PSIS.y * scaleY);
    ctx.stroke();
    ctx.strokeStyle = 'rgba(255,184,108,0.35)';
    const midy = (P.ASIS.y + P.PSIS.y) / 2;
    ctx.beginPath();
    ctx.moveTo(0, midy * scaleY);
    ctx.lineTo(W, midy * scaleY);
    ctx.stroke();
  }

  ctx.setLineDash([]);

  // ëª¨ë“  dotë“¤ì„ ì—°ê²°í•˜ëŠ” ì ì„  ê·¸ë¦¬ê¸°
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 4]);
  ctx.strokeStyle = 'rgba(100,100,100,0.4)';
  ctx.beginPath();
  let firstPoint = true;
  let hasPoints = false;
  for(const kp of currentKeypoints) {
    const pt = P[kp.key];
    if(!pt) continue;
    hasPoints = true;
    const x = pt.x * scaleX;
    const y = pt.y * scaleY;
    if(firstPoint) {
      ctx.moveTo(x, y);
      firstPoint = false;
    } else {
      ctx.lineTo(x, y);
    }
  }
  // ì ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì ì„  ê·¸ë¦¬ê¸° (ì—ëŸ¬ ë°©ì§€)
  if(hasPoints) {
    ctx.stroke();
  }
  ctx.setLineDash([]);

  // ì  ê·¸ë¦¬ê¸° (orientationì— ë§ëŠ” í‚¤í¬ì¸íŠ¸ ì‚¬ìš©)
  // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì—ì„œë„ ëª¨ë“  ì ì´ ê·¸ë ¤ì§€ë„ë¡ ë³´ì¥
  for(const kp of currentKeypoints) {
    const pt = P[kp.key];
    if(!pt) {
      // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì—ì„œ ì ì´ ì—†ìœ¼ë©´ ê²½ê³ ë§Œ ì¶œë ¥í•˜ê³  ê³„ì† ì§„í–‰
      if(editMode) {
        console.debug(`ì  ${kp.key}ì´(ê°€) ì—†ìŠµë‹ˆë‹¤.`);
      }
      continue;
    }
    const isSelected = editMode && selectedPoint === kp.key;
    try {
      drawHandle(pt.x * scaleX, pt.y * scaleY, kp.key, kp.color, isSelected);
    } catch(err) {
      console.error(`ì  ${kp.key} ê·¸ë¦¬ê¸° ì‹¤íŒ¨:`, err);
    }
  }
  
  // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì—ì„œ ì„ íƒëœ ì ì´ ìˆê³  ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì•ˆë‚´ í‘œì‹œ
  if(editMode && selectedPoint && !P[selectedPoint]) {
    const W = cv.width / DPR, H = cv.height / DPR;
    ctx.fillStyle = 'rgba(124,156,255,0.7)';
    ctx.font = 'bold 16px "Noto Sans KR"';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('ì¢Œí‘œë¥¼ ì…ë ¥í•˜ê³  "ì ìš©" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', W / 2, H / 2);
    ctx.textAlign = 'left';
    ctx.textBaseline = 'alphabetic';
  }
  
  // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì  í‘œì‹œ (ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œì¼ ë•Œ)
  if(calibrationMode && S.calibrationPoint1) {
    ctx.fillStyle = '#ffb86c';
    ctx.strokeStyle = '#ffb86c';
    ctx.lineWidth = 2;
    
    // ì  1 í‘œì‹œ
    const p1 = S.calibrationPoint1;
    ctx.beginPath();
    ctx.arc(p1.x * scaleX, p1.y * scaleY, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.stroke();
    
    // ì  2ê°€ ìˆìœ¼ë©´ í‘œì‹œí•˜ê³  ì„  ê·¸ë¦¬ê¸°
    if(S.calibrationPoint2) {
      const p2 = S.calibrationPoint2;
      ctx.beginPath();
      ctx.arc(p2.x * scaleX, p2.y * scaleY, 8, 0, Math.PI * 2);
      ctx.fill();
      ctx.stroke();
      
      // ë‘ ì  ì‚¬ì´ ì„  ê·¸ë¦¬ê¸°
      ctx.beginPath();
      ctx.moveTo(p1.x * scaleX, p1.y * scaleY);
      ctx.lineTo(p2.x * scaleX, p2.y * scaleY);
      ctx.stroke();
    }
  }
}

function drawHandle(x, y, label, color, isSelected = false) {
  // ì„ íƒëœ ì ì€ ë” í¬ê³  ê°•ì¡° í‘œì‹œ
  const radius = isSelected ? 12 : 8;
  const strokeWidth = isSelected ? 3 : 2;
  
  // ì„ íƒëœ ì ì€ ì™¸ê³½ ë§ í‘œì‹œ
  if(isSelected) {
    ctx.fillStyle = 'rgba(124,156,255,0.3)';
    ctx.beginPath();
    ctx.arc(x, y, radius + 4, 0, Math.PI * 2);
    ctx.fill();
  }
  
  // ì ì„ ë” í¬ê²Œ ê·¸ë¦¬ê³  ë“œë˜ê·¸ ì˜ì—­ì„ ë„“ê²Œ
  ctx.fillStyle = color;
  ctx.strokeStyle = isSelected ? 'rgba(124,156,255,1)' : 'rgba(0,0,0,0.8)';
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  ctx.fill();
  ctx.lineWidth = strokeWidth;
  ctx.stroke();
  ctx.font = '12px "Noto Sans KR"';
  const pad = 4;
  const tw = ctx.measureText(label).width;
  const th = 16;
  // âœ… dot ê°„ê²©ì„ ë²Œë¦¬ê¸° ìœ„í•´ label ìœ„ì¹˜ë¥¼ ë” ë©€ë¦¬ ë°°ì¹˜ (10 -> 18)
  const labelOffsetX = 18;
  ctx.fillStyle = isSelected ? 'rgba(124,156,255,0.8)' : 'rgba(0,0,0,0.6)';
  ctx.fillRect(x + labelOffsetX, y - 12, tw + pad * 2, th);
  ctx.fillStyle = '#e7eef7';
  ctx.fillText(label, x + labelOffsetX + pad, y + 1);
}

// ê°ë„ì™€ ì ìˆ˜ë§Œ ê³„ì‚° (ì‹¤ì‹œê°„ í‘œì‹œìš©, AI ë¶„ì„ ì—†ìŒ)
function computeMetricsOnly() {
  // sessionsê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¬´ì‹œ
  if(!window.sessions || !window.sessions[cur]) {
    console.warn("computeMetricsOnly() í˜¸ì¶œ ì‹œ sessionsê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  const S = sessions[cur];
  const pxPerCm = S.pxPerCm || 50.0;
  
  // ì¸¡ë©´ ë° ì •ë©´ í‚¤í¬ì¸íŠ¸ë¥¼ Map í˜•íƒœë¡œ ë³€í™˜
  const sidePoints = {};
  const frontPoints = {};
  
  // ì¸¡ë©´ í‚¤í¬ì¸íŠ¸
  for(const [key, value] of S.sidePoints.entries()) {
    if(value && value.x != null && value.y != null) {
      sidePoints[key] = { x: value.x, y: value.y };
    }
  }
  
  // ì •ë©´ í‚¤í¬ì¸íŠ¸
  for(const [key, value] of S.frontPoints.entries()) {
    if(value && value.x != null && value.y != null) {
      frontPoints[key] = { x: value.x, y: value.y };
    }
  }
  
  // ì „ì²´ ë©”íŠ¸ë¦­ ê³„ì‚° (AI ë¶„ì„ ì—†ì´)
  const imageWidth = cv ? (cv.width / DPR) : 1080; // ìº”ë²„ìŠ¤ ë„ˆë¹„ ë˜ëŠ” ê¸°ë³¸ê°’
  const sideMetrics = Object.keys(sidePoints).length > 0 
    ? analyzeFullPosture(sidePoints, pxPerCm, imageWidth) 
    : { status: "not_available" };
  
  const frontMetrics = Object.keys(frontPoints).length > 0 
    ? analyzeFrontPosture(frontPoints, pxPerCm) 
    : { status: "not_available" };
  
  // ì¸¡ë©´ ë° ì •ë©´ ë¶„ì„ ê²°ê³¼ë¥¼ í†µí•©í•˜ì—¬ fullMetricsì— ì €ì¥
  const mergedMetrics = {};
  
  // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ í†µí•©
  if(sideMetrics.status !== "not_available") {
    Object.assign(mergedMetrics, sideMetrics);
  }
  
  // ì •ë©´ ë¶„ì„ ê²°ê³¼ í†µí•© (ì¸¡ë©´ ê²°ê³¼ì™€ ë³‘í•©)
  if(frontMetrics.status !== "not_available") {
    Object.assign(mergedMetrics, frontMetrics);
  }
  
  // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ ì²˜ë¦¬
  const P = getPts(cur);
  let cva = null, pelvic = null, knee = null;

  if(P.C7 && P.Tragus) {
    // CVA: C7 ìˆ˜í‰ë©´ ê¸°ì¤€ ê°ë„ (0ë„ = C7 ìˆ˜í‰ë©´)
    const cv_theta = angleFromHorizontalDeg(P.C7, P.Tragus);
    const cv_acute = normalizeToAcuteDeg(cv_theta);
    cva = Math.abs(cv_acute); // C7 ìˆ˜í‰ë©´ ê¸°ì¤€ ê°ë„
  }
  if(P.ASIS && P.PSIS) {
    // TRUNK ê°ë„: ìˆ˜í‰ì„ ê³¼ ASIS-PSIS ì„  ì‚¬ì´ì˜ ê°ë„
    const dx = P.PSIS.x - P.ASIS.x;
    const dy = P.PSIS.y - P.ASIS.y;
    const angle = Math.atan2(dy, dx);
    let pelvicDeg = rad2deg(angle);
    
    if(pelvicDeg < -90) {
      pelvicDeg = 180 + pelvicDeg;
    } else if(pelvicDeg > 90) {
      pelvicDeg = pelvicDeg - 180;
    }
    
    pelvic = pelvicDeg;
  }
  if(P.Hip && P.Knee && P.Ankle) {
    knee = rad2deg(internalAngle(P.Hip, P.Knee, P.Ankle));
  }

  // fullMetricsê°€ ìˆìœ¼ë©´ fullMetrics ê¸°ë°˜ìœ¼ë¡œ ì ìˆ˜ ê³„ì‚°
  let score;
  if(Object.keys(mergedMetrics).length > 0) {
    S.metrics = { 
      cva, 
      pelvic, 
      knee,
      fullMetrics: mergedMetrics,
      orientation: sideMetrics.status !== "not_available" ? "side" : "front",
      frontMetrics: frontMetrics.status !== "not_available" ? frontMetrics : null
    };
    window.fullMetrics = mergedMetrics;
    score = computeScoreFromFullMetrics(mergedMetrics);
  } else {
    S.metrics = { cva, pelvic, knee };
    score = computeScore(cva, pelvic, knee);
  }
  
  S.score = score;
  
  // AI ë¶„ì„ì€ í•˜ì§€ ì•ŠìŒ (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ)
  
  updateDisplay();
  updateCompare(); // ì „ì²´ ë¶„ì„ í•­ëª© ì—…ë°ì´íŠ¸
  
  // ì „ì²´ ë¶„ì„ í•­ëª© í‘œì‹œ ì—…ë°ì´íŠ¸ (AI ë¶„ì„ ì—†ì´)
  // score ê°ì²´ë¥¼ ì „ë‹¬ (computeScoreFromFullMetricsëŠ” {score, reasons, penalties} ë°˜í™˜)
  const scoreData = typeof score === 'object' && score !== null ? score : { score: score, reasons: [], penalties: 0 };
  updateScoreAndAnalysis(scoreData, cva, pelvic, knee, null);
}

// ì „ì²´ ê³„ì‚° (AI ë¶„ì„ í¬í•¨) - ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ í˜¸ì¶œ
function computeAll() {
  const S = sessions[cur];
  const pxPerCm = S.pxPerCm || 50.0;
  
  // âœ… í˜„ì¬ ì„ íƒëœ orientation í™•ì¸ (ì •ë©´ ë¶„ì„ë§Œ í•  ë•Œ ì¸¡ë©´ ë°ì´í„° ë¬´ì‹œ)
  const btnSide = document.getElementById("btnOrientationSide");
  const btnFront = document.getElementById("btnOrientationFront");
  const currentOrientation = btnFront?.classList.contains("active") ? "front" 
    : (btnSide?.classList.contains("active") ? "side" : S.poseData?.orientation || "side");
  
  // ì¸¡ë©´ ë° ì •ë©´ í‚¤í¬ì¸íŠ¸ë¥¼ Map í˜•íƒœë¡œ ë³€í™˜
  const sidePoints = {};
  const frontPoints = {};
  
  // âœ… ì •ë©´ ë¶„ì„ë§Œ í•  ë•ŒëŠ” ì¸¡ë©´ í¬ì¸íŠ¸ ë¬´ì‹œ
  if (currentOrientation !== "front") {
  // ì¸¡ë©´ í‚¤í¬ì¸íŠ¸
  for(const [key, value] of S.sidePoints.entries()) {
    if(value && value.x != null && value.y != null) {
      sidePoints[key] = { x: value.x, y: value.y };
      }
    }
  }
  
  // âœ… ì¸¡ë©´ ë¶„ì„ë§Œ í•  ë•ŒëŠ” ì •ë©´ í¬ì¸íŠ¸ ë¬´ì‹œ
  if (currentOrientation !== "side") {
  // ì •ë©´ í‚¤í¬ì¸íŠ¸
  for(const [key, value] of S.frontPoints.entries()) {
    if(value && value.x != null && value.y != null) {
      frontPoints[key] = { x: value.x, y: value.y };
      }
    }
  }
  
  // í†µí•© ë¶„ì„ ì‹¤í–‰ (ìš´ë™ ì¶”ì²œ í¬í•¨)
  const analysisResult = analyzePostureAutoWithRecommendation({
    sidePts: Object.keys(sidePoints).length > 0 ? sidePoints : null,
    frontPts: Object.keys(frontPoints).length > 0 ? frontPoints : null,
    pxPerCm: pxPerCm
  });
  
  // í†µí•© ë¶„ì„ ê²°ê³¼ ì €ì¥
  S.analysisResult = analysisResult;
  
  // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ ì²˜ë¦¬
  let sideMetrics = analysisResult.side;
  let frontMetrics = analysisResult.front;
  
  // âœ… ì •ë©´ ë¶„ì„ë§Œ í•  ë•ŒëŠ” ì¸¡ë©´ ë©”íŠ¸ë¦­ ê°•ì œë¡œ ë¬´ì‹œ
  if (currentOrientation === "front") {
    sideMetrics = { status: "not_available" };
  }
  // âœ… ì¸¡ë©´ ë¶„ì„ë§Œ í•  ë•ŒëŠ” ì •ë©´ ë©”íŠ¸ë¦­ ê°•ì œë¡œ ë¬´ì‹œ
  if (currentOrientation === "side") {
    frontMetrics = { status: "not_available" };
  }
  
  // ì¸¡ë©´ ë° ì •ë©´ ë¶„ì„ ê²°ê³¼ë¥¼ í†µí•©í•˜ì—¬ fullMetricsì— ì €ì¥
  // âœ… ì •ë©´ ë¶„ì„ë§Œ ìˆì„ ë•ŒëŠ” ì •ë©´ ë©”íŠ¸ë¦­ë§Œ, ì¸¡ë©´ ë¶„ì„ë§Œ ìˆì„ ë•ŒëŠ” ì¸¡ë©´ ë©”íŠ¸ë¦­ë§Œ ì‚¬ìš©
  let mergedMetrics = {};
  
  // âœ… ì •ë©´ ë¶„ì„ë§Œ ìˆëŠ” ê²½ìš°ë¥¼ ë¨¼ì € ì²´í¬ (ì¸¡ë©´ ë¶„ì„ í›„ ì •ë©´ ë¶„ì„ ì‹œ ì •ë©´ë§Œ ì‚¬ìš©)
  if(frontMetrics.status !== "not_available" && sideMetrics.status === "not_available") {
    // ì •ë©´ ë¶„ì„ë§Œ ìˆëŠ” ê²½ìš° - ì •ë©´ ë©”íŠ¸ë¦­ë§Œ ì‚¬ìš©
    mergedMetrics = { ...frontMetrics };
    // âœ… orientationì„ mergedMetricsì— ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
    mergedMetrics.orientation = "front";
    
    // âœ… ê¸°ì¡´ ì¸¡ë©´ ë©”íŠ¸ë¦­ ë³´ì¡´ (ì´ì „ ë¶„ì„ ê²°ê³¼ ìœ ì§€)
    const existingSideMetrics = S.metrics?.sideMetrics || null;
    
    S.metrics = { 
      fullMetrics: mergedMetrics,  // ì •ë©´ ë¶„ì„ ê²°ê³¼ë§Œ
      orientation: "front",
      frontMetrics: frontMetrics,
      sideMetrics: existingSideMetrics // âœ… ê¸°ì¡´ ì¸¡ë©´ ë©”íŠ¸ë¦­ ë³´ì¡´
    };
    window.fullMetrics = mergedMetrics;
    
    // ì •ë©´ ë¶„ì„ ì ìˆ˜ ê³„ì‚° (ì •ë©´ ë©”íŠ¸ë¦­ë§Œ ì‚¬ìš©)
    const scoreData = computeScoreFromFullMetrics(mergedMetrics);
    S.score = scoreData;
    
    // âœ… ì •ë©´ ë¶„ì„ ì „ì— ì´ì „ ë¶„ì„ ê²°ê³¼ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ (ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ ë³´ì¡´)
    
    // ì •ë©´ ë¶„ì„ì— ëŒ€í•œ DB ê¸°ë°˜ ë¶„ì„ ì‹¤í–‰ (ì •ë©´ ë©”íŠ¸ë¦­ë§Œ ì „ë‹¬)
    analyzeMusclesWithDB(mergedMetrics, "front").then(analysis => {
      // âœ… ì •ë©´ ë¶„ì„ ê²°ê³¼ë¥¼ ë³„ë„ë¡œ ì €ì¥
      S.frontAnalysis = {
        ...analysis,
        fullMetrics: mergedMetrics,
        orientation: "front"
      };
      S.analysis = S.frontAnalysis; // í•˜ìœ„ í˜¸í™˜ì„±
      
      // âœ… sessions.Afterì—ë„ ì •ë©´ ë¶„ì„ ê²°ê³¼ ì €ì¥ (PDF ìƒì„± ì‹œ ì‚¬ìš©)
      if (sessions.After) {
        sessions.After.frontAnalysis = S.frontAnalysis;
        sessions.After.metrics = sessions.After.metrics || {};
        sessions.After.metrics.frontMetrics = frontMetrics;
        sessions.After.metrics.sideMetrics = existingSideMetrics; // ê¸°ì¡´ ì¸¡ë©´ ë©”íŠ¸ë¦­ ë³´ì¡´
        sessions.After.score = scoreData;
      }
      
      updateDisplay();
      updateCompare();
      // âœ… ì •ë©´ ë¶„ì„ ê²°ê³¼ëŠ” updateScoreAndAnalysisì—ì„œ í†µí•© í‘œì‹œ (ê·¼ìœ¡ DB + í•„ë¼í…ŒìŠ¤ DB ì—°ë™ í¬í•¨)
      // ì „ì²´ í•­ëª© í‘œì‹œë¥¼ ìœ„í•´ updateScoreAndAnalysis í˜¸ì¶œ (scoreData ê°ì²´ ì „ì²´ ì „ë‹¬)
      updateScoreAndAnalysis(scoreData, null, null, null, S.frontAnalysis);
    }).catch(err => {
      console.warn('ì •ë©´ DB ê¸°ë°˜ ë¶„ì„ ì‹¤íŒ¨, ê¸°ë³¸ ë¶„ì„ ì‚¬ìš©:', err);
      // âœ… ì •ë©´ ë¶„ì„ ê²°ê³¼ë¥¼ ë³„ë„ë¡œ ì €ì¥
      S.frontAnalysis = { 
        fullMetrics: mergedMetrics,
        orientation: "front",
        comments: [],
        details: [],
        exercises: []
      };
      S.analysis = S.frontAnalysis; // í•˜ìœ„ í˜¸í™˜ì„±
      
      // âœ… sessions.Afterì—ë„ ì •ë©´ ë¶„ì„ ê²°ê³¼ ì €ì¥ (PDF ìƒì„± ì‹œ ì‚¬ìš©)
      if (sessions.After) {
        sessions.After.frontAnalysis = S.frontAnalysis;
        sessions.After.metrics = sessions.After.metrics || {};
        sessions.After.metrics.frontMetrics = frontMetrics;
        sessions.After.metrics.sideMetrics = existingSideMetrics; // ê¸°ì¡´ ì¸¡ë©´ ë©”íŠ¸ë¦­ ë³´ì¡´
        sessions.After.score = scoreData;
      }
      
      updateDisplay();
      updateCompare();
      // âœ… ì •ë©´ ë¶„ì„ ê²°ê³¼ëŠ” updateScoreAndAnalysisì—ì„œ í†µí•© í‘œì‹œ (ê·¼ìœ¡ DB + í•„ë¼í…ŒìŠ¤ DB ì—°ë™ í¬í•¨)
      updateScoreAndAnalysis(scoreData, null, null, null, S.frontAnalysis);
    });
    
    // âœ… ì •ë©´ ë¶„ì„ ì‹œì—ëŠ” ê³¨ë°˜ ë¶„ì„ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ (ì¸¡ë©´ ì§€í‘œ í•„ìš”)
    // analyzePelvicTiltAuto(); // ì •ë©´ ë¶„ì„ì—ì„œëŠ” PTAê°€ ì—†ìœ¼ë¯€ë¡œ ì œì™¸
    
  } else if(sideMetrics.status !== "not_available") {
  // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œë„ ì €ì¥
    // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ í†µí•©
    mergedMetrics = { ...sideMetrics };
    
    // ì •ë©´ ë¶„ì„ ê²°ê³¼ë„ ìˆìœ¼ë©´ ë³‘í•© (í†µí•© ë¶„ì„ìš©)
    if(frontMetrics.status !== "not_available") {
      Object.assign(mergedMetrics, frontMetrics);
    }
    const cva = sideMetrics.CVA?.value_deg || null;
    const pelvic = sideMetrics.PTA?.value_deg || null;
    const knee = sideMetrics.KA?.value_deg || null;
    
    // âœ… ê¸°ì¡´ ì •ë©´ ë©”íŠ¸ë¦­ ë³´ì¡´ (ì´ì „ ë¶„ì„ ê²°ê³¼ ìœ ì§€)
    const existingFrontMetrics = S.metrics?.frontMetrics || (frontMetrics.status !== "not_available" ? frontMetrics : null);
    
    S.metrics = { 
      cva, 
      pelvic, 
      knee,
      fullMetrics: mergedMetrics,  // ì¸¡ë©´ + ì •ë©´ í†µí•© ê²°ê³¼
      orientation: "side",
      sideMetrics: sideMetrics, // âœ… ì¸¡ë©´ ë©”íŠ¸ë¦­ ë³„ë„ ì €ì¥
      frontMetrics: existingFrontMetrics  // âœ… ì •ë©´ ë¶„ì„ ê²°ê³¼ ë³„ë„ ì €ì¥ (ê¸°ì¡´ ê²ƒ ë³´ì¡´)
    };
    
    window.fullMetrics = mergedMetrics;
    
    // âœ… ì ìˆ˜ ê³„ì‚°ì€ í•­ìƒ fullMetrics ê¸°ë°˜ìœ¼ë¡œ ì¼ê´€ì„± ìœ ì§€
    const score = computeScoreFromFullMetrics(mergedMetrics);
    S.score = score;
    
    // AI ë¶„ì„ ì‹¤í–‰ (í†µí•©ëœ fullMetrics ì‚¬ìš©) - ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜
    // âœ… ì¸¡ë©´ ë¶„ì„ì´ ìˆìœ¼ë©´ "side" orientation ì „ë‹¬
    analyzeMusclesWithDB(mergedMetrics, "side").then(analysis => {
      // âœ… ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ë¥¼ ë³„ë„ë¡œ ì €ì¥
      S.sideAnalysis = {
        ...analysis,
        fullMetrics: mergedMetrics,
        orientation: "side"
      };
      S.analysis = S.sideAnalysis; // í•˜ìœ„ í˜¸í™˜ì„±
      
      // âœ… sessions.Afterì—ë„ ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ ì €ì¥ (PDF ìƒì„± ì‹œ ì‚¬ìš©)
      if (sessions.After) {
        sessions.After.sideAnalysis = S.sideAnalysis;
        sessions.After.metrics = sessions.After.metrics || {};
        // âœ… mergedMetricsì—ì„œ ì¸¡ë©´ ë©”íŠ¸ë¦­ë§Œ ì¶”ì¶œí•˜ì—¬ ì €ì¥ (sideMetricsëŠ” status: "not_available"ì¼ ìˆ˜ ìˆìŒ)
        const sideOnlyMetrics = {};
        Object.keys(mergedMetrics).forEach(key => {
          if (key === 'orientation') return;
          const code = METRIC_KEY_ALIASES[key] || key;
          const sideKeys = ['CVA', 'CVA_S', 'HPD', 'HPD_S', 'TIA', 'TIA_S', 'SAA', 'SAA_S', 'PTA', 'PTA_S', 'KA', 'KA_S', 'GSB', 'GSB_S', 'PDS', 'PDS_S'];
          if (sideKeys.includes(code) || sideKeys.includes(key)) {
            sideOnlyMetrics[key] = mergedMetrics[key];
          }
        });
        sideOnlyMetrics.orientation = "side";
        sessions.After.metrics.sideMetrics = sideOnlyMetrics;
        sessions.After.metrics.frontMetrics = existingFrontMetrics; // ê¸°ì¡´ ì •ë©´ ë©”íŠ¸ë¦­ ë³´ì¡´
        sessions.After.score = score;
        console.log('âœ… ì¸¡ë©´ ë©”íŠ¸ë¦­ ì €ì¥:', Object.keys(sideOnlyMetrics).length, 'ê°œ');
      }
      
      updateDisplay();
      updateCompare();
      // âœ… ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ëŠ” updateScoreAndAnalysisì—ì„œ í†µí•© í‘œì‹œ (ê·¼ìœ¡ DB + í•„ë¼í…ŒìŠ¤ DB ì—°ë™ í¬í•¨)
      updateScoreAndAnalysis(score, cva, pelvic, knee, S.sideAnalysis);
    }).catch(err => {
      console.warn('DB ê¸°ë°˜ ë¶„ì„ ì‹¤íŒ¨, ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©:', err);
      const analysis = analyzeMuscles(cva, pelvic, knee, mergedMetrics);
      // âœ… ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ë¥¼ ë³„ë„ë¡œ ì €ì¥
      S.sideAnalysis = {
        ...analysis,
        fullMetrics: mergedMetrics,
        orientation: "side"
      };
      S.analysis = S.sideAnalysis; // í•˜ìœ„ í˜¸í™˜ì„±
      updateDisplay();
      updateCompare();
      // âœ… ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ëŠ” updateScoreAndAnalysisì—ì„œ í†µí•© í‘œì‹œ (ê·¼ìœ¡ DB + í•„ë¼í…ŒìŠ¤ DB ì—°ë™ í¬í•¨)
      updateScoreAndAnalysis(score, cva, pelvic, knee, S.sideAnalysis);
    });
    
    // ê³¨ë°˜ ë¶„ì„ ìë™ ì‹¤í–‰
    analyzePelvicTiltAuto();
    
  } else if(frontMetrics.status !== "not_available") {
    // ì •ë©´ ë¶„ì„ë§Œ ìˆëŠ” ê²½ìš° - ì •ë©´ ë©”íŠ¸ë¦­ë§Œ ì‚¬ìš©
    mergedMetrics = { ...frontMetrics };
    // âœ… orientationì„ mergedMetricsì— ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
    mergedMetrics.orientation = "front";
    
    S.metrics = { 
      fullMetrics: mergedMetrics,  // ì •ë©´ ë¶„ì„ ê²°ê³¼ë§Œ
      orientation: "front",
      frontMetrics: frontMetrics
    };
    window.fullMetrics = mergedMetrics;
    
    // ì •ë©´ ë¶„ì„ ì ìˆ˜ ê³„ì‚° (ì •ë©´ ë©”íŠ¸ë¦­ë§Œ ì‚¬ìš©)
    const scoreData = computeScoreFromFullMetrics(mergedMetrics);
    S.score = scoreData;
    
    // ì •ë©´ ë¶„ì„ì— ëŒ€í•œ DB ê¸°ë°˜ ë¶„ì„ ì‹¤í–‰ (ì •ë©´ ë©”íŠ¸ë¦­ë§Œ ì „ë‹¬)
    analyzeMusclesWithDB(mergedMetrics, "front").then(analysis => {
      // âœ… ì •ë©´ ë¶„ì„ ê²°ê³¼ë¥¼ ë³„ë„ë¡œ ì €ì¥
      S.frontAnalysis = {
        ...analysis,
        fullMetrics: mergedMetrics,
        orientation: "front"
      };
      S.analysis = S.frontAnalysis; // í•˜ìœ„ í˜¸í™˜ì„±
      updateDisplay();
      updateCompare();
      // âœ… ì •ë©´ ë¶„ì„ ê²°ê³¼ëŠ” updateScoreAndAnalysisì—ì„œ í†µí•© í‘œì‹œ (ê·¼ìœ¡ DB + í•„ë¼í…ŒìŠ¤ DB ì—°ë™ í¬í•¨)
      // ì „ì²´ í•­ëª© í‘œì‹œë¥¼ ìœ„í•´ updateScoreAndAnalysis í˜¸ì¶œ (scoreData ê°ì²´ ì „ì²´ ì „ë‹¬)
      updateScoreAndAnalysis(scoreData, null, null, null, S.frontAnalysis);
    }).catch(err => {
      console.warn('ì •ë©´ DB ê¸°ë°˜ ë¶„ì„ ì‹¤íŒ¨, ê¸°ë³¸ ë¶„ì„ ì‚¬ìš©:', err);
      // âœ… ì •ë©´ ë¶„ì„ ê²°ê³¼ë¥¼ ë³„ë„ë¡œ ì €ì¥
      S.frontAnalysis = { 
        fullMetrics: mergedMetrics,
        orientation: "front",
        comments: [],
        details: [],
        exercises: []
      };
      S.analysis = S.frontAnalysis; // í•˜ìœ„ í˜¸í™˜ì„±
      updateDisplay();
      updateCompare();
      // âœ… ì •ë©´ ë¶„ì„ ê²°ê³¼ëŠ” updateScoreAndAnalysisì—ì„œ í†µí•© í‘œì‹œ (ê·¼ìœ¡ DB + í•„ë¼í…ŒìŠ¤ DB ì—°ë™ í¬í•¨)
      updateScoreAndAnalysis(scoreData, null, null, null, S.frontAnalysis);
    });
    
    // âœ… ì •ë©´ ë¶„ì„ ì‹œì—ëŠ” ê³¨ë°˜ ë¶„ì„ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ (ì¸¡ë©´ ì§€í‘œ í•„ìš”)
    // analyzePelvicTiltAuto(); // ì •ë©´ ë¶„ì„ì—ì„œëŠ” PTAê°€ ì—†ìœ¼ë¯€ë¡œ ì œì™¸
  } else {
    // ë¶„ì„ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°
    S.metrics = {};
    S.score = null;
    S.analysis = null;
    updateDisplay();
    updateCompare();
    // ë¹ˆ ë°ì´í„°ë¡œ UI ì´ˆê¸°í™”
    updateScoreAndAnalysis(null, null, null, null, null);
    
    // ê³¨ë°˜ ë¶„ì„ ì˜ì—­ ìˆ¨ê¸°ê¸°
    const pelvicDescEl = document.getElementById("pelvicDesc");
    if (pelvicDescEl) {
      pelvicDescEl.style.display = "none";
    }
  }
}

// âœ… ì •ë©´ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
function displayFrontAnalysis(fullMetrics) {
  const commentEl = document.getElementById("aiComment");
  const commentPanel = document.getElementById("aiCommentPanel");
  
  if(!fullMetrics || Object.keys(fullMetrics).length === 0) {
    commentPanel.style.display = "none";
    return;
  }
  
  let commentText = "ğŸ“· ì •ë©´ ìì„¸ ë¶„ì„ ê²°ê³¼:\n\n";
  const details = [];
  
  // ì •ë©´ ì§€í‘œë§Œ í•„í„°ë§ (ì¸¡ë©´ ì§€í‘œ ì œì™¸)
  const sideMetrics = ['CVA', 'HPD', 'TIA', 'SAA', 'PTA', 'KA', 'GSB', 'HPA', 'Tibial_Angle', 'Tibial', 'Tibial_Inclination'];
  const frontMetrics = ['STA', 'STA_F', 'POA', 'POA_F', 'LLD', 'LLD_F', 'Q_Angle', 'QAngle', 'Knee_Deviation', 'KneeDev', 'TD', 'HTA', 'SPP', 'KAS', 'LLAS'];
  
  for(const [key, value] of Object.entries(fullMetrics)) {
    // ì¸¡ë©´ ì§€í‘œëŠ” ì œì™¸
    if(sideMetrics.some(sm => key === sm || key.startsWith(sm))) {
      continue;
    }
    
    // ì •ë©´ ì§€í‘œë§Œ í‘œì‹œ
    if(!frontMetrics.some(fm => key === fm || key.startsWith(fm))) {
      continue;
    }
    
    if(value && value.value_deg != null) {
      const statusText = {
        "normal": "âœ… ì •ìƒ",
        "mild": "âš ï¸ ê²½ë¯¸",
        "moderate": "âš ï¸ ì¤‘ë“±ë„",
        "severe": "ğŸ”´ ì‹¬ê°"
      }[value.status] || value.status;
      
      commentText += `${key}: ${value.value_deg.toFixed(1)}Â° (${statusText})\n`;
      details.push(`â€¢ ${value.meaning || key}`);
    } else if(value && value.value_cm != null) {
      const statusText = {
        "normal": "âœ… ì •ìƒ",
        "mild": "âš ï¸ ê²½ë¯¸",
        "moderate": "âš ï¸ ì¤‘ë“±ë„",
        "severe": "ğŸ”´ ì‹¬ê°"
      }[value.status] || value.status;
      
      commentText += `${key}: ${value.value_cm.toFixed(2)}cm (${statusText})\n`;
      details.push(`â€¢ ${value.meaning || key}`);
    }
  }
  
  if(details.length > 0) {
    commentText += "\n" + details.join("\n");
  } else {
    commentText += "ì •ë©´ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
  }
  
  commentEl.innerHTML = commentText.replace(/\n/g, '<br>');
  commentPanel.style.display = "block";
}

// âœ… ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
function displaySideAnalysis(fullMetrics) {
  const commentEl = document.getElementById("aiComment");
  const commentPanel = document.getElementById("aiCommentPanel");
  
  if(!fullMetrics || Object.keys(fullMetrics).length === 0) {
    commentPanel.style.display = "none";
    return;
  }
  
  let commentText = "ğŸ“ ì¸¡ë©´ ìì„¸ ë¶„ì„ ê²°ê³¼:\n\n";
  const details = [];
  
  // ì¸¡ë©´ ì§€í‘œë§Œ í•„í„°ë§ (ì •ë©´ ì§€í‘œ ì œì™¸)
  const sideMetrics = ['CVA', 'HPD', 'TIA', 'SAA', 'PTA', 'KA', 'GSB', 'HPA', 'Tibial_Angle', 'Tibial'];
  const frontMetrics = ['STA', 'STA_F', 'POA', 'POA_F', 'LLD', 'LLD_F', 'Q_Angle', 'Knee_Deviation', 'TD', 'HTA', 'SPP', 'KAS', 'LLAS'];
  
  for(const [key, value] of Object.entries(fullMetrics)) {
    // ì •ë©´ ì§€í‘œëŠ” ì œì™¸
    if(frontMetrics.some(fm => key === fm || key.startsWith(fm))) {
      continue;
    }
    
    // ì¸¡ë©´ ì§€í‘œë§Œ í‘œì‹œ
    if(!sideMetrics.some(sm => key === sm || key.startsWith(sm))) {
      continue;
    }
    
    if(value && value.value_deg != null) {
      const statusText = {
        "normal": "âœ… ì •ìƒ",
        "mild": "âš ï¸ ê²½ë¯¸",
        "moderate": "âš ï¸ ì¤‘ë“±ë„",
        "severe": "ğŸ”´ ì‹¬ê°"
      }[value.status] || value.status;
      
      commentText += `${key}: ${value.value_deg.toFixed(1)}Â° (${statusText})\n`;
      details.push(`â€¢ ${value.meaning || key}`);
    } else if(value && value.value_cm != null) {
      const statusText = {
        "normal": "âœ… ì •ìƒ",
        "mild": "âš ï¸ ê²½ë¯¸",
        "moderate": "âš ï¸ ì¤‘ë“±ë„",
        "severe": "ğŸ”´ ì‹¬ê°"
      }[value.status] || value.status;
      
      commentText += `${key}: ${value.value_cm.toFixed(2)}cm (${statusText})\n`;
      details.push(`â€¢ ${value.meaning || key}`);
    }
  }
  
  if(details.length > 0) {
    commentText += "\n" + details.join("\n");
  } else {
    commentText += "ì¸¡ë©´ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
  }
  
  commentEl.innerHTML = commentText.replace(/\n/g, '<br>');
  commentPanel.style.display = "block";
}


// ì „ì²´ ë¶„ì„ í•­ëª© ê¸°ì¤€ìœ¼ë¡œ ì²´í˜• ì¢…í•© ì ìˆ˜ ê³„ì‚°
function computeScoreFromFullMetrics(fullMetrics) {
  if(!fullMetrics || Object.keys(fullMetrics).length === 0) {
    return { score: null, reasons: [], penalties: 0 };
  }
  
  // âœ… orientation í™•ì¸í•˜ì—¬ ì •ë©´/ì¸¡ë©´ êµ¬ë¶„
  const S = sessions[cur];
  const orientation = fullMetrics?.orientation || S?.metrics?.orientation || "side";
  
  // âœ… ì‹¤ì œ ì¸¡ì •ëœ ë©”íŠ¸ë¦­ì´ ìˆëŠ”ì§€ í™•ì¸
  const hasValidMetrics = Object.keys(fullMetrics).some(key => {
    if (key === 'orientation') return false;
    const metric = fullMetrics[key];
    if (!metric || typeof metric !== 'object') return false;
    const val = metric.value != null ? metric.value : 
                (metric.value_deg != null ? metric.value_deg : 
                (metric.value_cm != null ? metric.value_cm : null));
    return val != null && !isNaN(val) && isFinite(val);
  });
  
  if (!hasValidMetrics) {
    console.warn('âš ï¸ ìœ íš¨í•œ ë©”íŠ¸ë¦­ì´ ì—†ìŠµë‹ˆë‹¤. ì ìˆ˜ ê³„ì‚° ë¶ˆê°€.');
    return { score: null, reasons: ['ì¸¡ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'], penalties: 0 };
  }
  
  let penalties = 0;
  let reasons = [];
  let metricCount = 0; // ì‹¤ì œ ê³„ì‚°ëœ ë©”íŠ¸ë¦­ ê°œìˆ˜
  
  // âœ… ì •ë©´ ë¶„ì„ë§Œ ìˆì„ ë•ŒëŠ” ì¸¡ë©´ í•­ëª© ê³„ì‚° ê±´ë„ˆë›°ê¸°
  // âœ… ì¸¡ë©´ í•­ëª© ê³„ì‚° (ì¸¡ë©´ ë¶„ì„ì´ê±°ë‚˜ í†µí•© ë¶„ì„ì¼ ë•Œë§Œ)
  if(orientation === "side" || orientation === "both") {
    // 1. CVA (Craniovertebral Angle) - ì •ìƒ â‰¥50Â°
    const cva = fullMetrics.CVA?.value;
    if(cva != null && !isNaN(cva) && isFinite(cva)) {
      metricCount++;
      if(cva < 50) {
        const delta = 50 - cva;
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 1.6 â†’ delta * 2.5
        const penalty = Math.min(50, delta * 2.5);
        penalties += penalty;
        reasons.push(`CVA ${cva.toFixed(1)}Â° (ì •ìƒ â‰¥50Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 2. HPD (Head Protrusion Distance) - ì •ìƒ â‰¤2cm
    const hpd = fullMetrics.HPD?.value;
    if(hpd != null && !isNaN(hpd) && isFinite(hpd)) {
      metricCount++;
      if(hpd > 2) {
      const delta = hpd - 2;
      // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 5 â†’ delta * 8
      const penalty = Math.min(30, delta * 8);
      penalties += penalty;
      reasons.push(`HPD ${hpd.toFixed(1)}cm (ì •ìƒ â‰¤2cm) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    
    // 4. TIA (Trunk Inclination Angle) - ì •ìƒ 0-10Â°
    const tia = fullMetrics.TIA?.value;
    if(tia != null && !isNaN(tia) && isFinite(tia)) {
      metricCount++;
      if(tia > 10) {
      const delta = tia - 10;
      // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 2 â†’ delta * 3
      const penalty = Math.min(30, delta * 3);
      penalties += penalty;
      reasons.push(`TIA ${tia.toFixed(1)}Â° (ì •ìƒ 0-10Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 5. SAA (Scapular Alignment Angle) - ì •ìƒ 0-10Â°
    const saa = fullMetrics.SAA?.value;
    if(saa != null && !isNaN(saa) && isFinite(saa)) {
      metricCount++;
      if(saa > 10) {
      const delta = saa - 10;
      // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 1.5 â†’ delta * 2.5
      const penalty = Math.min(25, delta * 2.5);
      penalties += penalty;
      reasons.push(`SAA ${saa.toFixed(1)}Â° (ì •ìƒ 0-10Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 6. PTA (Pelvic Tilt Angle) - ì •ìƒ 0-15Â° (ë¶€í˜¸ í¬í•¨: +ì „ë°©/-í›„ë°©)
    const ptaSigned = fullMetrics.PTA?.value_signed; // ë¶€í˜¸ í¬í•¨ ê°’ ì‚¬ìš©
    const pta = fullMetrics.PTA?.value; // ì ˆëŒ“ê°’
    if(ptaSigned != null && pta != null && !isNaN(ptaSigned) && !isNaN(pta) && isFinite(ptaSigned) && isFinite(pta)) {
      metricCount++;
      // ëª©í‘œëŠ” 0Â° (ì¤‘ë¦½)
      const absPta = Math.abs(ptaSigned);
      if(absPta > 15) {
        const delta = absPta - 15;
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 2 â†’ delta * 3
        const penalty = Math.min(45, delta * 3);
        penalties += penalty;
        // ë¶€í˜¸ í¬í•¨ ê°’ìœ¼ë¡œ í‘œì‹œ: ì–‘ìˆ˜=ì „ë°©ê²½ì‚¬, ìŒìˆ˜=í›„ë°©ê²½ì‚¬
        const sign = ptaSigned > 0 ? '+' : '';
        reasons.push(`ê³¨ë°˜ ê¸°ìš¸ê¸° ${sign}${ptaSigned.toFixed(1)}Â° (ëª©í‘œ 0Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      } else if(absPta > 0) {
        // 0-15ë„ ë²”ìœ„ ë‚´ì—ì„œë„ ëª©í‘œ 0ë„ì—ì„œ ë²—ì–´ë‚˜ë©´ ê°ì 
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: absPta * 2.0 â†’ absPta * 3.0
        const penalty = Math.min(45, absPta * 3.0);
        penalties += penalty;
        const sign = ptaSigned > 0 ? '+' : '';
        reasons.push(`ê³¨ë°˜ ê¸°ìš¸ê¸° ${sign}${ptaSigned.toFixed(1)}Â° (ëª©í‘œ 0Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 7. KA (Knee Alignment Angle) - ì •ìƒ 175-185Â°
    const ka = fullMetrics.KA?.value;
    if(ka != null && !isNaN(ka) && isFinite(ka)) {
      metricCount++;
      if(ka < 175) {
        const delta = 175 - ka;
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 2.5 â†’ delta * 3.5
        const penalty = Math.min(35, delta * 3.5);
        penalties += penalty;
        reasons.push(`KA ${ka.toFixed(1)}Â° (ì •ìƒ 175-185Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      } else if(ka > 185) {
        const delta = ka - 185;
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 2.5 â†’ delta * 3.5
        const penalty = Math.min(35, delta * 3.5);
        penalties += penalty;
        reasons.push(`KA ${ka.toFixed(1)}Â° (ì •ìƒ 175-185Â°, ê³¼ì‹ ì „) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 8. Tibial Angle - ì •ìƒ 0-10Â° (ì •ë©´ ì§€í‘œì´ì§€ë§Œ ì¸¡ë©´ ë¶„ì„ì—ë„ í¬í•¨ë  ìˆ˜ ìˆìŒ)
    const tibial = fullMetrics.Tibial_Angle?.value;
    if(tibial != null && !isNaN(tibial) && isFinite(tibial)) {
      metricCount++;
      if(tibial > 10) {
      const delta = tibial - 10;
      // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 1.5 â†’ delta * 2.5
      const penalty = Math.min(25, delta * 2.5);
      penalties += penalty;
      reasons.push(`Tibial ${tibial.toFixed(1)}Â° (ì •ìƒ 0-10Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 9. Q-Angle - ì •ìƒ 10-20Â° (ë‚¨ì„± 10-15Â°, ì—¬ì„± 15-20Â°) - ì •ë©´ í•­ëª©ì´ì§€ë§Œ ì¸¡ë©´ ë¶„ì„ì—ë„ í¬í•¨ë  ìˆ˜ ìˆìŒ
    const qAngle = fullMetrics.Q_Angle?.value;
    if(qAngle != null && !isNaN(qAngle) && isFinite(qAngle)) {
      // Q-Angleì´ ë¹„ì •ìƒì ìœ¼ë¡œ í¬ë©´ (ì˜ˆ: 90ë„ ì´ìƒ) ê³„ì‚° ì˜¤ë¥˜ë¡œ ê°„ì£¼í•˜ê³  ìŠ¤í‚µ
      if(qAngle > 90) {
        console.warn(`âš ï¸ Q-Angleì´ ë¹„ì •ìƒì ìœ¼ë¡œ í¼: ${qAngle.toFixed(1)}Â°, ì ìˆ˜ ê³„ì‚°ì—ì„œ ì œì™¸`);
      } else {
        if(qAngle < 10) {
          const delta = 10 - qAngle;
          // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 1.5 â†’ delta * 2.5
          const penalty = Math.min(25, delta * 2.5);
          penalties += penalty;
          reasons.push(`Q-Angle ${qAngle.toFixed(1)}Â° (ì •ìƒ 10-20Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
        } else if(qAngle > 20) {
          const delta = qAngle - 20;
          // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 2 â†’ delta * 3
          const penalty = Math.min(30, delta * 3);
          penalties += penalty;
          reasons.push(`Q-Angle ${qAngle.toFixed(1)}Â° (ì •ìƒ 10-20Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
        }
      }
    }
    
    // 10. Knee Deviation - ì •ìƒ 0-3Â° - ì •ë©´ í•­ëª©ì´ì§€ë§Œ ì¸¡ë©´ ë¶„ì„ì—ë„ í¬í•¨ë  ìˆ˜ ìˆìŒ
    const kneeDev = fullMetrics.Knee_Deviation?.value;
    if(kneeDev != null && kneeDev > 3) {
      const delta = kneeDev - 3;
      // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 3 â†’ delta * 4
      const penalty = Math.min(25, delta * 4);
      penalties += penalty;
      reasons.push(`Knee Dev ${kneeDev.toFixed(1)}Â° (ì •ìƒ 0-3Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
    
    // 11. LLD (Leg Length Discrepancy) - ì •ìƒ â‰¤1cm - ì •ë©´ í•­ëª©ì´ì§€ë§Œ ì¸¡ë©´ ë¶„ì„ì—ë„ í¬í•¨ë  ìˆ˜ ìˆìŒ
    const lld = fullMetrics.LLD?.value;
    if(lld != null && lld > 1) {
      const delta = lld - 1;
      const penalty = Math.min(25, delta * 10);
      penalties += penalty;
      reasons.push(`LLD ${lld.toFixed(1)}cm (ì •ìƒ â‰¤1cm) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
    
    // 12. GSB (Global Sagittal Balance) - ì •ìƒ â‰¤2cm
    const gsb = fullMetrics.GSB?.value;
    if(gsb != null && !isNaN(gsb) && isFinite(gsb)) {
      metricCount++;
      if(gsb > 2) {
      const delta = gsb - 2;
      // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 5 â†’ delta * 8
      const penalty = Math.min(30, delta * 8);
      penalties += penalty;
      reasons.push(`GSB ${gsb.toFixed(1)}cm (ì •ìƒ â‰¤2cm) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 15. HPA (Headâ€“Pelvis Angle) - ì •ìƒ 0-10Â° (ì •ë©´ ì§€í‘œì´ì§€ë§Œ ì¸¡ë©´ ë¶„ì„ì—ë„ í¬í•¨ë  ìˆ˜ ìˆìŒ)
    const hpa = fullMetrics.HPA?.value;
    if(hpa != null && !isNaN(hpa) && isFinite(hpa)) {
      metricCount++;
      if(hpa > 10) {
      const delta = hpa - 10;
      // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 1.5 â†’ delta * 2.5
      const penalty = Math.min(25, delta * 2.5);
      penalties += penalty;
      reasons.push(`HPA ${hpa.toFixed(1)}Â° (ì •ìƒ 0-10Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
  }
  
  // âœ… ì •ë©´ í•­ëª© ê³„ì‚° (ì •ë©´ ë¶„ì„ì´ê±°ë‚˜ í†µí•© ë¶„ì„ì¼ ë•Œë§Œ)
  // âœ… ì •ë©´ ë¶„ì„ë§Œ ìˆì„ ë•ŒëŠ” ì¸¡ë©´ í•­ëª© ê³„ì‚°ì„ ê±´ë„ˆë›°ê³  ë°”ë¡œ ì •ë©´ í•­ëª© ê³„ì‚°
  if(orientation === "front" || orientation === "both") {
    // 16. STA (Shoulder Tilt Angle) - ì •ìƒ â‰¤3Â°
    const sta = fullMetrics.STA_F?.value || fullMetrics.STA?.value;
    if(sta != null && !isNaN(sta) && isFinite(sta)) {
      metricCount++;
      if(sta > 3) {
        const delta = sta - 3;
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: 3-10Â°: ê²½ë¯¸ (delta * 3), 10-20Â°: ì¤‘ë“±ë„ (delta * 3.5), 20Â° ì´ìƒ: ì‹¬ê° (delta * 4)
        let penaltyMultiplier = delta <= 7 ? 3 : (delta <= 17 ? 3.5 : 4);
        const penalty = Math.min(50, delta * penaltyMultiplier);
        penalties += penalty;
        reasons.push(`STA ${sta.toFixed(1)}Â° (ì •ìƒ â‰¤3Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 17. POA (Pelvic Obliquity Angle) - ì •ìƒ â‰¤3Â°
    const poa = fullMetrics.POA_F?.value || fullMetrics.POA?.value;
    if(poa != null && !isNaN(poa) && isFinite(poa)) {
      metricCount++;
      if(poa > 3) {
        const delta = poa - 3;
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: 3-10Â°: ê²½ë¯¸ (delta * 3), 10-20Â°: ì¤‘ë“±ë„ (delta * 3.5), 20Â° ì´ìƒ: ì‹¬ê° (delta * 4)
        let penaltyMultiplier = delta <= 7 ? 3 : (delta <= 17 ? 3.5 : 4);
        const penalty = Math.min(55, delta * penaltyMultiplier);
        penalties += penalty;
        reasons.push(`POA ${poa.toFixed(1)}Â° (ì •ìƒ â‰¤3Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 18. LLD_F (Leg Length Discrepancy) - ì •ìƒ â‰¤1cm (ì¸¡ë©´ LLDì™€ ì¤‘ë³µë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ê³„ì‚°)
    const lld_f = fullMetrics.LLD_F?.value;
    if(lld_f != null && !isNaN(lld_f) && isFinite(lld_f)) {
      metricCount++;
      if(lld_f > 1) {
        // ì¸¡ë©´ LLDê°€ ì´ë¯¸ ê³„ì‚°ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ ê³„ì‚°
        if(!fullMetrics.LLD || fullMetrics.LLD.value === lld_f) {
          const delta = lld_f - 1;
          const penalty = Math.min(25, delta * 10);
          penalties += penalty;
          reasons.push(`LLD_F ${lld_f.toFixed(1)}cm (ì •ìƒ â‰¤1cm) - ${penalty.toFixed(0)}ì  ê°ì `);
        }
      }
    }
    
    // 19. TD (Trunk Deviation) - ì •ìƒ Â±2Â°
    const td = fullMetrics.TD?.value;
    if(td != null && !isNaN(td) && isFinite(td)) {
      metricCount++;
      if(td > 2) {
        const delta = td - 2;
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 3 â†’ delta * 4
        const penalty = Math.min(25, delta * 4);
        penalties += penalty;
        reasons.push(`TD ${td.toFixed(1)}Â° (ì •ìƒ Â±2Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 20. HTA (Head Tilt Angle) - ì •ìƒ â‰¤3Â°
    const hta = fullMetrics.HTA?.value;
    if(hta != null && !isNaN(hta) && isFinite(hta)) {
      metricCount++;
      if(hta > 3) {
        const delta = hta - 3;
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: 3-10Â°: ê²½ë¯¸ (delta * 3), 10-20Â°: ì¤‘ë“±ë„ (delta * 3.5), 20Â° ì´ìƒ: ì‹¬ê° (delta * 4)
        let penaltyMultiplier = delta <= 7 ? 3 : (delta <= 17 ? 3.5 : 4);
        const penalty = Math.min(55, delta * penaltyMultiplier);
        penalties += penalty;
        reasons.push(`HTA ${hta.toFixed(1)}Â° (ì •ìƒ â‰¤3Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 21. SPP (Shoulderâ€“Pelvis Parallelism) - ì •ìƒ 0-3Â°
    const spp = fullMetrics.SPP?.value;
    if(spp != null && !isNaN(spp) && isFinite(spp)) {
      metricCount++;
      if(spp > 3) {
        const delta = spp - 3;
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 3 â†’ delta * 4
        const penalty = Math.min(25, delta * 4);
        penalties += penalty;
        reasons.push(`SPP ${spp.toFixed(1)}Â° (ì •ìƒ 0-3Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 22. KAS (Knee Alignment Symmetry) - ì •ìƒ Â±2Â°
    const kas = fullMetrics.KAS?.value;
    if(kas != null && !isNaN(kas) && isFinite(kas)) {
      metricCount++;
      if(kas > 2) {
        const delta = kas - 2;
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 3 â†’ delta * 4
        const penalty = Math.min(25, delta * 4);
        penalties += penalty;
        reasons.push(`KAS ${kas.toFixed(1)}Â° (ì •ìƒ Â±2Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 23. LLAS (Lower Limb Axis Symmetry) - ì •ìƒ Â±2Â°
    const llas = fullMetrics.LLAS?.value;
    if(llas != null && !isNaN(llas) && isFinite(llas)) {
      metricCount++;
      if(llas > 2) {
        const delta = llas - 2;
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 3 â†’ delta * 4
        const penalty = Math.min(25, delta * 4);
        penalties += penalty;
        reasons.push(`LLAS ${llas.toFixed(1)}Â° (ì •ìƒ Â±2Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
    
    // 24. Q-Angle - ì •ìƒ 10-20Â° (ë‚¨ì„± 10-15Â°, ì—¬ì„± 15-20Â°)
    const qAngle = fullMetrics.Q_Angle?.value;
    if(qAngle != null && !isNaN(qAngle) && isFinite(qAngle)) {
      metricCount++;
      // Q-Angleì´ ë¹„ì •ìƒì ìœ¼ë¡œ í¬ë©´ (ì˜ˆ: 90ë„ ì´ìƒ) ê³„ì‚° ì˜¤ë¥˜ë¡œ ê°„ì£¼í•˜ê³  ìŠ¤í‚µ
      if(qAngle > 90) {
        console.warn(`âš ï¸ Q-Angleì´ ë¹„ì •ìƒì ìœ¼ë¡œ í¼: ${qAngle.toFixed(1)}Â°, ì ìˆ˜ ê³„ì‚°ì—ì„œ ì œì™¸`);
        metricCount--; // metricCount ì¦ê°€ë¥¼ ì·¨ì†Œ
      } else {
        if(qAngle < 10) {
          const delta = 10 - qAngle;
          // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 1.5 â†’ delta * 2.5
          const penalty = Math.min(25, delta * 2.5);
          penalties += penalty;
          reasons.push(`Q-Angle ${qAngle.toFixed(1)}Â° (ì •ìƒ 10-20Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
        } else if(qAngle > 20) {
          const delta = qAngle - 20;
          // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 2 â†’ delta * 3
          const penalty = Math.min(30, delta * 3);
          penalties += penalty;
          reasons.push(`Q-Angle ${qAngle.toFixed(1)}Â° (ì •ìƒ 10-20Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
        }
      }
    }
    
    // 25. Knee Deviation - ì •ìƒ 0-3Â°
    const kneeDev = fullMetrics.Knee_Deviation?.value || fullMetrics['Knee_Deviation']?.value_deg;
    if(kneeDev != null && !isNaN(kneeDev) && isFinite(kneeDev)) {
      metricCount++;
      if(kneeDev > 3) {
        const delta = kneeDev - 3;
        // âœ… ê°ì  ê¸°ì¤€ ê°•í™”: delta * 3 â†’ delta * 4
        const penalty = Math.min(25, delta * 4);
        penalties += penalty;
        reasons.push(`Knee Dev ${kneeDev.toFixed(1)}Â° (ì •ìƒ 0-3Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
      }
    }
  }
  
  // âœ… ì¸¡ì •ëœ ë©”íŠ¸ë¦­ì´ ì—†ìœ¼ë©´ null ë°˜í™˜ (ì •ë©´/ì¸¡ë©´ í•­ëª© ê³„ì‚° í›„ì— ì²´í¬)
  // âœ… ê²½ê³  ì œê±°: ì¸¡ì • ë°ì´í„°ê°€ ì—†ì„ ë•ŒëŠ” ì¡°ìš©íˆ null ë°˜í™˜ (ê²½ê³  ë¡œê·¸ ì œê±°)
  if (metricCount === 0) {
    return { score: null, reasons: ['ì¸¡ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'], penalties: 0 };
  }
  
  // âœ… ê°ì  ê·¼ê±°ì— ê¸°ë°˜í•˜ì—¬ ì²´í˜• ì¢…í•© ì ìˆ˜ ê³„ì‚°
  // í•­ìƒ ê³„ì‚°ëœ penaltiesë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì ìˆ˜ë¥¼ ì‚°ì¶œí•˜ì—¬ ê°ì  ê·¼ê±°ì™€ ì¼ì¹˜ì‹œí‚´
  const score = Math.round(clamp(100 - penalties, 0, 100));
  
  // âœ… ì¸¡ì •ëœ ë©”íŠ¸ë¦­ì´ ìˆì§€ë§Œ ê°ì ì´ ì—†ìœ¼ë©´ 100ì  (ì •ìƒ)
  // ì¸¡ì •ëœ ë©”íŠ¸ë¦­ì´ ì—†ìœ¼ë©´ null ë°˜í™˜ (ì´ë¯¸ ìœ„ì—ì„œ ì²˜ë¦¬ë¨)
  
  return { score, reasons, penalties, metricCount };
}

// ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ í•¨ìˆ˜ (í•˜ìœ„ í˜¸í™˜)
function computeScore(cva, pelvic, knee) {
  // fullMetricsê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
  const S = sessions[cur];
  const fullMetrics = S.metrics?.fullMetrics;
  if(fullMetrics && Object.keys(fullMetrics).length > 0) {
    return computeScoreFromFullMetrics(fullMetrics);
  }
  
  // ê¸°ì¡´ ë°©ì‹ (fallback)
  let penalties = 0;
  let reasons = [];
  
  if(cva != null) {
    const target = 50;
    const delta = Math.max(0, target - cva);
    const penalty = Math.min(40, delta * 1.6);
    penalties += penalty;
    if(penalty > 0) {
      reasons.push(`CVA ${cva.toFixed(1)}Â° (ëª©í‘œ ${target}Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  if(pelvic != null) {
    const abs = Math.abs(pelvic);
    const target = 0;
    const penalty = Math.min(30, abs * 2.0);
    penalties += penalty;
    if(penalty > 0) {
      reasons.push(`ê³¨ë°˜ ê¸°ìš¸ê¸° ${pelvic.toFixed(1)}Â° (ëª©í‘œ ${target}Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  if(knee != null) {
    const target = 180;
    const delta = Math.max(0, target - knee);
    const penalty = Math.min(30, delta * 1.0);
    penalties += penalty;
    if(penalty > 0) {
      reasons.push(`ë¬´ë¦ ê° ${knee.toFixed(1)}Â° (ëª©í‘œ ${target}Â°) - ${penalty.toFixed(0)}ì  ê°ì `);
    }
  }
  
  const score = Math.round(clamp(100 - penalties, 0, 100));
  return { score, reasons, penalties };
}

// ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜ ê·¼ìœ¡ ë¶„ì„ í•¨ìˆ˜
async function analyzeMusclesWithDB(fullMetrics = null, orientation = null) {
  if (!fullMetrics) {
    return analyzeMuscles(null, null, null, null);
  }
  
  try {
    // ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ
    await loadPostureDB();
    
    // âœ… orientationì´ ëª…ì‹œë˜ì§€ ì•Šìœ¼ë©´ ì„¸ì…˜ì—ì„œ í™•ì¸
    if (!orientation) {
      orientation = sessions[cur]?.poseData?.orientation || sessions[cur]?.metrics?.orientation || fullMetrics?.orientation || "side";
    }
    
    // fullMetricsë¥¼ í‰íƒ„í™”í•˜ì—¬ analyzeWithDBì— ì „ë‹¬
    // âœ… orientationì„ ì „ë‹¬í•˜ì—¬ ì¸¡ë©´/ì •ë©´ ë©”íŠ¸ë¦­ í•„í„°ë§
    const flatMetrics = flattenFullMetrics(fullMetrics, orientation);
    if (flatMetrics.PTA == null && fullMetrics.PTA) {
      const ptaSigned = fullMetrics.PTA.value_signed;
      if (typeof ptaSigned === 'number' && !Number.isNaN(ptaSigned)) {
        flatMetrics.PTA = ptaSigned;
      } else {
        const ptaVal = extractMetricValue(fullMetrics.PTA);
        if (ptaVal != null) flatMetrics.PTA = ptaVal;
      }
    }
    if (flatMetrics.PDS == null && fullMetrics.PDS) {
      const pdsVal = extractMetricValue(fullMetrics.PDS);
      if (pdsVal != null) flatMetrics.PDS = pdsVal;
    }
    if (flatMetrics.PDS == null) {
      const sessionScore = sessions?.[cur]?.score?.score;
      if (typeof sessionScore === 'number' && !Number.isNaN(sessionScore)) {
        flatMetrics.PDS = sessionScore;
      }
    }
    if (Object.keys(flatMetrics).length === 0) {
      return analyzeMuscles(null, null, null, fullMetrics);
    }
    
    // DB ê¸°ë°˜ ë¶„ì„ ì‹¤í–‰
    // âœ… orientationì„ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬í•˜ì—¬ ì •ë©´/ì¸¡ë©´ êµ¬ë¶„
    const dbAnalysis = await analyzeWithDB(flatMetrics, orientation);
    
    // ê¸°ì¡´ analyzeMuscles í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    // âœ… ì•ˆì „ ê°€ë“œ: muscles ê°ì²´ê°€ ì—†ì„ ê²½ìš° ë¹ˆ ë°°ì—´ ì‚¬ìš©
    const muscles = dbAnalysis?.muscles || {};
    const tightSet = new Set();
    const weakSet = new Set();
    const comments = [];
    const details = [];
    const exercises = [];
    const patterns = [];
    
    // DB ë¶„ì„ ê²°ê³¼ë¥¼ íŒ¨í„´ìœ¼ë¡œ ë³€í™˜
    // âœ… ì•ˆì „ ê°€ë“œ: topRecommendationsê°€ ì—†ì„ ê²½ìš° ë¹ˆ ë°°ì—´ ì²˜ë¦¬
    const recommendations = dbAnalysis?.topRecommendations || dbAnalysis?.matches || [];
    recommendations.forEach((rec, idx) => {
      // âœ… ì•ˆì „ ê°€ë“œ: rec ê°ì²´ ì†ì„± ì•ˆì „í•˜ê²Œ ì ‘ê·¼
      patterns.push({
        name: rec?.name || rec?.code || 'ì•Œ ìˆ˜ ì—†ìŒ',
        description: `${rec?.code || ''} ${rec?.abnormal || ''}`,
        meaning: rec?.note || '',
        priority: idx < 3 ? 'high' : idx < 6 ? 'medium' : 'low'
      });
      
      // âœ… ê·¼ìœ¡ ì •ë³´ ì¶”ì¶œ ë° Setì— ì¶”ê°€ (CSV DBì˜ ë°°ì—´ ì§ì ‘ ì‚¬ìš©)
      // tightMusclesì™€ weakMuscles ë°°ì—´ì„ ìš°ì„  ì‚¬ìš© (ì´ë¯¸ CSVì—ì„œ íŒŒì‹±ëœ ì •í™•í•œ ê·¼ìœ¡ëª…)
      if (rec?.tightMuscles && Array.isArray(rec.tightMuscles)) {
        rec.tightMuscles.forEach(m => {
          if (m && typeof m === 'string') {
            tightSet.add(m.trim());
          }
        });
      } else if (rec?.tight) {
        // ë°°ì—´ì´ ì—†ìœ¼ë©´ ë¬¸ìì—´ì„ ì‰¼í‘œë¡œë§Œ ë¶„ë¦¬ (ê³µë°±ì€ ìœ ì§€)
        const tightArray = typeof rec.tight === 'string' 
          ? rec.tight.split(',').map(m => m.trim()).filter(Boolean)
          : (Array.isArray(rec.tight) ? rec.tight : []);
        tightArray.forEach(m => {
          if (m && typeof m === 'string') {
            tightSet.add(m.trim());
          }
        });
      }
      
      if (rec?.weakMuscles && Array.isArray(rec.weakMuscles)) {
        rec.weakMuscles.forEach(m => {
          if (m && typeof m === 'string') {
            weakSet.add(m.trim());
          }
        });
      } else if (rec?.weak) {
        // ë°°ì—´ì´ ì—†ìœ¼ë©´ ë¬¸ìì—´ì„ ì‰¼í‘œë¡œë§Œ ë¶„ë¦¬ (ê³µë°±ì€ ìœ ì§€)
        const weakArray = typeof rec.weak === 'string'
          ? rec.weak.split(',').map(m => m.trim()).filter(Boolean)
          : (Array.isArray(rec.weak) ? rec.weak : []);
        weakArray.forEach(m => {
          if (m && typeof m === 'string') {
            weakSet.add(m.trim());
          }
        });
      }
      
      // muscles ê°ì²´ì—ì„œë„ ì¶”ê°€ (ì´ì¤‘í™” ë°©ì§€)
      if (muscles.tight && Array.isArray(muscles.tight)) {
        muscles.tight.forEach(m => {
          if (m && typeof m === 'string') {
            tightSet.add(m.trim());
          }
        });
      }
      if (muscles.weak && Array.isArray(muscles.weak)) {
        muscles.weak.forEach(m => {
          if (m && typeof m === 'string') {
            weakSet.add(m.trim());
          }
        });
      }
      
      // ì½”ë©˜íŠ¸ ì¶”ê°€
      const hasTight = (rec?.tightMuscles && rec.tightMuscles.length > 0) || rec?.tight;
      const hasWeak = (rec?.weakMuscles && rec.weakMuscles.length > 0) || rec?.weak;
      if (hasTight || hasWeak) {
        comments.push(`${rec?.name || rec?.code || 'ì•Œ ìˆ˜ ì—†ìŒ'}: ${rec?.abnormal || ''}`);
        const tightList = rec?.tightMuscles && Array.isArray(rec.tightMuscles) 
          ? rec.tightMuscles.join(', ')
          : (rec?.tight || 'â€”');
        const weakList = rec?.weakMuscles && Array.isArray(rec.weakMuscles)
          ? rec.weakMuscles.join(', ')
          : (rec?.weak || 'â€”');
        details.push(`â€¢ ê¸´ì¥ ê·¼ìœ¡: ${tightList || 'â€”'}`);
        details.push(`â€¢ ì•½í™” ê·¼ìœ¡: ${weakList || 'â€”'}`);
      }
      
      // í•„ë¼í…ŒìŠ¤ ìš´ë™ ì¶”ê°€
      // âœ… ì•ˆì „ ê°€ë“œ: rec ê°ì²´ì˜ ì†ì„± ì•ˆì „í•˜ê²Œ ì ‘ê·¼
      const pilatesExercises = [];
      if (rec?.mat) pilatesExercises.push({ equipment: 'ë§¤íŠ¸', name: rec.mat });
      if (rec?.reformer) pilatesExercises.push({ equipment: 'ë¦¬í¬ë¨¸', name: rec.reformer });
      if (rec?.cadillac) pilatesExercises.push({ equipment: 'ìºë”œë½', name: rec.cadillac });
      if (rec?.chair) pilatesExercises.push({ equipment: 'ì²´ì–´', name: rec.chair });
      if (rec?.barrel) pilatesExercises.push({ equipment: 'ë°”ë ', name: rec.barrel });
      
      if (pilatesExercises.length > 0) {
        exercises.push({
          pattern: rec?.name || rec?.code || 'ì•Œ ìˆ˜ ì—†ìŒ',
          equipment: pilatesExercises
        });
      }
    });
    
    // âœ… í•„ë¼í…ŒìŠ¤ ìš´ë™ ë°°ì—´ ìƒì„± (updateScoreAndAnalysisì—ì„œ ì‚¬ìš©)
    const pilatesArray = recommendations.map((rec, idx) => {
      // âœ… pilatesExercises ê°ì²´ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš© (Pilates_Exercise_DB_1000_v2.jsonì—ì„œ ë¡œë“œëœ ìƒì„¸ ì •ë³´)
      const itemExercises = rec?.pilatesExercises || {};
      
      // ê¸°ì¡´ ë¬¸ìì—´ í•„ë“œë„ í™•ì¸ (í•˜ìœ„ í˜¸í™˜ì„±)
      if (!itemExercises['ë§¤íŠ¸'] || itemExercises['ë§¤íŠ¸'].length === 0) {
        if (rec?.mat) {
          if (!itemExercises['ë§¤íŠ¸']) itemExercises['ë§¤íŠ¸'] = [];
          // ë¬¸ìì—´ì¸ ê²½ìš° ê°ì²´ë¡œ ë³€í™˜
          const matStr = typeof rec.mat === 'string' ? rec.mat : '';
          if (matStr) {
            itemExercises['ë§¤íŠ¸'].push({ name: matStr, ko: matStr });
          }
        }
      }
      if (!itemExercises['ë¦¬í¬ë¨¸'] || itemExercises['ë¦¬í¬ë¨¸'].length === 0) {
        if (rec?.reformer) {
          if (!itemExercises['ë¦¬í¬ë¨¸']) itemExercises['ë¦¬í¬ë¨¸'] = [];
          const reformerStr = typeof rec.reformer === 'string' ? rec.reformer : '';
          if (reformerStr) {
            itemExercises['ë¦¬í¬ë¨¸'].push({ name: reformerStr, ko: reformerStr });
          }
        }
      }
      if (!itemExercises['ìºë”œë½'] || itemExercises['ìºë”œë½'].length === 0) {
        if (rec?.cadillac) {
          if (!itemExercises['ìºë”œë½']) itemExercises['ìºë”œë½'] = [];
          const cadillacStr = typeof rec.cadillac === 'string' ? rec.cadillac : '';
          if (cadillacStr) {
            itemExercises['ìºë”œë½'].push({ name: cadillacStr, ko: cadillacStr });
          }
        }
      }
      if (!itemExercises['ì²´ì–´'] || itemExercises['ì²´ì–´'].length === 0) {
        if (rec?.chair) {
          if (!itemExercises['ì²´ì–´']) itemExercises['ì²´ì–´'] = [];
          const chairStr = typeof rec.chair === 'string' ? rec.chair : '';
          if (chairStr) {
            itemExercises['ì²´ì–´'].push({ name: chairStr, ko: chairStr });
          }
        }
      }
      if (!itemExercises['ë°”ë '] || itemExercises['ë°”ë '].length === 0) {
        if (rec?.barrel) {
          if (!itemExercises['ë°”ë ']) itemExercises['ë°”ë '] = [];
          const barrelStr = typeof rec.barrel === 'string' ? rec.barrel : '';
          if (barrelStr) {
            itemExercises['ë°”ë '].push({ name: barrelStr, ko: barrelStr });
          }
        }
      }
      
      return {
        name: rec?.name || rec?.code || `íŒ¨í„´ ${idx + 1}`,
        issue: rec?.abnormal || '',
        condition: `${rec?.code || ''} ${rec?.abnormal || ''}`,
        interpretation: rec?.note || '',
        tight: rec?.tight ? (typeof rec.tight === 'string' ? rec.tight.split(/[,\s]+/).filter(Boolean) : rec.tight) : [],
        weak: rec?.weak ? (typeof rec.weak === 'string' ? rec.weak.split(/[,\s]+/).filter(Boolean) : rec.weak) : [],
        muscles: rec?.tight ? (typeof rec.tight === 'string' ? rec.tight.split(/[,\s]+/).filter(Boolean) : rec.tight) : [],
        pilates: itemExercises
      };
    }).filter(item => Object.keys(item.pilates).length > 0); // í•„ë¼í…ŒìŠ¤ ìš´ë™ì´ ìˆëŠ” ê²ƒë§Œ í•„í„°ë§
    
    // âœ… ìµœì¢… ê·¼ìœ¡ ë°°ì—´ ìƒì„± (Setì—ì„œ ë°°ì—´ë¡œ ë³€í™˜)
    const tight = Array.from(tightSet).filter(Boolean);
    const weak = Array.from(weakSet).filter(Boolean);
    
    return {
      tight: tight.length > 0 ? tight : (Array.isArray(muscles.tight) ? muscles.tight : []),
      weak: weak.length > 0 ? weak : (Array.isArray(muscles.weak) ? muscles.weak : []),
      comments: comments.length > 0 ? comments : ['ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜ ë¶„ì„ ì™„ë£Œ'],
      details: details.length > 0 ? details : [],
      exercises: exercises,
      patterns: patterns,
      pilates: pilatesArray, // âœ… í•„ë¼í…ŒìŠ¤ ìš´ë™ ë°°ì—´ ì¶”ê°€
      fullMetrics: fullMetrics
    };
  } catch (err) {
    console.error('DB ê¸°ë°˜ ë¶„ì„ ì‹¤íŒ¨:', err);
    // í´ë°±: ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
    return analyzeMuscles(null, null, null, fullMetrics);
  }
}

// ê¸°ì¡´ í•¨ìˆ˜ (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)
function analyzeMuscles(cva, pelvic, knee, fullMetrics = null) {
  const tight = [];
  const weak = [];
  const comments = [];
  const details = [];
  const exercises = [];
  
  // âš™ï¸ í•´ì„ ìš”ì•½ íŒ¨í„´ ë¶„ì„
  const patterns = [];
  
  // íŒ¨í„´ 1: ê±°ë¶ëª©(FHP): CVAâ†“, HPDâ†‘
  if(fullMetrics) {
    const cvaVal = fullMetrics.CVA?.value_deg;
    const hpdVal = fullMetrics.HPD?.value_cm;
    
    if(cvaVal != null && cvaVal < 50 && hpdVal != null && hpdVal > 2) {
      patterns.push({
        name: "ê±°ë¶ëª©(FHP)",
        description: `CVAâ†“(${cvaVal.toFixed(1)}Â°), HPDâ†‘(${hpdVal.toFixed(1)}cm)`,
        meaning: "ê²½ì¶” ì‹ ì „, ì‹¬ë¶€ êµ´ê·¼ ì•½í™”",
        priority: "high"
      });
      tight.push('ìƒë¶€ìŠ¹ëª¨ê·¼', 'ê²¬ê°‘ê±°ê·¼', 'SCM', 'í‰ì‡„ìœ ëŒê·¼');
      weak.push('ì‹¬ë¶€ê²½ë¶€êµ´ê·¼', 'ì „ê±°ê·¼');
    }
    
    // íŒ¨í„´ 2: ë¼ìš´ë“œ ìˆ„ë”(RSP): acromion ì „ë°© ì´ë™, SAAâ†‘
    const saaVal = fullMetrics.SAA?.value_deg;
    if(saaVal != null && saaVal > 10) {
      patterns.push({
        name: "ë¼ìš´ë“œ ìˆ„ë”(RSP)",
        description: `SAAâ†‘(${saaVal.toFixed(1)}Â°)`,
        meaning: "í‰ê·¼ ë‹¨ì¶•, í•˜ë¶€ìŠ¹ëª¨ ì•½í™”",
        priority: "high"
      });
      tight.push('í‰ê·¼', 'ì†Œí‰ê·¼');
      weak.push('í•˜ë¶€ìŠ¹ëª¨', 'ì „ê±°ê·¼', 'ì¤‘ë¶€ìŠ¹ëª¨');
    }
    
    // íŒ¨í„´ 3: ê³¼ì „ê²½ì‚¬ ê³¨ë°˜: PTAâ†‘ (>15Â°, ì–‘ìˆ˜ ê°’), ASISê°€ PSISë³´ë‹¤ ë‚®ìŒ
    const ptaVal = fullMetrics.PTA?.value_deg;
    const ptaSigned = fullMetrics.PTA?.value_signed;
    if(ptaVal != null && ptaSigned != null && ptaSigned > 15) {
      patterns.push({
        name: "ê³¼ì „ê²½ì‚¬ ê³¨ë°˜(Anterior Tilt)",
        description: `PTAâ†‘(${ptaSigned.toFixed(1)}Â°, ì–‘ìˆ˜) - ASISê°€ PSISë³´ë‹¤ ë‚®ìŒ`,
        meaning: "ìš”ì¶” ì „ë§Œ ì¦ê°€, hip flexor ë‹¨ì¶•",
        priority: "high"
      });
      tight.push('ì¥ìš”ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼', 'ëŒ€í‡´ì§ê·¼', 'í‰ìš”ê·¼ë§‰');
      weak.push('ë³µíš¡ê·¼', 'ë‘”ê·¼', 'ëŒ€ë‘”ê·¼', 'ì¤‘ë‘”ê·¼', 'í•˜ë‘”ê·¼');
    }
    
    // íŒ¨í„´ 4: í›„ê²½ì‚¬ ê³¨ë°˜: PTAâ†“ (ìŒìˆ˜ ë˜ëŠ” <5Â°), ASISê°€ PSISë³´ë‹¤ ë†’ìŒ
    if(ptaVal != null && ptaSigned != null && (ptaSigned < 0 || ptaSigned < 5)) {
      patterns.push({
        name: "í›„ê²½ì‚¬ ê³¨ë°˜(Posterior Tilt)",
        description: `PTAâ†“(${ptaSigned.toFixed(1)}Â°, ìŒìˆ˜ ë˜ëŠ” ì‘ì€ ê°’) - ASISê°€ PSISë³´ë‹¤ ë†’ìŒ`,
        meaning: "í–„ìŠ¤íŠ¸ë§/ë³µê·¼ ë‹¨ì¶•",
        priority: "medium"
      });
      tight.push('í–„ìŠ¤íŠ¸ë§', 'ë³µì§ê·¼', 'ë³µíš¡ê·¼');
      weak.push('ì¥ìš”ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼');
    }
    
    // íŒ¨í„´ 5: Xì ë‹¤ë¦¬(Valgus): KAâ†“ (<175Â°), Q-angleâ†‘
    const kaVal = fullMetrics.KA?.value_deg;
    const qAngleVal = fullMetrics.Q_Angle?.value_deg;
    if(kaVal != null && kaVal < 175) {
      patterns.push({
        name: "Xì ë‹¤ë¦¬(Valgus)",
        description: `KAâ†“(${kaVal.toFixed(1)}Â°)${qAngleVal != null ? `, Q-angleâ†‘(${qAngleVal.toFixed(1)}Â°)` : ''}`,
        meaning: "ë‚´ì¸¡ ë¬´ë¦ ë¶€í•˜ ì¦ê°€",
        priority: "high"
      });
      tight.push('ëŒ€í‡´ë‚´ì „ê·¼', 'ë¹„ë³µê·¼');
      weak.push('ëŒ€ë‘”ê·¼', 'ì¤‘ë‘”ê·¼', 'ëŒ€í‡´ì™¸ì „ê·¼');
    }
    
    // íŒ¨í„´ 6: Oì ë‹¤ë¦¬(Varus): KAâ†‘ (>180Â°)
    if(kaVal != null && kaVal > 180) {
      patterns.push({
        name: "Oì ë‹¤ë¦¬(Varus)",
        description: `KAâ†‘(${kaVal.toFixed(1)}Â°)`,
        meaning: "ì™¸ì¸¡ ë¬´ë¦ ë¶€í•˜ ì¦ê°€",
        priority: "high"
      });
      tight.push('ëŒ€í‡´ì™¸ì „ê·¼', 'ë¹„ë³µê·¼');
      weak.push('ëŒ€ë‘”ê·¼', 'ì¤‘ë‘”ê·¼', 'ëŒ€í‡´ë‚´ì „ê·¼');
    }
    
    // íŒ¨í„´ 7: ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© ì´ë™: GSBâ†‘
    const gsbVal = fullMetrics.GSB?.value_cm;
    if(gsbVal != null && gsbVal > 2) {
      patterns.push({
        name: "ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°© ì´ë™",
        description: `GSBâ†‘(${gsbVal.toFixed(1)}cm)`,
        meaning: "ìš”ì¶” ì „ë§Œ, ì¢…ê³¨ ìŠ¤íŠ¸ë ˆìŠ¤",
        priority: "medium"
      });
      tight.push('ì¥ìš”ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼');
      weak.push('ë³µíš¡ê·¼', 'ë‘”ê·¼');
    }
    
    // íŒ¨í„´ 8: ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°© ì´ë™: GSBâ†“
    if(gsbVal != null && gsbVal < -2) {
      patterns.push({
        name: "ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°© ì´ë™",
        description: `GSBâ†“(${gsbVal.toFixed(1)}cm)`,
        meaning: "ë‘”ê·¼ ê¸´ì¥, í–„ìŠ¤íŠ¸ë§ ë‹¨ì¶•",
        priority: "medium"
      });
      tight.push('ë‘”ê·¼', 'í–„ìŠ¤íŠ¸ë§');
      weak.push('ëŒ€í‡´ì‚¬ë‘ê·¼', 'ì¥ìš”ê·¼');
    }
    
    // íŒ¨í„´ ì •ë³´ë¥¼ commentsì— ì¶”ê°€
    if(patterns.length > 0) {
      comments.push(`\nğŸ“Š ìì„¸ íŒ¨í„´ ë¶„ì„:`);
      patterns.forEach((p, idx) => {
        comments.push(`${idx + 1}. ${p.name}: ${p.description} â†’ ${p.meaning}`);
      });
    }
  }
  
  // CVA ë¶„ì„ (ìƒì„¸)
  // CVA >= 50ë„ëŠ” ì •ìƒ ë²”ìœ„
  if(cva != null) {
    if(cva >= 50) {
      // 50ë„ ì´ìƒì´ë©´ ì •ìƒ ë²”ìœ„
      if(cva <= 55) {
        comments.push(`ê²½ì¶” ì •ë ¬ ì–‘í˜¸: CVA ${cva.toFixed(1)}Â° (ì •ìƒ ë²”ìœ„)`);
        details.push(`â€¢ ê²½ì¶” ì •ë ¬ì´ ì–‘í˜¸í•œ ìƒíƒœì…ë‹ˆë‹¤.`);
        details.push(`â€¢ í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•œ ì •ê¸°ì ì¸ ìŠ¤íŠ¸ë ˆì¹­ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`);
      } else {
        // 55ë„ ì´ˆê³¼ëŠ” í›„ë°© ê²½ì‚¬ (ê³¼ë„í•œ ê²½ìš°)
        comments.push(`ê²½ì¶” í›„ë°© ê²½ì‚¬: CVA ${cva.toFixed(1)}Â°ë¡œ ì •ìƒ ë²”ìœ„ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
        details.push(`â€¢ ê²½ì¶”ê°€ ê³¼ë„í•˜ê²Œ í›„ë°©ìœ¼ë¡œ ê¸°ìš¸ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.`);
        exercises.push('1. ê²½ì¶” ì „ë°© êµ´ê³¡ ìš´ë™: ì²œì²œíˆ í„±ì„ ê°€ìŠ´ ë°©í–¥ìœ¼ë¡œ ë‚´ë¦¬ê¸° (10íšŒÃ—2ì„¸íŠ¸)');
      }
    } else {
      // 50ë„ ë¯¸ë§Œì€ ì „ë°©ë‘ ìì„¸
      if(cva < 45) {
        tight.push('ìƒë¶€ìŠ¹ëª¨ê·¼', 'ê²¬ê°‘ê±°ê·¼', 'SCM', 'í‰ì‡„ìœ ëŒê·¼');
        weak.push('ì‹¬ë¶€ê²½ë¶€êµ´ê·¼', 'í•˜ë¶€ìŠ¹ëª¨ê·¼', 'ì „ê±°ê·¼');
        comments.push(`ì „ë°©ë‘ ìì„¸ ì‹¬ê°: CVA ${cva.toFixed(1)}Â°ë¡œ ì •ìƒ ë²”ìœ„(â‰¥50Â°)ë³´ë‹¤ ${(50-cva).toFixed(1)}Â° ë‚®ìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ìƒë¶€ìŠ¹ëª¨ê·¼ê³¼ ê²¬ê°‘ê±°ê·¼ì´ ì§€ì†ì ìœ¼ë¡œ ìˆ˜ì¶•ë˜ì–´ ëª©ê³¼ ì–´ê¹¨ í†µì¦ì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ì‹¬ë¶€ê²½ë¶€êµ´ê·¼ì´ ì•½í™”ë˜ì–´ ë¨¸ë¦¬ ë¬´ê²Œë¥¼ ì§€ì§€í•˜ì§€ ëª»í•´ ì „ë°© ì´ë™ì´ ê°€ì†í™”ë©ë‹ˆë‹¤.`);
        details.push(`â€¢ ì¥ê¸°ì ìœ¼ë¡œ ê²½ì¶” ë””ìŠ¤í¬ ì••ë ¥ ì¦ê°€ ë° ë‘í†µ, ì–´ê¹¨ ë»£ë»£í•¨ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        exercises.push('1. í„± ë‹¹ê¸°ê¸° ìš´ë™: ë²½ì— ë“±ì„ ëŒ€ê³  í„±ì„ ë’¤ë¡œ ë‹¹ê¸°ë©° 10ì´ˆ ìœ ì§€ (3ì„¸íŠ¸)');
        exercises.push('2. ì‹¬ë¶€ê²½ë¶€êµ´ê·¼ í™œì„±í™”: ëˆ„ì›Œì„œ í„±ì„ ê°€ìŠ´ì— ê°€ê¹ê²Œ ë‹¹ê¸°ë©° ë¨¸ë¦¬ë§Œ ì‚´ì§ ë“¤ì–´ì˜¬ë¦¬ê¸° (10íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('3. í•˜ë¶€ìŠ¹ëª¨ê·¼ ê°•í™”: íŒ”ì„ 30ë„ ê°ë„ë¡œ ì˜¬ë¦¬ë©° ì–´ê¹¨ë¼ˆë¥¼ ì•„ë˜ë¡œ ëˆŒëŸ¬ ëª¨ìœ¼ê¸° (15íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('4. ìƒë¶€ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ë¨¸ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ê¸°ìš¸ì—¬ ë°˜ëŒ€í¸ ì–´ê¹¨ ë°©í–¥ìœ¼ë¡œ ìŠ¤íŠ¸ë ˆì¹­ (ì¢Œìš° ê° 30ì´ˆ)');
      } else {
        tight.push('ìƒë¶€ìŠ¹ëª¨ê·¼', 'ê²¬ê°‘ê±°ê·¼');
        weak.push('ì‹¬ë¶€ê²½ë¶€êµ´ê·¼');
        comments.push(`ì „ë°©ë‘ ìì„¸ ê²½ë¯¸: CVA ${cva.toFixed(1)}Â°ë¡œ ì •ìƒ ë²”ìœ„(â‰¥50Â°)ì— ê·¼ì ‘í•©ë‹ˆë‹¤.`);
        details.push(`â€¢ ìƒë¶€ìŠ¹ëª¨ê·¼ê³¼ ê²¬ê°‘ê±°ê·¼ì— ì•½ê°„ì˜ ê¸´ì¥ì´ ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ì‹¬ë¶€ê²½ë¶€êµ´ê·¼ í™œì„±í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
        exercises.push('1. í„± ë‹¹ê¸°ê¸° ìš´ë™: ë²½ì— ë“±ì„ ëŒ€ê³  í„±ì„ ë’¤ë¡œ ë‹¹ê¸°ê¸° (10ì´ˆÃ—3ì„¸íŠ¸)');
        exercises.push('2. ì‹¬ë¶€ê²½ë¶€êµ´ê·¼ ê°•í™”: ëˆ„ì›Œì„œ ë¨¸ë¦¬ë§Œ ì‚´ì§ ë“¤ì–´ì˜¬ë¦¬ê¸° (10íšŒÃ—2ì„¸íŠ¸)');
        exercises.push('3. ìƒë¶€ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ì¢Œìš° ê° 30ì´ˆì”© ìŠ¤íŠ¸ë ˆì¹­');
      }
    }
  }
  
  // ê³¨ë°˜ ê¸°ìš¸ê¸° ë¶„ì„ (ìƒì„¸)
  if(pelvic != null) {
    const abs = Math.abs(pelvic);
    if(abs > 5) {
      if(pelvic > 0) {
        tight.push('ì¥ìš”ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼', 'ëŒ€í‡´ì§ê·¼', 'í‰ìš”ê·¼ë§‰');
        weak.push('ë³µíš¡ê·¼', 'ë‘”ê·¼', 'ëŒ€ë‘”ê·¼', 'ì¤‘ë‘”ê·¼', 'í•˜ë‘”ê·¼');
        comments.push(`ê³¨ë°˜ ì „ë°©ê²½ì‚¬ ì‹¬ê°: ${pelvic.toFixed(1)}Â°ë¡œ ëª©í‘œ 0Â°ë³´ë‹¤ ${pelvic.toFixed(1)}Â° í½ë‹ˆë‹¤.`);
        details.push(`â€¢ ì¥ìš”ê·¼ì´ ë‹¨ì¶•ë˜ì–´ ê³¨ë°˜ì„ ì•ìœ¼ë¡œ ë‹¹ê¸°ê³  ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ìš”ì¶” ì „ë§Œì´ ì¦ê°€í•˜ì—¬ í—ˆë¦¬ í†µì¦ ìœ„í—˜ì´ ë†’ìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ë³µíš¡ê·¼ê³¼ ë‘”ê·¼ì´ ì•½í™”ë˜ì–´ ê³¨ë°˜ ì•ˆì •ì„±ì´ ë–¨ì–´ì§‘ë‹ˆë‹¤.`);
        exercises.push('1. ì¥ìš”ê·¼ ìŠ¤íŠ¸ë ˆì¹­: í•œìª½ ë¬´ë¦ì„ ì•ìœ¼ë¡œ ë‚´ë°€ê³  ë°˜ëŒ€í¸ ë‹¤ë¦¬ë¥¼ ë’¤ë¡œ ë»—ì–´ ìŠ¤íŠ¸ë ˆì¹­ (ì¢Œìš° ê° 30ì´ˆÃ—3íšŒ)');
        exercises.push('2. ë‘”ê·¼ ê°•í™”: ëˆ„ì›Œì„œ ì—‰ë©ì´ë¥¼ ë“¤ì–´ì˜¬ë¦¬ë©° ë‘”ê·¼ ìˆ˜ì¶• (15íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('3. ë³µíš¡ê·¼ í™œì„±í™”: ë„¤ ë°œë¡œ ì—ë“œë ¤ì„œ ë³µë¶€ë¥¼ ì•ˆìœ¼ë¡œ ë‹¹ê¸°ë©° í˜¸í¡ (10íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('4. í™ ë¸Œë¦¿ì§€: ëˆ„ì›Œì„œ ë¬´ë¦ì„ êµ¬ë¶€ë¦¬ê³  ì—‰ë©ì´ë¥¼ ë“¤ì–´ì˜¬ë¦¬ê¸° (15íšŒÃ—3ì„¸íŠ¸)');
      } else {
        tight.push('ë‘”ê·¼', 'í–„ìŠ¤íŠ¸ë§', 'ìš”ì¶”ì‹ ê·¼');
        weak.push('ë³µì§ê·¼', 'ì¥ìš”ê·¼', 'ëŒ€í‡´ì‚¬ë‘ê·¼');
        comments.push(`ê³¨ë°˜ í›„ë°©ê²½ì‚¬: ${pelvic.toFixed(1)}Â°ë¡œ ëª©í‘œ 0Â°ë³´ë‹¤ ì‘ìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ë‘”ê·¼ê³¼ í–„ìŠ¤íŠ¸ë§ì´ ê³¼ë„í•˜ê²Œ ê¸´ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ë³µì§ê·¼ê³¼ ì¥ìš”ê·¼ì´ ì•½í™”ë˜ì–´ ê³¨ë°˜ì´ ë’¤ë¡œ ê¸°ìš¸ì–´ì§‘ë‹ˆë‹¤.`);
        exercises.push('1. ë‘”ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ì•‰ì•„ì„œ í•œìª½ ë¬´ë¦ì„ ê°€ìŠ´ì— ë‹¹ê¸°ê¸° (ì¢Œìš° ê° 30ì´ˆ)');
        exercises.push('2. í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­: ë‹¤ë¦¬ë¥¼ ë»—ê³  ì•ìœ¼ë¡œ ìˆ™ì´ê¸° (30ì´ˆÃ—3íšŒ)');
        exercises.push('3. ë³µì§ê·¼ ê°•í™”: í¬ëŸ°ì¹˜ ìš´ë™ (15íšŒÃ—3ì„¸íŠ¸)');
        exercises.push('4. ì¥ìš”ê·¼ ê°•í™”: ë¬´ë¦ ë‹¹ê¸°ê¸° ìš´ë™ (10íšŒÃ—3ì„¸íŠ¸)');
      }
    } else {
      comments.push(`ê³¨ë°˜ ì •ë ¬ ì–‘í˜¸: ${pelvic.toFixed(1)}Â°`);
      details.push(`â€¢ ê³¨ë°˜ ì •ë ¬ì´ ì–‘í˜¸í•œ ìƒíƒœì…ë‹ˆë‹¤.`);
    }
  }
  
  // ë¬´ë¦ ê°ë„ ë¶„ì„ (ìƒì„¸)
  if(knee != null) {
    if(knee < 175) {
      if(knee < 165) {
        tight.push('í–„ìŠ¤íŠ¸ë§', 'ë¹„ë³µê·¼', 'ê°€ìë¯¸ê·¼', 'ìŠ¬ì™€ê·¼');
        weak.push('ëŒ€í‡´ì‚¬ë‘ê·¼', 'ë‘”ê·¼', 'ëŒ€í‡´ì§ê·¼');
        comments.push(`ë¬´ë¦ ê³¼êµ´ê³¡ ì‹¬ê°: ${knee.toFixed(1)}Â°ë¡œ ëª©í‘œ 180Â°ë³´ë‹¤ ${(180-knee).toFixed(1)}Â° ë‚®ìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ í–„ìŠ¤íŠ¸ë§ê³¼ ë¹„ë³µê·¼ì´ ì‹¬ê°í•˜ê²Œ ë‹¨ì¶•ë˜ì–´ ë¬´ë¦ì„ êµ¬ë¶€ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ëŒ€í‡´ì‚¬ë‘ê·¼ì´ ì•½í™”ë˜ì–´ ë¬´ë¦ì„ í´ì§€ ëª»í•©ë‹ˆë‹¤.`);
        details.push(`â€¢ ì¥ê¸°ì ìœ¼ë¡œ ë¬´ë¦ ê´€ì ˆ ì••ë ¥ ì¦ê°€ ë° ì „ë°© ì‹­ìì¸ëŒ€ ë¶€ìƒ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.`);
        exercises.push('1. í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­: ì„œì„œ ë‹¤ë¦¬ë¥¼ ì˜¬ë¦¬ê³  ì•ìœ¼ë¡œ ìˆ™ì´ê¸° (ì¢Œìš° ê° 30ì´ˆÃ—3íšŒ)');
        exercises.push('2. ë¹„ë³µê·¼ ìŠ¤íŠ¸ë ˆì¹­: ë²½ì— ì†ì„ ëŒ€ê³  í•œìª½ ë‹¤ë¦¬ë¥¼ ë’¤ë¡œ ë‚´ë°€ë©° ìŠ¤íŠ¸ë ˆì¹­ (ì¢Œìš° ê° 30ì´ˆ)');
        exercises.push('3. ëŒ€í‡´ì‚¬ë‘ê·¼ ê°•í™”: ì˜ìì— ì•‰ì•„ ë‹¤ë¦¬ë¥¼ í´ë©° ë¬´ë¦ ë½ (10ì´ˆ ìœ ì§€Ã—10íšŒ)');
        exercises.push('4. ìŠ¤ì¿¼íŠ¸: ì²œì²œíˆ ì•‰ì•˜ë‹¤ ì¼ì–´ì„œê¸° (10íšŒÃ—3ì„¸íŠ¸)');
      } else {
        tight.push('í–„ìŠ¤íŠ¸ë§', 'ë¹„ë³µê·¼');
        weak.push('ëŒ€í‡´ì‚¬ë‘ê·¼');
        comments.push(`ë¬´ë¦ ì•½ê°„ êµ´ê³¡: ${knee.toFixed(1)}Â°ë¡œ ëª©í‘œì— ê·¼ì ‘í•©ë‹ˆë‹¤.`);
        details.push(`â€¢ í–„ìŠ¤íŠ¸ë§ê³¼ ë¹„ë³µê·¼ì— ì•½ê°„ì˜ ê¸´ì¥ì´ ìˆìŠµë‹ˆë‹¤.`);
        details.push(`â€¢ ëŒ€í‡´ì‚¬ë‘ê·¼ ê°•í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
        exercises.push('1. í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­: ì¢Œìš° ê° 30ì´ˆì”© ìŠ¤íŠ¸ë ˆì¹­');
        exercises.push('2. ëŒ€í‡´ì‚¬ë‘ê·¼ ê°•í™”: ì˜ìì— ì•‰ì•„ ë‹¤ë¦¬ í´ê¸° (10íšŒÃ—2ì„¸íŠ¸)');
        exercises.push('3. ìŠ¤ì¿¼íŠ¸: 10íšŒÃ—2ì„¸íŠ¸');
      }
    } else if(knee <= 185) {
      comments.push(`ë¬´ë¦ ì •ë ¬ ì–‘í˜¸: ${knee.toFixed(1)}Â°`);
      details.push(`â€¢ ë¬´ë¦ ì •ë ¬ì´ ì–‘í˜¸í•œ ìƒíƒœì…ë‹ˆë‹¤.`);
    } else {
      comments.push(`ë¬´ë¦ ê³¼ì‹ ì „: ${knee.toFixed(1)}Â°ë¡œ ëª©í‘œë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
      details.push(`â€¢ ë¬´ë¦ì´ ê³¼ë„í•˜ê²Œ í´ì ¸ ìˆì–´ í›„ë°© ì‹­ìì¸ëŒ€ ë¶€ìƒ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.`);
      exercises.push('1. ë¬´ë¦ ë¯¸ì„¸ êµ´ê³¡ ì—°ìŠµ: ì„œì„œ ë¬´ë¦ì„ ì‚´ì§ êµ¬ë¶€ë¦¬ê¸° (10íšŒÃ—2ì„¸íŠ¸)');
      exercises.push('2. ëŒ€í‡´ì‚¬ë‘ê·¼ ì´ì™„: ëˆ„ì›Œì„œ ë¬´ë¦ ì•„ë˜ì— ë² ê°œë¥¼ ë„£ê³  ìŠ¤íŠ¸ë ˆì¹­');
    }
  }
  
  // ì¢…í•© ìš´ë™ ì¶”ì²œ
  if(exercises.length === 0 && (tight.length > 0 || weak.length > 0)) {
    exercises.push('1. ì „ì‹  ìŠ¤íŠ¸ë ˆì¹­: ë§¤ì¼ ì•„ì¹¨ 10ë¶„ê°„ ì „ì‹  ìŠ¤íŠ¸ë ˆì¹­');
    exercises.push('2. ì½”ì–´ ê°•í™”: í”Œë­í¬ 30ì´ˆ ìœ ì§€ (3ì„¸íŠ¸)');
    exercises.push('3. ìì„¸ êµì • ìš´ë™: ë²½ì— ë“±ì„ ëŒ€ê³  ì„œì„œ ëª¸ ì •ë ¬ ìœ ì§€ (1ë¶„Ã—3íšŒ)');
  }
  
  // í•„ë¼í…ŒìŠ¤ ì¶”ì²œ (íŒ¨í„´ ê¸°ë°˜)
  const pilates = [];
  
  if(fullMetrics) {
    // íŒ¨í„´ ê¸°ë°˜ í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ìƒì„±
    // 1. ê±°ë¶ëª©(FHP)
    const cvaVal = fullMetrics.CVA?.value_deg;
    const niaVal = fullMetrics.NIA?.value_deg;
    const hpdVal = fullMetrics.HPD?.value_cm;
    if(cvaVal != null && cvaVal < 50 && niaVal != null && niaVal > 20 && hpdVal != null && hpdVal > 2) {
      if(pilatesPatterns.FHP) {
        pilates.push({
          pattern: 'FHP',
          name: pilatesPatterns.FHP.name,
          condition: pilatesPatterns.FHP.condition,
          interpretation: pilatesPatterns.FHP.interpretation,
          tight: pilatesPatterns.FHP.tight,
          weak: pilatesPatterns.FHP.weak,
          exercises: pilatesPatterns.FHP.exercises
        });
      }
    }
    
    // 2. ë¼ìš´ë“œ ìˆ„ë”(RSP)
    const saaVal = fullMetrics.SAA?.value_deg;
    if(saaVal != null && saaVal > 10) {
      if(pilatesPatterns.RSP) {
        pilates.push({
          pattern: 'RSP',
          name: pilatesPatterns.RSP.name,
          condition: pilatesPatterns.RSP.condition,
          interpretation: pilatesPatterns.RSP.interpretation,
          tight: pilatesPatterns.RSP.tight,
          weak: pilatesPatterns.RSP.weak,
          exercises: pilatesPatterns.RSP.exercises
        });
      }
    }
    
    // 3. ê³¼ì „ê²½ì‚¬ ê³¨ë°˜
    const ptaVal = fullMetrics.PTA?.value_deg;
    if(ptaVal != null && ptaVal > 15) {
      if(pilatesPatterns.AnteriorTilt) {
        pilates.push({
          pattern: 'AnteriorTilt',
          name: pilatesPatterns.AnteriorTilt.name,
          condition: pilatesPatterns.AnteriorTilt.condition,
          interpretation: pilatesPatterns.AnteriorTilt.interpretation,
          tight: pilatesPatterns.AnteriorTilt.tight,
          weak: pilatesPatterns.AnteriorTilt.weak,
          exercises: pilatesPatterns.AnteriorTilt.exercises
        });
      }
    }
    
    // 4. í›„ê²½ì‚¬ ê³¨ë°˜
    if(ptaVal != null && ptaVal < 5) {
      if(pilatesPatterns.PosteriorTilt) {
        pilates.push({
          pattern: 'PosteriorTilt',
          name: pilatesPatterns.PosteriorTilt.name,
          condition: pilatesPatterns.PosteriorTilt.condition,
          interpretation: pilatesPatterns.PosteriorTilt.interpretation,
          tight: pilatesPatterns.PosteriorTilt.tight,
          weak: pilatesPatterns.PosteriorTilt.weak,
          exercises: pilatesPatterns.PosteriorTilt.exercises
        });
      }
    }
    
    // 5. Xì ë‹¤ë¦¬
    const kaVal = fullMetrics.KA?.value_deg;
    const qAngleVal = fullMetrics.Q_Angle?.value_deg;
    if(kaVal != null && kaVal < 175) {
      if(pilatesPatterns.GenuValgum) {
        pilates.push({
          pattern: 'GenuValgum',
          name: pilatesPatterns.GenuValgum.name,
          condition: pilatesPatterns.GenuValgum.condition,
          interpretation: pilatesPatterns.GenuValgum.interpretation,
          tight: pilatesPatterns.GenuValgum.tight,
          weak: pilatesPatterns.GenuValgum.weak,
          exercises: pilatesPatterns.GenuValgum.exercises
        });
      }
    }
    
    // 6. Oì ë‹¤ë¦¬
    if(kaVal != null && kaVal > 180) {
      if(pilatesPatterns.GenuVarum) {
        pilates.push({
          pattern: 'GenuVarum',
          name: pilatesPatterns.GenuVarum.name,
          condition: pilatesPatterns.GenuVarum.condition,
          interpretation: pilatesPatterns.GenuVarum.interpretation,
          tight: pilatesPatterns.GenuVarum.tight,
          weak: pilatesPatterns.GenuVarum.weak,
          exercises: pilatesPatterns.GenuVarum.exercises
        });
      }
    }
    
    // 7. ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°©
    const gsbVal = fullMetrics.GSB?.value_cm;
    if(gsbVal != null && gsbVal > 2) {
      if(pilatesPatterns.ForwardCenter) {
        pilates.push({
          pattern: 'ForwardCenter',
          name: pilatesPatterns.ForwardCenter.name,
          condition: pilatesPatterns.ForwardCenter.condition,
          interpretation: pilatesPatterns.ForwardCenter.interpretation,
          tight: pilatesPatterns.ForwardCenter.tight,
          weak: pilatesPatterns.ForwardCenter.weak,
          exercises: pilatesPatterns.ForwardCenter.exercises
        });
      }
    }
    
    // 8. ì²´ì¤‘ ì¤‘ì‹¬ í›„ë°©
    if(gsbVal != null && gsbVal < -2) {
      if(pilatesPatterns.BackwardCenter) {
        pilates.push({
          pattern: 'BackwardCenter',
          name: pilatesPatterns.BackwardCenter.name,
          condition: pilatesPatterns.BackwardCenter.condition,
          interpretation: pilatesPatterns.BackwardCenter.interpretation,
          tight: pilatesPatterns.BackwardCenter.tight,
          weak: pilatesPatterns.BackwardCenter.weak,
          exercises: pilatesPatterns.BackwardCenter.exercises
        });
      }
    }
  }
  
  // íŒ¨í„´ ê¸°ë°˜ ì¶”ì²œì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
  if(pilates.length === 0) {
    const oldPilates = recommendPilates([...new Set(tight)], [...new Set(weak)]);
    pilates.push(...oldPilates);
  }
  
  return { 
    tight: [...new Set(tight)], 
    weak: [...new Set(weak)], 
    comments,
    details,
    exercises: [...new Set(exercises)],
    pilates
  };
}

// ì²´í˜• ìœ í˜• ë¶„ì„ í•¨ìˆ˜
function analyzePostureType(metrics, orientation = null) {
  if(!metrics || Object.keys(metrics).length === 0) {
    console.warn("âš ï¸ fullMetrics ì—†ìŒ - ë¶„ì„ ìƒëµ");
    return "ë¶„ì„ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
  }
  
  // âœ… orientation í™•ì¸ (ì •ë©´ ë¶„ì„ ì‹œ ì¸¡ë©´ ì§€í‘œ ì œì™¸)
  if (!orientation) {
    const S = sessions[cur];
    orientation = S?.metrics?.orientation || S?.poseData?.orientation || "side";
  }
  
  let analysis = [];
  let summarySection = '';
  let detailSections = [];
  let recommendations = [];
  
  // ì¸¡ì •ê°’ ì¶”ì¶œ (orientationì— ë”°ë¼ í•„í„°ë§)
  const cva = (orientation === "side") ? metrics.CVA?.value : null;
  const hpd = (orientation === "side") ? metrics.HPD?.value : null;
  const nia = (orientation === "side") ? metrics.NIA?.value : null;
  const pta = (orientation === "side") ? metrics.PTA?.value : null; // âœ… ì •ë©´ ë¶„ì„ ì‹œ ì œì™¸
  const ptaSigned = (orientation === "side") ? metrics.PTA?.value_signed : null; // âœ… ì •ë©´ ë¶„ì„ ì‹œ ì œì™¸
  const tia = (orientation === "side") ? metrics.TIA?.value : null;
  const ka = (orientation === "side") ? metrics.KA?.value : null;
  const gsb = (orientation === "side") ? metrics.GSB?.value : null;
  
  // ì •ë©´ ì§€í‘œ ì¶”ì¶œ (HPA, Tibial í¬í•¨ - ì¸¡ë©´ ë¶„ì„ ì‹œ ì œì™¸)
  const sta = (orientation === "front") ? (metrics.STA?.value || metrics.STA_F?.value) : null;
  const poa = (orientation === "front") ? (metrics.POA?.value || metrics.POA_F?.value) : null;
  const lld = (orientation === "front") ? (metrics.LLD?.value || metrics.LLD_F?.value) : null;
  const qAngle = (orientation === "front") ? metrics['Q_Angle']?.value : null;
  const kneeDev = (orientation === "front") ? metrics['Knee_Deviation']?.value : null;
  const td = (orientation === "front") ? metrics.TD?.value : null;
  const hta = (orientation === "front") ? metrics.HTA?.value : null;
  const spp = (orientation === "front") ? metrics.SPP?.value : null;
  const kas = (orientation === "front") ? metrics.KAS?.value : null;
  const llas = (orientation === "front") ? metrics.LLAS?.value : null;
  const hpa = (orientation === "front") ? metrics.HPA?.value : null;  // âœ… ì •ë©´ ì§€í‘œë¡œ ì´ë™
  const tibial = (orientation === "front") ? (metrics.Tibial_Angle?.value || metrics.Tibial?.value) : null;  // âœ… ì •ë©´ ì§€í‘œë¡œ ì´ë™
  
  const pds = metrics.PDS?.value;
  const pdsStatus = metrics.PDS?.status;
  
  // ë¬¸ì œ ì¹´ìš´íŠ¸
  let issueCount = 0;
  
  // âœ… ì •ë©´ ë¶„ì„ ì‹œ ì •ë©´ íŒ¨í„´ë§Œ í‘œì‹œ
  if (orientation === "front") {
    // === ì •ë©´: ì–´ê¹¨ ê¸°ìš¸ê¸° (Shoulder Tilt) ===
    if(sta != null && Math.abs(sta) > 3) {
      issueCount++;
      const severity = Math.abs(sta) > 6 ? 'ì‹¬ê°' : Math.abs(sta) > 4 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      detailSections.push(`
        <div style="border-left:3px solid #2ec4b6; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#2ec4b6; font-size:13px;">ğŸ“ ì–´ê¹¨ ê¸°ìš¸ê¸° (Shoulder Tilt) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> STA ${sta.toFixed(1)}Â° (ì •ìƒ: â‰¤3Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> í•œìª½ ì–´ê¹¨ ê·¼ìœ¡ ë¶ˆê· í˜•, ìŠ¬ë§ë°± ì‚¬ìš©, í•œìª½ìœ¼ë¡œ ì¹˜ìš°ì¹œ ìì„¸<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong>
            â€¢ ëª©ê³¼ ì–´ê¹¨ í†µì¦
            â€¢ ì²™ì¶” ì¸¡ë§Œì¦ ìœ„í—˜ ì¦ê°€
            â€¢ ì–´ê¹¨ ë†’ì´ ì°¨ì´ë¡œ ì¸í•œ ìì„¸ ë¶ˆê· í˜•<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ì–´ê¹¨ ë†’ì´ ê· í˜• ìš´ë™
            â‘¡ ìƒë¶€ ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­
            â‘¢ ì¤‘ë¶€/í•˜ë¶€ ìŠ¹ëª¨ê·¼ ê°•í™”
          </div>
        </div>
      `);
    }
    
    // === ì •ë©´: ê³¨ë°˜ ê¸°ìš¸ê¸° (Pelvic Obliquity) ===
    if(poa != null && Math.abs(poa) > 3) {
      issueCount++;
      const severity = Math.abs(poa) > 6 ? 'ì‹¬ê°' : Math.abs(poa) > 4 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      const side = poa > 0 ? 'ì¢Œì¸¡ í•˜ê°•' : 'ìš°ì¸¡ í•˜ê°•';
      detailSections.push(`
        <div style="border-left:3px solid #2ec4b6; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#2ec4b6; font-size:13px;">ğŸ“ ê³¨ë°˜ ê¸°ìš¸ê¸° (Pelvic Obliquity) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> POA ${poa.toFixed(1)}Â° (ì •ìƒ: â‰¤3Â°) - ${side}<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> í•˜ì§€ ê¸¸ì´ ì°¨ì´, í•œìª½ ë‹¤ë¦¬ì— ì²´ì¤‘ ë¶€í•˜, ê³¨ë°˜ ê·¼ìœ¡ ë¶ˆê· í˜•<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong>
            â€¢ ìš”í†µ ë° ê³¨ë°˜ í†µì¦
            â€¢ í•˜ì§€ ê¸¸ì´ ì°¨ì´ë¡œ ì¸í•œ ë³´í–‰ ì´ìƒ
            â€¢ ì²™ì¶” ì¸¡ë§Œì¦ ìœ„í—˜<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ê³¨ë°˜ ì •ë ¬ ìš´ë™
            â‘¡ ì¸¡ë©´ ì½”ì–´ ê°•í™”
            â‘¢ í•˜ì§€ ê¸¸ì´ ì°¨ì´ ë³´ì •
          </div>
        </div>
      `);
    }
    
    // === ì •ë©´: Q-Angle ë¬¸ì œ ===
    if(qAngle != null && (qAngle < 10 || qAngle > 20)) {
      issueCount++;
      const severity = qAngle < 5 || qAngle > 25 ? 'ì‹¬ê°' : qAngle < 8 || qAngle > 22 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      const issue = qAngle < 10 ? 'Q-Angle ê³¼ì†Œ' : 'Q-Angle ê³¼ëŒ€';
      detailSections.push(`
        <div style="border-left:3px solid #2ec4b6; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#2ec4b6; font-size:13px;">ğŸ“ ${issue} - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> Q-Angle ${qAngle.toFixed(1)}Â° (ì •ìƒ: 10-20Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> ë¬´ë¦ ì •ë ¬ ë¬¸ì œ, ëŒ€í‡´ì‚¬ë‘ê·¼ ë¶ˆê· í˜•, ìŠ¬ê°œê³¨ ìœ„ì¹˜ ì´ìƒ<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong>
            â€¢ ë¬´ë¦ í†µì¦ ë° ë¶ˆì•ˆì •ì„±
            â€¢ ìŠ¬ê°œëŒ€í‡´ í†µì¦ ì¦í›„êµ° ìœ„í—˜
            â€¢ ë³´í–‰ ì‹œ ë¬´ë¦ ë¶€ë‹´ ì¦ê°€<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ë¬´ë¦ ì •ë ¬ ìš´ë™
            â‘¡ ëŒ€í‡´ì‚¬ë‘ê·¼ ê· í˜• ê°•í™”
            â‘¢ ìŠ¬ê°œê³¨ ì•ˆì •í™” ìš´ë™
          </div>
        </div>
      `);
    }
    
    // === ì •ë©´: ë¬´ë¦ í¸ìœ„ (Knee Deviation) ===
    if(kneeDev != null && Math.abs(kneeDev) > 3) {
      issueCount++;
      const severity = Math.abs(kneeDev) > 6 ? 'ì‹¬ê°' : Math.abs(kneeDev) > 4 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      detailSections.push(`
        <div style="border-left:3px solid #2ec4b6; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#2ec4b6; font-size:13px;">ğŸ“ ë¬´ë¦ í¸ìœ„ (Knee Deviation) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> ë¬´ë¦ í¸ìœ„ ${kneeDev.toFixed(1)}Â° (ì •ìƒ: â‰¤3Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> í•˜ì§€ ì •ë ¬ ë¬¸ì œ, ë¬´ë¦ ê´€ì ˆ ë¶ˆì•ˆì •ì„±, ê·¼ìœ¡ ë¶ˆê· í˜•<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ë¬´ë¦ ì •ë ¬ ìš´ë™
            â‘¡ í•˜ì§€ ê·¼ìœ¡ ê· í˜• ê°•í™”
          </div>
        </div>
      `);
    }
    
    // === ì •ë©´: ë¨¸ë¦¬ ê¸°ìš¸ê¸° (Head Tilt) ===
    if(hta != null && Math.abs(hta) > 3) {
      issueCount++;
      const severity = Math.abs(hta) > 6 ? 'ì‹¬ê°' : Math.abs(hta) > 4 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      detailSections.push(`
        <div style="border-left:3px solid #2ec4b6; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#2ec4b6; font-size:13px;">ğŸ“ ë¨¸ë¦¬ ê¸°ìš¸ê¸° (Head Tilt) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> HTA ${hta.toFixed(1)}Â° (ì •ìƒ: â‰¤3Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> ê²½ì¶” ê·¼ìœ¡ ë¶ˆê· í˜•, ëª© í†µì¦ìœ¼ë¡œ ì¸í•œ ë³´ìƒ ìì„¸<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ê²½ì¶” ê·¼ìœ¡ ê· í˜• ìš´ë™
            â‘¡ ëª© ì •ë ¬ ê°œì„ 
          </div>
        </div>
      `);
    }
    
    // === ì •ë©´: ë‹¤ë¦¬ ê¸¸ì´ ë¶ˆê· í˜• (Leg Length Discrepancy) ===
    if(lld != null && lld > 1) {
      issueCount++;
      const severity = lld > 2 ? 'ì‹¬ê°' : lld > 1.5 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      detailSections.push(`
        <div style="border-left:3px solid #2ec4b6; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#2ec4b6; font-size:13px;">ğŸ“ ë‹¤ë¦¬ ê¸¸ì´ ë¶ˆê· í˜• (Leg Length Discrepancy) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> LLD ${lld.toFixed(1)}cm (ì •ìƒ: â‰¤1cm)<br>
            <strong>êµ¬ë¶„:</strong>
            â€¢ êµ¬ì¡°ì  ë¶ˆê· í˜•: ì‹¤ì œ ë¼ˆ ê¸¸ì´ ì°¨ì´ (X-ray ì´¬ì˜ í•„ìš”)
            â€¢ ê¸°ëŠ¥ì  ë¶ˆê· í˜•: ê·¼ìœ¡ ë¶ˆê· í˜•Â·ê³¨ë°˜ íšŒì „ìœ¼ë¡œ ì¸í•œ ê²‰ë³´ê¸° ì°¨ì´<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong>
            â€¢ ê³¨ë°˜ ê¸°ìš¸ì–´ì§ â†’ ì²™ì¶” ì¸¡ë§Œì¦(Scoliosis) ìœ ë°œ
            â€¢ ë³´í–‰ ì‹œ ë¹„ëŒ€ì¹­ â†’ ë¬´ë¦Â·ê³ ê´€ì ˆÂ·í—ˆë¦¬ í†µì¦
            â€¢ í•œìª½ ë‹¤ë¦¬ í”¼ë¡œ ëˆ„ì <br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ê¸°ëŠ¥ì  ë¶ˆê· í˜•: ê³¨ë°˜ êµì • ìš´ë™, ì¤‘ë‘”ê·¼(Gluteus medius) ê°•í™”, TFLÂ·QL ìŠ¤íŠ¸ë ˆì¹­
            â‘¡ êµ¬ì¡°ì  ë¶ˆê· í˜•: ê¹”ì°½(Heel lift) ì‚¬ìš© ê³ ë ¤, ì „ë¬¸ì˜ ìƒë‹´ í•„ìˆ˜<br>
            <strong>ì—°ì‡„ ë°˜ì‘:</strong> LLD â†’ ê³¨ë°˜ ê¸°ìš¸ì–´ì§ â†’ ì²™ì¶” ì¸¡ë§Œ â†’ ì–´ê¹¨ ë†’ì´ ì°¨ì´ â†’ ëª© í†µì¦
          </div>
        </div>
      `);
    }
    
    // === ì •ë©´: ì²´ê°„ í¸ìœ„ (Trunk Deviation) ===
    if(td != null && Math.abs(td) > 3) {
      issueCount++;
      const severity = Math.abs(td) > 6 ? 'ì‹¬ê°' : Math.abs(td) > 4 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      detailSections.push(`
        <div style="border-left:3px solid #2ec4b6; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#2ec4b6; font-size:13px;">ğŸ“ ì²´ê°„ í¸ìœ„ (Trunk Deviation) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> TD ${td.toFixed(1)}Â° (ì •ìƒ: â‰¤3Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> ì²™ì¶” ì¸¡ë§Œ, ê³¨ë°˜ ê¸°ìš¸ê¸°, ê·¼ìœ¡ ë¶ˆê· í˜•<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ì²™ì¶” ì •ë ¬ ê°œì„ 
            â‘¡ ì½”ì–´ ê·¼ìœ¡ ê· í˜• ê°•í™”
          </div>
        </div>
      `);
    }
    
    // === ì •ë©´: ì–´ê¹¨-ê³¨ë°˜ í‰í–‰ë„ (Shoulder-Pelvis Parallelism) ===
    if(spp != null && Math.abs(spp) > 3) {
      issueCount++;
      const severity = Math.abs(spp) > 6 ? 'ì‹¬ê°' : Math.abs(spp) > 4 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      detailSections.push(`
        <div style="border-left:3px solid #2ec4b6; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#2ec4b6; font-size:13px;">ğŸ“ ì–´ê¹¨-ê³¨ë°˜ í‰í–‰ë„ (Shoulder-Pelvis Parallelism) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> SPP ${spp.toFixed(1)}Â° (ì •ìƒ: â‰¤3Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> ì–´ê¹¨ì™€ ê³¨ë°˜ì˜ ë¹„ëŒ€ì¹­, ì²™ì¶” ì¸¡ë§Œ<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ì–´ê¹¨-ê³¨ë°˜ ì •ë ¬ ê°œì„ 
            â‘¡ ì¸¡ë©´ ì½”ì–´ ê°•í™”
          </div>
        </div>
      `);
    }
    
    // === ì •ë©´: ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„± (Knee Alignment Symmetry) ===
    if(kas != null && Math.abs(kas) > 3) {
      issueCount++;
      const severity = Math.abs(kas) > 6 ? 'ì‹¬ê°' : Math.abs(kas) > 4 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      detailSections.push(`
        <div style="border-left:3px solid #2ec4b6; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#2ec4b6; font-size:13px;">ğŸ“ ë¬´ë¦ ì •ë ¬ ëŒ€ì¹­ì„± (Knee Alignment Symmetry) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> KAS ${kas.toFixed(1)}Â° (ì •ìƒ: â‰¤3Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> í•˜ì§€ ì •ë ¬ ë¶ˆê· í˜•, ë¬´ë¦ ê´€ì ˆ ë¶ˆì•ˆì •ì„±<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ë¬´ë¦ ì •ë ¬ ìš´ë™
            â‘¡ í•˜ì§€ ê·¼ìœ¡ ê· í˜• ê°•í™”
          </div>
        </div>
      `);
    }
    
    // === ì •ë©´: í•˜ì§€ ì¶• ëŒ€ì¹­ì„± (Lower Limb Axis Symmetry) ===
    if(llas != null && Math.abs(llas) > 3) {
      issueCount++;
      const severity = Math.abs(llas) > 6 ? 'ì‹¬ê°' : Math.abs(llas) > 4 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      const side = llas > 0 ? 'ìš°ì¸¡ ì´ë™' : 'ì¢Œì¸¡ ì´ë™';
      detailSections.push(`
        <div style="border-left:3px solid #2ec4b6; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#2ec4b6; font-size:13px;">ğŸ“ í•˜ì§€ ì¶• ëŒ€ì¹­ì„± (Lower Limb Axis Symmetry) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> LLAS ${llas.toFixed(1)}Â° (ì •ìƒ: â‰¤3Â°) - ${side}<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> í•˜ì§€ ì •ë ¬ ë¶ˆê· í˜•, ê³¨ë°˜ ê¸°ìš¸ê¸°<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  í•˜ì§€ ì •ë ¬ ê°œì„ 
            â‘¡ ê³¨ë°˜ ì •ë ¬ ìš´ë™
          </div>
        </div>
      `);
    }
    
    // âœ… ì •ë©´ ë¶„ì„ ê²°ê³¼ ìš”ì•½
    // ì •ë©´ ì§€í‘œê°€ í•˜ë‚˜ë¼ë„ ìˆëŠ”ì§€ í™•ì¸
    const hasFrontData = sta != null || poa != null || lld != null || qAngle != null || kneeDev != null || 
                         td != null || hta != null || spp != null || kas != null || llas != null || 
                         hpa != null || tibial != null;
    
    if(!hasFrontData) {
      return "ë¶„ì„ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    }
    
    if(issueCount === 0) {
      summarySection = '<div style="padding:12px; background:#f0fdf4; border-radius:8px; margin-bottom:16px;"><strong style="color:#15803d;">âœ… ì •ë©´ ìì„¸ ë¶„ì„ ê²°ê³¼: ëª¨ë“  ì§€í‘œê°€ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.</strong></div>';
    } else {
      summarySection = `<div style="padding:12px; background:#fff7ed; border-radius:8px; margin-bottom:16px;"><strong style="color:#c2410c;">âš ï¸ ì •ë©´ ìì„¸ ë¶„ì„ ê²°ê³¼: ${issueCount}ê°œì˜ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</strong></div>`;
    }
    
    return summarySection + detailSections.join('');
  }
  
  // === ì¸¡ë©´ ë¶„ì„ íŒ¨í„´ (ì¸¡ë©´ ë¶„ì„ë§Œ) ===
  // === 1. ê±°ë¶ëª© ìì„¸ (Forward Head Posture) ===
  if(orientation === "side" && cva != null && cva < 50) {
    issueCount++;
    const severity = cva < 40 ? 'ì‹¬ê°' : cva < 45 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
    detailSections.push(`
      <div style="border-left:3px solid #ff6b6b; padding-left:12px; margin-bottom:16px;">
        <strong style="color:#ff6b6b; font-size:13px;">ğŸ“ ê±°ë¶ëª© ìì„¸ (Forward Head Posture) - ${severity}</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
          <strong>í˜„ì¬ ìƒíƒœ:</strong> CVA ${cva.toFixed(1)}Â° (ì •ìƒ: â‰¥50Â°), HPD ${hpd != null ? hpd.toFixed(1) + 'cm' : 'ë¯¸ì¸¡ì •'}<br>
          <strong>ì£¼ìš” ì›ì¸:</strong> ì¥ì‹œê°„ ìŠ¤ë§ˆíŠ¸í°Â·ì»´í“¨í„° ì‚¬ìš©, ì˜ëª»ëœ ë² ê°œ ë†’ì´, ê¹Šì€ ê·¼ìœ¡(Deep neck flexor) ì•½í™”<br>
          <strong>ë°œìƒ ì¦ìƒ:</strong> 
          â€¢ ëª©ë’¤ í†µì¦ ë° ê²½ì§ (Upper trapezius, Levator scapulae ê¸´ì¥)
          â€¢ ë‘í†µ (Tension headache), ì–´ì§€ëŸ¼ì¦
          â€¢ ì–´ê¹¨ ê²°ë¦¼ ë° ë‚ ê°œë¼ˆ í†µì¦
          â€¢ í„±ê´€ì ˆ ì¥ì• (TMJ disorder) ìœ ë°œ ê°€ëŠ¥<br>
          <strong>ê·¼ìœ¡ ë¶ˆê· í˜•:</strong>
          â€¢ ê¸´ì¥ëœ ê·¼ìœ¡: ìƒë¶€ ìŠ¹ëª¨ê·¼, ê²¬ê°‘ê±°ê·¼, í‰ì‡„ìœ ëŒê·¼, í›„ë‘í•˜ê·¼
          â€¢ ì•½í™”ëœ ê·¼ìœ¡: ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼(Longus colli, capitis), í•˜ë¶€ ìŠ¹ëª¨ê·¼<br>
          <strong>êµì • ë°©í–¥:</strong>
          â‘  í„±ë‹¹ê¹€ ìš´ë™(Chin tuck): ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼ ê°•í™”
          â‘¡ í‰ì¶” ì‹ ì „ ìš´ë™: ë“± ìœ—ë¶€ë¶„ ìœ ì—°ì„± í™•ë³´
          â‘¢ ê²¬ê°‘ê³¨ í›„ì¸ ìš´ë™: ì–´ê¹¨ë¥¼ ë’¤ë¡œ ë‹¹ê¸°ëŠ” ê·¼ìœ¡ ê°•í™”
          â‘£ ì‘ì—… í™˜ê²½ ê°œì„ : ëª¨ë‹ˆí„° ëˆˆë†’ì´ ì¡°ì •, ìŠ¤ë§ˆíŠ¸í° ì‚¬ìš© ìì„¸ ê°œì„ <br>
          <strong>ì£¼ì˜ì‚¬í•­:</strong> ê¸‰ê²©í•œ êµì • ì‹œë„ëŠ” ê²½ì¶” ë””ìŠ¤í¬ì— ë¬´ë¦¬ë¥¼ ì¤„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì ì§„ì ìœ¼ë¡œ ì ‘ê·¼í•´ì•¼ í•©ë‹ˆë‹¤.
        </div>
      </div>
    `);
  }
  
  // === 1-1. ë¨¸ë¦¬ ëŒì¶œ (Head Protrusion Distance) ë¬¸ì œ ===
  if(orientation === "side" && hpd != null && hpd > 2) {
    issueCount++;
    const severity = hpd > 10 ? 'ì‹¬ê°' : hpd > 6 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
    detailSections.push(`
      <div style="border-left:3px solid #ff6b6b; padding-left:12px; margin-bottom:16px;">
        <strong style="color:#ff6b6b; font-size:13px;">ğŸ“ ë¨¸ë¦¬ ëŒì¶œ (Head Protrusion Distance) - ${severity}</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
          <strong>í˜„ì¬ ìƒíƒœ:</strong> HPD ${hpd.toFixed(1)}cm (ì •ìƒ: â‰¤2cm)<br>
          <strong>ì˜ë¯¸:</strong> ë¨¸ë¦¬ê°€ ì–´ê¹¨(acromion)ì—ì„œ ì–¼ë§ˆë‚˜ ì•ìœ¼ë¡œ ëŒì¶œë˜ì–´ ìˆëŠ”ì§€ë¥¼ ì¸¡ì •í•œ ê°’ì…ë‹ˆë‹¤. ${hpd > 10 ? 'ë§¤ìš° ì‹¬ê°í•œ ìˆ˜ì¤€' : hpd > 6 ? 'ì‹¬ê°í•œ ìˆ˜ì¤€' : 'ê²½ë¯¸í•œ ìˆ˜ì¤€'}ì˜ ë¨¸ë¦¬ ì „ë°© ë³€ìœ„ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
          <strong>ì£¼ìš” ì›ì¸:</strong>
          â€¢ ì¥ì‹œê°„ ì»´í“¨í„°Â·ìŠ¤ë§ˆíŠ¸í° ì‚¬ìš©ìœ¼ë¡œ ì¸í•œ ì „ë°© ë¨¸ë¦¬ ìì„¸
          â€¢ ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼(Longus colli, capitis) ì•½í™”
          â€¢ ìƒë¶€ ìŠ¹ëª¨ê·¼, í‰ì‡„ìœ ëŒê·¼ ê³¼ê¸´ì¥
          â€¢ í‰ì¶” í›„ë§Œ ì¦ê°€ë¡œ ì¸í•œ ë³´ìƒ ìì„¸<br>
          <strong>ë°œìƒ ì¦ìƒ:</strong>
          â€¢ ëª©ê³¼ ì–´ê¹¨ í†µì¦ (ìƒë¶€ ìŠ¹ëª¨ê·¼, ê²¬ê°‘ê±°ê·¼ ê¸´ì¥)
          â€¢ ë‘í†µ ë° ì–´ì§€ëŸ¼ì¦
          â€¢ ê²½ì¶” ë””ìŠ¤í¬ ì••ë°• ì¦ê°€ë¡œ ì¸í•œ ëª© í†µì¦
          â€¢ í˜¸í¡ íš¨ìœ¨ ê°ì†Œ (í‰ê³½ í™•ì¥ ì œí•œ)
          â€¢ í„±ê´€ì ˆ ì¥ì• (TMJ disorder) ìœ„í—˜ ì¦ê°€<br>
          <strong>ê·¼ìœ¡ ë¶ˆê· í˜•:</strong>
          â€¢ ê¸´ì¥Â·ë‹¨ì¶•ëœ ê·¼ìœ¡: ìƒë¶€ ìŠ¹ëª¨ê·¼, í‰ì‡„ìœ ëŒê·¼, í›„ë‘í•˜ê·¼, ì „ê±°ê·¼
          â€¢ ì•½í™”Â·ì‹ ì¥ëœ ê·¼ìœ¡: ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼, í•˜ë¶€ ìŠ¹ëª¨ê·¼, ì¤‘ë¶€ ìŠ¹ëª¨ê·¼<br>
          <strong>êµì • ë°©í–¥:</strong>
          â‘  í„±ë‹¹ê¹€ ìš´ë™(Chin tuck): ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼ ê°•í™” (ê°€ì¥ ì¤‘ìš”)
          â‘¡ í‰ì¶” ì‹ ì „ ìš´ë™: ë“± ìœ—ë¶€ë¶„ ìœ ì—°ì„± í™•ë³´
          â‘¢ ìƒë¶€ ìŠ¹ëª¨ê·¼Â·í‰ì‡„ìœ ëŒê·¼ ìŠ¤íŠ¸ë ˆì¹­
          â‘£ ì‘ì—… í™˜ê²½ ê°œì„ : ëª¨ë‹ˆí„° ëˆˆë†’ì´ ì¡°ì •, ì˜ì ë†’ì´ ì¡°ì •
          â‘¤ í•„ë¼í…ŒìŠ¤Â·ìš”ê°€ ë“± ì „ì‹  ê· í˜• ìš´ë™<br>
          <strong>ì£¼ì˜ì‚¬í•­:</strong> ${hpd > 10 ? 'ë§¤ìš° ì‹¬ê°í•œ ìˆ˜ì¤€ì´ë¯€ë¡œ ì „ë¬¸ê°€(ë¬¼ë¦¬ì¹˜ë£Œì‚¬, ì¹´ì´ë¡œí”„ë™í„°) ìƒë‹´ì„ ê°•ë ¥íˆ ê¶Œì¥í•©ë‹ˆë‹¤. ê¸‰ê²©í•œ êµì •ì€ ê²½ì¶” ë””ìŠ¤í¬ì— ë¬´ë¦¬ë¥¼ ì¤„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì ì§„ì ìœ¼ë¡œ ì ‘ê·¼í•´ì•¼ í•©ë‹ˆë‹¤.' : 'ì ì§„ì ì¸ êµì •ì´ í•„ìš”í•˜ë©°, í†µì¦ì´ ì‹¬í•˜ë©´ ì „ë¬¸ê°€ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.'}
        </div>
      </div>
    `);
  }
  
  // === 2. ê³¨ë°˜ ê²½ì‚¬ ë¬¸ì œ (ì¸¡ë©´ ë¶„ì„ë§Œ) ===
  if(orientation === "side" && pta != null && ptaSigned != null && (ptaSigned > 15 || ptaSigned < 0)) {
    issueCount++;
    if(ptaSigned > 15) {
      const severity = ptaSigned > 25 ? 'ì‹¬ê°' : ptaSigned > 20 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      detailSections.push(`
        <div style="border-left:3px solid #ffb86c; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#ffb86c; font-size:13px;">ğŸ“ ê³¨ë°˜ ì „ë°© ê²½ì‚¬ (Anterior Pelvic Tilt) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> PTA ${ptaSigned.toFixed(1)}Â° (ì •ìƒ: 0-15Â°) - ASISê°€ PSISë³´ë‹¤ ë‚®ìŒ<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> ì¥ì‹œê°„ ì•‰ì•„ìˆëŠ” ìƒí™œ, í•˜ì´í ì°©ìš©, ë³µë¶€ ê·¼ë ¥ ì•½í™”, ì„ì‹  í›„ íšŒë³µ ë¶€ì¡±<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong>
            â€¢ ìš”ì¶” ê³¼ì „ë§Œ(Hyperlordosis)ìœ¼ë¡œ ì¸í•œ ë§Œì„± ìš”í†µ
            â€¢ í•˜ë³µë¶€ ëŒì¶œ (pseudo-pregnancy appearance)
            â€¢ ì—‰ë©ì´ê°€ ë’¤ë¡œ íŠ€ì–´ë‚˜ì˜¨ ìì„¸
            â€¢ ê³ ê´€ì ˆ êµ´ê³¡ê·¼(Hip flexor) ë‹¨ì¶•ìœ¼ë¡œ ì¸í•œ ë³´í–‰ ì¥ì• <br>
            <strong>ê·¼ìœ¡ ë¶ˆê· í˜•:</strong>
            â€¢ ê¸´ì¥Â·ë‹¨ì¶•ëœ ê·¼ìœ¡: ì¥ìš”ê·¼(Iliopsoas), ëŒ€í‡´ì§ê·¼(Rectus femoris), ì²™ì¶”ê¸°ë¦½ê·¼(Erector spinae)
            â€¢ ì•½í™”Â·ì‹ ì¥ëœ ê·¼ìœ¡: ë³µì§ê·¼(Rectus abdominis), ëŒ€ë‘”ê·¼(Gluteus maximus), í–„ìŠ¤íŠ¸ë§<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ëŸ°ì§€ ìì„¸ì—ì„œ ì¥ìš”ê·¼ ëŠ˜ë¦¬ê¸°
            â‘¡ ì½”ì–´ ê°•í™”: í”Œë­í¬, ë°ë“œë²„ê·¸(Dead bug) ìš´ë™
            â‘¢ ëŒ€ë‘”ê·¼ í™œì„±í™”: ë¸Œë¦¿ì§€, í™ ì“°ëŸ¬ìŠ¤íŠ¸, í´ë¨ì‰˜
            â‘£ ê³¨ë°˜ í›„ë°© ê²½ì‚¬ ì—°ìŠµ: ë²½ì— ë“±ëŒ€ê³  ê³¨ë°˜ ì¤‘ë¦½ ìì„¸ í•™ìŠµ<br>
            <strong>ë³µí•© ì¦í›„êµ°:</strong> Lower Cross Syndrome(í•˜ë¶€ êµì°¨ ì¦í›„êµ°)ì˜ í•µì‹¬ íŠ¹ì§•ì…ë‹ˆë‹¤.
          </div>
        </div>
      `);
    } else if(ptaSigned < 0) {
      detailSections.push(`
        <div style="border-left:3px solid #ffb86c; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#ffb86c; font-size:13px;">ğŸ“ ê³¨ë°˜ í›„ë°© ê²½ì‚¬ (Posterior Pelvic Tilt)</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> PTA ${ptaSigned.toFixed(1)}Â° (ì •ìƒ: 0-15Â°) - ASISê°€ PSISë³´ë‹¤ ë†’ìŒ<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> ê³¼ë„í•œ ì½”ì–´ ìš´ë™, ì¥ì‹œê°„ êµ¬ë¶€ì •í•œ ì•‰ì€ ìì„¸, í–„ìŠ¤íŠ¸ë§ ê³¼ê¸´ì¥<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong>
            â€¢ í‰í‰í•œ í—ˆë¦¬(Flat back)ë¡œ ì¸í•œ ì¶©ê²© í¡ìˆ˜ ê°ì†Œ
            â€¢ ê³¨ë°˜ì €ê·¼ ê¸°ëŠ¥ ì €í•˜
            â€¢ ì—‰ë©ì´ í¸í‰í™”, í•˜ì²´ í˜ˆì•¡ìˆœí™˜ ì €í•˜<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­
            â‘¡ ëŒ€ë‘”ê·¼Â·ì²™ì¶”ê¸°ë¦½ê·¼ ê°•í™”
            â‘¢ ê³¨ë°˜ ì „ë°© ê²½ì‚¬ ì—°ìŠµ (ë‹¨, ê³¼í•˜ì§€ ì•Šê²Œ)
          </div>
        </div>
      `);
    }
  }
  
  // === 3. ì²´ê°„ ê²½ì‚¬ê° (Trunk Inclination Angle) ë¬¸ì œ ===
  if(orientation === "side" && tia != null && (tia > 10 || tia < 0)) {
    issueCount++;
    const severity = tia > 15 ? 'ì‹¬ê°' : tia > 12 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
    if(tia > 10) {
      detailSections.push(`
        <div style="border-left:3px solid #ff6b6b; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#ff6b6b; font-size:13px;">ğŸ“ ì²´ê°„ ì „ë°© ê²½ì‚¬ (Forward Trunk Lean) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> TIA ${tia.toFixed(1)}Â° (ì •ìƒ: 0-10Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> ìƒì²´ ì „ë°© ì ë¦¼, ë³µë¶€ ê·¼ë ¥ ì•½í™”, ìš”ì¶” ê³¼ì „ë§Œ<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong>
            â€¢ ìš”í†µ ë° ì²™ì¶” ë¶€ë‹´ ì¦ê°€
            â€¢ ê· í˜• ê°ê° ì €í•˜
            â€¢ í˜¸í¡ íš¨ìœ¨ ê°ì†Œ<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ë³µë¶€ ì½”ì–´ ê°•í™”
            â‘¡ ì²™ì¶” ê¸°ë¦½ê·¼ ê°•í™”
            â‘¢ ì²´ê°„ ì¤‘ë¦½ ìì„¸ í›ˆë ¨
          </div>
        </div>
      `);
    }
  }
  
  // === 4. ì–´ê¹¨ ì „ë°©ê° (Shoulder Anterior Angle) ë¬¸ì œ ===
  if(orientation === "side" && metrics.SAA?.value != null) {
    const saa = metrics.SAA.value;
    if(saa > 10) {
      issueCount++;
      const severity = saa > 20 ? 'ì‹¬ê°' : saa > 15 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      detailSections.push(`
        <div style="border-left:3px solid #ff6b6b; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#ff6b6b; font-size:13px;">ğŸ“ ì–´ê¹¨ ì „ë°© ê²½ì‚¬ (Forward Shoulder) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> SAA ${saa.toFixed(1)}Â° (ì •ìƒ: 0-10Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> ë¼ìš´ë“œ ìˆ„ë”, ëŒ€í‰ê·¼ ë‹¨ì¶•, ì¤‘Â·í•˜ë¶€ ìŠ¹ëª¨ê·¼ ì•½í™”<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong>
            â€¢ ì–´ê¹¨ í†µì¦ ë° ë¶ˆì•ˆì •ì„±
            â€¢ ì–´ê¹¨ ì¶©ëŒ ì¦í›„êµ° ìœ„í—˜
            â€¢ ê²¬ê°‘ê³¨ ì „ë°© ë³€ìœ„<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  ëŒ€í‰ê·¼ ìŠ¤íŠ¸ë ˆì¹­
            â‘¡ ì¤‘Â·í•˜ë¶€ ìŠ¹ëª¨ê·¼ ê°•í™”
            â‘¢ ê²¬ê°‘ê³¨ í›„ì¸ ìš´ë™
          </div>
        </div>
      `);
    }
  }
  
  // === 5. ìƒë¶€ êµì°¨ ì¦í›„êµ° (Upper Cross Syndrome) ì²´í¬ ===
  const hasUpperCross = (orientation === "side" && cva != null && cva < 50);
  if(hasUpperCross) {
    issueCount++;
    detailSections.push(`
      <div style="border-left:3px solid #ff6b6b; padding-left:12px; margin-bottom:16px; background:rgba(255,107,107,0.05); padding:10px;">
        <strong style="color:#ff6b6b; font-size:13px;">âš ï¸ ìƒë¶€ êµì°¨ ì¦í›„êµ° (Upper Cross Syndrome) ì˜ì‹¬</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
          <strong>ì¦í›„êµ° ì„¤ëª…:</strong> ê±°ë¶ëª©ê³¼ ë‘¥ê·¼ ì–´ê¹¨ê°€ ë™ì‹œì— ë‚˜íƒ€ë‚˜ëŠ” í˜„ëŒ€ì¸ì˜ ëŒ€í‘œì  ìì„¸ ë¶ˆê· í˜• íŒ¨í„´ì…ë‹ˆë‹¤.<br>
          <strong>ì „í˜•ì  íŠ¹ì§•:</strong>
          â€¢ ë¨¸ë¦¬ ì „ë°© ëŒì¶œ (CVA: ${cva.toFixed(1)}Â°)
          â€¢ í‰ì¶” í›„ë§Œ ì¦ê°€ (ë“±ì´ êµ½ìŒ)
          â€¢ ì–´ê¹¨ ì „ë°© íšŒì „<br>
          <strong>êµì • ìš°ì„ ìˆœìœ„:</strong>
          â‘  ê¸´ì¥ í•´ì†Œ: ìƒë¶€ ìŠ¹ëª¨ê·¼, ëŒ€í‰ê·¼, í‰ì‡„ìœ ëŒê·¼ ì´ì™„
          â‘¡ í™œì„±í™”: ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼, ì¤‘Â·í•˜ë¶€ ìŠ¹ëª¨ê·¼, ì „ê±°ê·¼
          â‘¢ ìì„¸ êµìœ¡: ì•‰ì€ ìì„¸ì—ì„œ í‰ì¶” ì‹ ì „ ìœ ì§€
        </div>
      </div>
    `);
  }
  
  // === 6. ë¬´ë¦ ì •ë ¬ ë¬¸ì œ (ì¸¡ë©´ ë¶„ì„ë§Œ) ===
  if(orientation === "side" && ka != null && (ka > 185 || ka < 175)) {
    issueCount++;
    if(ka > 185) {
      const severity = ka > 195 ? 'ì‹¬ê°' : ka > 190 ? 'ì¤‘ë“±ë„' : 'ê²½ë¯¸';
      detailSections.push(`
        <div style="border-left:3px solid #ffd166; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#ffd166; font-size:13px;">ğŸ“ ë¬´ë¦ ê³¼ì‹ ì „ (Genu Recurvatum) - ${severity}</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> KA ${ka.toFixed(1)}Â° (ì •ìƒ: 175-185Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> ê´€ì ˆ ê³¼ì´ì™„ì„±(Joint hypermobility), ëŒ€í‡´ì‚¬ë‘ê·¼ ìš°ì„¸, í–„ìŠ¤íŠ¸ë§ ì•½í™”, ì˜ëª»ëœ ì„œê¸° ìŠµê´€<br>
            <strong>ë°œìƒ ì¦ìƒ:</strong>
            â€¢ ë¬´ë¦ í›„ë°© ì¸ëŒ€ ê³¼ë¶€í•˜ (PCL, í›„ë°© ê´€ì ˆë‚­ ìŠ¤íŠ¸ë ˆìŠ¤)
            â€¢ ìŠ¬ê°œê³¨ ì••ë°• ì¦ê°€ë¡œ ìŠ¬ê°œëŒ€í‡´ í†µì¦ ì¦í›„êµ° ìœ„í—˜
            â€¢ ë¬´ë¦ ë¶ˆì•ˆì •ì„±, ì¥ê¸°ì ìœ¼ë¡œ ì¡°ê¸° ê´€ì ˆì—¼ ìœ ë°œ<br>
            <strong>êµì • ë°©í–¥:</strong>
            â‘  í–„ìŠ¤íŠ¸ë§ ê°•í™”: ë ˆê·¸ì»¬, ë£¨ë§ˆë‹ˆì•ˆ ë°ë“œë¦¬í”„íŠ¸
            â‘¡ ëŒ€í‡´ì‚¬ë‘ê·¼ ê³¼ê¸´ì¥ ì™„í™”
            â‘¢ ì„œê¸° ìì„¸ êµì •: ë¬´ë¦ì„ ì‚´ì§ êµ¬ë¶€ë¦° ìƒíƒœ ìœ ì§€ ì—°ìŠµ
            â‘£ ê³ ìœ ìˆ˜ìš©ì„± í›ˆë ¨: í•œ ë°œ ì„œê¸°, ë°¸ëŸ°ìŠ¤ ë³´ë“œ<br>
            <strong>ì£¼ì˜ì‚¬í•­:</strong> ë¬´ë¦ì„ "ë”±" í´ëŠ” ìŠµê´€ì„ ì¦‰ì‹œ ì¤‘ë‹¨í•´ì•¼ í•©ë‹ˆë‹¤.
          </div>
        </div>
      `);
    } else {
      detailSections.push(`
        <div style="border-left:3px solid #ffd166; padding-left:12px; margin-bottom:16px;">
          <strong style="color:#ffd166; font-size:13px;">ğŸ“ ë¬´ë¦ ê³¼êµ´ê³¡ ìì„¸</strong>
          <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
            <strong>í˜„ì¬ ìƒíƒœ:</strong> KA ${ka.toFixed(1)}Â° (ì •ìƒ: 175-185Â°)<br>
            <strong>ì£¼ìš” ì›ì¸:</strong> í–„ìŠ¤íŠ¸ë§ ê³¼ê¸´ì¥, ì¢…ì•„ë¦¬ ê·¼ìœ¡ ë‹¨ì¶•, ê³¨ë°˜ í›„ë°© ê²½ì‚¬ ë™ë°˜<br>
            <strong>êµì • ë°©í–¥:</strong> í–„ìŠ¤íŠ¸ë§Â·ì¢…ì•„ë¦¬ ìŠ¤íŠ¸ë ˆì¹­, ëŒ€í‡´ì‚¬ë‘ê·¼ ê°•í™”
          </div>
        </div>
      `);
    }
  }
  
  // === 7. ì „ì‹  ê· í˜• ë¬¸ì œ (ì¸¡ë©´ ë¶„ì„ë§Œ) ===
  if(orientation === "side" && gsb != null && gsb > 2) {
    issueCount++;
    detailSections.push(`
      <div style="border-left:3px solid #ff6b6b; padding-left:12px; margin-bottom:16px;">
        <strong style="color:#ff6b6b; font-size:13px;">ğŸ“ ì „ì‹  ì •ë ¬ ë¶ˆê· í˜• (Global Postural Imbalance)</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.7; color:var(--muted);">
          <strong>í˜„ì¬ ìƒíƒœ:</strong> GSB ${gsb.toFixed(1)}cm<br>
          <strong>ì˜ë¯¸:</strong> ì£¼ìš” ê´€ì ˆë“¤ì´ ìˆ˜ì§ ì¤‘ë ¥ì„ ì—ì„œ í¬ê²Œ ë²—ì–´ë‚˜ ìˆì–´ ì „ì‹  ê·¼ê³¨ê²©ê³„ì— ê³¼ë¶€í•˜ê°€ ê±¸ë¦° ìƒíƒœì…ë‹ˆë‹¤.<br>
          <strong>ë°œìƒ ì¦ìƒ:</strong>
          â€¢ ì‰½ê²Œ í”¼ë¡œí•¨, ì¥ì‹œê°„ ì„œ ìˆê±°ë‚˜ ê±·ê¸° í˜ë“¦
          â€¢ ë§Œì„± í†µì¦ì˜ ë‹¤ë°œì„± ë°œìƒ (ëª©, ì–´ê¹¨, í—ˆë¦¬, ë¬´ë¦ ë“±)
          â€¢ ì—ë„ˆì§€ ì†Œëª¨ ì¦ê°€, í˜¸í¡ íš¨ìœ¨ ê°ì†Œ<br>
          <strong>êµì • ë°©í–¥:</strong>
          â‘  ì „ì²´ì ì¸ ìì„¸ ì¬ì •ë ¬ í”„ë¡œê·¸ë¨ í•„ìš” (í†µí•©ì  ì ‘ê·¼)
          â‘¡ í•„ë¼í…ŒìŠ¤, ìš”ê°€ ë“± ì „ì‹  ê· í˜• ìš´ë™
          â‘¢ ì „ë¬¸ê°€(ë¬¼ë¦¬ì¹˜ë£Œì‚¬, ì¹´ì´ë¡œí”„ë™í„°) ìƒë‹´ ê¶Œì¥
        </div>
      </div>
    `);
  }
  
  // === ì¢…í•© í‰ê°€ ë° ìš”ì•½ ===
  // âœ… ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ ìš”ì•½ ì¶”ê°€ (ì •ë©´ ë¶„ì„ì²˜ëŸ¼ ëª…í™•í•˜ê²Œ)
  if (orientation === "side") {
    // ì¸¡ë©´ ì§€í‘œê°€ í•˜ë‚˜ë¼ë„ ìˆëŠ”ì§€ í™•ì¸
    const hasSideData = cva != null || hpd != null || nia != null || pta != null || tia != null || 
                        ka != null || gsb != null || metrics.SAA?.value != null;
    
    if(!hasSideData) {
      return "ë¶„ì„ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    }
    
    if(issueCount === 0) {
      summarySection = '<div style="padding:12px; background:#f0fdf4; border-radius:8px; margin-bottom:16px;"><strong style="color:#15803d;">âœ… ì¸¡ë©´ ìì„¸ ë¶„ì„ ê²°ê³¼: ëª¨ë“  ì§€í‘œê°€ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.</strong></div>';
    } else {
      summarySection = `<div style="padding:12px; background:#fff7ed; border-radius:8px; margin-bottom:16px;"><strong style="color:#c2410c;">âš ï¸ ì¸¡ë©´ ìì„¸ ë¶„ì„ ê²°ê³¼: ${issueCount}ê°œì˜ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.</strong></div>`;
    }
  }
  
  // PDS ê¸°ë°˜ ì¢…í•© í‰ê°€ (ì¸¡ë©´/ì •ë©´ ê³µí†µ)
  if(pds != null && !summarySection) {
    if(pdsStatus === 'normal') {
      summarySection = `<div style="background:rgba(46,196,182,0.1); padding:12px; border-radius:8px; margin-bottom:16px;">
        <strong style="color:#2ec4b6; font-size:14px;">âœ“ ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸í•œ ìì„¸</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.6; color:var(--muted);">
          ëŒ€ë¶€ë¶„ì˜ ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ì— ìˆìŠµë‹ˆë‹¤. (PDS: ${pds.toFixed(1)}ì )<br>
          í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ê·œì¹™ì ì¸ ìŠ¤íŠ¸ë ˆì¹­ê³¼ ê·¼ë ¥ ìš´ë™ì„ ì§€ì†í•˜ì„¸ìš”.
        </div>
      </div>`;
    } else if(pdsStatus === 'mild') {
      summarySection = `<div style="background:rgba(255,209,102,0.1); padding:12px; border-radius:8px; margin-bottom:16px;">
        <strong style="color:#ffd166; font-size:14px;">âš ï¸ ê²½ë¯¸í•œ ìì„¸ ë¶ˆê· í˜•</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.6; color:var(--muted);">
          ${issueCount}ê°œ í•­ëª©ì—ì„œ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤. (PDS: ${pds.toFixed(1)}ì )<br>
          ì§€ê¸ˆë¶€í„° êµì •ì„ ì‹œì‘í•˜ë©´ ë‹¨ê¸°ê°„ ë‚´ ê°œì„ ì´ ê°€ëŠ¥í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤.
        </div>
      </div>`;
    } else if(pdsStatus === 'moderate') {
      summarySection = `<div style="background:rgba(255,184,108,0.1); padding:12px; border-radius:8px; margin-bottom:16px;">
        <strong style="color:#ffb86c; font-size:14px;">âš ï¸ ì¤‘ë“±ë„ ìì„¸ ë¶ˆê· í˜•</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.6; color:var(--muted);">
          ${issueCount}ê°œ í•­ëª©ì—ì„œ êµì •ì´ í•„ìš”í•©ë‹ˆë‹¤. (PDS: ${pds.toFixed(1)}ì )<br>
          ì²´ê³„ì ì¸ êµì • ìš´ë™ í”„ë¡œê·¸ë¨ê³¼ ìƒí™œ ìŠµê´€ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </div>
      </div>`;
    } else {
      summarySection = `<div style="background:rgba(255,107,107,0.1); padding:12px; border-radius:8px; margin-bottom:16px;">
        <strong style="color:#ff6b6b; font-size:14px;">ğŸš¨ ì‹¬ê°í•œ ìì„¸ ë¶ˆê· í˜•</strong>
        <div style="margin-top:6px; font-size:11px; line-height:1.6; color:var(--muted);">
          ${issueCount}ê°œ í•­ëª©ì—ì„œ ì •ìƒ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. (PDS: ${pds.toFixed(1)}ì )<br>
          <strong>ì „ë¬¸ê°€ ìƒë‹´ì„ ê°•ë ¥íˆ ê¶Œì¥í•©ë‹ˆë‹¤.</strong> (ë¬¼ë¦¬ì¹˜ë£Œì‚¬, ì •í˜•ì™¸ê³¼ ì „ë¬¸ì˜, ì¹´ì´ë¡œí”„ë™í„°)<br>
          ë°©ì¹˜ ì‹œ ë§Œì„± í†µì¦ ë° êµ¬ì¡°ì  ë³€í˜•ì´ ê³ ì°©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>`;
    }
  }
  
  // === í†µí•© ê¶Œì¥ì‚¬í•­ ===
  if(issueCount > 0) {
    recommendations.push(`
      <div style="background:rgba(124,156,255,0.08); padding:12px; border-radius:8px; margin-top:16px;">
        <strong style="color:#7c9cff; font-size:13px;">ğŸ’¡ í†µí•© êµì • ê¶Œì¥ì‚¬í•­</strong>
        <div style="margin-top:8px; font-size:11px; line-height:1.7; color:var(--muted);">
          <strong>1. ì¼ìƒìƒí™œ ê°œì„ :</strong><br>
          â€¢ ì‘ì—… í™˜ê²½: ëª¨ë‹ˆí„° ëˆˆë†’ì´, ì˜ì ë†’ì´, ì±…ìƒ ê±°ë¦¬ ì¡°ì •<br>
          â€¢ ìˆ˜ë©´ ìì„¸: ê²½ì¶” ì§€ì§€ ë² ê°œ, ì˜†ìœ¼ë¡œ ëˆ„ì›Œ ìê¸°<br>
          â€¢ ìŠ¤ë§ˆíŠ¸í°: ëˆˆë†’ì´ê¹Œì§€ ë“¤ê³  ë³´ê¸°, ì‚¬ìš© ì‹œê°„ ì œí•œ<br><br>
          
          <strong>2. ìš´ë™ í”„ë¡œê·¸ë¨:</strong><br>
          â€¢ ë§¤ì¼: ìŠ¤íŠ¸ë ˆì¹­ 10-15ë¶„ (ê¸´ì¥ëœ ê·¼ìœ¡ ì´ì™„)<br>
          â€¢ ì£¼ 3-4íšŒ: ê·¼ë ¥ ìš´ë™ 30ë¶„ (ì•½í™”ëœ ê·¼ìœ¡ ê°•í™”)<br>
          â€¢ ì£¼ 2-3íšŒ: ìœ ì‚°ì†Œ ìš´ë™ 30ë¶„ (ì „ì‹  ìˆœí™˜ ê°œì„ )<br><br>
          
          <strong>3. ì „ë¬¸ê°€ ë„ì›€:</strong><br>
          â€¢ ë¬¼ë¦¬ì¹˜ë£Œ: ìˆ˜ê¸° ì¹˜ë£Œ, ë„ìˆ˜ ì¹˜ë£Œ, ìš´ë™ ì¹˜ë£Œ<br>
          â€¢ í•„ë¼í…ŒìŠ¤/ìš”ê°€: ì „ë¬¸ ê°•ì‚¬ì˜ 1:1 êµì • ìˆ˜ì—…<br>
          â€¢ ì •ê¸° ê²€ì§„: 3-6ê°œì›”ë§ˆë‹¤ ìì„¸ ì¬í‰ê°€<br><br>
          
          <strong>4. êµì • ìˆœì„œ:</strong><br>
          â‘  1-2ì£¼ì°¨: ê¸´ì¥ëœ ê·¼ìœ¡ ì´ì™„ (ë§ˆì‚¬ì§€, í¼ë¡¤ëŸ¬, ìŠ¤íŠ¸ë ˆì¹­)<br>
          â‘¡ 3-4ì£¼ì°¨: ì•½í™”ëœ ê·¼ìœ¡ í™œì„±í™” (ì €ê°•ë„ ìš´ë™)<br>
          â‘¢ 5ì£¼ì°¨ ì´í›„: ì ì§„ì  ê°•í™” ë° ìì„¸ í†µí•© í›ˆë ¨
        </div>
      </div>
    `);
  }
  
  // === ìµœì¢… ì¶œë ¥ ì¡°í•© ===
  if(detailSections.length === 0) {
    return summarySection || "í˜„ì¬ ìì„¸ëŠ” ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸í•©ë‹ˆë‹¤.";
  }
  
  return summarySection + detailSections.join('') + recommendations.join('');
}

function updateScoreAndAnalysis(scoreData, cva, pelvic, knee, analysis) {
  const scoreEl = document.getElementById("totalScore");
  const reasonEl = document.getElementById("scoreReason");
  const commentEl = document.getElementById("aiComment");
  const commentPanel = document.getElementById("aiCommentPanel");
  const musclePanel = document.getElementById("musclePanel");
  const tightList = document.getElementById("muscleTightList");
  const weakList = document.getElementById("muscleWeakList");
  const exercisePanel = document.getElementById("exercisePanel");
  const exerciseList = document.getElementById("exerciseList");
  const pilatesPanel = document.getElementById("pilatesPanel");
  const pilatesList = document.getElementById("pilatesList");
  const allMetricsList = document.getElementById("allMetricsList");
  const pdsValueEl = document.getElementById("pdsValue");
  const conclusionPanel = document.getElementById("conclusionPanel");
  const conclusionContent = document.getElementById("conclusionContent");
  
  // ì „ì²´ ë¶„ì„ í•­ëª© í‘œì‹œ
  const S = sessions[cur];
  // âœ… ì•ˆì „ ê°€ë“œ: fullMetricsë¥¼ ì—¬ëŸ¬ ì†ŒìŠ¤ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  const fullMetrics = S.metrics?.fullMetrics || analysis?.fullMetrics || window.fullMetrics || {};
  // âœ… orientation í™•ì¸í•˜ì—¬ ì •ë©´/ì¸¡ë©´ êµ¬ë¶„
  const orientation = S.metrics?.orientation || analysis?.orientation || S.poseData?.orientation || "side";
  
  // âœ… scoreData ì²˜ë¦¬: ê°ì²´ì¼ ìˆ˜ë„ ìˆê³  ìˆ«ìì¼ ìˆ˜ë„ ìˆìŒ
  let scoreResult = null;
  if (typeof scoreData === 'object' && scoreData !== null) {
    // scoreDataê°€ ê°ì²´ì¸ ê²½ìš° (computeScoreFromFullMetrics ë°˜í™˜ê°’)
    scoreResult = scoreData;
  } else if (typeof scoreData === 'number') {
    // scoreDataê°€ ìˆ«ìì¸ ê²½ìš° (ê¸°ì¡´ ë°©ì‹)
    scoreResult = { score: scoreData, reasons: [], penalties: 0 };
  } else {
    // scoreDataê°€ nullì´ê±°ë‚˜ undefinedì¸ ê²½ìš°, ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
    const sessionScore = S.score;
    if (typeof sessionScore === 'object' && sessionScore !== null) {
      scoreResult = sessionScore;
    } else if (typeof sessionScore === 'number') {
      scoreResult = { score: sessionScore, reasons: [], penalties: 0 };
    } else {
      // fullMetricsì—ì„œ ì ìˆ˜ ê³„ì‚° ì‹œë„
      if (Object.keys(fullMetrics).length > 0) {
        scoreResult = computeScoreFromFullMetrics(fullMetrics);
      }
    }
  }
  
  if(allMetricsList && fullMetrics) {
    // ì¸¡ë©´ í•­ëª© (íŒŒë€ìƒ‰ #7c9cff) - HPA, Tibial ì œì™¸ (ì •ë©´ ì§€í‘œ)
    const sideMetricsOrder = [
      {key: 'CVA', name: 'CVA(ë‘ê°œê²½ì¶”ê°)', unit: 'Â°', type: 'side'},
      {key: 'HPD', name: 'HPD(ë‘ë¶€ì „ë°©ì´ë™)', unit: 'cm', type: 'side'},
      {key: 'TIA', name: 'TIA(ì²´ê°„ê²½ì‚¬ê°)', unit: 'Â°', type: 'side'},
      {key: 'SAA', name: 'SAA(ì–´ê¹¨ì „ë°©ê°)', unit: 'Â°', type: 'side'},
      {key: 'PTA', name: 'PTA(ê³¨ë°˜ ì „í›„ê²½ì‚¬ê°)', unit: 'Â°', type: 'side'},
      {key: 'KA', name: 'KA(ë¬´ë¦ê°)', unit: 'Â°', type: 'side'},
      {key: 'GSB', name: 'GSB(ì¤‘ë ¥ì¤‘ì‹¬ì„ )', unit: 'cm', type: 'side'},
      {key: 'PDS', name: 'PDS(ìì„¸ì ìˆ˜)', unit: 'score', type: 'side'}
    ];
    
    // ì •ë©´ í•­ëª© (ì²­ë¡ìƒ‰ #2ec4b6) - HPA, Tibial í¬í•¨
    const frontMetricsOrder = [
      {key: 'STA_F', name: 'STA(ì–´ê¹¨ê¸°ìš¸ê¸°ê°)', unit: 'Â°', type: 'front'},
      {key: 'STA', name: 'STA(ì–´ê¹¨ê¸°ìš¸ê¸°ê°)', unit: 'Â°', type: 'front'}, // í•˜ìœ„ í˜¸í™˜ì„±
      {key: 'POA_F', name: 'POA(ê³¨ë°˜ê¸°ìš¸ê¸°ê°)', unit: 'Â°', type: 'front'},
      {key: 'POA', name: 'POA(ê³¨ë°˜ê¸°ìš¸ê¸°ê°)', unit: 'Â°', type: 'front'}, // í•˜ìœ„ í˜¸í™˜ì„±
      {key: 'LLD_F', name: 'LLD(í•˜ì§€ê¸¸ì´ì°¨)', unit: 'cm', type: 'front'},
      {key: 'LLD', name: 'LLD(í•˜ì§€ê¸¸ì´ì°¨)', unit: 'cm', type: 'front'},  // ì •ë©´ ë¶„ì„ í•­ëª©ìœ¼ë¡œ ì´ë™
      {key: 'Q_Angle', name: 'Q-Angle(Qê°)', unit: 'Â°', type: 'front'},  // ì •ë©´ ë¶„ì„ í•­ëª©
      {key: 'Knee_Deviation', name: 'Knee Dev(ë¬´ë¦í¸ìœ„)', unit: 'Â°', type: 'front'},  // ì •ë©´ ë¶„ì„ í•­ëª©ìœ¼ë¡œ ì´ë™
      {key: 'TD', name: 'TD(ì²´ê°„í¸ìœ„)', unit: 'Â°', type: 'front'},
      {key: 'HTA', name: 'HTA(ë¨¸ë¦¬ê¸°ìš¸ê¸°ê°)', unit: 'Â°', type: 'front'},
      {key: 'SPP', name: 'SPP(ì–´ê¹¨ê³¨ë°˜í‰í–‰ë„)', unit: 'Â°', type: 'front'},
      {key: 'KAS', name: 'KAS(ë¬´ë¦ì •ë ¬ëŒ€ì¹­ì„±)', unit: 'Â°', type: 'front'},
      {key: 'LLAS', name: 'LLAS(í•˜ì§€ì¶•ëŒ€ì¹­ì„±)', unit: 'Â°', type: 'front'},
      {key: 'HPA', name: 'HPA(ê³¨ë°˜ íšŒì „ê°)', unit: 'Â°', type: 'front'},  // âœ… ì •ë©´ ì§€í‘œë¡œ ì´ë™
      {key: 'Tibial_Angle', name: 'Tibial(ê²½ê³¨ íšŒì „ê°)', unit: 'Â°', type: 'front'},  // âœ… ì •ë©´ ì§€í‘œë¡œ ì´ë™
    ];
    
    // âœ… orientationì— ë”°ë¼ í•­ëª© í•„í„°ë§
    // ì •ë©´ ë¶„ì„ ì‹œì—ëŠ” ì •ë©´ í•­ëª©ë§Œ, ì¸¡ë©´ ë¶„ì„ ì‹œì—ëŠ” ì¸¡ë©´ í•­ëª©ë§Œ í‘œì‹œ
    // ë‹¨, ì¸¡ë©´ ë¶„ì„ì´ì–´ë„ ì •ë©´ ë©”íŠ¸ë¦­ì´ ìˆìœ¼ë©´ ëª¨ë“  í•­ëª© í‘œì‹œ
    const frontMetricsKeys = ['STA', 'STA_F', 'POA', 'POA_F', 'LLD', 'LLD_F', 'Q_Angle', 'Knee_Deviation', 'TD', 'HTA', 'SPP', 'KAS', 'LLAS', 'HPA', 'Tibial_Angle', 'Tibial'];
    const hasFrontMetrics = (S.metrics?.frontMetrics && Object.keys(S.metrics.frontMetrics).length > 0) ||
                            frontMetricsKeys.some(key => fullMetrics[key] && fullMetrics[key].status !== undefined);
    let metricsOrder;
    if(orientation === "front") {
      metricsOrder = frontMetricsOrder; // ì •ë©´ ë¶„ì„: ì •ë©´ í•­ëª©ë§Œ
    } else if(orientation === "side" && hasFrontMetrics) {
      metricsOrder = [...sideMetricsOrder, ...frontMetricsOrder]; // ì¸¡ë©´ ë¶„ì„ + ì •ë©´ ë©”íŠ¸ë¦­ ìˆìŒ: ëª¨ë“  í•­ëª©
    } else if(orientation === "side") {
      metricsOrder = sideMetricsOrder; // ì¸¡ë©´ ë¶„ì„: ì¸¡ë©´ í•­ëª©ë§Œ
    } else {
      metricsOrder = [...sideMetricsOrder, ...frontMetricsOrder]; // ë‘˜ ë‹¤: ëª¨ë“  í•­ëª©
    }
    
    let html = '';
    const processedKeys = new Set(); // ì¤‘ë³µ ë°©ì§€
    
    metricsOrder.forEach(m => {
      // ì´ë¯¸ ì²˜ë¦¬ëœ í‚¤ëŠ” ê±´ë„ˆë›°ê¸°
      if(processedKeys.has(m.key)) return;
      
      // STA_Fì™€ STA ì¤‘ í•˜ë‚˜ë§Œ, POA_Fì™€ POA ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒ
      let metricKey = m.key;
      if(m.key === 'STA' && fullMetrics['STA_F']) {
        metricKey = 'STA_F';
        if(processedKeys.has('STA_F')) return;
      }
      if(m.key === 'POA' && fullMetrics['POA_F']) {
        metricKey = 'POA_F';
        if(processedKeys.has('POA_F')) return;
      }
      
      const metric = fullMetrics[metricKey] || fullMetrics[m.key];
      if(metric) {
        processedKeys.add(metricKey);
        if(m.key !== metricKey) processedKeys.add(m.key);
        
        // PTAëŠ” ë¶€í˜¸ í¬í•¨ ê°’(value_signed) ì‚¬ìš©, ë‚˜ë¨¸ì§€ëŠ” ê¸°ì¡´ ë°©ì‹
        let value;
        if (metricKey === 'PTA' && metric.value_signed !== undefined) {
          value = metric.value_signed; // ìŒìˆ˜ ê°’ë„ ê·¸ëŒ€ë¡œ í‘œì‹œ
        } else {
          value = metric.value !== undefined ? metric.value : (metric.value_deg !== undefined ? metric.value_deg : (metric.value_cm !== undefined ? metric.value_cm : null));
        }
        const status = metric.status || 'unknown';
        const unit = metric.unit || m.unit;
        if(value !== null && value !== undefined) {
          const statusColor = status === 'normal' ? '#2ec4b6' : status === 'mild' ? '#ffd166' : status === 'moderate' ? '#ffb86c' : '#ff6b6b';
          const statusText = status === 'normal' ? 'âœ“' : status === 'mild' ? 'âš ' : status === 'moderate' ? 'âš âš ' : status === 'severe' ? 'âœ—' : '?';
          
          // ì¸¡ë©´ í•­ëª©ì€ íŒŒë€ìƒ‰, ì •ë©´ í•­ëª©ì€ ì²­ë¡ìƒ‰ìœ¼ë¡œ ì´ë¦„ í‘œì‹œ
          const nameColor = m.type === 'front' ? '#2ec4b6' : '#7c9cff';
          
          // PTA ìŒìˆ˜ ê°’ í‘œì‹œ (ë¶€í˜¸ í¬í•¨)
          const displayValue = (metricKey === 'PTA' && value < 0) ? value.toFixed(1) : value.toFixed(1);
          const sign = (metricKey === 'PTA' && value < 0) ? '' : '';
          
          html += `<div style="display:flex; justify-content:space-between; margin-bottom:3px; padding:2px 0;">
            <span style="color:${nameColor}; font-weight:${m.type === 'front' ? '600' : '400'};">${m.name}:</span>
            <span style="color:${statusColor};">${displayValue}${unit} ${statusText}</span>
          </div>`;
        }
      }
    });
    allMetricsList.innerHTML = html || '<div style="color:var(--muted);">ë¶„ì„ ë°ì´í„° ì—†ìŒ</div>';
    
    // PDS í‘œì‹œ
    if(fullMetrics.PDS && pdsValueEl) {
      const pds = fullMetrics.PDS.value;
      const pdsStatus = fullMetrics.PDS.status;
      const pdsColor = pdsStatus === 'normal' ? '#2ec4b6' : pdsStatus === 'mild' ? '#ffd166' : '#ff6b6b';
      pdsValueEl.textContent = `${pds.toFixed(1)} (${pdsStatus})`;
      pdsValueEl.style.color = pdsColor;
    } else if(pdsValueEl) {
      pdsValueEl.textContent = 'â€”';
    }
  }
  
  // âœ… ì „ì²´ ë¶„ì„ í•­ëª© ê¸°ì¤€ìœ¼ë¡œ ì ìˆ˜ ì¬ê³„ì‚° (fullMetricsê°€ ìˆìœ¼ë©´)
  // scoreResultê°€ ì´ë¯¸ ê³„ì‚°ë˜ì—ˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì¬ê³„ì‚°
  if (!scoreResult && fullMetrics && Object.keys(fullMetrics).length > 0) {
    scoreResult = computeScoreFromFullMetrics(fullMetrics);
  }
  
  // âœ… scoreResult ì‚¬ìš© (scoreData ëŒ€ì‹ )
  if(scoreResult && scoreResult.score != null) {
    // âœ… scoreê°€ ìˆ«ìì¸ì§€ í™•ì¸ (ê°ì²´ê°€ ì•„ë‹Œì§€)
    let score = null;
    if(typeof scoreResult.score === 'number') {
      score = scoreResult.score;
    } else if(typeof scoreResult.score === 'object' && scoreResult.score !== null && typeof scoreResult.score.score === 'number') {
      score = scoreResult.score.score;
    }
    
    if(score !== null && typeof score === 'number') {
    scoreEl.textContent = score;
    
    // ì ìˆ˜ ìƒ‰ìƒ
    if(score >= 85) {
      scoreEl.style.color = "#2ec4b6";
    } else if(score >= 70) {
      scoreEl.style.color = "#ffd166";
    } else {
      scoreEl.style.color = "#ff6b6b";
    }
    
    // ì ìˆ˜ ê·¼ê±°
    if(scoreResult.reasons && Array.isArray(scoreResult.reasons) && scoreResult.reasons.length > 0) {
      reasonEl.textContent = "ê°ì  ê·¼ê±°: " + scoreResult.reasons.join(", ");
      } else {
        reasonEl.textContent = "ëª¨ë“  ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.";
      }
    } else {
      // scoreê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ fullMetricsì—ì„œ ì¬ê³„ì‚°
      if(Object.keys(fullMetrics).length > 0) {
        const recalculatedScore = computeScoreFromFullMetrics(fullMetrics);
        if(recalculatedScore && typeof recalculatedScore.score === 'number') {
          scoreEl.textContent = recalculatedScore.score;
          if(recalculatedScore.score >= 85) {
            scoreEl.style.color = "#2ec4b6";
          } else if(recalculatedScore.score >= 70) {
            scoreEl.style.color = "#ffd166";
          } else {
            scoreEl.style.color = "#ff6b6b";
          }
          if(recalculatedScore.reasons && Array.isArray(recalculatedScore.reasons) && recalculatedScore.reasons.length > 0) {
            reasonEl.textContent = "ê°ì  ê·¼ê±°: " + recalculatedScore.reasons.join(", ");
    } else {
      reasonEl.textContent = "ëª¨ë“  ì¸¡ì •ê°’ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.";
          }
        } else {
          scoreEl.textContent = "â€”";
          reasonEl.textContent = "";
        }
      } else {
        scoreEl.textContent = "â€”";
        reasonEl.textContent = "";
      }
    }
  } else {
    scoreEl.textContent = "â€”";
    reasonEl.textContent = "";
  }
  
  // AI ì½”ë©˜íŠ¸ (ë” ìƒì„¸í•˜ê²Œ)
  // âœ… orientationì— ë”°ë¼ ì¸¡ë©´/ì •ë©´ ë¶„ì„ ê²°ê³¼ êµ¬ë¶„ í‘œì‹œ
  // ë²„íŠ¼ ìƒíƒœë¥¼ ë¨¼ì € í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  const btnSide = document.getElementById("btnOrientationSide");
  const btnFront = document.getElementById("btnOrientationFront");
  const currentOrientation = btnFront?.classList.contains("active") ? "front" 
    : (btnSide?.classList.contains("active") ? "side" : (S.metrics?.orientation || analysis?.orientation || S.poseData?.orientation || "side"));
  
  // âœ… analysis.orientationê³¼ currentOrientationì´ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ì—ë§Œ analysis.comments ì‚¬ìš©
  // ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ fullMetrics ê¸°ë°˜ìœ¼ë¡œ í‘œì‹œ
  const analysisOrientation = analysis?.orientation || S.metrics?.orientation;
  const shouldUseAnalysisComments = analysis && analysis.comments && Array.isArray(analysis.comments) && analysis.comments.length > 0 
    && analysisOrientation === currentOrientation;
  
  if(shouldUseAnalysisComments) {
    // âœ… analysis.orientationì´ currentOrientationê³¼ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ì—ë§Œ analysis.comments ì‚¬ìš©
    if(currentOrientation === "front" && fullMetrics) {
      displayFrontAnalysis(fullMetrics);
    } else if(currentOrientation === "side" && fullMetrics) {
      displaySideAnalysis(fullMetrics);
    } else {
      // fullMetricsê°€ ì—†ìœ¼ë©´ analysis.comments ì‚¬ìš©
      let commentText = "";
      if(currentOrientation === "side") {
        commentText = "ğŸ“ ì¸¡ë©´ ìì„¸ ë¶„ì„ ê²°ê³¼:\n\n";
      } else if(currentOrientation === "front") {
        commentText = "ğŸ“· ì •ë©´ ìì„¸ ë¶„ì„ ê²°ê³¼:\n\n";
      }
      commentText += analysis.comments.join(" ");
    if(analysis.details && Array.isArray(analysis.details) && analysis.details.length > 0) {
      commentText += "\n\n" + analysis.details.join("\n");
    }
    commentEl.innerHTML = commentText.replace(/\n/g, '<br>');
    commentPanel.style.display = "block";
    }
    
    // ì²´í˜• ìœ í˜• ë¶„ì„ ì¶”ê°€
    const postureTypeContent = document.getElementById("postureTypeContent");
    if(postureTypeContent) {
      // âœ… í˜„ì¬ orientationì— ë§ëŠ” ë©”íŠ¸ë¦­ ê°€ì ¸ì˜¤ê¸°
      let metricsForAnalysis = {};
      
      if(currentOrientation === "side") {
        // ì¸¡ë©´ ë¶„ì„: ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ ìš°ì„  í™•ì¸
        if(S.sideAnalysis?.fullMetrics) {
          metricsForAnalysis = S.sideAnalysis.fullMetrics;
        } else if(S.metrics?.fullMetrics) {
          // fullMetricsì— ì¸¡ë©´ ë©”íŠ¸ë¦­ì´ ìˆëŠ”ì§€ í™•ì¸
          const hasSideMetrics = S.metrics.fullMetrics.CVA || S.metrics.fullMetrics.PTA || S.metrics.fullMetrics.KA;
          if(hasSideMetrics) {
            metricsForAnalysis = S.metrics.fullMetrics;
          } else {
            // ì¸¡ë©´ ë©”íŠ¸ë¦­ì´ ì—†ìœ¼ë©´ ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ì—ì„œ ê°€ì ¸ì˜¤ê¸°
            metricsForAnalysis = {};
          }
        } else if(analysis?.fullMetrics && analysis.orientation === "side") {
          metricsForAnalysis = analysis.fullMetrics;
        } else {
          metricsForAnalysis = fullMetrics || window.fullMetrics || {};
        }
      } else if(currentOrientation === "front") {
        // ì •ë©´ ë¶„ì„: ì •ë©´ ë¶„ì„ ê²°ê³¼ ìš°ì„  í™•ì¸
        if(S.frontAnalysis?.fullMetrics) {
          metricsForAnalysis = S.frontAnalysis.fullMetrics;
        } else if(S.metrics?.frontMetrics) {
          // frontMetricsê°€ ë³„ë„ë¡œ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ì‚¬ìš©
          metricsForAnalysis = S.metrics.frontMetrics;
        } else if(S.metrics?.fullMetrics) {
          // fullMetricsì— ì •ë©´ ë©”íŠ¸ë¦­ì´ ìˆëŠ”ì§€ í™•ì¸
          const hasFrontMetrics = S.metrics.fullMetrics.STA || S.metrics.fullMetrics.STA_F || S.metrics.fullMetrics.POA || S.metrics.fullMetrics.POA_F;
          if(hasFrontMetrics) {
            metricsForAnalysis = S.metrics.fullMetrics;
          } else {
            // ì •ë©´ ë©”íŠ¸ë¦­ì´ ì—†ìœ¼ë©´ ì •ë©´ ë¶„ì„ ê²°ê³¼ì—ì„œ ê°€ì ¸ì˜¤ê¸°
            metricsForAnalysis = {};
          }
        } else if(analysis?.fullMetrics && analysis.orientation === "front") {
          metricsForAnalysis = analysis.fullMetrics;
        } else {
          metricsForAnalysis = fullMetrics || window.fullMetrics || {};
        }
      } else {
        // ê¸°ë³¸: fullMetrics ì‚¬ìš©
        metricsForAnalysis = fullMetrics || S.metrics?.fullMetrics || analysis?.fullMetrics || window.fullMetrics || {};
      }
      
      if(metricsForAnalysis && Object.keys(metricsForAnalysis).length > 0) {
        // âœ… orientationì„ ì „ë‹¬í•˜ì—¬ ì •ë©´/ì¸¡ë©´ êµ¬ë¶„
        let postureType = analyzePostureType(metricsForAnalysis, currentOrientation);
        postureTypeContent.innerHTML = postureType;
      } else {
        console.warn("âš ï¸ fullMetrics ì—†ìŒ - ì²´í˜• ìœ í˜• ë¶„ì„ ìƒëµ");
        postureTypeContent.innerHTML = "ë¶„ì„ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }
    }
  } else {
    // âœ… analysis.orientationì´ currentOrientationê³¼ ì¼ì¹˜í•˜ì§€ ì•Šê±°ë‚˜ analysisê°€ ì—†ìœ¼ë©´ fullMetrics ê¸°ë°˜ìœ¼ë¡œ í‘œì‹œ
    if(currentOrientation === "side" && fullMetrics) {
      displaySideAnalysis(fullMetrics);
    } else if(currentOrientation === "front" && fullMetrics) {
      displayFrontAnalysis(fullMetrics);
  } else {
    commentPanel.style.display = "none";
    }
    
    // ì²´í˜• ìœ í˜• ë¶„ì„ ì¶”ê°€ (fullMetrics ê¸°ë°˜)
    const postureTypeContent = document.getElementById("postureTypeContent");
    if(postureTypeContent) {
      // âœ… í˜„ì¬ orientationì— ë§ëŠ” ë©”íŠ¸ë¦­ ê°€ì ¸ì˜¤ê¸°
      let metricsForAnalysis = {};
      
      if(currentOrientation === "side") {
        // ì¸¡ë©´ ë¶„ì„: ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ ìš°ì„  í™•ì¸
        if(S.sideAnalysis?.fullMetrics) {
          metricsForAnalysis = S.sideAnalysis.fullMetrics;
        } else if(S.metrics?.fullMetrics) {
          // fullMetricsì— ì¸¡ë©´ ë©”íŠ¸ë¦­ì´ ìˆëŠ”ì§€ í™•ì¸
          const hasSideMetrics = S.metrics.fullMetrics.CVA || S.metrics.fullMetrics.PTA || S.metrics.fullMetrics.KA;
          if(hasSideMetrics) {
            metricsForAnalysis = S.metrics.fullMetrics;
          } else {
            // ì¸¡ë©´ ë©”íŠ¸ë¦­ì´ ì—†ìœ¼ë©´ ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ì—ì„œ ê°€ì ¸ì˜¤ê¸°
            metricsForAnalysis = {};
          }
        } else if(analysis?.fullMetrics && analysis.orientation === "side") {
          metricsForAnalysis = analysis.fullMetrics;
        } else {
          metricsForAnalysis = fullMetrics || window.fullMetrics || {};
        }
      } else if(currentOrientation === "front") {
        // ì •ë©´ ë¶„ì„: ì •ë©´ ë¶„ì„ ê²°ê³¼ ìš°ì„  í™•ì¸
        if(S.frontAnalysis?.fullMetrics) {
          metricsForAnalysis = S.frontAnalysis.fullMetrics;
        } else if(S.metrics?.frontMetrics) {
          // frontMetricsê°€ ë³„ë„ë¡œ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ì‚¬ìš©
          metricsForAnalysis = S.metrics.frontMetrics;
        } else if(S.metrics?.fullMetrics) {
          // fullMetricsì— ì •ë©´ ë©”íŠ¸ë¦­ì´ ìˆëŠ”ì§€ í™•ì¸
          const hasFrontMetrics = S.metrics.fullMetrics.STA || S.metrics.fullMetrics.STA_F || S.metrics.fullMetrics.POA || S.metrics.fullMetrics.POA_F;
          if(hasFrontMetrics) {
            metricsForAnalysis = S.metrics.fullMetrics;
          } else {
            // ì •ë©´ ë©”íŠ¸ë¦­ì´ ì—†ìœ¼ë©´ ì •ë©´ ë¶„ì„ ê²°ê³¼ì—ì„œ ê°€ì ¸ì˜¤ê¸°
            metricsForAnalysis = {};
          }
        } else if(analysis?.fullMetrics && analysis.orientation === "front") {
          metricsForAnalysis = analysis.fullMetrics;
        } else {
          metricsForAnalysis = fullMetrics || window.fullMetrics || {};
        }
      } else {
        // ê¸°ë³¸: fullMetrics ì‚¬ìš©
        metricsForAnalysis = fullMetrics || S.metrics?.fullMetrics || analysis?.fullMetrics || window.fullMetrics || {};
      }
      
      if(metricsForAnalysis && Object.keys(metricsForAnalysis).length > 0) {
        let postureType = analyzePostureType(metricsForAnalysis, currentOrientation);
        postureTypeContent.innerHTML = postureType;
      } else {
        postureTypeContent.innerHTML = "ë¶„ì„ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }
    }
  }
  
  // ê·¼ìœ¡ ë¶„ì„ (ìƒì„¸)
  const hasTight = analysis?.tight && Array.isArray(analysis.tight) && analysis.tight.length > 0;
  const hasWeak = analysis?.weak && Array.isArray(analysis.weak) && analysis.weak.length > 0;
  
  if(analysis && (hasTight || hasWeak)) {
    if(hasTight) {
      tightList.innerHTML = analysis.tight.join(", ").replace(/,/g, ', ');
    } else {
      tightList.textContent = "ì—†ìŒ";
      tightList.style.color = "var(--muted)";
    }
    
    if(hasWeak) {
      weakList.innerHTML = analysis.weak.join(", ").replace(/,/g, ', ');
    } else {
      weakList.textContent = "ì—†ìŒ";
      weakList.style.color = "var(--muted)";
    }
    
    musclePanel.style.display = "block";
  } else {
    musclePanel.style.display = "none";
  }
  
  // ìš´ë™ ì¶”ì²œ
  if(analysis && analysis.exercises && Array.isArray(analysis.exercises) && analysis.exercises.length > 0) {
    exerciseList.innerHTML = analysis.exercises.map(ex => `<div style="margin-bottom:6px;">${ex}</div>`).join("");
    exercisePanel.style.display = "block";
  } else {
    exercisePanel.style.display = "none";
  }
  
  // í•„ë¼í…ŒìŠ¤ ì¶”ì²œ (íŒ¨í„´ ê¸°ë°˜)
  if(analysis && analysis.pilates && Array.isArray(analysis.pilates) && analysis.pilates.length > 0) {
    const pilatesHTML = analysis.pilates.map((item, idx) => renderPilatesItemCard(item, { context:'dark', index: idx, limitPerTool: 2 })).join('');
    pilatesList.innerHTML = pilatesHTML;
    pilatesPanel.style.display = "block";
  } else {
    pilatesPanel.style.display = "none";
  }
  
  // ê²°ë¡  ë° í–¥í›„ ê¶Œì¥ì‚¬í•­ ìƒì„± (íšŒì› ì´ë¦„ í¬í•¨, ì„ìƒ ì¤‘ì‹¬)
  if(conclusionPanel && conclusionContent && (analysis || scoreData)) {
    // íšŒì› ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ì„¸ì…˜ì—ì„œ ë˜ëŠ” ì „ì—­ ë³€ìˆ˜ì—ì„œ)
    const memberName = S.memberName || window.memberName || 'íšŒì›';
    
    let conclusionText = '';
    
    // íŒ¨í„´ ìš”ì•½
    const patterns = [];
    if(analysis && analysis.pilates && analysis.pilates.length > 0) {
      analysis.pilates.forEach(item => {
        if(item.name || item.issue) {
          patterns.push(item.name || item.issue);
        }
      });
    }
    
    // ê·¼ìœ¡ ë¶ˆê· í˜• ìš”ì•½
    const tightMuscles = analysis && analysis.tight ? analysis.tight : [];
    const weakMuscles = analysis && analysis.weak ? analysis.weak : [];
    
    // ê²°ë¡  ì‘ì„±
    conclusionText += `${memberName}ë‹˜ì˜ ê²€ì‚¬ ê²°ê³¼ì™€ AI ë¶„ì„ì„ ì¢…í•©í•´ë³´ë©´, ê´€ì°°ëœ ì£¼ìš” íŒ¨í„´ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n\n`;
    
    if(patterns.length > 0) {
      patterns.forEach((pattern, idx) => {
        conclusionText += `${idx + 1}. ${pattern}\n`;
      });
      conclusionText += '\n';
    } else {
      conclusionText += 'íŠ¹ì´ íŒ¨í„´ ì—†ìŒ\n\n';
    }
    
    conclusionText += `ìœ„ íŒ¨í„´ì€ íŠ¹ì • ê·¼ìœ¡êµ°ì˜ ê¸´ì¥(ì§§ì•„ì§)ê³¼ ì•½í™”(ì•½í•´ì§)ì´ ë™ë°˜ë˜ëŠ” ì „í˜•ì ì¸ ì„ìƒ ì†Œê²¬ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¶Œì¥ì‚¬í•­ì„ ì¼ê´€ë˜ê²Œ 6~12ì£¼ ë™ì•ˆ ì ìš©í•˜ë©´ ì¦ìƒ ì™„í™”ì™€ ìì„¸ ê°œì„ ì´ ê¸°ëŒ€ë©ë‹ˆë‹¤.\n\n`;
    
    // ë‹¨ê¸° ê¶Œì¥ì‚¬í•­
    conclusionText += `ã€ë‹¨ê¸°(1~4ì£¼)ã€‘\n`;
    conclusionText += `1. ê¸´ì¥ ê·¼ìœ¡ ì´ì™„ ì¤‘ì‹¬(í¼ë¡¤ëŸ¬, ê·¼ë§‰ ì´ì™„, ì •ì  ìŠ¤íŠ¸ë ˆì¹­) â€” í•˜ë£¨ 1íšŒ 10~15ë¶„\n`;
    conclusionText += `2. í˜¸í¡ ì¡°ì ˆê³¼ í•¨ê»˜í•˜ëŠ” ì½”ì–´ ê¸°ë³¸ìš´ë™ (Dead Bug, Pelvic Tilt) â€” ë§¤ì¼ 5~10ë¶„\n`;
    conclusionText += `3. ì¼ìƒ ìƒí™œì—ì„œì˜ ìì„¸ ë¦¬ì…‹(30~40ë¶„ë§ˆë‹¤) â€” ìŠµê´€í™”\n\n`;
    
    // ì¤‘ê¸° ê¶Œì¥ì‚¬í•­
    conclusionText += `ã€ì¤‘ê¸°(4~8ì£¼)ã€‘\n`;
    conclusionText += `1. ì•½í™” ê·¼ìœ¡ í™œì„±í™” (ë‘”ê·¼, ë³µíš¡ê·¼ ë“±) â€” ì£¼ 3íšŒ, ì ì§„ì  ë¶€í•˜\n`;
    conclusionText += `2. í•„ë¼í…ŒìŠ¤ ê¸°êµ¬ ìš´ë™ì„ í¬í•¨í•œ í†µí•© í”„ë¡œê·¸ë¨ â€” ì£¼ 2~3íšŒ\n`;
    conclusionText += `3. ì •ê¸° ì¬í‰ê°€ë¡œ í”„ë¡œê·¸ë¨ ì¡°ì • (3~4ì£¼ë§ˆë‹¤)\n\n`;
    
    // ì¥ê¸° ê¶Œì¥ì‚¬í•­
    conclusionText += `ã€ì¥ê¸°(8~12ì£¼ ì´ìƒ)ã€‘\n`;
    conclusionText += `í†µí•©ì  ê¸°ëŠ¥ íšŒë³µì„ ëª©í‘œë¡œ ì¼ìƒí™” ë° ìš´ë™ê°•ë„ ì¦ì§„ì„ ê¶Œì¥í•©ë‹ˆë‹¤. ê·¼ë ¥, ìœ ì—°ì„±, ì‹ ê²½ê·¼ ì œì–´ê°€ ëª¨ë‘ ê°œì„ ë˜ë©´ ìì„¸ ê°œì„  íš¨ê³¼ëŠ” ì¥ê¸°ì ìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.\n\n`;
    
    // ì ìˆ˜ ê¸°ë°˜ ì¶”ê°€ ê¶Œì¥ì‚¬í•­
    if(scoreData && scoreData.score != null) {
      const score = scoreData.score;
      if(score < 70) {
        conclusionText += `í˜„ì¬ ì²´í˜• ì¢…í•© ì ìˆ˜ê°€ ${score}ì ìœ¼ë¡œ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤. ìœ„ì˜ ë‹¨ê¸° ê¶Œì¥ì‚¬í•­ë¶€í„° ê¾¸ì¤€íˆ ì‹¤ì‹œí•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n`;
      } else if(score < 85) {
        conclusionText += `í˜„ì¬ ì²´í˜• ì¢…í•© ì ìˆ˜ê°€ ${score}ì ìœ¼ë¡œ ì–‘í˜¸í•œ í¸ì…ë‹ˆë‹¤. ì¤‘ê¸° ê¶Œì¥ì‚¬í•­ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ì†ì ì¸ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\n`;
      } else {
        conclusionText += `í˜„ì¬ ì²´í˜• ì¢…í•© ì ìˆ˜ê°€ ${score}ì ìœ¼ë¡œ ìš°ìˆ˜í•©ë‹ˆë‹¤. ì¥ê¸° ê¶Œì¥ì‚¬í•­ì„ í†µí•´ í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ê³  ë”ìš± ê°œì„ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n`;
      }
    }
    
    conclusionText += `"ìš°ë¦¬ëŠ” ê±±ì • ëŒ€ì‹  ê·¼ê±°(ë°ì´í„°)ë¡œ ì›€ì§ì…ë‹ˆë‹¤."`;
    
    conclusionContent.textContent = conclusionText;
    conclusionPanel.style.display = "block";
  } else if(conclusionPanel) {
    conclusionPanel.style.display = "none";
  }
}

// í•„ë¼í…ŒìŠ¤ ìš´ë™ ìƒì„¸ ì„¤ëª… ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
function showExerciseModal(exerciseEn = '', exerciseKo = '', purpose = '') {
  const modal = document.getElementById("pilatesExerciseModal");
  const modalTitle = document.getElementById("modalExerciseTitle");
  const modalContent = document.getElementById("modalExerciseContent");
  const closeBtn = document.getElementById("closeModalBtn");
  if(!modal || !modalTitle || !modalContent) return;
  
  const detail = getPilatesExerciseDetail(exerciseEn, exerciseKo);
  const manualDesc = pilatesExerciseDescriptions[exerciseEn] || pilatesExerciseDescriptions[exerciseKo];
  const finalEn = detail?.exercise_en || exerciseEn || manualDesc?.ko || 'Pilates Exercise';
  const finalKo = detail?.exercise_ko || exerciseKo || manualDesc?.ko || '';
  modalTitle.textContent = finalKo ? `${finalEn} (${finalKo})` : finalEn;
  
  let contentHTML = '';
  let hasContent = false;
  
  if(detail) {
    hasContent = true;
    const infoBadges = [];
    if(detail.posture_ko || detail.posture_key) {
      infoBadges.push(`ìì„¸: ${detail.posture_ko || detail.posture_key}`);
    }
    if(detail.equipment_ko || detail.equipment_en) {
      infoBadges.push(`ì¥ë¹„: ${detail.equipment_ko || detail.equipment_en}`);
    }
    if(detail.sets_reps) {
      infoBadges.push(`ì„¸íŠ¸/ë°˜ë³µ: ${detail.sets_reps}`);
    }
    if(infoBadges.length) {
      contentHTML += `<div style="margin-bottom:15px; display:flex; flex-wrap:wrap; gap:6px;">${infoBadges.map(badge => `<span style="font-size:11px; background:#eef2ff; color:#4c1d95; padding:4px 8px; border-radius:999px;">${badge}</span>`).join('')}</div>`;
    }
    
    const finalPurpose = detail.purpose || purpose || 'ìì„¸ êµì • ë° ê¸°ëŠ¥ íšŒë³µ';
    contentHTML += `<div style="margin-bottom:20px;">
      <h4 style="color:#2ec4b6; font-size:15px; margin-bottom:10px; border-bottom:2px solid #2ec4b6; padding-bottom:5px;">ìš´ë™ ëª©ì </h4>
      <p style="margin-bottom:15px; line-height:1.8;">${formatMultilineText(finalPurpose) || 'ë†’ì€ ì•ˆì •ì„±ê³¼ ê°€ë™ì„±ì„ ë™ì‹œì— í™•ë³´í•˜ê¸° ìœ„í•œ ë£¨í‹´ì…ë‹ˆë‹¤.'}</p>
    </div>`;
    
    if(detail.how_to_do) {
      contentHTML += `<div style="margin-bottom:20px;">
        <h4 style="color:#2ec4b6; font-size:15px; margin-bottom:10px; border-bottom:2px solid #2ec4b6; padding-bottom:5px;">ìš´ë™ ì„¤ëª…</h4>
        <div style="margin-bottom:15px; line-height:1.8; white-space:pre-wrap;">${formatMultilineText(detail.how_to_do)}</div>
      </div>`;
    }
    
    if(detail.key_cues || detail.sets_reps) {
      contentHTML += `<div style="margin-bottom:20px;">
        <h4 style="color:#2ec4b6; font-size:15px; margin-bottom:10px; border-bottom:2px solid #2ec4b6; padding-bottom:5px;">í•µì‹¬ í & ì§„í–‰</h4>
        ${detail.key_cues ? `<p style="margin-bottom:10px; line-height:1.8;">${formatMultilineText(detail.key_cues)}</p>` : ''}
        ${detail.sets_reps ? `<p style="margin-bottom:8px; line-height:1.6; color:#555;">ê¶Œì¥ ì„¸íŠ¸: ${detail.sets_reps}</p>` : ''}
      </div>`;
    }
    
    if(detail.precaution) {
      contentHTML += `<div style="margin-bottom:20px;">
        <h4 style="color:#ff6b6b; font-size:15px; margin-bottom:10px; border-bottom:2px solid #ff6b6b; padding-bottom:5px;">ì£¼ì˜ì‚¬í•­</h4>
        <p style="margin-bottom:15px; line-height:1.8; color:#ffb86c;">${formatMultilineText(detail.precaution)}</p>
      </div>`;
    }
  }
  
  if(manualDesc) {
    hasContent = true;
    contentHTML += `<div style="margin-bottom:20px;">
      <h4 style="color:#2ec4b6; font-size:15px; margin-bottom:10px; border-bottom:2px solid #2ec4b6; padding-bottom:5px;">ì „ë¬¸ê°€ íŒ</h4>
      <p style="margin-bottom:15px; line-height:1.8;">${formatMultilineText(manualDesc.description)}</p>
    </div>`;
    
    if(manualDesc.instructions) {
      contentHTML += `<div style="margin-bottom:20px;">
        <h4 style="color:#2ec4b6; font-size:15px; margin-bottom:10px; border-bottom:2px solid #2ec4b6; padding-bottom:5px;">ìˆ˜í–‰ ë°©ë²•</h4>
        <p style="margin-bottom:15px; line-height:1.8;">${formatMultilineText(manualDesc.instructions)}</p>
      </div>`;
    }
    
    if(manualDesc.benefits) {
      contentHTML += `<div style="margin-bottom:20px;">
        <h4 style="color:#2ec4b6; font-size:15px; margin-bottom:10px; border-bottom:2px solid #2ec4b6; padding-bottom:5px;">ìš´ë™ íš¨ê³¼</h4>
        <p style="margin-bottom:15px; line-height:1.8;">${formatMultilineText(manualDesc.benefits)}</p>
      </div>`;
    }
    
    if(manualDesc.precautions) {
      contentHTML += `<div style="margin-bottom:20px;">
        <h4 style="color:#ff6b6b; font-size:15px; margin-bottom:10px; border-bottom:2px solid #ff6b6b; padding-bottom:5px;">ì£¼ì˜ì‚¬í•­</h4>
        <p style="margin-bottom:15px; line-height:1.8; color:#ffb86c;">${formatMultilineText(manualDesc.precautions)}</p>
      </div>`;
    }
  }
  
  if(!hasContent) {
    contentHTML += `<div style="margin-bottom:20px;">
      <p style="margin-bottom:15px; line-height:1.8;">${exerciseKo || finalEn}</p>
      ${purpose ? `<p style="margin-bottom:15px; line-height:1.8; color:#2ec4b6;">ëª©ì : ${formatMultilineText(purpose)}</p>` : ''}
      <p style="margin-bottom:15px; line-height:1.8; color:var(--muted);">ìƒì„¸ ì„¤ëª…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
    </div>`;
  }
  
  modalContent.innerHTML = contentHTML;
  modal.style.display = "block";
  
  closeBtn.onclick = () => {
    modal.style.display = "none";
  };
  
  modal.onclick = (e) => {
    if(e.target === modal) {
      modal.style.display = "none";
    }
  };
  
  document.addEventListener('keydown', function escHandler(e) {
    if(e.key === 'Escape' && modal.style.display === 'block') {
      modal.style.display = "none";
      document.removeEventListener('keydown', escHandler);
    }
  });
}

function updateDisplay() {
  const M = sessions[cur].metrics;
  document.getElementById("dispCva").textContent = M.cva != null ? M.cva.toFixed(1) + "Â°" : "â€”";
  document.getElementById("dispPel").textContent = M.pelvic != null ? M.pelvic.toFixed(1) + "Â°" : "â€”";
  document.getElementById("dispKnee").textContent = M.knee != null ? M.knee.toFixed(1) + "Â°" : "â€”";
}

function fmtDeg(v) {
  return (v == null || isNaN(v)) ? "â€”" : v.toFixed(1) + "Â°";
}

function deltaStr(b, a, suf = "") {
  if(b == null || a == null || isNaN(b) || isNaN(a)) return "â€”";
  const d = a - b;
  const sign = d > 0 ? "+" : "";
  return sign + d.toFixed(1) + (suf || "");
}

function updateCompare() {
  // sessionsê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¬´ì‹œ
  if(!window.sessions || !window.sessions.Before || !window.sessions.After) {
    console.warn("updateCompare() í˜¸ì¶œ ì‹œ sessionsê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  const B = sessions.Before, A = sessions.After;
  
  // fullMetricsì—ì„œ 16ê°€ì§€ í•­ëª© ê°€ì ¸ì˜¤ê¸°
  const bMetrics = B.metrics?.fullMetrics || {};
  const aMetrics = A.metrics?.fullMetrics || {};
  
  // í—¬í¼ í•¨ìˆ˜: ë©”íŠ¸ë¦­ ê°’ ê°€ì ¸ì˜¤ê¸°
  const getMetricValue = (metrics, key) => {
    const metric = metrics[key];
    if(!metric) return null;
    return metric.value !== undefined ? metric.value : 
           (metric.value_deg !== undefined ? metric.value_deg : 
           (metric.value_cm !== undefined ? metric.value_cm : null));
  };
  
  // ì¸¡ë©´ + ì •ë©´ í•­ëª© ì—…ë°ì´íŠ¸
  const compareItems = [
    // ì¸¡ë©´ í•­ëª©
    {key: 'CVA', id: 'Cva', unit: 'Â°'},
    {key: 'HPD', id: 'Hpd', unit: 'cm'},
    {key: 'TIA', id: 'Tia', unit: 'Â°'},
    {key: 'SAA', id: 'Saa', unit: 'Â°'},
    {key: 'PTA', id: 'Pta', unit: 'Â°'},
    {key: 'KA', id: 'Ka', unit: 'Â°'},
    {key: 'Tibial_Angle', id: 'Tibial', unit: 'Â°'},
    {key: 'Knee_Deviation', id: 'Kneedev', unit: 'Â°'},
    {key: 'LLD', id: 'Lld', unit: 'cm'},
    {key: 'GSB', id: 'Gsb', unit: 'cm'},
    {key: 'HPA', id: 'Hpa', unit: 'Â°'},
    {key: 'PDS', id: 'Pds', unit: ''},
    // ì •ë©´ í•­ëª©
    {key: 'STA_F', altKey: 'STA', id: 'Sta', unit: 'Â°'},
    {key: 'POA_F', altKey: 'POA', id: 'Poa', unit: 'Â°'},
    {key: 'LLD_F', id: 'Lldf', unit: 'cm'},
    {key: 'TD', id: 'Td', unit: 'Â°'},
    {key: 'HTA', id: 'Hta', unit: 'Â°'},
    {key: 'SPP', id: 'Spp', unit: 'Â°'},
    {key: 'Q_Angle', id: 'Qangle', unit: 'Â°'},  // ì •ë©´ ë¶„ì„ í•­ëª©ìœ¼ë¡œ ì´ë™
    {key: 'KAS', id: 'Kas', unit: 'Â°'},
    {key: 'LLAS', id: 'Llas', unit: 'Â°'},
  ];
  
  // í—¬í¼ í•¨ìˆ˜: ì •ë©´ ë©”íŠ¸ë¦­ í‚¤ ê°€ì ¸ì˜¤ê¸° (í•˜ìœ„ í˜¸í™˜ì„±)
  const getFrontMetricKey = (metrics, key, altKey) => {
    if(metrics[key]) return key;
    if(altKey && metrics[altKey]) return altKey;
    return key;
  };
  
  compareItems.forEach(item => {
    // ì •ë©´ í•­ëª©ì˜ ê²½ìš° í•˜ìœ„ í˜¸í™˜ì„± í‚¤ í™•ì¸
    const metricKeyB = item.altKey ? getFrontMetricKey(bMetrics, item.key, item.altKey) : item.key;
    const metricKeyA = item.altKey ? getFrontMetricKey(aMetrics, item.key, item.altKey) : item.key;
    
    const vB = getMetricValue(bMetrics, metricKeyB);
    const vA = getMetricValue(aMetrics, metricKeyA);
    
    const elB = document.getElementById(`cmp${item.id}B`);
    const elA = document.getElementById(`cmp${item.id}A`);
    const elD = document.getElementById(`cmp${item.id}D`);
    
    if(elB && elA && elD) {
      if(vB != null) {
        elB.textContent = vB.toFixed(item.unit === '' ? 2 : 1) + item.unit;
      } else {
        elB.textContent = "â€”";
      }
      
      if(vA != null) {
        elA.textContent = vA.toFixed(item.unit === '' ? 2 : 1) + item.unit;
      } else {
        elA.textContent = "â€”";
      }
      
      if(vB != null && vA != null) {
        elD.textContent = deltaStr(vB, vA, item.unit);
      } else {
        elD.textContent = "â€”";
      }
    }
  });
  
  // ì ìˆ˜ ë¹„êµ ì—…ë°ì´íŠ¸
  const sB = B.score ? B.score.score : null, sA = A.score ? A.score.score : null;
  const scoreElB = document.getElementById("cmpScoreB");
  const scoreElA = document.getElementById("cmpScoreA");
  const scoreElD = document.getElementById("cmpScoreD");
  
  if(scoreElB && scoreElA && scoreElD) {
    scoreElB.textContent = sB != null ? sB : "â€”";
    scoreElA.textContent = sA != null ? sA : "â€”";
    if(sB != null && sA != null) {
      scoreElD.textContent = deltaStr(sB, sA, "");
    } else {
      scoreElD.textContent = "â€”";
    }
  }
}

// ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ í† ê¸€
const btnEditCoords = document.getElementById("btnEditCoords");
const coordEditPanel = document.getElementById("coordEditPanel");
if(btnEditCoords && coordEditPanel) {
  btnEditCoords.onclick = () => {
    editMode = !editMode;
    console.log("ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ:", editMode ? "í™œì„±" : "ë¹„í™œì„±");
    if(editMode) {
      // ì›ë³¸ í¬ê¸° ì €ì¥
      if(originalCanvasSize.width === 0) {
        originalCanvasSize.width = cv.width / DPR;
        originalCanvasSize.height = cv.height / DPR;
        originalCanvasSize.styleWidth = parseFloat(cv.style.width) || cv.width / DPR;
        originalCanvasSize.styleHeight = parseFloat(cv.style.height) || cv.height / DPR;
      }
      coordEditPanel.style.display = "block";
      btnEditCoords.style.background = "rgba(124,156,255,0.4)";
      btnEditCoords.textContent = "âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ (í™œì„±)";
      // í™•ëŒ€ ì ìš©
      applyZoom();
    } else {
      // ì›ë˜ í¬ê¸°ë¡œ ë³µì›
      currentZoom = 1;
      coordEditPanel.style.display = "none";
      btnEditCoords.style.background = "rgba(124,156,255,0.2)";
      btnEditCoords.textContent = "âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ";
      selectedPoint = null;
      const selectEl = document.getElementById("coordSelectPoint");
      const xEl = document.getElementById("coordX");
      const yEl = document.getElementById("coordY");
      const zoomEl = document.getElementById("zoomLevel");
      if(selectEl) selectEl.value = "";
      if(xEl) xEl.value = "";
      if(yEl) yEl.value = "";
      if(zoomEl) zoomEl.value = "1";
      // ì›ë³¸ í¬ê¸° ì´ˆê¸°í™”í•˜ì—¬ ë‹¤ì‹œ ê³„ì‚°ë˜ë„ë¡
      originalCanvasSize.width = 0;
      originalCanvasSize.height = 0;
      originalCanvasSize.styleWidth = 0;
      originalCanvasSize.styleHeight = 0;
      // ì›ë³¸ í¬ê¸°ë¡œ ë³µì›
      const S = sessions[cur];
      const orientation = S.poseData?.orientation || "side";
      const img = orientation === "front" ? S.imgFront : S.imgSide;
      if(img) {
        resizeCanvasFor(img);
      }
      draw(); // ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    }
  };
} else {
  console.error("ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", {btnEditCoords, coordEditPanel});
}

// í™•ëŒ€ ì ìš© í•¨ìˆ˜
function applyZoom() {
  const S = sessions[cur];
  const orientation = S.poseData?.orientation || "side";
  const img = orientation === "front" ? S.imgFront : S.imgSide;
  
  if((!editMode && !calibrationMode) || !img) {
    return;
  }
  
  // editModeì¼ ë•ŒëŠ” zoomLevel, calibrationModeì¼ ë•ŒëŠ” calibrationZoomLevel ì‚¬ìš©
  const zoomEl = editMode ? document.getElementById("zoomLevel") : document.getElementById("calibrationZoomLevel");
  if(zoomEl) {
    const newZoom = parseInt(zoomEl.value) || 1;
    currentZoom = clamp(newZoom, 1, 4); // 1~4ë°°ë¡œ ì œí•œ
  }
  
  // ì›ë³¸ ì´ë¯¸ì§€ë¡œ í™•ëŒ€ ì ìš© (ë¹„ìœ¨ ìœ ì§€)
  resizeCanvasFor(img);
  
  // ì¢Œí‘œ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
  if(selectedPoint) {
    const P = getPts(cur);
    const pt = P[selectedPoint];
    if(pt && coordX && coordY) {
      // ì¢Œí‘œëŠ” í•­ìƒ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œ
      coordX.value = pt.x.toFixed(1);
      coordY.value = pt.y.toFixed(1);
    }
  }
}

// í™•ëŒ€ ë°°ìœ¨ ë³€ê²½
const zoomLevel = document.getElementById("zoomLevel");
if(zoomLevel) {
  zoomLevel.addEventListener("change", () => {
    if(editMode) {
      applyZoom();
    }
  });
}

// âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œ í™•ëŒ€ ë°°ìœ¨ ë³€ê²½ ì´ë²¤íŠ¸
const calibrationZoomLevel = document.getElementById("calibrationZoomLevel");
if(calibrationZoomLevel) {
  calibrationZoomLevel.addEventListener("change", () => {
    if(calibrationMode) {
      applyZoom();
    }
  });
}

// ì  ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½
const coordSelectPoint = document.getElementById("coordSelectPoint");
const coordX = document.getElementById("coordX");
const coordY = document.getElementById("coordY");

// ì  ì„ íƒ ì‹œ ì¢Œí‘œ í‘œì‹œ í•¨ìˆ˜
function updateCoordDisplay() {
  if(!coordX || !coordY) return;
  
  if(selectedPoint) {
    const P = getPts(cur);
    const pt = P[selectedPoint];
    if(pt) {
      // ì›ë³¸ í¬ê¸° ê¸°ì¤€ ì¢Œí‘œ í‘œì‹œ
      coordX.value = pt.x.toFixed(1);
      coordY.value = pt.y.toFixed(1);
    } else {
      // ì ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì • (ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° ì¤‘ì•™ ê·¼ì²˜)
      if(sessions[cur].img) {
        const originalW = originalCanvasSize.width || (cv.width / DPR);
        const originalH = originalCanvasSize.height || (cv.height / DPR);
        const defaultX = (originalW / 2).toFixed(1);
        const defaultY = (originalH / 2).toFixed(1);
        coordX.value = defaultX;
        coordY.value = defaultY;
      } else {
        coordX.value = "";
        coordY.value = "";
      }
    }
    draw();
  } else {
    coordX.value = "";
    coordY.value = "";
    draw();
  }
}

if(coordSelectPoint && coordX && coordY) {
  coordSelectPoint.addEventListener("change", e => {
    selectedPoint = e.target.value || null;
    console.log("ì„ íƒëœ ì :", selectedPoint);
    updateCoordDisplay();
  });
  
  // ì´ˆê¸°í™” ì‹œì—ë„ ì¢Œí‘œ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì ì´ ì´ë¯¸ ì„ íƒë˜ì–´ ìˆìœ¼ë©´)
  if(selectedPoint) {
    updateCoordDisplay();
  }
} else {
  console.error("ì¢Œí‘œ ì…ë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", {coordSelectPoint, coordX, coordY});
}

// ë“œë˜ê·¸í•  ë•Œë„ ì¢Œí‘œ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
window.updateCoordDisplay = updateCoordDisplay;

// ì¢Œí‘œ ì ìš© (ì €ì¥ ë²„íŠ¼ ì—­í•  - AI ë¶„ì„ ì‹¤í–‰)
const coordApply = document.getElementById("coordApply");
if(coordApply) {
  coordApply.onclick = () => {
    if(!selectedPoint) {
      alert("ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    const x = parseFloat(coordX.value);
    const y = parseFloat(coordY.value);
    if(isNaN(x) || isNaN(y)) {
      alert("ì˜¬ë°”ë¥¸ ì¢Œí‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    // ì¢Œí‘œëŠ” í•­ìƒ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì €ì¥
    const originalW = originalCanvasSize.width || (cv.width / DPR / (editMode ? currentZoom : 1));
    const originalH = originalCanvasSize.height || (cv.height / DPR / (editMode ? currentZoom : 1));
    const orientation = sessions[cur].poseData?.orientation || "side";
    const map = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
    const clampedX = clamp(x, 0, originalW);
    const clampedY = clamp(y, 0, originalH);
    map.set(selectedPoint, {
      x: clampedX,
      y: clampedY
    });
    // ì ì„ ê³¼ ë„íŠ¸ê°€ í•­ìƒ ê·¸ë ¤ì§€ë„ë¡ ë³´ì¥
    try {
      draw();
    } catch(err) {
      console.error("draw() í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ (coordApply):", err);
      // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ë‹¤ì‹œ ì‹œë„
      setTimeout(() => {
        try {
          draw();
        } catch(retryErr) {
          console.error("draw() ì¬ì‹œë„ ì‹¤íŒ¨:", retryErr);
        }
      }, 10);
    }
    // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
    coordX.value = clampedX.toFixed(1);
    coordY.value = clampedY.toFixed(1);
    
    // ì €ì¥ í›„ ì›ë˜ í¬ê¸°ë¡œ ë³µì› ë° ëª¨ë“œ ì¢…ë£Œ
    if(editMode) {
      // ë¨¼ì € editModeë¥¼ falseë¡œ ì„¤ì •í•˜ì—¬ resizeCanvasForê°€ ì›ë³¸ í¬ê¸°ë¡œ ë³µì›í•˜ë„ë¡ í•¨
      editMode = false;
      currentZoom = 1;
      
      // UI ì—…ë°ì´íŠ¸
      const zoomEl = document.getElementById("zoomLevel");
      if(zoomEl) zoomEl.value = "1";
      
      // íŒ¨ë„ ë‹«ê¸°
      if(coordEditPanel) {
        coordEditPanel.style.display = "none";
      }
      
      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      if(btnEditCoords) {
        btnEditCoords.style.background = "rgba(124,156,255,0.2)";
        btnEditCoords.textContent = "âœï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ";
      }
      
      // ì„ íƒëœ ì  ì´ˆê¸°í™”
      selectedPoint = null;
      const selectEl = document.getElementById("coordSelectPoint");
      if(selectEl) selectEl.value = "";
      
      // ì›ë³¸ í¬ê¸°ë¡œ ë³µì› (orientationì— ë”°ë¼ ì˜¬ë°”ë¥¸ ì´ë¯¸ì§€ ì‚¬ìš©)
      const S = sessions[cur];
      const orientation = S.poseData?.orientation || "side";
      const img = orientation === "front" ? S.imgFront : S.imgSide;
      
      // ëª¨ë°”ì¼ì—ì„œ ì•ˆì •ì ì¸ ë Œë”ë§ì„ ìœ„í•´ requestAnimationFrame ì‚¬ìš©
      requestAnimationFrame(() => {
        if(img) {
          resizeCanvasFor(img);
        } else if(S.img) {
          resizeCanvasFor(S.img);
        }
        
        // ê°•ì œ ë¦¬í”Œë¡œìš°ë¥¼ ìœ„í•´ í•œ í”„ë ˆì„ ë” ëŒ€ê¸° (ëª¨ë°”ì¼ì—ì„œ í•„ìš”)
        requestAnimationFrame(() => {
          draw();
          
          // ëª¨ë°”ì¼ì—ì„œ ì¶”ê°€ ì•ˆì •ì„±ì„ ìœ„í•´ í•œ ë²ˆ ë” ëŒ€ê¸°
          requestAnimationFrame(() => {
            // ìº”ë²„ìŠ¤ í¬ê¸° ê°•ì œ ì—…ë°ì´íŠ¸ (ëª¨ë°”ì¼ì—ì„œ í•„ìš”í•  ìˆ˜ ìˆìŒ)
            if(cv && cv.style) {
              cv.style.width = cv.style.width;
              cv.style.height = cv.style.height;
            }
          });
        });
      });
    }
    
    // AI ë¶„ì„ ì‹¤í–‰ (ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ì—¬ ë™ ë°©ì§€, ëª¨ë°”ì¼ì—ì„œëŠ” ë” ê¸´ ì§€ì—°)
    const isMobile = window.innerWidth <= 768 && 'ontouchstart' in window;
    const delay = isMobile ? 150 : 50;
    setTimeout(() => {
      computeAll();
      // ì‹¤ì‹œê°„ ë¶„ì„ ì‹¤í–‰
      if(typeof liveAnalyzer !== 'undefined') {
        liveAnalyzer.analyzeCurrentSession();
      }
    }, delay);
  };
}

// ì·¨ì†Œ
const coordCancel = document.getElementById("coordCancel");
if(coordCancel) {
  coordCancel.onclick = () => {
    selectedPoint = null;
    if(coordSelectPoint) coordSelectPoint.value = "";
    if(coordX) coordX.value = "";
    if(coordY) coordY.value = "";
    draw();
  };
}

// X, Y ì¢Œí‘œ ì…ë ¥ í•„ë“œì—ì„œ Enter í‚¤ë¡œë„ ì ìš© ê°€ëŠ¥
if(coordX) {
  coordX.addEventListener("keypress", e => {
    if(e.key === "Enter") {
      if(coordApply) coordApply.click();
    }
  });
}
if(coordY) {
  coordY.addEventListener("keypress", e => {
    if(e.key === "Enter") {
      if(coordApply) coordApply.click();
    }
  });
}

// ì¢Œí‘œ ì¦ê° ë²„íŠ¼ ê¸°ëŠ¥ (ìë™ ì ìš©)
function adjustCoordinate(coordField, delta) {
  if(!coordField) return;
  
  // í˜„ì¬ ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
  let currentValue = parseFloat(coordField.value);
  if(isNaN(currentValue)) {
    // ì¢Œí‘œê°€ ì—†ìœ¼ë©´ ì¤‘ì•™ê°’ìœ¼ë¡œ ì„¤ì •
    const originalW = originalCanvasSize.width || (cv.width / DPR);
    const originalH = originalCanvasSize.height || (cv.height / DPR);
    if(coordField === coordX) {
      currentValue = originalW / 2;
    } else {
      currentValue = originalH / 2;
    }
  }
  
  const newValue = currentValue + delta;
  coordField.value = newValue.toFixed(1);
  
  // ìë™ìœ¼ë¡œ ì ìš© (ì ì´ ì„ íƒë˜ì–´ ìˆê³  ì¢Œí‘œê°€ ìœ íš¨í•œ ê²½ìš°)
  if(selectedPoint && !isNaN(newValue)) {
    const xField = coordX;
    const yField = coordY;
    if(!xField || !yField) return;
    
    const x = parseFloat(xField.value);
    const y = parseFloat(yField.value);
    
    if(!isNaN(x) && !isNaN(y)) {
      // ì¢Œí‘œëŠ” í•­ìƒ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì €ì¥
      const originalW = originalCanvasSize.width || (cv.width / DPR / (editMode ? currentZoom : 1));
      const originalH = originalCanvasSize.height || (cv.height / DPR / (editMode ? currentZoom : 1));
      const orientation = sessions[cur].poseData?.orientation || "side";
      const map = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
      const clampedX = clamp(x, 0, originalW);
      const clampedY = clamp(y, 0, originalH);
      
      map.set(selectedPoint, {
        x: clampedX,
        y: clampedY
      });
      
      // ì…ë ¥ í•„ë“œë„ ì—…ë°ì´íŠ¸ (í´ë¨í•‘ëœ ê°’)
      xField.value = clampedX.toFixed(1);
      yField.value = clampedY.toFixed(1);
      
    draw();
    computeMetricsOnly(); // ì‹¤ì‹œê°„ ë¶„ì„ ì—†ìŒ (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ AI ë¶„ì„)
    }
  }
}

// ì¦ê° ë²„íŠ¼ ì—°ì† í´ë¦­ ë³€ìˆ˜
let incrementTimer = null;
let incrementInterval = null;

function startIncrement(coordField, delta) {
  // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
  adjustCoordinate(coordField, delta);
  
  // ì§§ì€ ë”œë ˆì´ í›„ ì—°ì† ì‹¤í–‰
  incrementTimer = setTimeout(() => {
    incrementInterval = setInterval(() => {
      adjustCoordinate(coordField, delta);
    }, 50); // 50msë§ˆë‹¤ ì‹¤í–‰ (ë¹ ë¥¸ ì¦ê°)
  }, 300); // 300ms í›„ ì—°ì† ì‹¤í–‰ ì‹œì‘
}

function stopIncrement() {
  if(incrementTimer) {
    clearTimeout(incrementTimer);
    incrementTimer = null;
  }
  if(incrementInterval) {
    clearInterval(incrementInterval);
    incrementInterval = null;
  }
}

// X ì¢Œí‘œ ì¦ê° ë²„íŠ¼
const coordXDec = document.getElementById("coordXDec");
const coordXInc = document.getElementById("coordXInc");
if(coordXDec) {
  coordXDec.onmousedown = () => {
    if(coordX) startIncrement(coordX, -0.1);
  };
  coordXDec.onmouseup = stopIncrement;
  coordXDec.onmouseleave = stopIncrement;
  coordXDec.ontouchstart = (e) => {
    e.preventDefault();
    if(coordX) startIncrement(coordX, -0.1);
  };
  coordXDec.ontouchend = (e) => {
    e.preventDefault();
    stopIncrement();
  };
  coordXDec.ontouchcancel = (e) => {
    e.preventDefault();
    stopIncrement();
  };
}
if(coordXInc) {
  coordXInc.onmousedown = () => {
    if(coordX) startIncrement(coordX, 0.1);
  };
  coordXInc.onmouseup = stopIncrement;
  coordXInc.onmouseleave = stopIncrement;
  coordXInc.ontouchstart = (e) => {
    e.preventDefault();
    if(coordX) startIncrement(coordX, 0.1);
  };
  coordXInc.ontouchend = (e) => {
    e.preventDefault();
    stopIncrement();
  };
  coordXInc.ontouchcancel = (e) => {
    e.preventDefault();
    stopIncrement();
  };
}

// Y ì¢Œí‘œ ì¦ê° ë²„íŠ¼ (YëŠ” í™”ë©´ ì•„ë˜ë¡œ ê°ˆìˆ˜ë¡ ê°’ì´ ì»¤ì§€ë¯€ë¡œ ë°˜ëŒ€ë¡œ)
const coordYDec = document.getElementById("coordYDec");
const coordYInc = document.getElementById("coordYInc");
if(coordYDec) {
  coordYDec.onmousedown = () => {
    if(coordY) startIncrement(coordY, 0.1); // YëŠ” ìœ„ë¡œ ê°€ë ¤ë©´ ê°’ì´ ì¦ê°€í•´ì•¼ í•¨
  };
  coordYDec.onmouseup = stopIncrement;
  coordYDec.onmouseleave = stopIncrement;
  coordYDec.ontouchstart = (e) => {
    e.preventDefault();
    if(coordY) startIncrement(coordY, 0.1);
  };
  coordYDec.ontouchend = (e) => {
    e.preventDefault();
    stopIncrement();
  };
  coordYDec.ontouchcancel = (e) => {
    e.preventDefault();
    stopIncrement();
  };
}
if(coordYInc) {
  coordYInc.onmousedown = () => {
    if(coordY) startIncrement(coordY, -0.1); // YëŠ” ì•„ë˜ë¡œ ê°€ë ¤ë©´ ê°’ì´ ê°ì†Œí•´ì•¼ í•¨
  };
  coordYInc.onmouseup = stopIncrement;
  coordYInc.onmouseleave = stopIncrement;
  coordYInc.ontouchstart = (e) => {
    e.preventDefault();
    if(coordY) startIncrement(coordY, -0.1);
  };
  coordYInc.ontouchend = (e) => {
    e.preventDefault();
    stopIncrement();
  };
  coordYInc.ontouchcancel = (e) => {
    e.preventDefault();
    stopIncrement();
  };
}

// ë“œë˜ê·¸ ê¸°ëŠ¥ (ë§ˆìš°ìŠ¤ + í„°ì¹˜)
function getEventPos(e) {
  const r = cv.getBoundingClientRect();
  const clientX = e.touches && e.touches.length > 0 ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches && e.touches.length > 0 ? e.touches[0].clientY : e.clientY;
  
  // ìº”ë²„ìŠ¤ ìƒëŒ€ ì¢Œí‘œ (ìº”ë²„ìŠ¤ ê¸°ì¤€)
  // getBoundingClientRect()ëŠ” ì´ë¯¸ ìŠ¤í¬ë¡¤ëœ ìœ„ì¹˜ë¥¼ ë°˜ì˜í•˜ë¯€ë¡œ
  // clientX - r.leftëŠ” ìº”ë²„ìŠ¤ ì „ì²´ì—ì„œì˜ CSS í”½ì…€ ìœ„ì¹˜ì…ë‹ˆë‹¤
  let x = clientX - r.left;
  let y = clientY - r.top;
  
  // í™•ëŒ€ ëª¨ë“œ
  if(editMode && currentZoom > 1) {
    // x, yëŠ” ì´ë¯¸ í™•ëŒ€ëœ ìº”ë²„ìŠ¤ ì „ì²´ì—ì„œì˜ CSS í”½ì…€ ìœ„ì¹˜ (ìŠ¤í¬ë¡¤ í¬í•¨)
    // ë”°ë¼ì„œ zoomìœ¼ë¡œ ë‚˜ëˆ„ê¸°ë§Œ í•˜ë©´ ì›ë³¸ í¬ê¸° ì¢Œí‘œê°€ ë¨
    x = x / currentZoom;
    y = y / currentZoom;
    
    // ì›ë³¸ í¬ê¸° ë²”ìœ„ë¡œ ì œí•œ
    const originalW = originalCanvasSize.width || (cv.width / DPR / currentZoom);
    const originalH = originalCanvasSize.height || (cv.height / DPR / currentZoom);
    x = Math.max(0, Math.min(x, originalW));
    y = Math.max(0, Math.min(y, originalH));
    
    console.log('í™•ëŒ€ ëª¨ë“œ ì¢Œí‘œ ë³€í™˜:', {
      clientX, clientY,
      rLeft: r.left.toFixed(1), rTop: r.top.toFixed(1),
      beforeZoom: {x: (clientX - r.left).toFixed(1), y: (clientY - r.top).toFixed(1)},
      afterZoom: {x: x.toFixed(1), y: y.toFixed(1)},
      zoom: currentZoom
    });
  } else {
    // ì¼ë°˜ ëª¨ë“œ: CSS ì¢Œí‘œë¥¼ ìº”ë²„ìŠ¤ ë…¼ë¦¬ ì¢Œí‘œë¡œ ë³€í™˜
    const cssWidth = r.width;
    const cssHeight = r.height;
    
    // ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜
    const originalW = originalCanvasSize.width || (cv.width / DPR);
    const originalH = originalCanvasSize.height || (cv.height / DPR);
    
    // CSS ì¢Œí‘œë¥¼ ë…¼ë¦¬ ì¢Œí‘œë¡œ ë³€í™˜
    x = (x / cssWidth) * originalW;
    y = (y / cssHeight) * originalH;
    
    // ë²”ìœ„ ì œí•œ
    x = Math.max(0, Math.min(x, originalW));
    y = Math.max(0, Math.min(y, originalH));
  }
  
  return { x, y };
}

function startDrag(e) {
  // âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œì¼ ë•ŒëŠ” dot ì„ íƒ ë¶ˆê°€
  if(calibrationMode) {
    console.log('âš ï¸ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œ ì¤‘ì´ë¯€ë¡œ dot ì„ íƒ ë¶ˆê°€');
    return false;
  }
  
  // ìƒíƒœ ì´ˆê¸°í™” (touchstartì—ì„œ ì´ë¯¸ ì´ˆê¸°í™”í–ˆì„ ìˆ˜ ìˆì§€ë§Œ ë‹¤ì‹œ ì´ˆê¸°í™”)
  // ì´ì „ ìƒíƒœê°€ ì™„ì „íˆ ì •ë¦¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
  if(dragKey) {
    console.log('âš ï¸ startDrag: ì´ì „ ë“œë˜ê·¸ ìƒíƒœê°€ ì•„ì§ ë‚¨ì•„ìˆìŒ:', dragKey);
  }
  
  // ìƒíƒœ ì´ˆê¸°í™” (ëª…ì‹œì ìœ¼ë¡œ)
  dragKey = null;
  isScrolling = false;
  scrollDistance = 0;
  
  // í„°ì¹˜ ì´ë²¤íŠ¸ì¸ ê²½ìš° ì†ê°€ë½ ê°œìˆ˜ í™•ì¸
  let touchCount = 0;
  if(e.touches) {
    touchCount = e.touches.length;
    touchStartTime = Date.now();
  }
  
  // í™•ëŒ€ ëª¨ë“œì—ì„œ ìŠ¤í¬ë¡¤ì€ ë‘ ì†ê°€ë½ë§Œ í—ˆìš©
  if(editMode && currentZoom > 1 && touchCount === 2) {
    // ë‘ ì†ê°€ë½ í„°ì¹˜: ìŠ¤í¬ë¡¤ ëª¨ë“œë§Œ í—ˆìš© (ì  ë“œë˜ê·¸ ë¶ˆê°€)
    isScrolling = true;
    dragKey = null;
    if(e.touches && e.touches.length > 0) {
      scrollStartX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
      scrollStartY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
    }
    return false;
  }
  
  // í•œ ì†ê°€ë½ í„°ì¹˜ë§Œ ì  ë“œë˜ê·¸ í—ˆìš©
  if(touchCount > 1 && !(editMode && currentZoom > 1)) {
    // í™•ëŒ€ ëª¨ë“œê°€ ì•„ë‹Œë° ë‘ ì†ê°€ë½ ì´ìƒì´ë©´ ë¬´ì‹œ
    return false;
  }
  
  const pos = getEventPos(e);
  const P = getPts(cur);
  
  // Long press ê´€ë ¨ ìƒíƒœ ì´ˆê¸°í™” (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ ì •ë¦¬ìš©)
  if(longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
  longPressDetected = false;
  longPressNearPoint = null;
  
  // ë¨¼ì € ëª¨ë“  ì ì„ ì²´í¬í•˜ì—¬ ì ì„ í„°ì¹˜í–ˆëŠ”ì§€ í™•ì¸
  // getEventPosëŠ” ì´ë¯¸ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì¢Œí‘œë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ, ì  ì¢Œí‘œì™€ ì§ì ‘ ë¹„êµ ê°€ëŠ¥
  let bestPoint = null;
  let bestDistance = 1e9;
  
  // threshold ê³„ì‚°: í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” 1cm ì •ë„ì˜ ê°ì§€ ì˜ì—­ë§Œ ìœ ì§€
  // 1cmë¥¼ í”½ì…€ë¡œ ë³€í™˜ (ì¼ë°˜ì ìœ¼ë¡œ 96 DPI ê¸°ì¤€ ì•½ 37.8í”½ì…€, í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” devicePixelRatio ê³ ë ¤)
  // ì‹¤ì œ í™”ë©´ í¬ê¸°ë¥¼ ê³ ë ¤í•˜ì—¬ ë” ì •í™•í•˜ê²Œ ê³„ì‚°
  const r = cv.getBoundingClientRect();
  const screenWidth = r.width; // CSS í”½ì…€
  
  // 2cmë¥¼ í”½ì…€ë¡œ ë³€í™˜ (96 DPI ê¸°ì¤€: 1cm â‰ˆ 37.8px, 2cm â‰ˆ 75.6px)
  // í•˜ì§€ë§Œ ì‹¤ì œ í™”ë©´ì—ì„œëŠ” devicePixelRatioë¥¼ ê³ ë ¤í•´ì•¼ í•¨
  // ê°„ë‹¨í•˜ê²Œ í™”ë©´ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ 2cmë¥¼ ì¶”ì • (í™”ë©´ ë„ˆë¹„ì˜ ì•½ 5% ì •ë„)
  const cmToPixel = screenWidth * 0.05; // í™”ë©´ ë„ˆë¹„ì˜ 5%ë¥¼ 2cmë¡œ ì¶”ì •
  // í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ì´ë¯€ë¡œ thresholdë¥¼ ì ì ˆíˆ ì„¤ì •
  // ë„ˆë¬´ í¬ë©´ ë¹ˆ í™”ë©´ì„ ëˆŒëŸ¬ë„ ë“œë˜ê·¸ê°€ ì‹œì‘ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì ì ˆí•œ ë²”ìœ„ ìœ ì§€
  const baseThreshold = Math.max(50, Math.min(100, cmToPixel)); // ìµœì†Œ 50px, ìµœëŒ€ 100px (2cm)
  
  // í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ thresholdë¥¼ ê³„ì‚°
  // ëª¨ë“  í™•ëŒ€ ë°°ìœ¨ì—ì„œ ë™ì¼í•œ ì¸ì‹ ë²”ìœ„ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ threshold ì‚¬ìš©
  let threshold;
  if(editMode && currentZoom > 1) {
    // í™•ëŒ€ ëª¨ë“œ: ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ threshold ì„¤ì •
    // ëª¨ë“  í™•ëŒ€ ë°°ìœ¨(2, 3, 4ë°°)ì—ì„œ ë™ì¼í•œ ì¸ì‹ ë²”ìœ„ë¥¼ ìœ ì§€
    // ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ì´ë¯€ë¡œ thresholdëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©
    threshold = baseThreshold; // í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” ì›ë³¸ ê¸°ì¤€ threshold ì‚¬ìš© (ëª¨ë“  ë°°ìœ¨ì—ì„œ ë™ì¼)
  } else {
    // ì¼ë°˜ ëª¨ë“œ: í™”ë©´ í”½ì…€ ê¸°ì¤€ (ë¼ë²¨ ì˜ì—­ í¬í•¨)
    threshold = baseThreshold * 1.5; // ë¼ë²¨ ì˜ì—­ í¬í•¨ì„ ìœ„í•´ ì•½ê°„ ë” í¬ê²Œ
  }
  
  console.log('ë“œë˜ê·¸ ê°ì§€ ì‹œì‘, threshold:', threshold, 'editMode:', editMode, 'zoom:', currentZoom, 'pos:', pos, 'baseThreshold:', baseThreshold);
  
  // âœ… í™•ëŒ€ ëª¨ë“œ(2, 3, 4ë°°)ì—ì„œëŠ” ì„ íƒëœ ì ë§Œ ì²´í¬ (ë‹¤ë¥¸ ì  ì„ íƒ ë¶ˆê°€)
  if(editMode && currentZoom > 1) {
    // í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” ì„ íƒëœ ì ì´ ìˆìœ¼ë©´ ê·¸ ì ë§Œ ì²´í¬
    if(selectedPoint) {
      const pt = P[selectedPoint];
      if(pt) {
        // ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ê±°ë¦¬ ê³„ì‚°
        const d = Math.hypot(pt.x - pos.x, pt.y - pos.y);
        if(d < threshold) {
          bestPoint = selectedPoint;
          bestDistance = d;
          console.log('âœ… í™•ëŒ€ ëª¨ë“œ - ì„ íƒëœ ì  ë“œë˜ê·¸ ì‹œì‘ (ë°°ìœ¨ ' + currentZoom + '):', selectedPoint, 'ê±°ë¦¬:', d.toFixed(2));
        } else {
          console.log('âŒ í™•ëŒ€ ëª¨ë“œ - ì„ íƒëœ ì ì´ ë„ˆë¬´ ë©€ì–´ì„œ ë“œë˜ê·¸ ë¶ˆê°€:', selectedPoint, 'ê±°ë¦¬:', d.toFixed(2), 'threshold:', threshold);
        }
      }
    } else {
      // í™•ëŒ€ ëª¨ë“œì¸ë° ì„ íƒëœ ì ì´ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ë¶ˆê°€
      console.log('âš ï¸ í™•ëŒ€ ëª¨ë“œì´ì§€ë§Œ ì„ íƒëœ ì ì´ ì—†ì–´ì„œ ë“œë˜ê·¸ ë¶ˆê°€ (ë“œë¡­ë‹¤ìš´ì—ì„œ ì ì„ ì„ íƒí•˜ì„¸ìš”)');
      return false;
    }
  } else if(editMode && selectedPoint) {
    // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œ(ë°°ìœ¨ 1)ì—ì„œ ì„ íƒëœ ì ì´ ìˆìœ¼ë©´ ê·¸ ì ë§Œ ì²´í¬
    const pt = P[selectedPoint];
    if(pt) {
      // ë°°ìœ¨ 1ì´ì–´ë„ ì›ë³¸ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ê±°ë¦¬ ê³„ì‚° (thresholdë„ ì›ë³¸ ê¸°ì¤€)
      // posëŠ” ì´ë¯¸ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜ë˜ì–´ ìˆìŒ
      const d = Math.hypot(pt.x - pos.x, pt.y - pos.y);
      if(d < threshold) {
        bestPoint = selectedPoint;
        bestDistance = d;
        console.log('âœ… ì„ íƒëœ ì  ë“œë˜ê·¸ ì‹œì‘ (ë°°ìœ¨ ' + currentZoom + '):', selectedPoint, 'ê±°ë¦¬:', d.toFixed(2));
      } else {
        console.log('âŒ ì„ íƒëœ ì ì´ ë„ˆë¬´ ë©€ì–´ì„œ ë“œë˜ê·¸ ë¶ˆê°€:', selectedPoint, 'ê±°ë¦¬:', d.toFixed(2), 'threshold:', threshold);
      }
    }
    // ì„ íƒëœ ì ë§Œ ì²´í¬í•˜ë¯€ë¡œ ë‹¤ë¥¸ ì ì€ ì²´í¬í•˜ì§€ ì•ŠìŒ (bestPointê°€ nullì´ë©´ ë“œë˜ê·¸ ì‹œì‘ ì•ˆ ë¨)
  } else if(editMode && !selectedPoint) {
    // editModeì§€ë§Œ ì„ íƒëœ ì ì´ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ë¶ˆê°€
    console.log('âš ï¸ ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì´ì§€ë§Œ ì„ íƒëœ ì ì´ ì—†ì–´ì„œ ë“œë˜ê·¸ ë¶ˆê°€');
    return false;
  } else {
    // ì¼ë°˜ ëª¨ë“œ (editModeê°€ false): ëª¨ë“  ì  ì²´í¬ (í˜„ì¬ orientationì— ë§ëŠ” í‚¤í¬ì¸íŠ¸ ì‚¬ìš©)
    const currentKeypoints = getKeypoints();
    for(const k of currentKeypoints) {
      const p = P[k.key];
      if(!p) continue;
      
      // ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” CSS ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ê±°ë¦¬ ê³„ì‚°
        // posëŠ” ì´ë¯¸ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜ë˜ì–´ ìˆìŒ
      const d = Math.hypot(p.x - pos.x, p.y - pos.y);
      
        if(d < threshold) {
        console.log('âœ… ì¼ë°˜ ëª¨ë“œ ì  ê°ì§€:', k.key, 'ì  ì¢Œí‘œ:', p, 'í„°ì¹˜ ì¢Œí‘œ:', pos, 'ê±°ë¦¬:', d.toFixed(2), 'threshold:', threshold, 'zoom:', currentZoom);
      }
      
      if(d < threshold && d < bestDistance) {
        bestPoint = k.key;
        bestDistance = d;
      }
    }
  }
  
  // ì  ê·¼ì²˜ë¥¼ í„°ì¹˜í–ˆì„ ë•Œë§Œ ë“œë˜ê·¸ ëª¨ë“œë¡œ ì „í™˜
  // bestPointê°€ ì„¤ì •ë˜ê³  threshold ë‚´ì— ìˆì„ ë•Œë§Œ ë“œë˜ê·¸ ì‹œì‘
  if(bestPoint && bestDistance < threshold) {
    // preventDefaultëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í•˜ì§€ ì•ŠìŒ
    isScrolling = false;
    dragKey = bestPoint; // í™•ì‹¤í•˜ê²Œ ì„¤ì •
    
    // ìŠ¤í¬ë¡¤ ì‹œì‘ ìœ„ì¹˜ ì €ì¥ (ë“œë˜ê·¸ ì¤‘ì—ë„ ì‚¬ìš©)
    if(e.touches && e.touches.length > 0) {
      scrollStartX = e.touches[0].clientX;
      scrollStartY = e.touches[0].clientY;
    } else {
      scrollStartX = e.clientX;
      scrollStartY = e.clientY;
    }
    
    console.log('âœ… ë“œë˜ê·¸ ì‹œì‘ ì„±ê³µ:', bestPoint, 'ê±°ë¦¬:', bestDistance.toFixed(2), 'threshold:', threshold, 'pos:', pos, 'dragKey:', dragKey, 'editMode:', editMode, 'zoom:', currentZoom);
    return true;
  } else {
    // ì  ê·¼ì²˜ë¥¼ ëˆ„ë¥´ì§€ ì•Šì•˜ìœ¼ë©´ ë“œë˜ê·¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ
    console.log('âŒ ì  ê·¼ì²˜ë¥¼ ëˆ„ë¥´ì§€ ì•ŠìŒ, bestPoint:', bestPoint, 'ê±°ë¦¬:', bestDistance < 1e9 ? bestDistance.toFixed(2) : 'N/A', 'threshold:', threshold, 'pos:', pos);
  }
  
  // ì ì´ ì•„ë‹Œ ë¹ˆ í™”ë©´ì„ í„°ì¹˜í–ˆìœ¼ë©´ ë“œë˜ê·¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ
  // í™•ëŒ€ ëª¨ë“œì—ì„œ í•œ ì†ê°€ë½ í„°ì¹˜ëŠ” ìŠ¤í¬ë¡¤ ë¶ˆê°€ (ë‘ ì†ê°€ë½ë§Œ ìŠ¤í¬ë¡¤)
  // ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•ŠìŒ
  isScrolling = false;
  dragKey = null; // ëª…ì‹œì ìœ¼ë¡œ nullë¡œ ì„¤ì •
  return false;
}

function doDrag(e) {
  // í„°ì¹˜ ì´ë²¤íŠ¸ì¸ ê²½ìš° ì†ê°€ë½ ê°œìˆ˜ í™•ì¸
  let touchCount = 0;
  if(e.touches) {
    touchCount = e.touches.length;
  }
  
  // ë‘ ì†ê°€ë½ í„°ì¹˜: ìŠ¤í¬ë¡¤ë§Œ í—ˆìš© (í™•ëŒ€ ëª¨ë“œì—ì„œë§Œ)
  if(touchCount === 2 && editMode && currentZoom > 1) {
    e.preventDefault();
    e.stopPropagation();
    
    // ìŠ¤í¬ë¡¤ ëª¨ë“œ í™œì„±í™” í™•ì¸
    if(!isScrolling) {
      // ìŠ¤í¬ë¡¤ ëª¨ë“œê°€ ì•„ë‹ˆë©´ ì´ˆê¸°í™”í•˜ê³  ì‹œì‘
      isScrolling = true;
      dragKey = null;
    }
    
    // ë‘ ì†ê°€ë½ì˜ ì¤‘ì‹¬ì  ê³„ì‚°
    const touch1 = e.touches[0];
    const touch2 = e.touches[1];
    const currentX = (touch1.clientX + touch2.clientX) / 2;
    const currentY = (touch1.clientY + touch2.clientY) / 2;
    
    // ìŠ¤í¬ë¡¤ ì‹œì‘ ìœ„ì¹˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì„¤ì •
    if(scrollStartX === 0 && scrollStartY === 0) {
      scrollStartX = currentX;
      scrollStartY = currentY;
      return;
    }
    
    // ìŠ¤í¬ë¡¤ë§Œ ìˆ˜í–‰
    const canvasWrap = cv.parentElement;
    const deltaX = scrollStartX - currentX;
    const deltaY = scrollStartY - currentY;
    canvasWrap.scrollLeft += deltaX;
    canvasWrap.scrollTop += deltaY;
    scrollStartX = currentX;
    scrollStartY = currentY;
    return;
  }
  
  // í•œ ì†ê°€ë½ë§Œ ë“œë˜ê·¸ í—ˆìš© (ë‘ ì†ê°€ë½ ì´ìƒì´ë©´ ë¬´ì‹œ)
  if(touchCount > 1 && !(editMode && currentZoom > 1 && touchCount === 2)) {
    return;
  }
  
  // dragKeyê°€ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ì²˜ë¦¬ ì•ˆ í•¨
  if(!dragKey) {
    return;
  }
  
  // ë“œë˜ê·¸ ëª¨ë“œê°€ ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë“œë˜ê·¸ ì²˜ë¦¬ë§Œ ìˆ˜í–‰ (ìŠ¤í¬ë¡¤ ì™„ì „ ì°¨ë‹¨)
  if(dragKey) {
    e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
    e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨
    
    const pos = getEventPos(e);
    // ì¢Œí‘œëŠ” í•­ìƒ ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì €ì¥
    const originalW = originalCanvasSize.width || (cv.width / DPR / (editMode ? currentZoom : 1));
    const originalH = originalCanvasSize.height || (cv.height / DPR / (editMode ? currentZoom : 1));
    const x = clamp(pos.x, 0, originalW);
    const y = clamp(pos.y, 0, originalH);
    const orientation = sessions[cur].poseData?.orientation || "side";
    const map = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
    const p = map.get(dragKey);
    
    if(!p) {
      // ì ì´ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ì¢…ë£Œ
      console.log('ì ì´ ì—†ì–´ ë“œë˜ê·¸ ì¢…ë£Œ:', dragKey);
      dragKey = null;
      isScrolling = false;
      return;
    }
    
    // ì¢Œí‘œ ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” ì„ íƒëœ ì ë§Œ ì´ë™ (ë‹¤ë¥¸ ì ì€ ì ˆëŒ€ ì´ë™ ë¶ˆê°€)
    if(editMode && selectedPoint) {
      if(dragKey !== selectedPoint) {
        // ì„ íƒëœ ì ì´ ì•„ë‹ˆë©´ ë“œë˜ê·¸ ë¬´ì‹œ
        console.log('âš ï¸ ì„ íƒëœ ì ì´ ì•„ë‹ˆë¯€ë¡œ ë“œë˜ê·¸ ë¬´ì‹œ:', 'dragKey:', dragKey, 'selectedPoint:', selectedPoint);
        dragKey = null; // ë“œë˜ê·¸ ì¢…ë£Œ
        return;
      }
    }
    
    // ì¢Œí‘œ ì—…ë°ì´íŠ¸ (ì¦‰ì‹œ ë°˜ì˜)
    p.x = x;
    p.y = y;
    
    // ì…ë ¥ í•„ë“œë„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ì›ë³¸ í¬ê¸° ê¸°ì¤€)
    if(coordX && coordY) {
      coordX.value = x.toFixed(1);
      coordY.value = y.toFixed(1);
    }
    
    // ì„ íƒëœ ì ê³¼ ì¼ì¹˜í•˜ë©´ ì¢Œí‘œ í‘œì‹œ ì—…ë°ì´íŠ¸
    if(selectedPoint === dragKey && typeof window.updateCoordDisplay === 'function') {
      window.updateCoordDisplay();
    }
    
    // ì¦‰ì‹œ í™”ë©´ ì—…ë°ì´íŠ¸ (ì ì„ ê³¼ ë„íŠ¸ê°€ í•­ìƒ ê·¸ë ¤ì§€ë„ë¡)
    try {
      draw();
    } catch(err) {
      console.error("draw() í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ (doDrag):", err);
      // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ë‹¤ì‹œ ì‹œë„
      setTimeout(() => {
        try {
          draw();
        } catch(retryErr) {
          console.error("draw() ì¬ì‹œë„ ì‹¤íŒ¨:", retryErr);
        }
      }, 10);
    }
    
    // ì‹¤ì‹œê°„ ë¶„ì„ ì—…ë°ì´íŠ¸ (throttle ì ìš©)
    if(!dragUpdateTimer) {
      dragUpdateTimer = requestAnimationFrame(() => {
        computeMetricsOnly(); // ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­ë§Œ ê³„ì‚° (ë¹ ë¥¸ ì—…ë°ì´íŠ¸)
        dragUpdateTimer = null;
      });
    }
    
    return; // ë“œë˜ê·¸ ëª¨ë“œì—ì„œëŠ” ìŠ¤í¬ë¡¤ ì™„ì „ ì°¨ë‹¨
  }
}

// ë“œë˜ê·¸ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸
let dragUpdateTimer = null;

function endDrag(e) {
  // Long press íƒ€ì´ë¨¸ ì •ë¦¬ (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ ì •ë¦¬ìš©)
  if(longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
  
  // ë“œë˜ê·¸ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì •ë¦¬
  if(dragUpdateTimer) {
    cancelAnimationFrame(dragUpdateTimer);
    dragUpdateTimer = null;
  }
  
  // ë“œë˜ê·¸ê°€ ëë‚˜ë©´ ìƒíƒœ ì™„ì „íˆ ì´ˆê¸°í™” (ë‹¤ìŒ ë“œë˜ê·¸ë¥¼ ìœ„í•´)
  const wasDragging = dragKey !== null;
  if(dragKey) {
    console.log('ë“œë˜ê·¸ ì¢…ë£Œ:', dragKey);
    // ìµœì¢… ë¶„ì„ ì‹¤í–‰ (ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
    computeMetricsOnly(); // ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­ ê³„ì‚°
  }
  
  // ëª¨ë“  ìƒíƒœ ì™„ì „íˆ ì´ˆê¸°í™” (ë§¤ë²ˆ í™•ì‹¤íˆ)
  dragKey = null;
  isScrolling = false;
  scrollDistance = 0;
  scrollStartX = 0;
  scrollStartY = 0;
  longPressDetected = false;
  longPressNearPoint = null;
  
  // ë§ˆìš°ìŠ¤ ìƒíƒœë„ ì´ˆê¸°í™”
  if(typeof isMouseDown !== 'undefined') {
    isMouseDown = false;
  }
  
  // ìƒíƒœ ì´ˆê¸°í™” í™•ì¸ ë¡œê·¸
  if(wasDragging) {
    console.log('ë“œë˜ê·¸ ìƒíƒœ ì´ˆê¸°í™” ì™„ë£Œ, ë‹¤ìŒ ë“œë˜ê·¸ ì¤€ë¹„ë¨');
  }
}

// ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
let isMouseDown = false;
cv.addEventListener('mousedown', (e) => {
  // âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œì¼ ë•ŒëŠ” dot ì„ íƒ ë¶ˆê°€
  if(calibrationMode) {
    return; // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ í´ë¦­ í•¸ë“¤ëŸ¬ê°€ ì²˜ë¦¬í•˜ë„ë¡ í•¨
  }
  
  isMouseDown = true;
  
  // ìë™ ì¶”ì  ëª¨ë“œ í† ê¸€ ì²´í¬ (dotë¥¼ í´ë¦­í•˜ë©´ í† ê¸€) - startDrag ì „ì— ì²´í¬
  // âœ… í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” ìë™ ì¶”ì  ëª¨ë“œ ë¹„í™œì„±í™” (ì„ íƒëœ ì ë§Œ ë“œë˜ê·¸ ê°€ëŠ¥)
  if(editMode && currentZoom > 1) {
    // í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” ìë™ ì¶”ì  ëª¨ë“œ ì‚¬ìš© ì•ˆ í•¨ (ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒí•œ ì ë§Œ ì‚¬ìš©)
    // startDragë¡œ ë„˜ì–´ê°€ì„œ ì„ íƒëœ ì ë§Œ ì²´í¬í•˜ë„ë¡ í•¨
  } else {
  const pos = getEventPos(e);
  const P = getPts(cur);
  const currentKeypoints = getKeypoints();
  let clickedPoint = null;
  let minDistance = 1e9;
  const threshold = 50; // í´ë¦­ ê°ì§€ ë²”ìœ„
  
  for(const k of currentKeypoints) {
    const p = P[k.key];
    if(!p) continue;
    const d = Math.hypot(p.x - pos.x, p.y - pos.y);
    if(d < threshold && d < minDistance) {
      clickedPoint = k.key;
      minDistance = d;
    }
  }
  
  // dotë¥¼ í´ë¦­í–ˆì„ ë•Œ ìë™ ì¶”ì  ëª¨ë“œ í† ê¸€
  if(clickedPoint) {
    if(autoFollowKey === clickedPoint) {
      // ì´ë¯¸ ìë™ ì¶”ì  ì¤‘ì´ë©´ í•´ì œ
      autoFollowKey = null;
      dragKey = null;
      console.log('ğŸ›‘ ìë™ ì¶”ì  ëª¨ë“œ í•´ì œ:', clickedPoint);
      isMouseDown = false;
      e.preventDefault();
      return;
    } else {
      // ìë™ ì¶”ì  ëª¨ë“œ í™œì„±í™”
      autoFollowKey = clickedPoint;
      dragKey = null; // ë“œë˜ê·¸ ëª¨ë“œëŠ” í•´ì œ
      console.log('â–¶ï¸ ìë™ ì¶”ì  ëª¨ë“œ í™œì„±í™”:', clickedPoint);
      isMouseDown = false;
      e.preventDefault();
      return;
        }
    }
  }
  
  // ìë™ ì¶”ì  ëª¨ë“œê°€ ì•„ë‹ˆë©´ ì¼ë°˜ ë“œë˜ê·¸ ì²˜ë¦¬
  const dragStarted = startDrag(e);
  
  // ì ì„ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ isMouseDownì„ falseë¡œ ì„¤ì • (ë“œë˜ê·¸ê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ)
  if(!dragStarted) {
    isMouseDown = false;
  } else {
    // ë“œë˜ê·¸ê°€ ì‹œì‘ë˜ë©´ ìë™ ì¶”ì  ëª¨ë“œ í•´ì œ
    if(autoFollowKey) {
      autoFollowKey = null;
    }
  }
});

window.addEventListener('mouseup', () => {
  isMouseDown = false;
  endDrag();
});

window.addEventListener('mouseleave', () => {
  isMouseDown = false;
  endDrag();
});

window.addEventListener('mousemove', (e) => {
  // ìë™ ì¶”ì  ëª¨ë“œ: dragKey ì—†ì´ë„ ë§ˆìš°ìŠ¤ë¥¼ ë”°ë¼ì˜´
  if(autoFollowKey) {
    const pos = getEventPos(e);
    const originalW = originalCanvasSize.width || (cv.width / DPR / (editMode ? currentZoom : 1));
    const originalH = originalCanvasSize.height || (cv.height / DPR / (editMode ? currentZoom : 1));
    const x = clamp(pos.x, 0, originalW);
    const y = clamp(pos.y, 0, originalH);
    const orientation = sessions[cur].poseData?.orientation || "side";
    const map = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
    const p = map.get(autoFollowKey);
    
    if(p) {
      p.x = x;
      p.y = y;
      
      // ì…ë ¥ í•„ë“œë„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
      if(coordX && coordY && selectedPoint === autoFollowKey) {
        coordX.value = x.toFixed(1);
        coordY.value = y.toFixed(1);
      }
      
      // ì¦‰ì‹œ í™”ë©´ ì—…ë°ì´íŠ¸ (ì ì„ ê³¼ ë„íŠ¸ê°€ í•­ìƒ ê·¸ë ¤ì§€ë„ë¡)
      try {
        draw();
      } catch(err) {
        console.error("draw() í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ (autoFollow):", err);
        // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ë‹¤ì‹œ ì‹œë„
        setTimeout(() => {
          try {
            draw();
          } catch(retryErr) {
            console.error("draw() ì¬ì‹œë„ ì‹¤íŒ¨:", retryErr);
          }
        }, 10);
      }
      
      // ì‹¤ì‹œê°„ ë¶„ì„ ì—…ë°ì´íŠ¸ (throttle ì ìš©)
      if(!dragUpdateTimer) {
        dragUpdateTimer = requestAnimationFrame(() => {
          computeMetricsOnly();
          dragUpdateTimer = null;
        });
      }
    }
  }
  
  // dragKeyê°€ ì„¤ì •ë˜ì–´ ìˆì„ ë•Œë§Œ ë“œë˜ê·¸ ì²˜ë¦¬ (ì ì„ í´ë¦­í–ˆì„ ë•Œë§Œ)
  if(dragKey) {
    doDrag(e);
  }
});

// í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ ì§€ì›)
cv.addEventListener('touchstart', (e) => {
  // âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œì¼ ë•ŒëŠ” dot ì„ íƒ ë¶ˆê°€
  if(calibrationMode) {
    return; // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ í´ë¦­ í•¸ë“¤ëŸ¬ê°€ ì²˜ë¦¬í•˜ë„ë¡ í•¨
  }
  
  const touchCount = e.touches ? e.touches.length : 0;
  
  // ì´ì „ ìƒíƒœê°€ ë‚¨ì•„ìˆìœ¼ë©´ ì™„ì „íˆ ì´ˆê¸°í™” (ë“œë˜ê·¸ë“  ìŠ¤í¬ë¡¤ì´ë“ )
  // ìŠ¤í¬ë¡¤ í›„ ìƒˆë¡œìš´ ë“œë˜ê·¸ë¥¼ ìœ„í•´ ì™„ì „íˆ ì´ˆê¸°í™”
  if(dragKey || isScrolling) {
    console.log('âš ï¸ ì´ì „ ìƒíƒœê°€ ë‚¨ì•„ìˆìŒ, ì™„ì „íˆ ì •ë¦¬ - dragKey:', dragKey, 'isScrolling:', isScrolling);
    dragKey = null;
    isScrolling = false;
    scrollStartX = 0;
    scrollStartY = 0;
    scrollDistance = 0;
    // endDragë„ í˜¸ì¶œí•˜ì—¬ ì™„ì „íˆ ì •ë¦¬
    endDrag(e);
  }
  
  // ë‘ ì†ê°€ë½ ìŠ¤í¬ë¡¤ì¸ ê²½ìš° ìŠ¤í¬ë¡¤ ì‹œì‘ ìœ„ì¹˜ ì„¤ì •
  if(touchCount === 2 && editMode && currentZoom > 1) {
    const touch1 = e.touches[0];
    const touch2 = e.touches[1];
    scrollStartX = (touch1.clientX + touch2.clientX) / 2;
    scrollStartY = (touch1.clientY + touch2.clientY) / 2;
    isScrolling = true;
    dragKey = null;
    console.log('ë‘ ì†ê°€ë½ ìŠ¤í¬ë¡¤ ì‹œì‘, scrollStartX:', scrollStartX, 'scrollStartY:', scrollStartY);
    e.preventDefault();
    e.stopPropagation();
    return;
  }
  
  // í•œ ì†ê°€ë½ í„°ì¹˜ì¸ ê²½ìš°ì—ë§Œ ì  ì°¾ê¸° ì‹œë„
  if(touchCount === 1) {
    // ìƒˆë¡œìš´ í„°ì¹˜ ì‹œì‘ (ì´ì „ ìƒíƒœëŠ” ì´ë¯¸ ì´ˆê¸°í™”ë¨)
    const result = startDrag(e);
    
    // ì ì„ í„°ì¹˜í–ˆìœ¼ë©´ preventDefault
    if(result === true) {
      e.preventDefault();
      e.stopPropagation();
      console.log('í•œ ì†ê°€ë½ í„°ì¹˜ - ì  ê°ì§€ ì„±ê³µ, dragKey:', dragKey);
    } else {
      console.log('í•œ ì†ê°€ë½ í„°ì¹˜ - ì  ê°ì§€ ì‹¤íŒ¨');
    }
  }
}, {passive: false});

window.addEventListener('touchmove', (e) => {
  const touchCount = e.touches ? e.touches.length : 0;
  
  // ë‘ ì†ê°€ë½ í„°ì¹˜ì¸ ê²½ìš° ìŠ¤í¬ë¡¤ ëª¨ë“œ
  if(touchCount === 2 && editMode && currentZoom > 1) {
    e.preventDefault();
    e.stopPropagation();
    isScrolling = true;
    dragKey = null; // ìŠ¤í¬ë¡¤ ëª¨ë“œì—ì„œëŠ” ë“œë˜ê·¸ í‚¤ ì œê±°
    doDrag(e);
    return;
  }
  
  // ë‘ ì†ê°€ë½ì—ì„œ í•œ ì†ê°€ë½ìœ¼ë¡œ ë³€ê²½ëœ ê²½ìš° (ìŠ¤í¬ë¡¤ ì¢…ë£Œ)
  if(touchCount === 1 && isScrolling && editMode && currentZoom > 1) {
    // ìŠ¤í¬ë¡¤ ëª¨ë“œ ì¢…ë£Œí•˜ê³  ìƒíƒœ ì´ˆê¸°í™”
    console.log('ìŠ¤í¬ë¡¤ ëª¨ë“œ ì¢…ë£Œ (ë‘ ì†ê°€ë½ â†’ í•œ ì†ê°€ë½)');
    isScrolling = false;
    dragKey = null;
    scrollStartX = 0;
    scrollStartY = 0;
    // ë“œë˜ê·¸ ì²˜ë¦¬ ì•ˆ í•¨ (ìƒˆë¡œìš´ í„°ì¹˜ê°€ í•„ìš”)
    return;
  }
  
  // í•œ ì†ê°€ë½ í„°ì¹˜ì¸ ê²½ìš°
  if(touchCount === 1) {
    // dragKeyê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ë“œë˜ê·¸ ëª¨ë“œ (ì  ê·¼ì²˜ë¥¼ ëˆŒë €ì„ ë•Œë§Œ)
    if(dragKey) {
      e.preventDefault();
      e.stopPropagation();
      isScrolling = false; // ë“œë˜ê·¸ ì¤‘ì—ëŠ” ìŠ¤í¬ë¡¤ ì•„ë‹˜
      doDrag(e);
      return;
    }
    
    // dragKeyê°€ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ì²˜ë¦¬ ì•ˆ í•¨ (ì  ê·¼ì²˜ë¥¼ ëˆ„ë¥´ì§€ ì•Šì•˜ìŒ)
    // í™•ëŒ€ ëª¨ë“œì—ì„œë„ ë¹ˆ í™”ë©´ì„ ëˆ„ë¥´ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
    return;
  }
  
  // í„°ì¹˜ê°€ ì—†ê±°ë‚˜ 3ê°œ ì´ìƒì¸ ê²½ìš° ìƒíƒœ ì´ˆê¸°í™”
  if(touchCount === 0 || touchCount > 2) {
    isScrolling = false;
    dragKey = null;
  }
  
  // ê¸°ë³¸ ë™ì‘ì€ í—ˆìš© (ì ì´ ì•„ë‹Œ ê³³ì„ í„°ì¹˜í•œ ê²½ìš°)
}, {passive: false});

window.addEventListener('touchend', (e) => {
  // changedTouchesë¥¼ í™•ì¸í•˜ì—¬ ëë‚œ í„°ì¹˜ê°€ ìˆëŠ”ì§€ ì²´í¬
  const remainingTouches = e.touches ? e.touches.length : 0;
  const endedTouches = e.changedTouches ? e.changedTouches.length : 0;
  
  // ëª¨ë“  í„°ì¹˜ê°€ ëë‚¬ëŠ”ì§€ í™•ì¸
  if(remainingTouches === 0) {
    // ëª¨ë“  í„°ì¹˜ê°€ ëë‚¬ìœ¼ë©´ ë“œë˜ê·¸/ìŠ¤í¬ë¡¤ ì™„ì „íˆ ì¢…ë£Œ
    console.log('ëª¨ë“  í„°ì¹˜ ì¢…ë£Œ, ìƒíƒœ ì™„ì „ ì´ˆê¸°í™”');
    endDrag(e);
    // ì¶”ê°€ë¡œ í™•ì‹¤í•˜ê²Œ ì´ˆê¸°í™”
    dragKey = null;
    isScrolling = false;
    scrollStartX = 0;
    scrollStartY = 0;
    scrollDistance = 0;
  } else if(endedTouches > 0) {
    // ì¼ë¶€ í„°ì¹˜ë§Œ ëë‚¬ëŠ” ê²½ìš°
    // ë‘ ì†ê°€ë½ ìŠ¤í¬ë¡¤ ì¤‘ í•˜ë‚˜ê°€ ë–¨ì–´ì¡Œìœ¼ë©´ ìŠ¤í¬ë¡¤ ëª¨ë“œ ì¢…ë£Œ
    if(isScrolling && remainingTouches === 1) {
      console.log('ìŠ¤í¬ë¡¤ ëª¨ë“œ ì¢…ë£Œ (í•œ ì†ê°€ë½ ë‚¨ìŒ), ìƒíƒœ ì´ˆê¸°í™”');
      isScrolling = false;
      dragKey = null;
      scrollStartX = 0;
      scrollStartY = 0;
      scrollDistance = 0;
      // ë‹¤ìŒ ë“œë˜ê·¸ë¥¼ ìœ„í•´ ì™„ì „íˆ ì´ˆê¸°í™”
    } else if(remainingTouches === 1 && dragKey) {
      // ë“œë˜ê·¸ ì¤‘ì´ì—ˆëŠ”ë° í•œ ì†ê°€ë½ì´ ë‚¨ì•„ìˆìœ¼ë©´ ë“œë˜ê·¸ ê³„ì†
      // endDrag í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
    } else {
      // ê·¸ ì™¸ì˜ ê²½ìš°ëŠ” ìƒíƒœ ì´ˆê¸°í™”
      endDrag(e);
    }
  }
});
window.addEventListener('touchcancel', (e) => {
  // í„°ì¹˜ê°€ ì·¨ì†Œë˜ë©´ ë¬´ì¡°ê±´ ë“œë˜ê·¸/ìŠ¤í¬ë¡¤ ì¢…ë£Œ
  console.log('í„°ì¹˜ ì·¨ì†Œ, ìƒíƒœ ì´ˆê¸°í™”');
  endDrag(e);
});

// íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ (ê³µí†µ í•¨ìˆ˜) - ì „ì—­ìœ¼ë¡œ ë“±ë¡
window.handleFileUpload = function handleFileUpload(e) {
  const f = e.target.files[0];
  if(!f) return;
  const targetSessionName = cur;
  const targetSession = sessions[targetSessionName];
  if(!targetSession) {
    console.warn("ì„¸ì…˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // í˜„ì¬ ì„ íƒëœ ë²„íŠ¼(ì •ë©´/ì˜†ëª¨ìŠµ) í™•ì¸ - ì‚¬ìš©ìê°€ ì„ íƒí•œ orientation ìš°ì„  ì‚¬ìš©
  const btnSide = document.getElementById("btnOrientationSide");
  const btnFront = document.getElementById("btnOrientationFront");
  const currentButtonOrientation = btnFront?.classList.contains("active") ? "front" 
    : (btnSide?.classList.contains("active") ? "side" : null);
  
  // í˜„ì¬ ì„ íƒëœ ë²„íŠ¼ì˜ orientationì„ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì„¸ì…˜ì˜ orientation, ê·¸ê²ƒë„ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ "side"
  const guessedOrientation = currentButtonOrientation || targetSession.poseData?.orientation || "side";
  if(!targetSession.poseData) {
    targetSession.poseData = { orientation: guessedOrientation, landmarks: null, orientationMode: currentButtonOrientation ? "manual" : "auto" };
  } else if(!targetSession.poseData.orientationMode) {
    targetSession.poseData.orientationMode = currentButtonOrientation ? "manual" : "auto";
  }
  let imgKey = guessedOrientation === "front" ? "imgFront" : "imgSide";
  
  console.log("íŒŒì¼ ì—…ë¡œë“œ - í˜„ì¬ ì„ íƒëœ orientation:", guessedOrientation, "(ë²„íŠ¼:", currentButtonOrientation, ", ì„¸ì…˜:", targetSession.poseData?.orientation, ")");
  
  const img = new Image();
  img.onerror = (e) => {
    console.error("ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:", e);
    alert("ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
  };
  
  img.onload = async () => {
    console.log("ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ:", imgKey, "naturalWidth:", img.naturalWidth, "naturalHeight:", img.naturalHeight);
    
    // ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë©”ëª¨ë¦¬ ì •ë¦¬ (orientationë³„ë¡œ)
    const existingImg = targetSession[imgKey];
    if(existingImg && existingImg.src && existingImg.src.startsWith('blob:')) {
      URL.revokeObjectURL(existingImg.src);
    }
    
    // ìƒˆ ì´ë¯¸ì§€ë¡œ êµì²´ (orientationë³„ë¡œ ì €ì¥)
    targetSession[imgKey] = img;
    
    // ì›ë³¸ í¬ê¸° ì´ˆê¸°í™” (ìƒˆ ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ë¯€ë¡œ ë‹¤ì‹œ ê³„ì‚°)
    originalCanvasSize.width = 0;
    originalCanvasSize.height = 0;
    originalCanvasSize.styleWidth = 0;
    originalCanvasSize.styleHeight = 0;
    
    // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
    resizeCanvasFor(img);
    
    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ìº”ë²„ìŠ¤ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°)
    setTimeout(() => {
      try {
        draw();
        computeMetricsOnly(); // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì—ëŠ” AI ë¶„ì„ ì•ˆ í•¨
        console.log("ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° ì™„ë£Œ");
      } catch(err) {
        console.error("ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° ì‹¤íŒ¨:", err);
        // ì¬ì‹œë„
        setTimeout(() => {
          try {
            draw();
            computeMetricsOnly();
          } catch(err2) {
            console.error("ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° ì¬ì‹œë„ ì‹¤íŒ¨:", err2);
          }
        }, 200);
      }
    }, 100);
    
    // í¬ì¦ˆ ê°ì§€ ìë™ ì‹¤í–‰ (ì‚¬ìš©ìê°€ ì„ íƒí•œ orientation ìš°ì„  ì‚¬ìš©)
    const prevOrientation = targetSession.poseData?.orientation || guessedOrientation;
    let detectedOrientation = null;
    
    // ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ë²„íŠ¼ì„ ì„ íƒí•œ ê²½ìš°, ê·¸ orientationì„ ìš°ì„  ì‚¬ìš©
    const userSelectedOrientation = currentButtonOrientation;
    
    if(typeof applyPoseDetection === 'function') {
      try {
        // ì‚¬ìš©ìê°€ ì„ íƒí•œ orientationì„ ì„¸ì…˜ì— ë¨¼ì € ì„¤ì • (AI ê°ì§€ ì „ì—)
        if(userSelectedOrientation && !targetSession.poseData) {
          targetSession.poseData = { orientation: userSelectedOrientation, landmarks: null, orientationMode: "manual" };
        } else if(userSelectedOrientation && targetSession.poseData) {
          targetSession.poseData.orientation = userSelectedOrientation;
          targetSession.poseData.orientationMode = "manual";
        }
        
        const detectionResult = await applyPoseDetection(img, targetSessionName);
        detectedOrientation = detectionResult?.orientation || null;
      } catch(err) {
        console.error("í¬ì¦ˆ ê°ì§€ ì‹¤íŒ¨:", err);
      }
    }

    // ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ì„ íƒí•œ orientationì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„  ì‚¬ìš©
    const finalOrientation = userSelectedOrientation || detectedOrientation || guessedOrientation;
    
    if(finalOrientation) {
      const desiredKey = finalOrientation === "front" ? "imgFront" : "imgSide";
      if(desiredKey !== imgKey) {
        const prevImg = targetSession[desiredKey];
        if(prevImg && prevImg !== img && prevImg.src && prevImg.src.startsWith('blob:')) {
          URL.revokeObjectURL(prevImg.src);
        }
        targetSession[desiredKey] = img;
        if(targetSession[imgKey] === img) {
          targetSession[imgKey] = null;
        }
        imgKey = desiredKey;
      }
      
      if(!targetSession.poseData) {
        targetSession.poseData = { orientation: finalOrientation, landmarks: null, orientationMode: userSelectedOrientation ? "manual" : "auto" };
      }
      targetSession.poseData.orientation = finalOrientation;
      targetSession.poseData.orientationMode = userSelectedOrientation ? "manual" : "auto";
      
      if(targetSessionName === cur) {
        if(prevOrientation !== finalOrientation) {
          setOrientation(finalOrientation);
        } else {
          draw();
        }
        try {
          computeAll();
        } catch(errCompute) {
          console.warn("computeAll ì‹¤í–‰ ì‹¤íŒ¨, ê¸°ë³¸ ì§€í‘œë§Œ ê°±ì‹ :", errCompute);
          computeMetricsOnly();
        }
      }
    }
  };
  
  img.crossOrigin = "anonymous";
  const blobUrl = URL.createObjectURL(f);
  img.src = blobUrl;
  
  // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
  e.target.value = '';
}

// ì—…ë¡œë“œ (Before/After ê°ê° í•˜ë‚˜ì˜ ì‚¬ì§„ë§Œ ìœ ì§€) - DOM ì¤€ë¹„ í›„ ì‹¤í–‰
function setupFileUploads() {
  ["filePicker","cameraPicker"].forEach(id => {
    const input = document.getElementById(id);
    if(!input) {
      console.warn(`íŒŒì¼ ì…ë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${id}`);
      return;
    }
    
    // ëª¨ë°”ì¼ì—ì„œ label í´ë¦­ ì‹œ input í´ë¦­ íŠ¸ë¦¬ê±°
    const label = input.closest('label.btn');
    if(label) {
      // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±°ë¥¼ ìœ„í•´ ìƒˆë¡œ ìƒì„±
      const newLabel = label.cloneNode(true);
      label.parentNode.replaceChild(newLabel, label);
      const newInput = newLabel.querySelector('input');
      
      if(!newInput) {
        console.warn(`input ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${id}`);
        return;
      }
      
      // inputì— ì§ì ‘ change ì´ë²¤íŠ¸ ì²˜ë¦¬
      newInput.addEventListener("change", handleFileUpload);
      
      // inputì— ì§ì ‘ í„°ì¹˜/í´ë¦­ ì´ë²¤íŠ¸ëŠ” ê¸°ë³¸ ë™ì‘ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ì¶”ê°€ ì²˜ë¦¬ ë¶ˆí•„ìš”
      // (inputì´ ì§ì ‘ í´ë¦­/í„°ì¹˜ë˜ë©´ ìë™ìœ¼ë¡œ íŒŒì¼ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ì—´ë¦¼)
      
      // ëª¨ë°”ì¼ì—ì„œ ë” í™•ì‹¤í•˜ê²Œ ì‘ë™í•˜ë„ë¡ ì—¬ëŸ¬ ì´ë²¤íŠ¸ ì²˜ë¦¬
      let touchStarted = false;
      let touchMoved = false;
      
      // touchstart: í„°ì¹˜ ì‹œì‘
      newLabel.addEventListener('touchstart', (e) => {
        // inputì´ ì§ì ‘ í„°ì¹˜ëœ ê²½ìš°ëŠ” ì œì™¸
        if(e.target === newInput || e.target.closest('input') === newInput) {
          return;
        }
        console.log('Label í„°ì¹˜ ì‹œì‘:', id);
        touchStarted = true;
        touchMoved = false;
      }, { passive: true });
      
      // touchmove: í„°ì¹˜ ì´ë™ ê°ì§€
      newLabel.addEventListener('touchmove', (e) => {
        if(touchStarted) {
          touchMoved = true;
        }
      }, { passive: true });
      
      // touchend: í„°ì¹˜ ì¢…ë£Œ ì‹œ input í´ë¦­
      newLabel.addEventListener('touchend', (e) => {
        // inputì´ ì§ì ‘ í„°ì¹˜ëœ ê²½ìš°ëŠ” ì œì™¸
        if(e.target === newInput || e.target.closest('input') === newInput) {
          return;
        }
        
        // í„°ì¹˜ê°€ ì´ë™í–ˆìœ¼ë©´ í´ë¦­ìœ¼ë¡œ ê°„ì£¼í•˜ì§€ ì•ŠìŒ
        if(touchMoved) {
          touchStarted = false;
          touchMoved = false;
          return;
        }
        
        if(touchStarted) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          
          console.log('Label í„°ì¹˜ ì¢…ë£Œ, input í´ë¦­ ì‹œë„:', id);
          
          // ì¦‰ì‹œ input í´ë¦­ (ëª¨ë°”ì¼ì—ì„œ ë” í™•ì‹¤í•˜ê²Œ ì‘ë™)
          // requestAnimationFrameì„ ì‚¬ìš©í•˜ì—¬ ë¸Œë¼ìš°ì € ë Œë”ë§ ì‚¬ì´í´ì— ë§ì¶¤
          requestAnimationFrame(() => {
            try {
              // inputì„ í¬ì»¤ìŠ¤í•˜ê³  í´ë¦­
              newInput.focus();
              // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  í´ë¦­ (ëª¨ë°”ì¼ì—ì„œ ë” í™•ì‹¤í•˜ê²Œ ì‘ë™)
              setTimeout(() => {
                try {
                  newInput.click();
                  console.log('Input í´ë¦­ ì„±ê³µ:', id);
                } catch(err) {
                  console.error('Input click failed:', err);
                  // í´ë°±: ì§ì ‘ íŒŒì¼ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸° ì‹œë„
                  try {
                    const event = new MouseEvent('click', {
                      bubbles: true,
                      cancelable: true,
                      view: window
                    });
                    newInput.dispatchEvent(event);
                  } catch(err2) {
                    console.error('Input dispatchEvent failed:', err2);
                  }
                }
              }, 50);
            } catch(err) {
              console.error('Input focus failed:', err);
            }
          });
          
          touchStarted = false;
          touchMoved = false;
        }
      }, { passive: false });
      
      // click ì´ë²¤íŠ¸ ì²˜ë¦¬ (ë°ìŠ¤í¬í†± ë° ì¼ë¶€ ëª¨ë°”ì¼)
      // ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” labelì˜ ê¸°ë³¸ ë™ì‘ì„ ì‹ ë¢°í•˜ê³ , ëª¨ë°”ì¼ì—ì„œë§Œ ì¶”ê°€ ì²˜ë¦¬
      const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      newLabel.addEventListener('click', (e) => {
        // inputì´ ì§ì ‘ í´ë¦­ëœ ê²½ìš°ëŠ” ì œì™¸ (ê¸°ë³¸ ë™ì‘ ì‚¬ìš©)
        if(e.target === newInput || e.target.closest('input') === newInput) {
          return;
        }
        
        // ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ ì´ë²¤íŠ¸ë¡œ ì´ë¯¸ ì²˜ë¦¬ëœ ê²½ìš°ëŠ” ì œì™¸
        if(isMobile && touchStarted) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        // ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” labelì˜ ê¸°ë³¸ ë™ì‘ì„ ì‹ ë¢° (for ì†ì„±ìœ¼ë¡œ ìë™ ì—°ê²°ë¨)
        // ëª¨ë°”ì¼ì—ì„œë§Œ í”„ë¡œê·¸ë˜ë° ë°©ì‹ìœ¼ë¡œ í´ë¦­
        if(isMobile) {
          e.preventDefault();
          e.stopPropagation();
          
          // requestAnimationFrameì„ ì‚¬ìš©í•˜ì—¬ ë¸Œë¼ìš°ì € ë Œë”ë§ ì‚¬ì´í´ì— ë§ì¶¤
          requestAnimationFrame(() => {
            try {
              newInput.focus();
              newInput.click();
              console.log('Input í´ë¦­ ì„±ê³µ (ëª¨ë°”ì¼):', id);
            } catch(err) {
              console.error('Input click failed:', err);
            }
          });
        }
        // ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ê¸°ë³¸ ë™ì‘ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš© (labelì˜ for ì†ì„±ì´ ìë™ìœ¼ë¡œ inputì„ í´ë¦­í•¨)
      }, { passive: false });
      
      // mousedownì€ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ (ë°ìŠ¤í¬íƒ‘ì—ì„œ ê¸°ë³¸ ë™ì‘ ì‚¬ìš©)
    } else {
      // labelì´ ì—†ëŠ” ê²½ìš° (í•˜ìœ„ í˜¸í™˜ì„±)
      const newInput = input.cloneNode(true);
      input.parentNode.replaceChild(newInput, input);
      newInput.addEventListener("change", handleFileUpload);
    }
  });
}

// DOM ì¤€ë¹„ í›„ íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
if(document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupFileUploads);
} else {
  setupFileUploads();
}

// Reset ë²„íŠ¼ (ì•ˆì „í•œ ì´ˆê¸°í™”)
function setupResetButton() {
  const btnReset = document.getElementById("btnReset");
  if(!btnReset) {
    console.warn("Reset ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  addMobileTouchSupport(btnReset, () => {
    const orientation = sessions[cur].poseData?.orientation || "side";
    const currentPoints = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
    currentPoints.clear();
    draw();
    computeMetricsOnly(); // ë¦¬ì…‹ ì‹œì—ëŠ” AI ë¶„ì„ ì•ˆ í•¨
  });
}

// DOM ì¤€ë¹„ í›„ Reset ë²„íŠ¼ ì„¤ì •
if(document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupResetButton);
} else {
  setupResetButton();
}

// âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê¸°ëŠ¥
let calibrationMode = false;
let calibrationButtonHandler = null;
let calibrationConfirmHandler = null; // âœ… ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸
let calibrationCancelHandler = null; // âœ… ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸

function setupCalibrateButton() {
  const btnCalibrate = document.getElementById("btnCalibrate");
  if(!btnCalibrate) {
    console.warn("ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // âœ… ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
  if(calibrationButtonHandler) {
    btnCalibrate.removeEventListener('click', calibrationButtonHandler);
    btnCalibrate.removeEventListener('touchend', calibrationButtonHandler);
  }
  
  // âœ… ìƒˆ í•¸ë“¤ëŸ¬ ìƒì„±
  calibrationButtonHandler = () => {
    calibrationMode = !calibrationMode;
    const panel = document.getElementById("calibrationPanel");
    if(!panel) {
      console.error("calibrationPanelì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    const S = sessions[cur];
    if(!S) {
      console.error("í˜„ì¬ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    if(calibrationMode) {
      panel.style.display = "block";
      // ì„¸ì…˜ì— ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì  ì €ì¥
      S.calibrationPoint1 = null;
      S.calibrationPoint2 = null;
      const calPoint1 = document.getElementById("calPoint1");
      const calPoint2 = document.getElementById("calPoint2");
      const calibrationResult = document.getElementById("calibrationResult");
      if(calPoint1) calPoint1.textContent = "í´ë¦­í•˜ì—¬ ì„ íƒ";
      if(calPoint2) calPoint2.textContent = "í´ë¦­í•˜ì—¬ ì„ íƒ";
      if(calibrationResult) calibrationResult.textContent = "";
      // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œì—ì„œëŠ” í´ë¦­ ì´ë²¤íŠ¸ë¡œ ì  ì„ íƒ
      if(cv) cv.style.cursor = "crosshair";
      // âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œ í™œì„±í™” ì‹œ í™•ëŒ€ ë°°ìœ¨ ì´ˆê¸°í™” ë° ì ìš©
      const calibrationZoomEl = document.getElementById("calibrationZoomLevel");
      if(calibrationZoomEl) {
        calibrationZoomEl.value = "1";
        currentZoom = 1;
      }
      draw(); // ì´ˆê¸°í™”
      console.log("âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œ í™œì„±í™”");
    } else {
      panel.style.display = "none";
      if(cv) cv.style.cursor = "default";
      calibrationMode = false;
      // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì  ì´ˆê¸°í™”
      S.calibrationPoint1 = null;
      S.calibrationPoint2 = null;
      // âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œ ë¹„í™œì„±í™” ì‹œ í™•ëŒ€ ë°°ìœ¨ ì´ˆê¸°í™”
      currentZoom = 1;
      draw();
      console.log("âŒ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ëª¨ë“œ ë¹„í™œì„±í™”");
    }
  };
  
  // âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  addMobileTouchSupport(btnCalibrate, calibrationButtonHandler);
  console.log("âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë²„íŠ¼ ì´ˆê¸°í™” ì™„ë£Œ");
}

// âœ… initializeAppì—ì„œë§Œ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½ (ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)

// âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ í´ë¦­ í•¸ë“¤ëŸ¬ (ë‹¤ë¥¸ ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€)
let calibrationClickHandler = null;

function setupCalibrationClickHandler() {
  if(!cv) {
    console.warn("ìº”ë²„ìŠ¤(cv)ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // âœ… ê¸°ì¡´ í•¸ë“¤ëŸ¬ ì œê±° (ì¤‘ë³µ ë°©ì§€)
  if(calibrationClickHandler) {
    cv.removeEventListener('click', calibrationClickHandler, true);
  }
  
  // âœ… ìƒˆ í•¸ë“¤ëŸ¬ ìƒì„±
  calibrationClickHandler = (e) => {
  if(!calibrationMode) return;
  
  // ë‹¤ë¥¸ ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€
  e.preventDefault();
  e.stopPropagation();
  e.stopImmediatePropagation();
  
  const pos = getEventPos(e);
  const S = sessions[cur];
    
    if(!S) {
      console.error("í˜„ì¬ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
  
  if(!S.calibrationPoint1) {
    // ì  1 ì €ì¥
    S.calibrationPoint1 = pos;
      const calPoint1 = document.getElementById("calPoint1");
      if(calPoint1) calPoint1.textContent = `(${pos.x.toFixed(1)}, ${pos.y.toFixed(1)})`;
    draw(); // ì ì´ ì˜êµ¬ì ìœ¼ë¡œ í‘œì‹œë¨
      console.log('âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì  1:', pos);
  } else if(!S.calibrationPoint2) {
    // ì  2 ì €ì¥
    S.calibrationPoint2 = pos;
      const calPoint2 = document.getElementById("calPoint2");
      if(calPoint2) calPoint2.textContent = `(${pos.x.toFixed(1)}, ${pos.y.toFixed(1)})`;
    draw(); // ì ê³¼ ì„ ì´ ì˜êµ¬ì ìœ¼ë¡œ í‘œì‹œë¨
      console.log('âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì  2:', pos);
    
    // ë‘ ì  ì‚¬ì´ ê±°ë¦¬ ê³„ì‚°í•´ì„œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    if(S.calibrationPoint1 && S.calibrationPoint2) {
      const distPx = dist(S.calibrationPoint1, S.calibrationPoint2);
        const calibrationResult = document.getElementById("calibrationResult");
        if(calibrationResult) {
          calibrationResult.textContent = 
        `ê±°ë¦¬: ${distPx.toFixed(1)}px (ì‹¤ì œ ê¸¸ì´ ì…ë ¥ í›„ ê³„ì‚° ë²„íŠ¼ í´ë¦­)`;
          calibrationResult.style.color = "var(--muted)";
        }
    }
  } else {
    // ë‘ ì  ëª¨ë‘ ì„ íƒë˜ì—ˆìœ¼ë©´ ë‹¤ì‹œ ì‹œì‘
    S.calibrationPoint1 = pos;
    S.calibrationPoint2 = null;
      const calPoint1 = document.getElementById("calPoint1");
      const calPoint2 = document.getElementById("calPoint2");
      const calibrationResult = document.getElementById("calibrationResult");
      if(calPoint1) calPoint1.textContent = `(${pos.x.toFixed(1)}, ${pos.y.toFixed(1)})`;
      if(calPoint2) calPoint2.textContent = "í´ë¦­í•˜ì—¬ ì„ íƒ";
      if(calibrationResult) calibrationResult.textContent = "";
    draw();
      console.log('ğŸ”„ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì¬ì‹œì‘ - ì  1:', pos);
    }
  };
  
  // âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (capture phaseì—ì„œ ë¨¼ì € ì²˜ë¦¬)
  cv.addEventListener('click', calibrationClickHandler, true);
  console.log("âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ í´ë¦­ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™” ì™„ë£Œ");
}

// âœ… cv ìº”ë²„ìŠ¤ê°€ ì¤€ë¹„ëœ í›„ í˜¸ì¶œ
if(typeof cv !== 'undefined' && cv) {
  setupCalibrationClickHandler();
} else {
  // cvê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë‚˜ì¤‘ì— í˜¸ì¶œ
  if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(setupCalibrationClickHandler, 100);
    });
  } else {
    setTimeout(setupCalibrationClickHandler, 100);
  }
}

// âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê´€ë ¨ ë²„íŠ¼ë“¤ ì´ˆê¸°í™”
function setupCalibrationButtons() {
  const btnConfirm = document.getElementById("btnCalibrateConfirm");
  const btnCancel = document.getElementById("btnCalibrateCancel");
  const btnSaveJSON = document.getElementById("btnSaveJSON");
  const btnLoadJSON = document.getElementById("btnLoadJSON");
  
  if(btnConfirm) {
    // âœ… ê¸°ì¡´ í•¸ë“¤ëŸ¬ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    if(calibrationConfirmHandler) {
      btnConfirm.removeEventListener('click', calibrationConfirmHandler);
      btnConfirm.removeEventListener('touchend', calibrationConfirmHandler);
    }
    
    // âœ… ìƒˆ í•¸ë“¤ëŸ¬ ìƒì„±
    calibrationConfirmHandler = () => {
      const S = sessions[cur];
      if(!S) {
        alert("ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      
      if(!S.calibrationPoint1 || !S.calibrationPoint2) {
        alert("ë‘ ì ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      
      const calibrationLengthInput = document.getElementById("calibrationLength");
      if(!calibrationLengthInput) {
        alert("ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      
      const realLengthCm = parseFloat(calibrationLengthInput.value);
      if(!realLengthCm || realLengthCm <= 0) {
        alert("ì‹¤ì œ ê¸¸ì´(cm)ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      
      try {
        const pxPerCm = calibratePxPerCm(S.calibrationPoint1, S.calibrationPoint2, realLengthCm);
        S.pxPerCm = pxPerCm;
        const calibrationResult = document.getElementById("calibrationResult");
        if(calibrationResult) {
          calibrationResult.textContent = 
          `âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì™„ë£Œ: ${pxPerCm.toFixed(2)} px/cm`;
          calibrationResult.style.color = "#2ec4b6";
        }
        
        // ë©”íŠ¸ë¦­ ì¬ê³„ì‚°
        computeMetricsOnly();
        
        // âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì™„ë£Œ í›„ ëª¨ë“œ ì¢…ë£Œ ë° ë§ˆì»¤ ìˆ¨ê¹€
        calibrationMode = false;
        const panel = document.getElementById("calibrationPanel");
        if(panel) panel.style.display = "none";
        S.calibrationPoint1 = null;
        S.calibrationPoint2 = null;
        if(cv) cv.style.cursor = "default";
        draw(); // ë§ˆì»¤ ìˆ¨ê¹€
        
        console.log(`âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì™„ë£Œ: ${pxPerCm.toFixed(2)} px/cm`);
      } catch(err) {
        console.error("ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì˜¤ë¥˜:", err);
        alert("ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì˜¤ë¥˜: " + err.message);
      }
    };
    
    addMobileTouchSupport(btnConfirm, calibrationConfirmHandler);
    console.log("âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ í™•ì¸ ë²„íŠ¼ ì´ˆê¸°í™” ì™„ë£Œ");
  }
  
  if(btnCancel) {
    // âœ… ê¸°ì¡´ í•¸ë“¤ëŸ¬ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    if(calibrationCancelHandler) {
      btnCancel.removeEventListener('click', calibrationCancelHandler);
      btnCancel.removeEventListener('touchend', calibrationCancelHandler);
    }
    
    // âœ… ìƒˆ í•¸ë“¤ëŸ¬ ìƒì„±
    calibrationCancelHandler = () => {
      calibrationMode = false;
      const panel = document.getElementById("calibrationPanel");
      if(panel) panel.style.display = "none";
      
      const S = sessions[cur];
      if(S) {
      S.calibrationPoint1 = null;
      S.calibrationPoint2 = null;
      }
      
      if(cv) cv.style.cursor = "default";
      draw();
      console.log("âŒ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì·¨ì†Œ");
    };
    
    addMobileTouchSupport(btnCancel, calibrationCancelHandler);
    console.log("âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì·¨ì†Œ ë²„íŠ¼ ì´ˆê¸°í™” ì™„ë£Œ");
  }
  
  if(btnSaveJSON) {
    btnSaveJSON.onclick = () => {
      // ì €ì¥ ì „ì— AI ë¶„ì„ ì‹¤í–‰
      computeAll();
      
      const orientation = sessions[cur].poseData?.orientation || "side";
      const map = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
      const obj = Object.fromEntries(map);
      const json = JSON.stringify(obj, null, 2);
      const blob = new Blob([json], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `posture_coords_${cur}_${orientation}_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    };
  }
  
  if(btnLoadJSON) {
    btnLoadJSON.onclick = () => {
      const inp = document.createElement('input');
      inp.type = 'file';
      inp.accept = 'application/json';
      inp.onchange = e => {
        const f = e.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = () => {
          try {
            const obj = JSON.parse(r.result);
            const orientation = sessions[cur].poseData?.orientation || "side";
            const map = orientation === "front" ? sessions[cur].frontPoints : sessions[cur].sidePoints;
            map.clear();
            for(const k of Object.keys(obj)) map.set(k, obj[k]);
            draw();
            computeAll();
          } catch(err) {
            alert('JSON íŒŒì‹± ì‹¤íŒ¨: ' + err.message);
          }
        };
        r.readAsText(f);
      };
      inp.click();
    };
  }
}

// âœ… initializeAppì—ì„œë§Œ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½ (ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)

// Before-After ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ìƒì„± (Canvas API ì‚¬ìš©)
// ìŠ¤ì¼ˆë ˆí†¤ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (Before-After ì˜¤ë²„ë ˆì´ìš©)
function drawSkeleton(ctx, points, color, labelPrefix, isDashed = false) {
  ctx.strokeStyle = color;
  ctx.fillStyle = color;
  ctx.lineWidth = 3;
  ctx.globalAlpha = isDashed ? 0.9 : 0.8;
  ctx.setLineDash(isDashed ? [6, 4] : []);
  
  // í‚¤í¬ì¸íŠ¸ ìˆœì„œ ì •ì˜ (ì¸¡ë©´)
  const keyOrder = ['tragus', 'c7', 'acromion', 'hip', 'knee', 'ankle'];
  
  // í‚¤í¬ì¸íŠ¸ ê°„ ì„  ê·¸ë¦¬ê¸°
  for(let i = 0; i < keyOrder.length - 1; i++) {
    const key1 = keyOrder[i];
    const key2 = keyOrder[i + 1];
    const p1 = points[key1];
    const p2 = points[key2];
    
    if(p1 && p2 && p1.x != null && p1.y != null && p2.x != null && p2.y != null) {
      ctx.beginPath();
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.stroke();
    }
  }
  
  // ASIS-PSIS ì—°ê²° (ê³¨ë°˜)
  if(points.asis && points.psis) {
    ctx.beginPath();
    ctx.moveTo(points.asis.x, points.asis.y);
    ctx.lineTo(points.psis.x, points.psis.y);
    ctx.stroke();
  }
  
  ctx.setLineDash([]);
  
  // ê° í‚¤í¬ì¸íŠ¸ì— ì ê³¼ ë¼ë²¨ ê·¸ë¦¬ê¸°
  Object.keys(points).forEach(key => {
    const p = points[key];
    if(!p || p.x == null || p.y == null) return;
    
    // ì  ê·¸ë¦¬ê¸°
    ctx.beginPath();
    ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
    ctx.fill();
    
    // ë¼ë²¨ ê·¸ë¦¬ê¸°
    ctx.font = '13px Arial';
    ctx.fillStyle = '#fff';
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.strokeText(`${labelPrefix}:${key}`, p.x + 12, p.y);
    ctx.fillText(`${labelPrefix}:${key}`, p.x + 12, p.y);
  });
  
  ctx.globalAlpha = 1.0;
}

// Before-After ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ìƒì„± (ìŠ¤ì¼ˆë ˆí†¤ í¬í•¨)
async function createOverlayImageWithSkeleton(beforeImgData, afterImgData, beforePoints, afterPoints, alpha = 0.5) {
  return new Promise((resolve, reject) => {
    try {
      const beforeImg = new Image();
      const afterImg = new Image();
      
      beforeImg.onload = () => {
        afterImg.onload = () => {
          // ìº”ë²„ìŠ¤ ìƒì„±
          const overlayCanvas = document.createElement('canvas');
          const overlayCtx = overlayCanvas.getContext('2d');
          
          // í¬ê¸° ì„¤ì • (ë” í° ì´ë¯¸ì§€ ê¸°ì¤€)
          const width = Math.max(beforeImg.width, afterImg.width);
          const height = Math.max(beforeImg.height, afterImg.height);
          overlayCanvas.width = width;
          overlayCanvas.height = height;
          
          // ë°°ê²½ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (Before ì´ë¯¸ì§€ ì‚¬ìš©)
          overlayCtx.drawImage(beforeImg, 0, 0, width, height);
          
          // Before ìŠ¤ì¼ˆë ˆí†¤ ê·¸ë¦¬ê¸° (íŒŒë€ìƒ‰, ì ì„ )
          if(beforePoints) {
            // ì´ë¯¸ì§€ í¬ê¸°ì— ë§ê²Œ ì¢Œí‘œ ìŠ¤ì¼€ì¼ë§
            const scaleX = width / beforeImg.width;
            const scaleY = height / beforeImg.height;
            const scaledBeforePoints = {};
            Object.keys(beforePoints).forEach(key => {
              if(beforePoints[key] && beforePoints[key].x != null && beforePoints[key].y != null) {
                scaledBeforePoints[key] = {
                  x: beforePoints[key].x * scaleX,
                  y: beforePoints[key].y * scaleY
                };
              }
            });
            drawSkeleton(overlayCtx, scaledBeforePoints, '#2E86C1', 'B', true);
          }
          
          // After ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ (ì£¼í™©ìƒ‰ í†¤, íˆ¬ëª…ë„ ì ìš©)
          overlayCtx.globalCompositeOperation = 'source-over';
          overlayCtx.globalAlpha = alpha;
          
          // After ì´ë¯¸ì§€ë¥¼ ì£¼í™©ìƒ‰ í†¤ìœ¼ë¡œ ë³€í™˜
          const tempCanvas = document.createElement('canvas');
          const tempCtx = tempCanvas.getContext('2d');
          tempCanvas.width = width;
          tempCanvas.height = height;
          tempCtx.drawImage(afterImg, 0, 0, width, height);
          
          const afterImageData = tempCtx.getImageData(0, 0, width, height);
          for(let i = 0; i < afterImageData.data.length; i += 4) {
            afterImageData.data[i] = Math.min(255, afterImageData.data[i] * 1.3); // R ì¦ê°€ (ì£¼í™©ìƒ‰ í†¤)
            afterImageData.data[i + 1] = Math.min(255, afterImageData.data[i + 1] * 1.1); // G ì¦ê°€
            afterImageData.data[i + 2] = Math.min(255, afterImageData.data[i + 2] * 0.7); // B ê°ì†Œ
          }
          tempCtx.putImageData(afterImageData, 0, 0);
          
          overlayCtx.drawImage(tempCanvas, 0, 0);
          overlayCtx.globalAlpha = 1.0;
          
          // After ìŠ¤ì¼ˆë ˆí†¤ ê·¸ë¦¬ê¸° (ì£¼í™©ìƒ‰, ì‹¤ì„ )
          if(afterPoints) {
            const scaleX = width / afterImg.width;
            const scaleY = height / afterImg.height;
            const scaledAfterPoints = {};
            Object.keys(afterPoints).forEach(key => {
              if(afterPoints[key] && afterPoints[key].x != null && afterPoints[key].y != null) {
                scaledAfterPoints[key] = {
                  x: afterPoints[key].x * scaleX,
                  y: afterPoints[key].y * scaleY
                };
              }
            });
            drawSkeleton(overlayCtx, scaledAfterPoints, '#E67E22', 'A', false);
          }
          
          resolve(overlayCanvas.toDataURL('image/png'));
        };
        afterImg.onerror = reject;
        afterImg.src = afterImgData;
      };
      beforeImg.onerror = reject;
      beforeImg.src = beforeImgData;
    } catch(err) {
      reject(err);
    }
  });
}

// ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€ (í•˜ìœ„ í˜¸í™˜ì„±)
async function createOverlayImage(beforeImgData, afterImgData, alpha = 0.5) {
  return new Promise((resolve, reject) => {
    try {
      const beforeImg = new Image();
      const afterImg = new Image();
      
      beforeImg.onload = () => {
        afterImg.onload = () => {
          // ìº”ë²„ìŠ¤ ìƒì„±
          const overlayCanvas = document.createElement('canvas');
          const overlayCtx = overlayCanvas.getContext('2d');
          
          // í¬ê¸° ì„¤ì • (ë” í° ì´ë¯¸ì§€ ê¸°ì¤€)
          const width = Math.max(beforeImg.width, afterImg.width);
          const height = Math.max(beforeImg.height, afterImg.height);
          overlayCanvas.width = width;
          overlayCanvas.height = height;
          
          // Before ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (íŒŒë€ìƒ‰ í†¤)
          overlayCtx.globalCompositeOperation = 'source-over';
          overlayCtx.drawImage(beforeImg, 0, 0, width, height);
          
          // íŒŒë€ìƒ‰ í•„í„° ì ìš©
          const beforeImageData = overlayCtx.getImageData(0, 0, width, height);
          for(let i = 0; i < beforeImageData.data.length; i += 4) {
            beforeImageData.data[i] = Math.min(255, beforeImageData.data[i] * 0.7 + 50); // R ì¦ê°€ (íŒŒë€ìƒ‰ í†¤)
            beforeImageData.data[i + 1] = Math.min(255, beforeImageData.data[i + 1] * 0.8 + 30); // G ì¦ê°€
            beforeImageData.data[i + 2] = Math.min(255, beforeImageData.data[i + 2] * 1.2); // B ì¦ê°€
          }
          overlayCtx.putImageData(beforeImageData, 0, 0);
          
          // After ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ì£¼í™©ìƒ‰ í†¤, íˆ¬ëª…ë„ ì ìš©)
          overlayCtx.globalCompositeOperation = 'source-over';
          overlayCtx.globalAlpha = alpha;
          
          // After ì´ë¯¸ì§€ë¥¼ ì£¼í™©ìƒ‰ í†¤ìœ¼ë¡œ ë³€í™˜
          const tempCanvas = document.createElement('canvas');
          const tempCtx = tempCanvas.getContext('2d');
          tempCanvas.width = width;
          tempCanvas.height = height;
          tempCtx.drawImage(afterImg, 0, 0, width, height);
          
          const afterImageData = tempCtx.getImageData(0, 0, width, height);
          for(let i = 0; i < afterImageData.data.length; i += 4) {
            afterImageData.data[i] = Math.min(255, afterImageData.data[i] * 1.3); // R ì¦ê°€ (ì£¼í™©ìƒ‰ í†¤)
            afterImageData.data[i + 1] = Math.min(255, afterImageData.data[i + 1] * 1.1); // G ì¦ê°€
            afterImageData.data[i + 2] = Math.min(255, afterImageData.data[i + 2] * 0.7); // B ê°ì†Œ
          }
          tempCtx.putImageData(afterImageData, 0, 0);
          
          overlayCtx.drawImage(tempCanvas, 0, 0);
          overlayCtx.globalAlpha = 1.0;
          
          resolve(overlayCanvas.toDataURL('image/png'));
        };
        afterImg.onerror = reject;
        afterImg.src = afterImgData;
      };
      beforeImg.onerror = reject;
      beforeImg.src = beforeImgData;
    } catch(err) {
      reject(err);
    }
  });
}

// ì•ˆì „í•œ ëœë“œë§ˆí¬ ë§¤í•‘ í•¨ìˆ˜ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
async function getMappedKeypoints(session, orientation = 'side', maxRetries = 10) {
  // 1) í¬ì¦ˆ ë°ì´í„° ì†ŒìŠ¤ ìœ ì—°í•˜ê²Œ íƒìƒ‰
  const pose = session?.poseData || session?.sidePose || session?.frontPose || {};
  let raw = Array.isArray(pose.landmarks) ? pose.landmarks : [];
  
  // 2) ì¶”ë¡ ì´ ì•„ì§ì´ë©´ ì§§ê²Œ ì¬ì‹œë„
  if (!raw || !raw.length) {
    for (let i = 0; i < maxRetries; i++) {
      await new Promise(r => setTimeout(r, 100));
      const retry = session?.poseData?.landmarks || session?.sidePose?.landmarks || session?.frontPose?.landmarks || [];
      if (retry && retry.length > 0) {
        raw = retry;
        break;
      }
    }
  }
  
  // 3) ì—¬ì „íˆ ë¹„ì–´ìˆìœ¼ë©´ null ë°˜í™˜
  if (!raw || !raw.length) {
    console.warn('âš ï¸ landmarks empty. fallback to manual points only.');
    return null;
  }
  
  // 4) ì •ìƒ ë§¤í•‘
  try {
    return mapPoseToKeypoints({ keypoints: raw }, orientation);
  } catch(err) {
    console.warn('ëœë“œë§ˆí¬ ë§¤í•‘ ì‹¤íŒ¨:', err);
    return null;
  }
}

// Confidence Heatmap ìƒì„± (ì•ˆì „ ë²„ì „ - ê°œì„ )
async function createConfidenceHeatmap(imgData, sessionName, orientation = 'side') {
  return new Promise((resolve, reject) => {
    try {
      const img = new Image();
      img.onload = async () => {
        try {
          const session = sessions?.[sessionName];
          if(!session) {
            console.warn(`ì„¸ì…˜ ${sessionName}ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
            resolve({ heatmapImage: imgData, avgConfidence: 0.8 });
            return;
          }
          
          const heatmapCanvas = document.createElement('canvas');
          const heatmapCtx = heatmapCanvas.getContext('2d');
          if(!heatmapCtx) {
            throw new Error('Canvas contextë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
          
          heatmapCanvas.width = img.width;
          heatmapCanvas.height = img.height;
          
          // ì›ë³¸ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
          heatmapCtx.drawImage(img, 0, 0);
          
          // í‚¤í¬ì¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
          const points = orientation === 'front' ? session.frontPoints : session.sidePoints;
          
          // ì•ˆì „í•œ ëœë“œë§ˆí¬ ë§¤í•‘ (ì¬ì‹œë„ í¬í•¨)
          const MIN_CONF = 0.6;
          const mapped = await getMappedKeypoints(session, orientation);
          
          // í‰ê·  confidence ê³„ì‚°
          let totalConfidence = 0;
          let validCount = 0;
          
          if(mapped) {
            Object.values(mapped).forEach(point => {
              if(point && point.score != null && point.score >= MIN_CONF) {
                totalConfidence += point.score;
                validCount++;
              }
            });
          }
          
          const avgConfidence = validCount > 0 ? totalConfidence / validCount : 0.8;
          
          // ê° í‚¤í¬ì¸íŠ¸ì— confidence ê¸°ë°˜ ìƒ‰ìƒ ì ìš©
          points.forEach((point, key) => {
            if(!point || point.x == null || point.y == null) return;
            
            // landmarksì—ì„œ confidence ì°¾ê¸°
            let confidence = 0.8; // ê¸°ë³¸ê°’
            try {
              if(mapped && mapped[key] && mapped[key].score != null) {
                const score = mapped[key].score;
                // ìµœì†Œ ì‹ ë¢°ë„ ë¯¸ë§Œì€ ì œì™¸
                if(score >= MIN_CONF) {
                  confidence = score;
                }
              }
            } catch(err) {
              console.warn(`í‚¤í¬ì¸íŠ¸ ${key} confidence ê³„ì‚° ì‹¤íŒ¨:`, err);
              confidence = 0.8;
            }
            
            // Confidence ê¸°ë°˜ ìƒ‰ìƒ ê³„ì‚° (ì•ˆì „í•œ ë°©ì‹)
            // ë†’ìŒ(1.0): ë¹¨ê°•, ì¤‘ê°„(0.5): ë…¸ë‘, ë‚®ìŒ(0.0): íŒŒë‘
            const r = Math.floor(255 * confidence);
            const g = Math.floor(150 * confidence);
            const b = Math.floor(255 * (1 - confidence));
            const alpha = 0.4 + 0.3 * confidence;
            
            // ì› ê·¸ë¦¬ê¸°
            heatmapCtx.beginPath();
            heatmapCtx.fillStyle = `rgba(${r}, ${g}, ${b}, ${alpha})`;
            heatmapCtx.arc(point.x, point.y, 13, 0, Math.PI * 2);
            heatmapCtx.fill();
            
            // ë¼ë²¨ (ì•ˆì „í•œ í°íŠ¸ ì‚¬ìš©)
            heatmapCtx.font = '10px helvetica';
            heatmapCtx.fillStyle = '#fff';
            heatmapCtx.fillText(key, point.x + 15, point.y - 6);
            heatmapCtx.fillText(`${(confidence * 100).toFixed(0)}%`, point.x + 15, point.y + 9);
          });
          
          // í‰ê·  ì‹ ë¢°ë„ í‘œì‹œ
          heatmapCtx.fillStyle = '#ffffffcc';
          heatmapCtx.font = '14px helvetica';
          heatmapCtx.fillText(`AI í‰ê·  ì‹ ë¢°ë„: ${(avgConfidence * 100).toFixed(1)}%`, 20, 25);
          
          resolve({ 
            heatmapImage: heatmapCanvas.toDataURL('image/png'), 
            avgConfidence: avgConfidence 
          });
        } catch(err) {
          console.error('Heatmap ìƒì„± ì¤‘ ì˜¤ë¥˜:', err);
          // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì›ë³¸ ì´ë¯¸ì§€ ë°˜í™˜
          resolve({ heatmapImage: imgData, avgConfidence: 0.8 });
        }
      };
      img.onerror = (err) => {
        console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', err);
        reject(new Error('ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
      };
      img.src = imgData;
    } catch(err) {
      console.error('Heatmap ìƒì„± ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
      reject(err);
    }
  });
}

// ========== í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ë° AI ì‹¬ì¸µ ë¶„ì„ í•¨ìˆ˜ ==========

// ì•ˆì „ ìœ í‹¸
const getMetricValue = (m, k, d = null) => {
  if(!m) return d;
  const metric = m[k];
  if(!metric) return d;
  // {before, after} í˜•íƒœ ë˜ëŠ” ë‹¨ì¼ ê°’
  if(metric.after != null) return metric.after;
  if(metric.before != null) return metric.before;
  if(typeof metric === 'number') return metric;
  if(metric.value != null) return metric.value;
  return d;
};

// ì •ìƒë²”ìœ„ ê¸°ì¤€
const NORMAL_RANGE = {
  CVA: v => v >= 50,          // ë‘ê°œê²½ì¶”ê°
  HPD: v => v <= 2,           // ë‘ë¶€ ì „ë°©ì´ë™ (cm)
  TIA: v => v >= 0 && v <= 10, // ì²´ê°„ê²½ì‚¬
  SAA: v => v >= 0 && v <= 10, // ì–´ê¹¨ ì „ë°©ê°
  PTA: v => v >= 0 && v <= 15, // ê³¨ë°˜ ì „í›„ê²½ì‚¬
  KA:  v => v >= 175 && v <= 185, // ë¬´ë¦ê°
  Tibial_Angle: v => v >= 0 && v <= 10, // ê²½ê³¨ê²½ì‚¬
  GSB: v => v <= 2,           // ì¤‘ë ¥ì¤‘ì‹¬ì„ (cm)
  HPA: v => v >= 0 && v <= 10,  // Headâ€“Pelvis Angle
};

// íŒ¨í„´ íŒì • (After ìš°ì„ , ì—†ìœ¼ë©´ ë‹¨ì¼ ê°’)
function detectPatterns(metrics) {
  const v = k => getMetricValue(metrics, k);
  const pat = [];

  // ê±°ë¶ëª©(FHP): CVA ë‚®ìŒ(ì •ìƒ ë¯¸ë§Œ)
  if (v('CVA') != null && !NORMAL_RANGE.CVA(v('CVA'))) pat.push('FHP');

  // ë¼ìš´ë“œ ìˆ„ë”: SAAâ†‘
  if (v('SAA') != null && !NORMAL_RANGE.SAA(v('SAA'))) pat.push('RSP');

  // ê³¨ë°˜ ê³¼ì „ê²½ì‚¬/í›„ê²½ì‚¬: PTA ê¸°ì¤€
  if (v('PTA') != null) {
    if (v('PTA') > 15) pat.push('ANT_TILT');
    else if (v('PTA') < 5) pat.push('POST_TILT');
  }

  // í•˜ì§€ ì •ë ¬: KA
  if (v('KA') != null) {
    if (v('KA') < 175) pat.push('VALGUS');
    if (v('KA') > 185) pat.push('VARUS');
  }

  // ì²´ì¤‘ ì „/í›„ë°© ì´ë™: GSB
  if (v('GSB') != null) {
    if (v('GSB') > 2) pat.push('FORWARD_COG');
  }

  return [...new Set(pat)];
}

// í•„ë¼í…ŒìŠ¤ ë°ì´í„°ë² ì´ìŠ¤ (ê¸°ì¡´ íŒ¨í„´ DB - í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)
const PILATES_PATTERN_DB = {
  FHP: {
    title: 'ê±°ë¶ëª©(Forward Head Posture)',
    tight: ['SCM(í‰ì‡„ìœ ëŒê·¼)', 'ìƒë¶€ìŠ¹ëª¨', 'ê²¬ê°‘ê±°ê·¼', 'ì†Œí‰ê·¼'],
    weak:  ['ì‹¬ë¶€ê²½ë¶€êµ´ê·¼', 'í•˜ë¶€ìŠ¹ëª¨', 'ì „ê±°ê·¼'],
    moves: {
      Mat: [
        { name: 'Chin Tuck & Axial Elongation (í„±ë‹¹ê¸°ê¸°+ì¶•ì‹ ì¥)', goal: 'ê²½ì¶” ì •ë ¬Â·ì•ˆì •í™”',
          easy: 'ë²½ì— ë’¤í†µìˆ˜ ì‚´ì§ ëŒ€ê³ , í„±ì„ ê°€ë³ê²Œ ë‹¹ê²¨ ëª©ì„ ê¸¸ê²Œ. 5ì´ˆ ìœ ì§€Ã—8~10íšŒ.' },
        { name: 'Swan Prep', goal: 'í‰ì¶” ì‹ ì „, ê²¬ê°‘ ì•ˆì •',
          easy: 'ì—ë“œë ¤ ê°€ìŠ´ë§Œ ì‚´ì§ ë“¤ì–´ ì˜¬ë¦¬ë©° ê¸´ í˜¸í¡. í—ˆë¦¬ êº¾ì§€ ë§ê³  6~8íšŒ.' },
      ],
      Reformer: [
        { name: 'Pulling Straps', goal: 'ê²¬ê°‘ í›„ë°© ì•ˆì •í™”',
          easy: 'ì—ë“œë ¤ ìŠ¤íŠ¸ë© ë‹¹ê¸°ë©° ì–´ê¹¨ë¥¼ ì•„ë˜ë’¤ë¡œ. ëª©ì€ ê¸¸ê²Œ 8~10íšŒ.' },
      ],
      Cadillac: [
        { name: 'Tower Swan', goal: 'í‰ì¶” ì‹ ì „+ê²¬ê°‘ í›„ë°©',
          easy: 'í‘¸ì‹œìŠ¤ë£¨ë°” ì¡ê³  ë³µë¶€ ë‹¹ê¸´ ì±„ ê°€ìŠ´ì„ ê¸¸ê²Œ ì—´ê¸° 6~8íšŒ.' },
      ],
      Chair: [
        { name: 'Press Down Front', goal: 'ì „ê±°ê·¼/í•˜ë¶€ìŠ¹ëª¨ í™œì„±',
          easy: 'ìŠ¤í”„ë§ í˜ë‹¬ ì•ì—ì„œ íŒ”ë¡œ ì‚´ì§ ëˆŒëŸ¬ ì–´ê¹¨ë¥¼ ì•„ë˜ë¡œ ê³ ì • 8~10íšŒ.' },
      ],
      Barrel: [
        { name: 'Swan on Ladder Barrel', goal: 'í‰ì¶” ê°€ë™ì„±',
          easy: 'ê°€ìŠ´ì„ ë°°ëŸ´ ìœ„ì— ë‘ê³  ì²œì²œíˆ ì‹ ì „Â·ë³µê·€ 6~8íšŒ.' },
      ],
    }
  },
  RSP: {
    title: 'ë¼ìš´ë“œ ìˆ„ë”(Rounded Shoulder)',
    tight: ['ëŒ€í‰ê·¼', 'ì†Œí‰ê·¼', 'ìƒë¶€ìŠ¹ëª¨'],
    weak:  ['í•˜ë¶€ìŠ¹ëª¨', 'ëŠ¥í˜•ê·¼', 'ì „ê±°ê·¼'],
    moves: {
      Mat: [
        { name: 'Prone Scapular Retraction', goal: 'ê²¬ê°‘ í›„ì¸',
          easy: 'ì—ë“œë ¤ ë‚ ê°œë¼ˆë¥¼ ë’¤ë¡œ ëª¨ìœ¼ê³  ì•„ë˜ë¡œ 8~12íšŒ.' },
      ],
      Reformer: [
        { name: 'Rowing Back / Pulling Straps', goal: 'ê²¬ê°‘ ì•ˆì •',
          easy: 'ê°€ìŠ´ í™œì§ ì—´ë©° ìŠ¤íŠ¸ë© ë’¤ë¡œ ë‹¹ê¸°ê¸° 8~10íšŒ.' },
      ],
      Cadillac: [
        { name: 'Arm Springs - Extension', goal: 'ì–´ê¹¨ í›„ë°© ê·¼ìœ¡ ê°•í™”',
          easy: 'íŒ” ë’¤ë¡œ ë»—ìœ¼ë©° ì–´ê¹¨ëŠ” ì•„ë˜ ê³ ì • 8~12íšŒ.' },
      ],
      Chair: [
        { name: 'Spine Stretch (Chair ver.)', goal: 'í‰ì¶” ì‹ ì „Â·ê²¬ê°‘ ì•ˆì •',
          easy: 'ë“±ì„ ê¸¸ê²Œ ë§Œë“¤ë©° í˜ë‹¬ ì‚´ì§ ëˆ„ë¥´ê¸° 6~8íšŒ.' },
      ],
      Barrel: [
        { name: 'Shoulder Extension on Barrel', goal: 'ì–´ê¹¨ í›„ì¸Â·í‰ì¶” ê°€ë™ì„±',
          easy: 'ë°°ëŸ´ì—ì„œ íŒ”ì„ ë’¤ë¡œ ë»—ê³  ê°€ìŠ´ ì—´ê¸° 6~8íšŒ.' },
      ],
    }
  },
  ANT_TILT: {
    title: 'ê³¨ë°˜ ê³¼ì „ê²½ì‚¬(Anterior Tilt)',
    tight: ['ì¥ìš”ê·¼', 'ëŒ€í‡´ì§ê·¼', 'ì²™ì¶”ê¸°ë¦½ê·¼'],
    weak:  ['ë³µì§ê·¼/ë³µíš¡ê·¼', 'ë‘”ê·¼'],
    moves: {
      Mat: [
        { name: 'Pelvic Curl', goal: 'í›„ë°©ê²½ì‚¬ ìœ ë„',
          easy: 'ë¬´ë¦ êµ½í˜€ ëˆ„ì›Œ ê³¨ë°˜ì„ ë§ì•„ ì˜¬ë ¤ 8~10íšŒ.' },
        { name: 'Dead Bug / Toe Tap', goal: 'ë³µíš¡ê·¼ í™œì„±',
          easy: 'í—ˆë¦¬ ëœ¨ì§€ ì•Šê²Œ, ë‹¤ë¦¬ ë²ˆê°ˆì•„ ë‚®ì¶”ê¸° 8~10íšŒ.' },
      ],
      Reformer: [
        { name: 'Bridge on Reformer', goal: 'í›„ë°© ì‚¬ìŠ¬ ê°•í™”',
          easy: 'ë°œë°”ë‹¥ ê³ ì •, ì—‰ë©ì´ ì˜¬ë ¤ ì²™ì¶” ë§ì•„ ì˜¬ë¦¬ê¸° 8íšŒ.' },
      ],
      Cadillac: [
        { name: 'Roll Down (Push Through Bar)', goal: 'ì½”ì–´ ì¡°ì ˆ',
          easy: 'ê°ˆë¹„ë¥¼ ì•ˆìª½ìœ¼ë¡œ, ë“± ë§ì•„ ë‚´ë ¸ë‹¤ ì˜¬ë¼ì˜¤ê¸° 6~8íšŒ.' },
      ],
      Chair: [
        { name: 'Standing Hip Extension', goal: 'ë‘”ê·¼ ê°•í™”',
          easy: 'ëª¸í†µ ê³ ì •, ë‹¤ë¦¬ ë’¤ë¡œ ë»—ê¸° 8~12íšŒ.' },
      ],
      Barrel: [
        { name: 'Short Box - Round Back', goal: 'ì½”ì–´Â·í›„ë°©ì‚¬ìŠ¬',
          easy: 'ë³µë¶€ ë‹¹ê¸°ê³  ë“± ë‘¥ê¸€ê²Œ ë‚®ì·„ë‹¤ ë³µê·€ 6~8íšŒ.' },
      ],
    }
  },
  POST_TILT: {
    title: 'ê³¨ë°˜ í›„ê²½ì‚¬(Posterior Tilt)',
    tight: ['í–„ìŠ¤íŠ¸ë§', 'ë³µì§ê·¼'],
    weak:  ['ì¥ìš”ê·¼', 'ëŒ€í‡´ì§ê·¼', 'ì²™ì¶”ê¸°ë¦½ê·¼'],
    moves: {
      Mat: [
        { name: 'Leg Pull Front', goal: 'ì „ë°© ì‚¬ìŠ¬ ê°•í™”',
          easy: 'í”Œë­í¬ ìì„¸ì—ì„œ ëª¸í†µ ê¸¸ê²Œ 20~30ì´ˆÃ—3.' },
      ],
      Reformer: [
        { name: 'Footwork - Parallel Heels', goal: 'ê³ ê´€ì ˆ ì‹ ì „',
          easy: 'ë¬´ë¦-ë°œë ì •ë ¬ ìœ ì§€í•´ ë°€ê¸° 10~12íšŒ.' },
      ],
      Cadillac: [
        { name: 'Leg Springs - Supine', goal: 'ì¥ìš”ê·¼ ê¸°ëŠ¥ì  ìˆ˜ì¶•',
          easy: 'ê³¨ë°˜ ê³ ì •, ë‹¤ë¦¬ ë“¤ì–´ ì˜¬ë ¸ë‹¤ ë‚´ë¦¬ê¸° 8~10íšŒ.' },
      ],
      Chair: [
        { name: 'Swan Press', goal: 'ìš”ì¶” ì‹ ì „ ê°•í™”',
          easy: 'ê°€ìŠ´ì„ ê¸¸ê²Œ, í—ˆë¦¬ êº¾ì§€ ì•Šê¸° 6~8íšŒ.' },
      ],
      Barrel: [
        { name: 'Swan on Barrel', goal: 'ìš”ì¶”/í‰ì¶” ê°€ë™ì„±',
          easy: 'í¸ì•ˆí•œ ë²”ìœ„ë§Œí¼ ì‹ ì „ 6~8íšŒ.' },
      ],
    }
  },
  VALGUS: {
    title: 'Xì ë‹¤ë¦¬(Genu Valgum)',
    tight: ['ë‚´ì „ê·¼', 'ë‚´ì¸¡ê´‘ê·¼'],
    weak:  ['ì¤‘ë‘”ê·¼', 'ì™¸íšŒì „ê·¼', 'ì™¸ì¸¡ê´‘ê·¼'],
    moves: {
      Mat: [
        { name: 'Side-Lying Leg Lift', goal: 'ì¤‘ë‘”ê·¼ ê°•í™”',
          easy: 'ì˜†ìœ¼ë¡œ ëˆ„ì›Œ ìœ„ìª½ ë‹¤ë¦¬ ë“¤ì–´ ì˜¬ë¦¬ê¸° 10~12íšŒ.' },
      ],
      Reformer: [
        { name: 'Side Splits', goal: 'í•˜ì§€ ì™¸ì¸¡ ì•ˆì •',
          easy: 'ê³¨ë°˜ ìˆ˜í‰ ìœ ì§€í•˜ë©° ë²Œë¦¬ê³  ëª¨ìœ¼ê¸° 8~10íšŒ.' },
      ],
      Cadillac: [
        { name: 'Standing Hip Abduction', goal: 'ê³ ê´€ì ˆ ì™¸ì „',
          easy: 'ëª¸í†µ ê³ ì •, ì˜†ìœ¼ë¡œ ì°¨ ì˜¬ë¦¬ê¸° 8~10íšŒ.' },
      ],
      Chair: [
        { name: 'Step Up Lateral', goal: 'ì™¸ì¸¡ ì•ˆì •',
          easy: 'ì˜ì ì˜†ìœ¼ë¡œ ì˜¬ë¼ê°”ë‹¤ ë‚´ë ¤ì˜¤ê¸° 8íšŒ.' },
      ],
      Barrel: [
        { name: 'Side Bend Stretch', goal: 'ì¸¡ë©´ ê°€ë™ì„±',
          easy: 'ëª¸í†µ ê¸¸ê²Œ ëŠ˜ì´ë©° ì˜†êµ½í˜ 6íšŒ.' },
      ],
    }
  },
  VARUS: {
    title: 'Oì ë‹¤ë¦¬(Genu Varum)',
    tight: ['ì™¸ì¸¡ê´‘ê·¼', 'ë¹„ë³µê·¼', 'ëŒ€í‡´ì´ë‘'],
    weak:  ['ë‚´ì „ê·¼', 'ë‚´ì¸¡ê´‘ê·¼'],
    moves: {
      Mat: [
        { name: 'Ball Squeeze Bridge', goal: 'ë‚´ì „ê·¼ í™œì„±',
          easy: 'ë¬´ë¦ ì‚¬ì´ ë³¼ ë¼ê³  ë¸Œë¦¿ì§€ 8~10íšŒ.' },
      ],
      Reformer: [
        { name: 'Footwork - Small V', goal: 'ë‚´ì¸¡ê´‘ê·¼ ê°•í™”',
          easy: 'ì‘ì€ V, ë¬´ë¦ ëª¨ì•„ ë°€ê¸° 10~12íšŒ.' },
      ],
      Cadillac: [
        { name: 'Standing Leg Press - Adduction', goal: 'ë‚´ì „ê·¼ ê°•í™”',
          easy: 'ìŠ¤íŠ¸ë©ìœ¼ë¡œ ë‹¤ë¦¬ ì•ˆìª½ìœ¼ë¡œ ë‹¹ê¸°ê¸° 8~10íšŒ.' },
      ],
      Chair: [
        { name: 'Seated Adduction', goal: 'ë‚´ì¸¡ ì¡°ì ˆ',
          easy: 'ë°´ë“œ/ìŠ¤í”„ë§ìœ¼ë¡œ ë¬´ë¦ ëª¨ìœ¼ê¸° 8~12íšŒ.' },
      ],
      Barrel: [
        { name: 'Adductor Stretch on Barrel', goal: 'ë‚´ì „ê·¼ ì‹ ì¥',
          easy: 'í¸ì•ˆí•œ ë²”ìœ„ë¡œ 20ì´ˆ ìœ ì§€Ã—3.' },
      ],
    }
  },
  FORWARD_COG: {
    title: 'ì²´ì¤‘ ì¤‘ì‹¬ ì „ë°©(Forward Center)',
    tight: ['ëŒ€í‡´ì§ê·¼', 'ìš”ì¶”ê¸°ë¦½ê·¼', 'ì¢…ì•„ë¦¬'],
    weak:  ['ë‘”ê·¼', 'í–„ìŠ¤íŠ¸ë§', 'ë³µë¶€'],
    moves: {
      Mat: [
        { name: 'Pelvic Curl', goal: 'ë‘”ê·¼/í–„ìŠ¤íŠ¸ë§ í™œì„±',
          easy: 'ì²œì²œíˆ ë§ì•„ ì˜¬ë ¤ 8~10íšŒ.' },
      ],
      Reformer: [
        { name: 'Scooter', goal: 'ë‘”ê·¼ ì‹ ì „ ì¡°ì ˆ',
          easy: 'ëª¸í†µ ê³ ì •, ë’·ë‹¤ë¦¬ í˜ë‹¬ ì‚´ì§ ë°€ê¸° 8~12íšŒ.' },
      ],
      Cadillac: [
        { name: 'Tower Roll Up', goal: 'ì½”ì–´ í™œì„±',
          easy: 'ë°œë°”ë‹¥ ë°”ì— ë‘ê³  ë§ì•„ ì˜¬ë¼ê°€ê¸° 6~8íšŒ.' },
      ],
      Chair: [
        { name: 'Standing Leg Press', goal: 'í›„ë°© ì²´ì¤‘ ì´ë™',
          easy: 'ë°œë¡œ í˜ë‹¬ ëˆŒëŸ¬ ì—‰ë©ì´ ë’¤ë¡œ, ë¬´ë¦ ê³¼ì‹ ì „ ê¸ˆì§€ 8~10íšŒ.' },
      ],
      Barrel: [
        { name: 'Swan', goal: 'í‰ì¶” ì•ˆì •',
          easy: 'ê°€ìŠ´ì„ ê¸¸ê²Œ, ëª© ê¸¸ê²Œ 6~8íšŒ.' },
      ],
    }
  },
};

function buildPilatesTextFromAnalysis(pilatesItems) {
  if (!Array.isArray(pilatesItems) || pilatesItems.length === 0) return '';
  return pilatesItems.map((item, idx) => renderPilatesItemCard(item, { context:'pdf', index: idx, limitPerTool: Infinity })).join('');
}

// í•„ë¼í…ŒìŠ¤ ì¶”ì²œ í…ìŠ¤íŠ¸ ìƒì„±
function generatePilatesSessionText(metrics, pilatesItems = null) {
  const pilatesTextFromAnalysis = buildPilatesTextFromAnalysis(pilatesItems);
  if (pilatesTextFromAnalysis) return pilatesTextFromAnalysis;
  
  const pats = detectPatterns(metrics);
  if (!pats.length) {
    return `<div style="padding:12px; background:#f8f9ff; border-radius:10px; border:1px solid #e0e7ff; font-size:12px; font-family: var(--font-body); color:#111;">
      í˜„ì¬ ì¸¡ì •ê°’ì€ ëŒ€ì²´ë¡œ ì •ìƒ ë²”ìœ„ì…ë‹ˆë‹¤. ê¸°ë³¸ ì½”ì–´ ì•ˆì •ê³¼ ì „ì‹  ê°€ë™ì„± ë£¨í‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
    </div>`;
  }

  const blocks = pats.map(code => {
    const d = PILATES_PATTERN_DB[code];
    if (!d) return '';
    const tools = ['Mat', 'Reformer', 'Cadillac', 'Chair', 'Barrel'];
    const toolHTML = tools.map(tool => {
      if(!d.moves[tool] || d.moves[tool].length === 0) return '';
      const moves = d.moves[tool].map(m => `<li style="margin-bottom:4px;">${m.name} â€” ${m.goal}<br><span style="color:#475569;">${m.easy}</span></li>`).join('');
      return `<div style="margin-top:8px;">
        <div style="font-weight:600; color:#5c44b8; font-size:11px;">${tool}</div>
        <ul style="margin:6px 0 0 16px; padding:0; color:#0f172a; font-size:11px;">${moves}</ul>
      </div>`;
    }).join('');
    return `<div style="margin-bottom:12px; padding:12px; background:#f6f3ff; border-radius:12px; border:1px solid #ded3ff; font-family: var(--font-body);">
      <div style="font-weight:700; color:#5c44b8; margin-bottom:6px;">${d.title}</div>
      <div style="font-size:11px; margin-bottom:4px;"><strong style="color:#ff6b6b;">ê¸´ì¥:</strong> ${d.tight.join(', ')}</div>
      <div style="font-size:11px; margin-bottom:6px;"><strong style="color:#7c9cff;">ì•½í™”:</strong> ${d.weak.join(', ')}</div>
      ${toolHTML}
      <div style="margin-top:8px; font-size:11px; color:#475569;">ê¶Œì¥: í†µì¦ 0~2/10 ë²”ìœ„ ìœ ì§€, 8~12íšŒÃ—2~3ì„¸íŠ¸, í˜¸í¡ì€ "ê¸¸ê²Œ ë“¤ì´ì‰¬ê³  ê¸¸ê²Œ ë‚´ì‰¬ê¸°".</div>
    </div>`;
  }).filter(Boolean);

  return blocks.join('');
}

// âœ… AI ì‹¬ì¸µ ë¶„ì„ ìƒì„± (DB ê¸°ë°˜ ìƒì„¸ ë¶„ì„)
function generateAIDeepAnalysis(metrics) {
  // âœ… Before/After ì„¸ì…˜ì—ì„œ ì§ì ‘ ë©”íŠ¸ë¦­ ê°€ì ¸ì˜¤ê¸° (ê°œì„  ë²„ì „)
  const getMetricValue = (key) => {
    // 1ìˆœìœ„: metrics ê°ì²´ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸° (combinedMetrics í˜•íƒœ)
    if (metrics && metrics[key]) {
      const m = metrics[key];
      if (typeof m === 'object' && ('before' in m || 'after' in m)) {
    return {
          before: (m.before != null && !isNaN(m.before)) ? Number(m.before) : null,
          after: (m.after != null && !isNaN(m.after)) ? Number(m.after) : null
        };
      }
      // ìˆ«ì í˜•íƒœë©´ afterë¡œ ê°„ì£¼
      if (typeof m === 'number' && !isNaN(m)) {
        return { before: null, after: m };
      }
    }
    
    // 2ìˆœìœ„: Before/After ì„¸ì…˜ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸° (ê°œì„ : ëª¨ë“  ê°€ëŠ¥í•œ í‚¤ í™•ì¸)
    const beforeMetrics = sessions.Before?.metrics?.fullMetrics || {};
    const afterMetrics = sessions.After?.metrics?.fullMetrics || {};
    
    // âœ… í‚¤ ë³„ì¹­ ë§¤í•‘ (METRIC_KEY_ALIASES ì‚¬ìš©)
    const keyAliases = METRIC_KEY_ALIASES || {};
    const possibleKeys = [key, keyAliases[key], key.toUpperCase(), key.toLowerCase()].filter(Boolean);
    
    const getValue = (m, searchKeys) => {
      if (!m || typeof m !== 'object') return null;
      
      // ëª¨ë“  ê°€ëŠ¥í•œ í‚¤ë¡œ ì‹œë„
      for (const searchKey of searchKeys) {
        if (m[searchKey]) {
          const metric = m[searchKey];
          if (typeof metric === 'object') {
            const val = metric.value != null ? metric.value : 
                        (metric.value_deg != null ? metric.value_deg : 
                        (metric.value_cm != null ? metric.value_cm : null));
            if (val != null && !isNaN(val) && isFinite(val)) {
              return Number(val);
            }
          } else if (typeof metric === 'number' && !isNaN(metric) && isFinite(metric)) {
            return Number(metric);
          }
        }
      }
      return null;
    };
    
    const beforeValue = getValue(beforeMetrics, possibleKeys);
    const afterValue = getValue(afterMetrics, possibleKeys);
    
    // âœ… í˜„ì¬ ì„¸ì…˜ë„ í™•ì¸ (Before/Afterê°€ ì—†ì„ ë•Œ)
    if (beforeValue == null && afterValue == null) {
      const currentMetrics = sessions[cur]?.metrics?.fullMetrics || {};
      const currentValue = getValue(currentMetrics, possibleKeys);
      if (currentValue != null) {
        return { before: null, after: currentValue };
      }
    }
    
    return {
      before: beforeValue,
      after: afterValue
    };
  };

  const lines = [];
  lines.push('â–¶ ì „ì‹  ì •ë ¬ ì¢…í•© ì†Œê²¬');
  lines.push('- ë³¸ ë¶„ì„ì€ ë¨¸ë¦¬-ì–´ê¹¨-ê³¨ë°˜-í•˜ì§€ì˜ ì„ í˜• ì •ë ¬ê³¼ ë¶„ì ˆ ê°ë„ë¥¼ ì¢…í•© í‰ê°€í•˜ë©°, ì§€í‘œëŠ” ì„ìƒ ì •ìƒë²”ìœ„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•´ì„ë©ë‹ˆë‹¤.');
  lines.push('- ìš´ë™ ì²˜ë°©ì€ ê³¼ì‚¬ìš©/ì €ì‚¬ìš© ê·¼ìœ¡ì˜ ê· í˜• íšŒë³µê³¼ ì‹ ê²½ê·¼ ì¬êµìœ¡ì„ ëª©í‘œë¡œ êµ¬ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n');

  const seq = [
    { k:'CVA',  name:'CVA(ë‘ê°œê²½ì¶”ê°)', unit:'Â°',     fn:NORMAL_RANGE.CVA },
    { k:'HPD',  name:'HPD(ë‘ë¶€ ì „ë°©ì´ë™)', unit:'cm',  fn:NORMAL_RANGE.HPD },
    { k:'TIA',  name:'TIA(ì²´ê°„ê²½ì‚¬ê°)', unit:'Â°',      fn:NORMAL_RANGE.TIA },
    { k:'SAA',  name:'SAA(ì–´ê¹¨ ì „ë°©ê°)', unit:'Â°',     fn:NORMAL_RANGE.SAA },
    { k:'PTA',  name:'PTA(ê³¨ë°˜ ì „í›„ê²½ì‚¬)', unit:'Â°',   fn:NORMAL_RANGE.PTA },
    { k:'KA',   name:'KA(ë¬´ë¦ê°)', unit:'Â°',           fn:NORMAL_RANGE.KA },
    { k:'Tibial_Angle', name:'Tibial(ê²½ê³¨ ê²½ì‚¬ê°)', unit:'Â°', fn:NORMAL_RANGE.Tibial_Angle },
    { k:'GSB',  name:'GSB(ì¤‘ë ¥ì¤‘ì‹¬ì„  í¸ì°¨)', unit:'cm', fn:NORMAL_RANGE.GSB },
    { k:'HPA',  name:'HPA(ë¨¸ë¦¬-ê³¨ë°˜ ê°)', unit:'Â°',    fn:NORMAL_RANGE.HPA },
  ];

  // âœ… DBì—ì„œ ê° ì§€í‘œë³„ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  seq.forEach(s => {
    const {before, after} = getMetricValue(s.k);
    const currentValue = after != null ? after : before;
    const vStr = x => {
      if (x == null || x === undefined || isNaN(x)) return '-';
      return `${Number(x).toFixed(2)}${s.unit}`;
    };
    const parts = [];
    const beforeStr = vStr(before);
    const afterStr = vStr(after);
    parts.push(`- ${s.name}: ${beforeStr} â†’ ${afterStr}`);
    
    // âœ… DB ê¸°ë°˜ ìƒì„¸ í•´ì„ ì¶”ê°€
    if (currentValue != null && !isNaN(currentValue)) {
      // ì •ìƒ ë²”ìœ„ í™•ì¸
      if (typeof s.fn === 'function') {
        try {
        const ok = s.fn(currentValue);
        parts.push(`  Â· í•´ì„: ${ok ? 'ì •ìƒ ë²”ìœ„' : 'ì •ìƒ ë²”ìœ„ ì´íƒˆ'}`);
        } catch (e) {
          console.warn(`ì •ìƒ ë²”ìœ„ í™•ì¸ ì‹¤íŒ¨ (${s.k}):`, e);
        }
      }
      
      // DBì—ì„œ í•´ë‹¹ ì§€í‘œì˜ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      try {
      const abnormal = classifyAbnormalType(s.k, currentValue, NORMAL_TEXT[s.k] || '');
      const dbItems = POSTURE_DB.filter(r => {
        const dbCode = String(r['ì§€í‘œì½”ë“œ'] || '').toUpperCase();
        const dbAbnormal = String(r['ì´ìƒìœ í˜•'] || '');
        return dbCode === s.k.toUpperCase() && dbAbnormal.includes(abnormal);
      });
      
      if(dbItems.length > 0) {
        const dbItem = dbItems[0]; // ì²« ë²ˆì§¸ ë§¤ì¹­ í•­ëª© ì‚¬ìš©
        if(dbItem['ì›ì¸']) {
          parts.push(`  Â· ì›ì¸: ${dbItem['ì›ì¸']}`);
        }
        if(dbItem['ì¦ìƒ']) {
          parts.push(`  Â· ì¦ìƒ: ${dbItem['ì¦ìƒ']}`);
        }
        if(dbItem['ì„ìƒì ì˜ë¯¸']) {
          parts.push(`  Â· ì„ìƒì  ì˜ë¯¸: ${dbItem['ì„ìƒì ì˜ë¯¸']}`);
        }
        if(dbItem['ê¸´ì¥ê·¼ìœ¡(ì£¼ìš”)']) {
          parts.push(`  Â· ê¸´ì¥ëœ ê·¼ìœ¡: ${dbItem['ê¸´ì¥ê·¼ìœ¡(ì£¼ìš”)']}`);
        }
        if(dbItem['ì•½í™”ê·¼ìœ¡(ì£¼ìš”)']) {
          parts.push(`  Â· ì•½í™”ëœ ê·¼ìœ¡: ${dbItem['ì•½í™”ê·¼ìœ¡(ì£¼ìš”)']}`);
        }
        if(dbItem['êµì •ìš´ë™(ë„ìˆ˜/ìê°€)']) {
          parts.push(`  Â· êµì • ìš´ë™: ${dbItem['êµì •ìš´ë™(ë„ìˆ˜/ìê°€)']}`);
        }
        }
      } catch (e) {
        console.warn(`DB ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ (${s.k}):`, e);
      }
    }
    
    if (before != null && after != null && !isNaN(before) && !isNaN(after)) {
      const d = +(after - before).toFixed(2);
      if (Math.abs(d) >= 0.1) {
        const sign = d > 0 ? 'ì¦ê°€' : 'ê°ì†Œ';
        // ê°œì„ /ì•…í™” íŒë‹¨ ë¡œì§ ê°œì„ 
        let improvement = 'ë³€í™”';
        if (s.k === 'CVA') {
          improvement = d > 0 ? 'ê°œì„ ' : 'ì•…í™”'; // CVAëŠ” ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ
        } else if (s.k === 'PTA') {
          // PTAëŠ” 0-15ë„ê°€ ì •ìƒì´ë¯€ë¡œ, ì •ìƒ ë²”ìœ„ë¡œ ê°€ê¹Œì›Œì§€ë©´ ê°œì„ 
          const beforeOk = before >= 0 && before <= 15;
          const afterOk = after >= 0 && after <= 15;
          if (!beforeOk && afterOk) improvement = 'ê°œì„ ';
          else if (beforeOk && !afterOk) improvement = 'ì•…í™”';
          else if (Math.abs(after - 7.5) < Math.abs(before - 7.5)) improvement = 'ê°œì„ ';
          else if (Math.abs(after - 7.5) > Math.abs(before - 7.5)) improvement = 'ì•…í™”';
        } else if (['HPD', 'TIA', 'SAA', 'GSB'].includes(s.k)) {
          improvement = d < 0 ? 'ê°œì„ ' : 'ì•…í™”'; // ì‘ì„ìˆ˜ë¡ ì¢‹ìŒ
        } else if (['KA', 'Tibial_Angle', 'HPA'].includes(s.k)) {
          // ê° ì§€í‘œì˜ ì •ìƒ ë²”ìœ„ì— ë”°ë¼ íŒë‹¨
          improvement = 'ë³€í™”';
        }
        parts.push(`  Â· ë³€í™”: ${Math.abs(d)}${s.unit} ${sign} (${improvement})`);
      } else {
        parts.push(`  Â· ë³€í™”: ìœ ì˜ë¯¸í•œ ë³€í™” ì—†ìŒ`);
      }
    } else if (before == null && after != null && !isNaN(after)) {
      parts.push(`  Â· í˜„ì¬ ì¸¡ì •ê°’: ${after.toFixed(2)}${s.unit}`);
    } else if (before != null && after == null && !isNaN(before)) {
      parts.push(`  Â· Before ì¸¡ì •ê°’: ${before.toFixed(2)}${s.unit} (After ì¸¡ì • ì—†ìŒ)`);
    }
    lines.push(parts.join('\n'));
  });

  // âœ… íŒ¨í„´ ìš”ì•½ (DB ê¸°ë°˜)
  const pats = detectPatterns(metrics);
  lines.push('\nâ–¶ íŒ¨í„´ ìš”ì•½');
  if(pats.length) {
    lines.push(`- ê´€ì°°ëœ ì£¼ìš” íŒ¨í„´: ${pats.map(p => PILATES_PATTERN_DB[p]?.title || p).join(', ')}`);
    // ê° íŒ¨í„´ë³„ ìƒì„¸ ì„¤ëª… ì¶”ê°€
    pats.forEach(p => {
      const dbItem = POSTURE_DB.find(r => {
        const dbTitle = String(r['ì§€í‘œëª…'] || '').toLowerCase();
        const patternTitle = (PILATES_PATTERN_DB[p]?.title || p).toLowerCase();
        return dbTitle.includes(patternTitle) || patternTitle.includes(dbTitle);
      });
      if(dbItem) {
        if(dbItem['ì›ì¸']) lines.push(`  Â· ${PILATES_PATTERN_DB[p]?.title || p} ì›ì¸: ${dbItem['ì›ì¸']}`);
        if(dbItem['ì¦ìƒ']) lines.push(`  Â· ${PILATES_PATTERN_DB[p]?.title || p} ì¦ìƒ: ${dbItem['ì¦ìƒ']}`);
      }
    });
  } else {
    lines.push('- íŠ¹ì´ íŒ¨í„´ ì—†ìŒ(ê¸°ë³¸ ì•ˆì •í™” ê¶Œì¥)');
  }

  // âœ… ì„ìƒì  ê¶Œê³  (ìƒì„¸)
  lines.push('\nâ–¶ ì„ìƒì  ê¶Œê³ ');
  lines.push('- 2~4ì£¼ ê°„ ì£¼ 2~3íšŒ, ê° ì„¸ì…˜ 30~45ë¶„. í†µì¦ 0~2/10 ë²”ìœ„ ìœ ì§€.');
  lines.push('- "ì •ë ¬â†’ê°€ë™ì„±â†’ê·¼ì§€êµ¬ë ¥â†’ê¸°ëŠ¥ í†µí•©" ìˆœì„œë¡œ ì§„í–‰.');
  lines.push('- ì¼ìƒ ìì„¸ íŒ: ìŠ¤í¬ë¦° ëˆˆë†’ì´ ì¡°ì ˆ, 30~40ë¶„ë§ˆë‹¤ 30ì´ˆ ë¦¬ì…‹ ìŠ¤íŠ¸ë ˆì¹­, ì¥ì‹œê°„ ì„œê¸°/ì•‰ê¸° ì‹œ ê³¨ë°˜ ì¤‘ë¦½ ì²´í¬.');
  lines.push('- í˜¸í¡: ìš´ë™ ì¤‘ "ê¸¸ê²Œ ë“¤ì´ì‰¬ê³  ê¸¸ê²Œ ë‚´ì‰¬ê¸°"ë¥¼ ìœ ì§€í•˜ì—¬ ì½”ì–´ ì•ˆì •ì„±ì„ ë†’ì…ë‹ˆë‹¤.');
  lines.push('- ì§„í–‰ ìˆœì„œ: â‘  ì›Œë°ì—…(5ë¶„) â†’ â‘¡ ìŠ¤íŠ¸ë ˆì¹­(10ë¶„) â†’ â‘¢ ê°•í™” ìš´ë™(20ë¶„) â†’ â‘£ ì¿¨ë‹¤ìš´(5ë¶„)');
  lines.push('- ì£¼ì˜ì‚¬í•­: í†µì¦ì´ 3/10 ì´ìƒì´ë©´ ìš´ë™ì„ ì¤‘ë‹¨í•˜ê³  ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì„¸ìš”.');

  return lines.join('\n');
}

function buildPlanTexts({ memberName = 'íšŒì›', patterns = [], scoreResult = null, analysis = {}, comparisonSummary = '' }) {
  const uniquePatterns = Array.from(new Set((patterns || []).filter(Boolean)));
  const tightHighlight = Array.isArray(analysis?.tight) ? analysis.tight.filter(Boolean).slice(0, 3).join(', ') : '';
  const weakHighlight = Array.isArray(analysis?.weak) ? analysis.weak.filter(Boolean).slice(0, 3).join(', ') : '';
  const quickItems = [];
  if (comparisonSummary) quickItems.push(comparisonSummary);
  if (tightHighlight) quickItems.push(`ê¸´ì¥ ê·¼ìœ¡ ì´ì™„: ${tightHighlight} ì¤‘ì‹¬ìœ¼ë¡œ í¼ë¡¤ëŸ¬ Â· ì •ì  ìŠ¤íŠ¸ë ˆì¹­ 10~15ë¶„`);
  if (weakHighlight) quickItems.push(`ì•½í™” ê·¼ìœ¡ í™œì„±í™”: ${weakHighlight} ì¤‘ì‹¬ì˜ ì½”ì–´/ë‘”ê·¼ ê°•í™” 8~12íšŒ Ã— 2~3ì„¸íŠ¸`);
  quickItems.push('í•„ë¼í…ŒìŠ¤ ë£¨í‹´(ë‹¤ìŒ í˜ì´ì§€)ì„ ì£¼ 3íšŒ ì´ìƒ ì‹¤í–‰í•˜ì—¬ ì •ë ¬ íŒ¨í„´ì„ ì¬êµìœ¡í•©ë‹ˆë‹¤.');
  if (scoreResult?.score != null) {
    if (scoreResult.score < 70) {
      quickItems.push(`ì²´í˜• ì ìˆ˜ ${scoreResult.score}ì  â†’ 6ì£¼ ì§‘ì¤‘ êµì •ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
    } else if (scoreResult.score < 85) {
      quickItems.push(`ì²´í˜• ì ìˆ˜ ${scoreResult.score}ì  â†’ ì¤‘ê¸° ê°•ë„ì˜ ê·¼ë ¥/ê°€ë™ì„± ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
    } else {
      quickItems.push(`ì²´í˜• ì ìˆ˜ ${scoreResult.score}ì  â†’ í˜„ì¬ ì •ë ¬ì„ ìœ ì§€í•˜ë©° ì‹¬í™” ë£¨í‹´ì„ ì§„í–‰í•©ë‹ˆë‹¤.`);
    }
  }
  const quickHtml = quickItems.length
    ? `<ul style="margin:0; padding-left:18px; font-size:11px; line-height:1.7; color:#1f2937;">${quickItems.map(item => `<li style="margin-bottom:4px;">${escapeHtml(item)}</li>`).join('')}</ul>`
    : `<div style="font-size:11px; color:#475569;">ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìì„¸ ì¸¡ì •ì„ ì™„ë£Œí•œ ë’¤ ë‹¤ì‹œ ìƒì„±í•´ì£¼ì„¸ìš”.</div>`;

  let fullText = `${memberName}ë‹˜ì˜ ê²€ì‚¬ ê²°ê³¼ì™€ AI ë¶„ì„ì„ ì¢…í•©í•´ë³´ë©´, ê´€ì°°ëœ ì£¼ìš” íŒ¨í„´ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n\n`;
  if (uniquePatterns.length > 0) {
    uniquePatterns.forEach((pattern, idx) => {
      fullText += `${idx + 1}. ${pattern}\n`;
    });
  } else {
    fullText += 'íŠ¹ì´ íŒ¨í„´ ì—†ìŒ\n';
  }
  fullText += '\n';
  if (comparisonSummary) {
    fullText += `${comparisonSummary}\n\n`;
  }
  fullText += 'ìœ„ íŒ¨í„´ì€ íŠ¹ì • ê·¼ìœ¡êµ°ì˜ ê¸´ì¥(ì§§ì•„ì§)ê³¼ ì•½í™”(ì•½í•´ì§)ì´ ë™ë°˜ë˜ëŠ” ì „í˜•ì ì¸ ì„ìƒ ì†Œê²¬ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¶Œì¥ì‚¬í•­ì„ ì¼ê´€ë˜ê²Œ 6~12ì£¼ ë™ì•ˆ ì ìš©í•˜ë©´ ì¦ìƒ ì™„í™”ì™€ ìì„¸ ê°œì„ ì´ ê¸°ëŒ€ë©ë‹ˆë‹¤.\n\n';
  fullText += 'ã€ë‹¨ê¸°(1~4ì£¼)ã€‘\n';
  fullText += '1. ê¸´ì¥ ê·¼ìœ¡ ì´ì™„ ì¤‘ì‹¬(í¼ë¡¤ëŸ¬, ê·¼ë§‰ ì´ì™„, ì •ì  ìŠ¤íŠ¸ë ˆì¹­) â€” í•˜ë£¨ 1íšŒ 10~15ë¶„\n';
  fullText += '2. í˜¸í¡ ì¡°ì ˆê³¼ í•¨ê»˜í•˜ëŠ” ì½”ì–´ ê¸°ë³¸ìš´ë™ (Dead Bug, Pelvic Tilt) â€” ë§¤ì¼ 5~10ë¶„\n';
  fullText += '3. ì¼ìƒ ìƒí™œì—ì„œì˜ ìì„¸ ë¦¬ì…‹(30~40ë¶„ë§ˆë‹¤) â€” ìŠµê´€í™”\n\n';
  fullText += 'ã€ì¤‘ê¸°(4~8ì£¼)ã€‘\n';
  fullText += '1. ì•½í™” ê·¼ìœ¡ í™œì„±í™” (ë‘”ê·¼, ë³µíš¡ê·¼ ë“±) â€” ì£¼ 3íšŒ, ì ì§„ì  ë¶€í•˜\n';
  fullText += '2. í•„ë¼í…ŒìŠ¤ ê¸°êµ¬ ìš´ë™ì„ í¬í•¨í•œ í†µí•© í”„ë¡œê·¸ë¨ â€” ì£¼ 2~3íšŒ\n';
  fullText += '3. ì •ê¸° ì¬í‰ê°€ë¡œ í”„ë¡œê·¸ë¨ ì¡°ì • (3~4ì£¼ë§ˆë‹¤)\n\n';
  fullText += 'ã€ì¥ê¸°(8~12ì£¼ ì´ìƒ)ã€‘\n';
  fullText += 'í†µí•©ì  ê¸°ëŠ¥ íšŒë³µì„ ëª©í‘œë¡œ ì¼ìƒí™” ë° ìš´ë™ê°•ë„ ì¦ì§„ì„ ê¶Œì¥í•©ë‹ˆë‹¤. ê·¼ë ¥, ìœ ì—°ì„±, ì‹ ê²½ê·¼ ì œì–´ê°€ ëª¨ë‘ ê°œì„ ë˜ë©´ ìì„¸ ê°œì„  íš¨ê³¼ëŠ” ì¥ê¸°ì ìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.\n\n';
  if (scoreResult?.score != null) {
    const score = scoreResult.score;
    if (score < 70) {
      fullText += `í˜„ì¬ ì²´í˜• ì¢…í•© ì ìˆ˜ê°€ ${score}ì ìœ¼ë¡œ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤. ìœ„ì˜ ë‹¨ê¸° ê¶Œì¥ì‚¬í•­ë¶€í„° ê¾¸ì¤€íˆ ì‹¤ì‹œí•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n`;
    } else if (score < 85) {
      fullText += `í˜„ì¬ ì²´í˜• ì¢…í•© ì ìˆ˜ê°€ ${score}ì ìœ¼ë¡œ ì–‘í˜¸í•œ í¸ì…ë‹ˆë‹¤. ì¤‘ê¸° ê¶Œì¥ì‚¬í•­ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ì†ì ì¸ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\n`;
    } else {
      fullText += `í˜„ì¬ ì²´í˜• ì¢…í•© ì ìˆ˜ê°€ ${score}ì ìœ¼ë¡œ ìš°ìˆ˜í•©ë‹ˆë‹¤. ì¥ê¸° ê¶Œì¥ì‚¬í•­ì„ í†µí•´ í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ê³  ë”ìš± ê°œì„ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n`;
    }
  }
  fullText += '"ìš°ë¦¬ëŠ” ê±±ì • ëŒ€ì‹  ê·¼ê±°(ë°ì´í„°)ë¡œ ì›€ì§ì…ë‹ˆë‹¤."';

  return {
    quickHtml,
    fullText: fullText.trim()
  };
}

function buildBeforeAfterSummaryHTML(comparison) {
  if (!comparison || !Array.isArray(comparison.results) || comparison.results.length === 0) {
    return '<div style="font-size:11px; color:#475569; line-height:1.6;">Before-After ë¹„êµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
  }
  const improved = comparison.results.filter(r => r.status === 'improved').length;
  const worsened = comparison.results.filter(r => r.status === 'worsened').length;
  const maintained = comparison.results.filter(r => r.status === 'maintained').length;
  const stats = [
    { label: 'ê°œì„ ', value: improved, color: '#16a34a' },
    { label: 'ìœ ì§€', value: maintained, color: '#2563eb' },
    { label: 'ì£¼ì˜', value: worsened, color: '#dc2626' }
  ];
  const statsHtml = `<div style="display:flex; flex-wrap:wrap; gap:8px;">${stats.map(stat => `
    <div style="flex:1 1 90px; min-width:90px; padding:10px; border-radius:10px; background:rgba(0,0,0,0.03); border:1px solid rgba(0,0,0,0.05); text-align:center;">
      <div style="font-size:12px; color:${stat.color}; font-weight:600;">${stat.label}</div>
      <div style="font-size:20px; font-weight:700; color:#0b0f14;">${stat.value}</div>
    </div>`).join('')}</div>`;

  const summaryText = comparison.summary?.overallComment
    ? `<div style="margin-top:12px; font-size:11px; color:#1f2937; line-height:1.6;">${escapeHtml(comparison.summary.overallComment)}</div>`
    : '';

  const topChanges = [...comparison.results]
    .sort((a, b) => Math.abs(b.delta || 0) - Math.abs(a.delta || 0))
    .slice(0, 4)
    .map(item => {
      const decimals = item.unit === 'ì ' ? 2 : 1;
      const before = item.before != null ? item.before.toFixed(decimals) : '-';
      const after = item.after != null ? item.after.toFixed(decimals) : '-';
      const delta = item.delta != null ? `${item.delta >= 0 ? '+' : ''}${item.delta.toFixed(decimals)}${item.unit}` : '';
      const comment = item.comment ? `<div style="color:#475569; margin-top:2px;">${escapeHtml(item.comment)}</div>` : '';
      return `<li style="margin-bottom:6px;"><strong>${escapeHtml(item.name)}</strong> : ${before}${item.unit} â†’ ${after}${item.unit} (${delta})${comment}</li>`;
    });

  const topChangesHtml = topChanges.length
    ? `<div style="margin-top:14px;">
        <div style="font-size:11px; font-weight:600; color:#111827; margin-bottom:6px;">ë³€í™” í­ì´ í° ì§€í‘œ</div>
        <ul style="margin:0; padding-left:18px; font-size:11px; color:#0f172a; line-height:1.5;">${topChanges.join('')}</ul>
      </div>`
    : '';

  return `<div style="margin-bottom:18px;">${statsHtml}${summaryText}${topChangesHtml}</div>`;
}

// ========== 100ì¢… DB ê¸°ë°˜ ê·œì¹™ ì—”ì§„ ==========

/**********************
 * 100ì¢… DB ë¡œë” (ìºì‹œ ë°©ì‹)
 **********************/
let POSTURE_DB = [];
let POSTURE_DB_MAP = Object.create(null);
let PILATES_EXERCISE_DB = []; // âœ… í•„ë¼í…ŒìŠ¤ ìš´ë™ DB ì¶”ê°€ (Pilates_Exercise_DB_1000_v2.json)
let postureDBCache = null;
let pilatesDBCache = null;
const pilatesExerciseDetailMapEn = Object.create(null);
const pilatesExerciseDetailMapKo = Object.create(null);

function registerPilatesExerciseDetails(entries) {
  if (!Array.isArray(entries)) return;
  entries.forEach(item => {
    if (!item) return;
    const keyEn = (item.exercise_en || '').trim().toLowerCase();
    const keyKo = (item.exercise_ko || '').trim().toLowerCase();
    if (keyEn) {
      pilatesExerciseDetailMapEn[keyEn] = item;
    }
    if (keyKo) {
      pilatesExerciseDetailMapKo[keyKo] = item;
    }
  });
}

function getPilatesExerciseDetail(exerciseEn, exerciseKo) {
  if (exerciseEn) {
    const found = pilatesExerciseDetailMapEn[exerciseEn.trim().toLowerCase()];
    if (found) return found;
  }
  if (exerciseKo) {
    const found = pilatesExerciseDetailMapKo[exerciseKo.trim().toLowerCase()];
    if (found) return found;
  }
  return null;
}

function formatMultilineText(text) {
  if (!text) return '';
  return escapeHtml(text).replace(/\n/g, '<br>');
}

const PILATES_EQUIPMENT_LIST = ['ë§¤íŠ¸', 'ë¦¬í¬ë¨¸', 'ìºë”œë½', 'ì²´ì–´', 'ë°”ë '];
const REPORT_SIGNATURE = 'created by Kim Cook (@pila_strong)';
const REPORT_METRIC_RANGE = {
  'CVA(ë‘ê°œê²½ì¶”ê°)': [50, 90],
  'HPD(ë‘ë¶€ì „ë°©ì´ë™)': [0, 2],
  'TIA(ì²´ê°„ê²½ì‚¬ê°)': [0, 10],
  'SAA(ì–´ê¹¨ì „ë°©ê°)': [0, 10],
  'PTA(ê³¨ë°˜ê²½ì‚¬ê°)': [0, 15],
  'KA(ë¬´ë¦ê°)': [175, 185],
  'Tibial(ê²½ê³¨ê²½ì‚¬ê°)': [0, 10],
  'GSB(ì¤‘ì‹¬ì„ )': [0, 2],
  'HPA(ë¨¸ë¦¬-ê³¨ë°˜ê°)': [0, 10]
};

function chartOutOfRange(metricName = '', value = null) {
  if (value == null || Number.isNaN(value)) return false;
  const label = (metricName || '').replace(/\s+/g, '');
  const key = Object.keys(REPORT_METRIC_RANGE).find((k) => label.includes(k.replace(/[()\s]/g, '')));
  if (!key) return false;
  const [min, max] = REPORT_METRIC_RANGE[key];
  return value < min || value > max;
}

function escapeHtml(value) {
  if (value == null) return '';
  return String(value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

function escapeAttr(value) {
  return escapeHtml(value).replace(/"/g, '&quot;');
}

function normalizeExerciseEntry(entry) {
  if (!entry) return null;
  if (typeof entry === 'string') {
    return { name: entry };
  }
  // âœ… ì›ë³¸ entryë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬ (ì›ë³¸ í•„ë“œëª… ë³´ì¡´)
  const normalized = { ...entry };
  if (!normalized.name) {
    normalized.name = normalized.exercise_ko || normalized.exercise_en || normalized.Exercise_Name_KR || normalized.Exercise_Name_EN || normalized.en || normalized.ko || '';
  }
  if (!normalized.en && normalized.exercise_en) normalized.en = normalized.exercise_en;
  if (!normalized.en && normalized.Exercise_Name_EN) normalized.en = normalized.Exercise_Name_EN;
  if (!normalized.ko && normalized.exercise_ko) normalized.ko = normalized.exercise_ko;
  if (!normalized.ko && normalized.Exercise_Name_KR) normalized.ko = normalized.Exercise_Name_KR;
  // âœ… CSV DBì˜ ìš´ë™ ì„¤ëª… í•„ë“œ ë§¤í•‘ (í•„ë¼í…ŒìŠ¤ DB ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
  // How_to_Perform_Step_by_Stepì„ ìš°ì„  ì‚¬ìš© (í‘œì¤€í™”ëœ 10ê°œ ì»¬ëŸ¼ êµ¬ì¡°)
  if (!normalized.how && normalized['How_to_Perform_Step_by_Step (ìƒì„¸ ë™ì‘ ì„¤ëª…)']) normalized.how = normalized['How_to_Perform_Step_by_Step (ìƒì„¸ ë™ì‘ ì„¤ëª…)'];
  if (!normalized.how && normalized['How_to_Perform_Step_by_Step']) normalized.how = normalized['How_to_Perform_Step_by_Step'];
  if (!normalized.how && normalized.How_to_Perform_Step_by_Step) normalized.how = normalized.How_to_Perform_Step_by_Step;
  // í•˜ìœ„ í˜¸í™˜ì„±: ì´ì „ í•„ë“œëª…ë„ í™•ì¸
  if (!normalized.how && normalized['How_to_Perform_EASY_FOR_BEGINNERS (ìƒì„¸ ë™ì‘ ì„¤ëª…)']) normalized.how = normalized['How_to_Perform_EASY_FOR_BEGINNERS (ìƒì„¸ ë™ì‘ ì„¤ëª…)'];
  if (!normalized.how && normalized.How_to_Perform_EASY_FOR_BEGINNERS) normalized.how = normalized.How_to_Perform_EASY_FOR_BEGINNERS;
  // ìµœì¢… í´ë°±
  if (!normalized.how && normalized.how_to_do) normalized.how = normalized.how_to_do;
  if (!normalized.how && normalized.How_to_Perform) normalized.how = normalized.How_to_Perform;
  // âœ… ëª©ì  (ê°•í™”/ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡ ì •ë³´) - í•˜ìœ„ í˜¸í™˜ì„±ìš©
  if (!normalized.purpose && normalized.description) normalized.purpose = normalized.description;
  // âœ… ì„¸íŠ¸/ë°˜ë³µ - í•˜ìœ„ í˜¸í™˜ì„±ìš©
  if (!normalized.sets_reps && normalized.reps) normalized.sets_reps = normalized.reps;
  if (!normalized.sets_reps && normalized.Reps) normalized.sets_reps = normalized.Reps;
  // âœ… í•µì‹¬ í - í•˜ìœ„ í˜¸í™˜ì„±ìš© (ì›ë³¸ Classical_Cues_by_Jay_Grimes_RomanaëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)
  if (!normalized.key_cues && normalized.Classical_Cues_by_Jay_Grimes_Romana) normalized.key_cues = normalized.Classical_Cues_by_Jay_Grimes_Romana;
  // âœ… ìŠ¤í”„ë§ - í•˜ìœ„ í˜¸í™˜ì„±ìš© (ì›ë³¸ Spring_Traditionalì€ ê·¸ëŒ€ë¡œ ìœ ì§€)
  if (!normalized.spring && normalized.Spring_Traditional) normalized.spring = normalized.Spring_Traditional;
  if (!normalized.spring && normalized.Spring) normalized.spring = normalized.Spring;
  // âœ… ê°•í™”/ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡ - í•˜ìœ„ í˜¸í™˜ì„±ìš© (ì›ë³¸ í•„ë“œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)
  if (!normalized.strengthen_muscles && normalized.Main_Strengthen_Muscles) normalized.strengthen_muscles = normalized.Main_Strengthen_Muscles;
  if (!normalized.strengthen_muscles && normalized['Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)']) normalized.strengthen_muscles = normalized['Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)'];
  if (!normalized.stretch_muscles && normalized.Main_Stretch_Muscles) normalized.stretch_muscles = normalized.Main_Stretch_Muscles;
  if (!normalized.stretch_muscles && normalized['Main_Stretch_Muscles (ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡)']) normalized.stretch_muscles = normalized['Main_Stretch_Muscles (ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡)'];
  // âœ… ì£¼ì˜ì‚¬í•­
  if (!normalized.precaution && normalized.warning) normalized.precaution = normalized.warning;
  return normalized;
}

function getExerciseDetailInfo(entry) {
  const normalized = normalizeExerciseEntry(entry) || {};
  const en = normalized.en || normalized.exercise_en || normalized.name || '';
  const ko = normalized.ko || normalized.exercise_ko || '';
  const detail = getPilatesExerciseDetail(en, ko);
  const titleEn = detail?.exercise_en || normalized.exercise_en || normalized.en || '';
  const titleKo = detail?.exercise_ko || normalized.exercise_ko || normalized.ko || '';
  let title = normalized.name || titleEn || titleKo || 'Pilates Exercise';
  if (titleEn && titleKo && titleEn !== titleKo) {
    title = `${titleEn} (${titleKo})`;
  } else if (titleKo && !title.includes(titleKo)) {
    title = `${title} (${titleKo})`;
  }
  
  // âœ… ê¸°êµ¬ ì •ë³´ í™•ì¸ (ë¦¬í¬ë¨¸ëŠ” ë‹¤ë¥¸ í•„ë“œëª… ì‚¬ìš©)
  const equipment = normalized.equipment || normalized.equipment_ko || '';
  const isReformer = equipment === 'ë¦¬í¬ë¨¸' || equipment === 'Reformer';
  
  // âœ… CSV DBì˜ ê°•í™”/ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡ ì •ë³´ (ì›ë³¸ ë°ì´í„° ìš°ì„ , ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš° ì œì™¸)
  const strengthenMusclesRaw = normalized['Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)'] || 
                                normalized.Main_Strengthen_Muscles ||
                                normalized.strengthen_muscles || 
                                (normalized.strengthen_targets ? normalized.strengthen_targets.join(', ') : '') ||
                                detail?.['Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)'] ||
                                detail?.Main_Strengthen_Muscles ||
                                detail?.strengthen_muscles ||
                                '';
  const strengthenMuscles = (typeof strengthenMusclesRaw === 'string' && strengthenMusclesRaw.trim()) ? strengthenMusclesRaw.trim() : '';
  
  const stretchMusclesRaw = normalized['Main_Stretch_Muscles (ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡)'] || 
                            normalized.Main_Stretch_Muscles ||
                            normalized.stretch_muscles || 
                            (normalized.stretch_targets ? normalized.stretch_targets.join(', ') : '') ||
                            detail?.['Main_Stretch_Muscles (ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡)'] ||
                            detail?.Main_Stretch_Muscles ||
                            detail?.stretch_muscles ||
                            '';
  const stretchMuscles = (typeof stretchMusclesRaw === 'string' && stretchMusclesRaw.trim()) ? stretchMusclesRaw.trim() : '';
  
  // âœ… ëª©ì : ê°•í™”/ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡ ì •ë³´ë¡œ ì¬ìƒì„± (CSV ì›ë³¸ ë°ì´í„° ì‚¬ìš©)
  let purpose = '';
  if (strengthenMuscles || stretchMuscles) {
    purpose = strengthenMuscles 
      ? `ê°•í™”: ${strengthenMuscles}${stretchMuscles ? ` / ìŠ¤íŠ¸ë ˆì¹­: ${stretchMuscles}` : ''}`
      : (stretchMuscles ? `ìŠ¤íŠ¸ë ˆì¹­: ${stretchMuscles}` : '');
  } else {
    purpose = detail?.purpose || normalized.purpose || '';
  }
  
  // âœ… ìš´ë™ ì„¤ëª…: í•„ë¼í…ŒìŠ¤ DBì˜ How_to_Perform_Step_by_Step í•„ë“œë¥¼ ë¬´ì¡°ê±´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  // ëª¨ë“  ê¸°êµ¬ì—ì„œ ë™ì¼í•œ í•„ë“œëª… ì‚¬ìš© (í‘œì¤€í™”ëœ 10ê°œ ì»¬ëŸ¼ êµ¬ì¡°)
  // âœ… í•„ë“œê°’ ê²€ì¦: ìš´ë™ ì„¤ëª…ì€ ìµœì†Œ 20ì ì´ìƒì´ì–´ì•¼ í•˜ê³ , "ì¤€ë¹„", "ì‹œì‘", "1.", "2." ê°™ì€ íŒ¨í„´ì´ í¬í•¨ë˜ì–´ì•¼ í•¨
  // ê·¼ìœ¡ ì´ë¦„(ì˜ˆ: "ì²™ì£¼ê¸°ë¦½ê·¼", "ëŒ€ë‘”ê·¼")ì´ë‚˜ ì§§ì€ í…ìŠ¤íŠ¸ëŠ” ì œì™¸
  const isValidExerciseDescription = (value) => {
    if (!value || typeof value !== 'string') return false;
    const trimmed = value.trim();
    // ìµœì†Œ ê¸¸ì´ í™•ì¸
    if (trimmed.length < 20) return false;
    // ìš´ë™ ì„¤ëª… íŒ¨í„´ í™•ì¸ (ìˆ«ìë¡œ ì‹œì‘í•˜ê±°ë‚˜ "ì¤€ë¹„", "ì‹œì‘" ê°™ì€ í‚¤ì›Œë“œ í¬í•¨)
    if (!trimmed.match(/^[0-9]\.|ì¤€ë¹„|ì‹œì‘|ì„¸íŒ…|ë™ì‘|ì£¼ì˜|ì§‘ì¤‘|êµì°¨|ì‹ ì „|ë¡¤|í‚¥|ë°€ì–´|ëŒì–´|ì„œí´/i)) {
      // ê·¼ìœ¡ ì´ë¦„ íŒ¨í„´ ì œì™¸ (í•œê¸€ ê·¼ìœ¡ ì´ë¦„ì€ ë³´í†µ 2-4ì)
      if (trimmed.match(/^[ê°€-í£]{2,4}$|^[ê°€-í£]{2,4},?\s*[ê°€-í£]{2,4}$/)) return false;
    }
    return true;
  };
  
  let how = '';
  // How_to_Perform_Step_by_Step (ìƒì„¸ ë™ì‘ ì„¤ëª…) ìš°ì„  ì‚¬ìš© - ê²€ì¦ í¬í•¨
  const howFieldNames = [
    'How_to_Perform_Step_by_Step (ìƒì„¸ ë™ì‘ ì„¤ëª…)',
    'How_to_Perform_Step_by_Step',
    'How_to_Perform_Step_by_Step_FULL_CLASSICAL'
  ];
  
  for (const fieldName of howFieldNames) {
    const fieldValue = normalized[fieldName];
    if (fieldValue && isValidExerciseDescription(fieldValue)) {
      how = fieldValue.trim();
      break;
    }
  }
  
  // í´ë°±: Step_by_Stepì´ ì—†ìœ¼ë©´ ë‹¤ë¥¸ í•„ë“œ í™•ì¸ (í•˜ìœ„ í˜¸í™˜ì„±)
  if (!how) {
    // ë¦¬í¬ë¨¸ì˜ ê²½ìš° ì´ì „ í•„ë“œëª…ë„ í™•ì¸ (í•˜ìœ„ í˜¸í™˜ì„±)
    if (isReformer) {
      const easyFieldNames = [
        'How_to_Perform_EASY_FOR_BEGINNERS (ìƒì„¸ ë™ì‘ ì„¤ëª…)',
        'How_to_Perform_EASY_FOR_BEGINNERS'
      ];
      for (const fieldName of easyFieldNames) {
        const fieldValue = normalized[fieldName];
        if (fieldValue && isValidExerciseDescription(fieldValue)) {
          how = fieldValue.trim();
          break;
        }
      }
    }
    // ìµœì¢… í´ë°±
    if (!how) {
      const fallbackFields = ['How_to_Perform', 'how', 'how_to_do'];
      for (const fieldName of fallbackFields) {
        const fieldValue = normalized[fieldName] || detail?.[fieldName];
        if (fieldValue && isValidExerciseDescription(fieldValue)) {
          how = fieldValue.trim();
          break;
        }
      }
    }
  }
  
  // âœ… í•µì‹¬ í: Classical_Cues_by_Jay_Grimes_Romana í•„ë“œë§Œ ì‚¬ìš© (ë¬¸ìì—´ì¸ì§€ í™•ì¸)
  // âœ… ê°’ì´ ìˆ«ìë§Œ ìˆê±°ë‚˜ ìš´ë™ ì„¤ëª…ì´ë©´ ì œì™¸ (CSV íŒŒì‹± ì˜¤ë¥˜ ë°©ì§€)
  // âœ… ê·¼ìœ¡ ì´ë¦„ì´ ë“¤ì–´ê°€ë©´ ì œì™¸
  const cuesRaw = (normalized.Classical_Cues_by_Jay_Grimes_Romana && typeof normalized.Classical_Cues_by_Jay_Grimes_Romana === 'string' && normalized.Classical_Cues_by_Jay_Grimes_Romana.trim()) ||
               (normalized.key_cues && typeof normalized.key_cues === 'string' && normalized.key_cues.trim()) ||
               (normalized.cues && typeof normalized.cues === 'string' && normalized.cues.trim()) ||
               (detail?.key_cues && typeof detail.key_cues === 'string' && detail.key_cues.trim()) ||
               '';
  let cues = '';
  if (cuesRaw) {
    const cuesStr = cuesRaw.trim();
    // âœ… ê·¼ìœ¡ ì´ë¦„ íŒ¨í„´ ì œì™¸ (í•œê¸€ ê·¼ìœ¡ ì´ë¦„ì€ ë³´í†µ 2-4ì)
    if (cuesStr.match(/^[ê°€-í£]{2,4}$|^[ê°€-í£]{2,4},?\s*[ê°€-í£]{2,4}$/)) {
      cues = '';
    } else if (cuesStr.length < 50 &&
        !cuesStr.match(/^[\d\-\+\s]+$/) && // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° ì œì™¸
        !cuesStr.match(/^ì¤€ë¹„:|^ë‹¹ê¸°ê¸°:|^ëŒì•„ì˜¤ê¸°:|^ì£¼ì˜:|^1\.|^2\./i) && // ìš´ë™ ì„¤ëª… íŒ¨í„´ ì œì™¸
        (cuesStr.match(/["'"]|:|!|Grimes|Romana|Jay|Pilates/i) || cuesStr.length > 5)) { // ì¸ìš©êµ¬ë‚˜ ì´ë¦„ì´ í¬í•¨ë˜ì–´ì•¼ í•¨
      cues = cuesStr;
    }
  }
  
  // âœ… íšŸìˆ˜: Reps í•„ë“œë§Œ ì‚¬ìš© (ë¬¸ìì—´ ë˜ëŠ” ìˆ«ìì¸ì§€ í™•ì¸)
  // âœ… ê°’ì´ ìš´ë™ ì„¤ëª…ì²˜ëŸ¼ ê¸´ í…ìŠ¤íŠ¸ë©´ ì œì™¸ (CSV íŒŒì‹± ì˜¤ë¥˜ ë°©ì§€)
  // âœ… ê·¼ìœ¡ ì´ë¦„ì´ ë“¤ì–´ê°€ë©´ ì œì™¸ (ì˜ˆ: "ì „ë©´ ì‚¼ê°ê·¼", "ëŒ€ë‘”ê·¼" ë“±)
  const setsRaw = normalized.Reps || normalized.reps || normalized.sets_reps || detail?.sets_reps || detail?.reps || '';
  let sets = '';
  if (setsRaw) {
    const setsStr = String(setsRaw).trim();
    // âœ… ê·¼ìœ¡ ì´ë¦„ íŒ¨í„´ ì œì™¸ (í•œê¸€ ê·¼ìœ¡ ì´ë¦„ì€ ë³´í†µ 2-4ì, ì‰¼í‘œë¡œ êµ¬ë¶„)
    if (setsStr.match(/^[ê°€-í£]{2,4}$|^[ê°€-í£]{2,4},?\s*[ê°€-í£]{2,4}$|^[ê°€-í£]{2,4},?\s*[ê°€-í£]{2,4},?\s*[ê°€-í£]{2,4}$/)) {
      sets = '';
    } else if (setsStr.length < 50 && (setsStr.match(/^[\d\-\+\sÃ—Ã—]+$/) || setsStr.length < 20)) {
      // âœ… ìˆ«ì, ë²”ìœ„(ì˜ˆ: "6-8", "10", "3+3", "100"), ë˜ëŠ” ì§§ì€ í…ìŠ¤íŠ¸ë§Œ í—ˆìš©
      sets = setsStr;
    } else if (setsStr.length < 20 && !setsStr.match(/^[0-9]/)) {
      // 20ì ë¯¸ë§Œì´ê³  ìˆ«ìë¡œ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë©´ ì œì™¸ (ìš´ë™ ì„¤ëª…ì¼ ê°€ëŠ¥ì„±)
      sets = '';
    } else if (setsStr.length < 50) {
      sets = setsStr;
    }
  }
  
  // âœ… ìŠ¤í”„ë§: Spring_Traditional í•„ë“œë§Œ ì‚¬ìš© (ë¬¸ìì—´ì¸ì§€ í™•ì¸)
  // âœ… ê°’ì´ ê·¼ìœ¡ ì´ë¦„ì²˜ëŸ¼ ë³´ì´ë©´ ì œì™¸ (CSV íŒŒì‹± ì˜¤ë¥˜ ë°©ì§€)
  const springRaw = (normalized.Spring_Traditional && typeof normalized.Spring_Traditional === 'string' && normalized.Spring_Traditional.trim()) ||
                 (normalized.Spring && typeof normalized.Spring === 'string' && normalized.Spring.trim()) ||
                 (normalized.spring && typeof normalized.spring === 'string' && normalized.spring.trim()) ||
                 (detail?.spring && typeof detail.spring === 'string' && detail.spring.trim()) ||
                 '';
  let spring = '';
  if (springRaw) {
    const springStr = springRaw.trim();
    // âœ… ìŠ¤í”„ë§ ì •ë³´ëŠ” "Red", "Blue", "Yellow", ìˆ«ì, "+" ë“±ì´ í¬í•¨ë˜ì–´ì•¼ í•¨
    // ê·¼ìœ¡ ì´ë¦„(ì˜ˆ: "ì†Œí‰ê·¼", "ëŠ¥í˜•ê·¼", "ëŒ€í‰ê·¼")ì´ ë“¤ì–´ê°€ë©´ ì œì™¸
    // ìš´ë™ ì„¤ëª…(50ì ì´ìƒ)ì´ ë“¤ì–´ê°€ë©´ ì œì™¸
    if (springStr.length < 50 && 
        (springStr.match(/red|blue|yellow|spring|\d|\+|top|bottom|light|heavy/i) || springStr.length < 15) &&
        !springStr.match(/ê·¼|muscle|muscles|ì¤€ë¹„|ë‹¹ê¸°ê¸°|ëŒì•„ì˜¤ê¸°|ì£¼ì˜/i)) {
      spring = springStr;
    }
  }
  
  // âœ… í˜¸í¡: Breathing_Pattern í•„ë“œë§Œ ì‚¬ìš© (ë¬¸ìì—´ì¸ì§€ í™•ì¸)
  // âœ… ê°’ì´ ìŠ¤í”„ë§ ì •ë³´ì²˜ëŸ¼ ë³´ì´ë©´ ì œì™¸ (CSV íŒŒì‹± ì˜¤ë¥˜ ë°©ì§€)
  // âœ… ê·¼ìœ¡ ì´ë¦„ì´ ë“¤ì–´ê°€ë©´ ì œì™¸
  const breathingRaw = (normalized.Breathing_Pattern && typeof normalized.Breathing_Pattern === 'string' && normalized.Breathing_Pattern.trim()) ||
                    (normalized.Breathing && typeof normalized.Breathing === 'string' && normalized.Breathing.trim()) ||
                    (detail?.breathing && typeof detail.breathing === 'string' && detail.breathing.trim()) ||
                    '';
  let breathing = '';
  if (breathingRaw) {
    const breathingStr = breathingRaw.trim();
    // âœ… ê·¼ìœ¡ ì´ë¦„ íŒ¨í„´ ì œì™¸ (í•œê¸€ ê·¼ìœ¡ ì´ë¦„ì€ ë³´í†µ 2-4ì)
    if (breathingStr.match(/^[ê°€-í£]{2,4}$|^[ê°€-í£]{2,4},?\s*[ê°€-í£]{2,4}$/)) {
      breathing = '';
    } else if (breathingStr.length < 50 &&
        (breathingStr.match(/inhale|exhale|ë“¤ì–´|ë‚´ì‰¬|ë“¤ì´|ìˆ¨|breath/i) || breathingStr.length < 30) &&
        !breathingStr.match(/red|blue|yellow|spring|ê·¼|muscle|ì¤€ë¹„|ë‹¹ê¸°ê¸°|ëŒì•„ì˜¤ê¸°|ì£¼ì˜|^1\.|^2\./i)) {
      // âœ… í˜¸í¡ ì •ë³´ëŠ” "Inhale", "Exhale", "ë“¤ì–´", "ë‚´ì‰¬" ë“±ì´ í¬í•¨ë˜ì–´ì•¼ í•¨
      breathing = breathingStr;
    }
  }
  
  const precaution = detail?.precaution || normalized.precaution || normalized.warning || '';
  
  return { 
    title, purpose, how, cues, sets, precaution, 
    strengthenMuscles, stretchMuscles, spring, breathing,
    enKey: detail?.exercise_en || en, koKey: titleKo || ko 
  };
}

function renderExerciseDetailHTML(entry, options = {}) {
  const info = getExerciseDetailInfo(entry);
  if (!info.title) return '';
  const context = options.context || 'ui';
  const theme = {
    ui: { detailBg: '#ffffff', text: '#1f2933', accent: '#6c4ab6', hint: '#475569' },
    dark: { detailBg: 'rgba(255,255,255,0.05)', text: '#eef2ff', accent: '#a78bfa', hint: '#cbd5f5' },
    pdf: { detailBg: '#ffffff', text: '#0b0f14', accent: '#5c44b8', hint: '#475569' }
  }[context] || { detailBg: '#ffffff', text: '#1f2933', accent: '#6c4ab6', hint: '#475569' };
  // âœ… PDF ì»¨í…ìŠ¤íŠ¸ì¼ ë•Œë„ ì›ë˜ ê¸€ì í¬ê¸° ìœ ì§€
  const baseFontSize = context === 'pdf' ? (options.compact ? '12px' : '13px') : (options.compact ? '11px' : '12px');
  // âœ… PDF ì»¨í…ìŠ¤íŠ¸ì¼ ë•Œ ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì •í•˜ì—¬ ì—¬ë°± ì œê±°
  const detailWidth = context === 'pdf' ? 'width:100%; max-width:100%; box-sizing:border-box;' : '';
  let html = `<div style="margin-top:${options.compact ? '4px' : '8px'}; padding:${options.compact ? '8px' : '10px'}; background:${theme.detailBg}; border-radius:8px; font-size:${baseFontSize}; color:${theme.text}; line-height:1.6; font-family: var(--font-body); ${detailWidth} word-wrap:break-word; overflow-wrap:break-word;">`;
  html += `<div style="font-weight:600; color:${theme.accent}; margin-bottom:6px; font-size:${context === 'pdf' ? '14px' : '12px'};">${info.title}</div>`;
  
  // âœ… í•„ë¼í…ŒìŠ¤ DB í•„ë“œëª…ì„ í•œê¸€ë¡œ í‘œì‹œ
  if (info.strengthenMuscles || info.stretchMuscles) {
    html += `<div style="margin-bottom:6px; font-size:${context === 'pdf' ? '12px' : (parseInt(baseFontSize) - 1) + 'px'};`;
    if (info.strengthenMuscles) {
      html += `<div style="margin-bottom:2px;"><strong style="color:#10b981;">ğŸ’ª ì£¼ìš” ê°•í™” ê·¼ìœ¡:</strong> <span style="color:${theme.text};">${formatMultilineText(info.strengthenMuscles)}</span></div>`;
    }
    if (info.stretchMuscles) {
      html += `<div><strong style="color:#3b82f6;">ğŸ§˜ ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡:</strong> <span style="color:${theme.text};">${formatMultilineText(info.stretchMuscles)}</span></div>`;
    }
    html += `</div>`;
  }
  
  // âœ… í•„ë¼í…ŒìŠ¤ DB í•„ë“œ: ìƒì„¸ ë™ì‘ ì„¤ëª… (ìš´ë™ ì„¤ëª…ì„ ë°”ë¡œ í‘œì‹œ)
  if (info.how) {
    html += `<div style="margin-bottom:8px;"><strong style="color:${theme.accent}; font-size:${context === 'pdf' ? '14px' : (parseInt(baseFontSize) + 1) + 'px'};">ğŸ’¡ ìƒì„¸ ë™ì‘ ì„¤ëª…</strong><br><div style="margin-top:4px; line-height:1.8; font-size:${baseFontSize};">${formatMultilineText(info.how)}</div></div>`;
  }
  
  // âœ… í•„ë¼í…ŒìŠ¤ DB í•„ë“œ: íšŸìˆ˜, í˜¸í¡ íŒ¨í„´, ìŠ¤í”„ë§
  if (info.sets || info.spring || info.breathing) {
    html += `<div style="margin-bottom:4px; display:flex; gap:8px; flex-wrap:wrap; font-size:${context === 'pdf' ? '12px' : (parseInt(baseFontSize) - 1) + 'px'};">`;
    if (info.sets) {
      html += `<div><strong style="color:${theme.accent};">íšŸìˆ˜:</strong> ${formatMultilineText(info.sets)}</div>`;
    }
    if (info.breathing) {
      html += `<div><strong style="color:${theme.accent};">í˜¸í¡ íŒ¨í„´:</strong> ${formatMultilineText(info.breathing)}</div>`;
    }
    if (info.spring) {
      html += `<div><strong style="color:${theme.accent};">ìŠ¤í”„ë§:</strong> ${formatMultilineText(info.spring)}</div>`;
    }
    html += `</div>`;
  }
  
  html += `</div>`;
  return html;
}

function renderExerciseDetailsList(entries, options = {}) {
  if (!entries) return '';
  const list = (Array.isArray(entries) ? entries : [entries])
    .map(normalizeExerciseEntry)
    .filter(Boolean);
  if (!list.length) return '';
  const unlimited = options.limit === Infinity;
  const limit =
    unlimited
      ? list.length
      : options.limit ||
        (options.context === 'pdf' ? Math.min(8, list.length) : 2);
  return list.slice(0, limit).map(entry => renderExerciseDetailHTML(entry, options)).join('');
}

function renderPilatesEquipmentSections(pilatesObj, options = {}) {
  if (!pilatesObj) return '';
  let html = '';
  // âœ… PDF ì»¨í…ìŠ¤íŠ¸ì¼ ë•Œë„ ì›ë˜ ê¸€ì í¬ê¸° ìœ ì§€
  const fontSize = options.context === 'pdf' ? '13px' : '11px';
  const toolSize = options.context === 'pdf' ? '14px' : '11px';
  PILATES_EQUIPMENT_LIST.forEach(tool => {
    const exercises = pilatesObj[tool];
    const details = renderExerciseDetailsList(exercises, options);
    if (details) {
      // âœ… PDF ì»¨í…ìŠ¤íŠ¸ì¼ ë•Œ ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì •í•˜ì—¬ ì—¬ë°± ì œê±°
      const sectionWidth = options.context === 'pdf' ? 'width:100%; max-width:100%; box-sizing:border-box;' : '';
      html += `<div style="margin-top:8px; ${sectionWidth}">
        <div style="font-weight:600; font-size:${toolSize}; color:${options.context === 'dark' ? '#c7d2fe' : '#5c44b8'}; margin-bottom:4px; word-wrap:break-word;">${tool}</div>
        ${details}
      </div>`;
    }
  });
  return html;
}

function renderPilatesItemCard(item, options = {}) {
  if (!item) return '';
  const context = options.context || 'ui';
  const themeMap = {
    ui: { bg:'#f3e5f5', text:'#0b0f14', accent:'#9c88ff', border:'#d8c2ff' },
    dark: { bg:'rgba(255,255,255,0.05)', text:'#f8fbff', accent:'#c4b5fd', border:'rgba(255,255,255,0.12)' },
    pdf: { bg:'#f6f3ff', text:'#0b0f14', accent:'#5c44b8', border:'#d7ccff' }
  };
  const theme = themeMap[context] || themeMap.ui;
  const title = item.name || item.issue || `ì¶”ì²œ ${typeof options.index === 'number' ? options.index + 1 : ''}`;
  const musclesText = Array.isArray(item.muscles) ? item.muscles.join(', ') : (item.muscles || '');
  const tightText = Array.isArray(item.tight) ? item.tight.join(', ') : (item.tight || '');
  const weakText = Array.isArray(item.weak) ? item.weak.join(', ') : (item.weak || '');
  const pilatesData = item.pilates || item.pilatesExercises || null;
  const equipmentHTML = renderPilatesEquipmentSections(pilatesData, { context, limit: options.limitPerTool });
  const descriptionParts = [];
  if (item.condition) descriptionParts.push(item.condition);
  if (item.interpretation) descriptionParts.push(item.interpretation);
  if (item.description) descriptionParts.push(item.description);
  const description = descriptionParts.join(' Â· ');
  const note = item.note || item.manual || '';

  // âœ… PDF ì»¨í…ìŠ¤íŠ¸ì¼ ë•Œë„ ì›ë˜ ê¸€ì í¬ê¸° ìœ ì§€
  const fontSize = context === 'pdf' ? '13px' : '11px';
  const titleSize = context === 'pdf' ? '16px' : '14px';

  // âœ… PDF ì»¨í…ìŠ¤íŠ¸ì¼ ë•Œ ì¹´ë“œ ë„ˆë¹„ë¥¼ 764pxë¡œ ê³ ì •í•˜ì—¬ ì—¬ë°± ì œê±° (794px - 30px íŒ¨ë”©)
  const cardWidth = context === 'pdf' ? 'width:764px; max-width:764px;' : '';
  const cardMargin = context === 'pdf' ? 'margin-bottom:16px;' : 'margin-bottom:12px;';
  // âœ… PDF ì»¨í…ìŠ¤íŠ¸ì¼ ë•Œ íŒ¨ë”© ì¡°ì •ìœ¼ë¡œ ì—¬ë°± ìµœì†Œí™”
  const cardPadding = context === 'pdf' ? 'padding:12px;' : 'padding:14px;';

  return `
    <div style="${cardMargin} ${cardWidth} ${cardPadding} background:${theme.bg}; border-radius:12px; border:1px solid ${theme.border}; color:${theme.text}; font-family: var(--font-body); box-sizing:border-box;">
      <div style="font-weight:700; font-size:${titleSize}; margin-bottom:6px; color:${theme.accent}; word-wrap:break-word;">${title}</div>
      ${description ? `<div style="font-size:${fontSize}; margin-bottom:6px; word-wrap:break-word; overflow-wrap:break-word;">${formatMultilineText(description)}</div>` : ''}
      ${musclesText ? `<div style="font-size:${fontSize}; margin-bottom:4px; word-wrap:break-word; overflow-wrap:break-word;"><strong style="color:${theme.accent};">ê´€ë ¨ ê·¼ìœ¡:</strong> ${musclesText}</div>` : ''}
      ${tightText ? `<div style="font-size:${fontSize}; margin-bottom:4px; word-wrap:break-word; overflow-wrap:break-word;"><strong style="color:#ff6b6b;">ê¸´ì¥:</strong> ${tightText}</div>` : ''}
      ${weakText ? `<div style="font-size:${fontSize}; margin-bottom:6px; word-wrap:break-word; overflow-wrap:break-word;"><strong style="color:#7c9cff;">ì•½í™”:</strong> ${weakText}</div>` : ''}
      ${equipmentHTML ? `<div style="margin-top:8px; width:100%; max-width:100%; box-sizing:border-box;">${equipmentHTML}</div>` : ''}
      ${note ? `<div style="margin-top:10px; font-size:${fontSize}; color:${theme.text === '#f8fbff' ? '#c7d2fe' : '#4b5563'}; word-wrap:break-word; overflow-wrap:break-word;">${formatMultilineText(note)}</div>` : ''}
    </div>
  `;
}

// âœ… í•„ë¼í…ŒìŠ¤ ìš´ë™ ì„¤ëª…ì„ ë°”ë¡œ í‘œì‹œí•˜ë¯€ë¡œ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì œê±°
// document.addEventListener('click', (event) => {
//   const card = event.target.closest('[data-pilates-detail-card="1"]');
//   if (!card || typeof showExerciseModal !== 'function') return;
//   event.preventDefault();
//   const exerciseEn = card.getAttribute('data-exercise-en') || '';
//   const exerciseKo = card.getAttribute('data-exercise-ko') || '';
//   const purpose = card.getAttribute('data-exercise-purpose') || '';
//   showExerciseModal(exerciseEn, exerciseKo, purpose);
// });

function setPageContainerStyle(container, { width = 794 } = {}) {
  // position, left, topì€ .pdf-safe CSSì—ì„œ ì²˜ë¦¬
  container.style.width = `${width}px`;
  container.style.maxWidth = "100%";
  // âœ… í•„ë¼í…ŒìŠ¤ í˜ì´ì§€ëŠ” ì¢Œìš° íŒ¨ë”© ì¶•ì†Œë¡œ ì—¬ë°± ìµœì†Œí™”
  if (container.id === 'page5Container') {
    container.style.padding = "30px 15px";
  } else {
  container.style.padding = "30px 25px";
  }
  container.style.paddingBottom = "140px";
  container.style.background = "#ffffff";
  container.style.wordWrap = "break-word";
  container.style.overflowWrap = "break-word";
  container.style.boxSizing = "border-box";
  container.style.color = "#111";
  container.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, "Noto Sans KR", sans-serif';
  container.style.fontSize = "14px"; // ê¸€ì ê°€ë…ì„± ê°œì„  (12px -> 14px)
  container.style.lineHeight = "1.6"; // ì¤„ ê°„ê²© ê°œì„  (1.55 -> 1.6)
  container.style.letterSpacing = "0.2px";
  container.style.boxSizing = "border-box";
  container.style.overflow = "visible"; // í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€
  container.style.wordWrap = "break-word";
  container.style.overflowWrap = "break-word"; // ì¶”ê°€: í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€
  container.style.wordBreak = "break-word"; // ì¶”ê°€: ê¸´ ë‹¨ì–´ë„ ì¤„ë°”ê¿ˆ
  container.style.whiteSpace = "normal"; // í…ìŠ¤íŠ¸ê°€ ìì—°ìŠ¤ëŸ½ê²Œ ì¤„ë°”ê¿ˆë˜ë„ë¡
  container.style.minHeight = "1100px";
  container.style.maxHeight = "none"; // âœ… ë†’ì´ ì œí•œ ì œê±° (í˜ì´ì§€ë¥¼ ììœ ë¡­ê²Œ ëŠ˜ë¦¬ê¸°)
  // PDF ì•ˆì „ í°íŠ¸ í´ë˜ìŠ¤ ì¶”ê°€
  if (!container.classList.contains('pdf-safe')) {
    container.classList.add('pdf-safe');
  }
}

function buildCoverPageHTML({ memberName, centerName, dateStr, appName, beforeViews = {}, afterViews = {}, overlayImg, frontOverlayImg }) {
  const hasBefore = !!(beforeViews.side || beforeViews.front);
  const hasAfter = !!(afterViews.side || afterViews.front);
  const renderViewColumn = (label, views) => {
    const hasView = !!(views.side || views.front);
    if(!hasView) {
      return `
        <div style="flex:1; min-height:360px; border:1px dashed #cbd5f5; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-size:12px;">
          ${label} ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      `;
    }
    const rows = [];
    if(views.side) {
      rows.push(`
        <div style="text-align:center;">
          <img src="${views.side}" style="width:100%; height:auto; border-radius:10px; border:1px solid #e2e8f0; display:block; max-height:320px; object-fit:contain; background:#fff; image-rendering:high-quality;" />
          <div style="margin-top:6px; font-size:11px; color:#475569; font-weight:600;">${label} Â· ì˜†ëª¨ìŠµ</div>
        </div>
      `);
    }
    if(views.front) {
      rows.push(`
        <div style="text-align:center;">
          <img src="${views.front}" style="width:100%; height:auto; border-radius:10px; border:1px solid #e2e8f0; display:block; max-height:320px; object-fit:contain; background:#fff; image-rendering:high-quality;" />
          <div style="margin-top:6px; font-size:11px; color:#475569; font-weight:600;">${label} Â· ì •ë©´</div>
        </div>
      `);
    }
    return `
      <div style="flex:1; display:flex; flex-direction:column; gap:14px; padding:12px; border:1px solid #e2e8f0; border-radius:12px; background:#fafbff;">
        <div style="font-size:13px; font-weight:700; color:#0f172a;">${label}</div>
        ${rows.join('')}
      </div>
    `;
  };

  return `
    <div style="text-align:center; margin-top:60px;">
      <h1 style="margin:0; padding:0; font-size:32px; font-weight:800; color:#0b0f14; margin-bottom:30px; line-height:1.3;">ğŸ“‹ AI ìì„¸ ë¶„ì„ ë³´ê³ ì„œ</h1>
      ${memberName ? `<h2 style="margin:0; padding:0; font-size:20px; font-weight:600; color:#333; margin-bottom:15px;">íšŒì›ëª…: ${memberName}</h2>` : ''}
      ${centerName ? `<h3 style="margin:0; padding:0; font-size:18px; font-weight:500; color:#666; margin-bottom:15px;">ì„¼í„°ëª…: ${centerName}</h3>` : ''}
      <p style="margin:0; padding:0; font-size:14px; color:#999; margin-bottom:10px;">ë¶„ì„ì¼: ${dateStr}</p>
      <p style="margin:0; padding:0; font-size:12px; color:#999; margin-top:40px;">Generated by ${appName} Â· ${REPORT_SIGNATURE}</p>
    </div>
    
    ${(hasBefore || hasAfter) ? `
    <div style="margin-top:24px;">
      <div style="font-size:14px; font-weight:700; margin-bottom:12px; text-align:left;">ğŸ“¸ Before / After (ì¸¡ë©´ + ì •ë©´)</div>
      <div style="display:flex; gap:16px; flex-wrap:wrap;">
        ${renderViewColumn('Before', beforeViews)}
        ${renderViewColumn('After', afterViews)}
      </div>
    </div>
    ` : `
    <div style="margin-top:24px; padding:32px; border:1px dashed #cbd5f5; border-radius:12px; text-align:center; color:#94a3b8;">
      ì—…ë¡œë“œëœ ì‚¬ì§„ì´ ì—†ì–´ í‘œì§€ë¥¼ êµ¬ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    </div>
    `}
    
    ${(overlayImg || frontOverlayImg) ? `
    <div style="margin-top:24px;">
      <div style="font-size:12px; font-weight:600; margin-bottom:8px;">ğŸ”„ Before-After ì˜¤ë²„ë ˆì´ (ë³€í™” ì‹œê°í™”)</div>
      <div style="display:flex; gap:16px; flex-wrap:wrap; justify-content:center;">
        ${overlayImg ? `
        <div style="flex:1; min-width:280px; max-width:400px;">
      <div style="text-align:center;">
            <img src="${overlayImg}" style="width:100%; height:auto; border-radius:10px; border:1px solid #e2e8f0; display:block; max-height:400px; object-fit:contain; background:#fff; image-rendering:high-quality;" />
            <div style="margin-top:8px; font-size:10px; color:#666;">ì¸¡ë©´: íŒŒë€ìƒ‰(Before) | ì£¼í™©ìƒ‰(After)</div>
          </div>
        </div>
        ` : ''}
        ${frontOverlayImg ? `
        <div style="flex:1; min-width:280px; max-width:400px;">
          <div style="text-align:center;">
            <img src="${frontOverlayImg}" style="width:100%; height:auto; border-radius:10px; border:1px solid #e2e8f0; display:block; max-height:400px; object-fit:contain; background:#fff; image-rendering:high-quality;" />
            <div style="margin-top:8px; font-size:10px; color:#666;">ì •ë©´: íŒŒë€ìƒ‰(Before) | ì£¼í™©ìƒ‰(After)</div>
          </div>
        </div>
        ` : ''}
      </div>
    </div>
    ` : ''}
  `;
}

function createCoverPageContainer(params) {
  const container = document.createElement('div');
  container.id = 'page1Container';
  setPageContainerStyle(container);
  container.classList.add('pdf-safe');
  container.innerHTML = buildCoverPageHTML(params);
  return container;
}


async function captureReportCanvases({ centerName, memberName, appName, logoUrl }) {
  const S = sessions[cur];
  const M = S.metrics || {};
  const scoreData = S.score || {};
  let analysis = S.analysis || {};
  
  // ëª¨ë“  ìº”ë²„ìŠ¤ ë³€ìˆ˜ë¥¼ í•¨ìˆ˜ ìŠ¤ì½”í”„ ìƒë‹¨ì—ì„œ ì´ˆê¸°í™” (ì—ëŸ¬ ë°©ì§€)
  let sideImageCanvas = null; // ì¸¡ë©´ ì‚¬ì§„
  let sideReportCanvas = null; // ì¸¡ë©´ ë¦¬í¬íŠ¸
  let frontImageCanvas = null; // ì •ë©´ ì‚¬ì§„
  let frontReportCanvas = null; // ì •ë©´ ë¦¬í¬íŠ¸
  let combinedReportCanvas = null; // ì¢…í•© ë¦¬í¬íŠ¸ (ì¸¡ë©´+ì •ë©´)
  let canvas4 = null;
  let canvas5 = null; // í•„ë¼í…ŒìŠ¤ ì¶”ì²œ
  let canvas6 = null; // AI ì‹¬ì¸µ ë¶„ì„
  let canvas7 = null; // ìµœì¢… ë¶„ì„ & ì „ëµ
  let canvas8 = null; // ì²´í˜• ìœ í˜• ë¶„ì„ í˜ì´ì§€
  const hasMeaningfulAnalysis = (data) => {
    if (!data) return false;
    return ['pilates','exercises','comments','details','tight','weak'].some(key => Array.isArray(data[key]) && data[key].length > 0);
  };
  const mergeAnalysisData = (preferred = {}, fallback = {}) => ({
    ...fallback,
    ...preferred,
    pilates: (Array.isArray(preferred.pilates) && preferred.pilates.length > 0) ? preferred.pilates : (fallback.pilates || []),
    exercises: (Array.isArray(preferred.exercises) && preferred.exercises.length > 0) ? preferred.exercises : (fallback.exercises || []),
    comments: (Array.isArray(preferred.comments) && preferred.comments.length > 0) ? preferred.comments : (fallback.comments || []),
    details: (Array.isArray(preferred.details) && preferred.details.length > 0) ? preferred.details : (fallback.details || []),
    tight: (Array.isArray(preferred.tight) && preferred.tight.length > 0) ? preferred.tight : (fallback.tight || []),
    weak: (Array.isArray(preferred.weak) && preferred.weak.length > 0) ? preferred.weak : (fallback.weak || [])
  });

  const analysisResultFallback = S.analysisResult?.analysis || null;
  if (analysisResultFallback) {
    analysis = mergeAnalysisData(analysis, analysisResultFallback);
  }

  if (!hasMeaningfulAnalysis(analysis) && analysisResultFallback) {
    analysis = mergeAnalysisData(analysisResultFallback, analysis);
  }

  if (!hasMeaningfulAnalysis(analysis) && S.metrics?.fullMetrics) {
    try {
      const refreshedAnalysis = await analyzeMusclesWithDB(S.metrics.fullMetrics);
      if (refreshedAnalysis) {
        analysis = refreshedAnalysis;
        S.analysis = refreshedAnalysis;
      }
    } catch (recalcErr) {
      console.warn('PDF ìƒì„± ì¤‘ ë¶„ì„ ë°ì´í„° ë³´ê°• ì‹¤íŒ¨:', recalcErr);
    }
  }

  if (!analysis) {
    analysis = {};
  }

  // âœ… ì¸¡ë©´ ë¶„ì„ê³¼ ì •ë©´ ë¶„ì„ì„ ëª¨ë‘ í™•ì¸í•˜ì—¬ í†µí•©
  // 1ìˆœìœ„: After ì„¸ì…˜ì˜ ì¸¡ë©´/ì •ë©´ ë¶„ì„
  let sideAnalysisForPDF = sessions.After?.sideAnalysis || sessions.Before?.sideAnalysis || sessions[cur]?.sideAnalysis || null;
  let frontAnalysisForPDF = sessions.After?.frontAnalysis || sessions.Before?.frontAnalysis || sessions[cur]?.frontAnalysis || null;
  
  // ì¸¡ë©´ ë¶„ì„ì´ ìˆìœ¼ë©´ ì¸¡ë©´ ë¶„ì„ ë°ì´í„° ë³‘í•©
  if (sideAnalysisForPDF) {
    analysis = mergeAnalysisData(sideAnalysisForPDF, analysis);
  }
  
  // ì •ë©´ ë¶„ì„ì´ ìˆìœ¼ë©´ ì •ë©´ ë¶„ì„ ë°ì´í„° ë³‘í•©
  if (frontAnalysisForPDF) {
    analysis = mergeAnalysisData(frontAnalysisForPDF, analysis);
  }

  // í†µí•© ë¶„ì„ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸° (ìš´ë™ ì¶”ì²œ í¬í•¨)
  const analysisResult = S.analysisResult || analyzePostureAutoWithRecommendation({
    sidePts: S.sidePoints.size > 0 ? Object.fromEntries(S.sidePoints) : null,
    frontPts: S.frontPoints.size > 0 ? Object.fromEntries(S.frontPoints) : null,
    pxPerCm: S.pxPerCm || 50.0
  });

  // Before/After ìº”ë²„ìŠ¤ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° (dotì™€ ì ì„  í¬í•¨)
  if (!cv || !cv.toDataURL) {
    throw new Error("ìº”ë²„ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
  }

  const originalSession = cur;
  const wait = (ms = 80) => new Promise(resolve => setTimeout(resolve, ms));
  const hasOrientationData = (session, orientation) => {
    if (!session) return false;
    const map = orientation === "front" ? session.frontPoints : session.sidePoints;
    const imgRef = orientation === "front" ? session.imgFront : session.imgSide;
    return (map && map.size > 0) || !!imgRef;
  };

  const captureSessionSnapshot = async (sessionName, orientation) => {
    const session = sessions[sessionName];
    if(!session || !hasOrientationData(session, orientation)) return null;
    const originalSession = cur;
    const originalOrientation = session.poseData?.orientation || "side";

    if(cur !== sessionName) {
      switchSession(sessionName);
      await wait(80);
    }
    if(originalOrientation !== orientation) {
      setOrientation(orientation);
      await wait(80);
    } else {
      draw();
      await wait(50);
    }

    // âœ… Canvas ë Œë”ë§ ì™„ë£Œ ë³´ì¥ (ëª¨ë°”ì¼ PDF ì €ì¥ ì‹œ ì‚¬ì§„ ë° ì  ëˆ„ë½ ë°©ì§€)
    // ì—¬ëŸ¬ ë²ˆ ë Œë”ë§í•˜ì—¬ ëª¨ë“  ì ê³¼ ì„ ì´ ê·¸ë ¤ì§€ë„ë¡ ë³´ì¥
    if (cv && typeof draw === 'function') {
      draw(); // ì²« ë²ˆì§¸ ë Œë”ë§
      await new Promise(res => requestAnimationFrame(res));
      draw(); // ë‘ ë²ˆì§¸ ë Œë”ë§ (ëª¨ë°”ì¼ì—ì„œ ë Œë”ë§ ì§€ì—° ë³´ì •)
      await new Promise(res => requestAnimationFrame(res));
      await wait(100); // ì¶”ê°€ ëŒ€ê¸° ì‹œê°„ (ëª¨ë°”ì¼ ë Œë”ë§ ì™„ë£Œ ë³´ì¥)
    }

    // âœ… Canvas ë‚´ìš© ê²€ì¦ (ë¹ˆ ìº”ë²„ìŠ¤ ë°©ì§€)
    let snapshot = null;
    if (cv && cv.toDataURL) {
      snapshot = cv.toDataURL("image/png", 1.0);
      // ë¹ˆ ì´ë¯¸ì§€ í™•ì¸ (DataURLì´ ê¸°ë³¸ê°’ì¸ì§€ í™•ì¸)
      if (snapshot && snapshot !== 'data:,') {
        // Canvasì— ì‹¤ì œ ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸ (ì‘ì€ ì˜ì—­ ìƒ˜í”Œë§)
        try {
          const ctx = cv.getContext('2d');
          if (ctx) {
            const imageData = ctx.getImageData(0, 0, Math.min(cv.width, 10), Math.min(cv.height, 10));
            const hasContent = imageData.data.some((val, idx) => idx % 4 !== 3 || val < 255);
            if (!hasContent) {
              console.warn(`âš ï¸ Canvasê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë Œë”ë§í•©ë‹ˆë‹¤: ${sessionName} ${orientation}`);
              draw();
              await new Promise(res => requestAnimationFrame(res));
              await wait(100);
              snapshot = cv.toDataURL("image/png", 1.0);
            }
          }
        } catch (err) {
          // Canvas ì ‘ê·¼ ì˜¤ë¥˜ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
          console.warn('Canvas ë‚´ìš© ê²€ì¦ ì¤‘ ì˜¤ë¥˜:', err);
        }
      }
    }

    if(originalOrientation !== orientation) {
      setOrientation(originalOrientation);
      await wait(60);
    }
    if(cur !== originalSession) {
      switchSession(originalSession);
      await wait(60);
    } else {
      draw();
    }
    return snapshot;
  };

  const beforeViews = {};
  const afterViews = {};

  const beforeSideImg = await captureSessionSnapshot("Before", "side");
  if(beforeSideImg) beforeViews.side = beforeSideImg;
  const beforeFrontImg = await captureSessionSnapshot("Before", "front");
  if(beforeFrontImg) beforeViews.front = beforeFrontImg;

  const afterSideImg = await captureSessionSnapshot("After", "side");
  if(afterSideImg) afterViews.side = afterSideImg;
  const afterFrontImg = await captureSessionSnapshot("After", "front");
  if(afterFrontImg) afterViews.front = afterFrontImg;

  if(cur !== originalSession) {
    switchSession(originalSession);
    await wait(60);
  } else {
    draw();
  }

  const beforeImg = beforeViews.side || beforeViews.front || null;
  const afterImg = afterViews.side || afterViews.front || null;
  const beforeOrientation = beforeViews.side ? "side" : (beforeViews.front ? "front" : "side");
  const afterOrientation = afterViews.side ? "side" : (afterViews.front ? "front" : "side");

  // Before-After ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ìƒì„± (ì¸¡ë©´ + ì •ë©´ ëª¨ë‘)
  let overlayImg = null; // ì¸¡ë©´ overlay
  let frontOverlayImg = null; // ì •ë©´ overlay

      // Mapì„ ì¼ë°˜ ê°ì²´ë¡œ ë³€í™˜ (ì†Œë¬¸ì í‚¤ë¡œ í†µì¼)
      const getPointsObject = (pointsMap) => {
        if(!pointsMap) return null;
        const obj = {};
        if(pointsMap instanceof Map) {
          pointsMap.forEach((value, key) => {
            const lowerKey = key.toLowerCase();
            obj[lowerKey] = value;
          });
        } else if(typeof pointsMap === 'object') {
          Object.keys(pointsMap).forEach(key => {
            const lowerKey = key.toLowerCase();
            obj[lowerKey] = pointsMap[key];
          });
        }
        return obj;
      };

  // ì¸¡ë©´ overlay ìƒì„±
  if(beforeViews.side && afterViews.side) {
    try {
      const beforePointsMap = sessions.Before?.sidePoints;
      const afterPointsMap = sessions.After?.sidePoints;
      const beforePoints = getPointsObject(beforePointsMap);
      const afterPoints = getPointsObject(afterPointsMap);

      if(beforePoints && afterPoints && Object.keys(beforePoints).length > 0 && Object.keys(afterPoints).length > 0) {
        overlayImg = await createOverlayImageWithSkeleton(beforeViews.side, afterViews.side, beforePoints, afterPoints, 0.5);
      } else {
        overlayImg = await createOverlayImage(beforeViews.side, afterViews.side, 0.5);
      }
    } catch(err) {
      console.warn("ì¸¡ë©´ ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:", err);
      try {
        overlayImg = await createOverlayImage(beforeViews.side, afterViews.side, 0.5);
      } catch(err2) {
        console.warn("ì¸¡ë©´ ê¸°ë³¸ ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ìƒì„±ë„ ì‹¤íŒ¨:", err2);
      }
    }
  }

  // ì •ë©´ overlay ìƒì„±
  if(beforeViews.front && afterViews.front) {
    try {
      const beforePointsMap = sessions.Before?.frontPoints;
      const afterPointsMap = sessions.After?.frontPoints;
      const beforePoints = getPointsObject(beforePointsMap);
      const afterPoints = getPointsObject(afterPointsMap);

      if(beforePoints && afterPoints && Object.keys(beforePoints).length > 0 && Object.keys(afterPoints).length > 0) {
        frontOverlayImg = await createOverlayImageWithSkeleton(beforeViews.front, afterViews.front, beforePoints, afterPoints, 0.5);
      } else {
        frontOverlayImg = await createOverlayImage(beforeViews.front, afterViews.front, 0.5);
      }
    } catch(err) {
      console.warn("ì •ë©´ ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:", err);
      try {
        frontOverlayImg = await createOverlayImage(beforeViews.front, afterViews.front, 0.5);
      } catch(err2) {
        console.warn("ì •ë©´ ê¸°ë³¸ ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ìƒì„±ë„ ì‹¤íŒ¨:", err2);
      }
    }
  }

  // Confidence Heatmap ìƒì„± (Before, After) - ì•ˆì „ ë²„ì „
  let beforeHeatmap = null;
  let beforeAvgConfidence = 0.8;
  let afterHeatmap = null;
  let afterAvgConfidence = 0.8;

  if(beforeImg && sessions.Before) {
    try {
      const beforeOriginalImg = sessions.Before[beforeOrientation === "front" ? "imgFront" : "imgSide"];
      if(beforeOriginalImg && beforeOriginalImg.src) {
        const heatmapResult = await createConfidenceHeatmap(beforeOriginalImg.src, "Before", beforeOrientation);
        if(heatmapResult && typeof heatmapResult === 'object') {
          beforeHeatmap = heatmapResult.heatmapImage || heatmapResult;
          beforeAvgConfidence = heatmapResult.avgConfidence || 0.8;
        } else {
          beforeHeatmap = heatmapResult;
        }
      }
    } catch(err) {
      console.warn("Before íˆíŠ¸ë§µ ìƒì„± ì‹¤íŒ¨:", err);
      // í´ë°±: ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©
      beforeHeatmap = beforeImg;
    }
  }

  if(afterImg && sessions.After) {
    try {
      const afterOriginalImg = sessions.After[afterOrientation === "front" ? "imgFront" : "imgSide"];
      if(afterOriginalImg && afterOriginalImg.src) {
        const heatmapResult = await createConfidenceHeatmap(afterOriginalImg.src, "After", afterOrientation);
        if(heatmapResult && typeof heatmapResult === 'object') {
          afterHeatmap = heatmapResult.heatmapImage || heatmapResult;
          afterAvgConfidence = heatmapResult.avgConfidence || 0.8;
        } else {
          afterHeatmap = heatmapResult;
        }
      }
    } catch(err) {
      console.warn("After íˆíŠ¸ë§µ ìƒì„± ì‹¤íŒ¨:", err);
      // í´ë°±: ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©
      afterHeatmap = afterImg;
    }
  }

  // ì¸¡ì • ê²°ê³¼ ê¸°ë°˜ í•„ë¼í…ŒìŠ¤ ì¶”ì²œ
  const beforeMetrics = sessions.Before?.metrics || {};
  const afterMetrics = sessions.After?.metrics || {};
  const metricBasedPilates = recommendPilatesFromMetrics(beforeMetrics, afterMetrics);

  // ë¡œê³  HTML (ìˆìœ¼ë©´)
  const logoHtml = logoUrl ? `<img src="${logoUrl}" style="width:32px; height:32px; margin-right:8px; vertical-align:middle;" />` : '';

  // ë¶„ì„ ê²°ê³¼ ìš”ì•½ HTML ìƒì„± (undefined ì—ëŸ¬ ë°©ì§€)
  // ìš´ë™ ì¶”ì²œ HTML ìƒì„±
  const exerciseRecommendationHtml = buildExerciseRecommendationHtml(analysisResult);

  const now = new Date();
  const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

// html2canvas ì˜µì…˜ ì •ì˜ (í°íŠ¸ ë””ì½”ë”© ì˜¤ë¥˜ ë°©ì§€, ëª¨ë°”ì¼ ìµœì í™”)
// í™”ì§ˆ ëŒ€í­ ê°œì„ ì„ ìœ„í•´ scaleê³¼ í¬ê¸° ì œí•œ ì¦ê°€
const isMobile = isMobileDevice();
// âœ… í˜ì´ì§€ë¥¼ ììœ ë¡­ê²Œ ëŠ˜ë ¤ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í¬ê¸° ì œí•œ ëŒ€í­ ì¦ê°€
const PDF_MAX_CANVAS_EDGE = isMobile ? 10000 : 15000; // âœ… í¬ê¸° ì œí•œ ëŒ€í­ ì¦ê°€ (ì›ë³¸ í¬ê¸° ìœ ì§€)
const baseCanvasScale = isMobile ? 4.0 : 5.0; // ê³ í•´ìƒë„ ê°œì„  (2.5/3.0 â†’ 4.0/5.0)
const html2canvasOptions = {
  scale: baseCanvasScale,
  backgroundColor: "#ffffff",
  useCORS: true,
  allowTaint: false,
  logging: false,
  scrollX: 0,
  scrollY: -window.scrollY,
  imageTimeout: 20000,
  removeContainer: isMobile,
  // í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ ì˜µì…˜
  letterRendering: true, // í…ìŠ¤íŠ¸ ë Œë”ë§ ê°œì„ 
  // âœ… Quirks Mode ë°©ì§€: foreignObjectRendering ë¹„í™œì„±í™”
  foreignObjectRendering: false, // SVG foreignObject ì‚¬ìš© ì•ˆ í•¨ (Quirks Mode ë°©ì§€)
  // ë©”ëª¨ë¦¬ ì ˆì•½ ë° í…ìŠ¤íŠ¸ ë³´í˜¸ ì˜µì…˜
  onclone: (clonedDoc) => {
    // âœ… Quirks Mode ë°©ì§€: ë³µì œëœ ë¬¸ì„œì— DOCTYPE ì¶”ê°€ (ìµœì¢… ê°•í™”)
    try {
      // ë³µì œëœ ë¬¸ì„œì™€ ê´€ë ¨ëœ ëª¨ë“  ë¬¸ì„œ í™•ì¸
      const docsToFix = [clonedDoc];
      
      // clonedDoc.defaultViewë¥¼ í†µí•´ windowì— ì ‘ê·¼ (iframe ë‚´ë¶€ ë¬¸ì„œì¼ ìˆ˜ ìˆìŒ)
      if (clonedDoc.defaultView && clonedDoc.defaultView.document && clonedDoc.defaultView.document !== clonedDoc) {
        docsToFix.push(clonedDoc.defaultView.document);
      }
      
      // âœ… html2canvasê°€ ìƒì„±í•œ ëª¨ë“  iframe ë¬¸ì„œë„ í™•ì¸
      try {
        const allIframes = clonedDoc.querySelectorAll('iframe');
        allIframes.forEach(iframe => {
          try {
            if (iframe.contentDocument && iframe.contentDocument !== clonedDoc) {
              docsToFix.push(iframe.contentDocument);
            }
          } catch (e) {
            // Cross-origin iframeì€ ì ‘ê·¼ ë¶ˆê°€ (ë¬´ì‹œ)
          }
        });
      } catch (e) {
        // iframe ì ‘ê·¼ ì‹¤íŒ¨ (ë¬´ì‹œ)
      }
      
      docsToFix.forEach(doc => {
        try {
          // DOCTYPEì´ ì—†ê±°ë‚˜ Quirks Modeì¸ ê²½ìš° ê°•ì œë¡œ ì¶”ê°€
          if (!doc.doctype || doc.compatMode === 'BackCompat') {
            // ë°©ë²• 1: createDocumentType ì‚¬ìš© (ê°€ì¥ í‘œì¤€ì ì¸ ë°©ë²•)
            try {
              const doctype = doc.implementation.createDocumentType('html', '', '');
              // ê¸°ì¡´ DOCTYPEì´ ìˆìœ¼ë©´ ì œê±°
              if (doc.doctype) {
                doc.removeChild(doc.doctype);
              }
              // documentElement ì•ì— DOCTYPE ì‚½ì…
              if (doc.documentElement) {
                doc.insertBefore(doctype, doc.documentElement);
              } else {
                // documentElementê°€ ì—†ìœ¼ë©´ ì§ì ‘ ì¶”ê°€
                doc.appendChild(doctype);
              }
            } catch (e1) {
              console.warn('createDocumentType ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‹œë„:', e1);
              // ë°©ë²• 2: DOMParserë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆ ë¬¸ì„œ ìƒì„±
              try {
                const htmlContent = '<!DOCTYPE html>\n' + (doc.documentElement ? doc.documentElement.outerHTML : '');
                const parser = new DOMParser();
                const newDoc = parser.parseFromString(htmlContent, 'text/html');
                if (newDoc.doctype) {
                  // ê¸°ì¡´ DOCTYPE ì œê±° í›„ ìƒˆ DOCTYPE ì¶”ê°€
                  if (doc.doctype) {
                    doc.removeChild(doc.doctype);
                  }
                  if (doc.documentElement) {
                    doc.insertBefore(newDoc.doctype, doc.documentElement);
                  }
                }
              } catch (e2) {
                console.warn('DOMParser ë°©ë²•ë„ ì‹¤íŒ¨:', e2);
              }
            }
          }
          // ìµœì¢… í™•ì¸: document.compatModeê°€ 'BackCompat'ì´ë©´ Quirks Mode
          if (doc.compatMode === 'BackCompat') {
            console.warn('âš ï¸ ë³µì œëœ ë¬¸ì„œê°€ ì—¬ì „íˆ Quirks Modeì…ë‹ˆë‹¤. DOCTYPE:', doc.doctype);
          } else {
            console.log('âœ… ë³µì œëœ ë¬¸ì„œê°€ Standards Modeë¡œ ë Œë”ë§ë©ë‹ˆë‹¤.');
          }
        } catch (docErr) {
          console.warn('ê°œë³„ ë¬¸ì„œ DOCTYPE ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', docErr);
        }
      });
    } catch (err) {
      console.warn('onclone DOCTYPE ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', err);
    }
    
    // ëª¨ë“  í…ìŠ¤íŠ¸ ìš”ì†Œì— ê¸€ì ì˜ë¦¼ ë°©ì§€ ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš©
    const allElements = clonedDoc.querySelectorAll('*');
    allElements.forEach(el => {
      if (el.style) {
        // img, video, canvas íƒœê·¸ëŠ” overflow: visible ì„¤ì •í•˜ì§€ ì•ŠìŒ (deprecated ê²½ê³  ë°©ì§€)
        const isMediaElement = el.tagName === 'IMG' || el.tagName === 'VIDEO' || el.tagName === 'CANVAS';
        
        // í…ìŠ¤íŠ¸ê°€ ì˜ë¦¬ì§€ ì•Šë„ë¡ ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš©
        el.style.wordWrap = 'break-word';
        el.style.overflowWrap = 'break-word';
        el.style.wordBreak = 'break-word';
        el.style.whiteSpace = el.style.whiteSpace || 'normal';
        // overflowê°€ hiddenì´ë©´ visibleë¡œ ë³€ê²½ (í…ìŠ¤íŠ¸ ë³´í˜¸, ë‹¨ img/video/canvasëŠ” ì œì™¸)
        if (el.style.overflow === 'hidden' && !isMediaElement) {
          el.style.overflow = 'visible';
        }
        if (el.style.textOverflow === 'ellipsis') {
          el.style.textOverflow = 'clip';
          el.style.whiteSpace = 'normal';
        }
      }
    });
    
    // ë³µì œëœ ë¬¸ì„œì—ì„œ ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±°
    const images = clonedDoc.querySelectorAll('img');
    images.forEach(img => {
      if (img.src && img.src.startsWith('data:')) {
        // í° data URI ì´ë¯¸ì§€ëŠ” ì œê±°í•˜ê±°ë‚˜ ë¦¬ì‚¬ì´ì¦ˆ
        try {
          const imgElement = new Image();
          imgElement.src = img.src;
          if (imgElement.width > 2000 || imgElement.height > 2000) {
            img.style.maxWidth = '800px';
            img.style.maxHeight = '800px';
          }
        } catch (e) {
          // ë¬´ì‹œ
        }
      }
    });
  }
};

// ========== í˜ì´ì§€ 1: ì¸¡ë©´ Before & After ==========
  const sideImageContainer = document.createElement("div");
  sideImageContainer.id = "sideImageContainer";
  setPageContainerStyle(sideImageContainer);
  sideImageContainer.classList.add('pdf-safe');
  
if (beforeViews.side || afterViews.side) {
  const beforeImg = beforeViews.side || '';
  const afterImg = afterViews.side || '';
  
    sideImageContainer.innerHTML = `
    <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px;">ğŸ“¸ ì¸¡ë©´ Before & After</h2>
    <div style="display:flex; gap:20px; margin-top:20px;">
      <div style="flex:1; text-align:center;">
        <div style="font-size:14px; font-weight:600; color:#333; margin-bottom:10px;">Before</div>
        ${beforeImg ? `<img src="${beforeImg}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; max-height:800px; object-fit:contain; background:#fff;" />` : '<div style="padding:40px; border:1px dashed #ddd; border-radius:8px; color:#999;">Before ì´ë¯¸ì§€ ì—†ìŒ</div>'}
      </div>
      <div style="flex:1; text-align:center;">
        <div style="font-size:14px; font-weight:600; color:#333; margin-bottom:10px;">After</div>
        ${afterImg ? `<img src="${afterImg}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; max-height:800px; object-fit:contain; background:#fff;" />` : '<div style="padding:40px; border:1px dashed #ddd; border-radius:8px; color:#999;">After ì´ë¯¸ì§€ ì—†ìŒ</div>'}
      </div>
      </div>
      <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
        <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
          <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
          <span>Page 1</span>
        </div>
      </div>
    `;
  } else {
    sideImageContainer.innerHTML = `
    <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px;">ğŸ“¸ ì¸¡ë©´ Before & After</h2>
    <div style="text-align:center; padding:40px 20px; border:1px dashed #d0d0d0; border-radius:8px; background:#f9fafb; margin-top:20px;">
      <p style="margin:0; font-size:15px; color:#666;">ì¸¡ë©´ ì‚¬ì§„ì´ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
      </div>
      <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
        <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
          <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
          <span>Page 1</span>
        </div>
      </div>
    `;
  }
  
  document.body.appendChild(sideImageContainer);
  
  if (isMobile) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }

// ========== í˜ì´ì§€ 2: ì¸¡ë©´ ì˜¤ë²„ë ˆì´ì™€ ìŠ¤ì¼ˆë ˆí†¤ ëª¨í˜• ==========
const sideOverlayContainer = document.createElement("div");
sideOverlayContainer.id = "sideOverlayContainer";
setPageContainerStyle(sideOverlayContainer);
sideOverlayContainer.classList.add('pdf-safe');

if (overlayImg) {
  sideOverlayContainer.innerHTML = `
    <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px;">ğŸ”„ ì¸¡ë©´ ì˜¤ë²„ë ˆì´ & ìŠ¤ì¼ˆë ˆí†¤ ëª¨í˜•</h2>
    <div style="text-align:center; margin-top:20px;">
      <img src="${overlayImg}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; max-height:900px; object-fit:contain; background:#fff;" />
      <div style="margin-top:10px; font-size:11px; color:#666;">íŒŒë€ìƒ‰(Before) | ì£¼í™©ìƒ‰(After)</div>
    </div>
    <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
      <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
        <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page 2</span>
      </div>
    </div>
  `;
} else {
  sideOverlayContainer.innerHTML = `
    <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px;">ğŸ”„ ì¸¡ë©´ ì˜¤ë²„ë ˆì´ & ìŠ¤ì¼ˆë ˆí†¤ ëª¨í˜•</h2>
    <div style="text-align:center; padding:40px 20px; border:1px dashed #d0d0d0; border-radius:8px; background:#f9fafb; margin-top:20px;">
      <p style="margin:0; font-size:15px; color:#666;">ì¸¡ë©´ ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
      <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
        <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page 2</span>
      </div>
    </div>
  `;
}

document.body.appendChild(sideOverlayContainer);

if (isMobile) {
  await new Promise(resolve => setTimeout(resolve, 100));
}

// ========== í˜ì´ì§€ 3: ì¸¡ë©´ ë¶„ì„ ==========
// âœ… ì¸¡ë©´ ë©”íŠ¸ë¦­ë§Œ ë…ë¦½ì ìœ¼ë¡œ ì¶”ì¶œ (ì •ë©´ ë©”íŠ¸ë¦­ê³¼ ì™„ì „ ë¶„ë¦¬)
const sideMetrics = {};
// ì¸¡ë©´ ë¶„ì„ ì‹œ ì €ì¥ëœ ë…ë¦½ì ì¸ ì¸¡ë©´ ë©”íŠ¸ë¦­ ì‚¬ìš©
// Before/After ì„¸ì…˜ ëª¨ë‘ í™•ì¸í•˜ì—¬ ì¸¡ë©´ ë©”íŠ¸ë¦­ ì¶”ì¶œ

let sideMetricsSource = null;
const sideMetricKeys = ['CVA', 'CVA_S', 'HPD', 'HPD_S', 'TIA', 'TIA_S', 'SAA', 'SAA_S', 'PTA', 'PTA_S', 'KA', 'KA_S', 'GSB', 'GSB_S', 'PDS', 'PDS_S'];

// âœ… ëª¨ë“  ì„¸ì…˜ì—ì„œ ì¸¡ë©´ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
const allSideMetricsSources = [];

// After ì„¸ì…˜ í™•ì¸
if (sessions.After?.metrics?.sideMetrics) {
  allSideMetricsSources.push({ source: sessions.After.metrics.sideMetrics, label: 'After.sideMetrics' });
} else if (sessions.After?.metrics?.fullMetrics && sessions.After.metrics.orientation === "side") {
  allSideMetricsSources.push({ source: sessions.After.metrics.fullMetrics, label: 'After.fullMetrics(side)' });
} else if (sessions.After?.metrics?.fullMetrics) {
  allSideMetricsSources.push({ source: sessions.After.metrics.fullMetrics, label: 'After.fullMetrics' });
}

// Before ì„¸ì…˜ í™•ì¸
if (sessions.Before?.metrics?.sideMetrics) {
  allSideMetricsSources.push({ source: sessions.Before.metrics.sideMetrics, label: 'Before.sideMetrics' });
} else if (sessions.Before?.metrics?.fullMetrics && sessions.Before.metrics.orientation === "side") {
  allSideMetricsSources.push({ source: sessions.Before.metrics.fullMetrics, label: 'Before.fullMetrics(side)' });
} else if (sessions.Before?.metrics?.fullMetrics) {
  allSideMetricsSources.push({ source: sessions.Before.metrics.fullMetrics, label: 'Before.fullMetrics' });
}

// í˜„ì¬ ì„¸ì…˜ í™•ì¸
if (sessions[cur]?.metrics?.sideMetrics) {
  allSideMetricsSources.push({ source: sessions[cur].metrics.sideMetrics, label: `${cur}.sideMetrics` });
} else if (sessions[cur]?.metrics?.fullMetrics && sessions[cur].metrics.orientation === "side") {
  allSideMetricsSources.push({ source: sessions[cur].metrics.fullMetrics, label: `${cur}.fullMetrics(side)` });
} else if (sessions[cur]?.metrics?.fullMetrics) {
  allSideMetricsSources.push({ source: sessions[cur].metrics.fullMetrics, label: `${cur}.fullMetrics` });
}

// âœ… ê°€ì¥ ë§ì€ ì¸¡ë©´ ë©”íŠ¸ë¦­ì„ ê°€ì§„ ì†ŒìŠ¤ ì„ íƒ
if (allSideMetricsSources.length > 0) {
  const sourcesWithCounts = allSideMetricsSources.map(({ source, label }) => {
    const count = Object.keys(source).filter(key => {
      if (key === 'orientation') return false;
      const code = METRIC_KEY_ALIASES[key] || key;
      return sideMetricKeys.includes(code) || sideMetricKeys.includes(key);
    }).length;
    return { source, label, count };
  });
  
  const bestSource = sourcesWithCounts.sort((a, b) => b.count - a.count)[0];
  sideMetricsSource = bestSource.source;
  console.log(`âœ… ì¸¡ë©´ ë©”íŠ¸ë¦­ ì†ŒìŠ¤ ì„ íƒ: ${bestSource.label} (${bestSource.count}ê°œ ë©”íŠ¸ë¦­)`);
}

// ì¸¡ë©´ ë©”íŠ¸ë¦­ í‚¤ë§Œ í•„í„°ë§ (HPA, Tibial ì œì™¸ - ì •ë©´ ì§€í‘œ)
if (sideMetricsSource) {
  Object.keys(sideMetricsSource).forEach(key => {
    // âœ… í‚¤ ë³„ì¹­ í™•ì¸ (METRIC_KEY_ALIASES ì‚¬ìš©)
  const code = METRIC_KEY_ALIASES[key] || key;
    // âœ… ì›ë³¸ í‚¤ì™€ ë³„ì¹­ ëª¨ë‘ í™•ì¸
    if (sideMetricKeys.includes(code) || sideMetricKeys.includes(key)) {
      sideMetrics[key] = sideMetricsSource[key];
  }
});
}

// âœ… sideMetricsSourceê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ í˜„ì¬ ì„¸ì…˜ì—ì„œ ì§ì ‘ ì¸¡ë©´ ë©”íŠ¸ë¦­ ì¶”ì¶œ
if (Object.keys(sideMetrics).length <= 1) { // orientationë§Œ ìˆê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´
  // í˜„ì¬ ì„¸ì…˜ì˜ fullMetricsì—ì„œ ì¸¡ë©´ ë©”íŠ¸ë¦­ ì§ì ‘ ì¶”ì¶œ
  const currentFullMetrics = sessions[cur]?.metrics?.fullMetrics || S.metrics?.fullMetrics || {};
  Object.keys(currentFullMetrics).forEach(key => {
    if (key === 'orientation') return;
    const code = METRIC_KEY_ALIASES[key] || key;
    if (sideMetricKeys.includes(code) || sideMetricKeys.includes(key)) {
      const metric = currentFullMetrics[key];
      if (metric && typeof metric === 'object') {
        const val = metric.value != null ? metric.value : 
                    (metric.value_deg != null ? metric.value_deg : 
                    (metric.value_cm != null ? metric.value_cm : null));
        if (val != null && !isNaN(val) && isFinite(val)) {
          sideMetrics[key] = metric;
        }
      }
  }
});
}

// âœ… ì¸¡ë©´ ë¶„ì„ì„ì„ ëª…ì‹œ
sideMetrics.orientation = "side";

// ì¸¡ë©´ ë¶„ì„ ìˆ˜í–‰ - ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ ìš°ì„  ì‚¬ìš©
let sideAnalysis = null;

// 1ìˆœìœ„: ì €ì¥ëœ ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ í™•ì¸ (After ì„¸ì…˜)
if (sessions.After?.sideAnalysis && sessions.After.sideAnalysis.orientation === "side") {
  sideAnalysis = sessions.After.sideAnalysis;
} 
// 2ìˆœìœ„: Before ì„¸ì…˜ì˜ ì¸¡ë©´ ë¶„ì„ ê²°ê³¼
else if (sessions.Before?.sideAnalysis && sessions.Before.sideAnalysis.orientation === "side") {
  sideAnalysis = sessions.Before.sideAnalysis;
}
// 3ìˆœìœ„: í˜„ì¬ ì„¸ì…˜ì˜ ì¸¡ë©´ ë¶„ì„ ê²°ê³¼
else if (sessions[cur]?.sideAnalysis && sessions[cur].sideAnalysis.orientation === "side") {
  sideAnalysis = sessions[cur].sideAnalysis;
}
// 4ìˆœìœ„: ê¸°ì¡´ analysisê°€ ì¸¡ë©´ ë¶„ì„ì¸ ê²½ìš°
else if (sessions[cur]?.analysis && sessions[cur].analysis.orientation === "side") {
  sideAnalysis = sessions[cur].analysis;
}
// 5ìˆœìœ„: ì¸¡ë©´ ë©”íŠ¸ë¦­ì´ ìˆìœ¼ë©´ ìƒˆë¡œ ë¶„ì„
else if (Object.keys(sideMetrics).length > 1) { // orientation ì œì™¸í•˜ê³  ì‹¤ì œ ë©”íŠ¸ë¦­ì´ ìˆëŠ”ì§€ í™•ì¸
  try {
    // âœ… orientationì„ ì „ë‹¬í•˜ì—¬ ì¸¡ë©´ ë©”íŠ¸ë¦­ë§Œ í•„í„°ë§
    const flatSideMetrics = flattenFullMetrics(sideMetrics, "side");
    sideAnalysis = await analyzeWithDB(flatSideMetrics, "side");
} catch (err) {
  console.warn('ì¸¡ë©´ ë¶„ì„ ì‹¤íŒ¨:', err);
  }
}

// âœ… ì¸¡ë©´ ë¦¬í¬íŠ¸ í˜ì´ì§€ ìƒì„± (í•­ìƒ ìƒì„± - ì¸¡ì • ë°ì´í„°ê°€ ì—†ì–´ë„ í‘œì‹œ)
// ì¸¡ë©´ ë¦¬í¬íŠ¸ëŠ” í•­ìƒ ìƒì„±í•˜ì—¬ ì›¹ì•±ì˜ ëª¨ë“  ë‚´ìš©ì„ PDFì— í¬í•¨
if (true) { // í•­ìƒ ìƒì„±
  const sideReportContainer = document.createElement("div");
  sideReportContainer.id = "sideReportContainer";
  setPageContainerStyle(sideReportContainer);
  sideReportContainer.classList.add('pdf-safe');
  
  // âœ… ì¸¡ë©´ ë©”íŠ¸ë¦­ë§Œìœ¼ë¡œ ì ìˆ˜ ê³„ì‚° (Before/After ë¹„êµ) - ê°œì„  ë²„ì „
  // âœ… 1ìˆœìœ„: sessions.After.metrics.sideMetrics ì§ì ‘ í™•ì¸ (computeAllì—ì„œ ì €ì¥í•œ ê²ƒ)
  let metricsForScore = {};
  
  if (sessions.After?.metrics?.sideMetrics && Object.keys(sessions.After.metrics.sideMetrics).length > 1) {
    // âœ… computeAllì—ì„œ ì €ì¥í•œ ì¸¡ë©´ ë©”íŠ¸ë¦­ ì§ì ‘ ì‚¬ìš©
    metricsForScore = sessions.After.metrics.sideMetrics;
    console.log('âœ… ì¸¡ë©´ ë©”íŠ¸ë¦­: sessions.After.metrics.sideMetrics ì‚¬ìš©');
  } else if (sessions.Before?.metrics?.sideMetrics && Object.keys(sessions.Before.metrics.sideMetrics).length > 1) {
    metricsForScore = sessions.Before.metrics.sideMetrics;
    console.log('âœ… ì¸¡ë©´ ë©”íŠ¸ë¦­: sessions.Before.metrics.sideMetrics ì‚¬ìš©');
  } else if (Object.keys(sideMetrics).length > 1) {
    // âœ… 2ìˆœìœ„: PDF ìƒì„± ì‹œ ìˆ˜ì§‘í•œ sideMetrics ì‚¬ìš©
    metricsForScore = sideMetrics;
    console.log('âœ… ì¸¡ë©´ ë©”íŠ¸ë¦­: PDF ìƒì„± ì‹œ ìˆ˜ì§‘í•œ sideMetrics ì‚¬ìš©');
  } else {
    // âœ… 3ìˆœìœ„: fullMetricsì—ì„œ í•„í„°ë§
  const beforeSideMetrics = sessions.Before?.metrics?.fullMetrics || {};
  const afterSideMetrics = sessions.After?.metrics?.fullMetrics || {};
  
  const filterSideMetrics = (source, target) => {
    Object.keys(source).forEach(key => {
        if (key === 'orientation') return;
      const code = METRIC_KEY_ALIASES[key] || key;
      if (sideMetricKeys.includes(code) || sideMetricKeys.includes(key)) {
        const metric = source[key];
        if (metric && typeof metric === 'object') {
          const val = metric.value != null ? metric.value : 
                      (metric.value_deg != null ? metric.value_deg : 
                      (metric.value_cm != null ? metric.value_cm : null));
          if (val != null && !isNaN(val) && isFinite(val)) {
            target[key] = metric;
          }
        }
      }
    });
  };
  
    const afterFiltered = {};
    const beforeFiltered = {};
  filterSideMetrics(afterSideMetrics, afterFiltered);
    filterSideMetrics(beforeSideMetrics, beforeFiltered);
    
    metricsForScore = Object.keys(afterFiltered).length > 0 ? afterFiltered : 
                      (Object.keys(beforeFiltered).length > 0 ? beforeFiltered : sideMetrics);
    console.log('âœ… ì¸¡ë©´ ë©”íŠ¸ë¦­: fullMetricsì—ì„œ í•„í„°ë§');
  }
  
  // âœ… ì‹¤ì œ ë©”íŠ¸ë¦­ì´ ìˆëŠ”ì§€ í™•ì¸ (orientation ì œì™¸)
  const hasValidMetrics = Object.keys(metricsForScore).some(key => {
    if (key === 'orientation') return false;
    const metric = metricsForScore[key];
    if (!metric || typeof metric !== 'object') return false;
    const val = metric.value != null ? metric.value : 
                (metric.value_deg != null ? metric.value_deg : 
                (metric.value_cm != null ? metric.value_cm : null));
    return val != null && !isNaN(val) && isFinite(val);
  });
  
  if (hasValidMetrics) {
    metricsForScore.orientation = "side";
  }
  
  // âœ… ëª¨ë°”ì¼ì—ì„œë„ ì œëŒ€ë¡œ ì‘ë™í•˜ë„ë¡ ë©”íŠ¸ë¦­ í™•ì¸ ë¡œì§ ê°œì„ 
  // sideMetricsì—ì„œ ì§ì ‘ í™•ì¸ (í•„í„°ë§ ì „ ì›ë³¸ ë°ì´í„° í™•ì¸)
  let finalMetricsForScore = metricsForScore;
  if (!hasValidMetrics && Object.keys(sideMetrics).length > 1) {
    // í•„í„°ë§ëœ ë©”íŠ¸ë¦­ì´ ì—†ìœ¼ë©´ ì›ë³¸ sideMetricsì—ì„œ ì§ì ‘ í™•ì¸
    const directCheck = Object.keys(sideMetrics).some(key => {
      if (key === 'orientation') return false;
      const metric = sideMetrics[key];
      if (!metric || typeof metric !== 'object') return false;
      const val = metric.value != null ? metric.value : 
                  (metric.value_deg != null ? metric.value_deg : 
                  (metric.value_cm != null ? metric.value_cm : null));
      return val != null && !isNaN(val) && isFinite(val);
    });
    
    if (directCheck) {
      finalMetricsForScore = sideMetrics;
      finalMetricsForScore.orientation = "side";
      hasValidMetrics = true;
    }
  }
  
  // âœ… ì¶”ê°€: sessions.After ë˜ëŠ” sessions.Beforeì—ì„œ ì§ì ‘ ì¸¡ë©´ ë©”íŠ¸ë¦­ ì¶”ì¶œ ì‹œë„
  if (!hasValidMetrics) {
    // After ì„¸ì…˜ì˜ ì¸¡ë©´ ë©”íŠ¸ë¦­ ì§ì ‘ í™•ì¸
    const afterFullMetrics = sessions.After?.metrics?.fullMetrics || {};
    const afterSideOnly = {};
    Object.keys(afterFullMetrics).forEach(key => {
      if (key === 'orientation') return;
      const code = METRIC_KEY_ALIASES[key] || key;
      if (sideMetricKeys.includes(code) || sideMetricKeys.includes(key)) {
        const metric = afterFullMetrics[key];
        if (metric && typeof metric === 'object') {
          const val = metric.value != null ? metric.value : 
                      (metric.value_deg != null ? metric.value_deg : 
                      (metric.value_cm != null ? metric.value_cm : null));
          if (val != null && !isNaN(val) && isFinite(val)) {
            afterSideOnly[key] = metric;
          }
        }
      }
    });
    
    if (Object.keys(afterSideOnly).length > 0) {
      afterSideOnly.orientation = "side";
      finalMetricsForScore = afterSideOnly;
      hasValidMetrics = true;
    } else {
      // Before ì„¸ì…˜ì˜ ì¸¡ë©´ ë©”íŠ¸ë¦­ ì§ì ‘ í™•ì¸
      const beforeFullMetrics = sessions.Before?.metrics?.fullMetrics || {};
      const beforeSideOnly = {};
      Object.keys(beforeFullMetrics).forEach(key => {
        if (key === 'orientation') return;
        const code = METRIC_KEY_ALIASES[key] || key;
        if (sideMetricKeys.includes(code) || sideMetricKeys.includes(key)) {
          const metric = beforeFullMetrics[key];
          if (metric && typeof metric === 'object') {
            const val = metric.value != null ? metric.value : 
                        (metric.value_deg != null ? metric.value_deg : 
                        (metric.value_cm != null ? metric.value_cm : null));
            if (val != null && !isNaN(val) && isFinite(val)) {
              beforeSideOnly[key] = metric;
            }
          }
        }
      });
      
      if (Object.keys(beforeSideOnly).length > 0) {
        beforeSideOnly.orientation = "side";
        finalMetricsForScore = beforeSideOnly;
        hasValidMetrics = true;
      }
    }
  }
  
  const sideScoreResult = hasValidMetrics ? computeScoreFromFullMetrics(finalMetricsForScore) : { score: null, reasons: ['ì¸¡ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'], penalties: 0 };
  
  sideReportContainer.innerHTML = `
    <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px; word-wrap:break-word;">ğŸ“Š ì¸¡ë©´ ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸</h2>

    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:15px; margin-bottom:20px; max-width:100%;">
      ${sideScoreResult && sideScoreResult.score != null ? `
      <div style="padding:18px; background:#f0fdf4; border-radius:12px; border:1px solid #bbf7d0; word-wrap:break-word; overflow-wrap:break-word; max-width:100%; box-sizing:border-box;">
        <div style="font-size:13px; font-weight:700; color:#15803d; margin-bottom:8px; word-wrap:break-word;">ğŸ“Š ì¸¡ë©´ ì ìˆ˜</div>
        <div style="font-size:32px; font-weight:800; color:#0b0f14; margin-bottom:6px; word-wrap:break-word;">${sideScoreResult.score}/100</div>
        <div style="font-size:11px; color:#15803d; word-wrap:break-word; overflow-wrap:break-word; white-space:pre-wrap;">${sideScoreResult.reasons && sideScoreResult.reasons.length > 0 ? sideScoreResult.reasons.join(', ') : 'ëª¨ë“  ì§€í‘œê°€ ì •ìƒ ë²”ìœ„ì…ë‹ˆë‹¤'}</div>
      </div>` : (sideScoreResult && sideScoreResult.score === null ? `
      <div style="padding:18px; background:#fef2f2; border-radius:12px; border:1px solid #fecaca; word-wrap:break-word; overflow-wrap:break-word; max-width:100%; box-sizing:border-box;">
        <div style="font-size:13px; font-weight:700; color:#dc2626; margin-bottom:8px; word-wrap:break-word;">âš ï¸ ì¸¡ë©´ ì ìˆ˜ ê³„ì‚° ë¶ˆê°€</div>
        <div style="font-size:12px; color:#991b1b; word-wrap:break-word; overflow-wrap:break-word; white-space:pre-wrap;">${sideScoreResult.reasons && sideScoreResult.reasons.length > 0 ? sideScoreResult.reasons.join(', ') : 'ì¸¡ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'}</div>
      </div>` : '')}

      ${(sideAnalysis?.muscles?.tight && (sideAnalysis.muscles.tight.size > 0 || sideAnalysis.muscles.tight.length > 0)) || (sideAnalysis?.muscles?.weak && (sideAnalysis.muscles.weak.size > 0 || sideAnalysis.muscles.weak.length > 0)) ? `
      <div style="padding:18px; background:#fff7ed; border-radius:12px; border:1px solid #fed7aa; word-wrap:break-word; overflow-wrap:break-word; max-width:100%; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:13px; font-weight:700; color:#c2410c; margin-bottom:8px; word-wrap:break-word;">ğŸ’ª ê·¼ìœ¡ ìƒíƒœ</div>
        ${(sideAnalysis.muscles.tight?.size > 0 || sideAnalysis.muscles.tight?.length > 0) ? `<div style="font-size:11px; margin-bottom:4px; word-wrap:break-word; word-break:break-word; overflow-wrap:break-word; white-space:pre-wrap;"><strong style="color:#dc2626;">ê¸´ì¥</strong> ${sideAnalysis.muscles.tight instanceof Set ? Array.from(sideAnalysis.muscles.tight).join(', ') : (Array.isArray(sideAnalysis.muscles.tight) ? sideAnalysis.muscles.tight.join(', ') : '')}</div>` : ''}
        ${(sideAnalysis.muscles.weak?.size > 0 || sideAnalysis.muscles.weak?.length > 0) ? `<div style="font-size:11px; color:#334155; word-wrap:break-word; word-break:break-word; overflow-wrap:break-word; white-space:pre-wrap;"><strong style="color:#2563eb;">ì•½í™”</strong> ${sideAnalysis.muscles.weak instanceof Set ? Array.from(sideAnalysis.muscles.weak).join(', ') : (Array.isArray(sideAnalysis.muscles.weak) ? sideAnalysis.muscles.weak.join(', ') : '')}</div>` : ''}
      </div>` : ''}
    </div>

    ${(sideAnalysis?.topRecommendations || []).length ? `
    <div style="margin-bottom:20px; padding:15px; background:#f5f3ff; border-radius:12px; border:1px solid #dcd3ff; word-wrap:break-word; overflow-wrap:break-word; max-width:100%; box-sizing:border-box;">
      <div style="font-size:13px; font-weight:700; color:#5c44b8; margin-bottom:8px; word-wrap:break-word;">ğŸ“Œ ì¸¡ë©´ ì£¼ìš” íŒ¨í„´</div>
      <ul style="margin:0; padding-left:18px; font-size:11px; color:#312e81; line-height:1.6; word-wrap:break-word; overflow-wrap:break-word;">
        ${(sideAnalysis.topRecommendations || []).slice(0,3).map((item, idx) => `<li style="margin-bottom:6px; word-wrap:break-word; word-break:break-word; overflow-wrap:break-word; white-space:pre-wrap;">
          <strong>${idx + 1}. ${item.name || item.code}</strong> â€” ${item.abnormal || ''}
          ${item.tight ? `<br><span style="color:#dc2626;">ê¸´ì¥:</span> ${item.tight}` : ''}
          ${item.weak ? `<br><span style="color:#2563eb;">ì•½í™”:</span> ${item.weak}` : ''}
        </li>`).join('')}
      </ul>
    </div>` : ''}

    ${Object.keys(sideMetrics).length > 1 ? `
    <div style="margin-bottom:20px; padding:18px; background:#f0f9ff; border-radius:12px; border:1px solid #bae6fd; word-wrap:break-word; overflow-wrap:break-word; max-width:100%; box-sizing:border-box;">
      <div style="font-size:14px; font-weight:700; color:#0369a1; margin-bottom:12px; word-wrap:break-word;">ğŸ“ ì¸¡ë©´ ì¸¡ì • ì§€í‘œ ìƒì„¸</div>
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; font-size:11px; line-height:1.6;">
        ${Object.keys(sideMetrics).filter(key => key !== 'orientation').map(key => {
          const metric = sideMetrics[key];
          if (!metric || typeof metric !== 'object') return '';
          const value = metric.value != null ? metric.value : 
                       (metric.value_deg != null ? metric.value_deg : 
                       (metric.value_cm != null ? metric.value_cm : null));
          if (value == null || isNaN(value) || !isFinite(value)) return '';
          const unit = metric.unit || (metric.value_deg != null ? 'Â°' : (metric.value_cm != null ? 'cm' : ''));
          const status = metric.status || 'unknown';
          const statusText = {
            'normal': 'âœ… ì •ìƒ',
            'mild': 'âš ï¸ ê²½ë¯¸',
            'moderate': 'âš ï¸ ì¤‘ë“±ë„',
            'severe': 'ğŸ”´ ì‹¬ê°'
          }[status] || status;
          const desc = metric.desc || metric.meaning || key;
          
          // âœ… ì •ìƒ ë²”ìœ„ ì •ë³´ ì¶”ê°€
          let normalRange = '';
          if (key === 'CVA' || key === 'cva') {
            normalRange = '50-90Â°';
          } else if (key === 'HPD' || key === 'hpd') {
            normalRange = '0-2cm';
          } else if (key === 'TIA' || key === 'tia') {
            normalRange = '0-10Â°';
          } else if (key === 'SAA' || key === 'saa') {
            normalRange = '0-10Â°';
          } else if (key === 'PTA' || key === 'pta') {
            normalRange = '5-15Â°';
          } else if (key === 'KA' || key === 'ka') {
            normalRange = '175-185Â°';
          } else if (key === 'GSB' || key === 'gsb') {
            normalRange = '0-10Â°';
          } else if (key === 'PDS' || key === 'pds') {
            normalRange = '0-3Â°';
          }
          
          return `
          <div style="padding:10px; background:#ffffff; border-radius:8px; border:1px solid #e0f2fe;">
            <div style="font-weight:600; color:#0c4a6e; margin-bottom:4px; font-size:12px;">${desc}</div>
            <div style="font-size:18px; font-weight:700; color:#0369a1; margin-bottom:4px;">${value.toFixed(1)}${unit}</div>
            <div style="font-size:10px; color:#64748b; margin-bottom:4px;">${statusText}</div>
            ${normalRange ? `<div style="font-size:9px; color:#94a3b8; margin-top:2px;">ì •ìƒ ë²”ìœ„: ${normalRange}</div>` : ''}
          </div>`;
        }).filter(html => html.trim().length > 0).join('')}
      </div>
    </div>` : ''}

    <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
      <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
        <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page 3</span>
      </div>
    </div>
  `;
  
  document.body.appendChild(sideReportContainer);
  if (isMobile) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  
  try {
    // âœ… í˜ì´ì§€ ë„ˆë¹„ëŠ” 794pxë¡œ ê³ ì •í•˜ê³ , ë†’ì´ë§Œ ë™ì ìœ¼ë¡œ ê³„ì‚°
    const containerWidth = 794;  // PDF í‘œì¤€ ë„ˆë¹„ë¡œ ê³ ì •
    const containerHeight = Math.max(sideReportContainer.scrollHeight, sideReportContainer.offsetHeight);
    
    console.log('ğŸ“„ ì¸¡ë©´ ë¦¬í¬íŠ¸ ìº”ë²„ìŠ¤ ìƒì„±:', { width: containerWidth, height: containerHeight });
    
    sideReportCanvas = await html2canvas(sideReportContainer, {
      ...html2canvasOptions,
      windowWidth: containerWidth,
      windowHeight: containerHeight,
      width: containerWidth,
      height: containerHeight,
      scale: 2  // âœ… ì›ë³¸ í¬ê¸° ìœ ì§€ (ì‚¬ì§„ê³¼ dotê°€ ì˜ ë³´ì´ë„ë¡)
    });
    
    // âœ… ìº”ë²„ìŠ¤ í¬ê¸° ì œí•œ + ì••ì¶•
    if (sideReportCanvas && (sideReportCanvas.width > PDF_MAX_CANVAS_EDGE || sideReportCanvas.height > PDF_MAX_CANVAS_EDGE)) {
      const ratio = Math.min(PDF_MAX_CANVAS_EDGE / sideReportCanvas.width, PDF_MAX_CANVAS_EDGE / sideReportCanvas.height);
      const newCanvas = document.createElement('canvas');
      newCanvas.width = Math.floor(sideReportCanvas.width * ratio);
      newCanvas.height = Math.floor(sideReportCanvas.height * ratio);
      const ctx = newCanvas.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'medium';
      ctx.drawImage(sideReportCanvas, 0, 0, newCanvas.width, newCanvas.height);
      sideReportCanvas = newCanvas;
    }
  } catch (err) {
    console.error('âŒ ì¸¡ë©´ ë¦¬í¬íŠ¸ ìº”ë²„ìŠ¤ ìƒì„± ì‹¤íŒ¨:', err);
    sideReportCanvas = null;
  }
  
  // PDF ì»¨í…Œì´ë„ˆëŠ” DOMì— ìœ ì§€ (exportAsPdfì—ì„œ ì‚¬ìš©)
  // if (document.body.contains(sideReportContainer)) {
  //   document.body.removeChild(sideReportContainer);
  // }
  
  if (isMobile) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}

// ========== í˜ì´ì§€ 4: ì •ë©´ Before & After ==========
  const frontImageContainer = document.createElement("div");
  frontImageContainer.id = "frontImageContainer";
  setPageContainerStyle(frontImageContainer);
  frontImageContainer.classList.add('pdf-safe');
  
if (beforeViews.front || afterViews.front) {
  const beforeImg = beforeViews.front || '';
  const afterImg = afterViews.front || '';
  
    frontImageContainer.innerHTML = `
    <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px;">ğŸ“¸ ì •ë©´ Before & After</h2>
    <div style="display:flex; gap:20px; margin-top:20px;">
      <div style="flex:1; text-align:center;">
        <div style="font-size:14px; font-weight:600; color:#333; margin-bottom:10px;">Before</div>
        ${beforeImg ? `<img src="${beforeImg}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; max-height:800px; object-fit:contain; background:#fff;" />` : '<div style="padding:40px; border:1px dashed #ddd; border-radius:8px; color:#999;">Before ì´ë¯¸ì§€ ì—†ìŒ</div>'}
      </div>
      <div style="flex:1; text-align:center;">
        <div style="font-size:14px; font-weight:600; color:#333; margin-bottom:10px;">After</div>
        ${afterImg ? `<img src="${afterImg}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; max-height:800px; object-fit:contain; background:#fff;" />` : '<div style="padding:40px; border:1px dashed #ddd; border-radius:8px; color:#999;">After ì´ë¯¸ì§€ ì—†ìŒ</div>'}
      </div>
      </div>
      <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
        <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
          <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page 4</span>
        </div>
      </div>
    `;
  } else {
    frontImageContainer.innerHTML = `
    <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px;">ğŸ“¸ ì •ë©´ Before & After</h2>
    <div style="text-align:center; padding:40px 20px; border:1px dashed #d0d0d0; border-radius:8px; background:#f9fafb; margin-top:20px;">
      <p style="margin:0; font-size:15px; color:#666;">ì •ë©´ ì‚¬ì§„ì´ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
      </div>
      <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
        <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
          <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page 4</span>
        </div>
      </div>
    `;
  }
  
  document.body.appendChild(frontImageContainer);
  
  if (isMobile) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }

// ========== í˜ì´ì§€ 5: ì •ë©´ ì˜¤ë²„ë ˆì´ì™€ ìŠ¤ì¼ˆë ˆí†¤ ëª¨í˜• ==========
const frontOverlayContainer = document.createElement("div");
frontOverlayContainer.id = "frontOverlayContainer";
setPageContainerStyle(frontOverlayContainer);
frontOverlayContainer.classList.add('pdf-safe');

if (frontOverlayImg) {
  frontOverlayContainer.innerHTML = `
    <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px;">ğŸ”„ ì •ë©´ ì˜¤ë²„ë ˆì´ & ìŠ¤ì¼ˆë ˆí†¤ ëª¨í˜•</h2>
    <div style="text-align:center; margin-top:20px;">
      <img src="${frontOverlayImg}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; max-height:900px; object-fit:contain; background:#fff;" />
      <div style="margin-top:10px; font-size:11px; color:#666;">íŒŒë€ìƒ‰(Before) | ì£¼í™©ìƒ‰(After)</div>
    </div>
    <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
      <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
        <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page 5</span>
      </div>
    </div>
  `;
} else {
  frontOverlayContainer.innerHTML = `
    <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px;">ğŸ”„ ì •ë©´ ì˜¤ë²„ë ˆì´ & ìŠ¤ì¼ˆë ˆí†¤ ëª¨í˜•</h2>
    <div style="text-align:center; padding:40px 20px; border:1px dashed #d0d0d0; border-radius:8px; background:#f9fafb; margin-top:20px;">
      <p style="margin:0; font-size:15px; color:#666;">ì •ë©´ ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
      <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
        <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page 5</span>
      </div>
    </div>
  `;
}

document.body.appendChild(frontOverlayContainer);

if (isMobile) {
  await new Promise(resolve => setTimeout(resolve, 100));
}

// ========== í˜ì´ì§€ 6: ì •ë©´ ë¶„ì„ ==========
// âœ… ì •ë©´ ë©”íŠ¸ë¦­ë§Œ ë…ë¦½ì ìœ¼ë¡œ ì¶”ì¶œ (ì¸¡ë©´ ë©”íŠ¸ë¦­ê³¼ ì™„ì „ ë¶„ë¦¬)
const frontMetrics = {};
// ì •ë©´ ë¶„ì„ ì‹œ ì €ì¥ëœ ë…ë¦½ì ì¸ ì •ë©´ ë©”íŠ¸ë¦­ ì‚¬ìš©
// Before/After ì„¸ì…˜ ëª¨ë‘ í™•ì¸í•˜ì—¬ ì •ë©´ ë©”íŠ¸ë¦­ ì¶”ì¶œ

let frontMetricsSource = null;
const frontMetricKeys = ['STA', 'STA_F', 'POA', 'POA_F', 'LLD', 'LLD_F', 'TD', 'HTA', 'SPP', 'Q_Angle', 'QAngle', 'Knee_Deviation', 'KneeDev', 'KAS', 'LLAS', 'HPA', 'Tibial_Angle', 'Tibial'];

// âœ… ëª¨ë“  ì„¸ì…˜ì—ì„œ ì •ë©´ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
const allFrontMetricsSources = [];

// After ì„¸ì…˜ í™•ì¸
if (sessions.After?.metrics?.frontMetrics) {
  allFrontMetricsSources.push({ source: sessions.After.metrics.frontMetrics, label: 'After.frontMetrics' });
} else if (sessions.After?.metrics?.fullMetrics && sessions.After.metrics.orientation === "front") {
  allFrontMetricsSources.push({ source: sessions.After.metrics.fullMetrics, label: 'After.fullMetrics(front)' });
} else if (sessions.After?.metrics?.fullMetrics) {
  allFrontMetricsSources.push({ source: sessions.After.metrics.fullMetrics, label: 'After.fullMetrics' });
}

// Before ì„¸ì…˜ í™•ì¸
if (sessions.Before?.metrics?.frontMetrics) {
  allFrontMetricsSources.push({ source: sessions.Before.metrics.frontMetrics, label: 'Before.frontMetrics' });
} else if (sessions.Before?.metrics?.fullMetrics && sessions.Before.metrics.orientation === "front") {
  allFrontMetricsSources.push({ source: sessions.Before.metrics.fullMetrics, label: 'Before.fullMetrics(front)' });
} else if (sessions.Before?.metrics?.fullMetrics) {
  allFrontMetricsSources.push({ source: sessions.Before.metrics.fullMetrics, label: 'Before.fullMetrics' });
}

// í˜„ì¬ ì„¸ì…˜ í™•ì¸
if (sessions[cur]?.metrics?.frontMetrics) {
  allFrontMetricsSources.push({ source: sessions[cur].metrics.frontMetrics, label: `${cur}.frontMetrics` });
} else if (sessions[cur]?.metrics?.fullMetrics && sessions[cur].metrics.orientation === "front") {
  allFrontMetricsSources.push({ source: sessions[cur].metrics.fullMetrics, label: `${cur}.fullMetrics(front)` });
} else if (sessions[cur]?.metrics?.fullMetrics) {
  allFrontMetricsSources.push({ source: sessions[cur].metrics.fullMetrics, label: `${cur}.fullMetrics` });
}

// âœ… ê°€ì¥ ë§ì€ ì •ë©´ ë©”íŠ¸ë¦­ì„ ê°€ì§„ ì†ŒìŠ¤ ì„ íƒ
if (allFrontMetricsSources.length > 0) {
  const sourcesWithCounts = allFrontMetricsSources.map(({ source, label }) => {
    const count = Object.keys(source).filter(key => {
      if (key === 'orientation') return false;
      const code = METRIC_KEY_ALIASES[key] || key;
      return frontMetricKeys.includes(code) || frontMetricKeys.includes(key);
    }).length;
    return { source, label, count };
  });
  
  const bestSource = sourcesWithCounts.sort((a, b) => b.count - a.count)[0];
  frontMetricsSource = bestSource.source;
  console.log(`âœ… ì •ë©´ ë©”íŠ¸ë¦­ ì†ŒìŠ¤ ì„ íƒ: ${bestSource.label} (${bestSource.count}ê°œ ë©”íŠ¸ë¦­)`);
}

// ì •ë©´ ë©”íŠ¸ë¦­ í‚¤ë§Œ í•„í„°ë§ (HPA, Tibial í¬í•¨)
if (frontMetricsSource) {
  Object.keys(frontMetricsSource).forEach(key => {
  const code = METRIC_KEY_ALIASES[key] || key;
  if (frontMetricKeys.includes(code)) {
      frontMetrics[key] = frontMetricsSource[key];
  }
});
}

// âœ… ì •ë©´ ë¶„ì„ì„ì„ ëª…ì‹œ
frontMetrics.orientation = "front";

// ì •ë©´ ë¶„ì„ ìˆ˜í–‰
let frontAnalysis = null;
try {
  if (Object.keys(frontMetrics).length > 0) {
    // âœ… orientationì„ ì „ë‹¬í•˜ì—¬ ì •ë©´ ë©”íŠ¸ë¦­ë§Œ í•„í„°ë§
    const flatFrontMetrics = flattenFullMetrics(frontMetrics, "front");
    frontAnalysis = await analyzeWithDB(flatFrontMetrics, "front");
  }
} catch (err) {
  console.warn('ì •ë©´ ë¶„ì„ ì‹¤íŒ¨:', err);
}

// âœ… ì •ë©´ ë¦¬í¬íŠ¸ í˜ì´ì§€ ìƒì„± (í•­ìƒ ìƒì„± - ì¸¡ì • ë°ì´í„°ê°€ ì—†ì–´ë„ í‘œì‹œ)
// ì •ë©´ ë¦¬í¬íŠ¸ëŠ” í•­ìƒ ìƒì„±í•˜ì—¬ ì›¹ì•±ì˜ ëª¨ë“  ë‚´ìš©ì„ PDFì— í¬í•¨
if (true) { // í•­ìƒ ìƒì„±
  const frontReportContainer = document.createElement("div");
  frontReportContainer.id = "frontReportContainer";
  setPageContainerStyle(frontReportContainer);
  frontReportContainer.classList.add('pdf-safe');
  
  // âœ… ì •ë©´ ë©”íŠ¸ë¦­ë§Œìœ¼ë¡œ ì ìˆ˜ ê³„ì‚°
  const frontScoreResult = computeScoreFromFullMetrics(frontMetrics);
  
  frontReportContainer.innerHTML = `
    <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px; word-wrap:break-word;">ğŸ“Š ì •ë©´ ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸</h2>

    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:15px; margin-bottom:20px; max-width:100%;">
      ${frontScoreResult ? `
      <div style="padding:18px; background:#f0fdf4; border-radius:12px; border:1px solid #bbf7d0; word-wrap:break-word; overflow-wrap:break-word; max-width:100%; box-sizing:border-box;">
        <div style="font-size:13px; font-weight:700; color:#15803d; margin-bottom:8px; word-wrap:break-word;">ğŸ“Š ì •ë©´ ì ìˆ˜</div>
        <div style="font-size:32px; font-weight:800; color:#0b0f14; margin-bottom:6px; word-wrap:break-word;">${frontScoreResult.score}/100</div>
        <div style="font-size:11px; color:#15803d; word-wrap:break-word; overflow-wrap:break-word; white-space:pre-wrap;">${frontScoreResult.reasons ? frontScoreResult.reasons.join(', ') : 'ë°ì´í„° ëˆ„ì  ì¤‘'}</div>
      </div>` : ''}

      ${(frontAnalysis?.muscles?.tight && (frontAnalysis.muscles.tight.size > 0 || frontAnalysis.muscles.tight.length > 0)) || (frontAnalysis?.muscles?.weak && (frontAnalysis.muscles.weak.size > 0 || frontAnalysis.muscles.weak.length > 0)) ? `
      <div style="padding:18px; background:#fff7ed; border-radius:12px; border:1px solid #fed7aa; word-wrap:break-word; overflow-wrap:break-word; max-width:100%; box-sizing:border-box; overflow:hidden;">
        <div style="font-size:13px; font-weight:700; color:#c2410c; margin-bottom:8px; word-wrap:break-word;">ğŸ’ª ê·¼ìœ¡ ìƒíƒœ</div>
        ${(frontAnalysis.muscles.tight?.size > 0 || frontAnalysis.muscles.tight?.length > 0) ? `<div style="font-size:11px; margin-bottom:4px; word-wrap:break-word; word-break:break-word; overflow-wrap:break-word; white-space:pre-wrap;"><strong style="color:#dc2626;">ê¸´ì¥</strong> ${frontAnalysis.muscles.tight instanceof Set ? Array.from(frontAnalysis.muscles.tight).join(', ') : (Array.isArray(frontAnalysis.muscles.tight) ? frontAnalysis.muscles.tight.join(', ') : '')}</div>` : ''}
        ${(frontAnalysis.muscles.weak?.size > 0 || frontAnalysis.muscles.weak?.length > 0) ? `<div style="font-size:11px; color:#334155; word-wrap:break-word; word-break:break-word; overflow-wrap:break-word; white-space:pre-wrap;"><strong style="color:#2563eb;">ì•½í™”</strong> ${frontAnalysis.muscles.weak instanceof Set ? Array.from(frontAnalysis.muscles.weak).join(', ') : (Array.isArray(frontAnalysis.muscles.weak) ? frontAnalysis.muscles.weak.join(', ') : '')}</div>` : ''}
      </div>` : ''}
    </div>

    ${(frontAnalysis?.topRecommendations || []).length ? `
    <div style="margin-bottom:20px; padding:15px; background:#f5f3ff; border-radius:12px; border:1px solid #dcd3ff; word-wrap:break-word; overflow-wrap:break-word; max-width:100%; box-sizing:border-box;">
      <div style="font-size:13px; font-weight:700; color:#5c44b8; margin-bottom:8px; word-wrap:break-word;">ğŸ“Œ ì •ë©´ ì£¼ìš” íŒ¨í„´</div>
      <ul style="margin:0; padding-left:18px; font-size:11px; color:#312e81; line-height:1.6; word-wrap:break-word; overflow-wrap:break-word;">
        ${(frontAnalysis.topRecommendations || []).slice(0,3).map((item, idx) => `<li style="margin-bottom:6px; word-wrap:break-word; word-break:break-word; overflow-wrap:break-word; white-space:pre-wrap;">
          <strong>${idx + 1}. ${item.name || item.code}</strong> â€” ${item.abnormal || ''}
          ${item.tight ? `<br><span style="color:#dc2626;">ê¸´ì¥:</span> ${item.tight}` : ''}
          ${item.weak ? `<br><span style="color:#2563eb;">ì•½í™”:</span> ${item.weak}` : ''}
        </li>`).join('')}
      </ul>
    </div>` : ''}

    <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
      <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
        <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page 6</span>
      </div>
    </div>
  `;
  
  document.body.appendChild(frontReportContainer);
  if (isMobile) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  
  try {
    // âœ… í˜ì´ì§€ ë„ˆë¹„ëŠ” 794pxë¡œ ê³ ì •í•˜ê³ , ë†’ì´ë§Œ ë™ì ìœ¼ë¡œ ê³„ì‚°
    const containerWidth = 794;  // PDF í‘œì¤€ ë„ˆë¹„ë¡œ ê³ ì •
    const containerHeight = Math.max(frontReportContainer.scrollHeight, frontReportContainer.offsetHeight);
    
    console.log('ğŸ“„ ì •ë©´ ë¦¬í¬íŠ¸ ìº”ë²„ìŠ¤ ìƒì„±:', { width: containerWidth, height: containerHeight });
    
    frontReportCanvas = await html2canvas(frontReportContainer, {
      ...html2canvasOptions,
      windowWidth: containerWidth,
      windowHeight: containerHeight,
      width: containerWidth,
      height: containerHeight,
      scale: 2  // âœ… ì›ë³¸ í¬ê¸° ìœ ì§€ (ì‚¬ì§„ê³¼ dotê°€ ì˜ ë³´ì´ë„ë¡)
    });
    
    // âœ… ìº”ë²„ìŠ¤ í¬ê¸° ì œí•œ + ì••ì¶•
    if (frontReportCanvas && (frontReportCanvas.width > PDF_MAX_CANVAS_EDGE || frontReportCanvas.height > PDF_MAX_CANVAS_EDGE)) {
      const ratio = Math.min(PDF_MAX_CANVAS_EDGE / frontReportCanvas.width, PDF_MAX_CANVAS_EDGE / frontReportCanvas.height);
      const newCanvas = document.createElement('canvas');
      newCanvas.width = Math.floor(frontReportCanvas.width * ratio);
      newCanvas.height = Math.floor(frontReportCanvas.height * ratio);
      const ctx = newCanvas.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'medium';
      ctx.drawImage(frontReportCanvas, 0, 0, newCanvas.width, newCanvas.height);
      frontReportCanvas = newCanvas;
    }
  } catch (err) {
    console.error('âŒ ì •ë©´ ë¦¬í¬íŠ¸ ìº”ë²„ìŠ¤ ìƒì„± ì‹¤íŒ¨:', err);
    frontReportCanvas = null;
  }
  
  // PDF ì»¨í…Œì´ë„ˆëŠ” DOMì— ìœ ì§€ (exportAsPdfì—ì„œ ì‚¬ìš©)
  // if (document.body.contains(frontReportContainer)) {
  //   document.body.removeChild(frontReportContainer);
  // }
  
  if (isMobile) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}

const includeHeatmapPage = false;
const totalPages = 9; // ì¸¡ë©´ì‚¬ì§„, ì¸¡ë©´ë¦¬í¬íŠ¸, ì •ë©´ì‚¬ì§„, ì •ë©´ë¦¬í¬íŠ¸, ì¢…í•©ë¦¬í¬íŠ¸, í•„ë¼í…ŒìŠ¤, AIì‹¬ì¸µ, ì²´í˜•ìœ í˜•, ìµœì¢…ë¶„ì„
const pageIndexMap = {
  sideImage: 1,
  sideReport: 2,
  frontImage: 3,
  frontReport: 4,
  combinedReport: 5,
  pilates: 6,
  aiDeep: 7,
  postureType: 8,
  conclusion: 9
};
let planTexts = { quickHtml: '', fullText: '' };

let canvas2 = null;
if (false && includeHeatmapPage && (beforeHeatmap || afterHeatmap)) {
  const page2Container = document.createElement("div");
  setPageContainerStyle(page2Container);
  page2Container.classList.add('pdf-safe');

  page2Container.innerHTML = `
    <div style="margin-bottom:20px;">
      <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:8px;">ğŸ”¥ AI Confidence Heatmap</h2>
      <div style="font-size:11px; color:#666; margin-bottom:20px;">ê° ê´€ì ˆì˜ AI ì‹ ë¢°ë„ë¥¼ ìƒ‰ìƒìœ¼ë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤. ë¹¨ê°•(ë†’ìŒ) â†’ ë…¸ë‘(ì¤‘ê°„) â†’ íŒŒë‘(ë‚®ìŒ)</div>

      ${beforeHeatmap ? `
      <div style="margin-bottom:25px;">
        <div style="font-size:13px; font-weight:600; margin-bottom:10px; color:#6366f1;">Before Confidence Heatmap</div>
        <div style="font-size:10px; color:#666; margin-bottom:5px;">AI í‰ê·  ì‹ ë¢°ë„: ${(beforeAvgConfidence * 100).toFixed(1)}%</div>
        <img src="${beforeHeatmap}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; max-height:400px; object-fit:contain;" />
      </div>
      ` : ''}

      ${afterHeatmap ? `
      <div style="margin-bottom:25px;">
        <div style="font-size:13px; font-weight:600; margin-bottom:10px; color:#10b981;">After Confidence Heatmap</div>
        <div style="font-size:10px; color:#666; margin-bottom:5px;">AI í‰ê·  ì‹ ë¢°ë„: ${(afterAvgConfidence * 100).toFixed(1)}%</div>
        <img src="${afterHeatmap}" style="width:100%; height:auto; border-radius:8px; border:1px solid #ddd; display:block; max-height:400px; object-fit:contain;" />
      </div>
      ` : ''}

      ${!beforeHeatmap && !afterHeatmap ? `
      <div style="padding:40px; text-align:center; color:#999; font-size:12px;">
        Confidence ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. AI í¬ì¦ˆ ê°ì§€ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.
      </div>
      ` : ''}
    </div>

    <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
      <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
        <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page 2/${totalPages}</span>
      </div>
    </div>
  `;

  document.body.appendChild(page2Container);
  if (isMobile) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  // í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ ì»¨í…Œì´ë„ˆ í¬ê¸°ë¥¼ ì •í™•íˆ ê³„ì‚°
  const container2Width = Math.max(page2Container.scrollWidth, page2Container.offsetWidth, 794);
  const container2Height = Math.max(page2Container.scrollHeight, page2Container.offsetHeight);
  
  canvas2 = await html2canvas(page2Container, {
    ...html2canvasOptions,
    windowWidth: container2Width,
    windowHeight: container2Height,
    width: container2Width,
    height: container2Height
  });
  // PDF ì»¨í…Œì´ë„ˆëŠ” DOMì— ìœ ì§€ (exportAsPdfì—ì„œ ì‚¬ìš©)
  // if (document.body.contains(page2Container)) {
  //   document.body.removeChild(page2Container);
  // }
  
  // ìº”ë²„ìŠ¤ ì¦‰ì‹œ ì••ì¶• (4ê°œ ì‚¬ì§„ ì²˜ë¦¬ ì‹œ ë©”ëª¨ë¦¬ ì ˆì•½)
  if (canvas2 && (canvas2.width > PDF_MAX_CANVAS_EDGE || canvas2.height > PDF_MAX_CANVAS_EDGE)) {
    const ratio = Math.min(PDF_MAX_CANVAS_EDGE / canvas2.width, PDF_MAX_CANVAS_EDGE / canvas2.height);
    const newCanvas = document.createElement('canvas');
    newCanvas.width = Math.floor(canvas2.width * ratio);
    newCanvas.height = Math.floor(canvas2.height * ratio);
    const ctx = newCanvas.getContext('2d');
    ctx.drawImage(canvas2, 0, 0, newCanvas.width, newCanvas.height);
    canvas2 = newCanvas;
  }
  
  if (isMobile) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}

// âœ… ì¤‘ë³µ ì •ì˜ ì œê±°: setPageContainerStyleì€ ì´ë¯¸ 8478ë²ˆ ì¤„ì— ì •ì˜ë˜ì–´ ìˆìŒ

// ========== í˜ì´ì§€ 3: ìˆ˜ì¹˜í‘œ + ë³€í™” ê·¸ë˜í”„ (Chart.js) ==========
const comparison = analyzeBeforeAfterComparison();
try {
  await ensureChartLibrary();
} catch (chartErr) {
  console.warn('Chart.js ì¤€ë¹„ ì‹¤íŒ¨:', chartErr);
}
const page3Container = document.createElement("div");
setPageContainerStyle(page3Container);

// chartCanvas ë³€ìˆ˜ë¥¼ í•¨ìˆ˜ ìŠ¤ì½”í”„ ìƒë‹¨ì—ì„œ ì„ ì–¸
let chartCanvas = null;

let page3HTML = '<h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px;">ğŸ“Š ìˆ˜ì¹˜í‘œ + ë³€í™” ê·¸ë˜í”„</h2>';

if(comparison && comparison.results.length > 0) {
  let comparisonTableHTML = '<table style="width:100%; border-collapse:collapse; font-size:12px; table-layout:auto; margin-bottom:15px; word-wrap:break-word; overflow-wrap:break-word;"><tr style="background:#f0f0f0;"><th style="padding:8px 6px; text-align:left; border:1px solid #ddd; font-weight:600; word-wrap:break-word; overflow-wrap:break-word; word-break:break-word;">í•­ëª©</th><th style="padding:8px 6px; text-align:center; border:1px solid #ddd; font-weight:600; word-wrap:break-word; overflow-wrap:break-word; word-break:break-word;">Before</th><th style="padding:8px 6px; text-align:center; border:1px solid #ddd; font-weight:600; word-wrap:break-word; overflow-wrap:break-word; word-break:break-word;">After</th><th style="padding:8px 6px; text-align:center; border:1px solid #ddd; font-weight:600; word-wrap:break-word; overflow-wrap:break-word; word-break:break-word;">ë³€í™”</th><th style="padding:8px 6px; text-align:left; border:1px solid #ddd; font-weight:600; word-wrap:break-word; overflow-wrap:break-word; word-break:break-word;">ë¶„ì„</th></tr>';

  comparison.results.forEach((item, idx) => {
    const statusColor = item.status === 'improved' ? '#2ec4b6' : item.status === 'worsened' ? '#ff6b6b' : '#666';
    const statusIcon = item.status === 'improved' ? 'â†‘' : item.status === 'worsened' ? 'â†“' : 'â†’';
    const deltaStr = item.delta >= 0 ? '+' + item.delta.toFixed(1) : item.delta.toFixed(1);
    comparisonTableHTML += `<tr style="background:${idx % 2 === 0 ? '#fff' : '#fafafa'};">
      <td style="padding:8px 6px; border:1px solid #ddd; word-wrap:break-word; overflow-wrap:break-word; word-break:break-word; font-size:12px; white-space:normal;">${item.name}</td>
      <td style="padding:8px 6px; border:1px solid #ddd; text-align:center; word-wrap:break-word; overflow-wrap:break-word; word-break:break-word; font-size:12px; white-space:normal;">${item.before.toFixed(item.unit === 'ì ' ? 2 : 1)}${item.unit}</td>
      <td style="padding:8px 6px; border:1px solid #ddd; text-align:center; word-wrap:break-word; overflow-wrap:break-word; word-break:break-word; font-size:12px; white-space:normal;">${item.after.toFixed(item.unit === 'ì ' ? 2 : 1)}${item.unit}</td>
      <td style="padding:8px 6px; border:1px solid #ddd; text-align:center; word-wrap:break-word; overflow-wrap:break-word; word-break:break-word; font-size:12px; color:${statusColor}; font-weight:600; white-space:normal;">${deltaStr}${item.unit} ${statusIcon}</td>
      <td style="padding:8px 6px; border:1px solid #ddd; word-wrap:break-word; overflow-wrap:break-word; word-break:break-word; font-size:11px; color:#555; line-height:1.4; white-space:normal;">${item.comment}</td>
    </tr>`;
  });
  comparisonTableHTML += '</table>';

  // âœ… ì§€í‘œë³„ ìš´ë™ ê¶Œì¥ì‚¬í•­ ìƒì„± í•¨ìˆ˜ (ë³€í™” ë°ì´í„° ê¸°ë°˜)
  const generateExerciseRecommendation = (item) => {
    const { name, before, after, delta, unit, normal } = item;
    const absDelta = Math.abs(delta);
    
    // CVA (ë‘ê°œê²½ì¶”ê°)
    if (name.includes('CVA')) {
      if (after < 50) {
        // ì •ìƒ ë²”ìœ„ ë¯¸ë§Œ
        if (delta > 0) {
          return `â‘  í„±ë‹¹ê¹€ ìš´ë™(Chin tuck): í•˜ë£¨ 3ì„¸íŠ¸, ê° 10íšŒ ìœ ì§€ (ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼ ê°•í™”)<br>â‘¡ ê²½ì¶” ì‹ ì „ ìš´ë™: ìƒë¶€ ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­ í›„ ì‹ ì „ (10ì´ˆ ìœ ì§€ Ã— 5íšŒ)<br>â‘¢ í‰ì‡„ìœ ëŒê·¼ ìŠ¤íŠ¸ë ˆì¹­: ì¢Œìš° ê° 30ì´ˆ Ã— 3íšŒ<br>â‘£ ëª© ê·¼ë ¥ ê°•í™”: ì €í•­ ë°´ë“œ ì‚¬ìš©í•œ ê²½ì¶” êµ´ê³¡ ìš´ë™`;
        } else {
          return `â‘  ì¦‰ì‹œ í„±ë‹¹ê¹€ ìš´ë™ ê°•í™”: í•˜ë£¨ 5ì„¸íŠ¸, ê° 15íšŒ (ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼ ê¸´ê¸‰ ê°•í™”)<br>â‘¡ ìƒë¶€ ìŠ¹ëª¨ê·¼Â·í‰ì‡„ìœ ëŒê·¼ ìŠ¤íŠ¸ë ˆì¹­: ê° 30ì´ˆ Ã— 5íšŒ<br>â‘¢ ì‘ì—… í™˜ê²½ ê°œì„ : ëª¨ë‹ˆí„° ëˆˆë†’ì´ ì¡°ì •, ì˜ì ë†’ì´ ì¡°ì •<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥ (${after.toFixed(1)}Â°ëŠ” ì •ìƒ ë²”ìœ„ ë°–)`;
        }
      } else {
        // ì •ìƒ ë²”ìœ„ ë‚´
        return `â‘  ìœ ì§€ ìš´ë™: í„±ë‹¹ê¹€ ìš´ë™ ì£¼ 3íšŒ ìœ ì§€<br>â‘¡ ì˜ˆë°© ìŠ¤íŠ¸ë ˆì¹­: ìƒë¶€ ìŠ¹ëª¨ê·¼Â·í‰ì‡„ìœ ëŒê·¼ ì£¼ 2íšŒ<br>â‘¢ ìì„¸ ì¸ì‹: ì‘ì—… ì¤‘ 30ë¶„ë§ˆë‹¤ ìì„¸ í™•ì¸`;
      }
    }
    
    // HPD (ë‘ë¶€ì „ë°©ì´ë™)
    if (name.includes('HPD')) {
      if (after > 2) {
        // ì •ìƒ ë²”ìœ„ ì´ˆê³¼
        if (delta < 0) {
          return `â‘  í„±ë‹¹ê¹€ ìš´ë™ ì§€ì†: í•˜ë£¨ 4ì„¸íŠ¸, ê° 12íšŒ (${absDelta.toFixed(1)}cm ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼ ê°•í™”: ëˆ„ì›Œì„œ í„±ë‹¹ê¹€ (10ì´ˆ ìœ ì§€ Ã— 10íšŒ)<br>â‘¢ í‰ì¶” ì‹ ì „ ìš´ë™: ë“± ìœ—ë¶€ë¶„ ìœ ì—°ì„± í™•ë³´<br>â‘£ ìƒë¶€ ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ê° 30ì´ˆ Ã— 3íšŒ`;
        } else {
          return `â‘  ê¸´ê¸‰ í„±ë‹¹ê¹€ ìš´ë™: í•˜ë£¨ 5ì„¸íŠ¸, ê° 15íšŒ (ì‹¬ë¶€ ê²½ì¶” êµ´ê³¡ê·¼ ê¸´ê¸‰ ê°•í™”)<br>â‘¡ í‰ì‡„ìœ ëŒê·¼Â·í›„ë‘í•˜ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ê° 30ì´ˆ Ã— 5íšŒ<br>â‘¢ ì‘ì—… í™˜ê²½ ê°œì„ : ëª¨ë‹ˆí„° ëˆˆë†’ì´ ì¡°ì • í•„ìˆ˜<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê°•ë ¥ ê¶Œì¥ (${after.toFixed(1)}cmëŠ” ì‹¬ê° ìˆ˜ì¤€)`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: í„±ë‹¹ê¹€ ìš´ë™ ì£¼ 2íšŒ ìœ ì§€<br>â‘¡ ì˜ˆë°© ìŠ¤íŠ¸ë ˆì¹­: ìƒë¶€ ìŠ¹ëª¨ê·¼ ì£¼ 1íšŒ`;
      }
    }
    
    // PTA (ê³¨ë°˜ ì „í›„ê²½ì‚¬ê°)
    if (name.includes('PTA')) {
      if (after > 15 || after < 0) {
        // ì •ìƒ ë²”ìœ„ ë°–
        if (delta < 0 && after > 0) {
          return `â‘  ë‘”ê·¼ ê°•í™” ì§€ì†: í™ ë¸Œë¦¿ì§€ 3ì„¸íŠ¸ Ã— 15íšŒ (${absDelta.toFixed(1)}Â° ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ì¥ìš”ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ëŸ°ì§€ ìì„¸ 30ì´ˆ Ã— 3íšŒ<br>â‘¢ ì½”ì–´ ì•ˆì •í™”: í”Œë­í¬ 30ì´ˆ Ã— 3ì„¸íŠ¸<br>â‘£ í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­: ì„œì„œ ì•ìœ¼ë¡œ êµ½íˆê¸° 30ì´ˆ Ã— 3íšŒ`;
        } else if (delta > 0) {
          return `â‘  ë‘”ê·¼ ê¸´ê¸‰ ê°•í™”: í™ ë¸Œë¦¿ì§€ 4ì„¸íŠ¸ Ã— 20íšŒ (ê³¨ë°˜ í›„ë°©ê²½ì‚¬ êµì •)<br>â‘¡ ì¥ìš”ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ëŸ°ì§€ ìì„¸ 30ì´ˆ Ã— 5íšŒ<br>â‘¢ ì½”ì–´ ì•ˆì •í™” ê°•í™”: í”Œë­í¬ 45ì´ˆ Ã— 4ì„¸íŠ¸<br>â‘£ ì²™ì¶”ê¸°ë¦½ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ê³ ì–‘ì´ ìì„¸ 10íšŒ`;
        } else {
          return `â‘  ë‘”ê·¼ ê°•í™”: í™ ë¸Œë¦¿ì§€ 3ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¡ ì¥ìš”ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ëŸ°ì§€ ìì„¸ 30ì´ˆ Ã— 3íšŒ<br>â‘¢ ì½”ì–´ ì•ˆì •í™”: í”Œë­í¬ 30ì´ˆ Ã— 3ì„¸íŠ¸`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: í™ ë¸Œë¦¿ì§€ ì£¼ 2íšŒ<br>â‘¡ ì¥ìš”ê·¼ ìŠ¤íŠ¸ë ˆì¹­ ì£¼ 1íšŒ`;
      }
    }
    
    // KA (ë¬´ë¦ê°)
    if (name.includes('KA')) {
      const isInRange = after >= 175 && after <= 185;
      if (!isInRange) {
        if (after < 175) {
          return `â‘  ëŒ€í‡´ì‚¬ë‘ê·¼ ê· í˜• ê°•í™”: ë ˆê·¸ ìµìŠ¤í…ì…˜ 3ì„¸íŠ¸ Ã— 12íšŒ<br>â‘¡ ë¬´ë¦ ì •ë ¬ ìš´ë™: ìŠ¤í…ì—… ìš´ë™ 3ì„¸íŠ¸ Ã— 10íšŒ<br>â‘¢ í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­: ì„œì„œ ì•ìœ¼ë¡œ êµ½íˆê¸° 30ì´ˆ Ã— 3íšŒ<br>â‘£ ë¬´ë¦ ì•ˆì •í™”: ë°œëª© ë¬´ê²Œ ì‚¬ìš©í•œ ë ˆê·¸ ì»¬`;
        } else {
          return `â‘  ë¬´ë¦ ê³¼ì‹ ì „ êµì •: í–„ìŠ¤íŠ¸ë§ ê°•í™” 3ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¡ ëŒ€í‡´ì‚¬ë‘ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ì„œì„œ ë¬´ë¦ êµ½íˆê¸° 30ì´ˆ Ã— 3íšŒ<br>â‘¢ ë¬´ë¦ ì•ˆì •í™”: ë°œëª© ë¬´ê²Œ ì‚¬ìš©í•œ ë ˆê·¸ ì»¬<br>â‘£ ì¢…ì•„ë¦¬ ê·¼ìœ¡ ê°•í™”: í ë ˆì´ì¦ˆ 3ì„¸íŠ¸ Ã— 15íšŒ`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ë ˆê·¸ ìµìŠ¤í…ì…˜ ì£¼ 2íšŒ<br>â‘¡ ë¬´ë¦ ì•ˆì •í™” ìš´ë™ ì£¼ 1íšŒ`;
      }
    }
    
    // GSB (ì¤‘ë ¥ì¤‘ì‹¬ì„ )
    if (name.includes('GSB')) {
      if (after > 2) {
        if (delta < 0) {
          return `â‘  ì „ì‹  ì •ë ¬ ìš´ë™ ì§€ì†: ì›” ìŠ¤ì¿¼íŠ¸ 3ì„¸íŠ¸ Ã— 12íšŒ (${absDelta.toFixed(1)}cm ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ì½”ì–´ ì•ˆì •í™”: í”Œë­í¬ 30ì´ˆ Ã— 3ì„¸íŠ¸<br>â‘¢ ê· í˜• ìš´ë™: í•œ ë°œ ì„œê¸° 30ì´ˆ Ã— ì¢Œìš° 3íšŒ<br>â‘£ ì²™ì¶” ì •ë ¬ ìš´ë™: ì²™ì¶” íšŒì „ ìŠ¤íŠ¸ë ˆì¹­ 10íšŒ`;
        } else {
          return `â‘  ì „ì‹  ì •ë ¬ ìš´ë™ ê°•í™”: ì›” ìŠ¤ì¿¼íŠ¸ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¡ ì½”ì–´ ì•ˆì •í™” ê°•í™”: í”Œë­í¬ 45ì´ˆ Ã— 4ì„¸íŠ¸<br>â‘¢ ê· í˜• ìš´ë™: í•œ ë°œ ì„œê¸° 45ì´ˆ Ã— ì¢Œìš° 5íšŒ<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥ (${after.toFixed(1)}cmëŠ” ì¤‘ë“±ë„ ì´ìƒ)`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ì›” ìŠ¤ì¿¼íŠ¸ ì£¼ 2íšŒ<br>â‘¡ ê· í˜• ìš´ë™ ì£¼ 1íšŒ`;
      }
    }
    
    // TIA (ì²´ê°„ê²½ì‚¬ê°)
    if (name.includes('TIA')) {
      if (after > 10 || after < 0) {
        return `â‘  ì²´ê°„ ì •ë ¬ ìš´ë™: ì²™ì¶” íšŒì „ ìŠ¤íŠ¸ë ˆì¹­ 10íšŒ<br>â‘¡ ì½”ì–´ ì•ˆì •í™”: ì‚¬ì´ë“œ í”Œë­í¬ 30ì´ˆ Ã— ì¢Œìš° 3íšŒ<br>â‘¢ ë“± ê·¼ìœ¡ ê°•í™”: ë¡œìš° ìš´ë™ 3ì„¸íŠ¸ Ã— 12íšŒ<br>â‘£ í‰ì¶” ì‹ ì „ ìš´ë™: ê³ ì–‘ì´-ì†Œ ìì„¸ 10íšŒ`;
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ì²™ì¶” íšŒì „ ìŠ¤íŠ¸ë ˆì¹­ ì£¼ 2íšŒ<br>â‘¡ ì½”ì–´ ì•ˆì •í™” ì£¼ 1íšŒ`;
      }
    }
    
    // SAA (ì–´ê¹¨ì „ë°©ê°)
    if (name.includes('SAA')) {
      if (after > 10) {
        return `â‘  ë‘¥ê·¼ì–´ê¹¨ êµì •: ì „ê±°ê·¼ ê°•í™” ìš´ë™ 3ì„¸íŠ¸ Ã— 12íšŒ<br>â‘¡ í‰ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ë¬¸í‹€ ìŠ¤íŠ¸ë ˆì¹­ 30ì´ˆ Ã— 3íšŒ<br>â‘¢ ë“± ê·¼ìœ¡ ê°•í™”: ë¡œìš° ìš´ë™ 3ì„¸íŠ¸ Ã— 15íšŒ<br>â‘£ ì–´ê¹¨ ì•ˆì •í™”: ì™¸íšŒì „ ê·¼ìœ¡ ê°•í™”`;
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ì „ê±°ê·¼ ê°•í™” ì£¼ 2íšŒ<br>â‘¡ í‰ê·¼ ìŠ¤íŠ¸ë ˆì¹­ ì£¼ 1íšŒ`;
      }
    }
    
    // HPA (ê³ ê´€ì ˆê°)
    if (name.includes('HPA')) {
      if (after > 10 || after < 0) {
        return `â‘  ë¨¸ë¦¬-ê³¨ë°˜ ì •ë ¬ ìš´ë™: ì²™ì¶” ì‹ ì „ ìš´ë™ 10íšŒ<br>â‘¡ ì½”ì–´ ì•ˆì •í™”: í”Œë­í¬ 30ì´ˆ Ã— 3ì„¸íŠ¸<br>â‘¢ ê³ ê´€ì ˆ ê°€ë™ì„±: í™ ì„œí´ 10íšŒ Ã— ì¢Œìš°<br>â‘£ ì²´ê°„ í˜‘ì‘ ìš´ë™: ë²„ë“œë… ìì„¸ 10íšŒ`;
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ì²™ì¶” ì‹ ì „ ìš´ë™ ì£¼ 2íšŒ<br>â‘¡ ì½”ì–´ ì•ˆì •í™” ì£¼ 1íšŒ`;
      }
    }
    
    // PDS (ìì„¸ì ìˆ˜)
    if (name.includes('PDS')) {
      if (delta < 0) {
        return `â‘  ì¢…í•© ìì„¸ ê°œì„  í”„ë¡œê·¸ë¨ ì§€ì† (${absDelta.toFixed(1)}ì  ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ì½”ì–´ ì•ˆì •í™”: í”Œë­í¬ 30ì´ˆ Ã— 3ì„¸íŠ¸<br>â‘¢ ì „ì‹  ì •ë ¬ ìš´ë™: ì›” ìŠ¤ì¿¼íŠ¸ 3ì„¸íŠ¸ Ã— 12íšŒ<br>â‘£ ê· í˜• ìš´ë™: í•œ ë°œ ì„œê¸° 30ì´ˆ Ã— ì¢Œìš° 3íšŒ`;
      } else if (delta > 0) {
        return `â‘  ì¢…í•© ìì„¸ ê°œì„  í”„ë¡œê·¸ë¨ ê°•í™” í•„ìš”<br>â‘¡ ì½”ì–´ ì•ˆì •í™” ê°•í™”: í”Œë­í¬ 45ì´ˆ Ã— 4ì„¸íŠ¸<br>â‘¢ ì „ì‹  ì •ë ¬ ìš´ë™: ì›” ìŠ¤ì¿¼íŠ¸ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥`;
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ì½”ì–´ ì•ˆì •í™” ì£¼ 2íšŒ<br>â‘¡ ì „ì‹  ì •ë ¬ ìš´ë™ ì£¼ 1íšŒ`;
      }
    }
    
    // âœ… ì •ë©´ ì§€í‘œ ìš´ë™ ê¶Œì¥ì‚¬í•­ ì¶”ê°€
    // STA (ì–´ê¹¨ê¸°ìš¸ê¸°ê°)
    if (name.includes('STA') || name.includes('ì–´ê¹¨ê¸°ìš¸ê¸°')) {
      const afterAbs = Math.abs(after);
      if (afterAbs > 3) {
        if (Math.abs(delta) < 0) {
          return `â‘  ì–´ê¹¨ ëŒ€ì¹­ì„± ê°œì„  ìš´ë™ ì§€ì†: ì‚¬ì´ë“œ ë ˆì´ì¦ˆ 3ì„¸íŠ¸ Ã— 12íšŒ (${absDelta.toFixed(1)}Â° ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ìƒë¶€ ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ì¢Œìš° ê° 30ì´ˆ Ã— 3íšŒ<br>â‘¢ ì–´ê¹¨ ì•ˆì •í™”: ì™¸íšŒì „ ê·¼ìœ¡ ê°•í™” ìš´ë™<br>â‘£ ì½”ì–´ ì•ˆì •í™”: ì‚¬ì´ë“œ í”Œë­í¬ 30ì´ˆ Ã— ì¢Œìš° 3íšŒ`;
        } else {
          return `â‘  ì–´ê¹¨ ëŒ€ì¹­ì„± êµì • ìš´ë™: ì‚¬ì´ë“œ ë ˆì´ì¦ˆ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¡ ìƒë¶€ ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ì¢Œìš° ê° 30ì´ˆ Ã— 5íšŒ<br>â‘¢ ì–´ê¹¨ ì•ˆì •í™” ê°•í™”: ì™¸íšŒì „ ê·¼ìœ¡ ê°•í™” ìš´ë™<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥ (${afterAbs.toFixed(1)}Â°ëŠ” ì •ìƒ ë²”ìœ„ ë°–)`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ì‚¬ì´ë“œ ë ˆì´ì¦ˆ ì£¼ 2íšŒ<br>â‘¡ ì–´ê¹¨ ìŠ¤íŠ¸ë ˆì¹­ ì£¼ 1íšŒ`;
      }
    }
    
    // POA (ê³¨ë°˜ê¸°ìš¸ê¸°ê°) - ì •ë©´
    if ((name.includes('POA') && name.includes('ê³¨ë°˜ê¸°ìš¸ê¸°')) || (name.includes('POA') && !name.includes('ì „í›„'))) {
      const afterAbs = Math.abs(after);
      if (afterAbs > 3) {
        if (Math.abs(delta) < 0) {
          return `â‘  ê³¨ë°˜ ëŒ€ì¹­ì„± ê°œì„  ìš´ë™ ì§€ì†: ì‚¬ì´ë“œ ë ˆê·¸ ë ˆì´ì¦ˆ 3ì„¸íŠ¸ Ã— 15íšŒ (${absDelta.toFixed(1)}Â° ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ì¤‘ë‘”ê·¼ ê°•í™”: í´ë¨ì‰˜ ìš´ë™ 3ì„¸íŠ¸ Ã— 12íšŒ<br>â‘¢ TFL-QL ìŠ¤íŠ¸ë ˆì¹­: ê° 30ì´ˆ Ã— 3íšŒ<br>â‘£ ì½”ì–´ ì•ˆì •í™”: ì‚¬ì´ë“œ í”Œë­í¬ 30ì´ˆ Ã— ì¢Œìš° 3íšŒ`;
        } else {
          return `â‘  ê³¨ë°˜ ëŒ€ì¹­ì„± êµì • ìš´ë™: ì‚¬ì´ë“œ ë ˆê·¸ ë ˆì´ì¦ˆ 4ì„¸íŠ¸ Ã— 20íšŒ<br>â‘¡ ì¤‘ë‘”ê·¼ ê¸´ê¸‰ ê°•í™”: í´ë¨ì‰˜ ìš´ë™ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¢ TFL-QL ìŠ¤íŠ¸ë ˆì¹­: ê° 30ì´ˆ Ã— 5íšŒ<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥ (${afterAbs.toFixed(1)}Â°ëŠ” ì •ìƒ ë²”ìœ„ ë°–)`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ì‚¬ì´ë“œ ë ˆê·¸ ë ˆì´ì¦ˆ ì£¼ 2íšŒ<br>â‘¡ ì¤‘ë‘”ê·¼ ê°•í™” ì£¼ 1íšŒ`;
      }
    }
    
    // LLD (í•˜ì§€ê¸¸ì´ì°¨)
    if (name.includes('LLD') || name.includes('í•˜ì§€ê¸¸ì´')) {
      const afterAbs = Math.abs(after);
      if (afterAbs > 1) {
        if (delta < 0) {
          return `â‘  í•˜ì§€ ëŒ€ì¹­ì„± ê°œì„  ìš´ë™ ì§€ì†: í ë¦¬í”„íŠ¸ ìš´ë™ 3ì„¸íŠ¸ Ã— 12íšŒ (${absDelta.toFixed(1)}cm ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ê³¨ë°˜ êµì • ìš´ë™: í´ë¨ì‰˜ ìš´ë™ 3ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¢ ì¤‘ë‘”ê·¼ ê°•í™”: ì‚¬ì´ë“œ ë ˆê·¸ ë ˆì´ì¦ˆ 3ì„¸íŠ¸ Ã— 12íšŒ<br>â‘£ TFL-QL ìŠ¤íŠ¸ë ˆì¹­: ê° 30ì´ˆ Ã— 3íšŒ`;
        } else {
          return `â‘  í•˜ì§€ ëŒ€ì¹­ì„± êµì • ìš´ë™: í ë¦¬í”„íŠ¸ ìš´ë™ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¡ ê³¨ë°˜ êµì • ìš´ë™ ê°•í™”: í´ë¨ì‰˜ ìš´ë™ 4ì„¸íŠ¸ Ã— 20íšŒ<br>â‘¢ ì¤‘ë‘”ê·¼ ê¸´ê¸‰ ê°•í™”: ì‚¬ì´ë“œ ë ˆê·¸ ë ˆì´ì¦ˆ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥ (${afterAbs.toFixed(1)}cmëŠ” êµ¬ì¡°ì  ë¶ˆê· í˜• ê°€ëŠ¥ì„±)`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: í ë¦¬í”„íŠ¸ ìš´ë™ ì£¼ 2íšŒ<br>â‘¡ ê³¨ë°˜ êµì • ìš´ë™ ì£¼ 1íšŒ`;
      }
    }
    
    // Q_Angle (Qê°)
    if (name.includes('Q-Angle') || name.includes('Qê°')) {
      if (after < 10 || after > 20) {
        if (after < 10) {
          return `â‘  ë¬´ë¦ ì •ë ¬ êµì •: ëŒ€í‡´ì‚¬ë‘ê·¼ ê· í˜• ê°•í™” 3ì„¸íŠ¸ Ã— 12íšŒ<br>â‘¡ ë¬´ë¦ ì•ˆì •í™”: ë ˆê·¸ ìµìŠ¤í…ì…˜ 3ì„¸íŠ¸ Ã— 10íšŒ<br>â‘¢ ë‚´ì¸¡ ê´‘ê·¼ ê°•í™”: ë°œëª© ë¬´ê²Œ ì‚¬ìš©í•œ ë ˆê·¸ ì»¬<br>â‘£ ë¬´ë¦ ì •ë ¬ ìš´ë™: ìŠ¤í…ì—… ìš´ë™ 3ì„¸íŠ¸ Ã— 10íšŒ`;
        } else {
          return `â‘  ë¬´ë¦ ì •ë ¬ êµì •: ëŒ€í‡´ì‚¬ë‘ê·¼ ìŠ¤íŠ¸ë ˆì¹­ 30ì´ˆ Ã— 3íšŒ<br>â‘¡ ì™¸ì¸¡ ê´‘ê·¼ ê°•í™”: ë ˆê·¸ í”„ë ˆìŠ¤ 3ì„¸íŠ¸ Ã— 12íšŒ<br>â‘¢ ë¬´ë¦ ì•ˆì •í™”: ë°œëª© ë¬´ê²Œ ì‚¬ìš©í•œ ë ˆê·¸ ì»¬<br>â‘£ ë¬´ë¦ ì •ë ¬ ìš´ë™: ìŠ¤í…ì—… ìš´ë™ 3ì„¸íŠ¸ Ã— 10íšŒ`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ë ˆê·¸ ìµìŠ¤í…ì…˜ ì£¼ 2íšŒ<br>â‘¡ ë¬´ë¦ ì•ˆì •í™” ìš´ë™ ì£¼ 1íšŒ`;
      }
    }
    
    // Knee_Deviation (ë¬´ë¦í¸ìœ„)
    if (name.includes('Knee Dev') || name.includes('ë¬´ë¦í¸ìœ„')) {
      const afterAbs = Math.abs(after);
      if (afterAbs > 3) {
        if (Math.abs(delta) < 0) {
          return `â‘  ë¬´ë¦ ì •ë ¬ ê°œì„  ìš´ë™ ì§€ì†: ìŠ¤í…ì—… ìš´ë™ 3ì„¸íŠ¸ Ã— 12íšŒ (${absDelta.toFixed(1)}Â° ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ëŒ€í‡´ì‚¬ë‘ê·¼ ê· í˜• ê°•í™”: ë ˆê·¸ ìµìŠ¤í…ì…˜ 3ì„¸íŠ¸ Ã— 12íšŒ<br>â‘¢ ë¬´ë¦ ì•ˆì •í™”: ë°œëª© ë¬´ê²Œ ì‚¬ìš©í•œ ë ˆê·¸ ì»¬<br>â‘£ ë¬´ë¦ ì •ë ¬ ìŠ¤íŠ¸ë ˆì¹­: ì„œì„œ ë¬´ë¦ êµ½íˆê¸° 30ì´ˆ Ã— 3íšŒ`;
        } else {
          return `â‘  ë¬´ë¦ ì •ë ¬ êµì • ìš´ë™: ìŠ¤í…ì—… ìš´ë™ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¡ ëŒ€í‡´ì‚¬ë‘ê·¼ ê· í˜• ê°•í™”: ë ˆê·¸ ìµìŠ¤í…ì…˜ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¢ ë¬´ë¦ ì•ˆì •í™” ê°•í™”: ë°œëª© ë¬´ê²Œ ì‚¬ìš©í•œ ë ˆê·¸ ì»¬<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥ (${afterAbs.toFixed(1)}Â°ëŠ” ì •ìƒ ë²”ìœ„ ë°–)`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ìŠ¤í…ì—… ìš´ë™ ì£¼ 2íšŒ<br>â‘¡ ë¬´ë¦ ì•ˆì •í™” ìš´ë™ ì£¼ 1íšŒ`;
      }
    }
    
    // TD (ì²´ê°„í¸ìœ„)
    if (name.includes('TD') || name.includes('ì²´ê°„í¸ìœ„')) {
      const afterAbs = Math.abs(after);
      if (afterAbs > 3) {
        if (Math.abs(delta) < 0) {
          return `â‘  ì²´ê°„ ì •ë ¬ ê°œì„  ìš´ë™ ì§€ì†: ì²™ì¶” íšŒì „ ìŠ¤íŠ¸ë ˆì¹­ 10íšŒ (${absDelta.toFixed(1)}Â° ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ì½”ì–´ ì•ˆì •í™”: ì‚¬ì´ë“œ í”Œë­í¬ 30ì´ˆ Ã— ì¢Œìš° 3íšŒ<br>â‘¢ ë“± ê·¼ìœ¡ ê°•í™”: ë¡œìš° ìš´ë™ 3ì„¸íŠ¸ Ã— 12íšŒ<br>â‘£ ì²™ì¶” ì •ë ¬ ìš´ë™: ì²™ì¶” íšŒì „ ìŠ¤íŠ¸ë ˆì¹­ 10íšŒ`;
        } else {
          return `â‘  ì²´ê°„ ì •ë ¬ êµì • ìš´ë™: ì²™ì¶” íšŒì „ ìŠ¤íŠ¸ë ˆì¹­ 15íšŒ<br>â‘¡ ì½”ì–´ ì•ˆì •í™” ê°•í™”: ì‚¬ì´ë“œ í”Œë­í¬ 45ì´ˆ Ã— ì¢Œìš° 4íšŒ<br>â‘¢ ë“± ê·¼ìœ¡ ê°•í™”: ë¡œìš° ìš´ë™ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥ (${afterAbs.toFixed(1)}Â°ëŠ” ì •ìƒ ë²”ìœ„ ë°–)`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ì²™ì¶” íšŒì „ ìŠ¤íŠ¸ë ˆì¹­ ì£¼ 2íšŒ<br>â‘¡ ì½”ì–´ ì•ˆì •í™” ì£¼ 1íšŒ`;
      }
    }
    
    // HTA (ë¨¸ë¦¬ê¸°ìš¸ê¸°ê°)
    if (name.includes('HTA') || name.includes('ë¨¸ë¦¬ê¸°ìš¸ê¸°')) {
      const afterAbs = Math.abs(after);
      if (afterAbs > 3) {
        if (Math.abs(delta) < 0) {
          return `â‘  ë¨¸ë¦¬ ëŒ€ì¹­ì„± ê°œì„  ìš´ë™ ì§€ì†: ëª© ì¸¡ë©´ ìŠ¤íŠ¸ë ˆì¹­ 30ì´ˆ Ã— ì¢Œìš° 3íšŒ (${absDelta.toFixed(1)}Â° ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ìƒë¶€ ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ì¢Œìš° ê° 30ì´ˆ Ã— 3íšŒ<br>â‘¢ ê²½ì¶” ì•ˆì •í™”: í„±ë‹¹ê¹€ ìš´ë™ 3ì„¸íŠ¸ Ã— 10íšŒ<br>â‘£ ëª© ê·¼ë ¥ ê°•í™”: ì €í•­ ë°´ë“œ ì‚¬ìš©í•œ ê²½ì¶” ì¸¡ë©´ ìš´ë™`;
        } else {
          return `â‘  ë¨¸ë¦¬ ëŒ€ì¹­ì„± êµì • ìš´ë™: ëª© ì¸¡ë©´ ìŠ¤íŠ¸ë ˆì¹­ 30ì´ˆ Ã— ì¢Œìš° 5íšŒ<br>â‘¡ ìƒë¶€ ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹­: ì¢Œìš° ê° 30ì´ˆ Ã— 5íšŒ<br>â‘¢ ê²½ì¶” ì•ˆì •í™” ê°•í™”: í„±ë‹¹ê¹€ ìš´ë™ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥ (${afterAbs.toFixed(1)}Â°ëŠ” ì •ìƒ ë²”ìœ„ ë°–)`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ëª© ì¸¡ë©´ ìŠ¤íŠ¸ë ˆì¹­ ì£¼ 2íšŒ<br>â‘¡ ê²½ì¶” ì•ˆì •í™” ì£¼ 1íšŒ`;
      }
    }
    
    // SPP (ì–´ê¹¨ê³¨ë°˜í‰í–‰ë„)
    if (name.includes('SPP') || name.includes('ì–´ê¹¨ê³¨ë°˜í‰í–‰')) {
      const afterAbs = Math.abs(after);
      if (afterAbs > 3) {
        const beforeAbs = Math.abs(before);
        if (afterAbs < beforeAbs - 1) {
          return `â‘  ì–´ê¹¨-ê³¨ë°˜ ì •ë ¬ ê°œì„  ìš´ë™ ì§€ì†: ì‚¬ì´ë“œ í”Œë­í¬ 30ì´ˆ Ã— ì¢Œìš° 3íšŒ (${(beforeAbs - afterAbs).toFixed(1)}Â° ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ì½”ì–´ ì•ˆì •í™”: í”Œë­í¬ 30ì´ˆ Ã— 3ì„¸íŠ¸<br>â‘¢ ì¤‘ë‘”ê·¼ ê°•í™”: í´ë¨ì‰˜ ìš´ë™ 3ì„¸íŠ¸ Ã— 15íšŒ<br>â‘£ ì²™ì¶” ì •ë ¬ ìš´ë™: ì²™ì¶” íšŒì „ ìŠ¤íŠ¸ë ˆì¹­ 10íšŒ`;
        } else {
          return `â‘  ì–´ê¹¨-ê³¨ë°˜ ì •ë ¬ êµì • ìš´ë™: ì‚¬ì´ë“œ í”Œë­í¬ 45ì´ˆ Ã— ì¢Œìš° 4íšŒ<br>â‘¡ ì½”ì–´ ì•ˆì •í™” ê°•í™”: í”Œë­í¬ 45ì´ˆ Ã— 4ì„¸íŠ¸<br>â‘¢ ì¤‘ë‘”ê·¼ ê¸´ê¸‰ ê°•í™”: í´ë¨ì‰˜ ìš´ë™ 4ì„¸íŠ¸ Ã— 20íšŒ<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥ (${afterAbs.toFixed(1)}Â°ëŠ” ì •ìƒ ë²”ìœ„ ë°–)`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ì‚¬ì´ë“œ í”Œë­í¬ ì£¼ 2íšŒ<br>â‘¡ ì½”ì–´ ì•ˆì •í™” ì£¼ 1íšŒ`;
      }
    }
    
    // KAS (ë¬´ë¦ì •ë ¬ëŒ€ì¹­ì„±)
    if (name.includes('KAS') || name.includes('ë¬´ë¦ì •ë ¬ëŒ€ì¹­')) {
      const afterAbs = Math.abs(after);
      if (afterAbs > 3) {
        if (Math.abs(delta) < 0) {
          return `â‘  ë¬´ë¦ ëŒ€ì¹­ì„± ê°œì„  ìš´ë™ ì§€ì†: ìŠ¤í…ì—… ìš´ë™ 3ì„¸íŠ¸ Ã— 12íšŒ (${absDelta.toFixed(1)}Â° ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ëŒ€í‡´ì‚¬ë‘ê·¼ ê· í˜• ê°•í™”: ë ˆê·¸ ìµìŠ¤í…ì…˜ 3ì„¸íŠ¸ Ã— 12íšŒ<br>â‘¢ ë¬´ë¦ ì•ˆì •í™”: ë°œëª© ë¬´ê²Œ ì‚¬ìš©í•œ ë ˆê·¸ ì»¬<br>â‘£ ë¬´ë¦ ì •ë ¬ ìŠ¤íŠ¸ë ˆì¹­: ì„œì„œ ë¬´ë¦ êµ½íˆê¸° 30ì´ˆ Ã— 3íšŒ`;
        } else {
          return `â‘  ë¬´ë¦ ëŒ€ì¹­ì„± êµì • ìš´ë™: ìŠ¤í…ì—… ìš´ë™ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¡ ëŒ€í‡´ì‚¬ë‘ê·¼ ê· í˜• ê°•í™”: ë ˆê·¸ ìµìŠ¤í…ì…˜ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¢ ë¬´ë¦ ì•ˆì •í™” ê°•í™”: ë°œëª© ë¬´ê²Œ ì‚¬ìš©í•œ ë ˆê·¸ ì»¬<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥ (${afterAbs.toFixed(1)}Â°ëŠ” ì •ìƒ ë²”ìœ„ ë°–)`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: ìŠ¤í…ì—… ìš´ë™ ì£¼ 2íšŒ<br>â‘¡ ë¬´ë¦ ì•ˆì •í™” ìš´ë™ ì£¼ 1íšŒ`;
      }
    }
    
    // LLAS (í•˜ì§€ì¶•ëŒ€ì¹­ì„±)
    if (name.includes('LLAS') || name.includes('í•˜ì§€ì¶•ëŒ€ì¹­')) {
      const afterAbs = Math.abs(after);
      if (afterAbs > 3) {
        if (Math.abs(delta) < 0) {
          return `â‘  í•˜ì§€ ëŒ€ì¹­ì„± ê°œì„  ìš´ë™ ì§€ì†: í ë¦¬í”„íŠ¸ ìš´ë™ 3ì„¸íŠ¸ Ã— 12íšŒ (${absDelta.toFixed(1)}Â° ê°œì„  íš¨ê³¼ ìœ ì§€)<br>â‘¡ ê³¨ë°˜ êµì • ìš´ë™: í´ë¨ì‰˜ ìš´ë™ 3ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¢ ì¤‘ë‘”ê·¼ ê°•í™”: ì‚¬ì´ë“œ ë ˆê·¸ ë ˆì´ì¦ˆ 3ì„¸íŠ¸ Ã— 12íšŒ<br>â‘£ ë¬´ë¦ ì •ë ¬ ìš´ë™: ìŠ¤í…ì—… ìš´ë™ 3ì„¸íŠ¸ Ã— 10íšŒ`;
        } else {
          return `â‘  í•˜ì§€ ëŒ€ì¹­ì„± êµì • ìš´ë™: í ë¦¬í”„íŠ¸ ìš´ë™ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘¡ ê³¨ë°˜ êµì • ìš´ë™ ê°•í™”: í´ë¨ì‰˜ ìš´ë™ 4ì„¸íŠ¸ Ã— 20íšŒ<br>â‘¢ ì¤‘ë‘”ê·¼ ê¸´ê¸‰ ê°•í™”: ì‚¬ì´ë“œ ë ˆê·¸ ë ˆì´ì¦ˆ 4ì„¸íŠ¸ Ã— 15íšŒ<br>â‘£ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥ (${afterAbs.toFixed(1)}Â°ëŠ” ì •ìƒ ë²”ìœ„ ë°–)`;
        }
      } else {
        return `â‘  ìœ ì§€ ìš´ë™: í ë¦¬í”„íŠ¸ ìš´ë™ ì£¼ 2íšŒ<br>â‘¡ ê³¨ë°˜ êµì • ìš´ë™ ì£¼ 1íšŒ`;
      }
    }
    
    // ê¸°ë³¸ ê¶Œì¥ì‚¬í•­
    return `â‘  í•´ë‹¹ ë¶€ìœ„ ê·¼ìœ¡ ë¶ˆê· í˜• êµì • ìš´ë™<br>â‘¡ ìì„¸ ê°œì„  í”„ë¡œê·¸ë¨<br>â‘¢ ì „ë¬¸ê°€ ìƒë‹´ ê¶Œì¥`;
  };

  page3HTML += `<div style="margin-bottom:20px;">${comparisonTableHTML}</div>
    <div id="beforeAfterChartSection"></div>
    
    <!-- âœ… Before-After ìƒì„¸ ë¶„ì„ ì„¹ì…˜ ì¶”ê°€ -->
    <div style="margin-top:20px; padding:15px; background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0;">
      <div style="font-size:14px; font-weight:700; color:#0b0f14; margin-bottom:15px; border-bottom:2px solid #cbd5e1; padding-bottom:8px;">ğŸ“Š Before-After ìƒì„¸ ë¶„ì„</div>
      
      ${comparison.results.filter(r => r.status === 'improved').length > 0 ? `
      <div style="margin-bottom:15px; padding:12px; background:#f0fdf4; border-radius:8px; border-left:4px solid #2ec4b6;">
        <div style="font-size:13px; font-weight:600; color:#2ec4b6; margin-bottom:10px;">âœ… ê°œì„ ëœ ì§€í‘œ (${comparison.results.filter(r => r.status === 'improved').length}ê°œ)</div>
        ${comparison.results.filter(r => r.status === 'improved').map(item => `
          <div style="margin-bottom:8px; padding:8px; background:#fff; border-radius:6px; border:1px solid #bbf7d0;">
            <div style="font-size:12px; font-weight:600; color:#15803d; margin-bottom:4px;">${item.name}</div>
            <div style="font-size:11px; color:#333; line-height:1.6;">
              <strong>ë³€í™”:</strong> ${item.before.toFixed(item.unit === 'ì ' ? 2 : 1)}${item.unit} â†’ ${item.after.toFixed(item.unit === 'ì ' ? 2 : 1)}${item.unit} (${item.delta >= 0 ? '+' : ''}${item.delta.toFixed(item.unit === 'ì ' ? 2 : 1)}${item.unit})<br>
              <strong>ë¶„ì„:</strong> ${item.comment}<br>
              <strong>ìœ ì§€ ìš´ë™:</strong> ${generateExerciseRecommendation(item)}
            </div>
          </div>
        `).join('')}
      </div>` : ''}
      
      ${comparison.results.filter(r => r.status === 'worsened').length > 0 ? `
      <div style="margin-bottom:15px; padding:12px; background:#fef2f2; border-radius:8px; border-left:4px solid #f87171;">
        <div style="font-size:13px; font-weight:600; color:#dc2626; margin-bottom:10px;">âš ï¸ ì•…í™”ëœ ì§€í‘œ (${comparison.results.filter(r => r.status === 'worsened').length}ê°œ)</div>
        ${comparison.results.filter(r => r.status === 'worsened').map(item => `
          <div style="margin-bottom:8px; padding:8px; background:#fff; border-radius:6px; border:1px solid #fecaca;">
            <div style="font-size:12px; font-weight:600; color:#dc2626; margin-bottom:4px;">${item.name}</div>
            <div style="font-size:11px; color:#333; line-height:1.6;">
              <strong>ë³€í™”:</strong> ${item.before.toFixed(item.unit === 'ì ' ? 2 : 1)}${item.unit} â†’ ${item.after.toFixed(item.unit === 'ì ' ? 2 : 1)}${item.unit} (${item.delta >= 0 ? '+' : ''}${item.delta.toFixed(item.unit === 'ì ' ? 2 : 1)}${item.unit})<br>
              <strong>ë¶„ì„:</strong> ${item.comment}<br>
              <strong>ê¶Œì¥ ìš´ë™:</strong> ${generateExerciseRecommendation(item)}
            </div>
          </div>
        `).join('')}
      </div>` : ''}
      
      ${comparison.results.filter(r => r.status === 'stable').length > 0 ? `
      <div style="margin-bottom:15px; padding:12px; background:#f1f5f9; border-radius:8px; border-left:4px solid #64748b;">
        <div style="font-size:13px; font-weight:600; color:#475569; margin-bottom:10px;">â†’ ì•ˆì •ëœ ì§€í‘œ (${comparison.results.filter(r => r.status === 'stable').length}ê°œ)</div>
        <div style="font-size:11px; color:#475569; line-height:1.6;">
          ${comparison.results.filter(r => r.status === 'stable').map(item => `${item.name} (${item.comment})`).join(' | ')}
        </div>
      </div>` : ''}
      
    <div style="margin-top:15px; padding:12px; background:#e8f5e9; border-radius:8px; border-left:4px solid #2ec4b6;">
      <div style="font-size:12px; font-weight:600; margin-bottom:8px; color:#2ec4b6;">ğŸ“ˆ ì „ì²´ ë³€í™” ìš”ì•½</div>
      <div style="font-size:11px; line-height:1.6; color:#333;">${comparison.summary.overallComment}</div>
      </div>
    </div>`;
} else {
  page3HTML += '<div style="padding:40px; text-align:center; color:#999;">Before-After ë¹„êµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
}

const metricsPageNumber = pageIndexMap.metrics;
page3HTML += `<div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
      <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
        <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page ${metricsPageNumber}/${totalPages}</span>
      </div>
    </div>`;

page3Container.innerHTML = page3HTML;
const labels = comparison?.results?.map(r => r.name) || [];
const beforeData = comparison?.results?.map(r => r.before) || [];
const afterData = comparison?.results?.map(r => r.after) || [];

const chartSectionPlaceholder = page3Container.querySelector('#beforeAfterChartSection');
if(chartSectionPlaceholder) {
  const section = document.createElement('div');
  section.style.marginTop = '20px';
  section.innerHTML = `
    <div style="font-size:12px; font-weight:600; margin-bottom:10px; color:#333;">ğŸ“ˆ Before-After ê·¸ë˜í”„ (Chart.js)</div>
    <div style="background:#fff; padding:15px; border-radius:8px; border:1px solid #ddd;">
      <div style="font-size:10px; color:#666; margin-bottom:8px;">ğŸ”µ Before (êµì • ì „) | ğŸŸ¢ After (êµì • í›„) | âš ï¸ ë¶‰ì€ ê°’ = ì •ìƒë²”ìœ„ ë²—ì–´ë‚¨</div>
    </div>
  `;
  const graphShell = section.querySelector('div:nth-child(2)');
  chartCanvas = document.createElement('canvas');
  chartCanvas.width = 800;
  chartCanvas.height = 400;
  chartCanvas.style.width = '100%';
  chartCanvas.style.maxHeight = '420px';
  graphShell.appendChild(chartCanvas);
  chartSectionPlaceholder.replaceWith(section);

  if(typeof Chart !== 'undefined') {
    const ctx = chartCanvas.getContext('2d');
    chartCanvas.chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Before',
            data: beforeData,
            backgroundColor: beforeData.map((v, i) => 
              chartOutOfRange(labels[i], v) ? 'rgba(231,76,60,0.8)' : 'rgba(52,152,219,0.8)'),
            borderColor: beforeData.map((v, i) => 
              chartOutOfRange(labels[i], v) ? '#C0392B' : '#21618C'),
            borderWidth: 1
          },
          {
            label: 'After',
            data: afterData,
            backgroundColor: afterData.map((v, i) => 
              chartOutOfRange(labels[i], v) ? 'rgba(231,76,60,0.8)' : 'rgba(46,204,113,0.8)'),
            borderColor: afterData.map((v, i) => 
              chartOutOfRange(labels[i], v) ? '#C0392B' : '#1E8449'),
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { 
            display: true, 
            text: 'Beforeâ€“After ìì„¸ ë¹„êµ ê·¸ë˜í”„', 
            font: { size: 16, weight: 'bold' },
            padding: { top: 10, bottom: 20 }
          },
          legend: { 
            position: 'top',
            labels: {
              font: { size: 12 },
              padding: 15
            }
          },
          tooltip: { 
            callbacks: { 
              label: (ctx) => `${ctx.dataset.label}: ${ctx.formattedValue}${comparison.results[ctx.dataIndex].unit}` 
            } 
          }
        },
        scales: {
          y: { 
            beginAtZero: true, 
            title: { 
              display: true, 
              text: 'ë‹¨ìœ„ (Â° / cm)',
              font: { size: 12 }
            },
            ticks: {
              font: { size: 10 }
            }
          },
          x: { 
            ticks: { 
              autoSkip: false, 
              maxRotation: 45, 
              minRotation: 45,
              font: { size: 9 }
            }
          }
        }
      }
    });
    await waitForChartRender(chartCanvas.chartInstance);
    
    // ì°¨íŠ¸ê°€ ì™„ì „íˆ ë Œë”ë§ë  ë•Œê¹Œì§€ ì¶”ê°€ ëŒ€ê¸°
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // ì°¨íŠ¸ ìº”ë²„ìŠ¤ í¬ê¸° í™•ì¸ ë° ì¬ì„¤ì •
    if (chartCanvas.width === 0 || chartCanvas.height === 0) {
      console.warn('âš ï¸ ì°¨íŠ¸ ìº”ë²„ìŠ¤ í¬ê¸°ê°€ 0ì…ë‹ˆë‹¤. ì¬ì„¤ì •í•©ë‹ˆë‹¤.');
      chartCanvas.width = 800;
      chartCanvas.height = 400;
      if (chartCanvas.chartInstance) {
        chartCanvas.chartInstance.resize();
        await waitForChartRender(chartCanvas.chartInstance);
        await new Promise(resolve => setTimeout(resolve, 300));
      }
    }
  }
}

document.body.appendChild(page3Container);

// í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ ì»¨í…Œì´ë„ˆ í¬ê¸°ë¥¼ ì •í™•íˆ ê³„ì‚°
const container3Width = Math.max(page3Container.scrollWidth, page3Container.offsetWidth, 794);
const container3Height = Math.max(page3Container.scrollHeight, page3Container.offsetHeight);

let canvas3 = await html2canvas(page3Container, {
  ...html2canvasOptions,
  windowWidth: container3Width,
  windowHeight: container3Height,
  width: container3Width,
  height: container3Height
});

// PDF ì»¨í…Œì´ë„ˆëŠ” DOMì— ìœ ì§€ (exportAsPdfì—ì„œ ì‚¬ìš©)
// if (document.body.contains(page3Container)) {
//   document.body.removeChild(page3Container);
// }

// ìº”ë²„ìŠ¤ ì¦‰ì‹œ ì••ì¶• (4ê°œ ì‚¬ì§„ ì²˜ë¦¬ ì‹œ ë©”ëª¨ë¦¬ ì ˆì•½)
if (canvas3 && (canvas3.width > PDF_MAX_CANVAS_EDGE || canvas3.height > PDF_MAX_CANVAS_EDGE)) {
  const ratio = Math.min(PDF_MAX_CANVAS_EDGE / canvas3.width, PDF_MAX_CANVAS_EDGE / canvas3.height);
  const newCanvas = document.createElement('canvas');
  newCanvas.width = Math.floor(canvas3.width * ratio);
  newCanvas.height = Math.floor(canvas3.height * ratio);
  const ctx = newCanvas.getContext('2d');
  ctx.drawImage(canvas3, 0, 0, newCanvas.width, newCanvas.height);
  canvas3 = newCanvas;
}

if (isMobile) {
  await new Promise(resolve => setTimeout(resolve, 100));
}

// ========== í˜ì´ì§€ 5: ì¢…í•© ë¦¬í¬íŠ¸ (ì¸¡ë©´+ì •ë©´ ì¢…í•© ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸ ë° ì¢…í•©ì ìˆ˜) ==========
const page4Container = document.createElement("div");
page4Container.id = "page4Container";
setPageContainerStyle(page4Container);

// After metrics ì¶”ì¶œ (DB ê¸°ë°˜ ë¶„ì„ìš©)
const afterMetricsForDB = {};
const aMetricsForDB = sessions.After?.metrics?.fullMetrics || {};
const metricKeys = ['CVA', 'HPD', 'TIA', 'SAA', 'PTA', 'KA', 'Tibial_Angle', 'GSB', 'HPA', 
                    'STA', 'STA_F', 'POA', 'POA_F', 'TD', 'HTA', 'SPP', 'LLD', 'LLD_F'];
metricKeys.forEach(key => {
  const val = aMetricsForDB[key]?.value != null ? aMetricsForDB[key].value : 
              (aMetricsForDB[key]?.value_deg != null ? aMetricsForDB[key].value_deg : 
              (aMetricsForDB[key]?.value_cm != null ? aMetricsForDB[key].value_cm : null));
  if(val != null) {
    afterMetricsForDB[key] = val;
  }
});

// DB ê¸°ë°˜ AI ë¶„ì„ ìˆ˜í–‰ (ì „ì²´ metrics ì‚¬ìš©)
let dbAnalysis = null;
try {
  if(Object.keys(afterMetricsForDB).length > 0) {
    dbAnalysis = await runDBDrivenAI(afterMetricsForDB);
  }
} catch(err) {
  console.warn('DB ê¸°ë°˜ ë¶„ì„ ì‹¤íŒ¨:', err);
}

// âœ… ì „ì²´ ì²´í˜• ì ìˆ˜ ê³„ì‚° (ì›¹ì•±ê³¼ ë™ì¼í•œ ì ìˆ˜ ì‚¬ìš©)
// 1ìˆœìœ„: ì›¹ì•±ì—ì„œ ì´ë¯¸ ê³„ì‚°ëœ ì ìˆ˜ ì‚¬ìš© (sessions[cur].score ë˜ëŠ” sessions.After?.score)
let scoreResult = null;
if (sessions.After?.score && typeof sessions.After.score === 'object' && sessions.After.score.score != null) {
  scoreResult = sessions.After.score;
} else if (sessions[cur]?.score && typeof sessions[cur].score === 'object' && sessions[cur].score.score != null) {
  scoreResult = sessions[cur].score;
} else {
  // 2ìˆœìœ„: fullMetricsì—ì„œ ì ìˆ˜ ê³„ì‚°
  const fullMetricsForScore = sessions.After?.metrics?.fullMetrics || sessions[cur]?.metrics?.fullMetrics || {};
  scoreResult = computeScoreFromFullMetrics(fullMetricsForScore);
}

const memberNameForPDF1 = memberName || 'íšŒì›';

// âœ… íŒ¨í„´ ìš”ì•½ - ì¸¡ë©´ ë¶„ì„ê³¼ ì •ë©´ ë¶„ì„ ëª¨ë‘ í¬í•¨
const patterns = [];
// ì¸¡ë©´ ë¶„ì„ íŒ¨í„´ ì¶”ê°€
if(sideAnalysis && sideAnalysis.pilates && sideAnalysis.pilates.length > 0) {
  sideAnalysis.pilates.forEach(item => {
    if(item.name || item.issue) {
      patterns.push(`[ì¸¡ë©´] ${item.name || item.issue}`);
    }
  });
}
// ì •ë©´ ë¶„ì„ íŒ¨í„´ ì¶”ê°€
if(frontAnalysisForPDF && frontAnalysisForPDF.pilates && frontAnalysisForPDF.pilates.length > 0) {
  frontAnalysisForPDF.pilates.forEach(item => {
    if(item.name || item.issue) {
      patterns.push(`[ì •ë©´] ${item.name || item.issue}`);
    }
  });
}
// í†µí•© ë¶„ì„ íŒ¨í„´ ì¶”ê°€
if(analysis && analysis.pilates && analysis.pilates.length > 0) {
  analysis.pilates.forEach(item => {
    if(item.name || item.issue) {
      const patternName = item.name || item.issue;
      // ì¤‘ë³µ ì œê±°
      if(!patterns.some(p => p.includes(patternName))) {
        patterns.push(patternName);
      }
    }
  });
}
planTexts = buildPlanTexts({
  memberName: memberNameForPDF1,
  patterns,
  scoreResult,
  analysis,
  comparisonSummary: comparison?.summary?.overallComment || ''
});

page4Container.innerHTML = `
  <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px; word-wrap:break-word;">ğŸ“Š ì¢…í•© ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸ (ì¸¡ë©´ + ì •ë©´)</h2>

  <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:15px; margin-bottom:20px; max-width:100%;">
    ${scoreResult ? `
    <div style="padding:18px; background:#f0fdf4; border-radius:12px; border:1px solid #bbf7d0; word-wrap:break-word; overflow-wrap:break-word; max-width:100%; box-sizing:border-box;">
      <div style="font-size:13px; font-weight:700; color:#15803d; margin-bottom:8px; word-wrap:break-word;">ğŸ“Š ì²´í˜• ì¢…í•© ì ìˆ˜</div>
      <div style="font-size:32px; font-weight:800; color:#0b0f14; margin-bottom:6px; word-wrap:break-word;">${scoreResult.score}/100</div>
      <div style="font-size:11px; color:#15803d; word-wrap:break-word; overflow-wrap:break-word; white-space:pre-wrap;">${scoreResult.reasons ? scoreResult.reasons.join(', ') : 'ë°ì´í„° ëˆ„ì  ì¤‘'}</div>
    </div>` : ''}

    ${(() => {
      // âœ… ì¸¡ë©´ ë¶„ì„ê³¼ ì •ë©´ ë¶„ì„ì˜ ê·¼ìœ¡ ìƒíƒœ í†µí•©
      const allTight = [];
      const allWeak = [];
      
      // ì¸¡ë©´ ë¶„ì„ ê·¼ìœ¡ ìƒíƒœ
      if(sideAnalysis) {
        if(sideAnalysis.tight && Array.isArray(sideAnalysis.tight)) {
          allTight.push(...sideAnalysis.tight);
        } else if(sideAnalysis.tight && sideAnalysis.tight instanceof Set) {
          allTight.push(...Array.from(sideAnalysis.tight));
        }
        if(sideAnalysis.weak && Array.isArray(sideAnalysis.weak)) {
          allWeak.push(...sideAnalysis.weak);
        } else if(sideAnalysis.weak && sideAnalysis.weak instanceof Set) {
          allWeak.push(...Array.from(sideAnalysis.weak));
        }
      }
      
      // ì •ë©´ ë¶„ì„ ê·¼ìœ¡ ìƒíƒœ
      if(frontAnalysisForPDF) {
        if(frontAnalysisForPDF.tight && Array.isArray(frontAnalysisForPDF.tight)) {
          allTight.push(...frontAnalysisForPDF.tight);
        } else if(frontAnalysisForPDF.tight && frontAnalysisForPDF.tight instanceof Set) {
          allTight.push(...Array.from(frontAnalysisForPDF.tight));
        }
        if(frontAnalysisForPDF.weak && Array.isArray(frontAnalysisForPDF.weak)) {
          allWeak.push(...frontAnalysisForPDF.weak);
        } else if(frontAnalysisForPDF.weak && frontAnalysisForPDF.weak instanceof Set) {
          allWeak.push(...Array.from(frontAnalysisForPDF.weak));
        }
      }
      
      // í†µí•© ë¶„ì„ ê·¼ìœ¡ ìƒíƒœ
      if(analysis) {
        if(analysis.tight && Array.isArray(analysis.tight)) {
          allTight.push(...analysis.tight);
        } else if(analysis.tight && analysis.tight instanceof Set) {
          allTight.push(...Array.from(analysis.tight));
        }
        if(analysis.weak && Array.isArray(analysis.weak)) {
          allWeak.push(...analysis.weak);
        } else if(analysis.weak && analysis.weak instanceof Set) {
          allWeak.push(...Array.from(analysis.weak));
        }
      }
      
      // ì¤‘ë³µ ì œê±°
      const uniqueTight = [...new Set(allTight)];
      const uniqueWeak = [...new Set(allWeak)];
      
      if(uniqueTight.length > 0 || uniqueWeak.length > 0) {
        return `
    <div style="padding:18px; background:#fff7ed; border-radius:12px; border:1px solid #fed7aa; word-wrap:break-word; overflow-wrap:break-word; max-width:100%; box-sizing:border-box; overflow:hidden;">
      <div style="font-size:13px; font-weight:700; color:#c2410c; margin-bottom:8px; word-wrap:break-word;">ğŸ’ª ê·¼ìœ¡ ìƒíƒœ (ì¸¡ë©´ + ì •ë©´ í†µí•©)</div>
      ${uniqueTight.length > 0 ? `<div style="font-size:11px; margin-bottom:4px; word-wrap:break-word; word-break:break-word; overflow-wrap:break-word; white-space:pre-wrap;"><strong style="color:#dc2626;">ê¸´ì¥</strong> ${uniqueTight.join(', ')}</div>` : ''}
      ${uniqueWeak.length > 0 ? `<div style="font-size:11px; color:#334155; word-wrap:break-word; word-break:break-word; overflow-wrap:break-word; white-space:pre-wrap;"><strong style="color:#2563eb;">ì•½í™”</strong> ${uniqueWeak.join(', ')}</div>` : ''}
    </div>`;
      }
      return '';
    })()}

    ${analysis.comments?.length ? `
    <div style="padding:18px; background:#e0f2fe; border-radius:12px; border:1px solid #bae6fd;">
      <div style="font-size:13px; font-weight:700; color:#0369a1; margin-bottom:8px;">ğŸ¤– AI ì½”ë©˜íŠ¸</div>
      <div style="font-size:11px; line-height:1.7; color:#0f172a;">${analysis.comments.join(' ')}</div>
    </div>` : ''}
  </div>

  ${(dbAnalysis?.topRecommendations || []).length ? `
  <div style="margin-bottom:20px; padding:15px; background:#f5f3ff; border-radius:12px; border:1px solid #dcd3ff;">
    <div style="font-size:13px; font-weight:700; color:#5c44b8; margin-bottom:8px;">ğŸ“Œ DB ê¸°ë°˜ ì£¼ìš” íŒ¨í„´ (Top 3)</div>
    <ul style="margin:0; padding-left:18px; font-size:11px; color:#312e81; line-height:1.6;">
      ${(dbAnalysis.topRecommendations || []).slice(0,3).map((item, idx) => `<li style="margin-bottom:6px;">
        <strong>${idx + 1}. ${item.name || item.code}</strong> â€” ${item.abnormal || ''}
        ${item.tight ? `<br><span style="color:#dc2626;">ê¸´ì¥:</span> ${item.tight}` : ''}
        ${item.weak ? `<br><span style="color:#2563eb;">ì•½í™”:</span> ${item.weak}` : ''}
      </li>`).join('')}
    </ul>
    <div style="margin-top:6px; font-size:10px; color:#6b7280;">â€» ìƒì„¸ ë£¨í‹´ì€ ë‹¤ìŒ í˜ì´ì§€ 'í•„ë¼í…ŒìŠ¤ ì¶”ì²œ'ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</div>
  </div>` : ''}

  <div style="margin-top:15px; padding:12px; background:#f6fff7; border-radius:10px; border-left:4px solid #27ae60;">
    <div style="font-size:12px; font-weight:600; margin-bottom:8px; color:#27ae60;">âœ… í–¥í›„ ê´€ë¦¬ ìš”ì•½</div>
    ${planTexts.quickHtml || '<div style="font-size:11px; color:#475569;">ë¶„ì„ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>'}
  </div>

  ${(() => {
    // âœ… ì›¹ì•±ì˜ ê²°ë¡  ë° í–¥í›„ ê¶Œì¥ì‚¬í•­ ì¶”ê°€
    const memberNameForConclusion = memberName || 'íšŒì›';
    let conclusionText = '';
    
    // âœ… íŒ¨í„´ ìš”ì•½ - ì¸¡ë©´ ë¶„ì„ê³¼ ì •ë©´ ë¶„ì„ ëª¨ë‘ í¬í•¨
    const patterns = [];
    // ì¸¡ë©´ ë¶„ì„ íŒ¨í„´ ì¶”ê°€
    if(sideAnalysis && sideAnalysis.pilates && sideAnalysis.pilates.length > 0) {
      sideAnalysis.pilates.forEach(item => {
        if(item.name || item.issue) {
          patterns.push(`[ì¸¡ë©´] ${item.name || item.issue}`);
        }
      });
    }
    // ì •ë©´ ë¶„ì„ íŒ¨í„´ ì¶”ê°€
    if(frontAnalysisForPDF && frontAnalysisForPDF.pilates && frontAnalysisForPDF.pilates.length > 0) {
      frontAnalysisForPDF.pilates.forEach(item => {
        if(item.name || item.issue) {
          patterns.push(`[ì •ë©´] ${item.name || item.issue}`);
        }
      });
    }
    // í†µí•© ë¶„ì„ íŒ¨í„´ ì¶”ê°€
    if(analysis && analysis.pilates && analysis.pilates.length > 0) {
      analysis.pilates.forEach(item => {
        if(item.name || item.issue) {
          const patternName = item.name || item.issue;
          // ì¤‘ë³µ ì œê±°
          if(!patterns.some(p => p.includes(patternName))) {
            patterns.push(patternName);
          }
        }
      });
    }
    
    // âœ… ê·¼ìœ¡ ë¶ˆê· í˜• ìš”ì•½ - ì¸¡ë©´ ë¶„ì„ê³¼ ì •ë©´ ë¶„ì„ ëª¨ë‘ í¬í•¨
    const allTight = [];
    const allWeak = [];
    
    // ì¸¡ë©´ ë¶„ì„ ê·¼ìœ¡ ìƒíƒœ
    if(sideAnalysis) {
      if(sideAnalysis.tight && Array.isArray(sideAnalysis.tight)) {
        allTight.push(...sideAnalysis.tight);
      } else if(sideAnalysis.tight && sideAnalysis.tight instanceof Set) {
        allTight.push(...Array.from(sideAnalysis.tight));
      }
      if(sideAnalysis.weak && Array.isArray(sideAnalysis.weak)) {
        allWeak.push(...sideAnalysis.weak);
      } else if(sideAnalysis.weak && sideAnalysis.weak instanceof Set) {
        allWeak.push(...Array.from(sideAnalysis.weak));
      }
    }
    
    // ì •ë©´ ë¶„ì„ ê·¼ìœ¡ ìƒíƒœ
    if(frontAnalysisForPDF) {
      if(frontAnalysisForPDF.tight && Array.isArray(frontAnalysisForPDF.tight)) {
        allTight.push(...frontAnalysisForPDF.tight);
      } else if(frontAnalysisForPDF.tight && frontAnalysisForPDF.tight instanceof Set) {
        allTight.push(...Array.from(frontAnalysisForPDF.tight));
      }
      if(frontAnalysisForPDF.weak && Array.isArray(frontAnalysisForPDF.weak)) {
        allWeak.push(...frontAnalysisForPDF.weak);
      } else if(frontAnalysisForPDF.weak && frontAnalysisForPDF.weak instanceof Set) {
        allWeak.push(...Array.from(frontAnalysisForPDF.weak));
      }
    }
    
    // í†µí•© ë¶„ì„ ê·¼ìœ¡ ìƒíƒœ
    if(analysis) {
      if(analysis.tight && Array.isArray(analysis.tight)) {
        allTight.push(...analysis.tight);
      } else if(analysis.tight && analysis.tight instanceof Set) {
        allTight.push(...Array.from(analysis.tight));
      }
      if(analysis.weak && Array.isArray(analysis.weak)) {
        allWeak.push(...analysis.weak);
      } else if(analysis.weak && analysis.weak instanceof Set) {
        allWeak.push(...Array.from(analysis.weak));
      }
    }
    
    // ì¤‘ë³µ ì œê±°
    const tightMuscles = [...new Set(allTight)];
    const weakMuscles = [...new Set(allWeak)];
    
    // ê²°ë¡  ì‘ì„±
    conclusionText += `${memberNameForConclusion}ë‹˜ì˜ ê²€ì‚¬ ê²°ê³¼ì™€ AI ë¶„ì„ì„ ì¢…í•©í•´ë³´ë©´, ê´€ì°°ëœ ì£¼ìš” íŒ¨í„´ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n\n`;
    
    if(patterns.length > 0) {
      patterns.forEach((pattern, idx) => {
        conclusionText += `${idx + 1}. ${pattern}\n`;
      });
      conclusionText += '\n';
    } else {
      conclusionText += 'íŠ¹ì´ íŒ¨í„´ ì—†ìŒ\n\n';
    }
    
    conclusionText += `ìœ„ íŒ¨í„´ì€ íŠ¹ì • ê·¼ìœ¡êµ°ì˜ ê¸´ì¥(ì§§ì•„ì§)ê³¼ ì•½í™”(ì•½í•´ì§)ì´ ë™ë°˜ë˜ëŠ” ì „í˜•ì ì¸ ì„ìƒ ì†Œê²¬ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¶Œì¥ì‚¬í•­ì„ ì¼ê´€ë˜ê²Œ 6~12ì£¼ ë™ì•ˆ ì ìš©í•˜ë©´ ì¦ìƒ ì™„í™”ì™€ ìì„¸ ê°œì„ ì´ ê¸°ëŒ€ë©ë‹ˆë‹¤.\n\n`;
    
    // ë‹¨ê¸° ê¶Œì¥ì‚¬í•­
    conclusionText += `ã€ë‹¨ê¸°(1~4ì£¼)ã€‘\n`;
    conclusionText += `1. ê¸´ì¥ ê·¼ìœ¡ ì´ì™„ ì¤‘ì‹¬(í¼ë¡¤ëŸ¬, ê·¼ë§‰ ì´ì™„, ì •ì  ìŠ¤íŠ¸ë ˆì¹­) â€” í•˜ë£¨ 1íšŒ 10~15ë¶„\n`;
    conclusionText += `2. í˜¸í¡ ì¡°ì ˆê³¼ í•¨ê»˜í•˜ëŠ” ì½”ì–´ ê¸°ë³¸ìš´ë™ (Dead Bug, Pelvic Tilt) â€” ë§¤ì¼ 5~10ë¶„\n`;
    conclusionText += `3. ì¼ìƒ ìƒí™œì—ì„œì˜ ìì„¸ ë¦¬ì…‹(30~40ë¶„ë§ˆë‹¤) â€” ìŠµê´€í™”\n\n`;
    
    // ì¤‘ê¸° ê¶Œì¥ì‚¬í•­
    conclusionText += `ã€ì¤‘ê¸°(4~8ì£¼)ã€‘\n`;
    conclusionText += `1. ì•½í™” ê·¼ìœ¡ í™œì„±í™” (ë‘”ê·¼, ë³µíš¡ê·¼ ë“±) â€” ì£¼ 3íšŒ, ì ì§„ì  ë¶€í•˜\n`;
    conclusionText += `2. í•„ë¼í…ŒìŠ¤ ê¸°êµ¬ ìš´ë™ì„ í¬í•¨í•œ í†µí•© í”„ë¡œê·¸ë¨ â€” ì£¼ 2~3íšŒ\n`;
    conclusionText += `3. ì •ê¸° ì¬í‰ê°€ë¡œ í”„ë¡œê·¸ë¨ ì¡°ì • (3~4ì£¼ë§ˆë‹¤)\n\n`;
    
    // ì¥ê¸° ê¶Œì¥ì‚¬í•­
    conclusionText += `ã€ì¥ê¸°(8~12ì£¼ ì´ìƒ)ã€‘\n`;
    conclusionText += `í†µí•©ì  ê¸°ëŠ¥ íšŒë³µì„ ëª©í‘œë¡œ ì¼ìƒí™” ë° ìš´ë™ê°•ë„ ì¦ì§„ì„ ê¶Œì¥í•©ë‹ˆë‹¤. ê·¼ë ¥, ìœ ì—°ì„±, ì‹ ê²½ê·¼ ì œì–´ê°€ ëª¨ë‘ ê°œì„ ë˜ë©´ ìì„¸ ê°œì„  íš¨ê³¼ëŠ” ì¥ê¸°ì ìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.\n\n`;
    
    // ì ìˆ˜ ê¸°ë°˜ ì¶”ê°€ ê¶Œì¥ì‚¬í•­
    if(scoreResult && scoreResult.score != null) {
      const score = scoreResult.score;
      if(score < 70) {
        conclusionText += `í˜„ì¬ ì²´í˜• ì¢…í•© ì ìˆ˜ê°€ ${score}ì ìœ¼ë¡œ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤. ìœ„ì˜ ë‹¨ê¸° ê¶Œì¥ì‚¬í•­ë¶€í„° ê¾¸ì¤€íˆ ì‹¤ì‹œí•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n`;
      } else if(score < 85) {
        conclusionText += `í˜„ì¬ ì²´í˜• ì¢…í•© ì ìˆ˜ê°€ ${score}ì ìœ¼ë¡œ ì–‘í˜¸í•œ í¸ì…ë‹ˆë‹¤. ì¤‘ê¸° ê¶Œì¥ì‚¬í•­ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ì†ì ì¸ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\n`;
      } else {
        conclusionText += `í˜„ì¬ ì²´í˜• ì¢…í•© ì ìˆ˜ê°€ ${score}ì ìœ¼ë¡œ ìš°ìˆ˜í•©ë‹ˆë‹¤. ì¥ê¸° ê¶Œì¥ì‚¬í•­ì„ í†µí•´ í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ê³  ë”ìš± ê°œì„ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n`;
      }
    }
    
    conclusionText += `"ìš°ë¦¬ëŠ” ê±±ì • ëŒ€ì‹  ê·¼ê±°(ë°ì´í„°)ë¡œ ì›€ì§ì…ë‹ˆë‹¤."`;
    
    return conclusionText ? `
  <div style="margin-top:20px; padding:15px; background:#e0f2fe; border-radius:12px; border-left:4px solid #2ec4b6; word-wrap:break-word; overflow-wrap:break-word; max-width:100%; box-sizing:border-box; height:auto !important; max-height:none !important;">
    <div style="font-size:13px; font-weight:700; color:#2ec4b6; margin-bottom:10px; word-wrap:break-word; overflow-wrap:break-word; white-space:normal !important;">âœ… ê²°ë¡  ë° í–¥í›„ ê¶Œì¥ì‚¬í•­</div>
    <div style="font-size:11px; line-height:1.8; color:#0f172a; white-space:pre-wrap !important; word-wrap:break-word !important; overflow-wrap:break-word !important; text-overflow:clip !important; height:auto !important; max-height:none !important;">${conclusionText}</div>
  </div>
    ` : '';
  })()}

  <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
      <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
        <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page ${pageIndexMap.combinedReport}/${totalPages}</span>
      </div>
  </div>
`;
document.body.appendChild(page4Container);

if (isMobile) {
  await new Promise(resolve => setTimeout(resolve, 100));
}

try {
  // í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ ì»¨í…Œì´ë„ˆ í¬ê¸°ë¥¼ ì •í™•íˆ ê³„ì‚°
  const container4Width = Math.max(page4Container.scrollWidth, page4Container.offsetWidth, 794);
  const container4Height = Math.max(page4Container.scrollHeight, page4Container.offsetHeight);
  
  combinedReportCanvas = await html2canvas(page4Container, {
  ...html2canvasOptions,
  windowWidth: container4Width,
  windowHeight: container4Height,
  width: container4Width,
  height: container4Height,
  scale: 1.5  // âœ… í’ˆì§ˆ ë‚®ì¶¤
});
} catch (err) {
  console.error('âŒ ì¢…í•© ë¦¬í¬íŠ¸ ìº”ë²„ìŠ¤ ìƒì„± ì‹¤íŒ¨:', err);
  combinedReportCanvas = null;
}

// PDF ì»¨í…Œì´ë„ˆëŠ” DOMì— ìœ ì§€ (exportAsPdfì—ì„œ ì‚¬ìš©)
// if (document.body.contains(page4Container)) {
//   document.body.removeChild(page4Container);
// }

// âœ… ìº”ë²„ìŠ¤ ì¦‰ì‹œ ì••ì¶• + ì´ë¯¸ì§€ ìŠ¤ë¬´ë”©
if (combinedReportCanvas && (combinedReportCanvas.width > PDF_MAX_CANVAS_EDGE || combinedReportCanvas.height > PDF_MAX_CANVAS_EDGE)) {
  const ratio = Math.min(PDF_MAX_CANVAS_EDGE / combinedReportCanvas.width, PDF_MAX_CANVAS_EDGE / combinedReportCanvas.height);
  const newCanvas = document.createElement('canvas');
  newCanvas.width = Math.floor(combinedReportCanvas.width * ratio);
  newCanvas.height = Math.floor(combinedReportCanvas.height * ratio);
  const ctx = newCanvas.getContext('2d');
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'medium';
  ctx.drawImage(combinedReportCanvas, 0, 0, newCanvas.width, newCanvas.height);
  combinedReportCanvas = newCanvas;
}

if (isMobile) {
  await new Promise(resolve => setTimeout(resolve, 100));
}

// ========== í˜ì´ì§€ 5: í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ë£¨í‹´ (ì‰¬ìš´ ë”°ë¼í•˜ê¸°) ==========
const page5Container = document.createElement("div");
page5Container.id = "page5Container";
setPageContainerStyle(page5Container);
// âœ… í•„ë¼í…ŒìŠ¤ í˜ì´ì§€ ë„ˆë¹„ ê°•ì œ ê³ ì • (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ)
page5Container.style.width = '794px';
page5Container.style.maxWidth = '794px';
page5Container.style.minWidth = '794px';
page5Container.style.boxSizing = 'border-box';
page5Container.style.overflow = 'hidden'; // ë‚´ìš©ì´ ì˜†ìœ¼ë¡œ íŠ€ì–´ë‚˜ê°€ì§€ ì•Šë„ë¡

// metrics ë°ì´í„° ì¤€ë¹„ (Before-After ë¹„êµìš©)
const combinedMetrics = {};
const bMetrics = sessions.Before?.metrics?.fullMetrics || {};
const aMetrics = sessions.After?.metrics?.fullMetrics || {};

// ê° ì§€í‘œë¥¼ {before, after} í˜•íƒœë¡œ ë³€í™˜
['CVA', 'HPD', 'TIA', 'SAA', 'PTA', 'KA', 'Tibial_Angle', 'GSB', 'HPA'].forEach(key => {
  const bVal = bMetrics[key]?.value != null ? bMetrics[key].value : 
               (bMetrics[key]?.value_deg != null ? bMetrics[key].value_deg : 
               (bMetrics[key]?.value_cm != null ? bMetrics[key].value_cm : null));
  const aVal = aMetrics[key]?.value != null ? aMetrics[key].value : 
               (aMetrics[key]?.value_deg != null ? aMetrics[key].value_deg : 
               (aMetrics[key]?.value_cm != null ? aMetrics[key].value_cm : null));
  if(bVal != null || aVal != null) {
    combinedMetrics[key] = { before: bVal, after: aVal };
  }
});

// âœ… AI ê·¼ìœ¡ ìƒíƒœ ê¸°ë°˜ í•„ë¼í…ŒìŠ¤ ì¶”ì²œ (ìƒˆë¡œìš´ ë°©ì‹)
let muscleBasedRecommendations = [];
const combinedAnalysis = getCombinedAnalysis();
if (combinedAnalysis && combinedAnalysis.combined) {
  muscleBasedRecommendations = recommendPilatesFromMuscles(
    combinedAnalysis.combined.tight,
    combinedAnalysis.combined.weak
  );
}

// í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ì¹´ë“œ HTML ìƒì„± (ì›¹ì•±ê³¼ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ + DB ìƒì„¸ ì •ë³´ í¬í•¨)
let pilatesHtml = '';

// âœ… 1ìˆœìœ„: ì›¹ì•±ì—ì„œ ìƒì„±ëœ í•„ë¼í…ŒìŠ¤ ì¶”ì²œ (ì›¹ì•±ê³¼ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ í‘œì‹œ)
if (window.PilatesRecommendations && Array.isArray(window.PilatesRecommendations) && window.PilatesRecommendations.length > 0) {
  // ì›¹ì•± ì¶”ì²œ ë°ì´í„°ë¥¼ analysis.pilates í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  // ë„êµ¬ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ renderPilatesItemCardê°€ ê¸°ëŒ€í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  const toolMap = {
    'Mat': 'ë§¤íŠ¸',
    'Reformer': 'ë¦¬í¬ë¨¸',
    'Cadillac': 'ìºë”œë½',
    'Chair': 'ì²´ì–´',
    'WundaChair': 'ì²´ì–´',
    'Barrel': 'ë°”ë '
  };
  
  // ë„êµ¬ë³„ë¡œ ìš´ë™ ê·¸ë£¹í™”
  const groupedByTool = {};
  window.PilatesRecommendations.forEach(rec => {
    // equipment_koë¥¼ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ toolì„ ë³€í™˜
    const toolKo = rec.equipment_ko || rec.equipment || 
                   (rec.tool ? (toolMap[rec.tool] || toolMap['Mat'] || 'ë§¤íŠ¸') : 'ë§¤íŠ¸');
    if (!groupedByTool[toolKo]) {
      groupedByTool[toolKo] = [];
    }
    groupedByTool[toolKo].push({
      exercise_ko: rec.exercise_ko || rec.name,
      exercise_en: rec.exercise_en || rec.name,
      ...rec
    });
  });
  
  // renderPilatesItemCardê°€ ê¸°ëŒ€í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  const pilatesData = {
    name: 'í•„ë¼í…ŒìŠ¤ ìš´ë™ ì¶”ì²œ',
    description: 'ìì„¸ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¶”ì²œëœ í•„ë¼í…ŒìŠ¤ ìš´ë™ì…ë‹ˆë‹¤.',
    pilates: groupedByTool
  };
  
  pilatesHtml = renderPilatesItemCard(pilatesData, { context: 'pdf', index: 0, limitPerTool: Infinity });
} 
// âœ… 2ìˆœìœ„: ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ì—ì„œ í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ê°€ì ¸ì˜¤ê¸°
if (!pilatesHtml && sideAnalysis?.pilates && Array.isArray(sideAnalysis.pilates) && sideAnalysis.pilates.length > 0) {
  pilatesHtml = sideAnalysis.pilates.map((item, idx) => renderPilatesItemCard(item, { context: 'pdf', index: idx, limitPerTool: Infinity })).join('');
}
// âœ… 3ìˆœìœ„: AI ê·¼ìœ¡ ìƒíƒœ ê¸°ë°˜ ì¶”ì²œ (ì›¹ì•±ê³¼ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜)
else if (muscleBasedRecommendations && muscleBasedRecommendations.length > 0) {
  console.log('ğŸ“„ PDF í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ìƒì„±:', muscleBasedRecommendations.length, 'ê°œ');
  
  // ë„êµ¬ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ renderPilatesItemCardê°€ ê¸°ëŒ€í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  const toolMap = {
    'Mat': 'ë§¤íŠ¸',
    'Reformer': 'ë¦¬í¬ë¨¸',
    'Cadillac': 'ìºë”œë½',
    'Chair': 'ì²´ì–´',
    'WundaChair': 'ì²´ì–´',
    'Barrel': 'ë°”ë '
  };
  
  const groupedByTool = {};
  muscleBasedRecommendations.forEach(rec => {
    const toolKo = rec.equipment_ko || rec.equipment || 
                   (rec.tool ? (toolMap[rec.tool] || toolMap['Mat'] || 'ë§¤íŠ¸') : 'ë§¤íŠ¸');
    if (!groupedByTool[toolKo]) {
      groupedByTool[toolKo] = [];
    }
    groupedByTool[toolKo].push({
      exercise_ko: rec.exercise_ko || rec.Exercise_Name_KR || rec.name,
      exercise_en: rec.exercise_en || rec.Exercise_Name_EN || '',
      ...rec
    });
  });
  
  // renderPilatesItemCardê°€ ê¸°ëŒ€í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  const pilatesData = {
    name: 'í•„ë¼í…ŒìŠ¤ ìš´ë™ ì¶”ì²œ',
    description: 'ìì„¸ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¶”ì²œëœ í•„ë¼í…ŒìŠ¤ ìš´ë™ì…ë‹ˆë‹¤.',
    pilates: groupedByTool
  };
  
  pilatesHtml = renderPilatesItemCard(pilatesData, { context: 'pdf', index: 0, limitPerTool: Infinity });
} else if (analysis?.pilates && Array.isArray(analysis.pilates) && analysis.pilates.length > 0) {
  // PDF ìƒì„± ì‹œì—ëŠ” context: 'pdf'ë¡œ ì„¤ì •í•˜ì—¬ ì¸í„°ë™í‹°ë¸Œ ìš”ì†Œ ì œê±°
  pilatesHtml = analysis.pilates.map((item, idx) => renderPilatesItemCard(item, { context: 'pdf', index: idx, limitPerTool: Infinity })).join('');
} else {
  // í´ë°±: generatePilatesSessionText ì‚¬ìš©
  pilatesHtml = generatePilatesSessionText(combinedMetrics, analysis?.pilates);
}

page5Container.innerHTML = `
  <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px; word-wrap:break-word;">ğŸ§˜ í•„ë¼í…ŒìŠ¤ ì„¸ì…˜ ì¶”ì²œ</h2>
  <div style="margin-top:20px; line-height:1.6; word-wrap:break-word; overflow-wrap:break-word; width:764px; max-width:764px; box-sizing:border-box; padding:0; margin-left:0; margin-right:0;">
    ${pilatesHtml || '<div style="font-size:12px; color:#333;">ì¶”ì²œ ë£¨í‹´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>'}
  </div>
  <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
      <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
        <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page ${pageIndexMap.pilates}/${totalPages}</span>
      </div>
  </div>
`;

document.body.appendChild(page5Container);

if (isMobile) {
  await new Promise(resolve => setTimeout(resolve, 100));
}

try {
  // âœ… í•„ë¼í…ŒìŠ¤ í˜ì´ì§€ ë„ˆë¹„ëŠ” 794pxë¡œ ê³ ì •í•˜ê³ , ë†’ì´ë§Œ ë™ì ìœ¼ë¡œ ê³„ì‚° (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ)
  const container5Width = 794;  // PDF í‘œì¤€ ë„ˆë¹„ë¡œ ê³ ì • (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼)
  
  // âœ… í•„ë¼í…ŒìŠ¤ í˜ì´ì§€ ë„ˆë¹„ ê°•ì œ ì„¤ì • (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ ìœ ì§€) - ìº”ë²„ìŠ¤ ìƒì„± ì „ì— ë‹¤ì‹œ í™•ì¸
  page5Container.style.width = `${container5Width}px`;
  page5Container.style.maxWidth = `${container5Width}px`;
  page5Container.style.minWidth = `${container5Width}px`;
  page5Container.style.boxSizing = 'border-box';
  page5Container.style.overflow = 'hidden'; // ë‚´ìš©ì´ ì˜†ìœ¼ë¡œ íŠ€ì–´ë‚˜ê°€ì§€ ì•Šë„ë¡
  
  // âœ… í•„ë¼í…ŒìŠ¤ ë‚´ë¶€ ëª¨ë“  ìš”ì†Œì˜ ë„ˆë¹„ ê°•ì œ ì„¤ì • (ì—¬ë°± ì œê±°)
  const pilatesInnerDiv = page5Container.querySelector('div[style*="width:764px"]');
  if (pilatesInnerDiv) {
    pilatesInnerDiv.style.width = '764px';
    pilatesInnerDiv.style.maxWidth = '764px';
    pilatesInnerDiv.style.marginLeft = '0';
    pilatesInnerDiv.style.marginRight = '0';
    pilatesInnerDiv.style.paddingLeft = '0';
    pilatesInnerDiv.style.paddingRight = '0';
  }
  
  // âœ… í•„ë¼í…ŒìŠ¤ ì¹´ë“œë“¤ì˜ ë„ˆë¹„ë„ ê°•ì œ ì„¤ì •
  const pilatesCards = page5Container.querySelectorAll('div[style*="width:764px"]');
  pilatesCards.forEach(card => {
    card.style.width = '764px';
    card.style.maxWidth = '764px';
    card.style.marginLeft = '0';
    card.style.marginRight = '0';
  });
  
  // âœ… ê°•ì œ ë¦¬í”Œë¡œìš° (ìŠ¤íƒ€ì¼ ì ìš© ë³´ì¥)
  void page5Container.offsetHeight;
  
  const container5Height = Math.max(page5Container.scrollHeight, page5Container.offsetHeight);
  
  console.log('ğŸ“„ Page 5 ìº”ë²„ìŠ¤ ìƒì„±:', { width: container5Width, height: container5Height });
  
  canvas5 = await html2canvas(page5Container, {
  ...html2canvasOptions,
  windowWidth: container5Width,
  windowHeight: container5Height,
  width: container5Width,
    height: container5Height,
    scale: 2  // âœ… ì›ë³¸ í¬ê¸° ìœ ì§€ (ì‚¬ì§„ê³¼ dotê°€ ì˜ ë³´ì´ë„ë¡)
});
} catch (err) {
  console.error('âŒ canvas5 ìƒì„± ì‹¤íŒ¨:', err);
  canvas5 = null;
}

// PDF ì»¨í…Œì´ë„ˆëŠ” DOMì— ìœ ì§€ (exportAsPdfì—ì„œ ì‚¬ìš©)
// if (document.body.contains(page5Container)) {
//   document.body.removeChild(page5Container);
// }

// âœ… ìº”ë²„ìŠ¤ ì¦‰ì‹œ ì••ì¶• + ì´ë¯¸ì§€ ìŠ¤ë¬´ë”©
if (canvas5 && (canvas5.width > PDF_MAX_CANVAS_EDGE || canvas5.height > PDF_MAX_CANVAS_EDGE)) {
  const ratio = Math.min(PDF_MAX_CANVAS_EDGE / canvas5.width, PDF_MAX_CANVAS_EDGE / canvas5.height);
  const newCanvas = document.createElement('canvas');
  newCanvas.width = Math.floor(canvas5.width * ratio);
  newCanvas.height = Math.floor(canvas5.height * ratio);
  const ctx = newCanvas.getContext('2d');
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'medium';
  ctx.drawImage(canvas5, 0, 0, newCanvas.width, newCanvas.height);
  canvas5 = newCanvas;
}

if (isMobile) {
  await new Promise(resolve => setTimeout(resolve, 100));
}

// ========== í˜ì´ì§€ 6: AI ì‹¬ì¸µ ë¶„ì„ ==========
const page6Container = document.createElement("div");
page6Container.id = "page6Container";
setPageContainerStyle(page6Container);

// âœ… AI ì‹¬ì¸µ ë¶„ì„ í…ìŠ¤íŠ¸ ìƒì„± (DB ê¸°ë°˜)
const deepAnalysisText = generateAIDeepAnalysis(combinedMetrics);

// âœ… í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë³€í™˜ (ê¸€ì ì˜ë¦¼ ë°©ì§€ - word-wrap, white-space:pre-wrap ì¶”ê°€)
const deepAnalysisHtml = deepAnalysisText.split('\n').map(line => {
  if(line.trim() === '') return '<br>';
  if(line.startsWith('â–¶')) {
    return `<div style="font-size:16px; font-weight:700; color:#2c3e50; margin-top:20px; margin-bottom:10px; word-wrap:break-word; line-height:1.6;">${line}</div>`;
  }
  if(line.startsWith('ğŸ“')) {
    return `<div style="font-size:14px; font-weight:600; color:#6366f1; margin-top:15px; margin-bottom:8px; word-wrap:break-word; line-height:1.6;">${line}</div>`;
  }
  if(line.startsWith('- ')) {
    return `<div style="font-size:12px; color:#333; margin-left:10px; margin-bottom:5px; line-height:1.6; word-wrap:break-word; white-space:pre-wrap;">${line}</div>`;
  }
  if(line.startsWith('  Â·')) {
    return `<div style="font-size:11px; color:#555; margin-left:25px; margin-bottom:3px; line-height:1.6; word-wrap:break-word; white-space:pre-wrap;">${line}</div>`;
  }
  return `<div style="font-size:12px; color:#333; margin-bottom:5px; line-height:1.6; word-wrap:break-word; white-space:pre-wrap;">${line}</div>`;
}).join('');

page6Container.innerHTML = `
  <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px;">ğŸ¤– AI ìì„¸ ì‹¬ì¸µ ë¶„ì„</h2>
  <div style="margin-top:20px; line-height:1.6;">
    ${deepAnalysisHtml}
  </div>
  <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
      <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
        <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page ${pageIndexMap.aiDeep}/${totalPages}</span>
      </div>
  </div>
`;

document.body.appendChild(page6Container);

if (isMobile) {
  await new Promise(resolve => setTimeout(resolve, 100));
}

try {
  // í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ ì»¨í…Œì´ë„ˆ í¬ê¸°ë¥¼ ì •í™•íˆ ê³„ì‚°
  const container6Width = Math.max(page6Container.scrollWidth, page6Container.offsetWidth, 794);
  const container6Height = Math.max(page6Container.scrollHeight, page6Container.offsetHeight);
  
  canvas6 = await html2canvas(page6Container, {
  ...html2canvasOptions,
  windowWidth: container6Width,
  windowHeight: container6Height,
  width: container6Width,
  height: container6Height,
  scale: 1.5  // âœ… í’ˆì§ˆ ë‚®ì¶¤
});
} catch (err) {
  console.error('âŒ canvas6 ìƒì„± ì‹¤íŒ¨:', err);
  canvas6 = null;
}

// PDF ì»¨í…Œì´ë„ˆëŠ” DOMì— ìœ ì§€ (exportAsPdfì—ì„œ ì‚¬ìš©)
// if (document.body.contains(page6Container)) {
//   document.body.removeChild(page6Container);
// }

// âœ… ìº”ë²„ìŠ¤ ì¦‰ì‹œ ì••ì¶• + ì´ë¯¸ì§€ ìŠ¤ë¬´ë”©
if (canvas6 && (canvas6.width > PDF_MAX_CANVAS_EDGE || canvas6.height > PDF_MAX_CANVAS_EDGE)) {
  const ratio = Math.min(PDF_MAX_CANVAS_EDGE / canvas6.width, PDF_MAX_CANVAS_EDGE / canvas6.height);
  const newCanvas = document.createElement('canvas');
  newCanvas.width = Math.floor(canvas6.width * ratio);
  newCanvas.height = Math.floor(canvas6.height * ratio);
  const ctx = newCanvas.getContext('2d');
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'medium';
  ctx.drawImage(canvas6, 0, 0, newCanvas.width, newCanvas.height);
  canvas6 = newCanvas;
}

if (isMobile) {
  await new Promise(resolve => setTimeout(resolve, 100));
}

// ========== í˜ì´ì§€ 7.5: ì²´í˜• ìœ í˜• ë¶„ì„ ==========
// âœ… ì¸¡ë©´ ë©”íŠ¸ë¦­ê³¼ ì •ë©´ ë©”íŠ¸ë¦­ì„ ëª¨ë‘ í¬í•¨í•œ fullMetrics ìƒì„±
// 1ìˆœìœ„: After ì„¸ì…˜ì˜ fullMetrics
let fullMetricsForPostureType = sessions.After?.metrics?.fullMetrics || {};
// 2ìˆœìœ„: Before ì„¸ì…˜ì˜ fullMetrics
if (Object.keys(fullMetricsForPostureType).length === 0) {
  fullMetricsForPostureType = sessions.Before?.metrics?.fullMetrics || {};
}
// 3ìˆœìœ„: í˜„ì¬ ì„¸ì…˜ì˜ fullMetrics
if (Object.keys(fullMetricsForPostureType).length === 0) {
  fullMetricsForPostureType = S.metrics?.fullMetrics || analysis?.fullMetrics || window.fullMetrics || {};
}

// âœ… ì¸¡ë©´ ë©”íŠ¸ë¦­ì´ ë³„ë„ë¡œ ìˆìœ¼ë©´ ë³‘í•© (ì¸¡ë©´ ë©”íŠ¸ë¦­ ìš°ì„ )
if (Object.keys(sideMetrics).length > 1) { // orientation ì œì™¸í•˜ê³  ì‹¤ì œ ë©”íŠ¸ë¦­ì´ ìˆëŠ”ì§€ í™•ì¸
  // ì¸¡ë©´ ë©”íŠ¸ë¦­ì„ ìš°ì„ ì ìœ¼ë¡œ ë³‘í•© (ê¸°ì¡´ fullMetricsì— ë®ì–´ì“°ê¸°)
  Object.keys(sideMetrics).forEach(key => {
    if (key !== 'orientation') {
      fullMetricsForPostureType[key] = sideMetrics[key];
    }
  });
}

// âœ… ì •ë©´ ë©”íŠ¸ë¦­ë„ í™•ì¸í•˜ì—¬ ë³‘í•©
// After/Before/í˜„ì¬ ì„¸ì…˜ì—ì„œ ì •ë©´ ë©”íŠ¸ë¦­ ì¶”ì¶œ
let frontMetricsForPostureType = {};
if (sessions.After?.metrics?.frontMetrics) {
  frontMetricsForPostureType = sessions.After.metrics.frontMetrics;
} else if (sessions.Before?.metrics?.frontMetrics) {
  frontMetricsForPostureType = sessions.Before.metrics.frontMetrics;
} else if (sessions[cur]?.metrics?.frontMetrics) {
  frontMetricsForPostureType = sessions[cur].metrics.frontMetrics;
} else {
  // fullMetricsì—ì„œ ì •ë©´ ë©”íŠ¸ë¦­ë§Œ í•„í„°ë§
  const frontMetricKeys = ['STA', 'STA_F', 'POA', 'POA_F', 'LLD', 'LLD_F', 'Q_Angle', 'QAngle', 'Knee_Deviation', 'KneeDev', 'TD', 'HTA', 'SPP', 'KAS', 'LLAS'];
  Object.keys(fullMetricsForPostureType).forEach(key => {
    const code = METRIC_KEY_ALIASES[key] || key;
    if (frontMetricKeys.includes(code) || frontMetricKeys.includes(key)) {
      frontMetricsForPostureType[key] = fullMetricsForPostureType[key];
    }
  });
}

if (Object.keys(frontMetricsForPostureType).length > 0) {
  Object.assign(fullMetricsForPostureType, frontMetricsForPostureType);
}

// âœ… ì¸¡ë©´ê³¼ ì •ë©´ ë¶„ì„ ê²°ê³¼ë¥¼ ëª¨ë‘ í¬í•¨í•œ í†µí•© ë©”íŠ¸ë¦­ ì‚¬ìš©
let postureTypeHtml = '';
if (fullMetricsForPostureType && Object.keys(fullMetricsForPostureType).length > 0) {
  // ì¸¡ë©´ ë©”íŠ¸ë¦­ì´ ìˆìœ¼ë©´ ì¸¡ë©´ ë¶„ì„, ì •ë©´ ë©”íŠ¸ë¦­ë§Œ ìˆìœ¼ë©´ ì •ë©´ ë¶„ì„
  const hasSideMetrics = Object.keys(sideMetrics).length > 1;
  const hasFrontMetrics = Object.keys(frontMetricsForPostureType).length > 0;
  
  let sidePostureType = '';
  let frontPostureType = '';
  
  // âœ… ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ ìƒì„± - ì¸¡ë©´ ë©”íŠ¸ë¦­ë§Œ ì‚¬ìš©
  if (hasSideMetrics) {
    // ì¸¡ë©´ ë©”íŠ¸ë¦­ë§Œìœ¼ë¡œ ë¶„ì„
    const sideOnlyMetrics = {};
    Object.keys(sideMetrics).forEach(key => {
      if (key !== 'orientation') {
        sideOnlyMetrics[key] = sideMetrics[key];
      }
    });
    if (Object.keys(sideOnlyMetrics).length > 0) {
      sideOnlyMetrics.orientation = "side";
      sidePostureType = analyzePostureType(sideOnlyMetrics, "side");
      if (!sidePostureType || sidePostureType.includes('ë¶„ì„ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤')) {
        sidePostureType = '';
      }
    }
  }
  
  // âœ… ì •ë©´ ë¶„ì„ ê²°ê³¼ ìƒì„± - ì •ë©´ ë©”íŠ¸ë¦­ë§Œ ì‚¬ìš©
  if (hasFrontMetrics) {
    // ì •ë©´ ë©”íŠ¸ë¦­ë§Œìœ¼ë¡œ ë¶„ì„
    const frontOnlyMetrics = {};
    Object.keys(frontMetricsForPostureType).forEach(key => {
      frontOnlyMetrics[key] = frontMetricsForPostureType[key];
    });
    if (Object.keys(frontOnlyMetrics).length > 0) {
      frontOnlyMetrics.orientation = "front";
      frontPostureType = analyzePostureType(frontOnlyMetrics, "front");
      if (!frontPostureType || frontPostureType.includes('ë¶„ì„ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤')) {
        frontPostureType = '';
      }
    }
  }
  
  // âœ… ì¸¡ë©´ê³¼ ì •ë©´ ë¶„ì„ ê²°ê³¼ë¥¼ ëª¨ë‘ í•©ì¹˜ê¸°
  if (sidePostureType && frontPostureType) {
    // ë‘˜ ë‹¤ ìˆìœ¼ë©´ êµ¬ë¶„í•˜ì—¬ í‘œì‹œ
    postureTypeHtml = `<div style="margin-bottom:30px;"><h3 style="font-size:16px; font-weight:600; color:#0b0f14; margin-bottom:12px; border-bottom:2px solid #e0e0e0; padding-bottom:8px;">ğŸ“ ì¸¡ë©´ ìì„¸ ë¶„ì„ ê²°ê³¼</h3>${sidePostureType}</div>` +
                      `<div><h3 style="font-size:16px; font-weight:600; color:#0b0f14; margin-bottom:12px; border-bottom:2px solid #e0e0e0; padding-bottom:8px;">ğŸ“ ì •ë©´ ìì„¸ ë¶„ì„ ê²°ê³¼</h3>${frontPostureType}</div>`;
  } else if (sidePostureType) {
    postureTypeHtml = sidePostureType;
  } else if (frontPostureType) {
    postureTypeHtml = frontPostureType;
  } else {
    // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ê¸°ë³¸ ë¶„ì„ ì‹œë„
    postureTypeHtml = analyzePostureType(fullMetricsForPostureType);
  }
}

if (postureTypeHtml && postureTypeHtml.trim() !== '' && postureTypeHtml !== 'ë¶„ì„ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.') {
  const page8Container = document.createElement("div");
  page8Container.id = "page8Container";
  setPageContainerStyle(page8Container);
  
  page8Container.innerHTML = `
    <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px;">ğŸ“Œ ì²´í˜• ìœ í˜• ë¶„ì„</h2>
    <div style="font-size:12px; line-height:1.7; color:#111;">${postureTypeHtml}</div>
    <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
      <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
        <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
        <span>Page ${pageIndexMap.postureType || 7}/${totalPages}</span>
      </div>
    </div>
  `;
  
  document.body.appendChild(page8Container);
  
  if (isMobile) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  
  try {
    // í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ ì»¨í…Œì´ë„ˆ í¬ê¸°ë¥¼ ì •í™•íˆ ê³„ì‚°
    const container8Width = Math.max(page8Container.scrollWidth, page8Container.offsetWidth, 794);
    const container8Height = Math.max(page8Container.scrollHeight, page8Container.offsetHeight);
    
    canvas8 = await html2canvas(page8Container, {
      ...html2canvasOptions,
      windowWidth: container8Width,
      windowHeight: container8Height,
      width: container8Width,
      height: container8Height,
      scale: 1.5  // âœ… í’ˆì§ˆ ë‚®ì¶¤
    });
  } catch (err) {
    console.error('âŒ canvas8 ìƒì„± ì‹¤íŒ¨:', err);
    canvas8 = null;
  }
  
  // PDF ì»¨í…Œì´ë„ˆëŠ” DOMì— ìœ ì§€ (exportAsPdfì—ì„œ ì‚¬ìš©)
  // if (document.body.contains(page8Container)) {
  //   document.body.removeChild(page8Container);
  // }
  
  // âœ… ìº”ë²„ìŠ¤ ì¦‰ì‹œ ì••ì¶• + ì´ë¯¸ì§€ ìŠ¤ë¬´ë”©
  if (canvas8 && (canvas8.width > PDF_MAX_CANVAS_EDGE || canvas8.height > PDF_MAX_CANVAS_EDGE)) {
    const ratio = Math.min(PDF_MAX_CANVAS_EDGE / canvas8.width, PDF_MAX_CANVAS_EDGE / canvas8.height);
    const newCanvas = document.createElement('canvas');
    newCanvas.width = Math.floor(canvas8.width * ratio);
    newCanvas.height = Math.floor(canvas8.height * ratio);
    const ctx = newCanvas.getContext('2d');
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'medium';
    ctx.drawImage(canvas8, 0, 0, newCanvas.width, newCanvas.height);
    canvas8 = newCanvas;
  }
  
  if (isMobile) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}

// ========== í˜ì´ì§€ 7: ê²°ë¡  (ê¸°ì¡´ í˜ì´ì§€ 6) ==========
const page7Container = document.createElement("div");
page7Container.id = "page7Container";
setPageContainerStyle(page7Container);

    const beforeAfterSummaryHtml = buildBeforeAfterSummaryHTML(comparison);
const fullPlanHtml = planTexts.fullText
  ? formatMultilineText(planTexts.fullText)
  : '<div style="font-size:11px; color:#475569;">ë¶„ì„ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>';

page7Container.innerHTML = `
  <h2 style="margin:0; padding:0; font-size:20px; font-weight:700; color:#0b0f14; margin-bottom:20px;">ğŸ“Œ ìµœì¢… ë¶„ì„ & ì „ëµ</h2>
  ${beforeAfterSummaryHtml}
  <div style="margin-top:12px; padding:18px; background:#f6fff7; border-radius:12px; border-left:4px solid #27ae60;">
    <div style="font-size:13px; font-weight:700; color:#1b5e20; margin-bottom:8px;">ğŸ§­ 12ì£¼ ì¼€ì–´ ë¡œë“œë§µ</div>
    <div style="font-size:12px; line-height:1.7; color:#111;">${fullPlanHtml}</div>
  </div>
      <div style="margin-top:16px; font-size:10px; color:#6b7280; line-height:1.6;">
        â€» ë³¸ ë¦¬í¬íŠ¸ëŠ” êµìœ¡ìš©ìœ¼ë¡œ ì œê³µë˜ë©°, ì˜ë£Œ ì§„ë‹¨ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í†µì¦ì´ ì§€ì†ë˜ë©´ ì „ë¬¸ì˜ì™€ ìƒì˜í•˜ì„¸ìš”.
      </div>
      <div style="margin-top:20px; padding-top:10px; border-top:1px solid #e0e0e0;">
        <div style="display:flex; justify-content:space-between; font-size:9px; color:#666;">
          <span>Generated by ${appName} Â· ${REPORT_SIGNATURE}</span>
          <span>Page ${pageIndexMap.conclusion}/${totalPages}</span>
        </div>
      </div>
    `;

document.body.appendChild(page7Container);

if (isMobile) {
  await new Promise(resolve => setTimeout(resolve, 100));
}

try {
  // í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ ì»¨í…Œì´ë„ˆ í¬ê¸°ë¥¼ ì •í™•íˆ ê³„ì‚°
  const container7Width = Math.max(page7Container.scrollWidth, page7Container.offsetWidth, 794);
  const container7Height = Math.max(page7Container.scrollHeight, page7Container.offsetHeight);
  
  canvas7 = await html2canvas(page7Container, {
  ...html2canvasOptions,
  windowWidth: container7Width,
  windowHeight: container7Height,
  width: container7Width,
  height: container7Height,
  scale: 2  // âœ… ì›ë³¸ í¬ê¸° ìœ ì§€ (ì‚¬ì§„ê³¼ dotê°€ ì˜ ë³´ì´ë„ë¡)
});
} catch (err) {
  console.error('âŒ canvas7 ìƒì„± ì‹¤íŒ¨:', err);
  canvas7 = null;
}

// PDF ì»¨í…Œì´ë„ˆëŠ” DOMì— ìœ ì§€ (exportAsPdfì—ì„œ ì‚¬ìš©)
// if (document.body.contains(page7Container)) {
//   document.body.removeChild(page7Container);
// }

// âœ… ìº”ë²„ìŠ¤ ì¦‰ì‹œ ì••ì¶• + ì´ë¯¸ì§€ ìŠ¤ë¬´ë”©
if (canvas7 && (canvas7.width > PDF_MAX_CANVAS_EDGE || canvas7.height > PDF_MAX_CANVAS_EDGE)) {
  const ratio = Math.min(PDF_MAX_CANVAS_EDGE / canvas7.width, PDF_MAX_CANVAS_EDGE / canvas7.height);
  const newCanvas = document.createElement('canvas');
  newCanvas.width = Math.floor(canvas7.width * ratio);
  newCanvas.height = Math.floor(canvas7.height * ratio);
  const ctx = newCanvas.getContext('2d');
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'medium';
  ctx.drawImage(canvas7, 0, 0, newCanvas.width, newCanvas.height);
  canvas7 = newCanvas;
}

if (isMobile) {
  await new Promise(resolve => setTimeout(resolve, 100));
}

// ê¸°ì¡´ í˜ì´ì§€ 5, 6 ì½”ë“œëŠ” ìœ„ì—ì„œ ìƒˆë¡œìš´ í˜ì´ì§€ 5, 6, 7ë¡œ ëŒ€ì²´ë¨


  const textData = {
      comparison,
      analysis,
      dbAnalysis,
      scoreResult,
      planTexts,
      pilatesHtml,
      deepAnalysisText,
      beforeAfterSummaryHtml,
      fullPlanHtml,
      combinedMetrics,
      afterMetricsForDB,
      memberNameForPDF1
  };

  return {
    captureList: [
      { id: "page1Container", addPageAfter: true },
      { id: "sideImageContainer", addPageAfter: true },
      { id: "sideReportContainer", addPageAfter: true },
      { id: "frontImageContainer", addPageAfter: true },
      { id: "frontReportContainer", addPageAfter: true },
      { id: "page4Container", addPageAfter: true },
      { id: "page5Container", addPageAfter: true },
      { id: "page6Container", addPageAfter: true },
      { id: "page8Container", addPageAfter: true },
      { id: "page7Container", addPageAfter: false }
    ],
    textData,
    includeHeatmapPage,
    totalPages,
    pageIndexMap,
    // âœ… ìƒì„±ëœ ìº”ë²„ìŠ¤ ë°˜í™˜ (dot í¬í•¨ ë³´ì¥)
    sideImageCanvas,
    frontImageCanvas
  };
}

function combineCanvasesVertical(canvasList, gap = 40) {
  if (!Array.isArray(canvasList) || canvasList.length === 0) {
    throw new Error("ê²°í•©í•  ìº”ë²„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
  }
  const maxWidth = Math.max(...canvasList.map(canvas => canvas.width || 0));
  if (!maxWidth) {
    throw new Error("ìº”ë²„ìŠ¤ ë„ˆë¹„ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
  const scaledHeights = canvasList.map(canvas => {
    if (!canvas.width) return 0;
    const shouldScaleDown = canvas.width > maxWidth;
    const scale = shouldScaleDown ? maxWidth / canvas.width : 1;
    return Math.round(canvas.height * scale);
  });
  const totalHeight = scaledHeights.reduce((sum, h) => sum + h, 0) + gap * (canvasList.length - 1);
  const combined = document.createElement('canvas');
  combined.width = maxWidth;
  combined.height = totalHeight;
  const ctx = combined.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, combined.width, combined.height);
  let offsetY = 0;
  canvasList.forEach((canvas, idx) => {
    const height = scaledHeights[idx];
    if (!canvas.width || !canvas.height) return;
    const shouldScaleDown = canvas.width > maxWidth;
    const drawWidth = shouldScaleDown ? maxWidth : canvas.width;
    const scale = drawWidth / canvas.width;
    const drawHeight = canvas.height * scale;
    const offsetX = (maxWidth - drawWidth) / 2;
    ctx.drawImage(canvas, 0, 0, canvas.width, canvas.height, offsetX, offsetY, drawWidth, drawHeight);
    offsetY += height;
    if (idx < canvasList.length - 1) {
      offsetY += gap;
    }
  });
  return combined;
}

function downloadCanvasAsImage(canvas, fileName, btn, originalText) {
  return new Promise((resolve, reject) => {
    const finalize = () => {
      if (btn) {
        btn.textContent = originalText || btn.textContent;
        btn.disabled = false;
      }
    };
    canvas.toBlob(async (blob) => {
      if (!blob) {
        finalize();
        return reject(new Error('ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨'));
      }
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      const isMobile = isMobileDevice();
      const allowWebShare = false;
      try {
        if (allowWebShare && isMobile && navigator.share && navigator.canShare) {
          const file = new File([blob], fileName, { type: 'image/png' });
          if (navigator.canShare({ files: [file] })) {
            await navigator.share({ title: fileName.replace('.png',''), files: [file] });
            finalize();
            return resolve();
          }
        }
        if (isIOS) {
          const url = URL.createObjectURL(blob);
          const newWindow = window.open(url, '_blank');
          if (newWindow) {
            setTimeout(() => {
              URL.revokeObjectURL(url);
              alert('ğŸ–¼ï¸ ì´ë¯¸ì§€ê°€ ìƒˆ ì°½ì—ì„œ ì—´ë ¸ìŠµë‹ˆë‹¤. ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”.');
            }, 150);
            finalize();
            return resolve();
          }
        }
        const downloadUrl = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = fileName;
        link.style.position = 'fixed';
        link.style.top = '-9999px';
        link.style.left = '-9999px';
        document.body.appendChild(link);
        try {
          link.click();
        } catch (e) {
          const clickEvent = new MouseEvent('click', { view: window, bubbles: true, cancelable: true });
          link.dispatchEvent(clickEvent);
        }
        setTimeout(() => {
          URL.revokeObjectURL(downloadUrl);
          if (document.body.contains(link)) {
            document.body.removeChild(link);
          }
        }, 2000);
        if (isMobile) {
          setTimeout(() => alert('ì´ë¯¸ì§€ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œ í´ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”.'), 400);
        }
        finalize();
        resolve();
      } catch (err) {
        finalize();
        reject(err);
      }
    }, 'image/png');
  });
}

// CSV íŒŒì‹± í•¨ìˆ˜ (ë”°ì˜´í‘œ ì²˜ë¦¬ ê°œì„ )
function parseCSVLine(line) {
  const values = [];
  let currentValue = '';
  let inQuotes = false;
  
  for (let j = 0; j < line.length; j++) {
    const char = line[j];
    if (char === '"') {
      if (inQuotes && line[j + 1] === '"') {
        // ì´ìŠ¤ì¼€ì´í”„ëœ ë”°ì˜´í‘œ ("")
        currentValue += '"';
        j++; // ë‹¤ìŒ ë”°ì˜´í‘œ ê±´ë„ˆë›°ê¸°
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      // ë”°ì˜´í‘œ ì œê±° ë° ê³µë°± ì œê±°
      const cleaned = currentValue.trim().replace(/^"|"$/g, '');
      values.push(cleaned);
      currentValue = '';
    } else {
      currentValue += char;
    }
  }
  // ë§ˆì§€ë§‰ ê°’ ì¶”ê°€
  const cleaned = currentValue.trim().replace(/^"|"$/g, '');
  values.push(cleaned);
  
  return values;
}

// CSV íŒŒì‹± í•¨ìˆ˜
function parseCSV(csvText) {
  const lines = csvText.split('\n').filter(line => line.trim());
  if (lines.length < 2) return [];
  
  // í—¤ë”ë„ ë”°ì˜´í‘œ ì²˜ë¦¬í•˜ì—¬ íŒŒì‹±
  const headers = parseCSVLine(lines[0]);
  const records = [];
  
  for (let i = 1; i < lines.length; i++) {
    const values = parseCSVLine(lines[i]);
    
    if (values.length === headers.length) {
      const record = {};
      headers.forEach((header, idx) => {
        record[header] = values[idx] || '';
      });
      records.push(record);
    } else if (values.length > 0) {
      // âœ… í•„ë“œ ìˆ˜ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì„ ë•Œ: í—¤ë” ìˆ˜ì— ë§ì¶°ì„œë§Œ ë§¤í•‘ (ë‚˜ë¨¸ì§€ëŠ” ë¬´ì‹œ)
      console.warn(`âš ï¸ CSV í–‰ ${i + 1}: í•„ë“œ ìˆ˜ ë¶ˆì¼ì¹˜ (í—¤ë”: ${headers.length}, ë°ì´í„°: ${values.length})`);
      const record = {};
      const minLen = Math.min(headers.length, values.length);
      for (let idx = 0; idx < minLen; idx++) {
        record[headers[idx]] = values[idx] || '';
      }
      // âœ… ë‚˜ë¨¸ì§€ í•„ë“œëŠ” ë¹ˆ ë¬¸ìì—´ë¡œ ì±„ì›€ (í•„ë“œ ë°€ë¦¼ ë°©ì§€)
      for (let idx = minLen; idx < headers.length; idx++) {
        record[headers[idx]] = '';
      }
      records.push(record);
    }
  }
  
  return records;
}

function splitMuscleList(value) {
  if (!value) return [];
  return String(value)
    .replace(/\r/g, '')
    .split(/[,/;|Â·]/)
    .map((item) => item.trim())
    .filter(Boolean);
}

function normalizeMuscleName(name) {
  if (!name) return '';
  return name
    .replace(/\s*[\(\[][^)\]]*[\)\]]\s*/g, '')
    .replace(/\s+/g, '')
    .toLowerCase();
}

function buildDataUrlCandidates(relativePath) {
  const normalized = relativePath.replace(/^\/+/, '');
  const basePrefix = location.pathname.includes('/posture-ai-kor') ? '/posture-ai-kor' : '';
  const baseOrigin = location.origin;
  const list = [
    `${baseOrigin}${basePrefix}/${normalized}`,
    `${baseOrigin}/${normalized}`,
    `/${normalized}`,
    `./${normalized}`
  ];
  if (normalized.startsWith('db/')) {
    list.splice(1, 0, `https://raw.githubusercontent.com/skyman200/posture-ai-kor/main/public/${normalized}`);
  }
  return Array.from(new Set(list));
}

async function fetchWithCandidates(urls, responseType = 'text') {
  let lastError = null;
  for (const url of urls) {
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (responseType === 'json') return await res.json();
      return await res.text();
    } catch (err) {
      lastError = err;
      console.warn(`âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (${url}):`, err?.message || err);
    }
  }
  throw lastError || new Error('ëª¨ë“  ê²½ë¡œ ë¡œë“œ ì‹¤íŒ¨');
}

function mapPostureRecord(row) {
  const metricCode = (row.Metric_Code || row.metric_code || row.metric || row.Index_Code || '').trim();
  const deviation = (row.Deviation_Label || row.deviation || '').trim();
  const tightStr = row.Tight_Muscle || row.tight_muscle || '';
  const weakStr = row.Weak_Muscle || row.weak_muscle || '';
  const strategy = row.Recommended_Strategy || row.strategy || '';
  const notes = row.Notes || row.notes || '';
  const postureKo = row.Metric_Name_KR || row.metric_name_kr || row.Metric_Name_EN || metricCode;
  const postureEn = row.Metric_Name_EN || row.metric_name_en || '';

  const tightList = splitMuscleList(tightStr);
  const weakList = splitMuscleList(weakStr);

  return {
    ...row,
    key: row.Index_Code || metricCode || postureKo,
    posture_key: metricCode || row.Index_Code || postureKo,
    posture_ko: postureKo,
    posture_en: postureEn,
    'ì§€í‘œì½”ë“œ': metricCode,
    'ì§€í‘œëª…': postureKo,
    'ì´ìƒìœ í˜•': deviation,
    'ê¸´ì¥ê·¼ìœ¡(ì£¼ìš”)': tightStr,
    'ì•½í™”ê·¼ìœ¡(ì£¼ìš”)': weakStr,
    'êµì •ìš´ë™(ë„ìˆ˜/ìê°€)': strategy,
    'ì„ìƒì ì˜ë¯¸': notes,
    muscle_pattern: {
      tight: { primary: tightList },
      weak: { primary: weakList }
    },
    tight: tightList,
    weak: weakList,
    tightMuscles: tightList,
    weakMuscles: weakList,
    recommended_focus: {
      stretch: [],
      strengthen: []
    }
  };
}

function mapPilatesExerciseRow(row, equipmentKo) {
  // CSV ì»¬ëŸ¼ëª… í™•ì¸: Main_Strengthen_Muscles, Main_Stretch_Muscles
  const stretchStr = row.Main_Stretch_Muscles || row['Main_Stretch_Muscles (ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡)'] || row.main_stretch || '';
  const strengthenStr = row.Main_Strengthen_Muscles || row['Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)'] || row.main_strengthen || '';
  
  const stretchTargets = splitMuscleList(stretchStr);
  const strengthenTargets = splitMuscleList(strengthenStr);
  
  const exerciseKo = row.Exercise_Name_KR || row.exercise_ko || '';
  const exerciseEn = row.Exercise_Name_EN || row.exercise_en || '';
  
  // âœ… CSV ì›ë³¸ í•„ë“œëª… ê·¸ëŒ€ë¡œ ì €ì¥ (í•„ë¼í…ŒìŠ¤ DBì˜ How_to_Perform_Step_by_Step ìš°ì„  ì‚¬ìš©)
  // í‘œì¤€í™”ëœ 10ê°œ ì»¬ëŸ¼ êµ¬ì¡°ì—ì„œ How_to_Perform_Step_by_Stepì„ ìš°ì„  ì‚¬ìš©
  const howToPerform = row['How_to_Perform_Step_by_Step (ìƒì„¸ ë™ì‘ ì„¤ëª…)'] || 
                        row['How_to_Perform_Step_by_Step'] ||
                        row.How_to_Perform_Step_by_Step ||
                        row['How_to_Perform_Step_by_Step_FULL_CLASSICAL'] ||
                        row.How_to_Perform_Step_by_Step_FULL_CLASSICAL ||
                        // í•˜ìœ„ í˜¸í™˜ì„±: ì´ì „ í•„ë“œëª…ë„ í™•ì¸
                        row['How_to_Perform_EASY_FOR_BEGINNERS (ìƒì„¸ ë™ì‘ ì„¤ëª…)'] || 
                        row['How_to_Perform_EASY_FOR_BEGINNERS'] ||
                        row.How_to_Perform_EASY_FOR_BEGINNERS ||
                        // ìµœì¢… í´ë°±
                        row.How_to_Perform ||
                        '';
  
  // âœ… ì›ë³¸ CSV í•„ë“œê°’ ì§ì ‘ ì €ì¥ (ê³µë°± ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš°ë§Œ)
  const result = {
    equipment: equipmentKo,
    equipment_ko: equipmentKo,
    exercise_ko: exerciseKo,
    exercise_en: exerciseEn,
    name: exerciseEn || exerciseKo,
    ko: exerciseKo,
    posture_key: '',
    posture_ko: '',
    purpose: strengthenStr
      ? `ê°•í™”: ${strengthenStr}${stretchStr ? ` / ìŠ¤íŠ¸ë ˆì¹­: ${stretchStr}` : ''}`
      : '',
    how_to_do: howToPerform,
    key_cues: row.Classical_Cues_by_Jay_Grimes_Romana || row.Breathing_Pattern || row.Breathing || '',
    sets_reps: row.Reps || '',
    spring: row.Spring_Traditional || row.Spring || '',
    references: row.References || '',
    stretch_targets: stretchTargets,
    strengthen_targets: strengthenTargets,
    // CSV ì›ë³¸ ë°ì´í„°ë„ ì €ì¥ (í•˜ìœ„ í˜¸í™˜ì„±)
    Main_Strengthen_Muscles: strengthenStr,
    Main_Stretch_Muscles: stretchStr,
    stretchMuscles: stretchTargets,
    strengthenMuscles: strengthenTargets
  };
  
  // âœ… CSV ì›ë³¸ í•„ë“œëª… ê·¸ëŒ€ë¡œ ì €ì¥ (getExerciseDetailInfoì—ì„œ ìš°ì„  ì‚¬ìš©)
  // ëª¨ë“  ê°€ëŠ¥í•œ í•„ë“œëª…ì„ ëª…ì‹œì ìœ¼ë¡œ ì €ì¥ (ê°’ì´ ìˆìœ¼ë©´ ì €ì¥)
  const saveIfExists = (fieldName) => {
    if (row[fieldName] !== undefined && row[fieldName] !== null && row[fieldName] !== '') {
      result[fieldName] = row[fieldName];
    }
  };
  
  // âœ… ëª¨ë“  ì›ë³¸ CSV í•„ë“œë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥ (ì›ë³¸ ë°ì´í„° ë³´ì¡´)
  Object.keys(row).forEach(key => {
    if (!result.hasOwnProperty(key) && row[key] !== undefined && row[key] !== null && row[key] !== '') {
      result[key] = row[key];
    }
  });
  
  // ê°•í™”/ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡ í•„ë“œ
  saveIfExists('Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)');
  saveIfExists('Main_Stretch_Muscles (ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡)');
  
  // ìš´ë™ ì„¤ëª… í•„ë“œ (ë¦¬í¬ë¨¸ìš©)
  saveIfExists('How_to_Perform_EASY_FOR_BEGINNERS (ìƒì„¸ ë™ì‘ ì„¤ëª…)');
  saveIfExists('How_to_Perform_EASY_FOR_BEGINNERS');
  
  // ìš´ë™ ì„¤ëª… í•„ë“œ (ì¼ë°˜ìš©)
  saveIfExists('How_to_Perform_Step_by_Step (ìƒì„¸ ë™ì‘ ì„¤ëª…)');
  saveIfExists('How_to_Perform_Step_by_Step');
  saveIfExists('How_to_Perform_Step_by_Step_FULL_CLASSICAL');
  
  // ê¸°íƒ€ ìš´ë™ ì„¤ëª… í•„ë“œ
  if (row.How_to_Perform_Step_by_Step !== undefined) {
    result.How_to_Perform_Step_by_Step = row.How_to_Perform_Step_by_Step;
  }
  if (row.How_to_Perform_EASY_FOR_BEGINNERS !== undefined) {
    result.How_to_Perform_EASY_FOR_BEGINNERS = row.How_to_Perform_EASY_FOR_BEGINNERS;
  }
  if (row.How_to_Perform !== undefined) {
    result.How_to_Perform = row.How_to_Perform;
  }
  
  // í•µì‹¬ í í•„ë“œ
  saveIfExists('Classical_Cues_by_Jay_Grimes_Romana');
  if (row.Classical_Cues_by_Jay_Grimes_Romana !== undefined) {
    result.Classical_Cues_by_Jay_Grimes_Romana = row.Classical_Cues_by_Jay_Grimes_Romana;
  }
  
  // í˜¸í¡ í•„ë“œ
  saveIfExists('Breathing_Pattern');
  if (row.Breathing_Pattern !== undefined) {
    result.Breathing_Pattern = row.Breathing_Pattern;
  }
  if (row.Breathing !== undefined) {
    result.Breathing = row.Breathing;
  }
  
  // íšŸìˆ˜ í•„ë“œ
  saveIfExists('Reps');
  if (row.Reps !== undefined) {
    result.Reps = row.Reps;
  }
  
  // ìŠ¤í”„ë§ í•„ë“œ
  saveIfExists('Spring_Traditional');
  if (row.Spring_Traditional !== undefined) {
    result.Spring_Traditional = row.Spring_Traditional;
  }
  if (row.Spring !== undefined) {
    result.Spring = row.Spring;
  }
  
  return result;
}

async function loadPostureDB() {
  if (postureDBCache) {
    POSTURE_DB = postureDBCache;
    rebuildPostureDbMap(POSTURE_DB);
    return POSTURE_DB;
  }
  if (POSTURE_DB.length) {
    postureDBCache = POSTURE_DB;
    rebuildPostureDbMap(POSTURE_DB);
    return POSTURE_DB;
  }
  try {
    const csvText = await fetchWithCandidates(buildDataUrlCandidates('db/posture_metrics_full.csv'));
    const records = parseCSV(csvText);
    if (!records.length) {
      throw new Error('posture_metrics_full.csv ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
    }
    const mapped = records.map(mapPostureRecord);
    POSTURE_DB = mapped;
    postureDBCache = mapped;
    rebuildPostureDbMap(mapped);
    console.log('âœ… DB Loaded (CSV posture_metrics_full):', mapped.length, 'records');
    return POSTURE_DB;
  } catch (err) {
    console.error('âŒ DB ë¡œë“œ ì‹¤íŒ¨:', err);
    POSTURE_DB = [];
    postureDBCache = null;
    POSTURE_DB_MAP = Object.create(null);
    return POSTURE_DB;
  }
}

function rebuildPostureDbMap(records) {
  POSTURE_DB_MAP = Object.create(null);
  if (!Array.isArray(records)) return;
  records.forEach((item) => {
    if (!item) return;
    const key =
      (item.Index_Code ||
        item.index_code ||
        item.key ||
        item.posture_key ||
        '').toString().trim().toUpperCase();
    if (key) {
      POSTURE_DB_MAP[key] = item;
    }
  });
}

async function loadPilatesDB() {
  if (pilatesDBCache) {
    PILATES_EXERCISE_DB = pilatesDBCache;
    registerPilatesExerciseDetails(PILATES_EXERCISE_DB);
    return PILATES_EXERCISE_DB;
  }
  if (PILATES_EXERCISE_DB.length) {
    pilatesDBCache = PILATES_EXERCISE_DB;
    registerPilatesExerciseDetails(PILATES_EXERCISE_DB);
    return PILATES_EXERCISE_DB;
  }

  const equipmentFiles = [
    { path: 'db/Pilates_Mat_34_Classical.csv', label: 'ë§¤íŠ¸' },
    { path: 'db/Pilates_Reformer_42_Classical.csv', label: 'ë¦¬í¬ë¨¸' },
    { path: 'db/Pilates_Cadillac_58_Classical.csv', label: 'ìºë”œë½' },
    { path: 'db/Pilates_WundaChair_28_Classical.csv', label: 'ì²´ì–´' },
    { path: 'db/Pilates_Barrel_22_Classical.csv', label: 'ë°”ë ' }
  ];

  const merged = [];
  for (const file of equipmentFiles) {
    try {
      const csvText = await fetchWithCandidates(buildDataUrlCandidates(file.path));
      const rows = parseCSV(csvText);
      if (rows.length > 0) {
        console.log(`ğŸ“Š ${file.label} CSV íŒŒì‹± ì™„ë£Œ: ${rows.length}ê°œ í–‰, í—¤ë”:`, Object.keys(rows[0]));
        // âœ… ì²« ë²ˆì§¸ í–‰ì˜ í•„ë“œê°’ í™•ì¸ (ë””ë²„ê¹…)
        if (rows[0]) {
          const firstRow = rows[0];
          console.log(`ğŸ” ${file.label} ì²« ë²ˆì§¸ í–‰ í•„ë“œ í™•ì¸:`, {
            Exercise_Name_KR: firstRow.Exercise_Name_KR,
            Exercise_Name_EN: firstRow.Exercise_Name_EN,
            'Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)': firstRow['Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)']?.substring(0, 50),
            'Main_Stretch_Muscles (ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡)': firstRow['Main_Stretch_Muscles (ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡)']?.substring(0, 50),
            'How_to_Perform_Step_by_Step (ìƒì„¸ ë™ì‘ ì„¤ëª…)': firstRow['How_to_Perform_Step_by_Step (ìƒì„¸ ë™ì‘ ì„¤ëª…)']?.substring(0, 50),
            Reps: firstRow.Reps,
            Breathing_Pattern: firstRow.Breathing_Pattern,
            Spring_Traditional: firstRow.Spring_Traditional
          });
        }
        // âœ… Chest Expansion ê°™ì€ íŠ¹ì • ìš´ë™ì˜ í•„ë“œ í™•ì¸ (ë””ë²„ê¹…)
        const chestExpansion = rows.find(r => 
          (r.Exercise_Name_EN && r.Exercise_Name_EN.toLowerCase().includes('chest expansion')) ||
          (r.Exercise_Name_KR && r.Exercise_Name_KR.includes('ê°€ìŠ´') || r.Exercise_Name_KR.includes('ì²´ìŠ¤íŠ¸'))
        );
        if (chestExpansion) {
          console.log(`ğŸ” ${file.label} Chest Expansion í•„ë“œ í™•ì¸:`, {
            Exercise_Name_KR: chestExpansion.Exercise_Name_KR,
            Exercise_Name_EN: chestExpansion.Exercise_Name_EN,
            Main_Strengthen_Muscles: chestExpansion.Main_Strengthen_Muscles || chestExpansion['Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)'],
            Main_Stretch_Muscles: chestExpansion.Main_Stretch_Muscles || chestExpansion['Main_Stretch_Muscles (ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡)'],
            Reps: chestExpansion.Reps,
            Breathing_Pattern: chestExpansion.Breathing_Pattern,
            Spring_Traditional: chestExpansion.Spring_Traditional,
            Classical_Cues_by_Jay_Grimes_Romana: chestExpansion.Classical_Cues_by_Jay_Grimes_Romana
          });
        }
      }
      rows.forEach((row) => {
        const mapped = mapPilatesExerciseRow(row, file.label);
        merged.push(mapped);
      });
    } catch (err) {
      console.warn(`âš ï¸ ${file.label} CSV ë¡œë“œ ì‹¤íŒ¨:`, err?.message || err);
    }
  }

  if (!merged.length) {
    console.error('âŒ í•„ë¼í…ŒìŠ¤ ìš´ë™ DB ë¡œë“œ ì‹¤íŒ¨: CSV ë°ì´í„° ì—†ìŒ');
    PILATES_EXERCISE_DB = [];
    pilatesDBCache = null;
    return PILATES_EXERCISE_DB;
  }

  PILATES_EXERCISE_DB = merged;
  pilatesDBCache = merged;
  window.PilatesDB = merged;
  registerPilatesExerciseDetails(merged);
  console.log(`âœ… í•„ë¼í…ŒìŠ¤ ìš´ë™ DB ë¡œë“œ ì™„ë£Œ (CSV): ${merged.length} exercises`);
  return merged;
}

// âœ… í•„ë¼í…ŒìŠ¤ ìš´ë™ ë§¤ì¹­ í•¨ìˆ˜ (ì°¸ê³  ì½”ë“œ ê¸°ë°˜)
async function linkPilatesDB(postureResult) {
  const pilatesDB = window.PilatesDB || PILATES_EXERCISE_DB || (await loadPilatesDB());
  if (!pilatesDB || pilatesDB.length === 0) {
    console.warn('âš ï¸ í•„ë¼í…ŒìŠ¤ DBê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    return [];
  }

  const searchKeys = [];
  if (postureResult.posture_key) searchKeys.push(postureResult.posture_key.toLowerCase());
  if (postureResult.posture_ko) searchKeys.push(postureResult.posture_ko.toLowerCase());
  if (postureResult.name) searchKeys.push(postureResult.name.toLowerCase());
  if (postureResult.code) searchKeys.push(postureResult.code.toLowerCase());
  if (postureResult.abnormal) searchKeys.push(postureResult.abnormal.toLowerCase());

  // tightì™€ weakë¥¼ ë°°ì—´ë¡œ ë³€í™˜ (ë¬¸ìì—´ì¸ ê²½ìš° split)
  let tightArray = [];
  let weakArray = [];
  
  if (postureResult.tightMuscles) {
    tightArray = Array.isArray(postureResult.tightMuscles) 
      ? postureResult.tightMuscles 
      : splitMuscleList(postureResult.tightMuscles);
  } else if (postureResult.tight) {
    tightArray = Array.isArray(postureResult.tight)
      ? postureResult.tight
      : splitMuscleList(postureResult.tight);
  }
  
  if (postureResult.weakMuscles) {
    weakArray = Array.isArray(postureResult.weakMuscles)
      ? postureResult.weakMuscles
      : splitMuscleList(postureResult.weakMuscles);
  } else if (postureResult.weak) {
    weakArray = Array.isArray(postureResult.weak)
      ? postureResult.weak
      : splitMuscleList(postureResult.weak);
  }

  const tightSet = new Set(
    tightArray.map(normalizeMuscleName).filter(Boolean)
  );
  const weakSet = new Set(
    weakArray.map(normalizeMuscleName).filter(Boolean)
  );

  const matchedExercises = pilatesDB.filter((ex) => {
    const exKeys = [
      ex.posture_key,
      ex.posture_ko,
      ex.exercise_en,
      ex.exercise_ko,
      ex.name
    ]
      .filter(Boolean)
      .map((v) => v.toLowerCase());

    let matched =
      searchKeys.length > 0 &&
      searchKeys.some((key) =>
        exKeys.some((exKey) => exKey.includes(key) || key.includes(exKey))
      );

    // âœ… ê·¼ìœ¡ ê¸°ë°˜ ë§¤ì¹­: 
    // posture_metrics_full.csvì˜ Tight_Muscle â†’ í•„ë¼í…ŒìŠ¤ DBì˜ Main_Stretch_Musclesë¡œ ì—°ê²°
    // posture_metrics_full.csvì˜ Weak_Muscle â†’ í•„ë¼í…ŒìŠ¤ DBì˜ Main_Strengthen_Musclesë¡œ ì—°ê²°
    if (!matched && tightSet.size > 0) {
      // ê¸´ì¥ ê·¼ìœ¡(Tight_Muscle)ì„ ìŠ¤íŠ¸ë ˆì¹­í•˜ëŠ” ìš´ë™ ì°¾ê¸° â†’ Main_Stretch_Muscles ë§¤ì¹­
      const stretchStr = ex.stretch_targets?.join(', ') || ex.stretchMuscles || 
                         ex.Main_Stretch_Muscles || 
                         ex['Main_Stretch_Muscles (ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡)'] || '';
      const stretchTargets = stretchStr ? splitMuscleList(stretchStr) : [];
      matched = stretchTargets.some((target) => {
        const normalized = normalizeMuscleName(target);
        return tightSet.has(normalized) || 
          Array.from(tightSet).some(t => normalized.includes(t) || t.includes(normalized));
      });
    }

    if (!matched && weakSet.size > 0) {
      // ì•½í™” ê·¼ìœ¡(Weak_Muscle)ì„ ê°•í™”í•˜ëŠ” ìš´ë™ ì°¾ê¸° â†’ Main_Strengthen_Muscles ë§¤ì¹­
      const strengthenStr = ex.strengthen_targets?.join(', ') || ex.strengthenMuscles ||
                            ex.Main_Strengthen_Muscles || 
                            ex['Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)'] || '';
      const strengthenTargets = strengthenStr ? splitMuscleList(strengthenStr) : [];
      matched = strengthenTargets.some((target) => {
        const normalized = normalizeMuscleName(target);
        return weakSet.has(normalized) ||
          Array.from(weakSet).some(w => normalized.includes(w) || w.includes(normalized));
      });
    }

    return matched;
  });

  let recommended = matchedExercises.slice(0, 10);
  
  // âœ… ê¸°ë¦½ê·¼/ë³µì§ê·¼ ë¬¸ì œ ê°ì§€ ì‹œ ì½”ì–´ ìš´ë™ ì¶”ê°€
  const hasErectorProblem = Array.from(tightSet).some(m => 
    m.includes('ê¸°ë¦½ê·¼') || m.includes('erector') || m.includes('spine erector')
  ) || Array.from(weakSet).some(m => 
    m.includes('ê¸°ë¦½ê·¼') || m.includes('erector') || m.includes('spine erector')
  );
  
  const hasRectusProblem = Array.from(tightSet).some(m => 
    m.includes('ë³µì§ê·¼') || m.includes('rectus')
  ) || Array.from(weakSet).some(m => 
    m.includes('ë³µì§ê·¼') || m.includes('rectus')
  );
  
  if (hasErectorProblem || hasRectusProblem) {
    console.log('ğŸ” ê¸°ë¦½ê·¼/ë³µì§ê·¼ ë¬¸ì œ ê°ì§€ â†’ ì½”ì–´ ìš´ë™ ì¶”ê°€ ê²€ìƒ‰');
    
    // âœ… ì½”ì–´ ìš´ë™ í•„í„°ë§ (Main_Strengthen_Musclesì— ì½”ì–´ ê´€ë ¨ í‚¤ì›Œë“œ í¬í•¨)
    const coreKeywords = ['ì½”ì–´', 'core', 'ë³µì§ê·¼', 'ë³µíš¡ê·¼', 'ë³µì‚¬ê·¼', 'rectus', 'transverse', 'abdominis'];
    const coreExercises = pilatesDB.filter((ex) => {
      const strengthenStr = ex.Main_Strengthen_Muscles || 
                           ex['Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)'] || 
                           (ex.strengthen_targets ? ex.strengthen_targets.join(', ') : '');
      
      if (!strengthenStr) return false;
      
      // ì½”ì–´ ê´€ë ¨ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
      const hasCoreKeyword = coreKeywords.some(keyword => 
        strengthenStr.toLowerCase().includes(keyword.toLowerCase())
      );
      
      return hasCoreKeyword;
    });
    
    // âœ… ì´ë¯¸ ì¶”ì²œëœ ìš´ë™ ì œì™¸í•˜ê³  ì½”ì–´ ìš´ë™ ì¶”ê°€
    const recommendedNames = new Set(
      recommended.map(e => e.exercise_ko || e.exercise_en || e.name)
    );
    
    const additionalCoreExercises = coreExercises
      .filter(ex => {
        const exName = ex.exercise_ko || ex.exercise_en || ex.name;
        return exName && !recommendedNames.has(exName);
      })
      .slice(0, 5); // ìµœì†Œ 3-5ê°œ ì¶”ê°€
    
    if (additionalCoreExercises.length > 0) {
      recommended = [...recommended, ...additionalCoreExercises];
      console.log(`âœ… ì½”ì–´ ìš´ë™ ${additionalCoreExercises.length}ê°œ ì¶”ê°€:`, 
        additionalCoreExercises.map(e => e.exercise_ko || e.exercise_en || e.name).join(', '));
    }
  }
  
  console.log('âœ… í•„ë¼í…ŒìŠ¤ ìš´ë™ ì¶”ì²œ:', recommended.length, 'ê°œ');
  if (recommended.length > 0) {
    console.log('  -', recommended.map(e => e.exercise_ko || e.exercise_en || e.name).join(', '));
  }
  window.PilatesRecommendations = recommended;
  return recommended;
}


/**********************
 * ì •ìƒ ë²”ìœ„ íŒŒì„œ
 * 'â‰¥50Â°', '0â€“10Â°', 'â‰¤2cm' ë“± í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ì¹˜ ë²”ìœ„ë¡œ ë³€í™˜
 **********************/
function parseNormalRange(str) {
  if (!str) return null;
  const s = String(str).replace(/\s/g,'');
  // êµ¬ê°„ 'aâ€“b' ë˜ëŠ” 'a-b'
  let m = s.match(/^(-?\d+(?:\.\d+)?)\s*[â€“-]\s*(-?\d+(?:\.\d+)?)$/);
  if (m) return { type:'range', min: parseFloat(m[1]), max: parseFloat(m[2]) };
  // 'â‰¥a'
  m = s.match(/^â‰¥\s*(-?\d+(?:\.\d+)?)/);
  if (m) return { type:'min', min: parseFloat(m[1]) };
  // 'â‰¤a'
  m = s.match(/^â‰¤\s*(-?\d+(?:\.\d+)?)/);
  if (m) return { type:'max', max: parseFloat(m[1]) };
  return null;
}

const RANGE_LABEL_RULES = {
  CVA: { low: 'ë‚®ìŒ(ê±°ë¶ëª©)', high: 'ë†’ìŒ(ê³¼ì‹ ì „)' },
  HPD: { low: 'ë‚®ìŒ', high: 'ë†’ìŒ' },
  TIA: { low: 'ë‚®ìŒ', high: 'ë†’ìŒ' },
  SAA: { low: 'ë‚®ìŒ', high: 'ë†’ìŒ(ë¼ìš´ë“œìˆ„ë”)' },
  KA: { low: 'ë‚´ë°˜', high: 'ì™¸ë°˜' },
  Tibial: { low: 'ë‚´íšŒì „', high: 'ì™¸íšŒì „' },
  Tibial_Angle: { low: 'ë‚´íšŒì „', high: 'ì™¸íšŒì „' },
  QAngle: { low: 'ê³¼ì†Œ', high: 'ê³¼ëŒ€' },
  Q_Angle: { low: 'ê³¼ì†Œ', high: 'ê³¼ëŒ€' },
  KneeDev: { low: 'ë‚´ì¸¡', high: 'ì™¸ì¸¡' },
  Knee_Deviation: { low: 'ë‚´ì¸¡', high: 'ì™¸ì¸¡' }
};

const DIRECTIONAL_LABEL_RULES = {
  GSB: { threshold: 0.5, positive: 'ì „ë°© í¸ìœ„', negative: 'í›„ë°© í¸ìœ„' },
  SPP: { threshold: 1, positive: 'ì „ë°©', negative: 'í›„ë°©' },
  HPA: { threshold: 5, positive: 'ì¢ŒíšŒì „', negative: 'ìš°íšŒì „' },
  PDS: { threshold: 3, positive: 'ê³¨ë°˜ í•˜ê°•', negative: 'ê³¨ë°˜ ê±°ìƒ' },
  POA: { threshold: 2, positive: 'ìš°í•˜ê°•', negative: 'ì¢Œí•˜ê°•' },
  POA_F: { threshold: 2, positive: 'ìš°í•˜ê°•', negative: 'ì¢Œí•˜ê°•' },
  TD: { threshold: 5, positive: 'í›„ë§Œì¦', negative: 'ì „ë§Œì¦' },
  HTA: { threshold: 1, positive: 'ìš°ì¸¡ ê¸°ìš¸ê¸°', negative: 'ì¢Œì¸¡ ê¸°ìš¸ê¸°' },
  KAS: { threshold: 2, positive: 'ì™¸íšŒì „', negative: 'ë‚´íšŒì „' },
  LLAS: { threshold: 2, positive: 'ìš°ì¸¡ ì´ë™', negative: 'ì¢Œì¸¡ ì´ë™' },
};

const ABSOLUTE_LABEL_RULES = {
  LLD: { threshold: 1, label: 'ë¶ˆê· í˜•' },
  LLD_F: { threshold: 1, label: 'ë¶ˆê· í˜•' }
};

const SPECIAL_CLASSIFIERS = {
  PTA: (value) => {
    if (value <= -1) return 'í›„ë°©ê²½ì‚¬';
    if (value >= 15) return 'ì „ë°©ê²½ì‚¬';
    return 'ì •ìƒ';
  },
  CVA: (value) => {
    if (value < 50) return 'ë‚®ìŒ(ê±°ë¶ëª©)';
    if (value >= 70) return 'ë†’ìŒ(ê³¼ì‹ ì „)';
    return 'ì •ìƒ';
  }
};

/**********************
 * ì´ìƒìœ í˜• ë¶„ë¥˜ê¸° (ì¸¡ì •ê°’ â†’ DBì˜ ì´ìƒìœ í˜• label)
 * ê° ì§€í‘œë³„ í…ìŠ¤íŠ¸ ê¸°ì¤€ì— ë§¤í•‘
 **********************/
function classifyAbnormalType(metricCode, value, normalText) {
  if (value == null) return 'ì •ìƒ';

  if (SPECIAL_CLASSIFIERS[metricCode]) {
    const specialLabel = SPECIAL_CLASSIFIERS[metricCode](value);
    if (specialLabel !== 'ì •ìƒ') return specialLabel;
  }

  const directionalRule = DIRECTIONAL_LABEL_RULES[metricCode];
  if (directionalRule) {
    const threshold = directionalRule.threshold ?? 0;
    if (value > threshold) return directionalRule.positive || 'ë†’ìŒ';
    if (value < -threshold) return directionalRule.negative || 'ë‚®ìŒ';
    return 'ì •ìƒ';
  }

  const absRule = ABSOLUTE_LABEL_RULES[metricCode];
  if (absRule) {
    if (Math.abs(value) > absRule.threshold) return absRule.label;
    return 'ì •ìƒ';
  }

  const norm = parseNormalRange(normalText);
  if (!norm) return 'ì •ìƒ';
  const labels = RANGE_LABEL_RULES[metricCode];

  switch (norm.type) {
    case 'range': {
      if (value < norm.min) return labels?.low || 'ë‚®ìŒ';
      if (value > norm.max) return labels?.high || 'ë†’ìŒ';
      return 'ì •ìƒ';
    }
    case 'min': {
      if (value < norm.min) return labels?.low || 'ë‚®ìŒ';
      return labels?.high ? labels.high : 'ì •ìƒ';
    }
    case 'max': {
      if (value > norm.max) return labels?.high || 'ë†’ìŒ';
      return 'ì •ìƒ';
    }
    default:
      return 'ì •ìƒ';
  }
}

/**********************
 * ì§€í‘œë³„ ì •ìƒ í…ìŠ¤íŠ¸ (ë¦¬í¬íŠ¸ì— ì´ë¯¸ ì“°ë˜ í‘œê¸° ê·¸ëŒ€ë¡œ)
 **********************/
const NORMAL_TEXT = {
  CVA: 'â‰¥50Â°',
  HPD: '-2â€“2cm',
  TIA: '0â€“10Â°',
  SAA: '0â€“10Â°',
  PTA: '0â€“15Â°',
  KA:  '175â€“185Â°',
  Tibial: '0â€“10Â°',
  Tibial_Angle: '0â€“10Â°',
  QAngle: '10â€“20Â°',
  Q_Angle: '10â€“20Â°',
  KneeDev: '-1â€“3Â°',
  Knee_Deviation: '-1â€“3Â°',
  GSB: '-0.5â€“0.5cm',
  HPA: '-10â€“10Â°',
  PDS: '-3â€“3Â°',
  // ì •ë©´ ì§€í‘œ
  STA: 'â‰¤3Â°',
  STA_F: 'â‰¤3Â°',
  POA: 'â‰¤3Â°',
  POA_F: 'â‰¤3Â°',
  TD: '0â€“3Â°',
  HTA: 'â‰¤3Â°',
  SPP: '0â€“3Â°',
  LLD: 'â‰¤1cm',
  LLD_F: 'â‰¤1cm',
  KAS: '-2â€“2Â°',
  LLAS: '-2â€“2Â°',
  FBA: '-2â€“2Â°'
};

const DB_METRIC_RULES = {
  CVA: { min: 50, max: 80, lowCode: "CVA_LOW", highCode: "CVA_HIGH" },
  HPD: { min: -2, max: 2, lowCode: "HPD_LOW", highCode: "HPD_HIGH" },
  TIA: { min: -5, max: 10, lowCode: "TIA_LOW", highCode: "TIA_HIGH" },
  SAA: { min: -5, max: 10, lowCode: "SAA_LOW", highCode: "SAA_HIGH" },
  PTA: {
    positiveCode: "PTA_ANT",
    negativeCode: "PTA_POST",
    absThreshold: 1,
    labelPositive: "ì „ë°©ê²½ì‚¬",
    labelNegative: "í›„ë°©ê²½ì‚¬"
  },
  KA: { min: 175, max: 185, lowCode: "KA_VARUS", highCode: "KA_VALGUS" },
  Tibial: { min: -5, max: 10, lowCode: "TIB_INTERNAL", highCode: "TIB_EXTERNAL" },
  QAngle: { min: 10, max: 20, lowCode: "QANGLE_SMALL", highCode: "QANGLE_LARGE" },
  KneeDev: { min: -1, max: 3, lowCode: "KNEEDEV_MEDIAL", highCode: "KNEEDEV_LATERAL" },
  LLD: { absThreshold: 1, highCode: "LLD_IMBALANCE", labelHigh: "ë¶ˆê· í˜•" },
  GSB: {
    positiveCode: "GSB_FORWARD",
    negativeCode: "GSB_BACKWARD",
    absThreshold: 0.5,
    labelPositive: "ì „ë°© í¸ìœ„",
    labelNegative: "í›„ë°© í¸ìœ„"
  },
  HPA: {
    positiveCode: "HPA_LEFT",
    negativeCode: "HPA_RIGHT",
    absThreshold: 5,
    labelPositive: "ì¢ŒíšŒì „",
    labelNegative: "ìš°íšŒì „"
  },
  PDS: {
    positiveCode: "PDS_HIGH",
    negativeCode: "PDS_LOW",
    absThreshold: 3,
    labelPositive: "ê³¨ë°˜ í•˜ê°•",
    labelNegative: "ê³¨ë°˜ ê±°ìƒ"
  },
  STA: {
    positiveCode: "STA_HIGH",
    negativeCode: "STA_LOW",
    absThreshold: 2,
    labelPositive: "ì „ë°© ê²½ì‚¬",
    labelNegative: "í›„ë°© ê²½ì‚¬"
  },
  POA: {
    positiveCode: "POA_RIGHT",
    negativeCode: "POA_LEFT",
    absThreshold: 2,
    labelPositive: "ìš°í•˜ê°•",
    labelNegative: "ì¢Œí•˜ê°•"
  },
  TD: {
    positiveCode: "TD_KYPHOSIS",
    negativeCode: "TD_LORDOSIS",
    absThreshold: 5,
    labelPositive: "í›„ë§Œ ì¦ê°€",
    labelNegative: "í¸í‰ í‰ì¶”"
  },
  HTA: {
    positiveCode: "HTA_RIGHT",
    negativeCode: "HTA_LEFT",
    absThreshold: 1,
    labelPositive: "ìš°ì¸¡ ê¸°ìš¸ê¸°",
    labelNegative: "ì¢Œì¸¡ ê¸°ìš¸ê¸°"
  },
  SPP: {
    positiveCode: "SPP_FORWARD",
    negativeCode: "SPP_BACKWARD",
    absThreshold: 1,
    labelPositive: "ì „ë°© í¸ìœ„",
    labelNegative: "í›„ë°© í¸ìœ„"
  },
  KAS: {
    positiveCode: "KAS_EXTERNAL",
    negativeCode: "KAS_INTERNAL",
    absThreshold: 2,
    labelPositive: "ì™¸íšŒì „",
    labelNegative: "ë‚´íšŒì „"
  },
  LLAS: {
    positiveCode: "LLAS_RIGHT",
    negativeCode: "LLAS_LEFT",
    absThreshold: 2,
    labelPositive: "ìš°ì¸¡ ì´ë™",
    labelNegative: "ì¢Œì¸¡ ì´ë™"
  },
  FBA: {
    positiveCode: "FBA_PRONATION",
    negativeCode: "FBA_SUPINATION",
    absThreshold: 2,
    labelPositive: "íšŒë‚´",
    labelNegative: "íšŒì™¸"
  }
};

function evaluateMetricDeviationForDB(key, value) {
  if (value == null || Number.isNaN(value)) return { status: "ì •ìƒ" };
  const rule = DB_METRIC_RULES[key];
  if (!rule) return { status: "ì •ìƒ" };

  if (rule.positiveCode || rule.negativeCode) {
    const threshold = rule.absThreshold ?? 0;
    if (value > threshold && rule.positiveCode) {
      return {
        status: rule.labelPositive || "â†’ í¸ìœ„(+)",
        deviationKey: rule.positiveCode
      };
    }
    if (value < -threshold && rule.negativeCode) {
      return {
        status: rule.labelNegative || "â†’ í¸ìœ„(-)",
        deviationKey: rule.negativeCode
      };
    }
  }

  if (rule.min !== undefined && value < rule.min && rule.lowCode) {
    return { status: "â†“ ë‚®ìŒ", deviationKey: rule.lowCode };
  }
  if (rule.max !== undefined && value > rule.max && rule.highCode) {
    return { status: "â†‘ ë†’ìŒ", deviationKey: rule.highCode };
  }

  if (rule.highCode && rule.absThreshold !== undefined) {
    if (Math.abs(value) > rule.absThreshold) {
      return {
        status: rule.labelHigh || "â†‘ í¸ì°¨",
        deviationKey: rule.highCode
      };
    }
  }

  return { status: "ì •ìƒ" };
}

const METRIC_KEY_ALIASES = {
  STA_F: 'STA',
  POA_F: 'POA',
  Q_Angle: 'QAngle',
  QAngle: 'QAngle',
  Tibial_Angle: 'Tibial',
  Knee_Deviation: 'KneeDev',
  LLD_F: 'LLD'
};

function extractMetricValue(entry) {
  if (entry == null) return null;
  if (typeof entry === 'number' && !Number.isNaN(entry)) return entry;
  if (typeof entry === 'object') {
    const candidates = ['value_signed', 'value_deg', 'value_cm', 'value'];
    for (const key of candidates) {
      if (typeof entry[key] === 'number' && !Number.isNaN(entry[key])) {
        return entry[key];
      }
    }
  }
  return null;
}

function flattenFullMetrics(fullMetrics, orientation = null) {
  const flat = {};
  if (!fullMetrics || typeof fullMetrics !== 'object') return flat;
  
  // âœ… orientationì— ë”°ë¼ í•„í„°ë§í•  ë©”íŠ¸ë¦­ í‚¤ ì •ì˜
  // HPA, Tibialì€ ì •ë©´ ì§€í‘œë¡œ ë¶„ë¥˜ (ì¸¡ë©´ ë¶„ì„ ì‹œ ì œì™¸)
  const frontMetricKeys = ['STA', 'STA_F', 'POA', 'POA_F', 'LLD', 'LLD_F', 'TD', 'HTA', 'SPP', 'Q_Angle', 'QAngle', 'Knee_Deviation', 'KneeDev', 'KAS', 'LLAS', 'HPA', 'Tibial_Angle', 'Tibial'];
  const sideMetricKeys = ['CVA', 'HPD', 'TIA', 'SAA', 'PTA', 'KA', 'GSB', 'PDS'];
  
  for (const [rawKey, metric] of Object.entries(fullMetrics)) {
    const value = extractMetricValue(metric);
    if (value == null) continue;
    const canonicalKey = METRIC_KEY_ALIASES[rawKey] || rawKey;
    
    // âœ… orientationì´ ì§€ì •ë˜ë©´ í•´ë‹¹ ë°©í–¥ì˜ ë©”íŠ¸ë¦­ë§Œ í¬í•¨
    if (orientation === "front") {
      if (!frontMetricKeys.includes(canonicalKey)) continue;
    } else if (orientation === "side") {
      if (!sideMetricKeys.includes(canonicalKey)) continue;
    }
    // orientationì´ nullì´ë©´ ëª¨ë“  ë©”íŠ¸ë¦­ í¬í•¨ (í•˜ìœ„ í˜¸í™˜ì„±)
    
    flat[canonicalKey] = value;
  }
  return flat;
}

/**********************
 * DB ë§¤ì¹­ í•µì‹¬ í•¨ìˆ˜
 * metrics: {CVA:72.3, PTA:5.2, ...} (After ê¸°ì¤€ ê¶Œì¥)
 **********************/

async function analyzeWithDB(metrics = {}, orientation = null) {
  await loadPostureDB();
  await loadPilatesDB(); // âœ… í•„ë¼í…ŒìŠ¤ DB ë¡œë“œ

  // orientationì´ ì§€ì •ë˜ë©´ í•´ë‹¹ ë°©í–¥ì˜ í•­ëª©ë§Œ í•„í„°ë§
  // orientationì´ ì—†ìœ¼ë©´ í˜„ì¬ ì„¸ì…˜ì˜ orientation í™•ì¸
  if (!orientation) {
    orientation = sessions[cur]?.poseData?.orientation || sessions[cur]?.metrics?.orientation || "side";
  }
  
  // ì •ë©´/ì¸¡ë©´ í•­ëª© ì •ì˜
  // HPA, Tibialì€ ì •ë©´ ì§€í‘œë¡œ ë¶„ë¥˜ (ì¸¡ë©´ ë¶„ì„ ì‹œ ì œì™¸)
  const frontMetricKeys = ['STA', 'STA_F', 'POA', 'POA_F', 'LLD', 'LLD_F', 'TD', 'HTA', 'SPP', 'Q_Angle', 'QAngle', 'Knee_Deviation', 'KneeDev', 'KAS', 'LLAS', 'HPA', 'Tibial_Angle', 'Tibial'];
  const sideMetricKeys = ['CVA', 'HPD', 'TIA', 'SAA', 'PTA', 'KA', 'GSB', 'PDS'];
  
  // orientationì— ë”°ë¼ í•„í„°ë§
  let filteredMetrics = metrics;
  if (orientation === "front") {
    // ì •ë©´ ë¶„ì„: ì •ë©´ í•­ëª©ë§Œ í¬í•¨
    filteredMetrics = {};
    for (const [key, value] of Object.entries(metrics)) {
      const code = METRIC_KEY_ALIASES[key] || key;
      if (frontMetricKeys.includes(code)) {
        filteredMetrics[key] = value;
      }
    }
  } else {
    // ì¸¡ë©´ ë¶„ì„: ì¸¡ë©´ í•­ëª©ë§Œ í¬í•¨
    filteredMetrics = {};
    for (const [key, value] of Object.entries(metrics)) {
      const code = METRIC_KEY_ALIASES[key] || key;
      if (sideMetricKeys.includes(code)) {
        filteredMetrics[key] = value;
      }
    }
  }

  const findings = [];
  const matches = [];
  const tight = new Set();
  const weak = new Set();

  const weights = {
    CVA: 3,
    SAA: 2,
    PTA: 2,
    KA: 1.5,
    GSB: 1.5,
    HPA: 1.2,
    TIA: 1.2,
    STA: 1.2,
    STA_F: 1.2,
    POA: 1.2,
    POA_F: 1.2,
    TD: 1.2,
    HTA: 1.2,
    LLD: 1.5,
    LLD_F: 1.5,
    Tibial: 1.0,
    Tibial_Angle: 1.0,
    SPP: 1.2,
    QAngle: 1.2,
    Q_Angle: 1.2,
    KneeDev: 1.0,
    Knee_Deviation: 1.0
  };

  for (const [rawKey, rawValue] of Object.entries(filteredMetrics)) {
    const code = METRIC_KEY_ALIASES[rawKey] || rawKey;
    if (NORMAL_TEXT[code] == null) continue;
    const numericValue =
      typeof rawValue === "number" ? rawValue : Number(rawValue);
    if (Number.isNaN(numericValue)) continue;

    const deviation = evaluateMetricDeviationForDB(code, numericValue);
    findings.push({
      code,
      value: numericValue,
      normal: NORMAL_TEXT[code],
      abnormal: deviation.status
    });

    if (!deviation.deviationKey) continue;
    const record =
      POSTURE_DB_MAP[deviation.deviationKey] ||
      POSTURE_DB_MAP[deviation.deviationKey?.toUpperCase()];
    if (!record) continue;

    try {
      const recommendation = await createRecommendationFromRecord(record, {
        code,
        abnormal: deviation.status,
        weight: weights[code] ?? 1
      });
      matches.push(recommendation);
      recommendation.tightMuscles.forEach((m) => tight.add(m));
      recommendation.weakMuscles.forEach((m) => weak.add(m));
    } catch (err) {
      console.warn('âš ï¸ ì¶”ì²œ ìƒì„± ì‹¤íŒ¨:', err);
    }
  }

  matches.sort((a, b) => (b.weight || 1) - (a.weight || 1));

  const tightList = Array.from(tight).filter(Boolean);
  const weakList = Array.from(weak).filter(Boolean);

  return {
    findings,
    topRecommendations: matches.slice(0, 12),
    muscles: {
      tight: tightList,
      weak: weakList
    },
    tight: tightList,
    weak: weakList
  };
}

function getRecordMuscleList(record, type) {
  if (!record) return [];
  if (record.muscle_pattern) {
    const primary = record.muscle_pattern[type]?.primary || [];
    const secondary = record.muscle_pattern[type]?.secondary || [];
    return [...primary, ...secondary].map((m) => m.trim()).filter(Boolean);
  }
  const field =
    type === "tight"
      ? record.Tight_Muscle ||
        record.tight_muscle ||
        record['ê¸´ì¥ê·¼ìœ¡(ì£¼ìš”)'] ||
        ''
      : record.Weak_Muscle ||
        record.weak_muscle ||
        record['ì•½í™”ê·¼ìœ¡(ì£¼ìš”)'] ||
        '';
  return splitMuscleList(field);
}

async function createRecommendationFromRecord(record, context) {
  const tightList = getRecordMuscleList(record, 'tight');
  const weakList = getRecordMuscleList(record, 'weak');

  const postureName =
    record.posture_ko ||
    record['ì§€í‘œëª…'] ||
    record.Metric_Name_KR ||
    record.metric_name_kr ||
    record.metric_name_en ||
    context.code;

  const postureKeyRaw =
    record.posture_key ||
    record.key ||
    record.Index_Code ||
    record.Metric_Code ||
    context.code;

  const postureResult = {
    code: context.code,
    name: postureName,
    abnormal: context.abnormal,
    posture_key: postureKeyRaw ? postureKeyRaw.toLowerCase() : context.code,
    posture_ko: postureName,
    tight: tightList,
    weak: weakList,
    tightMuscles: tightList,
    weakMuscles: weakList,
    region: record.region || record['ë¶€ìœ„'] || ''
  };

  const pilatesBundle = await buildPilatesExerciseBundle(postureResult, record);

  return {
    code: context.code,
    name: postureName,
    abnormal: context.abnormal,
    weight: context.weight || 1,
    tight: tightList.join(', '),
    weak: weakList.join(', '),
    manual:
      record.recommended_focus?.strengthen?.join(', ') ||
      record['êµì •ìš´ë™(ë„ìˆ˜/ìê°€)'] ||
      '',
    mat: pilatesBundle.names['ë§¤íŠ¸'],
    reformer: pilatesBundle.names['ë¦¬í¬ë¨¸'],
    cadillac: pilatesBundle.names['ìºë”œë½'],
    chair: pilatesBundle.names['ì²´ì–´'],
    barrel: pilatesBundle.names['ë°”ë '],
    pilatesExercises: pilatesBundle.map,
    tightMuscles: tightList,
    weakMuscles: weakList,
    note:
      (record.clinical_significance &&
        Array.isArray(record.clinical_significance)
        ? record.clinical_significance.join(', ')
        : record.clinical_significance) ||
      record.Notes ||
      record.notes ||
      record.Recommended_Strategy ||
      record.strategy ||
      '',
    level: record.level || record['ì¶”ì²œë ˆë²¨(ì´ˆê¸‰/ì¤‘ê¸‰/ê³ ê¸‰)'] || ''
  };
}

async function buildPilatesExerciseBundle(postureResult, record) {
  const equipmentKeys = ['ë§¤íŠ¸', 'ë¦¬í¬ë¨¸', 'ìºë”œë½', 'ì²´ì–´', 'ë°”ë '];
  const bundle = {};
  equipmentKeys.forEach((key) => {
    bundle[key] = [];
  });

  try {
    const matchedPilates = await linkPilatesDB(postureResult);
    matchedPilates.forEach((p) => {
      const equipment = (p.equipment_ko || p.equipment_en || '')
        .toLowerCase()
        .trim();
      // âœ… CSV DBì˜ ëª¨ë“  ìƒì„¸ ì •ë³´ í¬í•¨
      const exercise = {
        name: p.exercise_ko || p.exercise_en || p.name || '',
        en: p.exercise_en || p.Exercise_Name_EN || '',
        ko: p.exercise_ko || p.Exercise_Name_KR || '',
        purpose: p.purpose || 
                 (p.Main_Strengthen_Muscles ? `ê°•í™”: ${p.Main_Strengthen_Muscles}${p.Main_Stretch_Muscles ? ` / ìŠ¤íŠ¸ë ˆì¹­: ${p.Main_Stretch_Muscles}` : ''}` : ''),
        how_to_do: p.how_to_do || 
                   p['How_to_Perform_Step_by_Step (ìƒì„¸ ë™ì‘ ì„¤ëª…)'] || 
                   p['How_to_Perform_Step_by_Step'] ||
                   p['How_to_Perform_EASY_FOR_BEGINNERS (ìƒì„¸ ë™ì‘ ì„¤ëª…)'] ||
                   p['How_to_Perform_EASY_FOR_BEGINNERS'] ||
                   p.How_to_Perform_Step_by_Step ||
                   p.How_to_Perform ||
                   '',
        sets_reps: p.sets_reps || p.Reps || '',
        key_cues: p.key_cues || 
                  p.Classical_Cues_by_Jay_Grimes_Romana || 
                  p.Breathing_Pattern || 
                  p.Breathing || 
                  '',
        spring: p.spring || p.Spring_Traditional || p.Spring || '',
        references: p.references || p.References || '',
        strengthen_muscles: p.Main_Strengthen_Muscles || 
                            p['Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)'] || 
                            (p.strengthen_targets ? p.strengthen_targets.join(', ') : ''),
        stretch_muscles: p.Main_Stretch_Muscles || 
                         p['Main_Stretch_Muscles (ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡)'] || 
                         (p.stretch_targets ? p.stretch_targets.join(', ') : ''),
        precaution: p.precaution || '',
        // âœ… ì›ë³¸ CSV ë°ì´í„°ë„ ë³´ì¡´ (í•˜ìœ„ í˜¸í™˜ì„±)
        ...p
      };
      if (!exercise.name && !exercise.ko) return;
      if (equipment.includes('ë§¤íŠ¸') || equipment.includes('mat')) {
        bundle['ë§¤íŠ¸'].push(exercise);
      }
      if (equipment.includes('ë¦¬í¬ë¨¸') || equipment.includes('reformer')) {
        bundle['ë¦¬í¬ë¨¸'].push(exercise);
      }
      if (equipment.includes('ìºë”œë½') || equipment.includes('cadillac')) {
        bundle['ìºë”œë½'].push(exercise);
      }
      if (equipment.includes('ì²´ì–´') || equipment.includes('chair')) {
        bundle['ì²´ì–´'].push(exercise);
      }
      if (
        equipment.includes('ë°”ë ') ||
        equipment.includes('barrel') ||
        equipment.includes('spine corrector')
      ) {
        bundle['ë°”ë '].push(exercise);
      }
    });
  } catch (err) {
    console.warn('âš ï¸ í•„ë¼í…ŒìŠ¤ ìš´ë™ ë§¤ì¹­ ì‹¤íŒ¨:', err);
  }

  const fallbackMap = {
    'ë§¤íŠ¸': record['í•„ë¼í…ŒìŠ¤ìš´ë™(Mat)'] || record.mat || '',
    'ë¦¬í¬ë¨¸': record['í•„ë¼í…ŒìŠ¤ìš´ë™(Reformer)'] || record.reformer || '',
    'ìºë”œë½': record['í•„ë¼í…ŒìŠ¤ìš´ë™(Cadillac)'] || record.cadillac || '',
    'ì²´ì–´': record['í•„ë¼í…ŒìŠ¤ìš´ë™(Chair)'] || record.chair || '',
    'ë°”ë ': record['í•„ë¼í…ŒìŠ¤ìš´ë™(Barrel)'] || record.barrel || ''
  };

  Object.entries(fallbackMap).forEach(([key, value]) => {
    if (value && bundle[key].length === 0) {
      bundle[key].push({ name: value, ko: value });
    }
  });

  const names = {};
  Object.entries(bundle).forEach(([key, list]) => {
    names[key] = list
      .map((ex) => ex.name || ex.ko)
      .filter(Boolean)
      .join(', ');
  });

  return { map: bundle, names };
}

/**********************
 * ë‚´ëŸ¬í‹°ë¸Œ ìƒì„± (PDFì— ë°”ë¡œ ì¶œë ¥)
 **********************/
function buildAINarrative(analysis) {
  const bad = analysis.findings.filter(f => f.abnormal !== 'ì •ìƒ');
  const good = analysis.findings.filter(f => f.abnormal === 'ì •ìƒ');
  const lines = [];

  // âœ… ì „ì²´ ì²´í˜• ì ìˆ˜ ê³„ì‚°
  const totalScore = computeScore(
    analysis.findings.find(f => f.code === 'CVA')?.value || null,
    analysis.findings.find(f => f.code === 'PTA')?.value || null,
    analysis.findings.find(f => f.code === 'KA')?.value || null
  );
  lines.push(`ğŸ“Š ì „ì²´ ì²´í˜• ì¢…í•© ì ìˆ˜: ${totalScore.score}/100ì `);
  if(totalScore.reasons && totalScore.reasons.length > 0) {
    lines.push(`ê°ì  ê·¼ê±°: ${totalScore.reasons.join(', ')}`);
  }

  // âœ… ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ ìƒì„¸ í‘œì‹œ
  lines.push('\nğŸ“ ì¸¡ë©´ ë¶„ì„ ê²°ê³¼');
  const sideMetrics = ['CVA', 'HPD', 'TIA', 'SAA', 'PTA', 'KA', 'Tibial_Angle', 'GSB', 'HPA'];
  sideMetrics.forEach(code => {
    const finding = analysis.findings.find(f => f.code === code);
    if(finding) {
      const unit = /cm$/.test(finding.normal) ? 'cm' : 'Â°';
      const status = finding.abnormal === 'ì •ìƒ' ? 'normal' : 
                     finding.abnormal.includes('ë†’ìŒ') ? 'severe' :
                     finding.abnormal.includes('ë‚®ìŒ') ? 'mild' : 'moderate';
      const statusText = status === 'normal' ? 'ì •ìƒ' : 
                         status === 'severe' ? 'ì‹¬ê°' :
                         status === 'mild' ? 'ê²½ë¯¸' : 'ì¤‘ë“±ë„';
      lines.push(`${code}: ${finding.value.toFixed(2)}${unit} (${statusText})`);
    }
  });

  // âœ… PDS ì¢…í•©ì ìˆ˜ (ìˆëŠ” ê²½ìš°)
  const pdsFinding = analysis.findings.find(f => f.code === 'PDS');
  if(pdsFinding) {
    lines.push(`PDS: ${pdsFinding.value.toFixed(1)}Â° (${pdsFinding.abnormal === 'ì •ìƒ' ? 'ì •ìƒ' : 'ì£¼ì˜'})`);
    lines.push(`PDS ì¢…í•©ì ìˆ˜: ${pdsFinding.value.toFixed(1)} (${pdsFinding.abnormal === 'ì •ìƒ' ? 'ì •ìƒ' : 'ì£¼ì˜'})`);
  }

  // âœ… í•µì‹¬ ì´ìŠˆ ìƒì„¸ ì„¤ëª…
  if (bad.length) {
    lines.push('\nâš ï¸ ì£¼ìš” ë¬¸ì œ íŒ¨í„´:');
    bad.forEach(b => {
      const dbItem = POSTURE_DB.find(r => {
        const dbCode = String(r['ì§€í‘œì½”ë“œ'] || '').toUpperCase();
        const dbAbnormal = String(r['ì´ìƒìœ í˜•'] || '');
        return dbCode === b.code.toUpperCase() && dbAbnormal.includes(b.abnormal);
      });
      
      if(dbItem) {
        lines.push(`\nğŸ“ ${dbItem['ì§€í‘œëª…'] || b.code} (${b.abnormal})`);
        if(dbItem['ì›ì¸']) lines.push(`  ì›ì¸: ${dbItem['ì›ì¸']}`);
        if(dbItem['ì¦ìƒ']) lines.push(`  ì¦ìƒ: ${dbItem['ì¦ìƒ']}`);
        if(dbItem['ì„ìƒì ì˜ë¯¸']) lines.push(`  ì„ìƒì  ì˜ë¯¸: ${dbItem['ì„ìƒì ì˜ë¯¸']}`);
        if(dbItem['ê¸´ì¥ê·¼ìœ¡(ì£¼ìš”)']) lines.push(`  ê¸´ì¥ëœ ê·¼ìœ¡: ${dbItem['ê¸´ì¥ê·¼ìœ¡(ì£¼ìš”)']}`);
        if(dbItem['ì•½í™”ê·¼ìœ¡(ì£¼ìš”)']) lines.push(`  ì•½í™”ëœ ê·¼ìœ¡: ${dbItem['ì•½í™”ê·¼ìœ¡(ì£¼ìš”)']}`);
      } else {
        lines.push(`\nğŸ“ ${b.code}: ${b.value}${/cm$/.test(b.normal) ? 'cm' : 'Â°'} (${b.abnormal})`);
      }
    });
  } else {
    lines.push('\nâœ… ëª¨ë“  í•µì‹¬ ì§€í‘œê°€ ì •ìƒ ë²”ìœ„ì…ë‹ˆë‹¤.');
  }

  if (good.length) {
    lines.push(`\nâœ“ ì•ˆì • í•­ëª©: ${good.map(g => g.code).join(', ')}`);
  }

  // âœ… ê·¼ìœ¡ ë¶ˆê· í˜• ìƒì„¸
  if (analysis.muscles.tight.length || analysis.muscles.weak.length) {
    lines.push('\nğŸ’ª ê·¼ìœ¡ ë¶ˆê· í˜• ë¶„ì„:');
    if(analysis.muscles.tight.length > 0) {
      lines.push(`ê¸´ì¥ëœ ê·¼ìœ¡: ${analysis.muscles.tight.join(', ')}`);
      lines.push(`  â†’ ì´ ê·¼ìœ¡ë“¤ì€ ê³¼ë„í•˜ê²Œ ìˆ˜ì¶•ë˜ì–´ ìˆì–´ ìŠ¤íŠ¸ë ˆì¹­ê³¼ ì´ì™„ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
    }
    if(analysis.muscles.weak.length > 0) {
      lines.push(`ì•½í™”ëœ ê·¼ìœ¡: ${analysis.muscles.weak.join(', ')}`);
      lines.push(`  â†’ ì´ ê·¼ìœ¡ë“¤ì€ ì•½í™”ë˜ì–´ ìˆì–´ ê°•í™” ìš´ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
    }
  }

  // âœ… AI ì‹¤ì‹œê°„ ë¶„ì„
  lines.push('\nğŸ¤– AI ì‹¤ì‹œê°„ ë¶„ì„');
  lines.push('ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜ ë¶„ì„ ì™„ë£Œ');

  return lines.join('\n');
}

/**********************
 * í†µí•© ì‹¤í–‰ í•¨ìˆ˜
 * (ì¸¡ì •ê°’ metricsëŠ” After ê¸°ì¤€ í˜¹ì€ ì¢…í•©ê°’)
 **********************/
async function runDBDrivenAI(metrics) {
  const analysis = await analyzeWithDB(metrics);
  return analysis;
}

/**********************
 * Before-After ë¹„êµ AI ë¶„ì„ í•¨ìˆ˜
 * before: {CVA: 63.4, HPD: 0.9, ...}
 * after: {CVA: 72.3, HPD: 0.9, ...}
 **********************/
async function analyzePostureAI(before, after) {
  const db = await loadPostureDB();
  if (!db || db.length === 0) {
    console.warn('DBê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸°ì¡´ ë¶„ì„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
    return { error: 'DB ë¡œë“œ ì‹¤íŒ¨', results: [] };
  }

  const results = [];
  
  // DB êµ¬ì¡°ì— ë§ê²Œ ë§¤ì¹­ (ì§€í‘œì½”ë“œ ë˜ëŠ” metric í•„ë“œ í™•ì¸)
  for (const [metric, beforeVal] of Object.entries(before)) {
    const afterVal = after[metric];
    if (afterVal == null) continue;
    
    // DBì—ì„œ í•´ë‹¹ ì§€í‘œ ì°¾ê¸° (ì§€í‘œì½”ë“œ ë˜ëŠ” metric í•„ë“œë¡œ ë§¤ì¹­)
    const rule = db.find(item => {
      const dbCode = String(item['ì§€í‘œì½”ë“œ'] || item.metric || '').toUpperCase();
      return dbCode === metric.toUpperCase();
    });
    
    if (!rule) continue;

    const delta = afterVal - beforeVal;
    
    // ì •ìƒ ë²”ìœ„ íŒŒì‹±
    const normalText = rule['ì •ìƒë²”ìœ„'] || rule.normalRange || NORMAL_TEXT[metric];
    const norm = parseNormalRange(normalText);
    
    let status = 'ì •ìƒ';
    if (norm) {
      if (norm.type === 'range') {
        if (afterVal < norm.min) status = 'ë‚®ìŒ';
        else if (afterVal > norm.max) status = 'ë†’ìŒ';
        else status = 'ì •ìƒ';
      } else if (norm.type === 'min') {
        if (afterVal < norm.min) status = 'ë‚®ìŒ';
        else if (metric === 'CVA' && afterVal >= 70) status = 'ë†’ìŒ(ê³¼ì‹ ì „)';
        else status = 'ì •ìƒ';
      } else if (norm.type === 'max') {
        if (afterVal > norm.max) status = 'ë†’ìŒ';
        else status = 'ì •ìƒ';
      }
    }

    results.push({
      metric: metric,
      name: rule['ì§€í‘œëª…'] || rule.name || metric,
      before: beforeVal,
      after: afterVal,
      change: delta.toFixed(1),
      unit: rule['ì¸¡ì •ë‹¨ìœ„'] || rule.unit || 'Â°',
      status,
      aiComment: rule['ë¬¸ì œì„¤ëª…'] || rule.aiComment || '',
      musclePattern: {
        tight: rule['ê¸´ì¥ê·¼ìœ¡(ì£¼ìš”)'] || rule.musclePattern?.tight || '',
        weak: rule['ì•½í™”ê·¼ìœ¡(ì£¼ìš”)'] || rule.musclePattern?.weak || ''
      },
      pilatesSession: {
        mat: rule['í•„ë¼í…ŒìŠ¤ìš´ë™(Mat)'] || rule.pilatesSession?.mat || '',
        reformer: rule['í•„ë¼í…ŒìŠ¤ìš´ë™(Reformer)'] || rule.pilatesSession?.reformer || '',
        cadillac: rule['í•„ë¼í…ŒìŠ¤ìš´ë™(Cadillac)'] || rule.pilatesSession?.cadillac || '',
        chair: rule['í•„ë¼í…ŒìŠ¤ìš´ë™(Chair)'] || rule.pilatesSession?.chair || '',
        barrel: rule['í•„ë¼í…ŒìŠ¤ìš´ë™(Barrel)'] || rule.pilatesSession?.barrel || ''
      },
      guide: rule['êµì •ìš´ë™(ë„ìˆ˜/ìê°€)'] || rule.guide || rule.exerciseGuide || '',
      clinical: rule['ì„ìƒì ì˜ë¯¸'] || rule.clinical || '',
      level: rule['ì¶”ì²œë ˆë²¨(ì´ˆê¸‰/ì¤‘ê¸‰/ê³ ê¸‰)'] || rule.level || ''
    });
  }
  
  console.table(results);
  return { results, error: null };
}

/**********************
 * Before-After ë¹„êµ ê·¸ë˜í”„ ìƒì„± (Chart.js)
 **********************/
function drawComparisonChart(before, after, containerId = null, options = {}) {
  const canvas = containerId ? document.getElementById(containerId) : document.createElement('canvas');
  if (!canvas) {
    console.error('Canvas element not found');
    return null;
  }
  
  if (!containerId) {
    canvas.width = 600;
    canvas.height = 300;
  }
  
  const ctx = canvas.getContext('2d');
  
  // ê¸°ì¡´ Chart ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆìœ¼ë©´ ì œê±°
  if (canvas.chart) {
    canvas.chart.destroy();
  }
  
  const labels = Object.keys(before);
  const beforeData = Object.values(before);
  const afterData = labels.map(key => after[key] || 0);
  
  // PDFìš©ìœ¼ë¡œ ì‚¬ìš©í•  ë•ŒëŠ” ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™”
  const disableAnimation = options.disableAnimation !== false; // ê¸°ë³¸ê°’ true
  
  canvas.chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Before',
          data: beforeData,
          backgroundColor: 'rgba(255, 99, 132, 0.6)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 1
        },
        {
          label: 'After',
          data: afterData,
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: !containerId, // containerIdê°€ ìˆìœ¼ë©´ false
      maintainAspectRatio: containerId ? false : true,
      animation: disableAnimation ? false : {
        duration: 0 // ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™”
      },
      transitions: {
        active: {
          animation: {
            duration: 0
          }
        }
      },
      scales: { 
        y: { beginAtZero: true },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      },
      plugins: {
        legend: { position: 'top' },
        title: { 
          display: true, 
          text: 'Beforeâ€“After ë¹„êµ ê·¸ë˜í”„',
          font: { size: 16, weight: 'bold' }
        }
      }
    }
  });
  
  return canvas;
}

/**********************
 * ëª¨ë°”ì¼ ê°ì§€ í•¨ìˆ˜
 **********************/
function isMobileDevice() {
  return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || 
         (window.innerWidth <= 768 && 'ontouchstart' in window);
}

/**********************
 * ëª¨ë°”ì¼ í˜¸í™˜ PDF ì €ì¥ ê¸°ëŠ¥
 **********************/
async function savePDFMobileCompatible(fileName, pdfInstance) {
  try {
    // ëª¨ë°”ì¼ì—ì„œëŠ” ê°„ë‹¨í•œ ë°©ì‹ ìš°ì„  ì‚¬ìš© (ë©”ëª¨ë¦¬ ì ˆì•½)
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isAndroid = /Android/i.test(navigator.userAgent);
    
    // ëª¨ë°”ì¼ì—ì„œëŠ” ì§ì ‘ save ë©”ì„œë“œ ìš°ì„  ì‹œë„ (ê°€ì¥ ì•ˆì •ì )
    if (isMobileDevice()) {
      try {
        // ì‘ì€ ì§€ì—°ìœ¼ë¡œ UI ë¸”ë¡œí‚¹ ë°©ì§€
        await new Promise(resolve => setTimeout(resolve, 100));
        pdfInstance.save(fileName);
        console.log('âœ… PDF ì €ì¥ ì„±ê³µ (ì§ì ‘ save)');
        return;
      } catch (saveErr) {
        console.warn('âš ï¸ ì§ì ‘ save ì‹¤íŒ¨:', saveErr);
        // í´ë°±ìœ¼ë¡œ ì§„í–‰
      }
    }
    
    // Blob ìƒì„± (ë°ìŠ¤í¬í†± ë˜ëŠ” ì§ì ‘ save ì‹¤íŒ¨ ì‹œ)
    let blob;
    try {
      blob = pdfInstance.output('blob');
      if (!blob || blob.size === 0) {
        throw new Error('PDF Blob ìƒì„± ì‹¤íŒ¨');
      }
    } catch (blobErr) {
      console.error('âŒ Blob ìƒì„± ì‹¤íŒ¨:', blobErr);
      // ìµœì¢… í´ë°±: data URI ì‚¬ìš©
      try {
        const dataUri = pdfInstance.output('datauristring');
        const link = document.createElement('a');
        link.href = dataUri;
        link.download = fileName;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        setTimeout(() => {
          if (document.body.contains(link)) {
            document.body.removeChild(link);
          }
        }, 1000);
        return;
      } catch (finalErr) {
        throw new Error('PDF ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + finalErr.message);
      }
    }
    
    // ëª¨ë°”ì¼ì—ì„œ Web Share API ì‚¬ìš© (ì„ íƒì )
    if (isMobileDevice() && navigator.share && navigator.canShare && blob.size < 50 * 1024 * 1024) {
      try {
        const file = new File([blob], fileName, { type: 'application/pdf' });
        if (navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: fileName.replace('.pdf', ''),
            files: [file]
          });
          console.log('âœ… PDF ê³µìœ  ì„±ê³µ (Web Share API)');
          return;
        }
      } catch (shareErr) {
        if (shareErr.name === 'AbortError') {
          return; // ì‚¬ìš©ì ì·¨ì†Œ
        }
        console.warn('âš ï¸ Web Share API ì‹¤íŒ¨:', shareErr);
      }
    }
    
    // ë°ìŠ¤í¬í†± ë˜ëŠ” ì•ˆì „í•œ ë‹¤ìš´ë¡œë“œ ë§í¬ ì‚¬ìš©
    const fileURL = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = fileURL;
    link.download = fileName;
    link.style.display = 'none';
    document.body.appendChild(link);
    
    // ì•ˆì „í•œ í´ë¦­
    requestAnimationFrame(() => {
      try {
        link.click();
      } catch (e) {
        console.warn('í´ë¦­ ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‚¬ìš©');
        const event = new MouseEvent('click', {
          bubbles: true,
          cancelable: true,
          view: window
        });
        link.dispatchEvent(event);
      }
    });
    
    // ì •ë¦¬ (ì§€ì—° ì‹œê°„ ì¦ê°€)
    setTimeout(() => {
      try {
        URL.revokeObjectURL(fileURL);
        if (document.body.contains(link)) {
          document.body.removeChild(link);
        }
      } catch (e) {
        console.warn('ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', e);
      }
    }, 3000);
    
  } catch (err) {
    console.error('âŒ PDF ì €ì¥ ì‹¤íŒ¨:', err);
    alert('âš ï¸ PDF ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

/**********************
 * ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜ (ìº”ë²„ìŠ¤ë‚˜ ê·¸ë˜í”„ ë“±)
 **********************/
async function saveImageMobile(canvas, fileName = 'report_image.png') {
  try {
    // Canvasë¥¼ Blobìœ¼ë¡œ ë³€í™˜
    const blob = await new Promise((resolve, reject) => {
      canvas.toBlob((blob) => {
        if (blob) {
          resolve(blob);
        } else {
          reject(new Error('ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨'));
        }
      }, 'image/png', 1.0);
    });
    
    // iOS ê°ì§€
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isAndroid = /Android/i.test(navigator.userAgent);
    
    // ëª¨ë°”ì¼ì—ì„œ Web Share API ì‚¬ìš©
    if (isMobileDevice() && navigator.share && navigator.canShare) {
      try {
        const file = new File([blob], fileName, { type: 'image/png' });
        
        if (navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: fileName.replace('.png', ''),
            files: [file]
          });
          console.log('âœ… ì´ë¯¸ì§€ ê³µìœ  ì„±ê³µ (Web Share API)');
          return;
        }
      } catch (shareErr) {
        if (shareErr.name !== 'AbortError') {
          console.warn('âš ï¸ Web Share API ì‹¤íŒ¨, í´ë°± ì‚¬ìš©:', shareErr);
        } else {
          return;
        }
      }
    }
    
    // iOSì—ì„œ ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°
    if (isIOS) {
      try {
        const fileURL = URL.createObjectURL(blob);
        const newWindow = window.open(fileURL, '_blank');
        if (newWindow) {
          setTimeout(() => {
            URL.revokeObjectURL(fileURL);
            alert('ğŸ–¼ï¸ ì´ë¯¸ì§€ê°€ ìƒˆ ì°½ì—ì„œ ì—´ë ¸ìŠµë‹ˆë‹¤. ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”.');
          }, 100);
          return;
        }
      } catch (err) {
        console.warn('âš ï¸ iOS ìƒˆ ì°½ ì—´ê¸° ì‹¤íŒ¨:', err);
      }
    }
    
    // Android ë˜ëŠ” ë°ìŠ¤í¬í†±: ë‹¤ìš´ë¡œë“œ ë§í¬ ì‚¬ìš©
    const fileURL = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = fileURL;
    link.download = fileName;
    link.style.display = 'none';
    document.body.appendChild(link);
    
    // ê°•ì œ í´ë¦­
    try {
      link.click();
    } catch (e1) {
      try {
        const clickEvent = new MouseEvent('click', {
          view: window,
          bubbles: true,
          cancelable: true,
          buttons: 1
        });
        link.dispatchEvent(clickEvent);
      } catch (e2) {
        window.open(fileURL, '_blank');
      }
    }
    
    setTimeout(() => {
      URL.revokeObjectURL(fileURL);
      if (document.body.contains(link)) {
        document.body.removeChild(link);
      }
    }, 2000);
    
    if (isMobileDevice()) {
      setTimeout(() => {
        alert('ğŸ–¼ï¸ ì´ë¯¸ì§€ ì €ì¥ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œ í´ë”ë‚˜ íŒŒì¼ ì•±ì—ì„œ í™•ì¸í•˜ì„¸ìš”.');
      }, 500);
    }
  } catch (err) {
    console.error('âŒ ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:', err);
    alert('âš ï¸ ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
  }
}

/**********************
 * Chart.js ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸° í•¨ìˆ˜
 **********************/
function waitForChartRender(chart, timeout = 2000) {
  return new Promise((resolve, reject) => {
    if (!chart || !chart.canvas) {
      reject(new Error('Chart ì¸ìŠ¤í„´ìŠ¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'));
      return;
    }
    
    try {
      // Chart.jsì˜ update ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ê°•ì œë¡œ ë Œë”ë§
      if (typeof chart.update === 'function') {
        chart.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
      }
      
      // ë Œë”ë§ ì™„ë£Œë¥¼ ë³´ì¥í•˜ê¸° ìœ„í•´ ì—¬ëŸ¬ í”„ë ˆì„ ëŒ€ê¸°
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            // ìµœì¢… í™•ì¸: Canvasì— ì‹¤ì œë¡œ ê·¸ë ¤ì¡ŒëŠ”ì§€ í™•ì¸
            try {
            const ctx = chart.canvas.getContext('2d');
              // ìº”ë²„ìŠ¤ í¬ê¸° í™•ì¸ (0ì´ë©´ ì˜¤ë¥˜ ë°œìƒ)
              if (chart.canvas.width > 0 && chart.canvas.height > 0) {
                const sampleWidth = Math.min(chart.canvas.width, 10);
                const sampleHeight = Math.min(chart.canvas.height, 10);
                const imageData = ctx.getImageData(0, 0, sampleWidth, sampleHeight);
            const hasContent = imageData.data.some((val, idx) => idx % 4 !== 3 && val !== 0); // ì•ŒíŒŒ ì±„ë„ ì œì™¸í•˜ê³  í”½ì…€ ë°ì´í„° í™•ì¸
            
            if (hasContent || chart.canvas.width > 0) {
              resolve(chart);
            } else {
              // ë‚´ìš©ì´ ì—†ì–´ë„ íƒ€ì„ì•„ì›ƒ í›„ ì§„í–‰
                  setTimeout(() => resolve(chart), 100);
                }
              } else {
                // ìº”ë²„ìŠ¤ í¬ê¸°ê°€ 0ì´ë©´ íƒ€ì„ì•„ì›ƒ í›„ ì§„í–‰
                setTimeout(() => resolve(chart), 100);
              }
            } catch (err) {
              // getImageData ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì§„í–‰
              console.warn('Chart ìº”ë²„ìŠ¤ í™•ì¸ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨):', err);
              setTimeout(() => resolve(chart), 100);
            }
          });
        });
      });
      
      // íƒ€ì„ì•„ì›ƒ ì„¤ì • (ì•ˆì „ì¥ì¹˜)
      setTimeout(() => {
        resolve(chart);
      }, timeout);
    } catch (err) {
      console.warn('Chart ë Œë”ë§ ëŒ€ê¸° ì¤‘ ì˜¤ë¥˜:', err);
      // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì§„í–‰ (ìµœì†Œí•œì˜ ë Œë”ë§ì€ ë˜ì—ˆì„ ê²ƒ)
      setTimeout(() => resolve(chart), 100);
    }
  });
}

let chartJsReadyPromise = null;

function loadChartJsFromCdn() {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
    script.async = true;
    script.onload = () => resolve();
    script.onerror = () => reject(new Error('Chart.js CDN ë¡œë“œ ì‹¤íŒ¨'));
    document.head.appendChild(script);
  });
}

function ensureChartLibrary(timeout = 3000) {
  if (typeof Chart !== 'undefined') {
    return Promise.resolve();
  }
  if (chartJsReadyPromise) {
    return chartJsReadyPromise;
  }
  chartJsReadyPromise = new Promise((resolve, reject) => {
    const start = Date.now();
    const poll = () => {
      if (typeof Chart !== 'undefined') {
        resolve();
      } else if (Date.now() - start >= timeout) {
        loadChartJsFromCdn().then(resolve).catch(reject);
      } else {
        setTimeout(poll, 100);
      }
    };
    poll();
  });
  return chartJsReadyPromise;
}

/**********************
 * ê°„ë‹¨í•œ PDF ìƒì„± í•¨ìˆ˜ (Before-After ë¹„êµ ì¤‘ì‹¬)
 * centerName, memberName: ì„¼í„°ëª…, íšŒì›ëª…
 * before, after: {CVA: 63.4, HPD: 0.9, ...} í˜•íƒœì˜ metrics ê°ì²´
 **********************/
async function generatePosturePDF(centerName, memberName, before, after) {
  try {
    await exportAsPdf({ centerName, memberName });
    return;
  } catch (primaryErr) {
    console.warn('í™•ì¥ PDF ìƒì„± ì‹¤íŒ¨, ê°„ë‹¨ ë²„ì „ì„ ì‹œë„í•©ë‹ˆë‹¤:', primaryErr);
  }

  try {
    const analysis = await analyzePostureAI(before, after);
    if (analysis?.error) {
      throw new Error(analysis.error);
    }

    const { jsPDF } = window.jspdf;
    if (!jsPDF) {
      throw new Error('jsPDFê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    const pdf = new jsPDF('p', 'mm', 'a4');
    pdf.setFont('helvetica', 'normal');
    pdf.setFontSize(20);
    pdf.text('AI ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸', 105, 20, { align: 'center' });
    pdf.setFontSize(12);
    pdf.text(`ì„¼í„°ëª…: ${centerName || 'ë¯¸ì…ë ¥'}`, 20, 35);
    pdf.text(`íšŒì›ëª…: ${memberName || 'ë¯¸ì…ë ¥'}`, 20, 42);
    pdf.text(`ìƒì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}`, 20, 49);

    try {
      await ensureChartLibrary();
    } catch (chartErr) {
      console.warn('Chart.js ì¤€ë¹„ ì‹¤íŒ¨:', chartErr);
    }
    const chartCanvas = typeof Chart !== 'undefined' ? drawComparisonChart(before, after, null, { disableAnimation: true }) : null;
    if (chartCanvas && chartCanvas.chart) {
      await waitForChartRender(chartCanvas.chart);
      const chartImg = chartCanvas.toDataURL('image/png', 1.0);
      if (chartImg && chartImg !== 'data:,') {
        pdf.addImage(chartImg, 'PNG', 10, 60, 180, 80);
        pdf.text('Beforeâ€“After ë³€í™” ì‹œê°í™”', 20, 155);
      } else {
        pdf.text('âš ï¸ ê·¸ë˜í”„ ìƒì„± ì‹¤íŒ¨', 20, 60);
      }
    } else {
      pdf.text('âš ï¸ ê·¸ë˜í”„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 20, 60);
    }

    let y = 170;
    const results = Array.isArray(analysis?.results) ? analysis.results : [];
    for (const item of results) {
      if (y > 260) {
        pdf.addPage();
        y = 20;
      }
      pdf.setFontSize(11);
      pdf.text(`${item.name || item.metric || 'ì§€í‘œ'}`, 20, y);
      pdf.setFontSize(10);
      pdf.text(`Before: ${item.before}${item.unit} | After: ${item.after}${item.unit}`, 20, y + 6);
      pdf.text(`ë³€í™”: ${item.change >= 0 ? '+' : ''}${item.change}${item.unit} â†’ ìƒíƒœ: ${item.status || 'â€”'}`, 20, y + 12);
      let nextY = y + 18;
      if (item.aiComment) {
        const commentLines = pdf.splitTextToSize(`ğŸ’¬ ${item.aiComment}`, 170);
        pdf.text(commentLines, 20, nextY);
        nextY += commentLines.length * 5;
      }
      if (item.musclePattern && (item.musclePattern.tight || item.musclePattern.weak)) {
        const muscleText = `ğŸ¦´ ê·¼ìœ¡íŒ¨í„´: ê¸´ì¥(${item.musclePattern.tight || 'â€”'}) / ì•½í™”(${item.musclePattern.weak || 'â€”'})`;
        const muscleLines = pdf.splitTextToSize(muscleText, 170);
        pdf.text(muscleLines, 20, nextY);
        nextY += muscleLines.length * 5;
      }
      if (item.pilatesSession) {
        const pilatesParts = [];
        if (item.pilatesSession.mat) pilatesParts.push(`Mat: ${item.pilatesSession.mat}`);
        if (item.pilatesSession.reformer) pilatesParts.push(`Reformer: ${item.pilatesSession.reformer}`);
        if (item.pilatesSession.cadillac) pilatesParts.push(`Cadillac: ${item.pilatesSession.cadillac}`);
        if (item.pilatesSession.chair) pilatesParts.push(`Chair: ${item.pilatesSession.chair}`);
        if (item.pilatesSession.barrel) pilatesParts.push(`Barrel: ${item.pilatesSession.barrel}`);
        if (pilatesParts.length > 0) {
          const pilatesText = `ğŸ§˜ í•„ë¼í…ŒìŠ¤ ì„¸ì…˜: ${pilatesParts.join(' | ')}`;
          const pilatesLines = pdf.splitTextToSize(pilatesText, 170);
          pdf.text(pilatesLines, 20, nextY);
          nextY += pilatesLines.length * 5;
        }
      }
      if (item.guide) {
        const guideLines = pdf.splitTextToSize(`ğŸ‹ ìš´ë™ê°€ì´ë“œ: ${item.guide}`, 170);
        pdf.text(guideLines, 20, nextY);
        nextY += guideLines.length * 5;
      }
      y = nextY + 8;
    }

    const fileName = `${memberName || 'íšŒì›'}_AI_Report_v2.pdf`;
    await savePDFMobileCompatible(fileName, pdf);
  } catch (err) {
    console.error('PDF ìƒì„± ì˜¤ë¥˜:', err);
    alert('ê°„ë‹¨ PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
  }
}

// ì¸¡ì • ê²°ê³¼ ê¸°ë°˜ í•„ë¼í…ŒìŠ¤ ì¶”ì²œ (ì˜¬ë°”ë¥¸ metrics êµ¬ì¡° ì‚¬ìš©)
function recommendPilatesFromMetrics(beforeMetrics, afterMetrics) {
  const recommendations = [];
  
  // í—¬í¼ í•¨ìˆ˜: ë©”íŠ¸ë¦­ ê°’ ê°€ì ¸ì˜¤ê¸°
  const getMetricValue = (metrics, key) => {
    if(!metrics) return null;
    const fullMetrics = metrics.fullMetrics || {};
    const metric = fullMetrics[key];
    if(!metric) return null;
    return metric.value !== undefined ? metric.value : 
           (metric.value_deg !== undefined ? metric.value_deg : 
           (metric.value_cm !== undefined ? metric.value_cm : null));
  };
  
  // CVA (ê±°ë¶ëª©) ê°œì„  - CVAê°€ ì¦ê°€í•˜ë©´ ê°œì„ 
  const cvaBefore = getMetricValue(beforeMetrics, 'CVA');
  const cvaAfter = getMetricValue(afterMetrics, 'CVA');
  if(cvaBefore != null && cvaAfter != null && cvaAfter > cvaBefore && cvaAfter < 50) {
    recommendations.push({
      issue: 'ê±°ë¶ëª© ê°œì„ ',
      muscles: ['ì‹¬ë¶€ê²½ë¶€êµ´ê·¼', 'ìƒë¶€ìŠ¹ëª¨ê·¼'],
      exercises: ['Chin Tuck', 'Swan', 'Pulling Straps'],
      pilates: {
        'ë§¤íŠ¸': ['Chin Tuck', 'Swan'],
        'ë¦¬í¬ë¨¸': ['Pulling Straps', 'Neck Pull'],
        'ìºë”œë½': ['Tower Prep']
      }
    });
  }
  
  // CVAê°€ 50ë„ ë¯¸ë§Œì´ë©´ ê±°ë¶ëª© ë¬¸ì œ
  if(cvaAfter != null && cvaAfter < 50) {
    recommendations.push({
      issue: 'ê±°ë¶ëª© ê°œì„ ',
      muscles: ['ì‹¬ë¶€ê²½ë¶€êµ´ê·¼', 'ìƒë¶€ìŠ¹ëª¨ê·¼'],
      exercises: ['Chin Tuck', 'Swan', 'Pulling Straps'],
      pilates: {
        'ë§¤íŠ¸': ['Chin Tuck', 'Swan'],
        'ë¦¬í¬ë¨¸': ['Pulling Straps', 'Neck Pull'],
        'ìºë”œë½': ['Tower Prep']
      }
    });
  }
  
  // PTA (ê³¨ë°˜ ì „ë°©ê²½ì‚¬) êµì • - PTAê°€ 15ë„ ì´ˆê³¼ë©´ ê³¼ì „ê²½ì‚¬
  const ptaBefore = getMetricValue(beforeMetrics, 'PTA');
  const ptaAfter = getMetricValue(afterMetrics, 'PTA');
  if(ptaAfter != null && ptaAfter > 15) {
    recommendations.push({
      issue: 'ê³¼ì „ê²½ì‚¬ ê³¨ë°˜',
      muscles: ['ë³µë¶€ ì½”ì–´', 'ë‘”ê·¼'],
      exercises: ['Pelvic Curl', 'Bridge', 'Hundred'],
      pilates: {
        'ë§¤íŠ¸': ['Pelvic Curl', 'Bridge', 'Hundred'],
        'ë¦¬í¬ë¨¸': ['Bridge on Reformer', 'Footwork'],
        'ìºë”œë½': ['Leg Springs']
      }
    });
  }
  
  // KA (ë¬´ë¦ê°) - Xì ë‹¤ë¦¬ (KA < 175ë„)
  const kaBefore = getMetricValue(beforeMetrics, 'KA');
  const kaAfter = getMetricValue(afterMetrics, 'KA');
  if(kaAfter != null && kaAfter < 175) {
    recommendations.push({
      issue: 'Xì ë‹¤ë¦¬ êµì •',
      muscles: ['ì¤‘ë‘”ê·¼', 'ëŒ€ë‘”ê·¼'],
      exercises: ['Side-Lying Leg Lift', 'Clamshell'],
      pilates: {
        'ë§¤íŠ¸': ['Side-Lying Leg Lift', 'Clamshell'],
        'ë¦¬í¬ë¨¸': ['Side Splits'],
        'ìºë”œë½': ['Side Leg Springs']
      }
    });
  }
  
  // SAA (ì–´ê¹¨ ì „ë°©ê°) - ë¼ìš´ë“œ ìˆ„ë” (SAA > 10ë„)
  const saaBefore = getMetricValue(beforeMetrics, 'SAA');
  const saaAfter = getMetricValue(afterMetrics, 'SAA');
  if(saaAfter != null && saaAfter > 10) {
    recommendations.push({
      issue: 'ë¼ìš´ë“œ ìˆ„ë” ì•ˆì •í™”',
      muscles: ['í‰ê·¼ ì´ì™„', 'ê²¬ê°‘ ì•ˆì •í™”'],
      exercises: ['Prone Scapular Retraction', 'Arm Springs', 'Chest Expansion'],
      pilates: {
        'ë§¤íŠ¸': ['Prone Scapular Retraction', 'Chest Expansion'],
        'ë¦¬í¬ë¨¸': ['Arm Springs', 'Pulling Straps'],
        'ìºë”œë½': ['Chest Expansion on Cadillac']
      }
    });
  }
  
  // ì¤‘ë³µ ì œê±° (ê°™ì€ issueê°€ ìˆìœ¼ë©´ í•˜ë‚˜ë§Œ ìœ ì§€)
  const uniqueRecommendations = [];
  const seenIssues = new Set();
  recommendations.forEach(rec => {
    if(!seenIssues.has(rec.issue)) {
      seenIssues.add(rec.issue);
      uniqueRecommendations.push(rec);
    }
  });
  
  console.log('í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ìƒì„±:', uniqueRecommendations.length, 'ê°œ');
  return uniqueRecommendations;
}

// âœ… html2canvas ìµœì í™” ìº¡ì²˜ í•¨ìˆ˜
async function captureForPdf(elem) {
  if (!elem || !document.body.contains(elem)) {
    console.error('âŒ ì»¨í…Œì´ë„ˆê°€ DOMì— ì—†ìŠµë‹ˆë‹¤:', elem?.id);
    throw new Error(`ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${elem?.id}`);
  }

  // âœ… ì»¨í…Œì´ë„ˆ í¬ê¸° í™•ì¸
  const width = elem.offsetWidth || elem.scrollWidth || 794;
  const height = elem.offsetHeight || elem.scrollHeight || 1000;
  
  if (width === 0 || height === 0) {
    console.error('âŒ ì»¨í…Œì´ë„ˆ í¬ê¸°ê°€ 0ì…ë‹ˆë‹¤:', elem.id, { width, height });
    throw new Error(`ì»¨í…Œì´ë„ˆ í¬ê¸°ê°€ 0ì…ë‹ˆë‹¤: ${elem.id}`);
  }

  // âœ… ìº¡ì²˜ ì „ì— opacityë¥¼ 1ë¡œ ë³€ê²½ (íˆ¬ëª… ìº¡ì²˜ ë°©ì§€)
  const originalOpacity = elem.style.opacity;
  const originalVisibility = elem.style.visibility;
  const originalPosition = elem.style.position;
  const originalTop = elem.style.top;
  const originalLeft = elem.style.left;
  const originalZIndex = elem.style.zIndex;
  const originalTransform = elem.style.transform;
  const originalClass = elem.className;
  
  // âœ… .pdf-safe í´ë˜ìŠ¤ ì œê±° (opacity: 0 !important ìš°íšŒ)
  if (elem.classList.contains('pdf-safe')) {
    elem.classList.remove('pdf-safe');
  }
  
  // âœ… ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ê°•ì œ ì„¤ì • (!important ìš°íšŒ)
  elem.style.setProperty('opacity', '1', 'important');
  elem.style.setProperty('visibility', 'visible', 'important');
  elem.style.setProperty('position', 'absolute', 'important');
  elem.style.setProperty('top', '0', 'important');
  elem.style.setProperty('left', '0', 'important');
  elem.style.setProperty('z-index', '9999', 'important');
  elem.style.setProperty('transform', 'scale(1)', 'important');
  elem.style.setProperty('display', 'block', 'important');
  // âœ… A4 ìš©ì§€ ë„ˆë¹„ì— ë§ê²Œ ê°•ì œ ì„¤ì • (794px = A4 ë„ˆë¹„, CSS !important ìš°íšŒ)
  elem.style.setProperty('width', `${width}px`, 'important');
  elem.style.setProperty('max-width', `${width}px`, 'important');
  
  // âœ… ì¶”ê°€: ëª¨ë“  ìì‹ ìš”ì†Œë„ opacity ë³´ì •
  const allChildren = elem.querySelectorAll('*');
  allChildren.forEach(child => {
    if (child.style) {
      const childOriginalOpacity = child.style.opacity;
      const childOriginalVisibility = child.style.visibility;
      child.style.setProperty('opacity', '1', 'important');
      child.style.setProperty('visibility', 'visible', 'important');
      // ë‚˜ì¤‘ì— ë³µì›í•˜ê¸° ìœ„í•´ data ì†ì„±ì— ì €ì¥
      if (childOriginalOpacity) child.setAttribute('data-original-opacity', childOriginalOpacity);
      if (childOriginalVisibility) child.setAttribute('data-original-visibility', childOriginalVisibility);
    }
  });
  
  // âœ… í°íŠ¸ ë¡œë“œ ëŒ€ê¸° (html2canvasê°€ í°íŠ¸ë¥¼ ì œëŒ€ë¡œ ë Œë”ë§í•˜ë„ë¡)
  if (document.fonts && document.fonts.ready) {
    await document.fonts.ready;
  }
  
  // âœ… ì´ë¯¸ì§€ ë¡œë“œ ëŒ€ê¸°
  const images = elem.querySelectorAll('img');
  if (images.length > 0) {
    await Promise.all(Array.from(images).map(img => {
      if (img.complete && img.naturalWidth > 0) return Promise.resolve();
      return new Promise((resolve) => {
        const timeout = setTimeout(resolve, 3000); // ìµœëŒ€ 3ì´ˆ ëŒ€ê¸°
        img.onload = () => {
          clearTimeout(timeout);
          resolve();
        };
        img.onerror = () => {
          clearTimeout(timeout);
          resolve(); // ì—ëŸ¬ê°€ ë‚˜ë„ ê³„ì† ì§„í–‰
        };
      });
    }));
  }
  
  // âœ… ì»¨í…Œì´ë„ˆ ë‚´ìš© ê²€ì¦ (ë¹ˆ ì»¨í…Œì´ë„ˆ ë°©ì§€)
  const hasContent = elem.textContent.trim().length > 0 || 
                     elem.querySelectorAll('img').length > 0 ||
                     elem.querySelectorAll('canvas').length > 0 ||
                     elem.innerHTML.trim().length > 50;
  
  if (!hasContent) {
    console.warn(`âš ï¸ ì»¨í…Œì´ë„ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤: ${elem.id}`);
  }
  
  // âœ… Canvas ë Œë”ë§ ë³´ì¥ (ëª¨ë°”ì¼ PDF ì €ì¥ ì‹œ ì‚¬ì§„ ë° ì  ëˆ„ë½ ë°©ì§€)
  const canvasElements = elem.querySelectorAll('canvas');
  if (canvasElements.length > 0) {
    // ë©”ì¸ Canvas (cv)ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    if (cv && typeof draw === 'function') {
      try {
        draw(); // ëª¨ë“  ì ê³¼ ì„ ì„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        await new Promise(res => requestAnimationFrame(res)); // ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°
      } catch (err) {
        console.warn('Canvas ë Œë”ë§ ì¤‘ ì˜¤ë¥˜:', err);
      }
    }
    // ì»¨í…Œì´ë„ˆ ë‚´ì˜ ë‹¤ë¥¸ Canvas ìš”ì†Œë“¤ë„ ë Œë”ë§ ë³´ì¥
    canvasElements.forEach(canvas => {
      if (canvas.getContext) {
        const ctx = canvas.getContext('2d');
        if (ctx) {
          // Canvasê°€ ì´ë¯¸ ê·¸ë ¤ì ¸ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€, ì•„ë‹ˆë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
          try {
            // Canvas ë‚´ìš©ì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
            const imageData = ctx.getImageData(0, 0, Math.min(canvas.width, 10), Math.min(canvas.height, 10));
            const hasContent = imageData.data.some((val, idx) => idx % 4 !== 3 || val < 255); // ì•ŒíŒŒ ì±„ë„ í™•ì¸
            if (!hasContent && typeof draw === 'function') {
              draw();
            }
          } catch (err) {
            // Canvas ì ‘ê·¼ ì˜¤ë¥˜ëŠ” ë¬´ì‹œ
          }
        }
      }
    });
  }
  
  // âœ… ë Œë”ë§ íƒ€ì´ë° ë³´ì¥ (ë” ê¸´ ëŒ€ê¸° ì‹œê°„)
  await new Promise(res => requestAnimationFrame(res));
  await new Promise(res => requestAnimationFrame(res));
  await new Promise(res => requestAnimationFrame(res));
  await new Promise(res => setTimeout(res, 200)); // 100ms â†’ 200msë¡œ ì¦ê°€

  // âœ… html2canvas ì˜µì…˜ ìµœì í™” (A4 ìš©ì§€ì— ë§ê²Œ ì¡°ì •)
  // âœ… scaleì„ 2ë¡œ ìœ ì§€í•˜ì—¬ ì›ë³¸ í¬ê¸°ì™€ í•´ìƒë„ ë³´ì¥ (ì‚¬ì§„ê³¼ dotê°€ ì˜ ë³´ì´ë„ë¡)
  const canvas = await html2canvas(elem, {
    scale: 2,  // âœ… ì›ë³¸ í¬ê¸° ìœ ì§€ (ì‚¬ì§„ê³¼ dotê°€ ì˜ ë³´ì´ë„ë¡)
    backgroundColor: "#ffffff",
    useCORS: true,
    allowTaint: false,
    foreignObjectRendering: false, // âœ… Quirks Mode ë°©ì§€
    logging: false,
    width: width,
    height: height,
    removeContainer: false, // ì»¨í…Œì´ë„ˆ ì œê±° ë°©ì§€
    imageTimeout: 15000, // ì´ë¯¸ì§€ ë¡œë“œ íƒ€ì„ì•„ì›ƒ 15ì´ˆ
    windowWidth: width,  // âœ… ëª…ì‹œì  ë„ˆë¹„ ì„¤ì •
    windowHeight: height, // âœ… ëª…ì‹œì  ë†’ì´ ì„¤ì •
    onclone: (clonedDoc) => {
      // âœ… Quirks Mode ë°©ì§€: ë³µì œëœ ë¬¸ì„œì— DOCTYPE ì¶”ê°€ (ìµœì¢… ê°•í™”)
      try {
        // ë³µì œëœ ë¬¸ì„œì™€ ê´€ë ¨ëœ ëª¨ë“  ë¬¸ì„œ í™•ì¸
        const docsToFix = [clonedDoc];
        
        // clonedDoc.defaultViewë¥¼ í†µí•´ windowì— ì ‘ê·¼ (iframe ë‚´ë¶€ ë¬¸ì„œì¼ ìˆ˜ ìˆìŒ)
        if (clonedDoc.defaultView && clonedDoc.defaultView.document && clonedDoc.defaultView.document !== clonedDoc) {
          docsToFix.push(clonedDoc.defaultView.document);
        }
        
        // âœ… html2canvasê°€ ìƒì„±í•œ ëª¨ë“  iframe ë¬¸ì„œë„ í™•ì¸
        try {
          const allIframes = clonedDoc.querySelectorAll('iframe');
          allIframes.forEach(iframe => {
            try {
              if (iframe.contentDocument && iframe.contentDocument !== clonedDoc) {
                docsToFix.push(iframe.contentDocument);
              }
            } catch (e) {
              // Cross-origin iframeì€ ì ‘ê·¼ ë¶ˆê°€ (ë¬´ì‹œ)
            }
          });
        } catch (e) {
          // iframe ì ‘ê·¼ ì‹¤íŒ¨ (ë¬´ì‹œ)
        }
        
        docsToFix.forEach(doc => {
          try {
            // DOCTYPEì´ ì—†ê±°ë‚˜ Quirks Modeì¸ ê²½ìš° ê°•ì œë¡œ ì¶”ê°€
            if (!doc.doctype || doc.compatMode === 'BackCompat') {
              // ë°©ë²• 1: createDocumentType ì‚¬ìš© (ê°€ì¥ í‘œì¤€ì ì¸ ë°©ë²•)
              try {
                const doctype = doc.implementation.createDocumentType('html', '', '');
                // ê¸°ì¡´ DOCTYPEì´ ìˆìœ¼ë©´ ì œê±°
                if (doc.doctype) {
                  doc.removeChild(doc.doctype);
                }
                // documentElement ì•ì— DOCTYPE ì‚½ì…
                if (doc.documentElement) {
                  doc.insertBefore(doctype, doc.documentElement);
                } else {
                  // documentElementê°€ ì—†ìœ¼ë©´ ì§ì ‘ ì¶”ê°€
                  doc.appendChild(doctype);
                }
              } catch (e1) {
                console.warn('createDocumentType ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‹œë„:', e1);
                // ë°©ë²• 2: DOMParserë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆ ë¬¸ì„œ ìƒì„±
                try {
                  const htmlContent = '<!DOCTYPE html>\n' + (doc.documentElement ? doc.documentElement.outerHTML : '');
                  const parser = new DOMParser();
                  const newDoc = parser.parseFromString(htmlContent, 'text/html');
                  if (newDoc.doctype) {
                    // ê¸°ì¡´ DOCTYPE ì œê±° í›„ ìƒˆ DOCTYPE ì¶”ê°€
                    if (doc.doctype) {
                      doc.removeChild(doc.doctype);
                    }
                    if (doc.documentElement) {
                      doc.insertBefore(newDoc.doctype, doc.documentElement);
                    }
                  }
                } catch (e2) {
                  console.warn('DOMParser ë°©ë²•ë„ ì‹¤íŒ¨:', e2);
                }
              }
            }
            // ìµœì¢… í™•ì¸: document.compatModeê°€ 'BackCompat'ì´ë©´ Quirks Mode
            if (doc.compatMode === 'BackCompat') {
              console.warn('âš ï¸ ë³µì œëœ ë¬¸ì„œê°€ ì—¬ì „íˆ Quirks Modeì…ë‹ˆë‹¤. DOCTYPE:', doc.doctype);
            } else {
              console.log('âœ… ë³µì œëœ ë¬¸ì„œê°€ Standards Modeë¡œ ë Œë”ë§ë©ë‹ˆë‹¤.');
            }
          } catch (docErr) {
            console.warn('ê°œë³„ ë¬¸ì„œ DOCTYPE ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', docErr);
          }
        });
      } catch (err) {
        console.warn('onclone DOCTYPE ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', err);
      }
      
      // ë³µì œëœ ë¬¸ì„œì—ì„œë„ ìŠ¤íƒ€ì¼ ë³´ì •
      const clonedElem = clonedDoc.getElementById(elem.id);
      if (clonedElem) {
        clonedElem.style.opacity = '1';
        clonedElem.style.visibility = 'visible';
        clonedElem.style.transform = 'scale(1)';
        clonedElem.style.display = 'block'; // âœ… display: block ë³´ì¥
        // âœ… A4 ìš©ì§€ ë„ˆë¹„ì— ë§ê²Œ ì„¤ì • (ì˜ë¦¼ ë°©ì§€)
        clonedElem.style.width = `${width}px`;
        clonedElem.style.maxWidth = `${width}px`;
        clonedElem.style.position = 'absolute';
        clonedElem.style.left = '0';
        clonedElem.style.top = '0';
      }
      
      // âœ… ê²°ë¡  ë° í–¥í›„ ê¶Œì¥ì‚¬í•­ ì„¹ì…˜ ë†’ì´ ì œí•œ í•´ì œ (ê¸€ì ì˜ë¦¼ ë°©ì§€)
      const allElements = clonedDoc.querySelectorAll('*');
      allElements.forEach(el => {
        if (el.style) {
          // img, video, canvas íƒœê·¸ëŠ” overflow: visible ì„¤ì •í•˜ì§€ ì•ŠìŒ (deprecated ê²½ê³  ë°©ì§€)
          const isMediaElement = el.tagName === 'IMG' || el.tagName === 'VIDEO' || el.tagName === 'CANVAS';
          
          // í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš©
          el.style.wordWrap = 'break-word';
          el.style.overflowWrap = 'break-word';
          el.style.wordBreak = 'break-word';
          el.style.whiteSpace = el.style.whiteSpace === 'pre-wrap' ? 'pre-wrap' : 'normal';
          // img/video/canvasëŠ” overflow ì„¤ì •í•˜ì§€ ì•ŠìŒ
          if (!isMediaElement) {
          el.style.overflow = 'visible';
          }
          el.style.textOverflow = 'clip';
          
          // ê²°ë¡  ì„¹ì…˜ ì‹ë³„ ë° ë†’ì´ ì œí•œ í•´ì œ
          const textContent = el.textContent || '';
          const id = el.id || '';
          const className = String(el.className || el.getAttribute('class') || '');
          if (textContent.includes('ê²°ë¡ ') || textContent.includes('ê¶Œì¥ì‚¬í•­') || 
              id.includes('conclusion') || className.includes('conclusion')) {
            el.style.height = 'auto';
            el.style.maxHeight = 'none';
            // img/video/canvasëŠ” overflow ì„¤ì •í•˜ì§€ ì•ŠìŒ
            if (!isMediaElement) {
            el.style.overflow = 'visible';
            }
          }
          
          // ëª¨ë“  div ìš”ì†Œì˜ ë†’ì´ ì œí•œ í•´ì œ
          if (el.tagName === 'DIV') {
            el.style.maxHeight = 'none';
          }
        }
      });
    }
  });
  
  // âœ… ìº¡ì²˜ í›„ ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë³µì›
  elem.removeAttribute('style');
  if (originalOpacity) elem.style.opacity = originalOpacity;
  if (originalVisibility) elem.style.visibility = originalVisibility;
  if (originalPosition) elem.style.position = originalPosition;
  if (originalTop) elem.style.top = originalTop;
  if (originalLeft) elem.style.left = originalLeft;
  if (originalZIndex) elem.style.zIndex = originalZIndex;
  if (originalTransform) elem.style.transform = originalTransform;

  // âœ… .pdf-safe í´ë˜ìŠ¤ ë³µì›
  if (originalClass && originalClass.includes('pdf-safe')) {
    elem.className = originalClass;
  }

  // âœ… ìì‹ ìš”ì†Œ ìŠ¤íƒ€ì¼ ë³µì› (ì´ë¯¸ ì„ ì–¸ëœ allChildren ë³€ìˆ˜ ì‚¬ìš©)
  allChildren.forEach(child => {
    if (child.hasAttribute('data-original-opacity')) {
      child.style.opacity = child.getAttribute('data-original-opacity');
      child.removeAttribute('data-original-opacity');
    }
    if (child.hasAttribute('data-original-visibility')) {
      child.style.visibility = child.getAttribute('data-original-visibility');
      child.removeAttribute('data-original-visibility');
    }
  });
  
  // âœ… ìº”ë²„ìŠ¤ í¬ê¸° í™•ì¸
  if (canvas.width === 0 || canvas.height === 0) {
    console.error('âŒ ìº”ë²„ìŠ¤ í¬ê¸°ê°€ 0ì…ë‹ˆë‹¤:', elem.id, { width: canvas.width, height: canvas.height });
    throw new Error(`ìº”ë²„ìŠ¤ í¬ê¸°ê°€ 0ì…ë‹ˆë‹¤: ${elem.id}`);
  }
  
  return canvas;
}

// âœ… PDF ë‚´ë³´ë‚´ê¸° ìœ í‹¸ (í—¤ë”/í‘¸í„° í¬í•¨)
async function exportAsPdf(options = {}) {
  const {
    fileName = null,
    centerName = localStorage.getItem('centerName'),
    memberName = localStorage.getItem('memberName'),
    appName = 'DIT ìì„¸ ë¶„ì„ AI',
    logoUrl = null
  } = options;
  
  // íŒŒì¼ëª… ìë™ ìƒì„±
  let finalName = fileName;
  if (!finalName) {
    if (centerName && memberName) {
      finalName = `${centerName}_${memberName}_ìì„¸ë¶„ì„ë¦¬í¬íŠ¸_${new Date().toISOString().split('T')[0]}.pdf`;
    } else {
      finalName = `DIT_ìì„¸_ë¶„ì„_${Date.now()}.pdf`;
    }
  }

  // ìº¡ì³ ë¦¬ìŠ¤íŠ¸ë§Œ ê°€ì ¸ì˜´ (ìº”ë²„ìŠ¤ ìƒì„± ì•ˆí•¨)
  const { captureList } = await captureReportCanvases({
        centerName,
        memberName,
        appName,
        logoUrl
      });
      
  // Worker ìƒì„± (GitHub Pages ì ˆëŒ€ URL ì‚¬ìš©)
  const workerBase = location.pathname.replace(/\/[^/]*$/, "/");
  const worker = new Worker(`${workerBase}pdfWorker.js`);

  function send(msg) {
    worker.postMessage(msg);
  }

  const pdfPromise = new Promise((resolve, reject) => {
    worker.onmessage = e => {
      const msg = e.data;

      if (msg.type === "pdfReady") {
        const blob = new Blob([msg.buffer], { type: "application/pdf" });
        resolve(blob);
        worker.terminate();
      }

      if (msg.type === "error") {
        reject(new Error(msg.message));
        worker.terminate();
      }
    };

    worker.onerror = err => {
      reject(new Error("Worker ë¡œë“œ ì‹¤íŒ¨: " + err.message));
      worker.terminate();
    };
  });

  // PDF ì´ˆê¸°í™”
  send({ type: "init", options: { orientation: "p", unit: "px", format: "a4" } });

  const pageW = 595;
  const pageH = 842;
  const margin = 24;
  const imgW = pageW - margin * 2;
  const imgH = pageH - margin * 2;

  // âœ… ê¸´ ì»¨í…Œì´ë„ˆë¥¼ ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë‚˜ëˆ„ëŠ” í•¨ìˆ˜
  async function addImageToPdf(canvas, containerId, addPageAfter) {
    if (!canvas || canvas.width === 0 || canvas.height === 0) {
      console.error(`âŒ ìº”ë²„ìŠ¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${containerId}`);
      return;
    }

    const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
    if (!dataUrl || dataUrl === 'data:,') {
      console.error(`âŒ ì´ë¯¸ì§€ ë°ì´í„° ìƒì„± ì‹¤íŒ¨: ${containerId}`);
      return;
    }

    // âœ… ì›ë³¸ ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ PDF í˜ì´ì§€ì— ë§ê²Œ ìŠ¤ì¼€ì¼ë§ (ì˜ë¦¼ ë°©ì§€)
    const canvasAspectRatio = canvas.width / canvas.height;
    const maxWidth = imgW; // í•œ í˜ì´ì§€ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ ë„ˆë¹„
    const maxHeight = imgH; // í•œ í˜ì´ì§€ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ ë†’ì´
    
    // âœ… ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ í˜ì´ì§€ì— ë§ê²Œ ìŠ¤ì¼€ì¼ë§ (ë„ˆë¹„ì™€ ë†’ì´ ëª¨ë‘ í™•ì¸)
    let scaledWidth = maxWidth;
    let scaledHeight = maxWidth / canvasAspectRatio;
    
    // âœ… ë†’ì´ê°€ í˜ì´ì§€ë¥¼ ì´ˆê³¼í•˜ë©´ ë†’ì´ ê¸°ì¤€ìœ¼ë¡œ ì¬ê³„ì‚° (ì˜ë¦¼ ë°©ì§€)
    if (scaledHeight > maxHeight) {
      scaledHeight = maxHeight;
      scaledWidth = maxHeight * canvasAspectRatio;
    }
    
    // âœ… ëª¨ë°”ì¼ì—ì„œë„ ì˜ë¦¬ì§€ ì•Šë„ë¡ ìµœì†Œ í¬ê¸° ë³´ì¥
    const minScale = 0.3;
    if (scaledWidth < canvas.width * minScale) {
      scaledWidth = canvas.width * minScale;
      scaledHeight = scaledWidth / canvasAspectRatio;
      if (scaledHeight > maxHeight) {
        scaledHeight = maxHeight;
        scaledWidth = maxHeight * canvasAspectRatio;
      }
    }

    // âœ… ì»¨í…Œì´ë„ˆê°€ í•œ í˜ì´ì§€ë¥¼ ì´ˆê³¼í•˜ë©´ ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë‚˜ëˆ„ê¸°
    // ì›ë³¸ ìº”ë²„ìŠ¤ì˜ ì‹¤ì œ ë†’ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì—¬ëŸ¬ í˜ì´ì§€ í•„ìš” ì—¬ë¶€ íŒë‹¨
    const originalScaledHeight = (canvas.height * scaledWidth) / canvas.width;
    if (originalScaledHeight > maxHeight) {
      const numPages = Math.ceil(originalScaledHeight / maxHeight);
      console.log(`ğŸ“„ ${containerId}: ${numPages}ê°œ í˜ì´ì§€ë¡œ ë¶„í•  (ë†’ì´: ${originalScaledHeight.toFixed(0)}px)`);
      
      const sourceHeight = canvas.height;
      const sliceHeight = sourceHeight / numPages;
      
      for (let pageIndex = 0; pageIndex < numPages; pageIndex++) {
        const yOffset = pageIndex * sliceHeight;
        const currentSliceHeight = Math.min(sliceHeight, sourceHeight - yOffset);
        
        // âœ… ìº”ë²„ìŠ¤ ìŠ¬ë¼ì´ìŠ¤ ìƒì„±
        const sliceCanvas = document.createElement('canvas');
        sliceCanvas.width = canvas.width;
        sliceCanvas.height = currentSliceHeight;
        const sliceCtx = sliceCanvas.getContext('2d');
        sliceCtx.drawImage(canvas, 0, yOffset, canvas.width, currentSliceHeight, 0, 0, canvas.width, currentSliceHeight);
        
        const sliceDataUrl = sliceCanvas.toDataURL("image/jpeg", 0.92);
        const sliceScaledHeight = (currentSliceHeight / sourceHeight) * originalScaledHeight;
        
        // âœ… ê° ìŠ¬ë¼ì´ìŠ¤ë¥¼ PDF í˜ì´ì§€ë¡œ ì¶”ê°€ (ë¹„ìœ¨ ìœ ì§€)
        send({
          type: "addImage",
          dataUrl: sliceDataUrl,
          imageType: "JPEG",
          x: margin,
          y: margin,
          width: scaledWidth,
          height: Math.min(sliceScaledHeight, maxHeight),
          addPageAfter: pageIndex < numPages - 1 || (pageIndex === numPages - 1 && addPageAfter)
        });
        
        // GC
        sliceCanvas.width = 1;
        sliceCanvas.height = 1;
        }
      } else {
      // âœ… í•œ í˜ì´ì§€ì— ë“¤ì–´ê°€ëŠ” ê²½ìš°
      send({
        type: "addImage",
        dataUrl,
        imageType: "JPEG",
        x: margin,
        y: margin,
        width: scaledWidth,
        height: scaledHeight,
        addPageAfter: addPageAfter
      });
    }

    // GC
    canvas.width = 1;
    canvas.height = 1;
  }

  // html2canvas â†’ JPEG â†’ Worker ë¡œ ì „ì†¡
  let capturedCount = 0;
  console.log(`ğŸ“„ PDF ìƒì„± ì‹œì‘: ${captureList.length}ê°œ ì»¨í…Œì´ë„ˆ ìº¡ì²˜ ì˜ˆì •`);
  
  for (const item of captureList) {
    const elem = document.getElementById(item.id);
    if (!elem) {
      console.warn(`âš ï¸ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${item.id} (ì¡°ê±´ë¶€ ìƒì„± ì»¨í…Œì´ë„ˆì¼ ìˆ˜ ìˆìŒ)`);
      continue;
    }

    // âœ… ì»¨í…Œì´ë„ˆ ë‚´ìš© ì‚¬ì „ ê²€ì¦
    const hasContent = elem.textContent.trim().length > 0 || 
                       elem.querySelectorAll('img').length > 0 ||
                       elem.querySelectorAll('canvas').length > 0 ||
                       elem.innerHTML.trim().length > 50;
    
    if (!hasContent) {
      console.warn(`âš ï¸ ì»¨í…Œì´ë„ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤: ${item.id}, ìŠ¤í‚µí•©ë‹ˆë‹¤`);
      continue;
    }

    try {
      console.log(`ğŸ“¸ ${item.id} ìº¡ì²˜ ì‹œì‘...`);
      // ìº¡ì²˜
      const canvas = await captureForPdf(elem);
      
      if (!canvas || canvas.width === 0 || canvas.height === 0) {
        console.error(`âŒ ìº”ë²„ìŠ¤ ìƒì„± ì‹¤íŒ¨: ${item.id}`);
        continue;
      }

      // âœ… ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë‚˜ëˆ„ì–´ì„œ ì¶”ê°€
      await addImageToPdf(canvas, item.id, item.addPageAfter);

      capturedCount++;
      console.log(`âœ… ${item.id} ìº¡ì²˜ ì™„ë£Œ`);
    } catch (err) {
      console.error(`âŒ ${item.id} ìº¡ì²˜ ì‹¤íŒ¨:`, err);
      // ì—ëŸ¬ê°€ ë‚˜ë„ ë‹¤ìŒ í˜ì´ì§€ ê³„ì† ì§„í–‰
      continue;
    }
  }
  
  // âœ… ìµœì†Œ 1ê°œ ì´ìƒ ìº¡ì²˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
  if (capturedCount === 0) {
    throw new Error('PDF ìƒì„± ì‹¤íŒ¨: ìº¡ì²˜ëœ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ìº¡ì²˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
  
  console.log(`âœ… ì´ ${capturedCount}ê°œ í˜ì´ì§€ ìº¡ì²˜ ì™„ë£Œ`);

  send({ type: "finalize" });

  const blob = await pdfPromise;

  // PDF ìƒì„± ì™„ë£Œ í›„ ì»¨í…Œì´ë„ˆ ì •ë¦¬
  for (const item of captureList) {
    const elem = document.getElementById(item.id);
    if (elem && document.body.contains(elem)) {
      document.body.removeChild(elem);
    }
  }

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = finalName;
  a.click();

              URL.revokeObjectURL(url);
}

// PDF ì €ì¥ (ëª¨ë°”ì¼ ìµœì í™”, í˜ì´ì§€ ë¶„ë¦¬) - ê°œì„  ë²„ì „
function setupPDFButton() {
  const btnPDF = document.getElementById("btnPDF");
  if (!btnPDF) {
    console.error("âŒ PDF ë²„íŠ¼(btnPDF)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ì¬ë“±ë¡ (ì¤‘ë³µ ë°©ì§€)
  const newBtn = btnPDF.cloneNode(true);
  btnPDF.parentNode.replaceChild(newBtn, btnPDF);
  
  newBtn.addEventListener('click', async () => {
    try {
      // ëª¨ë°”ì¼ì—ì„œ ë¡œë”© í‘œì‹œ
      const btn = document.getElementById("btnPDF");
      const originalText = btn.textContent;
      btn.textContent = "â³ PDF ìƒì„± ì¤‘...";
      btn.disabled = true;
      
      // ì„¼í„°ëª…/íšŒì›ëª… ì…ë ¥ (í•­ìƒ ì…ë ¥ë°›ê¸°)
      let centerName = prompt("ì„¼í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë ˆë“œì½”ì–´ìš´ë™ì„¼í„°):", localStorage.getItem('centerName') || "") || null;
      if(centerName) {
        localStorage.setItem('centerName', centerName);
      }
      
      let memberName = prompt("íšŒì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê¹€ê°•í›ˆ):", localStorage.getItem('memberName') || "") || null;
      if(memberName) {
        localStorage.setItem('memberName', memberName);
      }
      
      // ë‘˜ ë‹¤ ì…ë ¥ë˜ì§€ ì•Šìœ¼ë©´ ê²½ê³ 
      if(!centerName || !memberName) {
        const confirmContinue = confirm("ì„¼í„° ì´ë¦„ ë˜ëŠ” íšŒì› ì´ë¦„ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if(!confirmContinue) {
          btn.textContent = originalText;
          btn.disabled = false;
          return;
        }
      }
      
      // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸° (ìµœëŒ€ 3ì´ˆ)
      let retryCount = 0;
      while ((typeof html2canvas === 'undefined' || !window.jspdf) && retryCount < 30) {
        await new Promise(resolve => setTimeout(resolve, 100));
        retryCount++;
      }
      
      // ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
      if (typeof html2canvas === 'undefined') {
        throw new Error("html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
      }
      if (!window.jspdf || !window.jspdf.jsPDF) {
        throw new Error("jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
      }
      
      // ì„¸ì…˜ ë°ì´í„° í™•ì¸
      const S = sessions[cur];
      const hasSidePoints = S.sidePoints && (S.sidePoints.size > 0 || Object.keys(S.sidePoints).length > 0);
      const hasFrontPoints = S.frontPoints && (S.frontPoints.size > 0 || Object.keys(S.frontPoints).length > 0);
      if (!S || (!hasSidePoints && !hasFrontPoints)) {
        alert("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
        btn.textContent = originalText;
        btn.disabled = false;
        return;
      }
      
      // ê¸°ì¡´ ì‚¬ìš©ìëª… (í•˜ìœ„ í˜¸í™˜ì„±)
      let userName = localStorage.getItem('userName');
      if(!userName && !memberName) {
        userName = prompt("ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ë‚˜ì¤‘ì— ë³€ê²½ ê°€ëŠ¥):", "ì‚¬ìš©ì") || "ì‚¬ìš©ì";
        localStorage.setItem('userName', userName);
      }
      
      // âœ… ìƒˆë¡œìš´ 8í˜ì´ì§€ ì „ë¬¸ ë¦¬í¬íŠ¸ í•¨ìˆ˜ ì‚¬ìš©
      await generateFinalPostureReportPDF();
      
      btn.textContent = originalText;
      btn.disabled = false;
      
      // ëª¨ë°”ì¼ì—ì„œ ì„±ê³µ ë©”ì‹œì§€
      if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        alert("PDFê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
      }
    } catch(error) {
      console.error("âŒ PDF ìƒì„± ì‹¤íŒ¨:", error);
      console.error("âŒ ì—ëŸ¬ ìŠ¤íƒ:", error.stack);
      console.error("âŒ ì—ëŸ¬ ìƒì„¸:", {
        name: error.name,
        message: error.message,
        cause: error.cause
      });
      
      // âœ… ë” êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€
      const userMessage = error.message.includes('ìº”ë²„ìŠ¤ ìƒì„± ì‹¤íŒ¨') || error.message.includes('Blob') || error.message.includes('ìº¡ì²˜ëœ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤')
          ? "âŒ PDF ìƒì„±ì— í•„ìš”í•œ ì´ë¯¸ì§€ ìº¡ì²˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nê°€ëŠ¥í•œ ì›ì¸:\n- ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨\n- í°íŠ¸ ë¬¸ì œ\n- ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ\n\nì½˜ì†”ì„ í™•ì¸í•˜ì—¬ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          : error.message.includes('Worker')
          ? "âŒ PDF Worker ë¡œë“œ ì‹¤íŒ¨: " + error.message
          : "âŒ PDF ìƒì„± ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      
      alert(userMessage);
      btn.textContent = "ğŸ“„ PDF ì €ì¥ (ì˜¤ë¥˜)";
        btn.disabled = false;
    }
  });
}

// ê·¸ë¦¼ìœ¼ë¡œ ì €ì¥ (ì „ì²´ ë‚´ìš© í¬í•¨)
function setupImageButton() {
  const btnImage = document.getElementById("btnImage");
  if (!btnImage) {
    console.warn("ì´ë¯¸ì§€ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  btnImage.onclick = async () => {
    const btn = document.getElementById("btnImage");
    const originalText = btn.textContent;
    btn.textContent = "â³ ì´ë¯¸ì§€ ìƒì„± ì¤‘...";
    btn.disabled = true;
    try {
      if (typeof html2canvas === 'undefined') {
        throw new Error("html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
      }
      const memberNameDisplay = localStorage.getItem('memberName') || window.memberName || 'íšŒì›';
      const centerNameDisplay = localStorage.getItem('centerName') || window.centerName || '';
      
      // âœ… PDFì™€ ë™ì¼í•œ ì „ì²´ ë¦¬í¬íŠ¸ ì»¨í…Œì´ë„ˆ ìƒì„±
      const { captureList } = await captureReportCanvases({
        centerName: centerNameDisplay,
        memberName: memberNameDisplay,
        appName: 'DIT ìì„¸ ë¶„ì„ AI',
        logoUrl: null
      });
      
      if (!captureList || captureList.length === 0) {
        throw new Error("ì €ì¥í•  í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
      }
      
      // âœ… ëª¨ë“  ë¦¬í¬íŠ¸ ì»¨í…Œì´ë„ˆë¥¼ í•˜ë‚˜ì˜ ê¸´ ì»¨í…Œì´ë„ˆë¡œ ê²°í•©
      const fullReportContainer = document.createElement('div');
      fullReportContainer.id = 'fullReportContainerForImage';
      fullReportContainer.style.cssText = `
        position: absolute;
        left: -9999px;
        top: 0;
        width: 794px;
        max-width: 794px;
        background: white;
        padding: 0;
        display: block;
        opacity: 1;
        visibility: visible;
      `;
      
      // âœ… ëª¨ë“  ì»¨í…Œì´ë„ˆë¥¼ ìˆœì„œëŒ€ë¡œ ì¶”ê°€
      for (const item of captureList) {
        const elem = document.getElementById(item.id);
        if (elem) {
          // ì›ë³¸ ì»¨í…Œì´ë„ˆ ë³µì œ (DOMì—ì„œ ì œê±°í•˜ì§€ ì•ŠìŒ)
          const cloned = elem.cloneNode(true);
          cloned.style.cssText = `
            position: relative;
            width: 100%;
            max-width: 794px;
            margin-bottom: 0;
            opacity: 1;
            visibility: visible;
            display: block;
          `;
          fullReportContainer.appendChild(cloned);
        }
      }
      
      document.body.appendChild(fullReportContainer);
      
      // âœ… ë Œë”ë§ ëŒ€ê¸°
      await new Promise(res => requestAnimationFrame(res));
      await new Promise(res => setTimeout(res, 300));
      
      // âœ… ë‹¨ì¼ ê¸´ ì´ë¯¸ì§€ë¡œ ìº¡ì²˜
      const canvas = await html2canvas(fullReportContainer, {
        scale: 2, // ê³ í•´ìƒë„ ìº¡ì²˜
        backgroundColor: "#ffffff",
        useCORS: true,
        allowTaint: false,
        logging: false,
        width: 794,
        height: fullReportContainer.scrollHeight,
        windowWidth: 794,
        windowHeight: fullReportContainer.scrollHeight,
        onclone: (clonedDoc) => {
          // âœ… Quirks Mode ë°©ì§€: ë³µì œëœ ë¬¸ì„œì— DOCTYPE ì¶”ê°€ (ìµœì¢… ê°•í™”)
          try {
            // ë³µì œëœ ë¬¸ì„œì™€ ê´€ë ¨ëœ ëª¨ë“  ë¬¸ì„œ í™•ì¸
            const docsToFix = [clonedDoc];
            
            // clonedDoc.defaultViewë¥¼ í†µí•´ windowì— ì ‘ê·¼ (iframe ë‚´ë¶€ ë¬¸ì„œì¼ ìˆ˜ ìˆìŒ)
            if (clonedDoc.defaultView && clonedDoc.defaultView.document && clonedDoc.defaultView.document !== clonedDoc) {
              docsToFix.push(clonedDoc.defaultView.document);
            }
            
            // âœ… html2canvasê°€ ìƒì„±í•œ ëª¨ë“  iframe ë¬¸ì„œë„ í™•ì¸
            try {
              const allIframes = clonedDoc.querySelectorAll('iframe');
              allIframes.forEach(iframe => {
                try {
                  if (iframe.contentDocument && iframe.contentDocument !== clonedDoc) {
                    docsToFix.push(iframe.contentDocument);
                  }
                } catch (e) {
                  // Cross-origin iframeì€ ì ‘ê·¼ ë¶ˆê°€ (ë¬´ì‹œ)
                }
              });
            } catch (e) {
              // iframe ì ‘ê·¼ ì‹¤íŒ¨ (ë¬´ì‹œ)
            }
            
            docsToFix.forEach(doc => {
              try {
                // DOCTYPEì´ ì—†ê±°ë‚˜ Quirks Modeì¸ ê²½ìš° ê°•ì œë¡œ ì¶”ê°€
                if (!doc.doctype || doc.compatMode === 'BackCompat') {
                  // ë°©ë²• 1: createDocumentType ì‚¬ìš© (ê°€ì¥ í‘œì¤€ì ì¸ ë°©ë²•)
                  try {
                    const doctype = doc.implementation.createDocumentType('html', '', '');
                    // ê¸°ì¡´ DOCTYPEì´ ìˆìœ¼ë©´ ì œê±°
                    if (doc.doctype) {
                      doc.removeChild(doc.doctype);
                    }
                    // documentElement ì•ì— DOCTYPE ì‚½ì…
                    if (doc.documentElement) {
                      doc.insertBefore(doctype, doc.documentElement);
                    } else {
                      // documentElementê°€ ì—†ìœ¼ë©´ ì§ì ‘ ì¶”ê°€
                      doc.appendChild(doctype);
                    }
                  } catch (e1) {
                    console.warn('createDocumentType ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‹œë„:', e1);
                    // ë°©ë²• 2: DOMParserë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆ ë¬¸ì„œ ìƒì„±
                    try {
                      const htmlContent = '<!DOCTYPE html>\n' + (doc.documentElement ? doc.documentElement.outerHTML : '');
                      const parser = new DOMParser();
                      const newDoc = parser.parseFromString(htmlContent, 'text/html');
                      if (newDoc.doctype) {
                        // ê¸°ì¡´ DOCTYPE ì œê±° í›„ ìƒˆ DOCTYPE ì¶”ê°€
                        if (doc.doctype) {
                          doc.removeChild(doc.doctype);
                        }
                        if (doc.documentElement) {
                          doc.insertBefore(newDoc.doctype, doc.documentElement);
                        }
                      }
                    } catch (e2) {
                      console.warn('DOMParser ë°©ë²•ë„ ì‹¤íŒ¨:', e2);
                    }
                  }
                }
                // ìµœì¢… í™•ì¸: document.compatModeê°€ 'BackCompat'ì´ë©´ Quirks Mode
                if (doc.compatMode === 'BackCompat') {
                  console.warn('âš ï¸ ë³µì œëœ ë¬¸ì„œê°€ ì—¬ì „íˆ Quirks Modeì…ë‹ˆë‹¤. DOCTYPE:', doc.doctype);
                } else {
                  console.log('âœ… ë³µì œëœ ë¬¸ì„œê°€ Standards Modeë¡œ ë Œë”ë§ë©ë‹ˆë‹¤.');
                }
              } catch (docErr) {
                console.warn('ê°œë³„ ë¬¸ì„œ DOCTYPE ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', docErr);
              }
            });
          } catch (err) {
            console.warn('onclone DOCTYPE ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', err);
          }
          
          // í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš©
          const allElements = clonedDoc.querySelectorAll('*');
          allElements.forEach(el => {
            if (el.style) {
              // img, video, canvas íƒœê·¸ëŠ” overflow: visible ì„¤ì •í•˜ì§€ ì•ŠìŒ (deprecated ê²½ê³  ë°©ì§€)
              const isMediaElement = el.tagName === 'IMG' || el.tagName === 'VIDEO' || el.tagName === 'CANVAS';
              
              el.style.wordWrap = 'break-word';
              el.style.overflowWrap = 'break-word';
              el.style.wordBreak = 'break-word';
              el.style.whiteSpace = 'normal';
              // img/video/canvasëŠ” overflow ì„¤ì •í•˜ì§€ ì•ŠìŒ
              if (!isMediaElement) {
              el.style.overflow = 'visible';
              }
              el.style.textOverflow = 'clip';
            }
          });
        }
      });
      
      // âœ… ì„ì‹œ ì»¨í…Œì´ë„ˆ ì œê±°
      document.body.removeChild(fullReportContainer);
      
      // âœ… ì´ë¯¸ì§€ íŒŒì¼ë¡œ ì €ì¥
      const link = document.createElement('a');
      const centerNameForFile = centerNameDisplay || '';
      const memberNameForFile = memberNameDisplay || 'íšŒì›';
      let imageFileName;
      if(centerNameForFile && memberNameForFile) {
        imageFileName = `${centerNameForFile}_${memberNameForFile}_ìì„¸ë¶„ì„ë¦¬í¬íŠ¸_${new Date().toISOString().split('T')[0]}.png`;
      } else {
        imageFileName = `DIT_ìì„¸_ë¶„ì„_ë¦¬í¬íŠ¸_${cur}_${new Date().toISOString().split('T')[0]}.png`;
      }
      link.download = imageFileName;
      link.href = canvas.toDataURL('image/png');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // âœ… Canvas ë©”ëª¨ë¦¬ ì •ë¦¬
      canvas.width = 1;
      canvas.height = 1;
      
      btn.textContent = originalText || "ğŸ–¼ï¸ ì´ë¯¸ì§€ ì €ì¥";
      btn.disabled = false;
    } catch (error) {
      console.error("ì „ì²´ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:", error);
      alert("ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error?.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
      btn.textContent = originalText || "ğŸ–¼ï¸ ì´ë¯¸ì§€ ì €ì¥";
      btn.disabled = false;
    }
  };
}
// ê³µìœ í•˜ê¸° (Web Share API ì‚¬ìš©)
document.getElementById("btnShare").onclick = async () => {
  try {
    const btn = document.getElementById("btnShare");
    const originalText = btn.textContent;
    btn.textContent = "â³ ì¤€ë¹„ ì¤‘...";
    btn.disabled = true;
    
    const S = sessions[cur];
    const M = S.metrics || {};
    const scoreData = S.score || {};
    const analysis = S.analysis || {};
    
    // ê³µìœ í•  ì´ë¯¸ì§€ ìƒì„± (ê°„ë‹¨í•œ ë²„ì „)
    const cvImg = cv.toDataURL("image/png");
    
    // ê³µìœ í•  í…ìŠ¤íŠ¸ ìƒì„±
    const shareText = `DIT ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸ - ${cur}\n\n` +
      `ğŸ“Š ì²´í˜• ì¢…í•© ì ìˆ˜: ${scoreData.score != null ? scoreData.score : 'â€”'}\n` +
      `ğŸ“ ì¸¡ì • ê°ë„:\n` +
      `  - CVA: ${M.cva != null ? M.cva.toFixed(1) + "Â°" : "â€”"} (ì •ìƒ: â‰¥50Â°)\n` +
      `  - TRUNK: ${M.pelvic != null ? M.pelvic.toFixed(1) + "Â°" : "â€”"} (ì •ìƒ: |0â€“5Â°|)\n` +
      `  - KNEE: ${M.knee != null ? M.knee.toFixed(1) + "Â°" : "â€”"} (ì •ìƒ: 175â€“185Â°)\n\n` +
      `${analysis.comments && Array.isArray(analysis.comments) && analysis.comments.length > 0 ? analysis.comments.join(" ") + "\n\n" : ""}` +
      `${analysis.tight && Array.isArray(analysis.tight) && analysis.tight.length > 0 ? "ğŸ”´ ê¸´ì¥ëœ ê·¼ìœ¡: " + analysis.tight.join(", ") + "\n" : ""}` +
      `${analysis.weak && Array.isArray(analysis.weak) && analysis.weak.length > 0 ? "ğŸ”µ ì•½í™”ëœ ê·¼ìœ¡: " + analysis.weak.join(", ") + "\n" : ""}` +
      `\nâ€» ë³¸ ë¦¬í¬íŠ¸ëŠ” êµìœ¡ìš©ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.`;
    
    // Web Share API ì§€ì› ì—¬ë¶€ í™•ì¸
    if (navigator.share) {
      // ì´ë¯¸ì§€ íŒŒì¼ ìƒì„±
      const response = await fetch(cvImg);
      const blob = await response.blob();
      const file = new File([blob], `DIT_ìì„¸_ë¶„ì„_${cur}_${new Date().toISOString().split('T')[0]}.png`, { type: 'image/png' });
      
      // ê³µìœ  ì‹œë„
      try {
        await navigator.share({
          title: `DIT ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸ - ${cur}`,
          text: shareText,
          files: [file]
        });
        
        btn.textContent = originalText;
        btn.disabled = false;
      } catch (shareError) {
        // ì‚¬ìš©ìê°€ ê³µìœ ë¥¼ ì·¨ì†Œí–ˆê±°ë‚˜ ì—ëŸ¬ ë°œìƒ
        if (shareError.name !== 'AbortError') {
          console.error('ê³µìœ  ì‹¤íŒ¨:', shareError);
          // í´ë°±: ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
          const link = document.createElement('a');
          link.href = cvImg;
          link.download = `DIT_ìì„¸_ë¶„ì„_${cur}_${new Date().toISOString().split('T')[0]}.png`;
          link.style.position = 'fixed';
          link.style.top = '-9999px';
          link.style.left = '-9999px';
          document.body.appendChild(link);
          
          const clickEvent = new MouseEvent('click', {
            view: window,
            bubbles: true,
            cancelable: true
          });
          link.dispatchEvent(clickEvent);
          
          setTimeout(() => {
            if (document.body.contains(link)) {
              document.body.removeChild(link);
            }
          }, 500);
        }
        btn.textContent = originalText;
        btn.disabled = false;
      }
    } else {
      // Web Share APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš°: í´ë¦½ë³´ë“œì— ë³µì‚¬
      try {
        // í…ìŠ¤íŠ¸ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬
        await navigator.clipboard.writeText(shareText);
        
        // ì´ë¯¸ì§€ë„ ë‹¤ìš´ë¡œë“œ
        const link = document.createElement('a');
        link.href = cvImg;
        link.download = `DIT_ìì„¸_ë¶„ì„_${cur}_${new Date().toISOString().split('T')[0]}.png`;
        link.style.position = 'fixed';
        link.style.top = '-9999px';
        link.style.left = '-9999px';
        document.body.appendChild(link);
        
        const clickEvent = new MouseEvent('click', {
          view: window,
          bubbles: true,
          cancelable: true
        });
        link.dispatchEvent(clickEvent);
        
        setTimeout(() => {
          if (document.body.contains(link)) {
            document.body.removeChild(link);
          }
        }, 500);
        
        alert('ë¶„ì„ ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆê³  ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n\në‹¤ë¥¸ ì•±ì— ë¶™ì—¬ë„£ì–´ ê³µìœ í•˜ì„¸ìš”.');
        btn.textContent = originalText;
        btn.disabled = false;
      } catch (clipboardError) {
        console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', clipboardError);
        // ìµœì¢… í´ë°±: ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œë§Œ
        const link = document.createElement('a');
        link.href = cvImg;
        link.download = `DIT_ìì„¸_ë¶„ì„_${cur}_${new Date().toISOString().split('T')[0]}.png`;
        link.style.position = 'fixed';
        link.style.top = '-9999px';
        link.style.left = '-9999px';
        document.body.appendChild(link);
        
        const clickEvent = new MouseEvent('click', {
          view: window,
          bubbles: true,
          cancelable: true
        });
        link.dispatchEvent(clickEvent);
        
        setTimeout(() => {
          if (document.body.contains(link)) {
            document.body.removeChild(link);
          }
        }, 500);
        alert('ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ê³µìœ í•´ì£¼ì„¸ìš”.');
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }
  } catch (error) {
    console.error("ê³µìœ  ì‹¤íŒ¨:", error);
    alert("ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    const btn = document.getElementById("btnShare");
    btn.textContent = "ğŸ“¤ ê³µìœ í•˜ê¸°";
    btn.disabled = false;
  }
};

// ì‹¤ì‹œê°„ ë¶„ì„ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (UI ì—…ë°ì´íŠ¸)
// ì£¼ì„: updateLiveAnalysisUI í•¨ìˆ˜ê°€ í•„ìš”í•  ê²½ìš° ì—¬ê¸°ì— êµ¬í˜„
// liveAnalyzer.addListener((result) => {
//   // UI ì—…ë°ì´íŠ¸ ë¡œì§
//   console.log("ì‹¤ì‹œê°„ ë¶„ì„ ê²°ê³¼:", result);
// });

// â— ì´ˆê¸°í™” ì½”ë“œëŠ” initializeApp í•¨ìˆ˜ ì•ˆì—ì„œ ì‹¤í–‰ë¨
// resizeCanvasFor(null);
// draw();
// computeMetricsOnly();
// updateCompare();
// ìœ„ í•¨ìˆ˜ë“¤ì€ sessions ì´ˆê¸°í™” í›„ ì‹¤í–‰ë˜ì–´ì•¼ í•¨
</script>

<!-- âœ… Pose Detection Libraries -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>

<script>
// í¬ì¦ˆ ê°ì§€ ëª¨ë¸ ê´€ë¦¬
let detectors = { front: null, side: null };

// ì´ˆê¸° orientation ë²„íŠ¼ ìƒíƒœ ì„¤ì • ë° ì¢Œí‘œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
// DOMContentLoaded ì´ë²¤íŠ¸ëŠ” í•¨ìˆ˜ ì •ì˜ ì´í›„ì— ì‹¤í–‰ë˜ë„ë¡ í•¨
let initializeAppCalled = false;

function initializeApp() {
  // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
  if (initializeAppCalled) {
    console.log("ğŸš« initializeAppì´ ì´ë¯¸ í˜¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ì¤‘ë³µ í˜¸ì¶œì„ ë¬´ì‹œí•©ë‹ˆë‹¤.");
    return;
  }
  initializeAppCalled = true;
  
  console.log("=== initializeApp ì‹œì‘ ===");
  
  // sessions ê°ì²´ ì´ˆê¸°í™” (ì•ˆì „í•˜ê²Œ - êµ¬ì¡°ê°€ ì—†ê±°ë‚˜ ë¶ˆì™„ì „í•˜ë©´ ë¬´ì¡°ê±´ ì´ˆê¸°í™”)
  if(typeof window.sessions === 'undefined' || 
     !window.sessions || 
     !window.sessions.Before || 
     !window.sessions.After) {
    console.log("ğŸ”„ sessions ê°ì²´ ì´ˆê¸°í™” ì¤‘...");
    // sessionsë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
    const sessions = {
      Before: {
        imgSide:null,
        imgFront:null,
        sidePoints:new Map(),  // ì¸¡ë©´ í‚¤í¬ì¸íŠ¸ (tragus, c7, acromion, asis, psis, hip, knee, ankle)
        frontPoints:new Map(), // ì •ë©´ í‚¤í¬ì¸íŠ¸ (L_acromion, R_acromion, L_asis, R_asis, L_knee, R_knee, L_ankle, R_ankle)
        metrics:{},
        score:null,
        analysis:null
      },
      After: {
        imgSide:null,
        imgFront:null,
        sidePoints:new Map(),
        frontPoints:new Map(),
        metrics:{},
        score:null,
        analysis:null
      }
    };

    // sessionsë¥¼ windowì— ëª…ì‹œì ìœ¼ë¡œ í• ë‹¹ (ì „ì—­ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
    if(typeof window !== 'undefined') {
      window.sessions = sessions;
      console.log("âœ… sessions ê°ì²´ ì´ˆê¸°í™” ì™„ë£Œ");
    }
  } else {
    console.log("â„¹ï¸ sessions ê°ì²´ê°€ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
  }
  
  // íŒŒì¼ ì—…ë¡œë“œ ì„¤ì • (ê°€ì¥ ë¨¼ì €)
  if(typeof setupFileUploads === 'function') {
    setupFileUploads();
  } else {
    console.error("setupFileUploads í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
  
  // âœ… ëª¨ë“  ì„¤ì • í•¨ìˆ˜ë“¤ì„ ì§€ì—° ì‹¤í–‰ (í•¨ìˆ˜ ì •ì˜ ì™„ë£Œ ëŒ€ê¸°)
  setTimeout(() => {
    // ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
    if(typeof initSessionButtons === 'function') {
      initSessionButtons();
    } else {
      console.error("initSessionButtons í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
  
  // Reset ë²„íŠ¼ ì„¤ì •
  if(typeof setupResetButton === 'function') {
    setupResetButton();
  } else {
    console.error("setupResetButton í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
  
    // âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë²„íŠ¼ë“¤ ì„¤ì •
  if(typeof setupCalibrateButton === 'function') {
    setupCalibrateButton();
  } else {
    console.error("setupCalibrateButton í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
  
  if(typeof setupCalibrationButtons === 'function') {
    setupCalibrationButtons();
  } else {
    console.error("setupCalibrationButtons í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }

    // âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ í´ë¦­ í•¸ë“¤ëŸ¬ ì„¤ì • (cv ìº”ë²„ìŠ¤ê°€ ì¤€ë¹„ëœ í›„)
    if(typeof setupCalibrationClickHandler === 'function') {
      setTimeout(() => {
        setupCalibrationClickHandler();
      }, 200); // cv ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ëŒ€ê¸°
    } else {
      console.error("setupCalibrationClickHandler í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
  
  // PDF ë° ì´ë¯¸ì§€ ì €ì¥ ë²„íŠ¼ ì´ˆê¸°í™”
  if(typeof setupPDFButton === 'function') {
    setupPDFButton();
  } else {
    console.error("setupPDFButton í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
  
  if(typeof setupImageButton === 'function') {
    setupImageButton();
  } else {
    console.error("setupImageButton í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
  }, 100); // ëª¨ë“  í•¨ìˆ˜ë“¤ì´ ì •ì˜ë  ë•Œê¹Œì§€ ëŒ€ê¸°
  
  // AI ë¶„ì„ ë²„íŠ¼ ì´ˆê¸°í™”
  const btnAIAnalysis = document.getElementById("btnAIAnalysis");
  if (btnAIAnalysis) {
    btnAIAnalysis.addEventListener('click', async () => {
      try {
        const originalText = btnAIAnalysis.textContent;
        btnAIAnalysis.textContent = "â³ AI ë¶„ì„ ì¤‘...";
        btnAIAnalysis.disabled = true;
        
        // í˜„ì¬ ì„¸ì…˜ ë°ì´í„° í™•ì¸
        const S = sessions[cur];
        if (!S || (!S.sidePoints || S.sidePoints.size === 0) && (!S.frontPoints || S.frontPoints.size === 0)) {
          alert("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ì¢Œí‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.");
          btnAIAnalysis.textContent = originalText;
          btnAIAnalysis.disabled = false;
          return;
        }
        
        // ì „ì²´ ë¶„ì„ ì‹¤í–‰
        await computeAll();
        
        // ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì˜ì—­ ì—…ë°ì´íŠ¸
        const S2 = sessions[cur];
        if (S2.analysis && S2.score) {
          // scoreê°€ ê°ì²´ì¸ì§€ ìˆ«ìì¸ì§€ í™•ì¸í•˜ì—¬ ì ì ˆíˆ ì „ë‹¬
          const scoreData = typeof S2.score === 'object' && S2.score !== null ? S2.score : { score: S2.score, reasons: [], penalties: 0 };
          updateScoreAndAnalysis(scoreData, S2.metrics?.cva, S2.metrics?.pelvic, S2.metrics?.knee, S2.analysis);
        }
        
        btnAIAnalysis.textContent = "âœ… ë¶„ì„ ì™„ë£Œ";
        setTimeout(() => {
          btnAIAnalysis.textContent = originalText;
          btnAIAnalysis.disabled = false;
        }, 2000);
      } catch (error) {
        console.error("AI ë¶„ì„ ì‹¤íŒ¨:", error);
        alert("AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        const btn = document.getElementById("btnAIAnalysis");
        if (btn) {
          btn.textContent = "ğŸ¤– AI ë¶„ì„";
          btn.disabled = false;
        }
      }
    });
  }

  // ì„¸ì…˜ë³„ í¬ì¦ˆ ì •ë³´ ì €ì¥ (ê¸°ì¡´ sessions ê°ì²´ì™€ í†µí•©)
  // sessions ê°ì²´ì— orientationê³¼ landmarks ì •ë³´ ì¶”ê°€
  if(!window.sessions || !window.sessions.Before || !window.sessions.After) {
    console.warn("âš ï¸ sessions ê°ì²´ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¬ì‹œë„ ì¤‘...");
    // sessions ì¬ì´ˆê¸°í™” ì‹œë„
    if(typeof window !== 'undefined') {
      window.sessions = {
        Before: {
          imgSide:null,
          imgFront:null,
          sidePoints:new Map(),
          frontPoints:new Map(),
          metrics:{},
          score:null,
          analysis:null
        },
        After: {
          imgSide:null,
          imgFront:null,
          sidePoints:new Map(),
          frontPoints:new Map(),
          metrics:{},
          score:null,
          analysis:null
        }
      };
      console.log("âœ… sessions ê°ì²´ ì¬ì´ˆê¸°í™” ì™„ë£Œ");
    } else {
      console.error("âŒ window ê°ì²´ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸°í™”ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.");
    return;
    }
  }
  
  // âœ… Before ì„¸ì…˜ì˜ ë°©í–¥ì„ ì˜†ëª¨ìŠµìœ¼ë¡œ ê°•ì œ ì„¤ì •
  if(!window.sessions.Before.poseData) {
    window.sessions.Before.poseData = { orientation: "side", landmarks: null, orientationMode: "auto" };
  } else {
    // âœ… ê¸°ì¡´ poseDataê°€ ìˆì–´ë„ ë°©í–¥ì„ ì˜†ëª¨ìŠµìœ¼ë¡œ ê°•ì œ ì„¤ì •
    window.sessions.Before.poseData.orientation = "side";
  }
  if(!window.sessions.After.poseData) {
    window.sessions.After.poseData = { orientation: "side", landmarks: null, orientationMode: "auto" };
  }
  
  // orientation ë²„íŠ¼ ìƒíƒœ ì„¤ì •
  const orientation = window.sessions[cur].poseData?.orientation || "side";
  const btnSide = document.getElementById("btnOrientationSide");
  const btnFront = document.getElementById("btnOrientationFront");
  
  if(btnSide && btnFront) {
    btnSide.classList.toggle("active", orientation === "side");
    btnFront.classList.toggle("active", orientation === "front");
    console.log("Orientation ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ ì„¤ì • ì™„ë£Œ:", orientation);
  }
  
  // ì¢Œí‘œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
  updateCoordSelectOptions();
  
  // âœ… ìº”ë²„ìŠ¤ ë° UI ì´ˆê¸° ë Œë”ë§ (sessions ì´ˆê¸°í™” í›„ ì‹¤í–‰)
  try {
    resizeCanvasFor(null);
    draw();
    computeMetricsOnly(); // ì´ˆê¸°í™” ì‹œì—ëŠ” AI ë¶„ì„ ì•ˆ í•¨
    updateCompare();
    console.log("âœ… ì´ˆê¸° ë Œë”ë§ ì™„ë£Œ");
  } catch (err) {
    console.error("ì´ˆê¸° ë Œë”ë§ ì¤‘ ì˜¤ë¥˜:", err);
  }
  
  // ì´ˆê¸° ì‹¤ì‹œê°„ ë¶„ì„ ì‹¤í–‰
  setTimeout(() => {
    if(typeof liveAnalyzer !== 'undefined') {
      liveAnalyzer.analyzeCurrentSession();
    }
  }, 500);
  
  console.log("=== ì´ˆê¸°í™” ì™„ë£Œ ===");
}

// âœ… ëª¨ë¸ ë¡œë“œ ìƒíƒœ ì¶”ì 
let modelsLoading = { front: false, side: false };
let modelsLoaded = { front: false, side: false };

// âœ… ëª¨ë¸ ë¡œë“œ (ì •ë©´: BlazePose, ì˜†ëª¨ìŠµ: BlazePose) - ì •ë©´ë„ BlazePose ì‚¬ìš©ìœ¼ë¡œ ì •êµí•œ ë§¤í•‘
async function loadPoseModels() {
  try {
    // ì •ë©´ ëª¨ë¸ ë¡œë“œ (BlazePose ì‚¬ìš© - 33ê°œ ëœë“œë§ˆí¬ë¡œ ë” ì •êµí•œ ê´€ì ˆ ì¸ì‹)
    if (!modelsLoading.front && !modelsLoaded.front) {
      modelsLoading.front = true;
    detectors.front = await poseDetection.createDetector(
        poseDetection.SupportedModels.BlazePose,
        { runtime: "tfjs", modelType: "full", enableSmoothing: true }
    );
      modelsLoaded.front = true;
      modelsLoading.front = false;
      console.log("âœ… ì •ë©´ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ (BlazePose)");
    }
    
    // ì˜†ëª¨ìŠµ ëª¨ë¸ ë¡œë“œ
    if (!modelsLoading.side && !modelsLoaded.side) {
      modelsLoading.side = true;
    detectors.side = await poseDetection.createDetector(
      poseDetection.SupportedModels.BlazePose,
      { runtime: "tfjs", modelType: "full", enableSmoothing: true }
    );
      modelsLoaded.side = true;
      modelsLoading.side = false;
      console.log("âœ… ì˜†ëª¨ìŠµ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ");
    }
    
    console.log("âœ… ì •ë©´Â·ì˜†ëª¨ìŠµ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ (ëª¨ë‘ BlazePose)");
  } catch(error) {
    console.error("ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨:", error);
    modelsLoading.front = false;
    modelsLoading.side = false;
  }
}

loadPoseModels();

// âœ… ë¶„ì„ ì‹œ orientationì— ë§ëŠ” ëª¨ë¸ ì‚¬ìš©
async function detectPose(img, orientation) {
  // ëª¨ë¸ì´ ë¡œë“œ ì¤‘ì´ë©´ ê¸°ë‹¤ë¦¼
  let waitCount = 0;
  const maxWait = 50; // ìµœëŒ€ 5ì´ˆ ëŒ€ê¸° (100ms * 50)
  
  while (!modelsLoaded[orientation] && !detectors[orientation] && waitCount < maxWait) {
    if (!modelsLoading[orientation]) {
      // ëª¨ë¸ ë¡œë“œê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‹œì‘
      await loadPoseModels();
    }
    await new Promise(resolve => setTimeout(resolve, 100)); // 100ms ëŒ€ê¸°
    waitCount++;
  }
  
  const detector = detectors[orientation];
  if (!detector) {
    // ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
    console.log(`${orientation} ëª¨ë¸ ì¬ì‹œë„ ì¤‘...`);
    await loadPoseModels();
    
    if (!detectors[orientation]) {
      alert(`${orientation}ìš© ëª¨ë¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.`);
    return null;
    }
  }
  
  try {
    const poses = await detector.estimatePoses(img);
    if (!poses.length) {
      alert(`${orientation} ë°©í–¥ì—ì„œ ì‚¬ëŒì„ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤`);
      return null;
    }
    return poses[0];
  } catch(error) {
    console.error("í¬ì¦ˆ ê°ì§€ ì‹¤íŒ¨:", error);
    alert("í¬ì¦ˆ ê°ì§€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
    return null;
  }
}

// âœ… í¬ì¦ˆ ì¢Œí‘œë¥¼ ê¸°ì¡´ ì  ì‹œìŠ¤í…œì— ë§¤í•‘ (MediaPipe Pose ëœë“œë§ˆí¬ ì¸ë±ìŠ¤ ê¸°ë°˜)
function getKeypointConfidence(kp) {
  if (!kp) return 0;
  if (typeof kp.score === 'number' && !Number.isNaN(kp.score)) return kp.score;
  if (typeof kp.visibility === 'number' && !Number.isNaN(kp.visibility)) return kp.visibility;
  return 0;
}

function inferOrientationFromPose(pose) {
  if (!pose || !pose.keypoints) return "side";
  const keypoints = pose.keypoints;
  const pairs = [
    [11, 12], // shoulders
    [23, 24], // hips
    [25, 26], // knees
    [27, 28], // ankles
    [13, 14]  // elbows
  ];
  let frontScore = 0;
  let visiblePairs = 0;
  pairs.forEach(([l, r]) => {
    const L = keypoints[l];
    const R = keypoints[r];
    if (getKeypointConfidence(L) >= 0.3 && getKeypointConfidence(R) >= 0.3) {
      visiblePairs++;
      const diff = Math.abs(L.x - R.x);
      if (diff >= 0.03) {
        frontScore++;
      }
    }
  });
  if (frontScore >= 2 || (frontScore >= 1 && visiblePairs >= 3)) {
    return "front";
  }
  return "side";
}

function mapPoseToKeypoints(pose, orientation) {
  if(!pose || !pose.keypoints) return null;
  
  const keypointMap = {};
  const keypoints = pose.keypoints;
  
  // MediaPipe PoseëŠ” 33ê°œ ëœë“œë§ˆí¬ ì œê³µ (ì¸ë±ìŠ¤ ê¸°ë°˜)
  // 0: nose, 7: left_ear, 8: right_ear, 11: left_shoulder, 12: right_shoulder
  // 23: left_hip, 24: right_hip, 25: left_knee, 26: right_knee
  // 27: left_ankle, 28: right_ankle
  
  if(orientation === "side") {
    // ì˜†ëª¨ìŠµ: ë³´ì´ëŠ” ìª½ì˜ ëœë“œë§ˆí¬ ì‚¬ìš© (confidence ë†’ì€ ìª½ ì„ íƒ)
    const leftEar = keypoints[7];
    const rightEar = keypoints[8];
    const leftShoulder = keypoints[11];
    const rightShoulder = keypoints[12];
    const leftHip = keypoints[23];
    const rightHip = keypoints[24];
    const leftKnee = keypoints[25];
    const rightKnee = keypoints[26];
    const leftAnkle = keypoints[27];
    const rightAnkle = keypoints[28];
    const nose = keypoints[0];
    
    // ì–´ëŠ ìª½ì´ ë” ë³´ì´ëŠ”ì§€ íŒë‹¨ (x ì¢Œí‘œê°€ ë” ì‘ê±°ë‚˜ í° ìª½)
    let useLeft = true;
    if(leftShoulder && rightShoulder) {
      // ì–´ê¹¨ì˜ x ì°¨ì´ë¡œ íŒë‹¨ (ì˜†ëª¨ìŠµì—ì„œëŠ” í•œìª½ì´ ë” ì•ì— ë‚˜ì™€ ìˆìŒ)
    const leftScore = getKeypointConfidence(leftShoulder) + getKeypointConfidence(leftHip) + getKeypointConfidence(leftKnee);
    const rightScore = getKeypointConfidence(rightShoulder) + getKeypointConfidence(rightHip) + getKeypointConfidence(rightKnee);
      useLeft = leftScore >= rightScore;
    } else if(leftShoulder) {
      useLeft = true;
    } else if(rightShoulder) {
      useLeft = false;
    }
    
    console.log('ì˜†ëª¨ìŠµ ê°ì§€:', useLeft ? 'ì™¼ìª½ ì‚¬ìš©' : 'ì˜¤ë¥¸ìª½ ì‚¬ìš©');
    
    // visibility ì„ê³„ê°’ì„ ë” ë‚®ì¶°ì„œ ë” ë§ì€ ëœë“œë§ˆí¬ë¥¼ ë§¤í•‘ (0.2 -> 0.1)
    const minVisibility = 0.1;
    
    // tragus: ear (ë” ë³´ì´ëŠ” ìª½) - Flutter 1:1 ë§¤ì¹­
    const ear = useLeft ? leftEar : rightEar;
    if(ear && getKeypointConfidence(ear) >= minVisibility) {
      keypointMap['tragus'] = { x: ear.x, y: ear.y, score: getKeypointConfidence(ear) || 0.5 };
    } else if(nose && getKeypointConfidence(nose) >= minVisibility) {
      // earê°€ ì•ˆ ë³´ì´ë©´ nose ì‚¬ìš©
      keypointMap['tragus'] = { x: nose.x, y: nose.y + 0.03, score: (getKeypointConfidence(nose) || 0.5) * 0.8 };
    }
    
    // acromion: ì–´ê¹¨ (ë” ë³´ì´ëŠ” ìª½) - Flutter 1:1 ë§¤ì¹­
    const shoulder = useLeft ? leftShoulder : rightShoulder;
    if(shoulder && getKeypointConfidence(shoulder) >= minVisibility) {
      const shoulderConf = getKeypointConfidence(shoulder) || 0.5;
      keypointMap['acromion'] = { x: shoulder.x, y: shoulder.y, score: shoulderConf };
      console.log(`âœ… acromion ë§¤í•‘: (${shoulder.x.toFixed(3)}, ${shoulder.y.toFixed(3)}), score: ${shoulderConf.toFixed(2)}`);
      
      // c7: ì–´ê¹¨ë³´ë‹¤ ì•½ê°„ ìœ„/ë’¤ - Flutter 1:1 ë§¤ì¹­
      const c7Score = shoulderConf * 0.9;
      keypointMap['c7'] = { 
        x: shoulder.x - 0.02, // ì–´ê¹¨ë³´ë‹¤ ì•½ê°„ ë’¤
        y: shoulder.y - 0.03, // ì–´ê¹¨ë³´ë‹¤ ì•½ê°„ ìœ„
        score: c7Score
      };
      console.log(`âœ… c7 ë§¤í•‘: (${keypointMap['c7'].x.toFixed(3)}, ${keypointMap['c7'].y.toFixed(3)}), score: ${c7Score.toFixed(2)}`);
    } else {
      console.warn(`âš ï¸ shoulder ê°ì§€ ì‹¤íŒ¨: useLeft=${useLeft}, leftConf=${getKeypointConfidence(leftShoulder).toFixed(2)}, rightConf=${getKeypointConfidence(rightShoulder).toFixed(2)}`);
    }
    
    // hip: ê³¨ë°˜ (ë” ë³´ì´ëŠ” ìª½) - Flutter 1:1 ë§¤ì¹­
    const hip = useLeft ? leftHip : rightHip;
    if(hip && getKeypointConfidence(hip) >= minVisibility) {
      const hipConf = getKeypointConfidence(hip) || 0.5;
      keypointMap['hip'] = { x: hip.x, y: hip.y, score: hipConf };
      console.log(`âœ… hip ë§¤í•‘: (${hip.x.toFixed(3)}, ${hip.y.toFixed(3)}), score: ${hipConf.toFixed(2)}`);
      
      // asis: hipë³´ë‹¤ ì•½ê°„ ì•/ìœ„ - ë…ë¦½ì ìœ¼ë¡œ í‘œì‹œ
      const asisScore = hipConf * 0.85;
      keypointMap['asis'] = { 
        x: hip.x + 0.03, // ì•ìª½
        y: hip.y - 0.01, // ì•½ê°„ ìœ„
        score: asisScore
      };
      console.log(`âœ… asis ë§¤í•‘ (ë…ë¦½): (${keypointMap['asis'].x.toFixed(3)}, ${keypointMap['asis'].y.toFixed(3)}), score: ${asisScore.toFixed(2)}`);
      
      // psis: hipë³´ë‹¤ ì•½ê°„ ë’¤ - ë…ë¦½ì ìœ¼ë¡œ í‘œì‹œ
      const psisScore = hipConf * 0.85;
      keypointMap['psis'] = { 
        x: hip.x - 0.03, // ë’¤ìª½
        y: hip.y - 0.01, // ì•½ê°„ ìœ„
        score: psisScore
      };
      console.log(`âœ… psis ë§¤í•‘ (ë…ë¦½): (${keypointMap['psis'].x.toFixed(3)}, ${keypointMap['psis'].y.toFixed(3)}), score: ${psisScore.toFixed(2)}`);
    } else {
      console.warn(`âš ï¸ hip ê°ì§€ ì‹¤íŒ¨: useLeft=${useLeft}, leftHipConf=${getKeypointConfidence(leftHip).toFixed(2)}, rightHipConf=${getKeypointConfidence(rightHip).toFixed(2)}`);
    }
    
    // knee: ë¬´ë¦ (ë” ë³´ì´ëŠ” ìª½) - Flutter 1:1 ë§¤ì¹­
    const knee = useLeft ? leftKnee : rightKnee;
    if(knee && getKeypointConfidence(knee) >= minVisibility) {
      keypointMap['knee'] = { x: knee.x, y: knee.y, score: getKeypointConfidence(knee) || 0.5 };
    }
    
    // ankle: ë°œëª© (ë” ë³´ì´ëŠ” ìª½) - Flutter 1:1 ë§¤ì¹­
    const ankle = useLeft ? leftAnkle : rightAnkle;
    if(ankle && getKeypointConfidence(ankle) >= minVisibility) {
      keypointMap['ankle'] = { x: ankle.x, y: ankle.y, score: getKeypointConfidence(ankle) || 0.5 };
    }
    
    console.log('ì˜†ëª¨ìŠµ ëœë“œë§ˆí¬ ë§¤í•‘:', Object.keys(keypointMap));
  }
  
  if(orientation === "front") {
    // ì •ë©´: ì–‘ìª½ ëª¨ë‘ í‘œì‹œ (í™˜ì ì¢Œ/ìš° ì¸ì‹)
    // âœ… BlazePoseëŠ” 33ê°œ ëœë“œë§ˆí¬ ì œê³µ (MediaPipe Pose ì¸ë±ìŠ¤)
    // MediaPipe Pose ì¸ë±ìŠ¤:
    // 0: nose
    // 7: left_ear, 8: right_ear
    // 11: left_shoulder, 12: right_shoulder
    // 23: left_hip, 24: right_hip
    // 25: left_knee, 26: right_knee
    // 27: left_ankle, 28: right_ankle
    const leftEar = keypoints[7];
    const rightEar = keypoints[8];
    const leftShoulder = keypoints[11];   // BlazePose: left_shoulder (í™˜ì ì™¼ìª½)
    const rightShoulder = keypoints[12]; // BlazePose: right_shoulder (í™˜ì ì˜¤ë¥¸ìª½)
    const leftHip = keypoints[23];   // BlazePose: left_hip (í™˜ì ì™¼ìª½)
    const rightHip = keypoints[24]; // BlazePose: right_hip (í™˜ì ì˜¤ë¥¸ìª½)
    const leftKnee = keypoints[25];   // BlazePose: left_knee (í™˜ì ì™¼ìª½)
    const rightKnee = keypoints[26]; // BlazePose: right_knee (í™˜ì ì˜¤ë¥¸ìª½)
    const leftAnkle = keypoints[27];   // BlazePose: left_ankle (í™˜ì ì™¼ìª½)
    const rightAnkle = keypoints[28]; // BlazePose: right_ankle (í™˜ì ì˜¤ë¥¸ìª½)
    const nose = keypoints[0];
    
    // ë””ë²„ê¹…: keypoints ë°°ì—´ ìƒíƒœ í™•ì¸ (BlazePose ì¸ë±ìŠ¤)
    console.log(`ğŸ” ì •ë©´ keypoints ë””ë²„ê¹… (BlazePose): ì´ ${keypoints.length}ê°œ`);
    console.log(`ğŸ” keypoints[11] (leftShoulder):`, leftShoulder ? `ì¡´ì¬ (x=${leftShoulder.x?.toFixed(3)}, y=${leftShoulder.y?.toFixed(3)})` : 'null');
    console.log(`ğŸ” keypoints[12] (rightShoulder):`, rightShoulder ? `ì¡´ì¬ (x=${rightShoulder.x?.toFixed(3)}, y=${rightShoulder.y?.toFixed(3)})` : 'null');
    console.log(`ğŸ” keypoints[23] (leftHip):`, leftHip ? `ì¡´ì¬ (x=${leftHip.x?.toFixed(3)}, y=${leftHip.y?.toFixed(3)})` : 'null');
    console.log(`ğŸ” keypoints[24] (rightHip):`, rightHip ? `ì¡´ì¬ (x=${rightHip.x?.toFixed(3)}, y=${rightHip.y?.toFixed(3)})` : 'null');
    console.log(`ğŸ” keypoints[25] (leftKnee):`, leftKnee ? `ì¡´ì¬ (x=${leftKnee.x?.toFixed(3)}, y=${leftKnee.y?.toFixed(3)})` : 'null');
    console.log(`ğŸ” keypoints[26] (rightKnee):`, rightKnee ? `ì¡´ì¬ (x=${rightKnee.x?.toFixed(3)}, y=${rightKnee.y?.toFixed(3)})` : 'null');
    console.log(`ğŸ” keypoints[27] (leftAnkle):`, leftAnkle ? `ì¡´ì¬ (x=${leftAnkle.x?.toFixed(3)}, y=${leftAnkle.y?.toFixed(3)})` : 'null');
    console.log(`ğŸ” keypoints[28] (rightAnkle):`, rightAnkle ? `ì¡´ì¬ (x=${rightAnkle.x?.toFixed(3)}, y=${rightAnkle.y?.toFixed(3)})` : 'null');
    
    // visibility ì„ê³„ê°’ì„ ë” ë‚®ì¶°ì„œ ë” ë§ì€ ëœë“œë§ˆí¬ë¥¼ ë§¤í•‘ (ì¸¡ë©´ì²˜ëŸ¼ ì˜ˆë¯¼í•˜ê²Œ)
    const minVisibility = 0.1;
    
    // ì¢Œí‘œ ë³€í™˜ í•¨ìˆ˜: BlazePose ì¢Œí‘œë¥¼ ì´ë¯¸ì§€ í”½ì…€ ì¢Œí‘œë¡œ ë³€í™˜
    const makePoint = (kp, label = '') => {
      if (!kp || kp.x === undefined || kp.y === undefined) {
        return null;
      }
      const confidence = getKeypointConfidence(kp);
      
      // âœ… confidence ì„ê³„ê°’ì„ ë” ë‚®ì¶°ì„œ ë” ë§ì€ ëœë“œë§ˆí¬ë¥¼ ë§¤í•‘ (ì¸¡ë©´ì²˜ëŸ¼ ì˜ˆë¯¼í•˜ê²Œ)
      if (confidence < minVisibility) {
        return null;
      }
      
      return { x: kp.x, y: kp.y, score: confidence || 0.5 };
    };
    
    // ì •ë©´ ë§¤í•‘: í™”ë©´ ì™¼ìª½ â†’ í™˜ì ì™¼ìª½ â†’ L_*, í™”ë©´ ì˜¤ë¥¸ìª½ â†’ í™˜ì ì˜¤ë¥¸ìª½ â†’ R_*
    // BlazePose: keypoints[11] = left_shoulder (í™˜ì ì™¼ìª½), keypoints[12] = right_shoulder (í™˜ì ì˜¤ë¥¸ìª½)
    
    // L_acromion: ì™¼ìª½ ì–´ê¹¨
    if (leftShoulder && getKeypointConfidence(leftShoulder) >= minVisibility) {
      keypointMap['L_acromion'] = { x: leftShoulder.x, y: leftShoulder.y, score: getKeypointConfidence(leftShoulder) || 0.5 };
      console.log(`âœ… L_acromion ë§¤í•‘ (í™”ë©´ ì™¼ìª½ â†’ í™˜ì ì™¼ìª½): (${leftShoulder.x.toFixed(3)}, ${leftShoulder.y.toFixed(3)}), score: ${keypointMap['L_acromion'].score.toFixed(2)}`);
    }
    
    // R_acromion: ì˜¤ë¥¸ìª½ ì–´ê¹¨
    if (rightShoulder && getKeypointConfidence(rightShoulder) >= minVisibility) {
      keypointMap['R_acromion'] = { x: rightShoulder.x, y: rightShoulder.y, score: getKeypointConfidence(rightShoulder) || 0.5 };
      console.log(`âœ… R_acromion ë§¤í•‘ (í™”ë©´ ì˜¤ë¥¸ìª½ â†’ í™˜ì ì˜¤ë¥¸ìª½): (${rightShoulder.x.toFixed(3)}, ${rightShoulder.y.toFixed(3)}), score: ${keypointMap['R_acromion'].score.toFixed(2)}`);
    }
    
    // L_tragus, R_tragus: BlazePoseì˜ ê·€ ëœë“œë§ˆí¬ ì‚¬ìš©
    // BlazePose: keypoints[7] = left_ear, keypoints[8] = right_ear
    if (leftEar && getKeypointConfidence(leftEar) >= minVisibility) {
      keypointMap['L_tragus'] = { x: leftEar.x, y: leftEar.y, score: getKeypointConfidence(leftEar) || 0.5 };
      console.log(`âœ… L_tragus ë§¤í•‘ (ì™¼ìª½ ê·€): (${leftEar.x.toFixed(3)}, ${leftEar.y.toFixed(3)}), score: ${keypointMap['L_tragus'].score.toFixed(2)}`);
    } else if (nose && getKeypointConfidence(nose) >= minVisibility) {
      // ê·€ê°€ ì•ˆ ë³´ì´ë©´ ì½” ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
      keypointMap['L_tragus'] = { x: nose.x - 0.02, y: nose.y, score: (getKeypointConfidence(nose) || 0.5) * 0.8 };
      console.log(`âœ… L_tragus ì¶”ì • (nose ê¸°ì¤€): (${keypointMap['L_tragus'].x.toFixed(3)}, ${keypointMap['L_tragus'].y.toFixed(3)})`);
    }
    
    if (rightEar && getKeypointConfidence(rightEar) >= minVisibility) {
      keypointMap['R_tragus'] = { x: rightEar.x, y: rightEar.y, score: getKeypointConfidence(rightEar) || 0.5 };
      console.log(`âœ… R_tragus ë§¤í•‘ (ì˜¤ë¥¸ìª½ ê·€): (${rightEar.x.toFixed(3)}, ${rightEar.y.toFixed(3)}), score: ${keypointMap['R_tragus'].score.toFixed(2)}`);
    } else if (nose && getKeypointConfidence(nose) >= minVisibility) {
      // ê·€ê°€ ì•ˆ ë³´ì´ë©´ ì½” ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
      keypointMap['R_tragus'] = { x: nose.x + 0.02, y: nose.y, score: (getKeypointConfidence(nose) || 0.5) * 0.8 };
      console.log(`âœ… R_tragus ì¶”ì • (nose ê¸°ì¤€): (${keypointMap['R_tragus'].x.toFixed(3)}, ${keypointMap['R_tragus'].y.toFixed(3)})`);
    }
    
    // c7: ì–‘ìª½ ì–´ê¹¨ ì¤‘ê°„ (ëª© ì•„ë˜)
    if(keypointMap['R_acromion'] && keypointMap['L_acromion']) {
      const avgShoulderY = (keypointMap['R_acromion'].y + keypointMap['L_acromion'].y) / 2;
      const c7Offset = avgShoulderY < 1 ? 0.08 : (avgShoulderY * 0.1);
      keypointMap['c7'] = {
        x: (keypointMap['R_acromion'].x + keypointMap['L_acromion'].x) / 2,
        y: avgShoulderY - c7Offset,
        score: Math.min(keypointMap['R_acromion'].score, keypointMap['L_acromion'].score)
      };
      console.log(`âœ… c7 ë§¤í•‘ (ì–‘ìª½ ì–´ê¹¨ ì¤‘ê°„): (${keypointMap['c7'].x.toFixed(3)}, ${keypointMap['c7'].y.toFixed(3)}), score: ${keypointMap['c7'].score.toFixed(2)}`);
    } else if(keypointMap['R_acromion']) {
      const c7Offset = keypointMap['R_acromion'].y < 1 ? 0.08 : (keypointMap['R_acromion'].y * 0.1);
      keypointMap['c7'] = {
        x: keypointMap['R_acromion'].x,
        y: keypointMap['R_acromion'].y - c7Offset,
        score: keypointMap['R_acromion'].score * 0.8
      };
      console.log(`âœ… c7 ë§¤í•‘ (R_acromion ê¸°ì¤€): (${keypointMap['c7'].x.toFixed(3)}, ${keypointMap['c7'].y.toFixed(3)})`);
    } else if(keypointMap['L_acromion']) {
      const c7Offset = keypointMap['L_acromion'].y < 1 ? 0.08 : (keypointMap['L_acromion'].y * 0.1);
      keypointMap['c7'] = {
        x: keypointMap['L_acromion'].x,
        y: keypointMap['L_acromion'].y - c7Offset,
        score: keypointMap['L_acromion'].score * 0.8
      };
      console.log(`âœ… c7 ë§¤í•‘ (L_acromion ê¸°ì¤€): (${keypointMap['c7'].x.toFixed(3)}, ${keypointMap['c7'].y.toFixed(3)})`);
    }
    
    // L_asis, R_asis: BlazePoseì˜ ê³¨ë°˜ ëœë“œë§ˆí¬ ì‚¬ìš©
    // BlazePose: keypoints[23] = left_hip, keypoints[24] = right_hip
    if (leftHip && getKeypointConfidence(leftHip) >= minVisibility) {
      keypointMap['L_asis'] = { x: leftHip.x, y: leftHip.y, score: getKeypointConfidence(leftHip) || 0.5 };
      console.log(`âœ… L_asis ë§¤í•‘ (í™”ë©´ ì™¼ìª½ â†’ í™˜ì ì™¼ìª½): (${leftHip.x.toFixed(3)}, ${leftHip.y.toFixed(3)}), score: ${keypointMap['L_asis'].score.toFixed(2)}`);
    } else if (keypointMap['L_acromion']) {
      // ê³¨ë°˜ì´ ì—†ìœ¼ë©´ ì–´ê¹¨ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
      const shoulderY = keypointMap['L_acromion'].y;
      const hipOffset = shoulderY < 1 ? 0.25 : (shoulderY * 0.3);
      keypointMap['L_asis'] = {
        x: keypointMap['L_acromion'].x,
        y: shoulderY + hipOffset,
        score: keypointMap['L_acromion'].score * 0.7
      };
      console.log(`âœ… L_asis ì¶”ì • (L_acromion ê¸°ì¤€): (${keypointMap['L_asis'].x.toFixed(3)}, ${keypointMap['L_asis'].y.toFixed(3)})`);
    }
    
    if (rightHip && getKeypointConfidence(rightHip) >= minVisibility) {
      keypointMap['R_asis'] = { x: rightHip.x, y: rightHip.y, score: getKeypointConfidence(rightHip) || 0.5 };
      console.log(`âœ… R_asis ë§¤í•‘ (í™”ë©´ ì˜¤ë¥¸ìª½ â†’ í™˜ì ì˜¤ë¥¸ìª½): (${rightHip.x.toFixed(3)}, ${rightHip.y.toFixed(3)}), score: ${keypointMap['R_asis'].score.toFixed(2)}`);
    } else if (keypointMap['R_acromion']) {
      // ê³¨ë°˜ì´ ì—†ìœ¼ë©´ ì–´ê¹¨ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
      const shoulderY = keypointMap['R_acromion'].y;
      const hipOffset = shoulderY < 1 ? 0.25 : (shoulderY * 0.3);
      keypointMap['R_asis'] = {
        x: keypointMap['R_acromion'].x,
        y: shoulderY + hipOffset,
        score: keypointMap['R_acromion'].score * 0.7
      };
      console.log(`âœ… R_asis ì¶”ì • (R_acromion ê¸°ì¤€): (${keypointMap['R_asis'].x.toFixed(3)}, ${keypointMap['R_asis'].y.toFixed(3)})`);
    }
    
    // L_knee, R_knee: BlazePoseì˜ ë¬´ë¦ ëœë“œë§ˆí¬ ì‚¬ìš©
    // BlazePose: keypoints[25] = left_knee, keypoints[26] = right_knee
    if (leftKnee && getKeypointConfidence(leftKnee) >= minVisibility) {
      keypointMap['L_knee'] = { x: leftKnee.x, y: leftKnee.y, score: getKeypointConfidence(leftKnee) || 0.5 };
      console.log(`âœ… L_knee ë§¤í•‘ (í™”ë©´ ì™¼ìª½ â†’ í™˜ì ì™¼ìª½): (${leftKnee.x.toFixed(3)}, ${leftKnee.y.toFixed(3)}), score: ${keypointMap['L_knee'].score.toFixed(2)}`);
    } else if (keypointMap['L_asis']) {
      // ë¬´ë¦ì´ ì—†ìœ¼ë©´ ê³¨ë°˜ì„ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
      const hipY = keypointMap['L_asis'].y;
      const kneeOffset = hipY < 1 ? 0.30 : (hipY * 0.35);
      keypointMap['L_knee'] = {
        x: keypointMap['L_asis'].x,
        y: hipY + kneeOffset,
        score: keypointMap['L_asis'].score * 0.7
      };
      console.log(`âœ… L_knee ì¶”ì • (L_asis ê¸°ì¤€): (${keypointMap['L_knee'].x.toFixed(3)}, ${keypointMap['L_knee'].y.toFixed(3)})`);
    } else if (keypointMap['L_acromion']) {
      // ê³¨ë°˜ë„ ì—†ìœ¼ë©´ ì–´ê¹¨ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
      const shoulderY = keypointMap['L_acromion'].y;
      const kneeOffset = shoulderY < 1 ? 0.50 : (shoulderY * 0.55);
      keypointMap['L_knee'] = {
        x: keypointMap['L_acromion'].x,
        y: shoulderY + kneeOffset,
        score: keypointMap['L_acromion'].score * 0.6
      };
      console.log(`âœ… L_knee ì¶”ì • (L_acromion ê¸°ì¤€): (${keypointMap['L_knee'].x.toFixed(3)}, ${keypointMap['L_knee'].y.toFixed(3)})`);
    }
    
    if (rightKnee && getKeypointConfidence(rightKnee) >= minVisibility) {
      keypointMap['R_knee'] = { x: rightKnee.x, y: rightKnee.y, score: getKeypointConfidence(rightKnee) || 0.5 };
      console.log(`âœ… R_knee ë§¤í•‘ (í™”ë©´ ì˜¤ë¥¸ìª½ â†’ í™˜ì ì˜¤ë¥¸ìª½): (${rightKnee.x.toFixed(3)}, ${rightKnee.y.toFixed(3)}), score: ${keypointMap['R_knee'].score.toFixed(2)}`);
    } else if (keypointMap['R_asis']) {
      // ë¬´ë¦ì´ ì—†ìœ¼ë©´ ê³¨ë°˜ì„ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
      const hipY = keypointMap['R_asis'].y;
      const kneeOffset = hipY < 1 ? 0.30 : (hipY * 0.35);
      keypointMap['R_knee'] = {
        x: keypointMap['R_asis'].x,
        y: hipY + kneeOffset,
        score: keypointMap['R_asis'].score * 0.7
      };
      console.log(`âœ… R_knee ì¶”ì • (R_asis ê¸°ì¤€): (${keypointMap['R_knee'].x.toFixed(3)}, ${keypointMap['R_knee'].y.toFixed(3)})`);
    } else if (keypointMap['R_acromion']) {
      // ê³¨ë°˜ë„ ì—†ìœ¼ë©´ ì–´ê¹¨ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
      const shoulderY = keypointMap['R_acromion'].y;
      const kneeOffset = shoulderY < 1 ? 0.50 : (shoulderY * 0.55);
      keypointMap['R_knee'] = {
        x: keypointMap['R_acromion'].x,
        y: shoulderY + kneeOffset,
        score: keypointMap['R_acromion'].score * 0.6
      };
      console.log(`âœ… R_knee ì¶”ì • (R_acromion ê¸°ì¤€): (${keypointMap['R_knee'].x.toFixed(3)}, ${keypointMap['R_knee'].y.toFixed(3)})`);
    }
    
    // L_ankle, R_ankle: BlazePoseì˜ ë°œëª© ëœë“œë§ˆí¬ ì‚¬ìš©
    // BlazePose: keypoints[27] = left_ankle, keypoints[28] = right_ankle
    if (leftAnkle && getKeypointConfidence(leftAnkle) >= minVisibility) {
      keypointMap['L_ankle'] = { x: leftAnkle.x, y: leftAnkle.y, score: getKeypointConfidence(leftAnkle) || 0.5 };
      console.log(`âœ… L_ankle ë§¤í•‘ (í™”ë©´ ì™¼ìª½ â†’ í™˜ì ì™¼ìª½): (${leftAnkle.x.toFixed(3)}, ${leftAnkle.y.toFixed(3)}), score: ${keypointMap['L_ankle'].score.toFixed(2)}`);
    } else if (keypointMap['L_knee']) {
      // ë°œëª©ì´ ì—†ìœ¼ë©´ ë¬´ë¦ì„ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
        const kneeY = keypointMap['L_knee'].y;
        const ankleOffset = kneeY < 1 ? 0.30 : (kneeY * 0.35);
        keypointMap['L_ankle'] = {
          x: keypointMap['L_knee'].x,
          y: kneeY + ankleOffset,
          score: keypointMap['L_knee'].score * 0.7
        };
        console.log(`âœ… L_ankle ì¶”ì • (L_knee ê¸°ì¤€): (${keypointMap['L_ankle'].x.toFixed(3)}, ${keypointMap['L_ankle'].y.toFixed(3)})`);
      } else if (keypointMap['L_asis']) {
      // ë¬´ë¦ë„ ì—†ìœ¼ë©´ ê³¨ë°˜ì„ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
        const hipY = keypointMap['L_asis'].y;
        const ankleOffset = hipY < 1 ? 0.60 : (hipY * 0.65);
        keypointMap['L_ankle'] = {
          x: keypointMap['L_asis'].x,
          y: hipY + ankleOffset,
          score: keypointMap['L_asis'].score * 0.6
        };
        console.log(`âœ… L_ankle ì¶”ì • (L_asis ê¸°ì¤€): (${keypointMap['L_ankle'].x.toFixed(3)}, ${keypointMap['L_ankle'].y.toFixed(3)})`);
      } else if (keypointMap['L_acromion']) {
        // ê³¨ë°˜ë„ ì—†ìœ¼ë©´ ì–´ê¹¨ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
        const shoulderY = keypointMap['L_acromion'].y;
        const ankleOffset = shoulderY < 1 ? 0.75 : (shoulderY * 0.80);
        keypointMap['L_ankle'] = {
          x: keypointMap['L_acromion'].x,
          y: shoulderY + ankleOffset,
          score: keypointMap['L_acromion'].score * 0.5
        };
        console.log(`âœ… L_ankle ì¶”ì • (L_acromion ê¸°ì¤€): (${keypointMap['L_ankle'].x.toFixed(3)}, ${keypointMap['L_ankle'].y.toFixed(3)})`);
    }
    
    if (rightAnkle && getKeypointConfidence(rightAnkle) >= minVisibility) {
      keypointMap['R_ankle'] = { x: rightAnkle.x, y: rightAnkle.y, score: getKeypointConfidence(rightAnkle) || 0.5 };
      console.log(`âœ… R_ankle ë§¤í•‘ (í™”ë©´ ì˜¤ë¥¸ìª½ â†’ í™˜ì ì˜¤ë¥¸ìª½): (${rightAnkle.x.toFixed(3)}, ${rightAnkle.y.toFixed(3)}), score: ${keypointMap['R_ankle'].score.toFixed(2)}`);
    } else if (keypointMap['R_knee']) {
      // ë°œëª©ì´ ì—†ìœ¼ë©´ ë¬´ë¦ì„ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
        const kneeY = keypointMap['R_knee'].y;
        const ankleOffset = kneeY < 1 ? 0.30 : (kneeY * 0.35);
        keypointMap['R_ankle'] = {
          x: keypointMap['R_knee'].x,
          y: kneeY + ankleOffset,
          score: keypointMap['R_knee'].score * 0.7
        };
        console.log(`âœ… R_ankle ì¶”ì • (R_knee ê¸°ì¤€): (${keypointMap['R_ankle'].x.toFixed(3)}, ${keypointMap['R_ankle'].y.toFixed(3)})`);
      } else if (keypointMap['R_asis']) {
      // ë¬´ë¦ë„ ì—†ìœ¼ë©´ ê³¨ë°˜ì„ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
        const hipY = keypointMap['R_asis'].y;
        const ankleOffset = hipY < 1 ? 0.60 : (hipY * 0.65);
        keypointMap['R_ankle'] = {
          x: keypointMap['R_asis'].x,
          y: hipY + ankleOffset,
          score: keypointMap['R_asis'].score * 0.6
        };
        console.log(`âœ… R_ankle ì¶”ì • (R_asis ê¸°ì¤€): (${keypointMap['R_ankle'].x.toFixed(3)}, ${keypointMap['R_ankle'].y.toFixed(3)})`);
      } else if (keypointMap['R_acromion']) {
        // ê³¨ë°˜ë„ ì—†ìœ¼ë©´ ì–´ê¹¨ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •
        const shoulderY = keypointMap['R_acromion'].y;
        const ankleOffset = shoulderY < 1 ? 0.75 : (shoulderY * 0.80);
        keypointMap['R_ankle'] = {
          x: keypointMap['R_acromion'].x,
          y: shoulderY + ankleOffset,
          score: keypointMap['R_acromion'].score * 0.5
        };
        console.log(`âœ… R_ankle ì¶”ì • (R_acromion ê¸°ì¤€): (${keypointMap['R_ankle'].x.toFixed(3)}, ${keypointMap['R_ankle'].y.toFixed(3)})`);
    }
    
    // âœ… tibial tuberosity ì¶”ê°€: ë¬´ë¦ ì•„ë˜ ì•½ê°„ì˜ ìœ„ì¹˜ (Q-angle ì¸¡ì •ìš©: ASIS-KNEE-Tibial tub)
    // ê²½ê³¨ ê²°ì ˆì€ ë¬´ë¦ ë°”ë¡œ ì•„ë˜ ì•½ 5-8% ìœ„ì¹˜ì— ìˆì–´ì•¼ í•¨
    // ì¢Œì¸¡ tibial tub
    if (keypointMap['L_knee']) {
      const kneeY = keypointMap['L_knee'].y;
      // âœ… ë¬´ë¦ ì•„ë˜ 5-8% ìœ„ì¹˜ (ë” ì •í™•í•œ ë¹„ìœ¨)
      const tibialOffset = kneeY < 1 ? 0.06 : (kneeY * 0.07);
      keypointMap['L_tibial_tub'] = {
        x: keypointMap['L_knee'].x,
        y: kneeY + tibialOffset,
        score: keypointMap['L_knee'].score * 0.9
      };
      console.log(`âœ… L_tibial_tub ë§¤í•‘ (L_knee ê¸°ì¤€): (${keypointMap['L_tibial_tub'].x.toFixed(3)}, ${keypointMap['L_tibial_tub'].y.toFixed(3)})`);
    }
    
    // ìš°ì¸¡ tibial tub
    if (keypointMap['R_knee']) {
      const kneeY = keypointMap['R_knee'].y;
      // âœ… ë¬´ë¦ ì•„ë˜ 5-8% ìœ„ì¹˜ (ë” ì •í™•í•œ ë¹„ìœ¨)
      const tibialOffset = kneeY < 1 ? 0.06 : (kneeY * 0.07);
      keypointMap['R_tibial_tub'] = {
        x: keypointMap['R_knee'].x,
        y: kneeY + tibialOffset,
        score: keypointMap['R_knee'].score * 0.9
      };
      console.log(`âœ… R_tibial_tub ë§¤í•‘ (R_knee ê¸°ì¤€): (${keypointMap['R_tibial_tub'].x.toFixed(3)}, ${keypointMap['R_tibial_tub'].y.toFixed(3)})`);
    }

    console.log(`âœ… ì •ë©´ ëœë“œë§ˆí¬ ë§¤í•‘ ì™„ë£Œ (í™˜ì ê¸°ì¤€): ${Object.keys(keypointMap).length}ê°œ - [${Object.keys(keypointMap).join(', ')}]`);
  }
  
  return keypointMap;
}

// âœ… í¬ì¦ˆ ê°ì§€ í›„ ê¸°ì¡´ ì‹œìŠ¤í…œì— í†µí•©
async function applyPoseDetection(img, sessionName) {
  const session = sessions[sessionName];
  if(!session) return null;
  
  // ì„¸ì…˜ì˜ orientation ì‚¬ìš© (ê¸°ë³¸ê°’: side)
  if(!session.poseData) {
    session.poseData = { orientation: "side", landmarks: null, orientationMode: "auto" };
  }
  const orientation = session.poseData.orientation || "side";
  const isManualOrientation = session.poseData.orientationMode === "manual";
  
  console.log(`${sessionName} ì„¸ì…˜: ${orientation === "side" ? "ì˜†ëª¨ìŠµ" : "ì •ë©´"} í¬ì¦ˆ ê°ì§€ ì‹œì‘`);
  
  let pose = await detectPose(img, orientation);
  if(!pose) return null;
  
  // ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ì„ íƒí•œ orientationì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„  ì‚¬ìš© (AI ìë™ ê°ì§€ ë¬´ì‹œ)
  const btnSide = document.getElementById("btnOrientationSide");
  const btnFront = document.getElementById("btnOrientationFront");
  const userSelectedOrientation = btnFront?.classList.contains("active") ? "front" 
    : (btnSide?.classList.contains("active") ? "side" : null);
  
  let activeOrientation = userSelectedOrientation || orientation;
  
  // ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ AI ìë™ ê°ì§€ ì‚¬ìš©
  if(!userSelectedOrientation) {
  const inferredOrientation = inferOrientationFromPose(pose);
  if (!isManualOrientation && inferredOrientation && inferredOrientation !== orientation) {
    const retryPose = await detectPose(img, inferredOrientation);
    if (retryPose) {
      pose = retryPose;
    }
    console.log(`ìë™ orientation ê°ì§€: ${orientation} â†’ ${inferredOrientation}`);
    activeOrientation = inferredOrientation;
  }
  } else {
    console.log(`ì‚¬ìš©ìê°€ ì„ íƒí•œ orientation ì‚¬ìš©: ${activeOrientation} (AI ìë™ ê°ì§€ ë¬´ì‹œ)`);
  }
  
  // í¬ì¦ˆ ì •ë³´ ì €ì¥
  session.poseData.landmarks = pose.keypoints;
  session.poseData.detectedOrientation = activeOrientation;
  if(!isManualOrientation) {
    session.poseData.orientation = activeOrientation;
    session.poseData.orientationMode = "auto";
  }
  
  // ê¸°ì¡´ ì  ì‹œìŠ¤í…œì— ë§¤í•‘ (ì„ íƒì )
  const keypointMap = mapPoseToKeypoints(pose, activeOrientation);
  if(keypointMap) {
    // ë§¤í•‘ëœ í‚¤í¬ì¸íŠ¸ë¥¼ ê¸°ì¡´ ì  ì‹œìŠ¤í…œì— ì ìš©
    const map = activeOrientation === "front" ? session.frontPoints : session.sidePoints;
    if(map?.clear) {
      map.clear();
    }
    
    // ì›ë³¸ í¬ê¸° ê³„ì‚° (ì•„ì§ ì—†ìœ¼ë©´ ê³„ì‚°)
    if(originalCanvasSize.width === 0) {
      const canvasWrap = cv.parentElement;
      const maxW = canvasWrap.clientWidth - 24;
      const maxH = canvasWrap.clientHeight - 24;
      const r = Math.min(maxW / img.naturalWidth, maxH / img.naturalHeight);
      originalCanvasSize.width = Math.round(img.naturalWidth * r);
      originalCanvasSize.height = Math.round(img.naturalHeight * r);
    }
    
    for(const [key, value] of Object.entries(keypointMap)) {
      if(!value || value.x === undefined || value.y === undefined) {
        continue;
      }
      
      // âœ… ì‹œê°í™”ìš© ì‹ ë¢°ë„ í•„í„°ë§ ì œê±° (ì¶”ì •ëœ ê´€ì ˆë„ ëª¨ë‘ í‘œì‹œ)
      // ë©”íŠ¸ë¦­ ê³„ì‚°ì€ analyzeFrontPostureì—ì„œ ë³„ë„ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ, ì‹œê°í™”ëŠ” ëª¨ë“  í‚¤í¬ì¸íŠ¸ í‘œì‹œ
      const confidence = value.score || value.visibility || 0.5;
      
      // âœ… ì‹œê°í™”ë¥¼ ìœ„í•œ í•„í„°ë§ ì™„ì „ ì œê±°: ì¶”ì •ëœ ê´€ì ˆ(ë°œëª© ë“±)ë„ ëª¨ë‘ í‘œì‹œ
      // confidenceê°€ 0ë³´ë‹¤ í¬ë©´ ëª¨ë‘ í‘œì‹œ (ë©”íŠ¸ë¦­ ê³„ì‚°ì€ ë³„ë„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬)
      if(confidence <= 0) {
        console.warn(`âš ï¸ ${key} confidenceê°€ 0 ì´í•˜: ${confidence.toFixed(2)}, ìŠ¤í‚µ`);
        continue;
      }
      
        // MediaPipeëŠ” ì •ê·œí™”ëœ ì¢Œí‘œ(0-1)ë¥¼ ì œê³µí•˜ë¯€ë¡œ í”½ì…€ ì¢Œí‘œë¡œ ë³€í™˜
      // value.xê°€ ì´ë¯¸ 1ë³´ë‹¤ í¬ë©´ ì´ë¯¸ í”½ì…€ ì¢Œí‘œì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      let imgX, imgY;
      if(value.x > 1 || value.y > 1) {
        // ì´ë¯¸ í”½ì…€ ì¢Œí‘œì¸ ê²½ìš°
        imgX = value.x;
        imgY = value.y;
      } else {
        // ì •ê·œí™”ëœ ì¢Œí‘œ(0-1)ì¸ ê²½ìš°
        imgX = value.x * img.naturalWidth;
        imgY = value.y * img.naturalHeight;
      }
      
      // âœ… ì •ë©´ ë¶„ì„ ì‹œ y ì¢Œí‘œ ì¡°ì • ì œê±° (ì •í™•í•œ ì¢Œí‘œ ì‚¬ìš©)
      // ì •ë©´ ì´ë¯¸ì§€ë„ ì¸¡ë©´ê³¼ ë™ì¼í•˜ê²Œ ì •ê·œí™”ëœ ì¢Œí‘œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      // if(activeOrientation === "front") {
      //   imgY = imgY * 0.33; // ì œê±°: ì •í™•í•œ ì¢Œí‘œ ì‚¬ìš©
      // }
        
        // ìº”ë²„ìŠ¤ í¬ê¸°ì— ë§ê²Œ ìŠ¤ì¼€ì¼ë§
        const scaleX = originalCanvasSize.width / img.naturalWidth;
        const scaleY = originalCanvasSize.height / img.naturalHeight;
        
        const finalX = imgX * scaleX;
        const finalY = imgY * scaleY;
      
      // ìœ íš¨í•œ ì¢Œí‘œì¸ì§€ í™•ì¸
      if(isNaN(finalX) || isNaN(finalY) || !isFinite(finalX) || !isFinite(finalY)) {
        console.warn(`âš ï¸ ${key} ì¢Œí‘œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ: (${finalX}, ${finalY}), ìŠ¤í‚µ`);
        continue;
      }
        
        map.set(key, {
          x: finalX,
          y: finalY
        });
        
      console.log(`âœ… ${key} ë§¤í•‘: ì›ë³¸(${value.x.toFixed(3)}, ${value.y.toFixed(3)}) â†’ ì´ë¯¸ì§€í”½ì…€(${imgX.toFixed(1)}, ${imgY.toFixed(1)}) â†’ ìº”ë²„ìŠ¤(${finalX.toFixed(1)}, ${finalY.toFixed(1)}) [confidence: ${confidence.toFixed(2)}]`);
    }
    
    // ì €ì¥ëœ ëœë“œë§ˆí¬ ê°œìˆ˜ í™•ì¸
    const savedCount = map.size;
    console.log(`âœ… ${sessionName} ëœë“œë§ˆí¬ ì €ì¥ ì™„ë£Œ: ${savedCount}ê°œ (${activeOrientation === "side" ? "ì˜†ëª¨ìŠµ" : "ì •ë©´"})`);
    
    // ì €ì¥ í›„ ì¦‰ì‹œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    if(savedCount > 0) {
      draw();
    }
    
    console.log(`âœ… ${sessionName} í¬ì¦ˆ ê°ì§€ ë° ì¢Œí‘œ ì ìš© ì™„ë£Œ (${activeOrientation === "side" ? "ì˜†ëª¨ìŠµ" : "ì •ë©´"})`);
  }
  
  return { orientation: activeOrientation, pose };
}

// âœ… í¬ì¦ˆ ê°ì§€ëŠ” ìœ„ì˜ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ì—ì„œ ìë™ìœ¼ë¡œ í˜¸ì¶œë¨
// applyPoseDetection í•¨ìˆ˜ê°€ ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜ë˜ì–´ ìˆìŒ

/**********************
 * ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ (AIReportManager ëª¨ë“ˆì—ì„œ ì‚¬ìš©)
 **********************/
if (typeof window !== 'undefined') {
  // analyzePostureAIê°€ ì •ì˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ í›„ ë…¸ì¶œ
  if(typeof analyzePostureAI === 'function') {
    window.analyzePostureAI = analyzePostureAI;
  } else {
    console.warn("analyzePostureAI í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
  }
  if(typeof generatePosturePDF === 'function') {
    window.generatePosturePDF = generatePosturePDF;
  }
  if(typeof drawComparisonChart === 'function') {
    window.drawComparisonChart = drawComparisonChart;
  }
  if(typeof savePDFMobileCompatible === 'function') {
    window.savePDFMobileCompatible = savePDFMobileCompatible;
  }
  if(typeof saveImageMobile === 'function') {
    window.saveImageMobile = saveImageMobile;
  }
  if(typeof waitForChartRender === 'function') {
    window.waitForChartRender = waitForChartRender;
  }
  if(typeof loadPostureDB === 'function') {
    window.loadPostureDB = loadPostureDB; // DB ë¡œë”ë„ ë…¸ì¶œ
  }
  
  // ëª¨ë“  í•¨ìˆ˜ê°€ ì •ì˜ëœ í›„ initializeApp í˜¸ì¶œ
  if(document.readyState === 'loading') {
    document.addEventListener("DOMContentLoaded", initializeApp);
  } else {
    // ì´ë¯¸ ë¡œë“œ ì™„ë£Œëœ ê²½ìš° ì•½ê°„ì˜ ì§€ì—° í›„ ì‹¤í–‰ (í•¨ìˆ˜ë“¤ì´ ëª¨ë‘ ì •ì˜ë˜ë„ë¡)
    setTimeout(initializeApp, 0);
  }
}

/**********************
 * (ì„ íƒ ê¸°ëŠ¥) ì™¸ë¶€ AI ëª¨ë“ˆ ë¡œë“œ ë¹„í™œì„±í™”
 * ë„¤íŠ¸ì›Œí¬ 404ì™€ ì¤‘ë³µ ë¶„ì„ ë¬¸ì œë¥¼ ë§‰ê¸° ìœ„í•´ í˜„ì¬ëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 **********************/


// -------------------- ê³¨ë°˜ ë¶„ì„ ìë™ ì—°ë™ --------------------

// 1ï¸âƒ£ PTA ê³„ì‚°
function calcPTA(asis, psis) {
  // asis, psis: {x, y}
  // ì´ë¯¸ì§€ ì¢Œí‘œê³„: yì¶• ì•„ë˜ë¡œ ì¦ê°€
  // ASIS.y < PSIS.y â†’ ASISê°€ ìœ„ìª½(ë†’ìŒ) â†’ í›„ë°©ê²½ì‚¬(ìŒìˆ˜)
  // ASIS.y > PSIS.y â†’ ASISê°€ ë°‘ìª½(ë‚®ìŒ) â†’ ì „ë°©ê²½ì‚¬(ì–‘ìˆ˜)
  
  // ìˆ˜í‰ì„  ê¸°ì¤€ ê°ë„ ê³„ì‚° (PSISì—ì„œ ASISë¡œì˜ ê°ë„)
  const pta_theta = angleFromHorizontalDeg(psis, asis);
  const pta_abs = Math.abs(normalizeToAcuteDeg(pta_theta));
  
  let pta;
  if (asis.y < psis.y) {
    // í›„ë°©ê²½ì‚¬: ASISê°€ PSISë³´ë‹¤ ìœ„ìª½ â†’ ìŒìˆ˜, ìµœì†Œ -1ë„
    pta = -Math.max(1, pta_abs || 1);
  } else if (asis.y > psis.y) {
    // ì „ë°©ê²½ì‚¬: ASISê°€ PSISë³´ë‹¤ ë°‘ìª½ â†’ ì–‘ìˆ˜, ìµœì†Œ 1ë„
    pta = Math.max(1, pta_abs || 1);
  } else {
    // ê°™ì€ ë†’ì´: 0ë„
    pta = 0;
  }
  
  return pta; // ë¶€í˜¸ í¬í•¨ ê°’ (ì–‘ìˆ˜=ì „ë°©ê²½ì‚¬, ìŒìˆ˜=í›„ë°©ê²½ì‚¬)
}

// 2ï¸âƒ£ ì„¤ëª… ìƒì„±
function getPelvicTiltDescription(PTA) {
  let description = "";

  if (PTA > 15) {
    description = `
ğŸ“ ê³¨ë°˜ ì „ë°© ê²½ì‚¬ (Anterior Pelvic Tilt) - ì‹¬ê°
í˜„ì¬ ìƒíƒœ: PTA ${PTA.toFixed(1)}Â° (ì •ìƒ: 0â€“15Â°)

ì£¼ìš” ì›ì¸: ì¥ì‹œê°„ ì•‰ì•„ìˆëŠ” ìƒí™œ, í•˜ì´í ì°©ìš©, ë³µë¶€ ê·¼ë ¥ ì•½í™”, ì„ì‹  í›„ íšŒë³µ ë¶€ì¡±

ë°œìƒ ì¦ìƒ:
â€¢ ìš”ì¶” ê³¼ì „ë§Œ(Hyperlordosis)ìœ¼ë¡œ ì¸í•œ ë§Œì„± ìš”í†µ  
â€¢ í•˜ë³µë¶€ ëŒì¶œ (pseudo-pregnancy appearance)  
â€¢ ì—‰ë©ì´ê°€ ë’¤ë¡œ íŠ€ì–´ë‚˜ì˜¨ ìì„¸  
â€¢ ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ë‹¨ì¶•ìœ¼ë¡œ ì¸í•œ ë³´í–‰ ì¥ì• 

ê·¼ìœ¡ ë¶ˆê· í˜•:
â€¢ ê¸´ì¥Â·ë‹¨ì¶•ëœ ê·¼ìœ¡: ì¥ìš”ê·¼(Iliopsoas), ëŒ€í‡´ì§ê·¼(Rectus femoris), ì²™ì¶”ê¸°ë¦½ê·¼(Erector spinae)  
â€¢ ì•½í™”Â·ì‹ ì¥ëœ ê·¼ìœ¡: ë³µì§ê·¼(Rectus abdominis), ëŒ€ë‘”ê·¼(Gluteus maximus), í–„ìŠ¤íŠ¸ë§(Hamstrings)

êµì • ë°©í–¥:
â‘  ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ìŠ¤íŠ¸ë ˆì¹­ (ëŸ°ì§€ ìì„¸)  
â‘¡ ì½”ì–´ ê°•í™” (í”Œë­í¬, ë°ë“œë²„ê·¸)  
â‘¢ ëŒ€ë‘”ê·¼ í™œì„±í™” (ë¸Œë¦¿ì§€, í™ ì“°ëŸ¬ìŠ¤íŠ¸, í´ë¨ì‰˜)  
â‘£ ê³¨ë°˜ í›„ë°©ê²½ì‚¬ ì—°ìŠµ (ë²½ì— ë“±ëŒ€ê³  ì¤‘ë¦½ìì„¸)

ë³µí•© ì¦í›„êµ°: Lower Cross Syndrome(í•˜ë¶€ êµì°¨ ì¦í›„êµ°)ì˜ í•µì‹¬ íŠ¹ì§•ì…ë‹ˆë‹¤.
`;
  } else if (PTA < 0) {
    description = `
ğŸ“ ê³¨ë°˜ í›„ë°© ê²½ì‚¬ (Posterior Pelvic Tilt)
í˜„ì¬ ìƒíƒœ: PTA ${PTA.toFixed(1)}Â° (ì •ìƒ: 0â€“15Â°, ASISê°€ PSISë³´ë‹¤ ìœ„ìª½)

ì£¼ìš” ì›ì¸: ì¥ì‹œê°„ ì•‰ì€ ìì„¸, í–„ìŠ¤íŠ¸ë§ ë‹¨ì¶•, ë³µë¶€ ê·¼ìœ¡ ê³¼í™œì„±, ë‘”ê·¼ ê³¼ê¸´ì¥

ë°œìƒ ì¦ìƒ:
â€¢ ìš”ì¶” í‰í‰(Flat Back)ìœ¼ë¡œ ì¸í•œ í—ˆë¦¬ ì›€ì§ì„ ì œí•œ  
â€¢ ì—‰ë©ì´ê°€ ë‚©ì‘í•´ ë³´ì´ëŠ” ìì„¸  
â€¢ ë””ìŠ¤í¬ ì••ë°• ë° í—ˆë¦¬ í†µì¦  
â€¢ ë‘”ê·¼ ê¸´ì¥ìœ¼ë¡œ ì¸í•œ ê³ ê´€ì ˆ ê°€ë™ì„± ì €í•˜

ê·¼ìœ¡ ë¶ˆê· í˜•:
â€¢ ê¸´ì¥Â·ë‹¨ì¶•ëœ ê·¼ìœ¡: ë³µì§ê·¼(Rectus abdominis), í–„ìŠ¤íŠ¸ë§(Hamstrings), ëŒ€ë‘”ê·¼(Gluteus maximus)  
â€¢ ì•½í™”Â·ì‹ ì¥ëœ ê·¼ìœ¡: ì¥ìš”ê·¼(Iliopsoas), ì²™ì¶”ê¸°ë¦½ê·¼(Erector spinae)

êµì • ë°©í–¥:
â‘  í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹­ (ë²½ ì§šê³  ì„œì„œ ë‹¤ë¦¬ í´ê¸°)  
â‘¡ ì²™ì¶”ê¸°ë¦½ê·¼ ê°•í™” (ë°± ìµìŠ¤í…ì…˜, ë²„ë“œë…)  
â‘¢ ì¥ìš”ê·¼ í™œì„±í™” (Standing Hip Flexor Activation)  
â‘£ ê³¨ë°˜ ì „ë°©ê²½ì‚¬ ìœ ë„ (Pelvic Tilt Drill)

ë³µí•© ì¦í›„êµ°: Flat Back Syndrome, Upper Cross Syndromeê³¼ ì—°ê´€ ê°€ëŠ¥ì„± ìˆìŒ.
`;
  } else {
    description = `
ğŸ“ ê³¨ë°˜ ì¤‘ë¦½ (Neutral Pelvic Alignment)
í˜„ì¬ ìƒíƒœ: PTA ${PTA.toFixed(1)}Â° (ì •ìƒ: 0â€“15Â°)

ê³¨ë°˜ì´ ì•ˆì •ëœ ì¤‘ë¦½ ì •ë ¬ ìƒíƒœë¡œ, í—ˆë¦¬ ë¶€ë‹´ì´ ìµœì†Œí™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.  
í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ë³µë¶€ ì½”ì–´ ê°•í™”ì™€ ì •ê¸°ì ì¸ ìŠ¤íŠ¸ë ˆì¹­ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
`;
  }

  const pelvicDescEl = document.getElementById("pelvicDesc");
  if (pelvicDescEl) {
    pelvicDescEl.innerText = description.trim();
    pelvicDescEl.style.display = "block";
  }
}

// 3ï¸âƒ£ AI ë¶„ì„ ìë™ ì—°ê²° (computeAll í•¨ìˆ˜ì—ì„œ í˜¸ì¶œ)
function analyzePelvicTiltAuto() {
  try {
    const S = sessions[cur];
    if (!S || !S.sidePoints) return;

    // ASISì™€ PSIS ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸°
    const asis = S.sidePoints.get('asis');
    const psis = S.sidePoints.get('psis');

    if (!asis || !psis || asis.x == null || asis.y == null || psis.x == null || psis.y == null) {
      // ì¢Œí‘œê°€ ì—†ìœ¼ë©´ í‘œì‹œ ì˜ì—­ ìˆ¨ê¸°ê¸°
      const pelvicDescEl = document.getElementById("pelvicDesc");
      if (pelvicDescEl) {
        pelvicDescEl.style.display = "none";
      }
      return;
    }

    // PTA ê³„ì‚°
    const PTA = calcPTA(asis, psis);
    
    // ì„¤ëª… ìƒì„± ë° í‘œì‹œ
    getPelvicTiltDescription(PTA);

    console.log(`[AI-Posture] PTA=${PTA.toFixed(2)}Â° â†’ ìë™ ë¶„ì„ ì™„ë£Œ`);
  } catch (err) {
    console.warn('âš ï¸ ê³¨ë°˜ ë¶„ì„ ì‹¤íŒ¨:', err);
  }
}

// âœ… ìº”ë²„ìŠ¤ ì—†ìœ¼ë©´ ìë™ ìƒì„± (ì ˆëŒ€ PDF ì•ˆí„°ì§€ê²Œ ë§Œë“¦)
function getOrCreateCanvas(id, width = 1200, height = 800) {
  let canvas = document.getElementById(id);
  if (!canvas) {
    console.warn(`âš ï¸ ${id} ìº”ë²„ìŠ¤ ì—†ìŒ â†’ ìƒˆë¡œ ìƒì„±`);
    canvas = document.createElement("canvas");
    canvas.id = id;
    canvas.width = width;
    canvas.height = height;
    document.body.appendChild(canvas);
  }
  return canvas;
}

// âœ… chart / summary ìº”ë²„ìŠ¤ ê°•ì œ í™•ë³´ + 2D context ì•ˆì •í™”
function ensureCanvasReady() {
  const chartCanvas = getOrCreateCanvas("chartCanvas");
  const aiSummaryCanvas = getOrCreateCanvas("aiSummaryCanvas");

  chartCanvas.getContext("2d", { willReadFrequently: true });
  aiSummaryCanvas.getContext("2d", { willReadFrequently: true });

  return { chartCanvas, aiSummaryCanvas };
}

// âœ… PDF ìƒì„± (í„°ì§ˆ í™•ë¥  0%ì— ë„ì „í•œ ë²„ì „) - ì‚¬ìš©ì ì œê³µ ê°„ë‹¨ ë²„ì „
// ì£¼ì˜: ê¸°ì¡´ exportAsPdf í•¨ìˆ˜ì™€ ì´ë¦„ì´ ê°™ì§€ë§Œ, ì´ ë²„ì „ì€ ê°„ë‹¨í•œ fallbackìš©ì…ë‹ˆë‹¤
async function exportAsPdfSimple() {
  try {
    console.log("ğŸ”¥ PDF ìƒì„± ì‹œì‘ (ê°„ë‹¨ ë²„ì „)");

    const { chartCanvas, aiSummaryCanvas } = ensureCanvasReady();

    // ìº”ë²„ìŠ¤ì— ë‚´ìš© ì—†ì„ ê²½ìš° ì•ˆë‚´ ë¬¸êµ¬ ìë™ ìƒì„±
    const ctx = aiSummaryCanvas.getContext("2d");
    ctx.fillStyle = "#111";
    ctx.font = "24px Pretendard";
    ctx.fillText("AI ë¶„ì„ ê²°ê³¼ê°€ ì•„ì§ ì—†ê±°ë‚˜ í‘œì‹œë˜ì§€ ì•ŠìŒ", 50, 120);

    // ì´ë¯¸ì§€ ë³€í™˜
    const img1 = chartCanvas.toDataURL("image/png");
    const img2 = aiSummaryCanvas.toDataURL("image/png");

    // jsPDF ìƒì„±
    if (!window.jspdf || !window.jspdf.jsPDF) {
      throw new Error("jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }
    const pdf = new window.jspdf.jsPDF({
      orientation: "p",
      unit: "px",
      format: "a4"
    });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const imgWidth = pageWidth - 40;

    pdf.text("ğŸ“Œ ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸", 20, 40);
    pdf.addImage(img1, "PNG", 20, 60, imgWidth, 220);
    pdf.addPage();
    pdf.text("ğŸ“Š AI ë¶„ì„ ìš”ì•½", 20, 40);
    pdf.addImage(img2, "PNG", 20, 60, imgWidth, 220);
    pdf.save("Posture_AI_Report.pdf");

    console.log("âœ… PDF ìƒì„± ì™„ë£Œ");
  } catch (err) {
    console.error("âŒ PDF ìƒì„± ì‹¤íŒ¨:", err);
    alert("PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + err.message);
  }
}

// PDF ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê°„ë‹¨ ë²„ì „ ì‚¬ìš©)
// ê¸°ì¡´ setupPDFButtonê³¼ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡ ì£¼ì˜
/* ================== PDF ìƒì„± (ë¹ˆ í™”ë©´ ë¬¸ì œ ì™„ì „ í•´ê²°) ================== */
document.getElementById('downloadPdfBtn')?.addEventListener('click', async function() {
  try {
    if (!window.html2canvas || !window.jspdf?.jsPDF) throw new Error("ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨");
    const { jsPDF } = window.jspdf;

    const pdf = new jsPDF('p', 'pt', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 50;
    const contentWidth = pageWidth - 2 * margin;
    let yPos = margin;

    await document.fonts.ready;

    // íšŒì› ì •ë³´ ì…ë ¥
    const memberName = prompt("íšŒì›ëª…", "ê¹€ì² ìˆ˜") || "ê¹€ì² ìˆ˜";
    const centerName = prompt("ì„¼í„°ëª…", "DIT í•„ë¼í…ŒìŠ¤") || "DIT í•„ë¼í…ŒìŠ¤";
    document.getElementById('page1MemberInfo').innerHTML = `
      íšŒì›ëª…: ${memberName}<br>
      ì„¼í„°ëª…: ${centerName}<br>
      ë¶„ì„ì¼: ${new Date().toLocaleDateString('ko-KR')}
    `;

    // ì˜ˆì‹œ ë¶„ì„ ë°ì´í„° (ì‹¤ì œ ë¶„ì„ ê²°ê³¼ë¡œ êµì²´)
    const analysis = {
      side: { score: 72, tight: ['ì¥ìš”ê·¼'], weak: ['ë³µì§ê·¼', 'ëŒ€ë‘”ê·¼'], pattern: 'ì „ë°© ê²½ì‚¬í˜•' },
      front: { score: 88, tight: ['ìš°ì¸¡ ìŠ¹ëª¨ê·¼'], weak: ['ì¢Œì¸¡ ì¤‘ë‘”ê·¼'], pattern: 'ê³¨ë°˜ ì¢Œí•˜ê°•' }
    };

    // ì»¨í…Œì´ë„ˆ ë‚´ìš© ì—…ë°ì´íŠ¸
    document.getElementById('sideScore').textContent = `${analysis.side.score}/100`;
    document.getElementById('sideMuscles').textContent = `ê¸´ì¥: ${analysis.side.tight.join(', ')} | ì•½í™”: ${analysis.side.weak.join(', ')}`;
    document.getElementById('sidePattern').textContent = analysis.side.pattern;

    document.getElementById('frontScore').textContent = `${analysis.front.score}/100`;
    document.getElementById('frontMuscles').textContent = `ê¸´ì¥: ${analysis.front.tight.join(', ')} | ì•½í™”: ${analysis.front.weak.join(', ')}`;
    document.getElementById('frontPattern').textContent = analysis.front.pattern;

    const totalScore = Math.round((analysis.side.score + analysis.front.score) / 2);
    const totalTight = [...new Set([...analysis.side.tight, ...analysis.front.tight])];
    const totalWeak = [...new Set([...analysis.side.weak, ...analysis.front.weak])];
    document.getElementById('totalScore').textContent = `${totalScore}/100`;
    document.getElementById('totalMuscles').textContent = `ê¸´ì¥: ${totalTight.join(', ')} | ì•½í™”: ${totalWeak.join(', ')}`;
    document.getElementById('aiComment').textContent = `ë³µí•©í˜• ì²´í˜•. ì½”ì–´ ê°•í™” + ê³ ê´€ì ˆ/ê²¬ê°‘ ì•ˆì • í•„ìš”.`;

    // í•„ë¼í…ŒìŠ¤ ì¶”ì²œ (AI ë§¤ì¹­)
    const recs = recommendPilates(totalTight, totalWeak);
    document.getElementById('pilatesRecommendations').innerHTML = recs.map(r =>
      `<p style="margin:8px 0;"><strong>${r.name}</strong> <small>(${r.equip} | ${r.type}: ${r.target})</small></p>`
    ).join('');

    document.getElementById('deepAnalysis').innerHTML = `<p>â€¢ ê³¨ë°˜ ì „ë°© ê²½ì‚¬: 18Â° â†’ 8Â°<br>â€¢ ì–´ê¹¨ ê¸°ìš¸ê¸°: 4Â° â†’ 1Â°</p>`;
    document.getElementById('bodyTypeAnalysis').innerHTML = `<p><strong>ìœ í˜•:</strong> ì „ë°© ê²½ì‚¬ + ê³¨ë°˜ ë¹„ëŒ€ì¹­ ë³µí•©í˜•</p>`;
    document.getElementById('improvementSummary').textContent = `ê³¨ë°˜ 10Â° ê°œì„ , ì–´ê¹¨ 3Â° êµì •`;
    document.getElementById('roadmapList').innerHTML = [
      '<li>1~4ì£¼: ì½”ì–´ ê¸°ì´ˆ ê°•í™”</li>',
      '<li>5~8ì£¼: ê³ ê´€ì ˆ ê°€ë™ì„± í–¥ìƒ</li>',
      '<li>9~12ì£¼: ê¸°ëŠ¥ì  ì›€ì§ì„ í†µí•©</li>'
    ].join('');

    // === PDF ìƒì„± (ëª¨ë“  ì»¨í…Œì´ë„ˆ ìº¡ì²˜) ===
    const containers = [
      'sideImageContainer', 'sideOverlayContainer', 'sideReportContainer',
      'frontImageContainer', 'frontOverlayContainer', 'frontReportContainer',
      'page4Container', 'page5Container', 'page8Container', 'page7Container'
    ];

    for (let i = 0; i < containers.length; i++) {
      const id = containers[i];
      const el = document.getElementById(id);
      if (!el) continue;

      // ì„ì‹œ ë˜í¼ ìƒì„± (ë³´ì´ì§€ ì•Šì§€ë§Œ ë Œë”ë§ ê°€ëŠ¥)
      const wrapper = document.createElement('div');
      wrapper.style.cssText = `
        position: absolute; left: -9999px; top: 0; width: 520px;
        padding: 30px; background: white; font-family: Pretendard, sans-serif;
        visibility: visible;
      `;
      const clone = el.cloneNode(true);
      clone.style.cssText = 'visibility: visible !important;';
      wrapper.appendChild(clone);
      document.body.appendChild(wrapper);

      // ìº¡ì²˜
      const canvas = await html2canvas(wrapper, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: false,
        width: wrapper.scrollWidth,
        height: wrapper.scrollHeight,
        onclone: (clonedDoc) => {
          // âœ… Quirks Mode ë°©ì§€: ë³µì œëœ ë¬¸ì„œì— DOCTYPE ì¶”ê°€ (ìµœì¢… ê°•í™”)
          try {
            // ë³µì œëœ ë¬¸ì„œì™€ ê´€ë ¨ëœ ëª¨ë“  ë¬¸ì„œ í™•ì¸
            const docsToFix = [clonedDoc];
            
            // clonedDoc.defaultViewë¥¼ í†µí•´ windowì— ì ‘ê·¼ (iframe ë‚´ë¶€ ë¬¸ì„œì¼ ìˆ˜ ìˆìŒ)
            if (clonedDoc.defaultView && clonedDoc.defaultView.document && clonedDoc.defaultView.document !== clonedDoc) {
              docsToFix.push(clonedDoc.defaultView.document);
            }
            
            // âœ… html2canvasê°€ ìƒì„±í•œ ëª¨ë“  iframe ë¬¸ì„œë„ í™•ì¸
            try {
              const allIframes = clonedDoc.querySelectorAll('iframe');
              allIframes.forEach(iframe => {
                try {
                  if (iframe.contentDocument && iframe.contentDocument !== clonedDoc) {
                    docsToFix.push(iframe.contentDocument);
                  }
                } catch (e) {
                  // Cross-origin iframeì€ ì ‘ê·¼ ë¶ˆê°€ (ë¬´ì‹œ)
                }
              });
            } catch (e) {
              // iframe ì ‘ê·¼ ì‹¤íŒ¨ (ë¬´ì‹œ)
            }
            
            docsToFix.forEach(doc => {
              try {
                // DOCTYPEì´ ì—†ê±°ë‚˜ Quirks Modeì¸ ê²½ìš° ê°•ì œë¡œ ì¶”ê°€
                if (!doc.doctype || doc.compatMode === 'BackCompat') {
                  // ë°©ë²• 1: createDocumentType ì‚¬ìš© (ê°€ì¥ í‘œì¤€ì ì¸ ë°©ë²•)
                  try {
                    const doctype = doc.implementation.createDocumentType('html', '', '');
                    // ê¸°ì¡´ DOCTYPEì´ ìˆìœ¼ë©´ ì œê±°
                    if (doc.doctype) {
                      doc.removeChild(doc.doctype);
                    }
                    // documentElement ì•ì— DOCTYPE ì‚½ì…
                    if (doc.documentElement) {
                      doc.insertBefore(doctype, doc.documentElement);
                    } else {
                      // documentElementê°€ ì—†ìœ¼ë©´ ì§ì ‘ ì¶”ê°€
                      doc.appendChild(doctype);
                    }
                  } catch (e1) {
                    console.warn('createDocumentType ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‹œë„:', e1);
                    // ë°©ë²• 2: DOMParserë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆ ë¬¸ì„œ ìƒì„±
                    try {
                      const htmlContent = '<!DOCTYPE html>\n' + (doc.documentElement ? doc.documentElement.outerHTML : '');
                      const parser = new DOMParser();
                      const newDoc = parser.parseFromString(htmlContent, 'text/html');
                      if (newDoc.doctype) {
                        // ê¸°ì¡´ DOCTYPE ì œê±° í›„ ìƒˆ DOCTYPE ì¶”ê°€
                        if (doc.doctype) {
                          doc.removeChild(doc.doctype);
                        }
                        if (doc.documentElement) {
                          doc.insertBefore(newDoc.doctype, doc.documentElement);
                        }
                      }
                    } catch (e2) {
                      console.warn('DOMParser ë°©ë²•ë„ ì‹¤íŒ¨:', e2);
                    }
                  }
                }
                // ìµœì¢… í™•ì¸: document.compatModeê°€ 'BackCompat'ì´ë©´ Quirks Mode
                if (doc.compatMode === 'BackCompat') {
                  console.warn('âš ï¸ ë³µì œëœ ë¬¸ì„œê°€ ì—¬ì „íˆ Quirks Modeì…ë‹ˆë‹¤. DOCTYPE:', doc.doctype);
                } else {
                  console.log('âœ… ë³µì œëœ ë¬¸ì„œê°€ Standards Modeë¡œ ë Œë”ë§ë©ë‹ˆë‹¤.');
                }
              } catch (docErr) {
                console.warn('ê°œë³„ ë¬¸ì„œ DOCTYPE ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', docErr);
              }
            });
          } catch (err) {
            console.warn('onclone DOCTYPE ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', err);
          }
        }
      });

      document.body.removeChild(wrapper);

      const imgData = canvas.toDataURL('image/png');
      const imgHeight = (canvas.height * contentWidth) / canvas.width;
      let heightLeft = imgHeight;
      let pos = 0;

      while (heightLeft > 0) {
        if (yPos + 100 > pageHeight - margin && heightLeft > 100) {
          pdf.addPage();
          yPos = margin;
        }
        const sliceH = Math.min(heightLeft, pageHeight - yPos - margin);
        const sliceCanvas = document.createElement('canvas');
        sliceCanvas.width = canvas.width;
        sliceCanvas.height = (sliceH * canvas.width) / contentWidth;
        const ctx = sliceCanvas.getContext('2d');
        ctx.drawImage(canvas, 0, pos, canvas.width, sliceCanvas.height, 0, 0, canvas.width, sliceCanvas.height);

        pdf.addImage(sliceCanvas.toDataURL('image/png'), 'PNG', margin, yPos, contentWidth, sliceH);
        heightLeft -= sliceH;
        pos += sliceCanvas.height;
        yPos += sliceH + 20;
      }

      if (i < containers.length - 1) {
        pdf.addPage();
        yPos = margin;
      }
    }

    pdf.save(`${centerName}_${memberName}_ìì„¸ë¶„ì„ë¦¬í¬íŠ¸.pdf`);
    alert("PDF ìƒì„± ì™„ë£Œ! ëª¨ë“  ë‚´ìš©ì´ ì •ìƒ ì¶œë ¥ë©ë‹ˆë‹¤.");

  } catch (err) {
    console.error("PDF ìƒì„± ì˜¤ë¥˜:", err);
    alert("PDF ìƒì„± ì‹¤íŒ¨: " + err.message);
  }
});

/* ================== AI í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ì—”ì§„ ================== */
function recommendPilates(tightMuscles, weakMuscles) {
  const recs = [];
  const seen = new Set();

  // ì•½í•œ ê·¼ìœ¡ ê°•í™”
  weakMuscles.forEach(m => {
    PILATES_ALL.forEach(ex => {
      if (ex.Main_Strengthen_Muscles?.includes(m) && !seen.has(ex.Exercise_Name_KR)) {
        seen.add(ex.Exercise_Name_KR);
        recs.push({ name: ex.Exercise_Name_KR, type: 'ê°•í™”', target: m, equip: ex.Spring_Traditional?.includes('None') ? 'ë§·' : 'ê¸°êµ¬' });
      }
    });
  });

  // ê¸´ì¥ ê·¼ìœ¡ ìŠ¤íŠ¸ë ˆì¹˜
  tightMuscles.forEach(m => {
    PILATES_ALL.forEach(ex => {
      if (ex.Main_Stretch_Muscles?.includes(m) && !seen.has(ex.Exercise_Name_KR)) {
        seen.add(ex.Exercise_Name_KR);
        recs.push({ name: ex.Exercise_Name_KR, type: 'ìŠ¤íŠ¸ë ˆì¹˜', target: m, equip: ex.Spring_Traditional?.includes('None') ? 'ë§·' : 'ê¸°êµ¬' });
      }
    });
  });

  return recs.slice(0, 8);
}

/* ================== PDF ìƒì„± (ë¹ˆ í™”ë©´ 100% í•´ê²°) ================== */
async function generateFinalPostureReportPDF() {
  try {
    if (!window.html2canvas || !window.jspdf?.jsPDF) throw new Error("ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨");
    const { jsPDF } = window.jspdf;

    const pdf = new jsPDF('p', 'pt', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 60; // âœ… ë§ˆì§„ ì¦ê°€ (ê¸€ì/ì‚¬ì§„ ì˜ë¦¼ ë°©ì§€)
    const contentWidth = pageWidth - 2 * margin;
    let yPos = margin;

    await document.fonts.ready;

    // === ì»¨í…Œì´ë„ˆ ìƒì„± ===
    console.log("ğŸ“„ ì»¨í…Œì´ë„ˆ ìƒì„± ì¤‘...");
    const captureResult = await captureReportCanvases({
      centerName: localStorage.getItem('centerName') || '',
      memberName: localStorage.getItem('memberName') || '',
      appName: 'DIT ìì„¸ ë¶„ì„ AI',
      logoUrl: null
    });
    console.log("âœ… ì»¨í…Œì´ë„ˆ ìƒì„± ì™„ë£Œ");

    const centerName = localStorage.getItem('centerName') || '';
    const memberName = localStorage.getItem('memberName') || '';

    // === PDF ìº¡ì²˜ ===
    // âœ… ì´ë¯¸ ìƒì„±ëœ ìº”ë²„ìŠ¤ê°€ ìˆìœ¼ë©´ ì§ì ‘ ì‚¬ìš© (sideImageCanvas, frontImageCanvas)
    const preGeneratedCanvases = {
      'sideImageContainer': captureResult?.sideImageCanvas || null,
      'frontImageContainer': captureResult?.frontImageCanvas || null
    };
    
    const containers = [
      'sideImageContainer', 'sideOverlayContainer', 'sideReportContainer',
      'frontImageContainer', 'frontOverlayContainer', 'frontReportContainer',
      'page4Container', 'page5Container', 'page8Container', 'page7Container'
    ];

    for (let i = 0; i < containers.length; i++) {
      const id = containers[i];
      
      // âœ… ì´ë¯¸ ìƒì„±ëœ ìº”ë²„ìŠ¤ê°€ ìˆìœ¼ë©´ ì§ì ‘ ì‚¬ìš© (dot í¬í•¨ ë³´ì¥)
      if (preGeneratedCanvases[id]) {
        const canvas = preGeneratedCanvases[id];
        if (canvas && canvas.width > 0 && canvas.height > 0) {
          console.log(`âœ… ${id} ì´ë¯¸ ìƒì„±ëœ ìº”ë²„ìŠ¤ ì‚¬ìš© (í¬ê¸°: ${canvas.width}x${canvas.height})`);
          
          // âœ… ì›ë³¸ ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ PDF í˜ì´ì§€ì— ë§ê²Œ ìŠ¤ì¼€ì¼ë§ (ì˜ë¦¼ ë°©ì§€)
          const imgData = canvas.toDataURL('image/png', 1.0);
          const canvasAspectRatio = canvas.width / canvas.height;
          const maxWidth = contentWidth;
          const maxHeight = pageHeight - margin * 2;
          
          // âœ… ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ í˜ì´ì§€ì— ë§ê²Œ ìŠ¤ì¼€ì¼ë§
          let imgWidth = maxWidth;
          let imgHeight = maxWidth / canvasAspectRatio;
          
          // âœ… ë†’ì´ê°€ í˜ì´ì§€ë¥¼ ì´ˆê³¼í•˜ë©´ ë†’ì´ ê¸°ì¤€ìœ¼ë¡œ ì¬ê³„ì‚° (ì˜ë¦¼ ë°©ì§€)
          if (imgHeight > maxHeight) {
            imgHeight = maxHeight;
            imgWidth = maxHeight * canvasAspectRatio;
          }
          
          // âœ… ëª¨ë°”ì¼ì—ì„œë„ ì˜ë¦¬ì§€ ì•Šë„ë¡ ìµœì†Œ í¬ê¸° ë³´ì¥
          const minScale = 0.3;
          if (imgWidth < canvas.width * minScale) {
            imgWidth = canvas.width * minScale;
            imgHeight = imgWidth / canvasAspectRatio;
            if (imgHeight > maxHeight) {
              imgHeight = maxHeight;
              imgWidth = maxHeight * canvasAspectRatio;
            }
          }
          
          // âœ… ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë‚˜ëˆ„ì–´ì„œ ì¶”ê°€ (ì˜ë¦¼ ë°©ì§€ ê°•í™”)
          let heightLeft = imgHeight;
          let currentY = yPos;
          let sourceY = 0; // ì›ë³¸ ìº”ë²„ìŠ¤ì—ì„œì˜ Y ìœ„ì¹˜ (í”½ì…€ ë‹¨ìœ„)
          
          while (heightLeft > 0) {
            // âœ… í˜„ì¬ í˜ì´ì§€ì— ì‚¬ìš© ê°€ëŠ¥í•œ ë†’ì´ ê³„ì‚° (ì—¬ìœ  ê³µê°„ í™•ë³´)
            const availableHeight = pageHeight - currentY - margin;
            const minSliceHeight = 50; // ìµœì†Œ ìŠ¬ë¼ì´ìŠ¤ ë†’ì´ (ë„ˆë¬´ ì‘ì€ ì¡°ê° ë°©ì§€)
            
            // ê³µê°„ì´ ë¶€ì¡±í•˜ë©´ ìƒˆ í˜ì´ì§€ ì¶”ê°€
            if (availableHeight < minSliceHeight && heightLeft > minSliceHeight) {
              pdf.addPage();
              currentY = margin;
              continue;
            }
            
            // âœ… í˜„ì¬ í˜ì´ì§€ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ ë†’ì´ ê³„ì‚°
            const sliceH = Math.min(heightLeft, availableHeight);
            
            if (sliceH <= 0) {
              // ìŠ¬ë¼ì´ìŠ¤ ë†’ì´ê°€ 0 ì´í•˜ë©´ ìƒˆ í˜ì´ì§€ ì¶”ê°€
              pdf.addPage();
              currentY = margin;
              continue;
            }
            
            // âœ… ì›ë³¸ ìº”ë²„ìŠ¤ì—ì„œ ìŠ¬ë¼ì´ìŠ¤í•  ë†’ì´ ê³„ì‚° (í”½ì…€ ë‹¨ìœ„, ì •í™•ë„ í–¥ìƒ, ì˜¤ë²„í”Œë¡œìš° ë°©ì§€)
            // ë¹„ìœ¨ ê¸°ë°˜ ê³„ì‚°ìœ¼ë¡œ ì •í™•ë„ í–¥ìƒ
            const scaleRatio = canvas.height / imgHeight;
            
            // âœ… ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ìŠ¤ëŠ” ë‚¨ì€ ë¶€ë¶„ ëª¨ë‘ í¬í•¨ (ì˜ë¦¼ ë°©ì§€)
            const isLastSlice = heightLeft <= sliceH * 1.1; // ë§ˆì§€ë§‰ 10% ë²”ìœ„
            let sourceSliceHeight;
            
            if (isLastSlice) {
              // ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ìŠ¤: ë‚¨ì€ ë¶€ë¶„ ëª¨ë‘ í¬í•¨
              const remainingHeight = canvas.height - sourceY;
              sourceSliceHeight = Math.max(remainingHeight, Math.round(sliceH * scaleRatio));
            } else {
              // ì¼ë°˜ ìŠ¬ë¼ì´ìŠ¤: Math.roundë¡œ ì •í™•ë„ í–¥ìƒ
              sourceSliceHeight = Math.min(
                Math.round(sliceH * scaleRatio), // Math.roundë¡œ ë³€ê²½ (ë” ì •í™•)
                canvas.height - sourceY // ì›ë³¸ ìº”ë²„ìŠ¤ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡
              );
            }
            
            if (sourceSliceHeight <= 0 || sourceY >= canvas.height) {
              // ìŠ¬ë¼ì´ìŠ¤í•  ë†’ì´ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ëì— ë„ë‹¬í–ˆìœ¼ë©´ ì¢…ë£Œ
              break;
            }
            
            // âœ… ìº”ë²„ìŠ¤ ìŠ¬ë¼ì´ìŠ¤ ìƒì„±
            const sliceCanvas = document.createElement('canvas');
            sliceCanvas.width = canvas.width;
            sliceCanvas.height = sourceSliceHeight;
            const ctx = sliceCanvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            // âœ… ì›ë³¸ ìº”ë²„ìŠ¤ì—ì„œ ìŠ¬ë¼ì´ìŠ¤ ì¶”ì¶œ (ì •í™•í•œ ìœ„ì¹˜ì—ì„œ, ì˜ë¦¼ ë°©ì§€)
            ctx.drawImage(
              canvas, 
              0, sourceY, canvas.width, sourceSliceHeight,  // ì›ë³¸ ì˜ì—­
              0, 0, canvas.width, sourceSliceHeight         // ëŒ€ìƒ ì˜ì—­
            );
            
            // âœ… PDFì— ì¶”ê°€ ì‹œ ì •í™•í•œ ë†’ì´ ì‚¬ìš© (ì˜ë¦¼ ë°©ì§€)
            const actualSliceH = Math.min(sliceH, availableHeight);
            pdf.addImage(sliceCanvas.toDataURL('image/png', 1.0), 'PNG', margin, currentY, imgWidth, actualSliceH);
            
            // âœ… ë‹¤ìŒ ìŠ¬ë¼ì´ìŠ¤ ì¤€ë¹„
            heightLeft -= sliceH;
            sourceY += sourceSliceHeight;
            currentY += actualSliceH;
            
            // âœ… ë‹¤ìŒ ìŠ¬ë¼ì´ìŠ¤ê°€ ë‚¨ì•„ìˆê³  ê³µê°„ì´ ë¶€ì¡±í•˜ë©´ ìƒˆ í˜ì´ì§€ ì¶”ê°€
            if (heightLeft > minSliceHeight) {
              const nextAvailableHeight = pageHeight - currentY - margin;
              if (nextAvailableHeight < minSliceHeight) {
                pdf.addPage();
                currentY = margin;
              }
            }
            
            // âœ… ë©”ëª¨ë¦¬ ì •ë¦¬
            sliceCanvas.width = 1;
            sliceCanvas.height = 1;
          }
          
          yPos = currentY;
          
          if (i < containers.length - 1) {
            pdf.addPage();
            yPos = margin;
          }
          continue;
        }
      }
      
      const el = document.getElementById(id);
      if (!el) {
        // âœ… sideReportContainerì™€ frontReportContainerëŠ” í•­ìƒ ìƒì„±ë˜ì–´ì•¼ í•˜ë¯€ë¡œ ê²½ê³  ì¶œë ¥
        console.warn(`âš ï¸ ì»¨í…Œì´ë„ˆ ì—†ìŒ: ${id} (í•­ìƒ ìƒì„±ë˜ì–´ì•¼ í•¨)`);
        continue;
      }

      // âœ… ì¸¡ë©´/ì •ë©´ ë¦¬í¬íŠ¸ëŠ” ë‚´ìš©ì´ ì—†ì–´ë„ í•­ìƒ í¬í•¨ (í•­ìƒ ìƒì„±ë˜ë¯€ë¡œ)
      if (id === 'sideReportContainer' || id === 'frontReportContainer') {
        // ë¦¬í¬íŠ¸ëŠ” í•­ìƒ ìƒì„±ë˜ë¯€ë¡œ ë‚´ìš© ê²€ì¦ ì—†ì´ ì§„í–‰
        console.log(`âœ… ${id} ë¦¬í¬íŠ¸ í¬í•¨ (í•­ìƒ ìƒì„±)`);
      } else {
        // ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆëŠ” ë‚´ìš© ê²€ì¦
      const hasContent = el.textContent.trim().length > 0 || 
                         el.querySelectorAll('img').length > 0 ||
                         el.querySelectorAll('canvas').length > 0 ||
                         el.innerHTML.trim().length > 50;
      
      if (!hasContent) {
        console.warn(`âš ï¸ ì»¨í…Œì´ë„ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤: ${id}, ìŠ¤í‚µí•©ë‹ˆë‹¤`);
        continue;
        }
      }

      try {
        console.log(`ğŸ“¸ ${id} ìº¡ì²˜ ì‹œì‘...`);
        
        // âœ… captureForPdf í•¨ìˆ˜ ì‚¬ìš© (ì´ë¯¸ ìµœì í™”ëœ ìº¡ì²˜ ë¡œì§)
        const canvas = await captureForPdf(el);
        
        if (!canvas || canvas.width === 0 || canvas.height === 0) {
          console.error(`âŒ ìº”ë²„ìŠ¤ ìƒì„± ì‹¤íŒ¨: ${id} (í¬ê¸°: ${canvas?.width}x${canvas?.height})`);
          continue;
        }
        
        console.log(`âœ… ${id} ìº¡ì²˜ ì™„ë£Œ (í¬ê¸°: ${canvas.width}x${canvas.height})`);

        // âœ… í•„ë¼í…ŒìŠ¤ í˜ì´ì§€(page5Container)ëŠ” ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë‚˜ëˆ ë„ ë˜ë¯€ë¡œ ì˜ë¦¼ ë°©ì§€ ê°•í™”
        const isPilatesPage = id === 'page5Container';

        // âœ… ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë‚˜ëˆ„ì–´ì„œ ì¶”ê°€ (A4 ìš©ì§€ì— ë§ê²Œ ìë™ ì¶•ì†Œ)
        const imgData = canvas.toDataURL('image/jpeg', 0.95); // í’ˆì§ˆ í–¥ìƒ
        
        // âœ… ì›ë³¸ ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ PDF í˜ì´ì§€ì— ë§ê²Œ ìŠ¤ì¼€ì¼ë§ (ì˜ë¦¼ ë°©ì§€)
        const canvasAspectRatio = canvas.width / canvas.height;
        const maxWidth = contentWidth; // ì—¬ë°± ì œì™¸í•œ A4 ë„ˆë¹„
        const maxHeight = pageHeight - margin * 2; // ì—¬ë°± ì œì™¸í•œ A4 ë†’ì´
        
        // âœ… ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ í˜ì´ì§€ì— ë§ê²Œ ìŠ¤ì¼€ì¼ë§ (ë„ˆë¹„ì™€ ë†’ì´ ëª¨ë‘ í™•ì¸)
        let imgWidth = maxWidth;
        let imgHeight = maxWidth / canvasAspectRatio;
        
        // âœ… ë†’ì´ê°€ í˜ì´ì§€ë¥¼ ì´ˆê³¼í•˜ë©´ ë†’ì´ ê¸°ì¤€ìœ¼ë¡œ ì¬ê³„ì‚° (ì˜ë¦¼ ë°©ì§€)
        if (imgHeight > maxHeight) {
          imgHeight = maxHeight;
          imgWidth = maxHeight * canvasAspectRatio;
        }
        
        // âœ… í•„ë¼í…ŒìŠ¤ í˜ì´ì§€ëŠ” ì›ë³¸ í¬ê¸° ìœ ì§€ (ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë‚˜ëˆ ë„ ë¨)
        if (isPilatesPage) {
          // í•„ë¼í…ŒìŠ¤ í˜ì´ì§€ëŠ” ì›ë³¸ í¬ê¸° ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì¶•ì†Œí•˜ì§€ ì•ŠìŒ)
          imgWidth = maxWidth;
          imgHeight = (canvas.height / canvas.width) * maxWidth;
        } else {
          // ë‹¤ë¥¸ í˜ì´ì§€ëŠ” ê¸°ì¡´ ë¡œì§ ìœ ì§€
          // âœ… ëª¨ë°”ì¼ì—ì„œë„ ì˜ë¦¬ì§€ ì•Šë„ë¡ ìµœì†Œ í¬ê¸° ë³´ì¥
          const minScale = 0.3; // ìµœì†Œ 30% í¬ê¸° ìœ ì§€
          if (imgWidth < canvas.width * minScale) {
            imgWidth = canvas.width * minScale;
            imgHeight = imgWidth / canvasAspectRatio;
            // ë†’ì´ë„ í™•ì¸í•˜ì—¬ ì¬ì¡°ì •
            if (imgHeight > maxHeight) {
              imgHeight = maxHeight;
              imgWidth = maxHeight * canvasAspectRatio;
            }
          }
        }
        
        // âœ… ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë‚˜ëˆ„ì–´ì„œ ì¶”ê°€ (ìœ ë™ì  í˜ì´ì§€ ë¶„í•  - ì˜ë¦¼ ë°©ì§€ ê°•í™” ë²„ì „)
        let heightLeft = imgHeight;
        let sourceY = 0; // ì›ë³¸ ìº”ë²„ìŠ¤ì—ì„œì˜ Y ìœ„ì¹˜ (í”½ì…€ ë‹¨ìœ„)

        while (heightLeft > 0) {
          // âœ… í˜„ì¬ í˜ì´ì§€ì— ì‚¬ìš© ê°€ëŠ¥í•œ ë†’ì´ ê³„ì‚° (ì—¬ìœ  ê³µê°„ í™•ë³´)
          const availableHeight = pageHeight - yPos - margin;
          
          // âœ… ìµœì†Œ ìŠ¬ë¼ì´ìŠ¤ ë†’ì´ (ë„ˆë¬´ ì‘ì€ ì¡°ê° ë°©ì§€, ê¸€ì/ì‚¬ì§„ ì˜ë¦¼ ë°©ì§€)
          // í•„ë¼í…ŒìŠ¤ í˜ì´ì§€ëŠ” ë” ì‘ì€ ì¡°ê°ë„ í—ˆìš© (ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë‚˜ëˆ ë„ ë¨)
          const minSliceHeight = isPilatesPage ? 20 : 50;
          
          // âœ… ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ìŠ¤ì¸ì§€ ë¨¼ì € í™•ì¸ (ë‚¨ì€ ë†’ì´ê°€ ê±°ì˜ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰)
          const isLastSliceNow = heightLeft <= minSliceHeight * 3;
          
          // ê³µê°„ì´ ë¶€ì¡±í•˜ë©´ ìƒˆ í˜ì´ì§€ ì¶”ê°€ (ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ìŠ¤ê°€ ì•„ë‹ˆë©´)
          if (availableHeight < minSliceHeight && heightLeft > minSliceHeight && !isLastSliceNow) {
            pdf.addPage();
            yPos = margin;
            continue;
          }
          
          // âœ… í˜„ì¬ í˜ì´ì§€ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ ë†’ì´ ê³„ì‚° (ì •í™•ë„ í–¥ìƒ)
          // ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ìŠ¤ëŠ” ë‚¨ì€ ë†’ì´ ëª¨ë‘ í¬í•¨
          const sliceH = isLastSliceNow ? heightLeft : Math.min(heightLeft, availableHeight);
          
          if (sliceH <= 0) {
            // ìŠ¬ë¼ì´ìŠ¤ ë†’ì´ê°€ 0 ì´í•˜ë©´ ìƒˆ í˜ì´ì§€ ì¶”ê°€
            pdf.addPage();
            yPos = margin;
            continue;
          }
          
          // âœ… ì›ë³¸ ìº”ë²„ìŠ¤ì—ì„œ ìŠ¬ë¼ì´ìŠ¤í•  ë†’ì´ ê³„ì‚° (í”½ì…€ ë‹¨ìœ„, ì •í™•ë„ í–¥ìƒ, ì˜¤ë²„í”Œë¡œìš° ë°©ì§€)
          // ë¹„ìœ¨ ê¸°ë°˜ ê³„ì‚°ìœ¼ë¡œ ì •í™•ë„ í–¥ìƒ
          const scaleRatio = canvas.height / imgHeight;
          
          // âœ… ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ìŠ¤ëŠ” ë‚¨ì€ ë¶€ë¶„ ëª¨ë‘ í¬í•¨ (ì˜ë¦¼ ë°©ì§€)
          const isLastSlice = heightLeft <= sliceH * 1.1; // ë§ˆì§€ë§‰ 10% ë²”ìœ„
          let sourceSliceHeight;
          
          if (isLastSlice) {
            // ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ìŠ¤: ë‚¨ì€ ë¶€ë¶„ ëª¨ë‘ í¬í•¨
            const remainingHeight = canvas.height - sourceY;
            sourceSliceHeight = Math.max(remainingHeight, Math.round(sliceH * scaleRatio));
          } else {
            // ì¼ë°˜ ìŠ¬ë¼ì´ìŠ¤: Math.roundë¡œ ì •í™•ë„ í–¥ìƒ
            sourceSliceHeight = Math.min(
              Math.round(sliceH * scaleRatio), // Math.roundë¡œ ë³€ê²½ (ë” ì •í™•)
              canvas.height - sourceY // ì›ë³¸ ìº”ë²„ìŠ¤ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡
            );
          }
          
          if (sourceSliceHeight <= 0 || sourceY >= canvas.height) {
            // ìŠ¬ë¼ì´ìŠ¤í•  ë†’ì´ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ëì— ë„ë‹¬í–ˆìœ¼ë©´ ì¢…ë£Œ
            break;
          }
          
          // âœ… ìº”ë²„ìŠ¤ ìŠ¬ë¼ì´ìŠ¤ ìƒì„±
          const sliceCanvas = document.createElement('canvas');
          sliceCanvas.width = canvas.width;
          sliceCanvas.height = sourceSliceHeight;
          const ctx = sliceCanvas.getContext('2d');
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          
          // âœ… ì›ë³¸ ìº”ë²„ìŠ¤ì—ì„œ ìŠ¬ë¼ì´ìŠ¤ ì¶”ì¶œ (ì •í™•í•œ ìœ„ì¹˜ì—ì„œ, ì˜ë¦¼ ë°©ì§€)
          ctx.drawImage(
            canvas, 
            0, sourceY, canvas.width, sourceSliceHeight,  // ì›ë³¸ ì˜ì—­
            0, 0, canvas.width, sourceSliceHeight         // ëŒ€ìƒ ì˜ì—­
          );

          // âœ… PDFì— ì¶”ê°€ ì‹œ ì •í™•í•œ ë†’ì´ ì‚¬ìš© (ì˜ë¦¼ ë°©ì§€)
          const actualSliceH = Math.min(sliceH, availableHeight);
          pdf.addImage(sliceCanvas.toDataURL('image/jpeg', 0.95), 'JPEG', margin, yPos, imgWidth, actualSliceH, undefined, 'FAST');
          
          // âœ… ë‹¤ìŒ ìŠ¬ë¼ì´ìŠ¤ ì¤€ë¹„
          heightLeft -= sliceH;
          sourceY += sourceSliceHeight;
          yPos += actualSliceH;
          
          // âœ… ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ìŠ¤ì¸ì§€ í™•ì¸ (ë‚¨ì€ ë†’ì´ê°€ ê±°ì˜ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰)
          const isLastSliceCheck = heightLeft <= minSliceHeight * 2;
          
          // âœ… ë‹¤ìŒ ìŠ¬ë¼ì´ìŠ¤ê°€ ë‚¨ì•„ìˆê³  ê³µê°„ì´ ë¶€ì¡±í•˜ë©´ ìƒˆ í˜ì´ì§€ ì¶”ê°€
          if (heightLeft > minSliceHeight && !isLastSliceCheck) {
            const nextAvailableHeight = pageHeight - yPos - margin;
            if (nextAvailableHeight < minSliceHeight) {
              pdf.addPage();
              yPos = margin;
            }
          }
          
          // âœ… ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ìŠ¤ëŠ” ë‚¨ì€ ëª¨ë“  ë†’ì´ í¬í•¨ (ì˜ë¦¼ ë°©ì§€)
          if (isLastSliceCheck && heightLeft > 0) {
            const finalAvailableHeight = pageHeight - yPos - margin;
            if (finalAvailableHeight < heightLeft) {
              // ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ìŠ¤ê°€ í˜ì´ì§€ì— ë‹¤ ì•ˆ ë“¤ì–´ê°€ë©´ ìƒˆ í˜ì´ì§€ì— ì¶”ê°€
              pdf.addPage();
              yPos = margin;
            }
            // ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ìŠ¤ëŠ” ë‚¨ì€ ë†’ì´ ëª¨ë‘ í¬í•¨
            const finalSliceH = Math.min(heightLeft, pageHeight - yPos - margin);
            const finalSourceSliceHeight = Math.min(
              Math.round(finalSliceH * scaleRatio),
              canvas.height - sourceY
            );
            
            if (finalSourceSliceHeight > 0 && sourceY < canvas.height) {
              const finalSliceCanvas = document.createElement('canvas');
              finalSliceCanvas.width = canvas.width;
              finalSliceCanvas.height = finalSourceSliceHeight;
              const finalCtx = finalSliceCanvas.getContext('2d');
              finalCtx.imageSmoothingEnabled = true;
              finalCtx.imageSmoothingQuality = 'high';
              
              finalCtx.drawImage(
                canvas,
                0, sourceY, canvas.width, finalSourceSliceHeight,
                0, 0, canvas.width, finalSourceSliceHeight
              );
              
              pdf.addImage(finalSliceCanvas.toDataURL('image/jpeg', 0.95), 'JPEG', margin, yPos, imgWidth, finalSliceH, undefined, 'FAST');
              yPos += finalSliceH;
              
              finalSliceCanvas.width = 1;
              finalSliceCanvas.height = 1;
            }
            break; // ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ìŠ¤ ì²˜ë¦¬ ì™„ë£Œ
          }
          
          // âœ… ë©”ëª¨ë¦¬ ì •ë¦¬
          sliceCanvas.width = 1;
          sliceCanvas.height = 1;
        }

        // âœ… ë©”ëª¨ë¦¬ ì •ë¦¬
        canvas.width = 1;
        canvas.height = 1;

        // âœ… ë‹¤ìŒ ì»¨í…Œì´ë„ˆë¥¼ ìœ„í•´ ìƒˆ í˜ì´ì§€ ì¶”ê°€ (ë§ˆì§€ë§‰ ì»¨í…Œì´ë„ˆê°€ ì•„ë‹ˆë©´)
        if (i < containers.length - 1) {
          pdf.addPage();
          yPos = margin;
        }
      } catch (err) {
        console.error(`âŒ ${id} ìº¡ì²˜ ì‹¤íŒ¨:`, err);
        // ì—ëŸ¬ê°€ ë‚˜ë„ ë‹¤ìŒ í˜ì´ì§€ ê³„ì† ì§„í–‰
        continue;
      }
    }

    // âœ… PDF ìƒì„± ì™„ë£Œ í›„ ì»¨í…Œì´ë„ˆ ì •ë¦¬
    const containerIds = ['sideImageContainer', 'sideOverlayContainer', 'sideReportContainer', 
                          'frontImageContainer', 'frontOverlayContainer', 'frontReportContainer',
                          'page4Container', 'page5Container', 'page8Container', 'page7Container'];
    containerIds.forEach(id => {
      const elem = document.getElementById(id);
      if (elem && document.body.contains(elem)) {
        document.body.removeChild(elem);
      }
    });

    // ì €ì¥
    console.log("ğŸ’¾ PDF ì €ì¥ ì¤‘...");
    const finalCenterName = centerName || 'DIT';
    const finalMemberName = memberName || 'íšŒì›';
    const filename = `${finalCenterName}_${finalMemberName}_ìì„¸ë¶„ì„ë¦¬í¬íŠ¸.pdf`;
    pdf.save(filename);
    console.log(`âœ… PDF ì €ì¥ ì™„ë£Œ: ${filename}`);
    alert("PDF ìƒì„± ì™„ë£Œ! ëª¨ë“  í˜ì´ì§€ì— ë‚´ìš©ì´ ì •ìƒ ì¶œë ¥ë©ë‹ˆë‹¤.");

  } catch (err) {
    console.error("PDF ì˜¤ë¥˜:", err);
    alert("PDF ìƒì„± ì‹¤íŒ¨: " + err.message);
  }
}

/* ================== CSV ê¸°ë°˜ AI ê·¼ìœ¡-ìš´ë™ ë§¤ì¹­ ì—”ì§„ ================== */

// ë©”íŠ¸ë¦­ ë°ì´í„°ë² ì´ìŠ¤ CSV (ê°„ì†Œí™” ë²„ì „)
const METRICS_CSV = `Index_Code,Metric_Code,Metric_Name_KR,Metric_Name_EN,Deviation_Label,Tight_Muscle,Weak_Muscle,Recommended_Strategy,Notes
CVA_LOW,CVA,ê²½ì¶” ì „ë§Œê°,Craniocervical Angle,ë‚®ìŒ,"ìƒë¶€ ìŠ¹ëª¨ê·¼, ê²¬ê°‘ê±°ê·¼, í‰ì‡„ìœ ëŒê·¼","ì‹¬ë¶€ëª©êµ´ê³¡ê·¼, í•˜ë¶€ ìŠ¹ëª¨ê·¼, ì „ê±°ê·¼","ê²½ì¶” ì‹ ì „ê·¼ ì´ì™„ + ì‹¬ë¶€ êµ´ê³¡ê·¼ í™œì„±","Forward head posture"
CVA_HIGH,CVA,ê²½ì¶” ì „ë§Œê°,Craniocervical Angle,ë†’ìŒ,"í›„ê²½ë¶€ ë‹¨ì¶•ê·¼, í›„ë‘í•˜ê·¼","ì „ê²½ë¶€ ì•ˆì •ê·¼, ì „í‰ê·¼","ê²½ì¶” ì •ë ¬ íšŒë³µ, í›„ë‘ ì´ì™„","ê³¼ì‹ ì „ íŒ¨í„´"
PTA_ANT,PTA,ê³¨ë°˜ ì „í›„ê²½ì‚¬ê°,Pelvic Tilt,ì „ë°©ê²½ì‚¬,"ì¥ìš”ê·¼, ëŒ€í‡´ì§ê·¼, ì²™ì¶”ê¸°ë¦½ê·¼","ë³µì§ê·¼, ë³µíš¡ê·¼, ë‘”ê·¼","ê³ ê´€ì ˆ êµ´ê·¼ ìŠ¤íŠ¸ë ˆì¹˜ + ë‘”ê·¼ ê°•í™”","Anterior pelvic tilt"
PTA_POST,PTA,ê³¨ë°˜ ì „í›„ê²½ì‚¬ê°,Pelvic Tilt,í›„ë°©ê²½ì‚¬,"í–„ìŠ¤íŠ¸ë§, ë³µì§ê·¼","ì¥ìš”ê·¼, ì²™ì¶”ê¸°ë¦½ê·¼","í–„ìŠ¤íŠ¸ë§ ì´ì™„ + ìš”ì¶” ì „ë§Œ íšŒë³µ","Posterior pelvic tilt"
SAA_HIGH,SAA,ì–´ê¹¨ ì „ë°©ê°,Shoulder Anterior Angle,ë†’ìŒ,"ëŒ€í‰ê·¼, ì†Œí‰ê·¼, ì „ë©´ ì‚¼ê°ê·¼","ì¤‘ë¶€/í•˜ë¶€ ìŠ¹ëª¨ê·¼, ëŠ¥í˜•ê·¼","í‰ê·¼ ì´ì™„ + ê²¬ê°‘ í›„ë°© ì•ˆì •","ë¼ìš´ë“œ ìˆ„ë”"
POA_LEFT,POA,ê³¨ë°˜ ê¸°ìš¸ê¸°,Pelvic Obliquity,ì¢Œí•˜ê°•,"ì¢Œì¸¡ í–„ìŠ¤íŠ¸ë§, QL","ìš°ì¸¡ ì¤‘ë‘”ê·¼","ì¸¡ë©´ ê· í˜•","Left hip drop"
POA_RIGHT,POA,ê³¨ë°˜ ê¸°ìš¸ê¸°,Pelvic Obliquity,ìš°í•˜ê°•,"ìš°ì¸¡ í–„ìŠ¤íŠ¸ë§, QL","ì¢Œì¸¡ ì¤‘ë‘”ê·¼","ì¸¡ë©´ ê· í˜•","Right hip drop"`;

// í•„ë¼í…ŒìŠ¤ ìš´ë™ ë°ì´í„°ë² ì´ìŠ¤ (ê°„ì†Œí™” ë²„ì „ - ì‹¤ì œë¡œëŠ” CSV íŒŒì¼ì—ì„œ ë¡œë“œ)
const PILATES_DB_SAMPLE = {
  mat: [
    { Exercise_Name_KR: 'í”Œë­í¬', Main_Strengthen_Muscles: 'ë³µì§ê·¼, ë³µíš¡ê·¼, ì „ê±°ê·¼', Main_Stretch_Muscles: '', Reps: '30ì´ˆ 3ì„¸íŠ¸' },
    { Exercise_Name_KR: 'ë°ë“œë²„ê·¸', Main_Strengthen_Muscles: 'ë³µíš¡ê·¼, ê³¨ë°˜ì €ê·¼', Main_Stretch_Muscles: '', Reps: '10íšŒ 3ì„¸íŠ¸' },
    { Exercise_Name_KR: 'í™ ì“°ëŸ¬ìŠ¤íŠ¸', Main_Strengthen_Muscles: 'ëŒ€ë‘”ê·¼, í–„ìŠ¤íŠ¸ë§', Main_Stretch_Muscles: '', Reps: '15íšŒ 3ì„¸íŠ¸' },
    { Exercise_Name_KR: 'ê³ ê´€ì ˆ êµ´ê³¡ê·¼ ìŠ¤íŠ¸ë ˆì¹˜', Main_Strengthen_Muscles: '', Main_Stretch_Muscles: 'ì¥ìš”ê·¼, ëŒ€í‡´ì§ê·¼', Reps: '30ì´ˆ 3ì„¸íŠ¸' },
    { Exercise_Name_KR: 'í–„ìŠ¤íŠ¸ë§ ìŠ¤íŠ¸ë ˆì¹˜', Main_Strengthen_Muscles: '', Main_Stretch_Muscles: 'í–„ìŠ¤íŠ¸ë§', Reps: '30ì´ˆ 3ì„¸íŠ¸' },
    { Exercise_Name_KR: 'í‰ê·¼ ìŠ¤íŠ¸ë ˆì¹˜', Main_Strengthen_Muscles: '', Main_Stretch_Muscles: 'ëŒ€í‰ê·¼, ì†Œí‰ê·¼', Reps: '30ì´ˆ 3ì„¸íŠ¸' },
    { Exercise_Name_KR: 'ìƒë¶€ ìŠ¹ëª¨ê·¼ ìŠ¤íŠ¸ë ˆì¹˜', Main_Strengthen_Muscles: '', Main_Stretch_Muscles: 'ìƒë¶€ ìŠ¹ëª¨ê·¼', Reps: '30ì´ˆ 3ì„¸íŠ¸' },
    { Exercise_Name_KR: 'ëŠ¥í˜•ê·¼ ê°•í™”', Main_Strengthen_Muscles: 'ëŠ¥í˜•ê·¼, ì¤‘ë¶€ ìŠ¹ëª¨ê·¼', Main_Stretch_Muscles: '', Reps: '15íšŒ 3ì„¸íŠ¸' }
  ]
};

// CSV íŒŒì‹± í•¨ìˆ˜ (ë‹¨ìˆœ ë²„ì „ - ë©”íŠ¸ë¦­ìš©)
function parseCSVSimple(csv) {
  const lines = csv.trim().split('\n');
  const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
  return lines.slice(1).map(line => {
    const values = line.split(',').map(v => v.replace(/^"|"$/g, '').trim());
    return headers.reduce((obj, h, i) => {
      obj[h] = values[i] || '';
      return obj;
    }, {});
  });
}

// ë©”íŠ¸ë¦­ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì‹±
const METRICS_DB = parseCSVSimple(METRICS_CSV);

// âœ… AI ê·¼ìœ¡-ìš´ë™ ë§¤ì¹­ í•¨ìˆ˜ (ì‹¤ì œ CSV DB ê¸°ë°˜)
function recommendPilatesFromMuscles(tightMuscles, weakMuscles) {
  const recommendations = [];
  const seen = new Set();
  
  // âœ… ì‹¤ì œ ë¡œë“œëœ í•„ë¼í…ŒìŠ¤ DB ì‚¬ìš© (CSVì—ì„œ ë¡œë“œë¨)
  const allPilates = window.PilatesDB || PILATES_EXERCISE_DB || [];
  
  if (!allPilates || allPilates.length === 0) {
    console.warn('âš ï¸ í•„ë¼í…ŒìŠ¤ DBê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©');
    // í´ë°±: ìƒ˜í”Œ ë°ì´í„°
    const fallbackPilates = Object.values(PILATES_DB_SAMPLE).flat();
    return recommendPilatesFromMusclesLegacy(tightMuscles, weakMuscles, fallbackPilates);
  }
  
  console.log('âœ… í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ì‹œì‘:', { tight: tightMuscles, weak: weakMuscles, dbSize: allPilates.length });
  
  // ê·¼ìœ¡ ì´ë¦„ ì •ê·œí™”
  const normalizeMuscle = (m) => m.trim().replace(/\s+/g, ' ');
  const tightSet = new Set((tightMuscles || []).map(normalizeMuscle));
  const weakSet = new Set((weakMuscles || []).map(normalizeMuscle));
  
  // 1. ì•½í•œ ê·¼ìœ¡(Weak_Muscle) ê°•í™” ìš´ë™ ì¶”ì²œ â†’ Main_Strengthen_Muscles ë§¤ì¹­
  if (weakSet.size > 0) {
    allPilates.forEach(ex => {
      const strengthenStr = ex.Main_Strengthen_Muscles || 
                            ex['Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)'] ||
                            ex.strengthen_targets?.join(', ') || '';
      if (!strengthenStr) return;
      
      const strengthenMuscles = splitMuscleList(strengthenStr).map(normalizeMuscle);
      const matched = strengthenMuscles.some(target => 
        Array.from(weakSet).some(weak => 
          target.includes(weak) || weak.includes(target) || target === weak
        )
      );
      
      if (matched) {
        const key = ex.exercise_ko || ex.Exercise_Name_KR || ex.name;
        if (key && !seen.has(key)) {
          seen.add(key);
          recommendations.push({
            ...ex,  // âœ… ì „ì²´ ìš´ë™ ì •ë³´ í¬í•¨
            name: key,
            type: 'ê°•í™”',
            target: strengthenMuscles.find(t => Array.from(weakSet).some(w => t.includes(w) || w.includes(t))) || strengthenMuscles[0],
            reps: ex.Reps || ex.sets_reps || '3ì„¸íŠ¸',
            equip: ex.equipment_ko || ex.equipment || 'ë§¤íŠ¸'
          });
        }
      }
    });
  }
  
  // 2. ê¸´ì¥ëœ ê·¼ìœ¡(Tight_Muscle) ìŠ¤íŠ¸ë ˆì¹˜ ìš´ë™ ì¶”ì²œ â†’ Main_Stretch_Muscles ë§¤ì¹­
  if (tightSet.size > 0) {
    allPilates.forEach(ex => {
      const stretchStr = ex.Main_Stretch_Muscles || 
                         ex['Main_Stretch_Muscles (ì£¼ìš” ìŠ¤íŠ¸ë ˆì¹­ ê·¼ìœ¡)'] ||
                         ex.stretch_targets?.join(', ') || '';
      if (!stretchStr) return;
      
      const stretchMuscles = splitMuscleList(stretchStr).map(normalizeMuscle);
      const matched = stretchMuscles.some(target => 
        Array.from(tightSet).some(tight => 
          target.includes(tight) || tight.includes(target) || target === tight
        )
      );
      
      if (matched) {
        const key = ex.exercise_ko || ex.Exercise_Name_KR || ex.name;
        if (key && !seen.has(key)) {
          seen.add(key);
          recommendations.push({
            ...ex,  // âœ… ì „ì²´ ìš´ë™ ì •ë³´ í¬í•¨
            name: key,
            type: 'ìŠ¤íŠ¸ë ˆì¹˜',
            target: stretchMuscles.find(t => Array.from(tightSet).some(ti => t.includes(ti) || ti.includes(t))) || stretchMuscles[0],
            reps: ex.Reps || ex.sets_reps || '30ì´ˆ 3ì„¸íŠ¸',
            equip: ex.equipment_ko || ex.equipment || 'ë§¤íŠ¸'
          });
        }
      }
    });
  }
  
  // âœ… ê¸°ë¦½ê·¼/ë³µì§ê·¼ ë¬¸ì œ ê°ì§€ ì‹œ ì½”ì–´ ìš´ë™ ì¶”ê°€
  const hasErectorProblem = Array.from(tightSet).some(m => 
    m.includes('ê¸°ë¦½ê·¼') || m.includes('erector') || m.includes('spine erector')
  ) || Array.from(weakSet).some(m => 
    m.includes('ê¸°ë¦½ê·¼') || m.includes('erector') || m.includes('spine erector')
  );
  
  const hasRectusProblem = Array.from(tightSet).some(m => 
    m.includes('ë³µì§ê·¼') || m.includes('rectus')
  ) || Array.from(weakSet).some(m => 
    m.includes('ë³µì§ê·¼') || m.includes('rectus')
  );
  
  if (hasErectorProblem || hasRectusProblem) {
    console.log('ğŸ” ê¸°ë¦½ê·¼/ë³µì§ê·¼ ë¬¸ì œ ê°ì§€ â†’ ì½”ì–´ ìš´ë™ ì¶”ê°€ ê²€ìƒ‰');
    
    // âœ… ì½”ì–´ ìš´ë™ í•„í„°ë§ (Main_Strengthen_Musclesì— ì½”ì–´ ê´€ë ¨ í‚¤ì›Œë“œ í¬í•¨)
    const coreKeywords = ['ì½”ì–´', 'core', 'ë³µì§ê·¼', 'ë³µíš¡ê·¼', 'ë³µì‚¬ê·¼', 'rectus', 'transverse', 'abdominis'];
    const coreExercises = allPilates.filter((ex) => {
      const strengthenStr = ex.Main_Strengthen_Muscles || 
                           ex['Main_Strengthen_Muscles (ì£¼ìš” ê°•í™” ê·¼ìœ¡)'] || 
                           (ex.strengthen_targets ? ex.strengthen_targets.join(', ') : '');
      
      if (!strengthenStr) return false;
      
      // ì½”ì–´ ê´€ë ¨ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
      const hasCoreKeyword = coreKeywords.some(keyword => 
        strengthenStr.toLowerCase().includes(keyword.toLowerCase())
      );
      
      return hasCoreKeyword;
    });
    
    // âœ… ì´ë¯¸ ì¶”ì²œëœ ìš´ë™ ì œì™¸í•˜ê³  ì½”ì–´ ìš´ë™ ì¶”ê°€
    const recommendedNames = new Set(
      recommendations.map(r => r.name || r.exercise_ko || r.Exercise_Name_KR)
    );
    
    const additionalCoreExercises = coreExercises
      .filter(ex => {
        const exName = ex.exercise_ko || ex.Exercise_Name_KR || ex.name;
        return exName && !recommendedNames.has(exName);
      })
      .slice(0, 5) // ìµœì†Œ 3-5ê°œ ì¶”ê°€
      .map(ex => {
        const key = ex.exercise_ko || ex.Exercise_Name_KR || ex.name;
        return {
          ...ex,
          name: key,
          type: 'ì½”ì–´',
          target: 'ì½”ì–´ ì•ˆì •ì„±',
          reps: ex.Reps || ex.sets_reps || '3ì„¸íŠ¸',
          equip: ex.equipment_ko || ex.equipment || 'ë§¤íŠ¸'
        };
      });
    
    if (additionalCoreExercises.length > 0) {
      recommendations.push(...additionalCoreExercises);
      console.log(`âœ… ì½”ì–´ ìš´ë™ ${additionalCoreExercises.length}ê°œ ì¶”ê°€:`, 
        additionalCoreExercises.map(e => e.name).join(', '));
    }
  }
  
  console.log('âœ… í•„ë¼í…ŒìŠ¤ ì¶”ì²œ ì™„ë£Œ:', recommendations.length, 'ê°œ');
  return recommendations.slice(0, 15); // ìµœëŒ€ 15ê°œ ì¶”ì²œ (ê¸°ë³¸ 10ê°œ + ì½”ì–´ 5ê°œ)
}

// ë ˆê±°ì‹œ ìƒ˜í”Œ ë°ì´í„°ìš© í•¨ìˆ˜
function recommendPilatesFromMusclesLegacy(tightMuscles, weakMuscles, allPilates) {
  const recommendations = [];
  const seen = new Set();
  
  if (weakMuscles && weakMuscles.length > 0) {
    weakMuscles.forEach(muscle => {
      allPilates.forEach(ex => {
        if (ex.Main_Strengthen_Muscles && 
            ex.Main_Strengthen_Muscles.includes(muscle) && 
            !seen.has(ex.Exercise_Name_KR)) {
          seen.add(ex.Exercise_Name_KR);
          recommendations.push({
            name: ex.Exercise_Name_KR,
            type: 'ê°•í™”',
            target: muscle,
            reps: ex.Reps || '3ì„¸íŠ¸',
            equip: 'Mat'
          });
        }
      });
    });
  }
  
  if (tightMuscles && tightMuscles.length > 0) {
    tightMuscles.forEach(muscle => {
      allPilates.forEach(ex => {
        if (ex.Main_Stretch_Muscles && 
            ex.Main_Stretch_Muscles.includes(muscle) && 
            !seen.has(ex.Exercise_Name_KR)) {
          seen.add(ex.Exercise_Name_KR);
          recommendations.push({
            name: ex.Exercise_Name_KR,
            type: 'ìŠ¤íŠ¸ë ˆì¹˜',
            target: muscle,
            reps: ex.Reps || '30ì´ˆ 3ì„¸íŠ¸',
            equip: 'Mat'
          });
        }
      });
    });
  }
  
  return recommendations.slice(0, 8);
}

// âœ… ì‹¤ì œ ë¶„ì„ ê²°ê³¼ì—ì„œ ê·¼ìœ¡ ìƒíƒœ ì¶”ì¶œ
function extractMuscleStatus(analysis) {
  const tight = [];
  const weak = [];
  
  if (!analysis) return { tight, weak };
  
  // âœ… 1ìˆœìœ„: analysis.tight, analysis.weak ì§ì ‘ í™•ì¸ (analyzeMusclesWithDB ë°˜í™˜ê°’)
  if (Array.isArray(analysis.tight)) {
    tight.push(...analysis.tight);
  }
  if (Array.isArray(analysis.weak)) {
    weak.push(...analysis.weak);
  }
  
  // âœ… 2ìˆœìœ„: analysis.muscles ê°ì²´ í™•ì¸
  if (analysis.muscles) {
    if (analysis.muscles.tight) {
      if (analysis.muscles.tight instanceof Set) {
        tight.push(...Array.from(analysis.muscles.tight));
      } else if (Array.isArray(analysis.muscles.tight)) {
        tight.push(...analysis.muscles.tight);
      }
    }
    
    if (analysis.muscles.weak) {
      if (analysis.muscles.weak instanceof Set) {
        weak.push(...Array.from(analysis.muscles.weak));
      } else if (Array.isArray(analysis.muscles.weak)) {
        weak.push(...analysis.muscles.weak);
      }
    }
  }
  
  // âœ… 3ìˆœìœ„: analysis.topRecommendationsì—ì„œ ê·¼ìœ¡ ì¶”ì¶œ (CSV DB ê¸°ë°˜)
  if (Array.isArray(analysis.topRecommendations) && analysis.topRecommendations.length > 0) {
    analysis.topRecommendations.forEach(rec => {
      if (Array.isArray(rec.tightMuscles)) {
        rec.tightMuscles.forEach(m => {
          if (m && typeof m === 'string') tight.push(m.trim());
        });
      }
      if (Array.isArray(rec.weakMuscles)) {
        rec.weakMuscles.forEach(m => {
          if (m && typeof m === 'string') weak.push(m.trim());
        });
      }
    });
  }
  
  // ì¤‘ë³µ ì œê±°
  return { 
    tight: [...new Set(tight.filter(Boolean))], 
    weak: [...new Set(weak.filter(Boolean))] 
  };
}

// âœ… ì¸¡ë©´/ì •ë©´ ë¶„ì„ ê²°ê³¼ í†µí•© (ê·¼ìœ¡ ìƒíƒœ ê°•í™”)
function getCombinedAnalysis() {
  // âœ… ì¸¡ë©´ ë¶„ì„: Before/After ì„¸ì…˜ì—ì„œ ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ ì°¾ê¸°
  let sideAnalysis = null;
  let sideScore = 0;
  let sidePattern = 'ë¶„ì„ ì¤‘';
  
  // 1ìˆœìœ„: After ì„¸ì…˜ì˜ sideAnalysis (ì¸¡ë©´ ë¶„ì„ ê²°ê³¼)
  if (sessions.After?.sideAnalysis && sessions.After.sideAnalysis.orientation === "side") {
    sideAnalysis = sessions.After.sideAnalysis;
    sideScore = sessions.After.score?.score || sessions.After.sideAnalysis?.score || 0;
    sidePattern = sessions.After.sideAnalysis?.topRecommendations?.[0]?.name || 
                  sessions.After.sideAnalysis?.patterns?.[0]?.name || 'ë¶„ì„ ì¤‘';
  }
  // 2ìˆœìœ„: Before ì„¸ì…˜ì˜ sideAnalysis
  else if (sessions.Before?.sideAnalysis && sessions.Before.sideAnalysis.orientation === "side") {
    sideAnalysis = sessions.Before.sideAnalysis;
    sideScore = sessions.Before.score?.score || sessions.Before.sideAnalysis?.score || 0;
    sidePattern = sessions.Before.sideAnalysis?.topRecommendations?.[0]?.name || 
                  sessions.Before.sideAnalysis?.patterns?.[0]?.name || 'ë¶„ì„ ì¤‘';
  }
  // 3ìˆœìœ„: í˜„ì¬ ì„¸ì…˜ì˜ sideAnalysis
  else if (sessions[cur]?.sideAnalysis && sessions[cur].sideAnalysis.orientation === "side") {
    sideAnalysis = sessions[cur].sideAnalysis;
    sideScore = sessions[cur].score?.score || sessions[cur].sideAnalysis?.score || 0;
    sidePattern = sessions[cur].sideAnalysis?.topRecommendations?.[0]?.name || 
                  sessions[cur].sideAnalysis?.patterns?.[0]?.name || 'ë¶„ì„ ì¤‘';
  }
  // 4ìˆœìœ„: After ì„¸ì…˜ì˜ analysis (orientation í™•ì¸)
  else if (sessions.After?.analysis && sessions.After.metrics?.orientation === "side") {
    sideAnalysis = sessions.After.analysis;
    sideScore = sessions.After.score?.score || sessions.After.analysis?.score || 0;
    sidePattern = sessions.After.analysis?.topRecommendations?.[0]?.name || 
                  sessions.After.analysis?.patterns?.[0]?.name || 'ë¶„ì„ ì¤‘';
  }
  // 5ìˆœìœ„: í˜„ì¬ ì„¸ì…˜ì˜ analysis (orientation í™•ì¸)
  else if (sessions[cur]?.analysis && sessions[cur].metrics?.orientation === "side") {
    sideAnalysis = sessions[cur].analysis;
    sideScore = sessions[cur].score?.score || sessions[cur].analysis?.score || 0;
    sidePattern = sessions[cur].analysis?.topRecommendations?.[0]?.name || 
                  sessions[cur].analysis?.patterns?.[0]?.name || 'ë¶„ì„ ì¤‘';
  }
  // 6ìˆœìœ„: After ì„¸ì…˜ì˜ ë¶„ì„ (orientation ë¶ˆëª…í™•)
  else if (sessions.After?.analysis) {
    sideAnalysis = sessions.After.analysis;
    sideScore = sessions.After.score?.score || sessions.After.analysis?.score || 0;
    sidePattern = sessions.After.analysis?.topRecommendations?.[0]?.name || 
                  sessions.After.analysis?.patterns?.[0]?.name || 'ë¶„ì„ ì¤‘';
  }
  
  // âœ… ì •ë©´ ë¶„ì„: After ì„¸ì…˜ì˜ ì •ë©´ ë¶„ì„ ê²°ê³¼ ì°¾ê¸°
  let frontAnalysis = null;
  let frontScore = 0;
  let frontPattern = 'ë¶„ì„ ì¤‘';
  
  // 1ìˆœìœ„: After ì„¸ì…˜ì˜ frontAnalysis (ì •ë©´ ë¶„ì„ ê²°ê³¼)
  if (sessions.After?.frontAnalysis && sessions.After.frontAnalysis.orientation === "front") {
    frontAnalysis = sessions.After.frontAnalysis;
    frontScore = sessions.After.score?.score || sessions.After.frontAnalysis?.score || 0;
    frontPattern = sessions.After.frontAnalysis?.topRecommendations?.[0]?.name || 
                   sessions.After.frontAnalysis?.patterns?.[0]?.name || 'ë¶„ì„ ì¤‘';
  }
  // 2ìˆœìœ„: Before ì„¸ì…˜ì˜ frontAnalysis
  else if (sessions.Before?.frontAnalysis && sessions.Before.frontAnalysis.orientation === "front") {
    frontAnalysis = sessions.Before.frontAnalysis;
    frontScore = sessions.Before.score?.score || sessions.Before.frontAnalysis?.score || 0;
    frontPattern = sessions.Before.frontAnalysis?.topRecommendations?.[0]?.name || 
                   sessions.Before.frontAnalysis?.patterns?.[0]?.name || 'ë¶„ì„ ì¤‘';
  }
  // 3ìˆœìœ„: í˜„ì¬ ì„¸ì…˜ì˜ frontAnalysis
  else if (sessions[cur]?.frontAnalysis && sessions[cur].frontAnalysis.orientation === "front") {
    frontAnalysis = sessions[cur].frontAnalysis;
    frontScore = sessions[cur].score?.score || sessions[cur].frontAnalysis?.score || 0;
    frontPattern = sessions[cur].frontAnalysis?.topRecommendations?.[0]?.name || 
                   sessions[cur].frontAnalysis?.patterns?.[0]?.name || 'ë¶„ì„ ì¤‘';
  }
  // 4ìˆœìœ„: After ì„¸ì…˜ì˜ analysis (orientation í™•ì¸)
  else if (sessions.After?.analysis && sessions.After.metrics?.orientation === "front") {
    frontAnalysis = sessions.After.analysis;
    frontScore = sessions.After.score?.score || sessions.After.analysis?.score || 0;
    frontPattern = sessions.After.analysis?.topRecommendations?.[0]?.name || 
                   sessions.After.analysis?.patterns?.[0]?.name || 'ë¶„ì„ ì¤‘';
  }
  // 5ìˆœìœ„: After ì„¸ì…˜ì˜ frontMetricsê°€ ìˆëŠ” ê²½ìš°
  else if (sessions.After?.metrics?.frontMetrics && sessions.After.analysis) {
    frontAnalysis = sessions.After.analysis;
    frontScore = sessions.After.score?.score || sessions.After.analysis?.score || 0;
    frontPattern = sessions.After.analysis?.topRecommendations?.[0]?.name || 
                   sessions.After.analysis?.patterns?.[0]?.name || 'ë¶„ì„ ì¤‘';
  }
  // 6ìˆœìœ„: í˜„ì¬ ì„¸ì…˜ì˜ analysis (orientation í™•ì¸)
  else if (sessions[cur]?.analysis && sessions[cur].metrics?.orientation === "front") {
    frontAnalysis = sessions[cur].analysis;
    frontScore = sessions[cur].score?.score || sessions[cur].analysis?.score || 0;
    frontPattern = sessions[cur].analysis?.topRecommendations?.[0]?.name || 
                   sessions[cur].analysis?.patterns?.[0]?.name || 'ë¶„ì„ ì¤‘';
  }
  
  // ê·¼ìœ¡ ìƒíƒœ ì¶”ì¶œ
  const sideMuscles = extractMuscleStatus(sideAnalysis);
  const frontMuscles = extractMuscleStatus(frontAnalysis);
  
  // í†µí•© ê·¼ìœ¡ ìƒíƒœ
  const combinedTight = [...new Set([...sideMuscles.tight, ...frontMuscles.tight])];
  const combinedWeak = [...new Set([...sideMuscles.weak, ...frontMuscles.weak])];
  
  return {
    side: {
      score: sideScore,
      tight: sideMuscles.tight,
      weak: sideMuscles.weak,
      pattern: sidePattern
    },
    front: {
      score: frontScore,
      tight: frontMuscles.tight,
      weak: frontMuscles.weak,
      pattern: frontPattern
    },
    combined: {
      tight: combinedTight,
      weak: combinedWeak
    }
  };
}

/* ================== PDF ë²„íŠ¼ì— ìƒˆ í•¨ìˆ˜ ì—°ê²° ================== */
// ê¸°ì¡´ setupPDFButtonì—ì„œ ìƒˆ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
// ë˜ëŠ” setupPDFButton ë‚´ë¶€ì—ì„œ generateFinalPostureReportPDFë¥¼ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½ ê°€ëŠ¥
</script>
  </body>
</html>
