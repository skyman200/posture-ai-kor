<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DIT ìì„¸ ë¶„ì„ AI â€” Before/After + PDF + ëª¨ë°”ì¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --ink:#e7eef7; --muted:#9bb0c7; --accent:#7c9cff; --bad:#ff6b6b; --ok:#ffd166; --good:#2ec4b6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,#0b0f14 0%, #0e1520 100%); color:var(--ink); font:14px/1.6 "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Noto Sans, Helvetica, Arial}
    .wrap{display:grid; grid-template-columns: 340px 1fr; gap:16px; padding:16px; height:100vh}
    .panel{background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:16px; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.25)}
    .sidebar{padding:16px; overflow:auto}
    .title{font-size:18px; font-weight:800; margin-bottom:6px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .row + .row{margin-top:10px}
    .seg{display:flex; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:10px; overflow:hidden}
    .seg button{flex:1; padding:8px 10px; color:var(--muted); background:transparent; border:0; cursor:pointer}
    .seg button.active{color:var(--ink); background:rgba(124,156,255,0.15)}
    .card{padding:12px; border:1px solid rgba(255,255,255,0.08); border-radius:12px; background:rgba(255,255,255,0.03)}
    label.btn{display:inline-flex; align-items:center; gap:8px; border:1px dashed rgba(255,255,255,0.18); background:rgba(124,156,255,0.06); padding:10px 12px; border-radius:999px; cursor:pointer; color:#dce6ff}
    label.btn:hover{background:rgba(124,156,255,0.12)}
    input[type=file]{display:none}
    .btn{display:inline-flex; align-items:center; gap:8px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); padding:10px 12px; border-radius:10px; color:var(--ink); cursor:pointer}
    .btn:hover{background:rgba(255,255,255,0.12)}
    .scoreBox{display:grid; grid-template-columns: 1fr auto; gap:6px; align-items:center}
    .score{font-size:28px; font-weight:800}
    .score.good{color:var(--good)} .score.ok{color:var(--ok)} .score.bad{color:var(--bad)}
    .hint{font-size:12px; color:var(--muted)}
    .canvasWrap{position:relative; height:100%; display:flex; align-items:center; justify-content:center; padding:8px}
    canvas{max-width:100%; max-height:100%; border-radius:16px; background:#0a0e13}
    .legend{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px}
    .legend .item{display:flex; align-items:center; gap:8px; color:var(--muted)}
    .dotSample{width:12px; height:12px; border-radius:50%}
    .dashSample{width:28px; height:0; border-top:2px dashed currentColor}
    .tbl{width:100%; border-collapse:collapse; font-size:13px}
    .tbl th,.tbl td{border-bottom:1px solid rgba(255,255,255,0.08); padding:8px; text-align:left}
    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 920px){ .wrap{grid-template-columns:1fr; height:auto; min-height:100vh} .canvasWrap{min-height:50vh} }
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="sidebar panel analysis-report" id="report">
      <div class="title">ğŸ“¸ DIT ìì„¸ ë¶„ì„ â€” Before/After + ìˆ˜ë™ ì (ASIS/PSIS í¬í•¨)</div>
      <div class="muted">ì´ë¯¸ì§€ ì—…ë¡œë“œ(íŒŒì¼ ì„ íƒ/ì§ì ‘ ì´¬ì˜) â†’ ì  ë“œë˜ê·¸ â†’ ê°ë„/ì ìˆ˜ ìë™ â†’ PDF ì €ì¥</div>

      <div class="row" style="margin-top:12px">
        <div class="seg" role="tablist" aria-label="ì„¸ì…˜ ì„ íƒ">
          <button id="btnBefore" class="active" aria-selected="true">Before</button>
          <button id="btnAfter" aria-selected="false">After</button>
        </div>
        <button id="btnExplain" class="btn">â“ ìŠ¤ì½”ì–´ ì„¤ëª…</button>
      </div>

      <div class="row" style="margin-top:8px">
        <!-- íŒŒì¼ ì„ íƒ + ì§ì ‘ ì´¬ì˜ (ê° ì„¸ì…˜ ê³µìš©) -->
        <label class="btn">ğŸ“· íŒŒì¼ ì„ íƒ
          <input id="filePicker" type="file" accept="image/*" />
        </label>
        <label class="btn">ğŸ“¸ ì§ì ‘ ì´¬ì˜
          <input id="cameraPicker" type="file" accept="image/*" capture="environment" />
        </label>
        <button id="btnReset" class="btn">â†º í˜„ì¬ ì„¸ì…˜ ì  ì´ˆê¸°í™”</button>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="scoreBox">
          <div>
            <div class="muted">ì²´í˜• ì¢…í•© ì ìˆ˜ (0â€“100)</div>
            <div id="score" class="score">â€”</div>
          </div>
          <div class="row">
            <button id="btnSaveJSON" class="btn">ğŸ’¾ ì¢Œí‘œ ì €ì¥</button>
            <button id="btnLoadJSON" class="btn">ğŸ“‚ ì¢Œí‘œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button id="btnPDF" class="btn">ğŸ“„ PDF ì €ì¥</button>
          </div>
        </div>
        <div class="legend" style="margin-top:8px">
          <div class="item"><span class="dotSample" style="background:#7c9cff"></span> ê¸°ì¤€ ê´€ì ˆ ì </div>
          <div class="item"><span class="dashSample" style="color:#7c9cff"></span> ë¶„ì„ ì ì„ </div>
          <div class="item"><span class="dotSample" style="background:#ffb86c"></span> ê³¨ë°˜(ASIS/PSIS)</div>
          <div class="item"><span class="dashSample" style="color:#ffb86c"></span> ê³¨ë°˜ ê¸°ì¤€ì„ </div>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <table class="tbl" id="cmpTbl">
          <thead><tr><th>í•­ëª©</th><th>Before</th><th>After</th><th>ë³€í™”</th><th>ì •ìƒ ë²”ìœ„</th><th>ìƒíƒœ</th></tr></thead>
          <tbody>
            <tr><td>CVA</td><td id="cmpCvaB">â€”</td><td id="cmpCvaA">â€”</td><td id="cmpCvaD">â€”</td><td>â‰¥ 50Â°</td><td id="cmpCvaS">â€”</td></tr>
            <tr><td>TRUNK(ASISâ†’PSIS)</td><td id="cmpPelB">â€”</td><td id="cmpPelA">â€”</td><td id="cmpPelD">â€”</td><td>|0â€“5Â°|</td><td id="cmpPelS">â€”</td></tr>
            <tr><td>KNEE</td><td id="cmpKneeB">â€”</td><td id="cmpKneeA">â€”</td><td id="cmpKneeD">â€”</td><td>175â€“185Â°</td><td id="cmpKneeS">â€”</td></tr>
            <tr><td>ì²´í˜• ì ìˆ˜</td><td id="cmpScB">â€”</td><td id="cmpScA">â€”</td><td id="cmpScD">â€”</td><td>0â€“100</td><td id="cmpScS">â€”</td></tr>
          </tbody>
        </table>
      </div>
    </aside>

    <main class="panel canvasWrap">
      <canvas id="cv" width="1600" height="1000" aria-label="ìì„¸ ë¶„ì„ ìº”ë²„ìŠ¤" tabindex="0"></canvas>
    </main>
  </div>

  <!-- html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5zs5lQ68bq7kzB5b7nJcJcZ0xS0W8U3s6yYq1nGqE8N0yR2g7Oe5QyX8d0zS3r4w3lJ6k6A3F4k8aP7YwA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-Hq0PpC4q8b7wQHf1l3dwZ8uUqF2k3e2G2o1g2kqYq4x8h9FQeQ0xE1m0+fY7t2n3b8t2w8k8j2P1Yj2S9K0X0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
  // ===== ìœ í‹¸ =====
  const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
  const rad2deg = r=> r*180/Math.PI;
  function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
  function angleBetween(a,b){ return Math.atan2(b.y-a.y, b.x-a.x); }
  function internalAngle(a,b,c){ const ab=Math.atan2(a.y-b.y,a.x-b.x); const cb=Math.atan2(c.y-b.y,c.x-b.x); let d=Math.abs(ab-cb); if(d>Math.PI) d=2*Math.PI-d; return d; }

  // ===== ìƒíƒœ =====
  const keypoints = [
    {key:'Tragus', color:'#7c9cff'},
    {key:'C7', color:'#7c9cff'},
    {key:'Shoulder', color:'#7c9cff'},
    {key:'Hip', color:'#7c9cff'},
    {key:'Knee', color:'#7c9cff'},
    {key:'Ankle', color:'#7c9cff'},
    {key:'ASIS', color:'#ffb86c'},
    {key:'PSIS', color:'#ffb86c'},
  ];
  const sessions = {
    Before: { img:null, pts:new Map(), score:null, metrics:{} },
    After:  { img:null, pts:new Map(), score:null, metrics:{} },
  };
  let cur = 'Before';

  // ===== ìº”ë²„ìŠ¤ =====
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  let DPR = window.devicePixelRatio || 1;
  function resizeCanvasFor(img){
    const maxW = cv.parentElement.clientWidth - 24;
    const maxH = cv.parentElement.clientHeight - 24;
    const r = img ? Math.min(maxW/img.naturalWidth, maxH/img.naturalHeight) : 1;
    const w = Math.round((img?img.naturalWidth:1200)*r);
    const h = Math.round((img?img.naturalHeight:800)*r);
    cv.width = Math.round(w*DPR); cv.height = Math.round(h*DPR);
    cv.style.width = w+'px'; cv.style.height = h+'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    draw();
  }

  // ===== ì—…ë¡œë“œ(íŒŒì¼/ì¹´ë©”ë¼ ê³µìš©) =====
  const filePicker = document.getElementById('filePicker');
  const cameraPicker = document.getElementById('cameraPicker');
  filePicker.addEventListener('change', e=> loadImage(cur, e.target.files[0]));
  cameraPicker.addEventListener('change', e=> loadImage(cur, e.target.files[0]));

  function loadImage(slot, file){
    if(!file) return;
    const img = new Image();
    img.onload = ()=>{ sessions[slot].img = img; resizeCanvasFor(img); computeAll(); updateCompare(); };
    // objectURLì€ CORS ë¬¸ì œ ì—†ìŒ
    img.src = URL.createObjectURL(file);
  }

  // ===== ì„¸ì…˜ ì „í™˜ =====
  const btnBefore = document.getElementById('btnBefore');
  const btnAfter  = document.getElementById('btnAfter');
  const modeLabel = document.createElement('span');
  btnBefore.onclick = ()=>{ cur='Before'; btnBefore.classList.add('active'); btnAfter.classList.remove('active'); draw(); computeAll(); updateCompare(); };
  btnAfter.onclick  = ()=>{ cur='After';  btnAfter.classList.add('active');  btnBefore.classList.remove('active'); draw(); computeAll(); updateCompare(); };

  // ===== ê¸°ë³¸ ì  ë°°ì¹˜ =====
  function ensureDefaultPoints(session){
    const S = sessions[session];
    const W = cv.width/DPR, H = cv.height/DPR;
    if(S.pts.size===0){
      const defaults = {
        Tragus:{x:W*0.35, y:H*0.3}, C7:{x:W*0.3, y:H*0.35},
        Shoulder:{x:W*0.35, y:H*0.4}, Hip:{x:W*0.38, y:H*0.6},
        Knee:{x:W*0.42, y:H*0.8}, Ankle:{x:W*0.44, y:H*0.95},
        ASIS:{x:W*0.40, y:H*0.58}, PSIS:{x:W*0.35, y:H*0.6},
      };
      for(const k of keypoints) S.pts.set(k.key, {...defaults[k.key]});
    }
  }

  // ===== ë“œë¡œì‰ =====
  function draw(){
    const S = sessions[cur];
    const W = cv.width/DPR, H = cv.height/DPR;
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.fillStyle = '#0a0e13'; ctx.fillRect(0,0,W,H);

    if(S.img){ ctx.drawImage(S.img, 0, 0, W, H); }
    ensureDefaultPoints(cur);

    // ë³´ì¡°ì„ /ì—°ê²°ì„ 
    const P = getPts(cur);
    ctx.lineWidth=2; ctx.setLineDash([8,6]); ctx.strokeStyle='rgba(124,156,255,0.85)';
    if(P.C7 && P.Tragus){ ctx.beginPath(); ctx.moveTo(0,P.C7.y); ctx.lineTo(W,P.C7.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(P.C7.x,P.C7.y); ctx.lineTo(P.Tragus.x,P.Tragus.y); ctx.stroke(); }
    if(P.Shoulder && P.Hip){ ctx.beginPath(); ctx.moveTo(P.Shoulder.x,P.Shoulder.y); ctx.lineTo(P.Hip.x,P.Hip.y); ctx.stroke(); }
    if(P.Hip && P.Knee){ ctx.beginPath(); ctx.moveTo(P.Hip.x,P.Hip.y); ctx.lineTo(P.Knee.x,P.Knee.y); ctx.stroke(); }
    if(P.Knee && P.Ankle){ ctx.beginPath(); ctx.moveTo(P.Knee.x,P.Knee.y); ctx.lineTo(P.Ankle.x,P.Ankle.y); ctx.stroke(); }

    if(P.ASIS && P.PSIS){
      ctx.strokeStyle='rgba(255,184,108,0.95)';
      ctx.beginPath(); ctx.moveTo(P.ASIS.x,P.ASIS.y); ctx.lineTo(P.PSIS.x,P.PSIS.y); ctx.stroke();
      ctx.strokeStyle='rgba(255,184,108,0.35)'; const midy=(P.ASIS.y+P.PSIS.y)/2;
      ctx.beginPath(); ctx.moveTo(0, midy); ctx.lineTo(W, midy); ctx.stroke();
    }
    ctx.setLineDash([]);

    // ì  + ë¼ë²¨
    for(const kp of keypoints){ const pt = P[kp.key]; if(!pt) continue; drawHandle(pt.x, pt.y, kp.key, kp.color); }
  }

  function drawHandle(x,y,label,color){
    ctx.fillStyle=color; ctx.strokeStyle='rgba(0,0,0,0.8)';
    ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fill(); ctx.lineWidth=2; ctx.stroke();
    ctx.font='12px "Noto Sans KR"'; const pad=4; const tw=ctx.measureText(label).width; const th=16;
    ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(x+10,y-12, tw+pad*2, th);
    ctx.fillStyle='#e7eef7'; ctx.fillText(label, x+10+pad, y+1);
  }

  function getPts(session){ const map=sessions[session].pts; const out={}; for(const k of keypoints) out[k.key]=map.get(k.key); return out; }

  // ===== ë“œë˜ê·¸ =====
  let dragKey=null;
  cv.addEventListener('mousedown',e=>{
    const r=cv.getBoundingClientRect(); const x=(e.clientX-r.left), y=(e.clientY-r.top);
    const P=getPts(cur); let best=null, bestD=1e9; for(const k of keypoints){ const p=P[k.key]; if(!p) continue; const d=Math.hypot(p.x-x,p.y-y); if(d<12 && d<bestD){ best=k.key; bestD=d; } }
    if(best) dragKey=best;
  });
  window.addEventListener('mousemove',e=>{
    if(!dragKey) return; const r=cv.getBoundingClientRect(); const x=(e.clientX-r.left), y=(e.clientY-r.top);
    const map=sessions[cur].pts; const p=map.get(dragKey); if(!p) return; p.x=clamp(x,0,cv.width/DPR); p.y=clamp(y,0,cv.height/DPR);
    draw(); computeAll(); updateCompare();
  });
  window.addEventListener('mouseup',()=> dragKey=null);

  // ===== ë©”íŠ¸ë¦­/ìŠ¤ì½”ì–´ =====
  function computeAll(){
    const S = sessions[cur]; const P = getPts(cur);
    let cva=null, pelvic=null, knee=null;
    if(P.C7 && P.Tragus){ const a=angleBetween(P.C7,P.Tragus); cva = Math.abs(rad2deg(a)); }
    if(P.ASIS && P.PSIS){ pelvic = rad2deg(angleBetween(P.ASIS,P.PSIS)); }
    if(P.Hip && P.Knee && P.Ankle){ knee = rad2deg( internalAngle(P.Hip,P.Knee,P.Ankle) ); }
    S.metrics = { cva, pelvic, knee };
    const sc = computeScore(cva,pelvic,knee); S.score=sc; renderScore(sc);
  }
  function computeScore(cva,pelvic,knee){ let p=0; if(cva!=null){ const d=Math.max(0,50-cva); p+=Math.min(40,d*1.6);} if(pelvic!=null){ const d=Math.abs(pelvic); p+=Math.min(30,d*2.0);} if(knee!=null){ const d=Math.max(0,180-knee); p+=Math.min(30,d*1.0);} return Math.round(clamp(100-p,0,100)); }
  function renderScore(sc){ const el=document.getElementById('score'); if(sc==null){ el.textContent='â€”'; el.className='score'; return;} el.textContent=sc; el.className='score ' + (sc>=85?'good':sc>=70?'ok':'bad'); }

  // ===== ìƒíƒœíŒì • DOT =====
  function statusDot(val, type){
    if(val==null||isNaN(val)) return ['â€”','â€”'];
    if(type==='CVA'){ if(val>=50) return ['ğŸŸ¢ ì •ìƒ', 'â‰¥50Â°']; if(val>=45) return ['ğŸŸ¡ ê²½ë¯¸', '45â€“49Â°']; return ['ğŸ”´ ë¬¸ì œ','<45Â°']; }
    if(type==='TRUNK'){ const a=Math.abs(val); if(a<=5) return ['ğŸŸ¢ ì •ìƒ','|0â€“5Â°|']; if(a<=10) return ['ğŸŸ¡ ê²½ë¯¸','|6â€“10Â°|']; return ['ğŸ”´ ë¬¸ì œ','>10Â°']; }
    if(type==='KNEE'){ if(val>=175) return ['ğŸŸ¢ ì •ìƒ','175â€“185Â°']; if(val>=165) return ['ğŸŸ¡ ê²½ë¯¸','165â€“174Â°']; return ['ğŸ”´ ë¬¸ì œ','<165Â°']; }
    return ['â€”','â€”'];
  }

  // ===== ë¹„êµí‘œ =====
  function fmtDeg(v){ return (v==null||isNaN(v)) ? 'â€”' : v.toFixed(1)+'Â°'; }
  function deltaStr(b,a,suf){ if(b==null||a==null||isNaN(b)||isNaN(a)) return 'â€”'; const d=(a-b); const sign = d>0?'+':''; return sign + d.toFixed(1) + (suf||''); }
  function updateCompare(){
    const B=sessions.Before, A=sessions.After;
    const cB=B.metrics.cva, cA=A.metrics.cva; document.getElementById('cmpCvaB').textContent=fmtDeg(cB); document.getElementById('cmpCvaA').textContent=fmtDeg(cA); document.getElementById('cmpCvaD').textContent=deltaStr(cB,cA,'Â°'); document.getElementById('cmpCvaS').textContent=statusDot(cA??cB,'CVA')[0];
    const pB=B.metrics.pelvic, pA=A.metrics.pelvic; document.getElementById('cmpPelB').textContent=fmtDeg(pB); document.getElementById('cmpPelA').textContent=fmtDeg(pA); document.getElementById('cmpPelD').textContent=deltaStr(pB,pA,'Â°'); document.getElementById('cmpPelS').textContent=statusDot(pA??pB,'TRUNK')[0];
    const kB=B.metrics.knee,   kA=A.metrics.knee;   document.getElementById('cmpKneeB').textContent=fmtDeg(kB); document.getElementById('cmpKneeA').textContent=fmtDeg(kA); document.getElementById('cmpKneeD').textContent=deltaStr(kB,kA,'Â°'); document.getElementById('cmpKneeS').textContent=statusDot(kA??kB,'KNEE')[0];
    const sB=B.score, sA=A.score; document.getElementById('cmpScB').textContent=sB==null?'â€”':sB; document.getElementById('cmpScA').textContent=sA==null?'â€”':sA; document.getElementById('cmpScD').textContent=deltaStr(sB,sA,''); document.getElementById('cmpScS').textContent= (sA??sB)==null?'â€”': ((sA??sB)>=85?'ğŸŸ¢ ì¢‹ìŒ':(sA??sB)>=70?'ğŸŸ¡ ë³´í†µ':'ğŸ”´ ì£¼ì˜');
  }

  // ===== ë¦¬ì…‹/ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° =====
  document.getElementById('btnReset').onclick = ()=>{ sessions[cur].pts.clear(); draw(); computeAll(); updateCompare(); };
  document.getElementById('btnSaveJSON').onclick = ()=>{ const blob=new Blob([ JSON.stringify(Object.fromEntries(sessions[cur].pts), null, 2) ], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${cur}_keypoints.json`; a.click(); URL.revokeObjectURL(a.href); };
  document.getElementById('btnLoadJSON').onclick = ()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); const map=new Map(); for(const k of Object.keys(obj)) map.set(k,obj[k]); sessions[cur].pts=map; draw(); computeAll(); updateCompare(); }catch(err){ alert('JSON íŒŒì‹± ì‹¤íŒ¨: '+err.message); } }; r.readAsText(f); }; inp.click(); };

  // ===== PDF ì €ì¥ (ë¹ˆ PDF ë¬¸ì œ í•´ê²° ë²„ì „) =====
  document.getElementById('btnPDF').onclick = async ()=>{
    // 1) í˜„ì¬ ìº”ë²„ìŠ¤ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
    const cvData = cv.toDataURL('image/png');
    const cvImg = new Image(); cvImg.src = cvData; await cvImg.decode();

    // 2) PDFìš© ì„ì‹œ DOM êµ¬ì„± (ë¦¬í¬íŠ¸ + ìº”ë²„ìŠ¤ ì´ë¯¸ì§€)
    const exportNode = document.createElement('div');
    exportNode.style.width = '794px'; // A4 px @96DPI (approx): 794x1123
    exportNode.style.padding = '16px';
    exportNode.style.background = '#ffffff';
    exportNode.style.color = '#111';
    exportNode.style.fontFamily = 'Noto Sans KR, Arial, sans-serif';
    exportNode.innerHTML = `
      <h2 style="margin:0 0 8px 0; font-weight:800">DIT ìì„¸ ë¶„ì„ ë¦¬í¬íŠ¸</h2>
      <div style="font-size:12px; color:#555; margin-bottom:8px">${new Date().toLocaleString()}</div>
      <div id="exportMetrics" style="margin-bottom:10px"></div>
      <img id="exportImage" style="width:100%; border:1px solid #ddd; border-radius:8px" />
      <div style="margin-top:10px; font-size:12px; color:#444">â€» ë³¸ ë¦¬í¬íŠ¸ëŠ” êµìœ¡ìš©ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.</div>
    `;
    // ë©”íŠ¸ë¦­ í…ìŠ¤íŠ¸ ì‚½ì…
    const M = sessions[cur].metrics; const S = sessions[cur].score;
    exportNode.querySelector('#exportMetrics').innerHTML = `
      <table style="width:100%; border-collapse:collapse; font-size:13px">
        <tr><th style="text-align:left; border-bottom:1px solid #eee; padding:6px 0">í•­ëª©</th><th style="text-align:left; border-bottom:1px solid #eee; padding:6px 0">ê°’</th><th style="text-align:left; border-bottom:1px solid #eee; padding:6px 0">ì •ìƒ ë²”ìœ„</th><th style="text-align:left; border-bottom:1px solid #eee; padding:6px 0">ìƒíƒœ</th></tr>
        <tr><td style="padding:6px 0">CVA</td><td>${fmtDeg(M.cva)}</td><td>â‰¥ 50Â°</td><td>${statusDot(M.cva,'CVA')[0]}</td></tr>
        <tr><td style="padding:6px 0">TRUNK</td><td>${fmtDeg(M.pelvic)}</td><td>|0â€“5Â°|</td><td>${statusDot(M.pelvic,'TRUNK')[0]}</td></tr>
        <tr><td style="padding:6px 0">KNEE</td><td>${fmtDeg(M.knee)}</td><td>175â€“185Â°</td><td>${statusDot(M.knee,'KNEE')[0]}</td></tr>
        <tr><td style="padding:6px 0">ì²´í˜• ì ìˆ˜</td><td>${S==null?'â€”':S}</td><td>0â€“100</td><td>${S==null?'â€”':(S>=85?'ğŸŸ¢ ì¢‹ìŒ':S>=70?'ğŸŸ¡ ë³´í†µ':'ğŸ”´ ì£¼ì˜')}</td></tr>
      </table>`;
    exportNode.querySelector('#exportImage').src = cvData;

    // 3) í™”ë©´ ë°–ì— ë¶™ì—¬ì„œ ë Œë” (html2canvasê°€ ê³„ì‚° ê°€ëŠ¥í•˜ë„ë¡)
    exportNode.style.position='fixed'; exportNode.style.left='-9999px'; document.body.appendChild(exportNode);

    // 4) ìº¡ì²˜ â†’ PDF
    const canvas = await html2canvas(exportNode, {scale:2, backgroundColor:'#ffffff', useCORS:true, allowTaint:true});
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({orientation:'portrait', unit:'px', format:'a4'});

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const imgW = pageW - 40; // ì¢Œìš° ì—¬ë°±
    const imgH = canvas.height * (imgW / canvas.width);

    let y = 20;
    if(imgH < pageH - 40){
      pdf.addImage(imgData, 'PNG', 20, y, imgW, imgH);
    } else {
      // ì—¬ëŸ¬ í˜ì´ì§€ì— ë‚˜ëˆ  ê·¸ë¦¬ê¸°
      let remaining = imgH; let sY = 0; const sliceH = canvas.height * ((pageH-40)/imgH);
      const onePageHpx = sliceH; const onePageH = pageH - 40;
      while(remaining > 0){
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = canvas.width; pageCanvas.height = Math.min(onePageHpx, canvas.height - sY);
        const pctx = pageCanvas.getContext('2d');
        pctx.drawImage(canvas, 0, sY, canvas.width, pageCanvas.height, 0, 0, canvas.width, pageCanvas.height);
        const pageImg = pageCanvas.toDataURL('image/png');
        pdf.addImage(pageImg, 'PNG', 20, 20, imgW, onePageH*(pageCanvas.height/onePageHpx));
        remaining -= onePageH; sY += onePageHpx; if(remaining>0) pdf.addPage();
      }
    }
    pdf.save('DIT_ìì„¸_ë¶„ì„_ë¦¬í¬íŠ¸.pdf');

    // 5) ì •ë¦¬
    document.body.removeChild(exportNode);
  };

  // ===== ì„¤ëª…ì°½ =====
  document.getElementById('btnExplain').onclick = ()=>{
    alert('ìŠ¤ì½”ì–´ ì‚°ì‹\n\nâ€¢ CVA ëª©í‘œ 50Â°. ë¸íƒ€ = max(0, 50 - CVA), ê°ì  = min(40, ë¸íƒ€Ã—1.6).\nâ€¢ ê³¨ë°˜ ê¸°ìš¸ê¸° ëª©í‘œ 0Â°. ë¸íƒ€ = |ê¸°ìš¸ê¸°|, ê°ì  = min(30, ë¸íƒ€Ã—2.0).\nâ€¢ ë¬´ë¦ ê° ëª©í‘œ 180Â°. ë¸íƒ€ = max(0, 180 - ë¬´ë¦ê°), ê°ì  = min(30, ë¸íƒ€Ã—1.0).\n\nì¢…í•©ì ìˆ˜ = 100 - (CVAê°ì  + ê³¨ë°˜ê°ì  + ë¬´ë¦ê°ì ).');
  };

  // ===== ì´ˆê¸°í™” =====
  resizeCanvasFor(null); computeAll(); updateCompare();
  </script>
</body>
</html>
