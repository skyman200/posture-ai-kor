<!DOCTYPE html>
<html lang="ko">
  <head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIT 자세 분석 AI (최종 통합버전)</title>
<!-- Import-map (브라우저가 importmap을 지원하면 @mediapipe/pose를 매핑) - 모든 module script보다 먼저 와야 함 -->

<!-- ✅ @mediapipe/pose 먼저 로드 (pose-detection 의존성 해결) -->

<!-- ✅ TensorFlow.js 싱글톤 로더 (중복 로딩 완전 차단) -->
<script>
  // Load TF.js exactly once and export a singleton on window.tfSingleton
  // Protects against duplicate kernel registration caused by multiple loads.
  (function(){
    if (window.tfSingleton && window.tfSingleton._loaded) {
      console.log('✅ TF singleton already loaded');
      return;
    }
    window.tfSingleton = window.tfSingleton || { _loading: true, _loaded: false };
    async function loadTfOnce() {
      if (window.tfSingleton._loaded) return window.tfSingleton.tf;
      if (window.tfSingleton._loading && window.tfSingleton._promise) return window.tfSingleton._promise;
      window.tfSingleton._promise = (async () => {
        // ✅ UMD 방식 우선 사용 (안정성 확보)
        return new Promise((resolve, reject) => {
          // 이미 로드되어 있으면 바로 반환
          if (window.tf) {
            window.tfSingleton.tf = window.tf;
            window.tfSingleton._loaded = true;
            window.tfSingleton._loading = false;
            console.log('✅ TensorFlow.js already loaded (singleton)');
            resolve(window.tfSingleton.tf);
            return;
          }
          
          const s = document.createElement('script');
          // ✅ 안정적인 CDN 경로 사용 (UMD 버전)
          s.src = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js';
          s.onload = () => {
            window.tfSingleton.tf = window.tf || (window).tf;
            if (!window.tfSingleton.tf) {
              reject(new Error('TensorFlow.js loaded but window.tf is undefined'));
              return;
            }
            window.tfSingleton._loaded = true;
            window.tfSingleton._loading = false;
            console.log('✅ TensorFlow.js loaded via UMD (singleton)');
            resolve(window.tfSingleton.tf);
          };
          s.onerror = (e) => {
            console.error('❌ TensorFlow.js UMD load failed, trying ESM fallback', e);
            // ESM 폴백 시도
            import('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/+esm')
              .then(mod => {
                const tf = (mod && (mod.default || mod.tf)) || mod;
                window.tfSingleton.tf = tf;
                window.tf = tf; // 호환성
                window.tfSingleton._loaded = true;
                window.tfSingleton._loading = false;
                console.log('✅ TensorFlow.js loaded via ESM fallback (singleton)');
                resolve(tf);
              })
              .catch(esmErr => {
                console.error('❌ TensorFlow.js ESM fallback also failed', esmErr);
                reject(esmErr);
              });
          };
          document.head.appendChild(s);
        });
      })();
      return window.tfSingleton._promise;
    }
    // expose loader globally
    window.loadTfOnce = loadTfOnce;
  })();
</script>
<!-- ✅ 3. favicon.ico 404 오류 해결 (선택사항) -->
<link rel="icon" type="image/png" href="/posture-ai-kor/pwa-192x192.png">
<style>
:root {
  --bg: #0b0f14;
  --panel: rgba(30, 34, 42, 0.7);
  --accent: #7c9cff;
  --accent2: #ffb86c;
  --ink: #e7eef7;
  --muted: #9bb0c7;
  --radius: 18px;
  --font-body: 'Apple SD Gothic Neo', 'Malgun Gothic', 'Nanum Gothic', 'Noto Sans KR', 'Pretendard', 'Segoe UI', 'Roboto', sans-serif;
}

/* PDF용 안전 폰트 (구글 폰트 제외) */
.pdf-safe {
  font-family: var(--font-body), sans-serif !important;
  letter-spacing: 0.2px;
  line-height: 1.45;
}

.pdf-safe * {
  font-family: inherit !important;
}
* { box-sizing: border-box; }
html, body {
  margin: 0; 
  padding: 0;
  height: 100%;
  -webkit-overflow-scrolling: touch;
}
body {
  background: var(--bg); 
  color: var(--ink);
  font-family: var(--font-body);
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  overflow-x: hidden;
}
button, input, select, textarea {
  font-family: var(--font-body);
}
.panel {
  background: var(--panel);
  backdrop-filter: blur(20px);
  border-radius: var(--radius);
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
}
.sidebar { 
  padding: 12px; 
  overflow-y: auto;
  overflow-x: hidden;
  max-height: 50vh;
  -webkit-overflow-scrolling: touch;
}
.title { 
  font-size: 16px; 
  font-weight:800; 
  margin-bottom: 6px; 
  line-height: 1.3;
}
.muted { 
  color: var(--muted); 
  font-size: 11px; 
  line-height: 1.4;
}
.btn {
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 10px 14px;
  background: rgba(255,255,255,0.05);
  color: var(--ink);
  cursor: pointer;
  font-size: 13px;
  width: 100%;
  text-align: center;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.btn:hover, .btn:active { 
  background: rgba(255,255,255,0.12); 
}
.seg { 
  display: flex; 
  border-radius: 10px; 
  overflow: hidden; 
  margin-top: 8px; 
  gap: 4px;
}
.seg button { 
  flex:1; 
  border:0; 
  background: rgba(255,255,255,0.04); 
  color:var(--muted); 
  padding:10px 8px; 
  cursor:pointer; 
  font-size: 13px;
  touch-action: manipulation;
}
.seg button.active { 
  background: rgba(124,156,255,0.25); 
  color:var(--ink); 
}
label.btn { 
  display: block;
  width: 100%;
  margin-bottom: 8px;
  position: relative;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
label.btn input { 
  position: absolute;
  opacity: 0;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  cursor: pointer;
  z-index: 10;
  pointer-events: auto;
  -webkit-tap-highlight-color: transparent;
  font-size: 0;
  margin: 0;
  padding: 0;
  border: 0;
}
.tbl { 
  width:100%; 
  border-collapse:collapse; 
  font-size:11px; 
  overflow-x: auto;
  display: table;
  -webkit-overflow-scrolling: touch;
}
.tbl th,.tbl td { 
  border-bottom:1px solid rgba(255,255,255,0.1); 
  padding:6px 4px; 
  text-align: center;
  font-size: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.canvasWrap { 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  flex: 1;
  min-height: 50vh;
  padding: 8px;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  position: relative;
}
.canvasWrap.zoomed {
  align-items: flex-start;
  justify-content: flex-start;
}
canvas { 
  border-radius:var(--radius); 
  background:#0a0e13; 
  cursor: crosshair; 
  touch-action: none; /* 드래그와 스크롤을 JavaScript로 제어 */
  display: block;
  flex-shrink: 0;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
  -moz-user-select: none;
       user-select: none;
  -webkit-user-select: none;
}
</style>
<script type="importmap">
{
  "imports": {
    "@mediapipe/pose": "https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.164/pose.js"
  }
}
</script>
    <script type="module" crossorigin src="/posture-ai-kor/assets/main-BU0Vz_wY.js"></script>
  </head>
  <body>
<aside class="panel sidebar" style="order: 1;">
  <div class="title">📸 DIT 자세 분석 AI</div>
  <div class="muted">파일 업로드 → 점을 드래그로 조정 → 각도 자동 계산</div>

  <div class="seg">
    <button id="btnBefore" class="active">Before</button>
    <button id="btnAfter">After</button>
  </div>
  <div style="margin-top:8px; display:flex; flex-direction:column; gap:8px;">
    <div class="seg" style="margin-bottom:4px;">
      <button id="btnOrientationSide" class="active">📐 옆모습</button>
      <button id="btnOrientationFront">📷 정면</button>
    </div>
    <label class="btn" for="filePicker">📷 파일 선택
      <input id="filePicker" name="filePicker" type="file" accept="image/*">
    </label>
    <label class="btn" for="cameraPicker">📸 직접 촬영
      <input id="cameraPicker" name="cameraPicker" type="file" accept="image/*" capture="environment">
    </label>
    <button class="btn" id="btnReset">↺ 초기화</button>
    <button class="btn" id="btnCalibrate" style="background: rgba(255,184,108,0.2);">📏 캘리브레이션</button>
  </div>

  <div id="calibrationPanel" style="margin-top:12px; padding:10px; background:rgba(255,184,108,0.1); border-radius:10px; display:none;">
    <div class="muted" style="margin-bottom:8px; font-weight:600;">📏 캘리브레이션</div>
    <div class="muted" style="font-size:11px; margin-bottom:8px;">기준 마커 두 점을 찍고 실제 길이(cm)를 입력하세요</div>
    <div style="margin-bottom:8px;">
      <input type="number" id="calibrationLength" name="calibrationLength" placeholder="실제 길이 (cm)" step="0.1" min="0.1" style="width:100%; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.3); color:var(--ink);">
    </div>
    <div class="muted" style="font-size:11px; margin-bottom:4px;">점 1: <span id="calPoint1">클릭하여 선택</span></div>
    <div class="muted" style="font-size:11px; margin-bottom:8px;">점 2: <span id="calPoint2">클릭하여 선택</span></div>
    <button class="btn" id="btnCalibrateConfirm" style="width:100%; margin-bottom:8px;">✅ 계산</button>
    <button class="btn" id="btnCalibrateCancel" style="width:100%;">❌ 취소</button>
    <div id="calibrationResult" class="muted" style="font-size:11px; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);"></div>
  </div>

  <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
    <button class="btn" id="btnEditCoords" style="background: rgba(124,156,255,0.2);">✏️ 좌표 수정 모드</button>
    <button class="btn" id="btnSaveJSON">💾 좌표 저장</button>
    <button class="btn" id="btnLoadJSON">📂 좌표 불러오기</button>
    <button class="btn" id="btnPDF">📄 PDF 저장</button>
    <button class="btn" id="btnImage">🖼️ 그림으로 저장</button>
    <button class="btn" id="btnShare">📤 공유하기</button>
    <button class="btn" id="btnAIAnalysis" style="background: rgba(46,196,182,0.3); border: 1px solid rgba(46,196,182,0.5);">🤖 AI 분석</button>
  </div>

  <!-- 골반 결과 표시 영역 -->
  <div id="pelvicDesc" style="white-space: pre-line; line-height:1.6; font-size:15px; margin-top:10px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px; display:none;"></div>

  <div id="coordEditPanel" style="margin-top:12px; padding:10px; background:rgba(124,156,255,0.1); border-radius:10px; display:none;">
    <div class="muted" style="margin-bottom:8px; font-weight:600;">좌표 수정</div>
    <div style="margin-bottom:8px;">
      <div class="muted" style="font-size:11px; margin-bottom:4px;">확대 배율</div>
      <select id="zoomLevel" class="btn" style="width:100%; padding:6px; margin-bottom:8px;">
        <option value="1">원본 크기 (1배)</option>
        <option value="2">2배 확대 (스크롤 가능)</option>
        <option value="3">3배 확대 (스크롤 가능)</option>
        <option value="4">4배 확대 (스크롤 가능)</option>
      </select>
      <div class="muted" style="font-size:10px; margin-top:4px; margin-bottom:8px; line-height:1.4;">확대 시 양손으로 드래그하여 이동 가능</div>
    </div>
    <div style="margin-bottom:8px;">
      <select id="coordSelectPoint" class="btn" style="width:100%; padding:6px; margin-bottom:6px;">
        <option value="">점 선택...</option>
        <!-- 옵션은 JavaScript에서 동적으로 업데이트됨 -->
      </select>
    </div>
    <div style="display:flex; flex-direction:column; gap:6px; margin-bottom:6px;">
      <div>
        <div class="muted" style="font-size:11px; margin-bottom:4px;">X 좌표</div>
        <div style="display:flex; gap:4px; align-items:center;">
          <input type="number" id="coordX" name="coordX" class="btn" style="flex:1; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);" step="0.1" placeholder="X">
          <button class="btn" id="coordXDec" style="padding:8px 12px; background:rgba(255,107,107,0.2); border:1px solid rgba(255,107,107,0.3); min-width:40px;">−</button>
          <button class="btn" id="coordXInc" style="padding:8px 12px; background:rgba(46,196,182,0.2); border:1px solid rgba(46,196,182,0.3); min-width:40px;">+</button>
        </div>
      </div>
      <div>
        <div class="muted" style="font-size:11px; margin-bottom:4px;">Y 좌표</div>
        <div style="display:flex; gap:4px; align-items:center;">
          <input type="number" id="coordY" name="coordY" class="btn" style="flex:1; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1);" step="0.1" placeholder="Y">
          <button class="btn" id="coordYDec" style="padding:8px 12px; background:rgba(255,107,107,0.2); border:1px solid rgba(255,107,107,0.3); min-width:40px;">−</button>
          <button class="btn" id="coordYInc" style="padding:8px 12px; background:rgba(46,196,182,0.2); border:1px solid rgba(46,196,182,0.3); min-width:40px;">+</button>
        </div>
      </div>
    </div>
    <button class="btn" id="coordApply" style="width:100%; background:rgba(124,156,255,0.3);">적용</button>
    <button class="btn" id="coordCancel" style="width:100%; margin-top:6px; background:rgba(255,255,255,0.05);">취소</button>
  </div>

  <div style="margin-top:12px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px;">
    <div class="muted" style="margin-bottom:6px;">현재 세션: <span id="currentSession">Before</span></div>
    
    <!-- 주요 지표 (간략 표시) -->
    <div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.1);">
      <div class="muted" style="margin-bottom:4px;">CVA: <span id="dispCva">—</span></div>
      <div class="muted" style="margin-bottom:4px;">TRUNK: <span id="dispPel">—</span></div>
      <div class="muted" style="margin-bottom:4px;">KNEE: <span id="dispKnee">—</span></div>
    </div>
    
    <!-- 전체 분석 항목 (16가지) -->
    <div id="allMetricsPanel" style="max-height:300px; overflow-y:auto; margin-bottom:8px;">
      <div style="font-size:12px; font-weight:600; margin-bottom:6px; color:#7c9cff;">📊 전체 분석 항목</div>
      <div id="allMetricsList" style="font-size:11px; line-height:1.6;"></div>
    </div>
    
    <div style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1);">
      <div style="font-size:14px; font-weight:600; margin-bottom:8px;">📊 체형 종합 점수</div>
      <div id="totalScore" style="font-size:32px; font-weight:800; margin-bottom:8px;">—</div>
      <div id="scoreReason" class="muted" style="font-size:11px; line-height:1.4; margin-bottom:8px;"></div>
      <div id="pdsScore" class="muted" style="font-size:12px; margin-top:6px;">PDS: <span id="pdsValue">—</span></div>
    </div>
  </div>


  <!-- AI PRO 리포트 표시 영역 -->
  <div id="report-box" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.1); border-radius:10px; display:none; white-space: pre-wrap; font-size:12px; line-height:1.5; max-height:400px; overflow-y:auto; color:var(--ink); font-family: 'Noto Sans KR', sans-serif;"></div>
  
  <!-- 16개 항목 상세 설명 -->
  <div id="metricsDescPanel" style="margin-top:12px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#7c9cff;">📋 분석 항목 설명</div>
    <div style="font-size:11px; color:#7c9cff; margin-bottom:8px; padding:4px 8px; background:rgba(124,156,255,0.2); border-radius:4px; display:inline-block;">측면 항목 (옆모습)</div>
    <div style="font-size:11px; color:#2ec4b6; margin-bottom:8px; padding:4px 8px; background:rgba(46,196,182,0.2); border-radius:4px; display:inline-block; margin-left:8px;">정면 항목 (앞모습)</div>
    <div id="metricsDescContent" style="max-height:400px; overflow-y:auto; font-size:11px; line-height:1.6;">
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">CVA (Craniovertebral Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> 귀 뒤 유양돌기(Tragus)와 제7경추(C7) 사이의 각도<br>
          <strong>의미:</strong> 거북목 자세의 정도를 평가하는 가장 중요한 지표입니다. 각도가 작을수록 머리가 앞으로 나온 상태입니다.<br>
          <strong>정상 범위:</strong> ≥50° (각도가 클수록 좋음)<br>
          <strong>임상적 의미:</strong> CVA &lt; 50°는 전방두부자세(FHP)를 의미하며, 경추 근육 긴장, 두통, 목 통증의 원인이 됩니다.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">HPD (Head Protrusion Distance)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> 귀(Tragus)와 어깨(Acromion) 사이의 수평 거리<br>
          <strong>의미:</strong> 머리가 몸통에서 얼마나 앞으로 돌출되어 있는지를 cm 단위로 측정합니다.<br>
          <strong>정상 범위:</strong> ≤2cm<br>
          <strong>임상적 의미:</strong> 2cm 초과 시 경추 부담 증가, 상부 승모근 과긴장, 목-어깨 통증 유발 가능성이 높습니다.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">TIA (Trunk Inclination Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> 어깨(Acromion)와 골반(Hip)을 연결한 선과 수직선 사이의 각도<br>
          <strong>의미:</strong> 몸통의 앞뒤 기울기를 평가하여 전체적인 체간 정렬을 확인합니다.<br>
          <strong>정상 범위:</strong> 0-10°<br>
          <strong>임상적 의미:</strong> 10° 초과 시 요추 과전만 또는 평평한 등(Flat Back) 위험이 있습니다.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">SAA (Scapular Alignment Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> 어깨(Acromion)와 골반 후면(PSIS)을 연결한 선과 수평선 사이의 각도<br>
          <strong>의미:</strong> 어깨뼈의 정렬 상태와 상부 체간의 자세를 평가합니다.<br>
          <strong>정상 범위:</strong> 0-10°<br>
          <strong>임상적 의미:</strong> 이상 시 견갑골 날개뼈(Winging) 또는 어깨 전방 말림이 의심됩니다.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">PTA (Pelvic Tilt Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> 후상장골극(PSIS)과 전상장골극(ASIS)을 연결한 선과 수평선 사이의 각도<br>
          <strong>의미:</strong> 골반의 전방 또는 후방 기울기를 평가하는 핵심 지표입니다.<br>
          <strong>해석 기준:</strong> PSIS 기준으로 ASIS와 같은 높이 = 0도, ASIS가 PSIS보다 위쪽에 있으면 = 골반 후방경사(음수, -1도부터), ASIS가 PSIS보다 밑쪽에 있으면 = 골반 전방경사(양수, 1도부터)<br>
          <strong>정상 범위:</strong> 0-15° (약간의 전방 경사는 정상)<br>
          <strong>임상적 의미:</strong> &gt;15° (양수)는 골반 전방 경사(요추 과전만), &lt;0° (음수)는 골반 후방 경사(요추 평평)를 의미합니다.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">KA (Knee Alignment Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> 고관절(Hip)-무릎(Knee)-발목(Ankle) 세 점이 이루는 각도<br>
          <strong>의미:</strong> 무릎 관절의 신전(펴짐) 정도를 평가합니다.<br>
          <strong>정상 범위:</strong> 175-185°<br>
          <strong>임상적 의미:</strong> &lt;175°는 무릎 과굴곡(슬개건 부담), &gt;185°는 무릎 과신전(관절 불안정성)을 나타냅니다.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">Tibial Angle (경골 경사각)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> 무릎(Knee)과 발목(Ankle)을 연결한 선과 수직선 사이의 각도<br>
          <strong>의미:</strong> 정강이(경골)의 앞뒤 기울기를 측정합니다.<br>
          <strong>정상 범위:</strong> 0-10°<br>
          <strong>임상적 의미:</strong> 과도한 경사는 발목 불안정성 및 종아리 근육 불균형을 유발할 수 있습니다.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">Q-Angle (대퇴사두근 각도)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> ASIS-슬개골(Patella)-경골조면(Tibial Tuberosity) 세 점이 이루는 각도<br>
          <strong>의미:</strong> 대퇴사두근의 당김 방향을 평가하여 무릎 정렬을 확인합니다.<br>
          <strong>정상 범위:</strong> 남성 10-15°, 여성 15-20°<br>
          <strong>임상적 의미:</strong> &gt;20°는 슬개골 외측 전위 및 슬개대퇴 통증 증후군의 위험 요인입니다.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">Knee Deviation (무릎 높이 차)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> 좌우 무릎의 높이 차이를 각도로 환산<br>
          <strong>의미:</strong> 양쪽 무릎의 수평 정렬을 평가하여 골반 기울기를 간접적으로 확인합니다.<br>
          <strong>정상 범위:</strong> 0-3°<br>
          <strong>임상적 의미:</strong> 3° 초과 시 골반 회전(Pelvic Rotation) 또는 척추 측만증이 의심됩니다.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">LLD (Leg Length Discrepancy)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> 좌우 다리 길이(Hip-Ankle) 차이를 cm 단위로 측정<br>
          <strong>의미:</strong> 기능적 또는 구조적 다리 길이 차이를 평가합니다.<br>
          <strong>정상 범위:</strong> ≤1cm<br>
          <strong>임상적 의미:</strong> 1cm 초과 시 골반 비대칭, 척추 측만, 보행 이상이 발생할 수 있으며 보상 자세로 인한 만성 통증의 원인이 됩니다.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">GSB (Global Sagittal Balance)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> 귀(Tragus)와 발목(Ankle)의 수평 거리<br>
          <strong>의미:</strong> 전신의 시상면(옆에서 본) 균형을 종합적으로 평가하는 지표입니다.<br>
          <strong>정상 범위:</strong> ≤2cm<br>
          <strong>임상적 의미:</strong> 2cm 초과 시 중력 중심선 이탈로 인한 전체 근골격계 부담 증가 및 에너지 소모가 증가합니다.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">HPA (Head–Pelvis Angle)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> 머리(Tragus)와 골반(PSIS)을 연결한 선과 수직선 사이의 각도<br>
          <strong>의미:</strong> 머리와 골반의 상대적 위치 관계를 통해 전신 자세를 종합 평가합니다.<br>
          <strong>정상 범위:</strong> 0-10°<br>
          <strong>임상적 의미:</strong> 이상 각도는 머리-골반 분절 간 협응 부족을 나타내며, 전신 자세 불균형의 지표입니다.
        </div>
      </details>
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#7c9cff; padding:4px 0;">PDS (Postural Deviation Score)</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 방법:</strong> 위 15개 항목의 비정상 정도를 점수화하여 합산<br>
          <strong>의미:</strong> 전체적인 자세 불균형의 정도를 하나의 숫자로 요약한 종합 지표입니다.<br>
          <strong>정상 범위:</strong> 0-10점<br>
          <strong>분류:</strong> 0-10 (정상), 11-20 (경미), 21-30 (중등도), 31+ (심각)<br>
          <strong>임상적 의미:</strong> 점수가 높을수록 다양한 자세 문제가 복합적으로 나타나며, 전문적인 교정 치료가 필요합니다.
        </div>
      </details>
      
      <!-- 정면 항목 (앞모습) - 색상: #2ec4b6 -->
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">STA (Shoulder Tilt Angle) - 어깨 좌우 기울기</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 기준:</strong> angle(line(L_acromion, R_acromion), horizontal)<br>
          <strong>측정 방법:</strong> ① 카메라를 가슴 중앙 높이에 고정하고 피험자는 정면으로 선 자세 유지. ② 좌·우 Acromion의 좌표를 인식. ③ Δy를 각도로 변환(atan(Δy / Δx)).<br>
          <strong>정상 범위:</strong> ≤ 3°<br>
          <strong>해석:</strong> ↑ → 어깨 좌우 불균형, 승모근·능형근 긴장 차이 가능성.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">POA (Pelvic Obliquity Angle) - 골반 좌우 기울기</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 기준:</strong> angle(line(L_ASIS, R_ASIS), horizontal)<br>
          <strong>측정 방법:</strong> ① 카메라를 골반 높이에 맞추고 정면에서 촬영. ② 좌·우 ASIS를 인식하고 Δy 계산. ③ 각도 계산: POA = atan(Δy / Δx).<br>
          <strong>정상 범위:</strong> ≤ 3°<br>
          <strong>해석:</strong> ↑ → 골반 좌우 비대칭 / 하지 길이 차 / 요추 측만 가능성.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">LLD (Leg Length Discrepancy) - 하지 길이 차</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 기준:</strong> |distance(L_ASIS, L_ankle) - distance(R_ASIS, R_ankle)|<br>
          <strong>측정 방법:</strong> ① 전신이 보이도록 정면 촬영. ② 좌·우 ASIS 및 발목(Ankle) 좌표 인식. ③ 거리(cm) 환산(pxPerCm 보정).<br>
          <strong>정상 범위:</strong> ≤ 1 cm<br>
          <strong>해석:</strong> ↑ → 구조적 또는 기능적 하지 길이 차 존재.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">TD (Trunk Deviation) - 체간 편위</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 기준:</strong> horizontal deviation(C7, midline(L_ankle, R_ankle))<br>
          <strong>측정 방법:</strong> ① 카메라를 정면, 양 발목이 수평에 오도록 촬영. ② L/R Ankle 좌표로 중간선(midpoint) 계산. ③ C7의 수평 거리 편차 계산.<br>
          <strong>정상 범위:</strong> ± 2°<br>
          <strong>해석:</strong> ↑ → 체간이 좌우로 기울어짐 / 체중 중심 불균형.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">HTA (Head Tilt Angle) - 머리 좌우 기울기</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 기준:</strong> angle(line(L_tragus, R_tragus), horizontal)<br>
          <strong>측정 방법:</strong> ① 정면에서 Tragus 좌우가 명확히 보이도록 촬영. ② 두 점의 y좌표 차이 계산 → 각도로 변환.<br>
          <strong>정상 범위:</strong> ≤ 3°<br>
          <strong>해석:</strong> ↑ → 경부 측굴 또는 측만성 긴장 패턴.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">SPP (Shoulder–Pelvis Parallelism) - 어깨-골반 평행도</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 기준:</strong> angle_diff(line(L_acromion, R_acromion), line(L_ASIS, R_ASIS))<br>
          <strong>측정 방법:</strong> ① 정면 촬영 시 L/R 어깨와 L/R ASIS가 모두 보여야 함. ② 두 선의 각도 차 계산.<br>
          <strong>정상 범위:</strong> 0–3°<br>
          <strong>해석:</strong> ↑ → 체간 회전 / 골반 비틀림 / 척추 회전성 불균형.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">KAS (Knee Alignment Symmetry) - 무릎 정렬 대칭성</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 기준:</strong> angle_diff(line(L_knee, L_ankle), line(R_knee, R_ankle))<br>
          <strong>측정 방법:</strong> ① 정면에서 무릎과 발목 모두 인식. ② 각 무릎–발목 수직선의 각도 비교.<br>
          <strong>정상 범위:</strong> 대칭(±2° 이내)<br>
          <strong>해석:</strong> ↑ → 한쪽 내반/외반 또는 하지 회전 패턴.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">LLAS (Lower Limb Axis Symmetry) - 하지 축 대칭성</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 기준:</strong> angle_diff(line(L_ASIS, L_ankle), line(R_ASIS, R_ankle))<br>
          <strong>측정 방법:</strong> ① 정면에서 하지 전체 촬영. ② 각 하지축 라인 각도 비교.<br>
          <strong>정상 범위:</strong> ±2°<br>
          <strong>해석:</strong> ↑ → 한쪽 회내·회외 또는 하지 회전성 불균형.
        </div>
      </details>
      
      <details style="margin-bottom:8px; border-left:3px solid #2ec4b6; padding-left:8px;">
        <summary style="cursor:pointer; font-weight:600; color:#2ec4b6; padding:4px 0;">FBA (Foot Base Angle) - 발 정렬 각도</summary>
        <div style="padding:8px 0 0 12px; color:var(--muted); line-height:1.5;">
          <strong>측정 기준:</strong> angle(line(ankle, toe), body midline)<br>
          <strong>측정 방법:</strong> ① 피험자는 발끝까지 보이게 정면으로 선다. ② 발 중심선(ankle–toe)과 몸 중심선 간 각도 계산.<br>
          <strong>정상 범위:</strong> 0–10°<br>
          <strong>해석:</strong> ↑ → 과도한 외회전(회외) / ↓ → 회내 경향.
        </div>
      </details>
    </div>
  </div>
  
  <!-- 실시간 분석 결과 패널 -->
  <div id="liveAnalysisPanel" style="margin-top:12px; padding:12px; background:rgba(124,156,255,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#7c9cff;">📊 실시간 AI 분석 결과</div>
    <div id="livePDS" style="font-size:16px; font-weight:700; margin-bottom:8px; color:#7c9cff;">PDS: —</div>
    <div id="livePatterns" style="font-size:12px; line-height:1.6;"></div>
  </div>

  <!-- 근육 상태 분석 (먼저 표시) -->
  <div id="musclePanel" style="margin-top:12px; padding:12px; background:rgba(255,184,108,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#ffb86c; font-family: 'Noto Sans KR', sans-serif;">💪 근육 상태 분석</div>
    <div id="muscleTight" style="margin-bottom:8px;">
      <div class="muted" style="font-size:12px; margin-bottom:4px; font-family: 'Noto Sans KR', sans-serif;">🔴 긴장된 근육:</div>
      <div id="muscleTightList" style="font-size:12px; color:#ff6b6b; line-height:1.6; font-family: 'Noto Sans KR', sans-serif;"></div>
    </div>
    <div id="muscleWeak" style="margin-bottom:8px;">
      <div class="muted" style="font-size:12px; margin-bottom:4px; font-family: 'Noto Sans KR', sans-serif;">🔵 약화된 근육:</div>
      <div id="muscleWeakList" style="font-size:12px; color:#7c9cff; line-height:1.6; font-family: 'Noto Sans KR', sans-serif;"></div>
    </div>
  </div>

  <!-- AI 체형 분석 (근육 상태 분석 다음) -->
  <div id="aiCommentPanel" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.1); border-radius:10px; display:none; font-family: 'Noto Sans KR', sans-serif;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#2ec4b6; font-family: 'Noto Sans KR', sans-serif;">🤖 AI 체형 분석</div>
    <div id="aiComment" class="muted" style="font-size:12px; line-height:1.6; font-family: 'Noto Sans KR', sans-serif; color:var(--ink);"></div>
    
    <!-- 개인별 체형 분석 설명 -->
    <div id="postureTypeDesc" style="margin-top:12px; padding:10px; background:rgba(255,255,255,0.1); border-radius:8px; border-left:3px solid #2ec4b6; font-family: 'Noto Sans KR', sans-serif;">
      <div style="font-size:13px; font-weight:600; margin-bottom:6px; color:#2ec4b6; font-family: 'Noto Sans KR', sans-serif;">📌 체형 유형 분석</div>
      <div id="postureTypeContent" style="font-size:12px; line-height:1.6; color:var(--muted); font-family: 'Noto Sans KR', sans-serif;"></div>
    </div>
  </div>

  <!-- 추천 운동 -->
  <div id="exercisePanel" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.15); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#2ec4b6; font-family: 'Noto Sans KR', sans-serif;">🏋️ 추천 운동</div>
    <div id="exerciseList" style="font-size:12px; line-height:1.6; font-family: 'Noto Sans KR', sans-serif;"></div>
  </div>

  <!-- 필라테스 세션 추천 -->
  <div id="pilatesPanel" style="margin-top:12px; padding:12px; background:rgba(156,136,255,0.15); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#9c88ff; font-family: 'Noto Sans KR', sans-serif;">🧘 필라테스 세션 추천</div>
    <div id="pilatesList" style="font-size:12px; line-height:1.6; font-family: 'Noto Sans KR', sans-serif;"></div>
  </div>

  <!-- 필라테스 운동 상세 설명 모달 -->
  <div id="pilatesExerciseModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; overflow-y:auto; padding:20px; box-sizing:border-box;">
    <div style="max-width:600px; margin:0 auto; background:#1a1a2e; border-radius:12px; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 id="modalExerciseTitle" style="margin:0; color:#9c88ff; font-size:18px; font-weight:600;"></h3>
        <button id="closeModalBtn" style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>
      <div id="modalExerciseContent" style="color:#e0e0e0; line-height:1.8; font-size:13px;">
        <!-- 운동 상세 설명이 여기에 표시됩니다 -->
      </div>
    </div>
  </div>


  <!-- 결론 및 향후 권장사항 (회원 이름 포함, 임상 중심) -->
  <div id="conclusionPanel" style="margin-top:12px; padding:12px; background:rgba(46,196,182,0.1); border-radius:10px; display:none;">
    <div style="font-size:14px; font-weight:600; margin-bottom:8px; color:#2ec4b6; font-family: 'Noto Sans KR', sans-serif;">✅ 결론 및 향후 권장사항</div>
    <div id="conclusionContent" style="font-size:12px; line-height:1.8; color:var(--ink); font-family: 'Noto Sans KR', sans-serif; white-space:pre-wrap; word-wrap:break-word;"></div>
  </div>

  <!-- 항목 (Before/After 비교 테이블) -->
  <div style="margin-top:12px; max-height:400px; overflow-y:auto;">
    <table class="tbl">
      <thead><tr><th>항목</th><th>Before</th><th>After</th><th>변화</th><th>정상</th></tr></thead>
      <tbody>
        <tr><td>CVA(두개경추각)</td><td id="cmpCvaB">—</td><td id="cmpCvaA">—</td><td id="cmpCvaD">—</td><td>≥50°</td></tr>
        <tr><td>HPD(두부전방이동)</td><td id="cmpHpdB">—</td><td id="cmpHpdA">—</td><td id="cmpHpdD">—</td><td>≤2cm</td></tr>
        <tr><td>TIA(체간경사각)</td><td id="cmpTiaB">—</td><td id="cmpTiaA">—</td><td id="cmpTiaD">—</td><td>0-10°</td></tr>
        <tr><td>SAA(어깨전방각)</td><td id="cmpSaaB">—</td><td id="cmpSaaA">—</td><td id="cmpSaaD">—</td><td>0-10°</td></tr>
        <tr><td>PTA(골반 전후경사각)</td><td id="cmpPtaB">—</td><td id="cmpPtaA">—</td><td id="cmpPtaD">—</td><td>0-15°</td></tr>
        <tr><td>KA(무릎각)</td><td id="cmpKaB">—</td><td id="cmpKaA">—</td><td id="cmpKaD">—</td><td>175-185°</td></tr>
        <tr><td>Tibial(경골경사각)</td><td id="cmpTibialB">—</td><td id="cmpTibialA">—</td><td id="cmpTibialD">—</td><td>0-10°</td></tr>
        <tr><td>Q-Angle(Q각)</td><td id="cmpQangleB">—</td><td id="cmpQangleA">—</td><td id="cmpQangleD">—</td><td>10-20°</td></tr>
        <tr><td>Knee Dev(무릎편위)</td><td id="cmpKneedevB">—</td><td id="cmpKneedevA">—</td><td id="cmpKneedevD">—</td><td>0-3°</td></tr>
        <tr><td>LLD(하지길이차)</td><td id="cmpLldB">—</td><td id="cmpLldA">—</td><td id="cmpLldD">—</td><td>≤1cm</td></tr>
        <tr><td>GSB(중력중심선)</td><td id="cmpGsbB">—</td><td id="cmpGsbA">—</td><td id="cmpGsbD">—</td><td>≤2cm</td></tr>
        <tr><td>HPA(고관절각)</td><td id="cmpHpaB">—</td><td id="cmpHpaA">—</td><td id="cmpHpaD">—</td><td>0-10°</td></tr>
        <tr><td>PDS(자세점수)</td><td id="cmpPdsB">—</td><td id="cmpPdsA">—</td><td id="cmpPdsD">—</td><td>0-10</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">STA(어깨기울기각)</td><td id="cmpStaB">—</td><td id="cmpStaA">—</td><td id="cmpStaD">—</td><td>≤3°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">POA(골반기울기각)</td><td id="cmpPoaB">—</td><td id="cmpPoaA">—</td><td id="cmpPoaD">—</td><td>≤3°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">LLD(하지길이차)</td><td id="cmpLldfB">—</td><td id="cmpLldfA">—</td><td id="cmpLldfD">—</td><td>≤1cm</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">TD(체간편위)</td><td id="cmpTdB">—</td><td id="cmpTdA">—</td><td id="cmpTdD">—</td><td>0-3°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">HTA(머리기울기각)</td><td id="cmpHtaB">—</td><td id="cmpHtaA">—</td><td id="cmpHtaD">—</td><td>≤3°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">SPP(어깨골반평행도)</td><td id="cmpSppB">—</td><td id="cmpSppA">—</td><td id="cmpSppD">—</td><td>0-3°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">KAS(무릎정렬대칭성)</td><td id="cmpKasB">—</td><td id="cmpKasA">—</td><td id="cmpKasD">—</td><td>0-3°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">LLAS(하지축대칭성)</td><td id="cmpLlasB">—</td><td id="cmpLlasA">—</td><td id="cmpLlasD">—</td><td>0-3°</td></tr>
        <tr style="background:rgba(46,196,182,0.1);"><td style="color:#2ec4b6; font-weight:600;">FBA(발정렬각)</td><td id="cmpFbaB">—</td><td id="cmpFbaA">—</td><td id="cmpFbaD">—</td><td>0-3°</td></tr>
        <tr style="background:#f0f0f0; font-weight:600;"><td>체형 점수</td><td id="cmpScoreB">—</td><td id="cmpScoreA">—</td><td id="cmpScoreD">—</td><td>0–100</td></tr>
      </tbody>
    </table>
  </div>
</aside>
<main class="panel canvasWrap" style="order: 2;">
  <canvas id="cv" width="1600" height="1000"></canvas>
</main>

<!-- ✅ 전역 충돌 방어 및 강제 등록 (최우선 실행) -->
<script>
// ---- 전역 변수 초기화 보호 (중복 선언 방지) ----
if (typeof window.cur === 'undefined') {
  window.cur = "Before";
}
if (typeof window.sessions === 'undefined') {
  window.sessions = {};
}
if (typeof window.currentSessions === 'undefined') {
  window.currentSessions = null;
}

// ---- 전역 충돌 방어 ----
window.analyzePostureAI = window.analyzePostureAI || function(before, after) {
  if (window.modelManager && !window.modelManager.ready) {
    console.log('modelManager not ready — models may not be loaded yet');
  }
  console.log("✅ analyzePostureAI 강제 바인딩 실행됨", { before, after });
  // 실제 함수가 나중에 정의되면 덮어씌워짐
  return { results: [], findings: [], muscles: { tight: [], weak: [] } };
};

// ---- 파일 업로드 핸들러 먼저 정의 ----
window.handleFileUpload = window.handleFileUpload || function handleFileUpload(e) {
  const f = e.target.files[0];
  if(!f) return;
  const targetSessionName = window.cur || "Before";
  const targetSession = window.sessions[targetSessionName];
  if(!targetSession) {
    console.warn("세션 정보를 찾을 수 없습니다.");
    return;
  }
  
  // 현재 선택된 버튼(정면/옆모습) 확인
  const btnSide = document.getElementById("btnOrientationSide");
  const btnFront = document.getElementById("btnOrientationFront");
  const currentButtonOrientation = btnFront?.classList.contains("active") ? "front" 
    : (btnSide?.classList.contains("active") ? "side" : null);
  
  const guessedOrientation = currentButtonOrientation || targetSession.poseData?.orientation || "side";
  if(!targetSession.poseData) {
    targetSession.poseData = { orientation: guessedOrientation, landmarks: null, orientationMode: currentButtonOrientation ? "manual" : "auto" };
  } else if(!targetSession.poseData.orientationMode) {
    targetSession.poseData.orientationMode = currentButtonOrientation ? "manual" : "auto";
  }
  let imgKey = guessedOrientation === "front" ? "imgFront" : "imgSide";
  
  console.log("파일 업로드 - 현재 선택된 orientation:", guessedOrientation);
  
  const img = new Image();
  img.onerror = (e) => {
    console.error("이미지 로드 실패:", e);
    alert("이미지를 불러올 수 없습니다. 파일 형식을 확인해주세요.");
  };
  
    img.onload = async () => {
    targetSession[imgKey] = img;
    if(window.resizeCanvasFor) window.resizeCanvasFor(img);
    if(window.draw) window.draw();
    if(window.computeMetricsOnly) window.computeMetricsOnly();
    
    // 포즈 분석 실행 (정면/옆모습 자동 감지)
    if(window.liveAnalyzer && window.liveAnalyzer.analyzeCurrentSession) {
      setTimeout(async () => {
        try {
          await window.liveAnalyzer.analyzeCurrentSession();
        } catch (err) {
          console.error("❌ 포즈 분석 실패:", err);
        }
      }, 500);
    }
  };
  
  img.src = URL.createObjectURL(f);
  e.target.value = '';
};

// ---- 파일 업로드 강제 등록 ----
window.setupFileUploads = window.setupFileUploads || function() {
  console.log("📌 setupFileUploads 강제 활성화");
  
  const fileInputs = document.querySelectorAll("input[type=file]");
  fileInputs.forEach(input => {
    // 기존 이벤트 제거 후 재등록
    const newInput = input.cloneNode(true);
    input.parentNode.replaceChild(newInput, input);
    
    newInput.addEventListener("change", (e) => {
      console.log("📁 파일 선택됨:", e.target.files);
      if (typeof window.handleFileUpload === 'function') {
        window.handleFileUpload(e);
      } else {
        console.error("❌ handleFileUpload 함수를 찾을 수 없습니다.");
      }
    });
  });
};

// DOM 준비되면 즉시 실행
if (document.readyState === 'loading') {
  document.addEventListener("DOMContentLoaded", () => {
    console.log("🔥 DOM 준비됨 → 파일 첨부 기능 주입");
    if (window.setupFileUploads) {
      window.setupFileUploads();
    }
  });
} else {
  // 이미 로드 완료된 경우 즉시 실행
  console.log("🔥 DOM 이미 준비됨 → 파일 첨부 기능 주입");
  if (window.setupFileUploads) {
    window.setupFileUploads();
  }
}
</script>

<!-- ✅ modelManager: front/side 모델 분리 로드 및 UI 잠금/해제 -->

</body>
</html>